!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],e):e(t.ethereal={},t.three)}(this,function(t,e){var i=Object.freeze(new e.Vector2),n=Object.freeze(new e.Vector2),o=Object.freeze(new e.Vector3),r=Object.freeze(new e.Vector3(1,0,0)),s=Object.freeze(new e.Vector3(0,1,0)),a=Object.freeze(new e.Vector3(0,0,1)),c=Object.freeze(new e.Vector3(1,1,1)),u=Object.freeze(new e.Quaternion),l=Promise.resolve(),h=function(t,e){var i=this;this._factory=t,this._reset=e,this._pool=[],this._unpooled=new Set,this._autoPool=function(){i._nextAutoPool=void 0,i._poolAll()}};h.prototype.get=function(){var t=this._pool.pop()||this._reset(this._factory());return this._unpooled.add(t),this._nextAutoPool||(this._nextAutoPool=l.then(this._autoPool)),t},h.prototype.pool=function(t){this._pool.push(t),this._unpooled.delete(t),this._reset(t)},h.prototype._poolAll=function(){if(0!==this._unpooled.size)for(var t=0,e=this._unpooled;t<e.length;t+=1)this.pool(e[t])};var p=new h(function(){return new e.Vector2},function(t){return t.set(0,0)}),f=new h(function(){return new e.Vector3},function(t){return t.set(0,0,0)}),d=new h(function(){return new e.Vector4},function(t){return t.set(0,0,0,1)}),m=new h(function(){return new e.Quaternion},function(t){return t.set(0,0,0,1)}),x=new h(function(){return new e.Matrix3},function(t){return t.identity()}),y=new h(function(){return new e.Matrix4},function(t){return t.identity()});function g(t,e,i){if(e.call(i,t))for(var n=0,o=t.children;n<o.length;n+=1)g(o[n],e,i)}var v,b,w,M,F=0,T=new e.Vector3;function _(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new P,this.unassigned=new P,this.vertices=[]}function B(){this.normal=new e.Vector3,this.midpoint=new e.Vector3,this.area=0,this.constant=0,this.outside=null,this.mark=F,this.edge=null}function z(t,e){this.vertex=t,this.prev=null,this.next=null,this.twin=null,this.face=e}function C(t){this.point=t,this.prev=null,this.next=null,this.face=null}function P(){this.head=null,this.tail=null}Object.assign(_.prototype,{setFromPoints:function(t){!0!==Array.isArray(t)&&console.error("THREE.QuickHull: Points parameter is not an array."),t.length<4&&console.error("THREE.QuickHull: The algorithm needs at least four points."),this.makeEmpty();for(var e=0,i=t.length;e<i;e++)this.vertices.push(new C(t[e]));return this.compute(),this},setFromObject:function(t){var i=[];return t.updateMatrixWorld(!0),t.traverse(function(t){var n,o,r,s=t.geometry;if(void 0!==s)if(s.isGeometry){var a=s.vertices;for(n=0,o=a.length;n<o;n++)(r=a[n].clone()).applyMatrix4(t.matrixWorld),i.push(r)}else if(s.isBufferGeometry){var c=s.attributes.position;if(void 0!==c)for(n=0,o=c.count;n<o;n++)(r=new e.Vector3).fromBufferAttribute(c,n).applyMatrix4(t.matrixWorld),i.push(r)}}),this.setFromPoints(i)},containsPoint:function(t){for(var e=this.faces,i=0,n=e.length;i<n;i++)if(e[i].distanceToPoint(t)>this.tolerance)return!1;return!0},intersectRay:function(t,e){for(var i=this.faces,n=-Infinity,o=Infinity,r=0,s=i.length;r<s;r++){var a=i[r],c=a.distanceToPoint(t.origin),u=a.normal.dot(t.direction);if(c>0&&u>=0)return null;var l=0!==u?-c/u:0;if(!(l<=0)&&(u>0?o=Math.min(l,o):n=Math.max(l,n),n>o))return null}return t.at(-Infinity!==n?n:o,e),e},intersectsRay:function(t){return null!==this.intersectRay(t,T)},makeEmpty:function(){return this.faces=[],this.vertices=[],this},addVertexToFace:function(t,e){return t.face=e,null===e.outside?this.assigned.append(t):this.assigned.insertBefore(e.outside,t),e.outside=t,this},removeVertexFromFace:function(t,e){return t===e.outside&&(e.outside=null!==t.next&&t.next.face===e?t.next:null),this.assigned.remove(t),this},removeAllVerticesFromFace:function(t){if(null!==t.outside){for(var e=t.outside,i=t.outside;null!==i.next&&i.next.face===t;)i=i.next;return this.assigned.removeSubList(e,i),e.prev=i.next=null,t.outside=null,e}},deleteFaceVertices:function(t,e){var i=this.removeAllVerticesFromFace(t);if(void 0!==i)if(void 0===e)this.unassigned.appendChain(i);else{var n=i;do{var o=n.next;e.distanceToPoint(n.point)>this.tolerance?this.addVertexToFace(n,e):this.unassigned.append(n),n=o}while(null!==n)}return this},resolveUnassignedPoints:function(t){if(!1===this.unassigned.isEmpty()){var e=this.unassigned.first();do{for(var i=e.next,n=this.tolerance,o=null,r=0;r<t.length;r++){var s=t[r];if(s.mark===F){var a=s.distanceToPoint(e.point);if(a>n&&(n=a,o=s),n>1e3*this.tolerance)break}}null!==o&&this.addVertexToFace(e,o),e=i}while(null!==e)}return this},computeExtremes:function(){var t,i,n,o=new e.Vector3,r=new e.Vector3,s=[],a=[];for(t=0;t<3;t++)s[t]=a[t]=this.vertices[0];for(o.copy(this.vertices[0].point),r.copy(this.vertices[0].point),t=0,i=this.vertices.length;t<i;t++){var c=this.vertices[t],u=c.point;for(n=0;n<3;n++)u.getComponent(n)<o.getComponent(n)&&(o.setComponent(n,u.getComponent(n)),s[n]=c);for(n=0;n<3;n++)u.getComponent(n)>r.getComponent(n)&&(r.setComponent(n,u.getComponent(n)),a[n]=c)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(o.x),Math.abs(r.x))+Math.max(Math.abs(o.y),Math.abs(r.y))+Math.max(Math.abs(o.z),Math.abs(r.z))),{min:s,max:a}},computeInitialHull:function(){void 0===v&&(v=new e.Line3,b=new e.Plane,w=new e.Vector3);var t,i,n,o,r,s,a,c,u,l=this.vertices,h=this.computeExtremes(),p=h.min,f=h.max,d=0,m=0;for(s=0;s<3;s++)(u=f[s].point.getComponent(s)-p[s].point.getComponent(s))>d&&(d=u,m=s);for(d=0,v.set((i=p[m]).point,(n=f[m]).point),s=0,a=this.vertices.length;s<a;s++)(t=l[s])!==i&&t!==n&&(v.closestPointToPoint(t.point,!0,w),(u=w.distanceToSquared(t.point))>d&&(d=u,o=t));for(d=-1,b.setFromCoplanarPoints(i.point,n.point,o.point),s=0,a=this.vertices.length;s<a;s++)(t=l[s])!==i&&t!==n&&t!==o&&(u=Math.abs(b.distanceToPoint(t.point)))>d&&(d=u,r=t);var x=[];if(b.distanceToPoint(r.point)<0)for(x.push(B.create(i,n,o),B.create(r,n,i),B.create(r,o,n),B.create(r,i,o)),s=0;s<3;s++)c=(s+1)%3,x[s+1].getEdge(2).setTwin(x[0].getEdge(c)),x[s+1].getEdge(1).setTwin(x[c+1].getEdge(0));else for(x.push(B.create(i,o,n),B.create(r,i,n),B.create(r,n,o),B.create(r,o,i)),s=0;s<3;s++)c=(s+1)%3,x[s+1].getEdge(2).setTwin(x[0].getEdge((3-s)%3)),x[s+1].getEdge(0).setTwin(x[c+1].getEdge(1));for(s=0;s<4;s++)this.faces.push(x[s]);for(s=0,a=l.length;s<a;s++)if((t=l[s])!==i&&t!==n&&t!==o&&t!==r){d=this.tolerance;var y=null;for(c=0;c<4;c++)(u=this.faces[c].distanceToPoint(t.point))>d&&(d=u,y=this.faces[c]);null!==y&&this.addVertexToFace(t,y)}return this},reindexFaces:function(){for(var t=[],e=0;e<this.faces.length;e++){var i=this.faces[e];i.mark===F&&t.push(i)}return this.faces=t,this},nextVertexToAdd:function(){if(!1===this.assigned.isEmpty()){var t,e=0,i=this.assigned.first().face,n=i.outside;do{var o=i.distanceToPoint(n.point);o>e&&(e=o,t=n),n=n.next}while(null!==n&&n.face===i);return t}},computeHorizon:function(t,e,i,n){var o;this.deleteFaceVertices(i),i.mark=1,o=null===e?e=i.getEdge(0):e.next;do{var r=o.twin,s=r.face;s.mark===F&&(s.distanceToPoint(t)>this.tolerance?this.computeHorizon(t,r,s,n):n.push(o)),o=o.next}while(o!==e);return this},addAdjoiningFace:function(t,e){var i=B.create(t,e.tail(),e.head());return this.faces.push(i),i.getEdge(-1).setTwin(e.twin),i.getEdge(0)},addNewFaces:function(t,e){this.newFaces=[];for(var i=null,n=null,o=0;o<e.length;o++){var r=this.addAdjoiningFace(t,e[o]);null===i?i=r:r.next.setTwin(n),this.newFaces.push(r.face),n=r}return i.next.setTwin(n),this},addVertexToHull:function(t){var e=[];return this.unassigned.clear(),this.removeVertexFromFace(t,t.face),this.computeHorizon(t.point,null,t.face,e),this.addNewFaces(t,e),this.resolveUnassignedPoints(this.newFaces),this},cleanup:function(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this},compute:function(){var t;for(this.computeInitialHull();void 0!==(t=this.nextVertexToAdd());)this.addVertexToHull(t);return this.reindexFaces(),this.cleanup(),this}}),Object.assign(B,{create:function(t,e,i){var n=new B,o=new z(t,n),r=new z(e,n),s=new z(i,n);return o.next=s.prev=r,r.next=o.prev=s,s.next=r.prev=o,n.edge=o,n.compute()}}),Object.assign(B.prototype,{getEdge:function(t){for(var e=this.edge;t>0;)e=e.next,t--;for(;t<0;)e=e.prev,t++;return e},compute:function(){void 0===M&&(M=new e.Triangle);var t=this.edge.tail(),i=this.edge.head(),n=this.edge.next.head();return M.set(t.point,i.point,n.point),M.getNormal(this.normal),M.getMidpoint(this.midpoint),this.area=M.getArea(),this.constant=this.normal.dot(this.midpoint),this},distanceToPoint:function(t){return this.normal.dot(t)-this.constant}}),Object.assign(z.prototype,{head:function(){return this.vertex},tail:function(){return this.prev?this.prev.vertex:null},length:function(){var t=this.head(),e=this.tail();return null!==e?e.point.distanceTo(t.point):-1},lengthSquared:function(){var t=this.head(),e=this.tail();return null!==e?e.point.distanceToSquared(t.point):-1},setTwin:function(t){return this.twin=t,t.twin=this,this}}),Object.assign(P.prototype,{first:function(){return this.head},last:function(){return this.tail},clear:function(){return this.head=this.tail=null,this},insertBefore:function(t,e){return e.prev=t.prev,e.next=t,null===e.prev?this.head=e:e.prev.next=e,t.prev=e,this},insertAfter:function(t,e){return e.prev=t,e.next=t.next,null===e.next?this.tail=e:e.next.prev=e,t.next=e,this},append:function(t){return null===this.head?this.head=t:this.tail.next=t,t.prev=this.tail,t.next=null,this.tail=t,this},appendChain:function(t){for(null===this.head?this.head=t:this.tail.next=t,t.prev=this.tail;null!==t.next;)t=t.next;return this.tail=t,this},remove:function(t){return null===t.prev?this.head=t.next:t.prev.next=t.next,null===t.next?this.tail=t.prev:t.next.prev=t.prev,this},removeSubList:function(t,e){return null===t.prev?this.head=e.next:t.prev.next=e.next,null===e.next?this.tail=t.prev:e.next.prev=t.prev,this},isEmpty:function(){return null===this.head}});var V=function(t){function e(e){t.call(this),this.points=e,this.fromBufferGeometry(new I(e)),this.mergeVertices()}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e}(e.Geometry),I=function(t){function i(i){t.call(this),this.points=i;var n=[],o=[];void 0===_&&console.error("THREE.ConvexBufferGeometry: ConvexBufferGeometry relies on THREE.QuickHull");for(var r=(new _).setFromPoints(i).faces,s=0;s<r.length;s++){var a=r[s],c=a.edge;do{var u=c.head().point;n.push(u.x,u.y,u.z),o.push(a.normal.x,a.normal.y,a.normal.z),c=c.next}while(c!==a.edge)}this.addAttribute("position",new e.Float32BufferAttribute(n,3)),this.addAttribute("normal",new e.Float32BufferAttribute(o,3))}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i}(e.BufferGeometry),A=function(){};!function(){var t=new e.Vector3,i=new e.Vector3;function n(t,e){var i=t.indexOf(e);i>-1&&t.splice(i,1)}function o(t,e){var i,n,o=e.position.distanceTo(t.position),r=0,s=[],a=t.faces.length;for(i=0;i<a;i++)(n=t.faces[i]).hasVertex(e)&&s.push(n);for(i=0;i<a;i++){var c=1;n=t.faces[i];for(var u=0;u<s.length;u++){var l=n.normal.dot(s[u].normal);c=Math.min(c,(1.001-l)/2)}r=Math.max(r,c)}return s.length<2&&(r=1),o*r+0}function r(t){if(0===t.neighbors.length)return t.collapseNeighbor=null,void(t.collapseCost=-.01);t.collapseCost=1e5,t.collapseNeighbor=null;for(var e=0;e<t.neighbors.length;e++){var i=o(t,t.neighbors[e]);t.collapseNeighbor||(t.collapseNeighbor=t.neighbors[e],t.collapseCost=i,t.minCost=i,t.totalCost=0,t.costCount=0),t.costCount++,t.totalCost+=i,i<t.minCost&&(t.collapseNeighbor=t.neighbors[e],t.minCost=i)}t.collapseCost=t.totalCost/t.costCount}function s(t,e){for(console.assert(0===t.faces.length);t.neighbors.length;)n(t.neighbors.pop().neighbors,t);n(e,t)}function a(t,e){n(e,t),t.v1&&n(t.v1.faces,t),t.v2&&n(t.v2.faces,t),t.v3&&n(t.v3.faces,t);for(var i,o,r=[t.v1,t.v2,t.v3],s=0;s<3;s++)o=r[(s+1)%3],(i=r[s])&&o&&(i.removeIfNonNeighbor(o),o.removeIfNonNeighbor(i))}function c(t,e,i,n){if(n){var o,c=[];for(o=0;o<i.neighbors.length;o++)c.push(i.neighbors[o]);for(o=i.faces.length-1;o>=0;o--)i.faces[o].hasVertex(n)&&a(i.faces[o],e);for(o=i.faces.length-1;o>=0;o--)i.faces[o].replaceVertex(i,n);for(s(i,t),o=0;o<c.length;o++)r(c[o])}else s(i,t)}function u(t){for(var e=t[0],i=0;i<t.length;i++)t[i].collapseCost<e.collapseCost&&(e=t[i]);return e}function l(t,i,n,o,r,s){this.a=o,this.b=r,this.c=s,this.v1=t,this.v2=i,this.v3=n,this.normal=new e.Vector3,this.computeNormal(),t.faces.push(this),t.addUniqueNeighbor(i),t.addUniqueNeighbor(n),i.faces.push(this),i.addUniqueNeighbor(t),i.addUniqueNeighbor(n),n.faces.push(this),n.addUniqueNeighbor(t),n.addUniqueNeighbor(i)}function h(t,e){this.position=t,this.id=e,this.faces=[],this.neighbors=[],this.collapseCost=0,this.collapseNeighbor=null}l.prototype.computeNormal=function(){var e=this.v1.position,n=this.v2.position;t.subVectors(this.v3.position,n),i.subVectors(e,n),t.cross(i).normalize(),this.normal.copy(t)},l.prototype.hasVertex=function(t){return t===this.v1||t===this.v2||t===this.v3},l.prototype.replaceVertex=function(t,e){t===this.v1?this.v1=e:t===this.v2?this.v2=e:t===this.v3&&(this.v3=e),n(t.faces,this),e.faces.push(this),t.removeIfNonNeighbor(this.v1),this.v1.removeIfNonNeighbor(t),t.removeIfNonNeighbor(this.v2),this.v2.removeIfNonNeighbor(t),t.removeIfNonNeighbor(this.v3),this.v3.removeIfNonNeighbor(t),this.v1.addUniqueNeighbor(this.v2),this.v1.addUniqueNeighbor(this.v3),this.v2.addUniqueNeighbor(this.v1),this.v2.addUniqueNeighbor(this.v3),this.v3.addUniqueNeighbor(this.v1),this.v3.addUniqueNeighbor(this.v2),this.computeNormal()},h.prototype.addUniqueNeighbor=function(t){var e,i;-1===(e=this.neighbors).indexOf(i=t)&&e.push(i)},h.prototype.removeIfNonNeighbor=function(t){var e=this.neighbors,i=this.faces,n=e.indexOf(t);if(-1!==n){for(var o=0;o<i.length;o++)if(i[o].hasVertex(t))return;e.splice(n,1)}},A.prototype.modify=function(t,i){t.isBufferGeometry&&(t=(new e.Geometry).fromBufferGeometry(t)),t.mergeVertices();var n,o,s,a=t.vertices,p=t.faces,f=[],d=[];for(n=0,o=a.length;n<o;n++){var m=new h(a[n],n);f.push(m)}for(n=0,o=p.length;n<o;n++){var x=new l(f[M=(w=p[n]).a],f[F=w.b],f[T=w.c],M,F,T);d.push(x)}for(n=0,o=f.length;n<o;n++)r(f[n]);for(var y=i;y--;){if(!(s=u(f))){console.log("THREE.SimplifyModifier: No next vertex");break}c(f,d,s,s.collapseNeighbor)}var g=new e.BufferGeometry,v=[],b=[];for(n=0;n<f.length;n++)v.push((m=f[n].position).x,m.y,m.z);for(n=0;n<d.length;n++){var w,M=f.indexOf((w=d[n]).v1),F=f.indexOf(w.v2),T=f.indexOf(w.v3);b.push(M,F,T)}return g.addAttribute("position",new e.Float32BufferAttribute(v,3)),g.setIndex(b),g}}();var j=function(){};j.compute=function(t,i){void 0===i&&(i=30);var n="BufferGeometry"===t.type?t:null,o=n?(new e.Geometry).fromBufferGeometry(n):t;if(o.vertices.length<i)return this.hulls.set(t,o),o;var r=new A,s=new V(o.vertices);if(s.vertices.length>i){var a=r.modify(s,s.vertices.length-i);s=(new e.Geometry).fromBufferGeometry(a)}return this.hulls.set(t,s),s},j.get=function(t){return this.hulls.get(t)||t},j.hulls=new WeakMap;var O=function(t){function i(){t.apply(this,arguments),this.objectFilter=W.objectFilter,this.objectExpansion="box",this.coordinateSystem=void 0,this._vector=new e.Vector3,this._mat4=new e.Matrix4,this._box=new e.Box3,this._center=new e.Vector3,this._size=new e.Vector3}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype._onObjectTraverse=function(t){return!(this.objectFilter&&!this.objectFilter(t)||(this._objectExpandFunction.call(this,t),0))},i.prototype.setFromObject=function(t){switch(this.makeEmpty(),this.objectExpansion){case"geometry":this._objectExpandFunction=this.expandByObjectGeometry;break;case"hull":this._objectExpandFunction=this.expandByObjectHull;break;case"box":default:this._objectExpandFunction=this.expandByObjectBox}this._objectExpandFunction.call(this,t);for(var e=0,i=t.children;e<i.length;e+=1)g(i[e],this._onObjectTraverse,this);return this},i.prototype.expandByObjectGeometry=function(t){var e,i,n=this._vector,o=t;t.updateWorldMatrix(!1,!1);var r=o.geometry;if(void 0!==r){var s=this._getCoordinateSystemTransform(t);if(r.isGeometry){var a=r.vertices;for(e=0,i=a.length;e<i;e++)n.copy(a[e]),n.applyMatrix4(s),this.expandByPoint(n)}else if(r.isBufferGeometry){var c=r.attributes.position;if(void 0!==c)for(e=0,i=c.count;e<i;e++)n.fromBufferAttribute(c,e).applyMatrix4(s),this.expandByPoint(n)}}return this},i.prototype.expandByObjectHull=function(t){var e=this._vector,i=t.geometry;if(!i)return this;var n=this._getCoordinateSystemTransform(t);if((i=j.get(i))&&"vertices"in i)for(var o=i.vertices,r=0;r<o.length;++r)e.copy(o[r]).applyMatrix4(n),this.expandByPoint(e);else for(var s=i.getAttribute("position"),a=0;a<s.count;a+=s.itemSize)e.set(s.getX(a),s.getY(a),s.getZ(a)).applyMatrix4(n),this.expandByPoint(e);return this},i.prototype.expandByObjectBox=function(t){var e=this._box,i=t.geometry;return i?(null===i.boundingBox&&i.computeBoundingBox(),e.copy(i.boundingBox),e.applyMatrix4(this._getCoordinateSystemTransform(t)),this.union(e),this):this},i.prototype._getCoordinateSystemTransform=function(t){var e=this._mat4;return this.coordinateSystem?e.getInverse(this.coordinateSystem.transitioner.matrixWorldTarget).multiply(t.transitioner.matrixWorldTarget):e.copy(t.transitioner.matrixWorldTarget),e},i.prototype.relativeToAbsolute=function(t,e){if(void 0===e&&(e=t),this.isEmpty())e.copy(t).multiplyScalar(0);else{var i=this._center,n=this._size;this.getCenter(i),this.getSize(n),e.copy(t).multiplyScalar(.5).multiply(n).add(i)}return e},i.prototype.absoluteToRelative=function(t,e){if(void 0===e&&(e=t),this.isEmpty())e.copy(t).multiplyScalar(0);else{var i=this._center,n=this._size;this.getCenter(i),this.getSize(n),e.copy(t).sub(i).divide(n).multiplyScalar(2)}return e},i.prototype.isEmpty=function(){return!(isFinite(this.min.x)||isFinite(this.min.y)||isFinite(this.min.z)||isFinite(this.max.x)||isFinite(this.max.y)||isFinite(this.max.z))},i}(e.Box3),E=(new e.Quaternion).setFromAxisAngle(s,Math.PI),S=function(t){this.coordinateSystem=t,this.objectFilter=W.objectFilter,this.objectExpansion="box",this.min=new e.Vector3(Infinity,Infinity,Infinity),this.max=new e.Vector3(-Infinity,-Infinity,-Infinity),this.minClamped=new e.Vector3,this.maxClamped=new e.Vector3,this._vec3=new e.Vector3,this._mat4=new e.Matrix4,this._boxPoints=[new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3]},D={left:{configurable:!0},leftClamped:{configurable:!0},top:{configurable:!0},topClamped:{configurable:!0},right:{configurable:!0},rightClamped:{configurable:!0},bottom:{configurable:!0},bottomClamped:{configurable:!0},near:{configurable:!0},nearClamped:{configurable:!0},far:{configurable:!0},farClamped:{configurable:!0},horizontal:{configurable:!0},horizontalClamped:{configurable:!0},vertical:{configurable:!0},verticalClamped:{configurable:!0},depth:{configurable:!0},depthClamped:{configurable:!0},diagonal:{configurable:!0},diagonalClamped:{configurable:!0}};D.left.get=function(){return this.isEmpty()?0:this.min.x},D.leftClamped.get=function(){return this.isEmpty()?0:this.minClamped.x},D.top.get=function(){return this.isEmpty()?0:this.max.y},D.topClamped.get=function(){return this.isEmpty()?0:this.maxClamped.y},D.right.get=function(){return this.isEmpty()?0:this.max.x},D.rightClamped.get=function(){return this.isEmpty()?0:this.maxClamped.x},D.bottom.get=function(){return this.isEmpty()?0:this.min.y},D.bottomClamped.get=function(){return this.isEmpty()?0:this.minClamped.y},D.near.get=function(){return this.isEmpty()?0:this.min.z},D.nearClamped.get=function(){return this.isEmpty()?0:this.minClamped.z},D.far.get=function(){return this.isEmpty()?0:this.max.z},D.farClamped.get=function(){return this.isEmpty()?0:this.maxClamped.z},D.horizontal.get=function(){return this.isEmpty()?0:this.right-this.left},D.horizontalClamped.get=function(){return this.isEmpty()?0:this.rightClamped-this.leftClamped},D.vertical.get=function(){return this.isEmpty()?0:this.top-this.bottom},D.verticalClamped.get=function(){return this.isEmpty()?0:this.topClamped-this.bottomClamped},D.depth.get=function(){return this.isEmpty()?0:this.far-this.near},D.depthClamped.get=function(){return this.isEmpty()?0:this.farClamped-this.nearClamped},D.diagonal.get=function(){if(this.isEmpty())return 0;var t=W.getCartesianForSphericalDirection(this.min,f.get()),i=W.getCartesianForSphericalDirection(this.max,f.get()),n=t.angleTo(i);return f.pool(t),f.pool(i),n*e.Math.RAD2DEG},D.diagonalClamped.get=function(){if(this.isEmpty())return 0;var t=W.getCartesianForSphericalDirection(this.minClamped,f.get()),i=W.getCartesianForSphericalDirection(this.maxClamped,f.get()),n=t.angleTo(i);return f.pool(t),f.pool(i),n*e.Math.RAD2DEG},S.prototype.isEmpty=function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},S.prototype.getCenter=function(t){return t.set(this.right-this.horizontal/2,this.top-this.vertical/2,this.far-this.depth/2)},S.prototype.getClampedCenter=function(t){return t.set(this.rightClamped-this.horizontalClamped/2,this.topClamped-this.verticalClamped/2,this.farClamped-this.depthClamped/2)},S.prototype.getSize=function(t){return t.set(this.horizontal,this.vertical,this.depth)},S.prototype.getClampedSize=function(t){return t.set(this.horizontalClamped,this.verticalClamped,this.depthClamped)},S.prototype.getPositionForOffset=function(t,e){var i=this.getCenter(f.get()),n=this.getSize(f.get());return e.copy(t).multiplyScalar(.5).multiply(n).add(i),f.pool(i),f.pool(n),e},S.prototype.getClampedPositionForOffset=function(t,e){var i=this.getClampedCenter(f.get()),n=this.getClampedSize(f.get());return e.copy(t).multiplyScalar(.5).multiply(n).add(i),f.pool(i),f.pool(n),e},S.prototype.setFromPerspectiveProjectionMatrix=function(t){var i=y.get().getInverse(t),n=f.get();this.min.x=-n.set(-1,0,-1).applyMatrix4(i).angleTo(a)*e.Math.RAD2DEG,this.max.x=n.set(1,0,-1).applyMatrix4(i).angleTo(a)*e.Math.RAD2DEG,this.min.y=-n.set(0,-1,-1).applyMatrix4(i).angleTo(a)*e.Math.RAD2DEG,this.max.y=n.set(0,1,-1).applyMatrix4(i).angleTo(a)*e.Math.RAD2DEG,this.min.z=-n.set(0,0,-1).applyMatrix4(i).z,this.max.z=-n.set(0,0,1).applyMatrix4(i).z,y.pool(i),f.pool(n),this._applyClamping()},S.prototype.makeEmpty=function(){this.min.set(Infinity,Infinity,Infinity),this.max.set(-Infinity,-Infinity,-Infinity)},S.prototype.setFromObject=function(t){switch(this.makeEmpty(),this.objectExpansion){case"geometry":case"hull":this._objectExpandFunction=this.expandByObjectHull;break;case"box":default:this._objectExpandFunction=this.expandByObjectBox}this._objectExpandFunction.call(this,t);for(var e=0,i=t.children;e<i.length;e+=1)g(i[e],this._onObjectTraverse,this);return this},S.prototype._onObjectTraverse=function(t){return!(this.objectFilter&&!this.objectFilter(t)||(this._objectExpandFunction.call(this,t),0))},S.prototype.expandByObjectHull=function(t){var e=t;if(e.isMesh){var i=this.coordinateSystem,n=this._vec3,o=this._mat4.getInverse(i.matrixWorld).multiply(e.matrixWorld),r=j.get(e.geometry),s=W.get(i);if("vertices"in r)for(var a=0,c=r.vertices;a<c.length;a+=1){n.copy(c[a]).applyMatrix4(o);var u=s.getVisualPositionForCartesianPosition(n,n);this.min.min(u),this.max.max(u)}else for(var l=r.getAttribute("position"),h=0;h<l.count;h+=l.itemSize){n.set(l.getX(h),l.getY(h),l.getZ(h)).applyMatrix4(o);var p=s.getVisualPositionForCartesianPosition(n,n);this.min.min(p),this.max.max(p)}this._applyClamping()}},S.prototype.expandByObjectBox=function(t){var e=this._mat4,i=t,n=i.geometry;if(!n)return this;null===n.boundingBox&&n.computeBoundingBox();var o=n.boundingBox,r=this._boxPoints;r[0].set(o.min.x,o.min.y,o.min.z),r[1].set(o.min.x,o.min.y,o.max.z),r[2].set(o.min.x,o.max.y,o.min.z),r[3].set(o.min.x,o.max.y,o.max.z),r[4].set(o.max.x,o.min.y,o.min.z),r[5].set(o.max.x,o.min.y,o.max.z),r[6].set(o.max.x,o.max.y,o.min.z),r[7].set(o.max.x,o.max.y,o.max.z);for(var s=this.coordinateSystem,a=W.get(s),c=e.getInverse(s.matrixWorld).multiply(i.matrixWorld),u=0,l=r;u<l.length;u+=1){var h=l[u];h.applyMatrix4(c);var p=a.getVisualPositionForCartesianPosition(h,h);this.min.min(p),this.max.max(p)}this._applyClamping()},S.prototype._applyClamping=function(){this.minClamped.copy(this.min),this.maxClamped.copy(this.max),this.minClamp&&this.minClamped.min(this.minClamp),this.maxClamp&&this.maxClamped.max(this.maxClamp)},Object.defineProperties(S.prototype,D);var W=function(t){this.object=t,this.matrixWorldGetter="target",this._box=new O,this._visualFrustum=new S(this.object)};W.get=function(t){return this._metrics.has(t)?this._metrics.get(t):(this._metrics.set(t,new W(t)),this._metrics.get(t))},W.getCartesianForSphericalDirection=function(t,i){var n=e.Math.DEG2RAD*t.y,o=e.Math.DEG2RAD*t.x,r=Math.sin(n),s=Math.cos(n)*Math.sin(o),a=-Math.cos(n)*Math.cos(o);return i.set(s,r,a).normalize(),i},W.getSphericalDirectionForCartesian=function(t,i){var n=f.get().copy(t).normalize();return i.y=Math.asin(n.y)*e.Math.RAD2DEG,i.x=Math.atan2(n.x,-n.z)*e.Math.RAD2DEG,f.pool(n),i},W.getSphericalPositionForCartesian=function(t,i){var n=t.length(),o=i.copy(t).normalize();return i.y=Math.asin(o.y)*e.Math.RAD2DEG,i.x=Math.atan2(o.x,-o.z)*e.Math.RAD2DEG,i.z=n,i},W.getCartesianForSphericalPosition=function(t,e){var i=t.z,n=p.get().set(t.x,t.y);return W.getCartesianForSphericalDirection(n,e).multiplyScalar(i),p.pool(n),e},W.prototype.getMatrixWorld=function(t){return"current"===this.matrixWorldGetter?t.matrixWorld:t.transitioner.matrixWorldTarget},W.prototype.getCartesianForVisualDirection=function(t,e){return W.getCartesianForSphericalDirection(t,e),this.object.isCamera||e.applyQuaternion(E),e},W.prototype.getVisualDirectionForCartesian=function(t,e){var i=f.get().copy(t);return this.object.isCamera||i.applyQuaternion(E),W.getSphericalDirectionForCartesian(i,e),f.pool(i),e},W.prototype.getVisualPositionForCartesianPosition=function(t,e){var i=e.copy(t);return this.object.isCamera||i.applyQuaternion(E),W.getSphericalPositionForCartesian(i,e),e},W.prototype.getCartesianForVisualPosition=function(t,e){var i=t.z,n=p.get().set(t.x,t.y);return this.getCartesianForVisualDirection(n,e).multiplyScalar(i),p.pool(n),e},W.prototype.getPositionOf=function(t,e){e.setFromMatrixPosition(this.getMatrixWorld(t));var i=y.get().getInverse(this.getMatrixWorld(this.object));return e.applyMatrix4(i),y.pool(i),e},W.prototype.getDistanceOf=function(t){var e=f.get(),i=this.getPositionOf(t,e).length();return f.pool(e),i},W.prototype.getDirectionOf=function(t,e){var i=this.getPositionOf(t,e),n=i.lengthSq();return 0!==n&&isFinite(n)?i.normalize():e.set(0,0,this.object.isCamera?-1:1)},W.prototype.getWorldDirectionOf=function(t,e){return this.getDirectionOf(t,e).transformDirection(this.getMatrixWorld(this.object))},W.prototype.getClosestOrthogonalOrientationOf=function(t,e){for(var i,n,r=this.object,s=(r?y.get().getInverse(this.getMatrixWorld(r)):y.get()).multiply(this.getMatrixWorld(t)),a=s.extractRotation(s),c=e.setFromRotationMatrix(a),u=f.get().set(0,0,1).applyQuaternion(c),l=f.get().set(0,1,0).applyQuaternion(c),h=Infinity,p=Infinity,d=0,m=N;d<m.length;d+=1){var x=m[d],g=l.distanceToSquared(x);g<p&&(p=g,n=x)}for(var v=0,b=N;v<b.length;v+=1){var w=b[v];if(!(w.x&&n.x||w.y&&n.y||w.z&&n.z)){var M=u.distanceToSquared(w);M<h&&(h=M,i=w)}}a.identity(),a.lookAt(i,o,n),c.setFromRotationMatrix(a),y.pool(a),r.updateMatrixWorld()},W.prototype.getOrientationOf=function(t,e){var i=y.get(),n=m.get().setFromRotationMatrix(i.extractRotation(this.getMatrixWorld(t))),o=m.get().setFromRotationMatrix(i.extractRotation(this.getMatrixWorld(this.object))).inverse();return e.multiplyQuaternions(o,n),m.pool(n),m.pool(o),y.pool(i),e},W.prototype.getVisualDirectionOf=function(t,e){var i=this.getDirectionOf(t,f.get()),n=this.getVisualDirectionForCartesian(i,e);return f.pool(i),n},W.prototype.getVisualAngleOf=function(t,e){var i=this.getDirectionOf(t,f.get()),n=this.getVisualDirectionForCartesian(i,e);return f.pool(i),n},W.prototype.getBoundsOf=function(t,e){return void 0===e&&(e=this._box),e===this._box&&(e.objectFilter=W.objectFilter,e.objectExpansion="box"),e.coordinateSystem=this.object,e.setFromObject(t)},W.prototype.getVisualFrustumOf=function(t,e){return void 0===t&&(t=this.object),void 0===e&&(e=this._visualFrustum),e===this._visualFrustum&&(e.objectFilter=W.objectFilter),t.isCamera?e.setFromPerspectiveProjectionMatrix(t.projectionMatrix):e.setFromObject(t),e},W.prototype.getVisualOffsetOf=function(t){var i=this.getDirectionOf(t,f.get());this.object.isCamera||i.applyQuaternion(E);var n=a.angleTo(i)*e.Math.RAD2DEG;return f.pool(i),n},W._metrics=new WeakMap,W.objectFilter=function(t){return!t.layout.isBoundingContext()};var N=[new e.Vector3(1,0,0),new e.Vector3(0,1,0),new e.Vector3(0,0,1),new e.Vector3(-1,0,0),new e.Vector3(0,-1,0),new e.Vector3(0,0,-1)],G=function(t){this.object=t,this.forceBoundsExclusion=!1,this.weight=1,this.absolute=new O,this.relative=new O,this.orientation=new e.Quaternion,this.minRelativeSize=new e.Vector3,this.minAbsoluteSize=new e.Vector3,this._fit="contain",this.fitTargets={contain:1,contain3d:0,cover:0,cover3d:0,fill:0,fill3d:0},this.fitAlign=new e.Vector3,this.clip=new O,this.inner=new O,this.innerAutoUpdate=!0,this.computedBounds=new O,this.computedInnerBounds=new O,this.computedOuterBounds=new O,this.computedClipBounds=new O,this.matrix=new e.Matrix4,this._boundsValid=!1,this.computedInnerBounds.objectFilter=W.objectFilter,this.computedInnerBounds.objectExpansion="box",this.computedInnerBounds.coordinateSystem=t},U={fit:{configurable:!0}};U.fit.set=function(t){for(var e in this._fit=t,this.fitTargets)this.fitTargets[e]=0;this.fitTargets[t]=1},U.fit.get=function(){return this._fit},G.prototype.invalidateBounds=function(){this._boundsValid=!1},G.prototype.resetLayout=function(){this.fit="contain",this.absolute.makeEmpty(),this.relative.makeEmpty()},G.prototype.resetPose=function(){this.object.position.setScalar(0),this.object.quaternion.set(0,0,0,1),this.object.scale.setScalar(1)},G.prototype.reset=function(){this.resetLayout(),this.resetPose()},G.prototype.isPassive=function(){return this.absolute.isEmpty()&&this.relative.isEmpty()},G.prototype.isBoundingContext=function(){return!!this.forceBoundsExclusion||!this.isPassive()&&(this.forceBoundsExclusion=!0,!0)},G.prototype.updateMatrix=function(){var t=this.computedBounds;if(this.isPassive())this.matrix.identity();else{this._boundsValid||(G.updateInnerBounds(this.object),G.updateOuterBounds(this.object),this.computedInnerBounds.isEmpty()&&this.computedInnerBounds.copy(this.computedOuterBounds),this._boundsValid=!0);var e=this.absolute,i=this.relative,n=this.fitTargets,o=this.orientation,r=this.computedInnerBounds,s=this.computedOuterBounds,a=this.clip;if(t.makeEmpty(),s.relativeToAbsolute(i.min,t.min),s.relativeToAbsolute(i.max,t.max),isFinite(e.min.x)&&(t.min.x=(isFinite(t.min.x)?t.min.x:0)+e.min.x),isFinite(e.min.y)&&(t.min.y=(isFinite(t.min.y)?t.min.y:0)+e.min.y),isFinite(e.min.z)&&(t.min.z=(isFinite(t.min.z)?t.min.z:0)+e.min.z),isFinite(e.max.x)&&(t.max.x=(isFinite(t.max.x)?t.max.x:0)+e.max.x),isFinite(e.max.y)&&(t.max.y=(isFinite(t.max.y)?t.max.y:0)+e.max.y),isFinite(e.max.z)&&(t.max.z=(isFinite(t.max.z)?t.max.z:0)+e.max.z),!a.isEmpty()){var c=r.absoluteToRelative(a.max,f.get()),u=r.absoluteToRelative(a.min,f.get());t.relativeToAbsolute(c,c),t.relativeToAbsolute(u,u),isFinite(c.x)||(c.x=Infinity),isFinite(c.y)||(c.y=Infinity),isFinite(c.z)||(c.z=Infinity),isFinite(u.x)||(u.x=-Infinity),isFinite(u.y)||(u.y=-Infinity),isFinite(u.z)||(u.z=-Infinity),t.max.min(c),t.min.max(u),f.pool(c),f.pool(u)}var l=s.getSize(f.get()).multiply(this.minRelativeSize).max(this.minAbsoluteSize),h=r.getSize(f.get()),p=t.getSize(f.get()).max(l).divide(h);G.adjustScaleForFit(n,p);var d=f.get().multiplyVectors(h,p);d.x=Math.abs(d.x),d.y=Math.abs(d.y),d.z=Math.abs(d.z),isFinite(t.min.x)||isFinite(t.max.x)||(t.max.x=d.x/2,t.min.x=-t.max.x),isFinite(t.min.y)||isFinite(t.max.y)||(t.max.y=d.y/2,t.min.y=-t.max.y),isFinite(t.min.z)||isFinite(t.max.z)||(t.max.z=d.z/2,t.min.z=-t.max.z),isFinite(t.max.x)||(t.max.x=t.min.x+d.x),isFinite(t.max.y)||(t.max.y=t.min.y+d.y),isFinite(t.max.z)||(t.max.z=t.min.z+d.z),isFinite(t.min.x)||(t.min.x=t.max.x-d.x),isFinite(t.min.y)||(t.min.y=t.max.y-d.y),isFinite(t.min.z)||(t.min.z=t.max.z-d.z);var m=y.get().makeRotationFromQuaternion(o),x=d.divideScalar(2),g=t.relativeToAbsolute(this.fitAlign,f.get());t.min.copy(g).sub(x),t.max.copy(g).add(x),t.applyMatrix4(m);var v=r.relativeToAbsolute(this.fitAlign,f.get());v.multiply(p).applyMatrix4(m),t.min.sub(v),t.max.sub(v);var b=t.getCenter(f.get());this.matrix.compose(b,o,p),f.pool(h),f.pool(l),f.pool(d),f.pool(b),f.pool(p),f.pool(g)}},G.updateInnerBounds=function(t){var e=t.layout,i=e.computedInnerBounds;return e._boundsValid?i:(i.coordinateSystem=t,i.setFromObject(t).union(e.inner),i.min.x===i.max.x&&(i.max.x+=1e-10),i.min.y===i.max.y&&(i.max.y+=1e-10),i.min.z===i.max.z&&(i.max.z+=1e-10),i)},G.updateOuterBounds=function(t){var e=t.layout,i=e.computedOuterBounds;if(e._boundsValid)return i;var n=t.parent,o=n;if(o&&o.isCamera){var r=f.get().setFromMatrixPosition(t.matrix),s=y.get().getInverse(o.projectionMatrix),a=i.min.set(0,0,-1).applyMatrix4(s).z,c=i.min.set(0,0,1).applyMatrix4(s).z,u=i.min.set(0,0,r.z).applyMatrix4(o.projectionMatrix).z;i.min.set(-1,-1,u),i.max.set(1,1,u),i.min.applyMatrix4(s),i.max.applyMatrix4(s),i.min.z=c,i.max.z=a,f.pool(r),y.pool(s)}else n?i.copy(n.layout.computedInnerBounds):i.makeEmpty();var l=y.get().makeRotationFromQuaternion(e.orientation);return i.applyMatrix4(l.getInverse(l)),y.pool(l),i},G.adjustScaleForFit=function(t,i){var n=this._fitScale,o=i,r=1e-10,s=1e10;if(!isFinite(o.x)&&!isFinite(o.y)&&!isFinite(o.z))return o.setScalar(1),o;isFinite(o.x)||(o.x=s),isFinite(o.y)||(o.y=s),isFinite(o.z)||(o.z=s),o.x=o.x<0?e.Math.clamp(o.x,-s,-r):e.Math.clamp(o.x,r,s),o.y=o.y<0?e.Math.clamp(o.y,-s,-r):e.Math.clamp(o.y,r,s),o.z=o.z<0?e.Math.clamp(o.z,-s,-r):e.Math.clamp(o.z,r,s);var a=o.x,c=o.y,u=o.z,l=Math.abs(a),h=Math.abs(c),p=Math.abs(u);return t.fill&&(n.set(a,c,a+c/2),o.lerp(n,t.fill)),t.contain&&(l<h?n.set(a,a,a):n.set(c,c,c),o.lerp(n,t.contain)),t.contain3d&&(l<h&&l<p?n.set(a,a,a):h<l&&h<p?n.set(c,c,c):n.set(u,u,u),o.lerp(n,t.contain3d)),t.cover&&(l>h?n.set(a,a,a):n.set(c,c,c),o.lerp(n,t.cover)),t.cover3d&&(l>h&&l>p?n.set(a,a,a):h>l&&h>p?n.set(c,c,c):n.set(u,u,u),o.lerp(n,t.cover3d)),isFinite(o.x)||(o.x=r),isFinite(o.y)||(o.y=r),isFinite(o.z)||(o.z=r),o.x=o.x<0?e.Math.clamp(o.x,-s,-r):e.Math.clamp(o.x,r,s),o.y=o.y<0?e.Math.clamp(o.y,-s,-r):e.Math.clamp(o.y,r,s),o.z=o.z<0?e.Math.clamp(o.z,-s,-r):e.Math.clamp(o.z,r,s),o},Object.defineProperties(G.prototype,U),G._fitScale=new e.Vector3;var R=function(t){return function(e){return 1-t(1-e)}},q=function(t){return function(e){return e<=.5?t(2*e)/2:(2-t(2*(1-e)))/2}},H=R,k=q,L=function(t){return function(e){return Math.pow(e,t)}},Q=function(t){return function(e){return e*e*((t+1)*e-t)}},X=function(t){var e=Q(t);return function(t){return(t*=2)<1?.5*e(t):.5*(2-Math.pow(2,-10*(t-1)))}},Y=L(2),Z=R(Y),$=q(Y),J=function(t){return 1-Math.sin(Math.acos(t))},K=R(J),tt=q(K),et=Q(1.525),it=function(t){var e=t*t;return t<4/11?7.5625*e:t<8/11?9.075*e-9.9*t+3.4:t<.9?4356/361*e-35442/1805*t+16061/1805:10.8*t*t-20.52*t+10.72},nt="undefined"!=typeof Float32Array,ot=function(t,e){return 1-3*e+3*t},rt=function(t,e){return 3*e-6*t},st=function(t){return 3*t},at=function(t,e,i){return 3*ot(e,i)*t*t+2*rt(e,i)*t+st(e)},ct=function(t,e,i){return((ot(e,i)*t+rt(e,i))*t+st(e))*t},ut={reversed:R,mirrored:q,createReversedEasing:H,createMirroredEasing:k,createExpoIn:L,createBackIn:Q,createAnticipateEasing:X,linear:function(t){return t},easeIn:Y,easeOut:Z,easeInOut:$,circIn:J,circOut:K,circInOut:tt,backIn:et,backOut:R(et),backInOut:q(et),anticipate:X(1.525),bounceOut:it,bounceIn:function(t){return 1-it(1-t)},bounceInOut:function(t){return t<.5?.5*(1-it(1-2*t)):.5*it(2*t-1)+.5},cubicBezier:function(t,e,i,n){var o=nt?new Float32Array(11):new Array(11);return function(){for(var e=0;e<11;++e)o[e]=ct(.1*e,t,i)}(),function(r){return t===e&&i===n?r:0===r?0:1===r?1:ct(function(e){for(var n,r,s=0,a=1;10!==a&&o[a]<=e;++a)s+=.1;return(r=at(n=s+(e-o[--a])/(o[a+1]-o[a])*.1,t,i))>=.001?function(e,n){for(var o=0,r=0;o<8;++o){if(0===(r=at(n,t,i)))return n;n-=(ct(n,t,i)-e)/r}return n}(e,n):0===r?n:function(e,n,o){var r,s,a=0;do{(r=ct(s=n+(o-n)/2,t,i)-e)>0?o=s:n=s}while(Math.abs(r)>1e-7&&++a<10);return s}(e,s,s+.1)}(r),e,n)}}};function lt(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];for(var i=0,n=t;i<n.length;i+=1){var o=n[i];if(void 0!==o)return o}}var ht=function(t){this.multiplier=void 0,this.duration=void 0,this.easing=void 0,this.threshold=void 0,this.delay=void 0,this.debounce=void 0,this.maxWait=void 0,this.targetQueue=[],this._delayTime=0,this._debounceTime=0,this._waitTime=0,this._changePercent=0,this._config={},Object.assign(this,t);var e=this.target;void 0===this.current&&(this.current="number"==typeof e?e:e.clone()),void 0===this.start&&(this.start="number"==typeof e?e:e.clone())};ht.prototype.update=function(t,e,i){var n=this._updateConfig(e),o=this.targetQueue,r=this.target;for(this._changePercent=i="number"==typeof i?i:this._computePercentChange(),t*=n.multiplier,i>n.threshold?(this._delayTime>n.delay&&("number"==typeof r?this.committedTarget=r:this.committedTarget?this.committedTarget.copy(r):this.committedTarget=r.clone(),this._delayTime=0,this._debounceTime=0),this._delayTime+=t):(void 0!==this.committedTarget&&(this._delayTime=0),this._debounceTime+=t),this.committedTarget&&(this._waitTime+=t),this.committedTarget&&(this._debounceTime>n.debounce||this._waitTime>n.maxWait)&&(o.push({value:this.committedTarget,easing:n.easing,duration:n.duration,elapsed:0}),this.committedTarget=void 0,this._waitTime=0);o.length&&o[0].elapsed>o[0].duration;)this.start=o.shift().value;this._setCurrent(this.start);for(var s=this.start,a=0,c=o;a<c.length;a+=1){var u=c[a];u.elapsed+=t,this._addTargetInfluence(s,u),s=u.value}},ht.prototype._addTargetInfluence=function(t,n){var r=n.duration>0?n.easing(Math.min(n.elapsed,n.duration)/n.duration):1;if("number"!=typeof n.value&&"isMatrix4"in n.value){var s=this.current,a=t,c=n.value,l=f.get(),h=m.get(),d=f.get();s.decompose(l,h,d);var x=f.get(),y=m.get(),g=f.get();a.decompose(x,y,g);var v=f.get(),b=m.get(),w=f.get();return c.decompose(v,b,w),l.add(v.sub(x).lerp(o,1-r)),h.multiply(y.inverse().multiply(b).slerp(u,1-r)).normalize(),d.add(w.sub(g).lerp(o,1-r)),f.pool(l),m.pool(h),f.pool(d),f.pool(x),m.pool(y),f.pool(g),f.pool(v),m.pool(b),void f.pool(w)}if("number"!=typeof n.value){if("isVector3"in n.value){var M=this.current,F=t,T=n.value,_=f.get().copy(T).sub(F).lerp(o,1-r);return M.add(_),void f.pool(_)}if("isVector2"in n.value){var B=this.current,z=t,C=n.value,P=p.get().copy(C).sub(z).lerp(i,1-r);return B.add(P),void p.pool(P)}if("isQuaternion"in n.value){var V=this.current,I=t,A=n.value,j=m.get().copy(I).inverse().multiply(A).slerp(u,1-r);return V.multiply(j).normalize(),void m.pool(j)}if("isColor"in n.value){var O=this.current,E=t,S=ht._c.copy(n.value).sub(E).lerp(ht._cBlack,1-r);O.add(S)}else if("isBox3"in n.value){var D=this.current,W=t,N=n.value,G=f.get().copy(N.min).sub(W.min).lerp(o,1-r),U=f.get().copy(N.max).sub(W.max).lerp(o,1-r);return isFinite(D.min.x)&&(D.min.x=0),isFinite(D.min.y)&&(D.min.y=0),isFinite(D.min.z)&&(D.min.z=0),isFinite(D.max.x)&&(D.max.x=0),isFinite(D.max.y)&&(D.max.y=0),isFinite(D.max.z)&&(D.max.z=0),D.min.add(G),void D.max.add(U)}}else this.current+=e.Math.lerp(0,n.value-t,r)},ht.prototype._setCurrent=function(t){"number"==typeof t?this.current=t:this.current.copy(t)},ht.prototype._computePercentChange=function(){var t=this.target,e=this.committedTarget||this.targetQueue[0]&&this.targetQueue[0].value||this.current;if("number"==typeof e)return Math.abs(t-e/(this.range||1));if("isMatrix4"in e){var i=e,n=t,o=f.get(),r=m.get(),s=f.get();i.decompose(o,r,s);var a=f.get(),c=m.get(),u=f.get();n.decompose(a,c,u);var l=o.equals(a)?0:Infinity,h=Math.abs(r.angleTo(c)/Math.PI),d=s.equals(u)?0:Infinity;return f.pool(o),m.pool(r),f.pool(s),f.pool(a),m.pool(c),f.pool(u),Math.max(l,h,d)}if("isVector3"in e){var x=e,y=t;if(!this.range)return y.equals(x)?0:Infinity;var g=f.get().subVectors(y,x).divide(this.range),v=g.x,b=g.y,w=g.z;return f.pool(g),Math.max(Math.abs(v||0),Math.abs(b||0),Math.abs(w||0))}if("isVector2"in e){var M=e,F=t;if(!this.range)return F.equals(M)?0:Infinity;var T=p.get().subVectors(F,M).divide(this.range),_=T.x,B=T.y;return p.pool(T),Math.max(Math.abs(_||0),Math.abs(B||0))}if("isQuaternion"in e)return Math.abs(e.angleTo(t)/Math.PI);if("isColor"in e){var z=e,C=t;return Math.max(Math.abs(C.r-z.r),Math.abs(C.g-z.r),Math.abs(C.b-z.r))}if("isBox3"in e){var P=e,V=t;if(!this.range)return V.equals(P)?0:Infinity;var I=this.range,A=f.get().subVectors(V.min,P.min).divide(I),j=f.get().subVectors(V.max,P.max).divide(I),O=Math.max(Math.abs(A.x||0),Math.abs(A.y||0),Math.abs(A.z||0)),E=Math.max(Math.abs(j.x||0),Math.abs(j.y||0),Math.abs(j.z||0));return f.pool(A),f.pool(j),Math.max(O,E)}return Infinity},ht.prototype._updateConfig=function(t){return this._config.multiplier=lt(this.multiplier,t&&t.multiplier,ft.DEFAULT_CONFIG.multiplier),this._config.duration=lt(this.duration,t&&t.duration,ft.DEFAULT_CONFIG.duration),this._config.easing=lt(this.easing,t&&t.easing,ft.DEFAULT_CONFIG.easing),this._config.threshold=lt(this.threshold,t&&t.threshold,ft.DEFAULT_CONFIG.threshold),this._config.delay=lt(this.delay,t&&t.delay,ft.DEFAULT_CONFIG.delay),this._config.debounce=lt(this.debounce,t&&t.debounce,ft.DEFAULT_CONFIG.debounce),this._config.maxWait=lt(this.maxWait,t&&t.maxWait,ft.DEFAULT_CONFIG.maxWait),this._config},ht._c=new e.Color,ht._cBlack=new e.Color(0,0,0);var pt=function(t){function i(i){t.call(this,{target:new e.Matrix4}),this.object=i,this.position=new t({target:new e.Vector3}),this.quaternion=new t({target:new e.Quaternion}),this.scale=new t({target:new e.Vector3(1,1,1)}),this.autoRange=!0,this.synchronizeComponents=!0}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.update=function(t,i){this._updateConfig(i);var n=this.position,o=this.quaternion,r=this.scale,s=this._config;this.autoRange&&(n.range||(n.range=new e.Vector3),r.range||(r.range=new e.Vector3),this.object.layout.computedOuterBounds.getSize(n.range),this.object.layout.computedOuterBounds.getSize(r.range).divide(n.range),isFinite(r.range.x)&&0!==r.range.x||(r.range.x=1),isFinite(r.range.y)&&0!==r.range.y||(r.range.y=1),isFinite(r.range.z)&&0!==r.range.z||(r.range.z=1)),this.target.decompose(n.target,o.target,r.target),this.current.decompose(n.current,o.current,r.current);var a=void 0;this.synchronizeComponents&&(a=Math.max(n._computePercentChange(),o._computePercentChange(),r._computePercentChange())),n.update(t,s,a),o.update(t,s,a),r.update(t,s,a),this.current.compose(n.current,o.current,r.current)},i}(ht),ft=function(t){this.object=t,this._active=!1,this.parentTarget=null,this.matrixWorldTarget=new e.Matrix4,this.multiplier=void 0,this.duration=void 0,this.easing=void 0,this.threshold=void 0,this.delay=void 0,this.debounce=void 0,this.maxWait=void 0,this.customTransitionables=[],this.matrixLocal=new pt(this.object)},dt={active:{configurable:!0}};dt.active.set=function(t){this._active=t},dt.active.get=function(){return this._active&&!ft.disableAllTransitions},ft.prototype.add=function(t){var e=t instanceof ht?t:new ht(t);return this.customTransitionables.push(e),e},ft.prototype.update=function(t,e){if(void 0===e&&(e=!0),!this.active&&e&&(this.active=!0),this.active){e&&this.object.updateWorldMatrix(!0,!0),this._setParent(),t=Math.max(t,1e-10),this.matrixLocal.update(t,this);for(var i=0,n=this.customTransitionables;i<n.length;i+=1)n[i].update(t,this);this.object.updateWorldMatrix(!1,!0)}else{this.matrixLocal.current.copy(this.matrixLocal.target);for(var o=0,r=this.customTransitionables;o<r.length;o+=1){var s=r[o];s._setCurrent(s.target)}}},ft.prototype._setParent=function(){var t=this.parentTarget,e=this.object;if(t&&e.parent!==t){e.updateWorldMatrix(!0,!0);var i=y.get().copy(e.matrixWorld);e.parent&&e.parent.remove(e),t&&t.add(e),t.updateWorldMatrix(!0,!0);var n=t?y.get().getInverse(t.matrixWorld):y.get().identity();e.matrix.copy(n.multiply(i)),e.matrix.decompose(e.position,e.quaternion,e.scale),y.pool(i),y.pool(n)}},Object.defineProperties(ft.prototype,dt),ft.disableAllTransitions=!1,ft.DEFAULT_CONFIG={multiplier:1,duration:1.5,easing:$,threshold:.01,delay:0,debounce:0,maxWait:10},ft.NATURAL_DURATION=-Math.log(1-.95);var mt=new e.Vector3,xt=new e.Vector3,yt=new e.Vector3,gt=new e.Vector2,vt=new e.Vector2,bt=new e.Vector2,wt=new e.Vector3,Mt=new e.Vector3;function Ft(t,i,n,o,r,s){const a=3*r,c=i.index.getX(a),u=i.index.getX(a+1),l=i.index.getX(a+2),h=function(t,i,n,o,r,s,a,c){mt.fromBufferAttribute(o,s),xt.fromBufferAttribute(o,a),yt.fromBufferAttribute(o,c);var u=function(t,i,n,o,r,s,a,c){if(null===(i.side===e.BackSide?o.intersectTriangle(a,s,r,!0,c):o.intersectTriangle(r,s,a,i.side!==e.DoubleSide,c)))return null;Mt.copy(c),Mt.applyMatrix4(t.matrixWorld);var u=n.ray.origin.distanceTo(Mt);return u<n.near||u>n.far?null:{distance:u,point:Mt.clone(),object:t}}(t,t.material,i,n,mt,xt,yt,wt);if(u){r&&(gt.fromBufferAttribute(r,s),vt.fromBufferAttribute(r,a),bt.fromBufferAttribute(r,c),u.uv=e.Triangle.getUV(wt,mt,xt,yt,gt,vt,bt,new e.Vector2));var l=new e.Vector3;u.face=new e.Face3(s,a,c,e.Triangle.getNormal(mt,xt,yt,l)),u.faceIndex=s}return u}(t,n,o,i.attributes.position,i.attributes.uv,c,u,l);return h?(h.faceIndex=r,s&&s.push(h),h):null}function Tt(t,e){return e.min.x=t[0],e.min.y=t[1],e.min.z=t[2],e.max.x=t[3],e.max.y=t[4],e.max.z=t[5],e}function _t(t){let e=-1,i=-Infinity;for(let n=0;n<3;n++){const o=t[n+3]-t[n];o>i&&(i=o,e=n)}return e}class Bt{constructor(){this.min=Infinity,this.max=-Infinity}setFromPointsField(t,e){let i=Infinity,n=-Infinity;for(let o=0,r=t.length;o<r;o++){const r=t[o][e];i=Math.min(r,i),n=Math.max(r,n)}this.min=i,this.max=n}setFromPoints(t,e){let i=Infinity,n=-Infinity;for(let o=0,r=e.length;o<r;o++){const r=t.dot(e[o]);i=Math.min(r,i),n=Math.max(r,n)}this.min=i,this.max=n}isSeparated(t){return this.min>t.max||t.min>this.max}}Bt.prototype.setFromBox=function(){const t=new e.Vector3;return function(e,i){const n=i.min,o=i.max;let r=Infinity,s=-Infinity;for(let i=0;i<=1;i++)for(let a=0;a<=1;a++)for(let c=0;c<=1;c++){t.x=n.x*i+o.x*(1-i),t.y=n.y*a+o.y*(1-a),t.z=n.z*c+o.z*(1-c);const u=e.dot(t);r=Math.min(u,r),s=Math.max(u,s)}this.min=r,this.max=s}}();const zt=function(){const t=new e.Vector3,i=new e.Vector3,n=new e.Vector3;return function(e,o,r){const s=t,a=i;n.subVectors(e.start,o.start),t.subVectors(e.end,o.start),i.subVectors(o.end,o.start);const c=n.dot(a),u=a.dot(s),l=a.dot(a),h=n.dot(s),p=s.dot(s)*l-u*u;let f,d;d=(c+(f=0!==p?(c*u-h*l)/p:0)*u)/l,r.x=f,r.y=d}}(),Ct=function(){const t=new e.Vector2,i=new e.Vector3,n=new e.Vector3;return function(e,o,r,s){zt(e,o,t);let a=t.x,c=t.y;if(a>=0&&a<=1&&c>=0&&c<=1)return e.at(a,r),void o.at(c,s);if(a>=0&&a<=1)return o.at(c<0?0:1,s),void e.closestPointToPoint(s,!0,r);if(c>=0&&c<=1)return e.at(a<0?0:1,r),void o.closestPointToPoint(r,!0,s);{let t,u;t=a<0?e.start:e.end;const l=i,h=n;return e.closestPointToPoint(u=c<0?o.start:o.end,!0,i),o.closestPointToPoint(t,!0,n),l.distanceToSquared(u)<=h.distanceToSquared(t)?(r.copy(l),void s.copy(u)):(r.copy(t),void s.copy(h))}}}(),Pt=function(){const t=new e.Vector3,i=new e.Vector3,n=new e.Plane,o=new e.Line3;return function(e,r){const{radius:s,center:a}=e,{a:c,b:u,c:l}=r;if(o.start=c,o.end=u,o.closestPointToPoint(a,!0,t).distanceTo(a)<=s)return!0;if(o.start=c,o.end=l,o.closestPointToPoint(a,!0,t).distanceTo(a)<=s)return!0;if(o.start=u,o.end=l,o.closestPointToPoint(a,!0,t).distanceTo(a)<=s)return!0;const h=r.getPlane(n);if(Math.abs(h.distanceToPoint(a))<=s){const t=h.projectPoint(a,i);if(r.containsPoint(t))return!0}return!1}}();class Vt extends e.Triangle{constructor(...t){super(...t),this.isSeparatingAxisTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new e.Vector3),this.satBounds=new Array(4).fill().map(()=>new Bt),this.points=[this.a,this.b,this.c],this.sphere=new e.Sphere}}Vt.prototype.update=function(){const t=new Array(3);return function(){const e=this.a,i=this.b,n=this.c;t[0]=this.a,t[1]=this.b,t[2]=this.c;const o=this.satAxes,r=this.satBounds,s=o[0],a=r[0];this.getNormal(s),a.setFromPoints(s,t);const c=o[1],u=r[1];c.subVectors(e,i),u.setFromPoints(c,t);const l=o[2],h=r[2];l.subVectors(i,n),h.setFromPoints(l,t);const p=o[3],f=r[3];p.subVectors(n,e),f.setFromPoints(p,t),this.sphere.setFromPoints(this.points)}}(),Vt.prototype.intersectsTriangle=function(){const t=new Vt,i=new Array(3),n=new Array(3),o=new Bt,r=new Bt,s=new e.Vector3;return function(e){e.isSeparatingAxisTriangle||(t.copy(e),t.update(),e=t);const a=this.satBounds,c=this.satAxes;n[0]=e.a,n[1]=e.b,n[2]=e.c;for(let t=0;t<4;t++){const e=a[t];if(o.setFromPoints(c[t],n),e.isSeparated(o))return!1}const u=e.satBounds,l=e.satAxes;i[0]=this.a,i[1]=this.b,i[2]=this.c;for(let t=0;t<4;t++){const e=u[t];if(o.setFromPoints(l[t],i),e.isSeparated(o))return!1}for(let t=0;t<4;t++){const e=c[t];for(let t=0;t<4;t++)if(s.crossVectors(e,l[t]),o.setFromPoints(s,i),r.setFromPoints(s,n),o.isSeparated(r))return!1}return!0}}(),Vt.prototype.distanceToPoint=function(){const t=new e.Vector3;return function(e){return this.closestPointToPoint(e,t),e.distanceTo(t)}}(),Vt.prototype.distanceToTriangle=function(){const t=new e.Vector3,i=new e.Vector3,n=["a","b","c"],o=new e.Line3,r=new e.Line3;return function(e,s=null,a=null){if(this.intersectsTriangle(e))return(s||a)&&(this.getMidpoint(t),e.closestPointToPoint(t,i),this.closestPointToPoint(i,t),s&&s.copy(t),a&&a.copy(i)),0;let c=Infinity;for(let i=0;i<3;i++){let o;const r=n[i],u=e[r];this.closestPointToPoint(u,t),(o=u.distanceToSquared(t))<c&&(c=o,s&&s.copy(t),a&&a.copy(u));const l=this[r];e.closestPointToPoint(l,t),(o=l.distanceToSquared(t))<c&&(c=o,s&&s.copy(l),a&&a.copy(t))}for(let u=0;u<3;u++){o.set(this[n[u]],this[n[(u+1)%3]]);for(let u=0;u<3;u++){r.set(e[n[u]],e[n[(u+1)%3]]),Ct(o,r,t,i);const l=t.distanceToSquared(i);l<c&&(c=l,s&&s.copy(t),a&&a.copy(i))}}return Math.sqrt(c)}}();class It extends e.Box3{constructor(...t){super(...t),this.isOrientedBox=!0,this.matrix=new e.Matrix4,this.invMatrix=new e.Matrix4,this.points=new Array(8).fill().map(()=>new e.Vector3),this.satAxes=new Array(3).fill().map(()=>new e.Vector3),this.satBounds=new Array(3).fill().map(()=>new Bt),this.alignedSatBounds=new Array(3).fill().map(()=>new Bt),this.sphere=new e.Sphere}set(t,e,i){super.set(t,e),this.matrix=i}copy(t){super.copy(t),this.matrix.copy(t.matrix)}}It.prototype.update=function(){const t=this.matrix,e=this.min,i=this.max,n=this.points;for(let o=0;o<=1;o++)for(let r=0;r<=1;r++)for(let s=0;s<=1;s++){const a=n[1*o|2*r|4*s];a.x=o?i.x:e.x,a.y=r?i.y:e.y,a.z=s?i.z:e.z,a.applyMatrix4(t)}this.sphere.setFromPoints(this.points);const o=this.satBounds,r=this.satAxes,s=n[0];for(let t=0;t<3;t++){const e=r[t],i=o[t];e.subVectors(s,n[1<<t]),i.setFromPoints(e,n)}const a=this.alignedSatBounds;a[0].setFromPointsField(n,"x"),a[1].setFromPointsField(n,"y"),a[2].setFromPointsField(n,"z"),this.invMatrix.getInverse(this.matrix)},It.prototype.intersectsBox=function(){const t=new Bt;return function(e){if(!e.intersectsSphere(this.sphere))return!1;const i=e.min,n=e.max,o=this.satBounds,r=this.satAxes,s=this.alignedSatBounds;if(t.min=i.x,t.max=n.x,s[0].isSeparated(t))return!1;if(t.min=i.y,t.max=n.y,s[1].isSeparated(t))return!1;if(t.min=i.z,t.max=n.z,s[2].isSeparated(t))return!1;for(let i=0;i<3;i++){const n=o[i];if(t.setFromBox(r[i],e),n.isSeparated(t))return!1}return!0}}(),It.prototype.intersectsTriangle=function(){const t=new Vt,i=new Array(3),n=new Bt,o=new Bt,r=new e.Vector3;return function(e){e.isSeparatingAxisTriangle||(t.copy(e),t.update(),e=t);const s=this.satBounds,a=this.satAxes;i[0]=e.a,i[1]=e.b,i[2]=e.c;for(let t=0;t<3;t++){const e=s[t];if(n.setFromPoints(a[t],i),e.isSeparated(n))return!1}const c=e.satBounds,u=e.satAxes,l=this.points;for(let t=0;t<3;t++){const e=c[t];if(n.setFromPoints(u[t],l),e.isSeparated(n))return!1}for(let t=0;t<3;t++){const e=a[t];for(let t=0;t<4;t++)if(r.crossVectors(e,u[t]),n.setFromPoints(r,i),o.setFromPoints(r,l),n.isSeparated(o))return!1}return!0}}(),It.prototype.closestPointToPoint=function(t,e){return e.copy(t).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),e},It.prototype.distanceToPoint=function(){const t=new e.Vector3;return function(e){return this.closestPointToPoint(e,t),e.distanceTo(t)}}(),It.prototype.distanceToBox=function(){const t=["x","y","z"],i=new Array(12).fill().map(()=>new e.Line3),n=new Array(12).fill().map(()=>new e.Line3),o=new e.Vector3,r=new e.Vector3;return function(e,s=0,a=null,c=null){if(this.intersectsBox(e))return(a||c)&&(e.getCenter(r),this.closestPointToPoint(r,o),e.closestPointToPoint(o,r),a&&a.copy(o),c&&c.copy(r)),0;const u=s*s,l=e.min,h=e.max,p=this.points;let f=Infinity;for(let t=0;t<8;t++){const e=p[t];r.copy(e).clamp(l,h);const i=e.distanceToSquared(r);if(i<f&&(f=i,a&&a.copy(e),c&&c.copy(r),i<u))return Math.sqrt(i)}let d=0;for(let e=0;e<3;e++)for(let o=0;o<=1;o++)for(let r=0;r<=1;r++){const s=(e+1)%3,a=(e+2)%3;i[d].set(p[o<<s|r<<a],p[1<<e|o<<s|r<<a]);const c=t[e],u=t[s],f=t[a],m=n[d],x=m.start,y=m.end;x[c]=l[c],x[u]=o?l[u]:h[u],x[f]=r?l[f]:h[u],y[c]=h[c],y[u]=o?l[u]:h[u],y[f]=r?l[f]:h[u],d++}for(let t=0;t<=1;t++)for(let e=0;e<=1;e++)for(let i=0;i<=1;i++){r.x=t?h.x:l.x,r.y=e?h.y:l.y,r.z=i?h.z:l.z,this.closestPointToPoint(r,o);const n=r.distanceToSquared(o);if(n<f&&(f=n,a&&a.copy(o),c&&c.copy(r),n<u))return Math.sqrt(n)}for(let t=0;t<12;t++){const e=i[t];for(let t=0;t<12;t++){Ct(e,n[t],o,r);const i=o.distanceToSquared(r);if(i<f&&(f=i,a&&a.copy(o),c&&c.copy(r),i<u))return Math.sqrt(i)}}return Math.sqrt(f)}}();const At=new e.Box3,jt=new e.Vector3,Ot=["x","y","z"];function Et(t,e,i,n){const o=t.a,r=t.b,s=t.c;let a=i.getX(e);o.x=n.getX(a),o.y=n.getY(a),o.z=n.getZ(a),a=i.getX(e+1),r.x=n.getX(a),r.y=n.getY(a),r.z=n.getZ(a),a=i.getX(e+2),s.x=n.getX(a),s.y=n.getY(a),s.z=n.getZ(a)}class St{constructor(){}intersectRay(t,e){return Tt(this.boundingData,At),t.intersectBox(At,e)}raycast(t,e,i,n){this.count?function(t,e,i,n,o,r,s){for(let a=o,c=o+r;a<c;a++)Ft(t,e,i,n,a,s)}(t,t.geometry,e,i,this.offset,this.count,n):(this.left.intersectRay(i,jt)&&this.left.raycast(t,e,i,n),this.right.intersectRay(i,jt)&&this.right.raycast(t,e,i,n))}raycastFirst(t,e,i){if(this.count)return function(t,e,i,n,o,r){let s=Infinity,a=null;for(let c=o,u=o+r;c<u;c++){const o=Ft(t,e,i,n,c);o&&o.distance<s&&(a=o,s=o.distance)}return a}(t,t.geometry,e,i,this.offset,this.count);{const n=this.splitAxis,o=Ot[n];let r,s;i.direction[o]>=0?(r=this.left,s=this.right):(r=this.right,s=this.left);const a=r.intersectRay(i,jt)?r.raycastFirst(t,e,i):null;if(a){const t=i.origin[o],e=t-a.point[o],r=t-s.boundingData[n],c=t-s.boundingData[n+3],u=e*e;if(u<=r*r&&u<=c*c)return a}const c=s.intersectRay(i,jt)?s.raycastFirst(t,e,i):null;return a&&c?a.distance<=c.distance?a:c:a||c||null}}}St.prototype.shapecast=function(){const t=new Vt,i=new e.Box3,n=new e.Box3;return function(e,o,r=null,s=null){if(this.count&&r){const i=e.geometry,n=i.index,o=i.attributes.position,s=this.offset;for(let e=3*s,i=3*(this.count+s);e<i;e+=3)if(Et(t,e,n,o),t.update(),r(t,e,e+1,e+2))return!0;return!1}{const t=this.left,a=this.right;let c,u,l,h,p=t,f=a;if(s&&(h=n,Tt(p.boundingData,l=i),Tt(f.boundingData,h),c=s(l),(u=s(h))<c)){p=a,f=t;const e=c;c=u,u=e;const i=l;l=h,h=i}return l||Tt(p.boundingData,l=i),!!(o(l,!!p.count,c,p)&&p.shapecast(e,o,r,s)||(h||Tt(f.boundingData,h=n),o(h,!!f.count,u,f)&&f.shapecast(e,o,r,s)))}}}(),St.prototype.intersectsGeometry=function(){const t=new Vt,i=new Vt,n=new e.Mesh,o=new e.Matrix4,r=new It,s=new It;return function(e,a,c,u=null){if(null===u&&(a.boundingBox||a.computeBoundingBox(),r.set(a.boundingBox.min,a.boundingBox.max,c),r.update(),u=r),!this.count){const t=this.left,i=this.right;return Tt(t.boundingData,At),!!(u.intersectsBox(At)&&t.intersectsGeometry(e,a,c,u)||(Tt(i.boundingData,At),u.intersectsBox(At)&&i.intersectsGeometry(e,a,c,u)))}{const r=e.geometry,u=r.index,l=r.attributes.position,h=a.index,p=a.attributes.position,f=this.offset,d=this.count;if(o.getInverse(c),a.boundsTree){Tt(this.boundingData,s),s.matrix.copy(o),s.update(),n.geometry=a;const t=a.boundsTree.shapecast(n,t=>s.intersectsBox(t),function(t){t.a.applyMatrix4(c),t.b.applyMatrix4(c),t.c.applyMatrix4(c),t.update();for(let e=3*f,n=3*(d+f);e<n;e+=3)if(Et(i,e,u,l),i.update(),t.intersectsTriangle(i))return!0;return!1});return n.geometry=null,t}for(let e=3*f,n=d+3*f;e<n;e+=3){Et(t,e,u,l),t.a.applyMatrix4(o),t.b.applyMatrix4(o),t.c.applyMatrix4(o),t.update();for(let e=0,n=h.count;e<n;e+=3)if(Et(i,e,h,p),i.update(),t.intersectsTriangle(i))return!0}}}}(),St.prototype.intersectsBox=function(){const t=new It;return function(e,i,n){return t.set(i.min,i.max,n),t.update(),this.shapecast(e,e=>t.intersectsBox(e),e=>t.intersectsTriangle(e))}}(),St.prototype.intersectsSphere=function(t,e){return this.shapecast(t,t=>e.intersectsBox(t),t=>Pt(e,t))},St.prototype.closestPointToPoint=function(){const t=new e.Vector3;return function(e,i,n=null,o=0,r=Infinity){let s=Infinity;return this.shapecast(e,(t,e,i)=>i<s&&i<r,e=>{e.closestPointToPoint(i,t);const r=i.distanceTo(t);return r<s&&(n&&n.copy(t),s=r),r<o},t=>t.distanceToPoint(i)),s}}(),St.prototype.closestPointToGeometry=function(){const t=new Vt,i=new It,n=new e.Vector3,o=new e.Vector3;return function(e,r,s,a=null,c=null,u=0,l=Infinity){r.boundingBox||r.computeBoundingBox(),i.set(r.boundingBox.min,r.boundingBox.max,s),i.update();const h=r.attributes.position,p=r.index;let f,d;a&&(f=n),c&&(d=o);let m=Infinity;return this.shapecast(e,(t,e,i)=>i<m&&i<l,e=>{const i=e.sphere;for(let n=0,o=p.count;n<o;n+=3){Et(t,n,p,h),t.a.applyMatrix4(s),t.b.applyMatrix4(s),t.c.applyMatrix4(s),t.sphere.setFromPoints(t.points);const o=t.sphere;if(o.center.distanceTo(i.center)-o.radius-i.radius>m)continue;t.update();const r=e.distanceToTriangle(t,f,d);if(r<m&&(a&&a.copy(f),c&&c.copy(d),m=r),r<u)return!0}return!1},t=>i.distanceToBox(t,Math.min(m,l))),m}}();const Dt=0,Wt=1,Nt=2,Gt=["x","y","z"],Ut=new e.Box3;class Rt{constructor(t,e){if(this.geo=t,this.options=e,this.bounds=function(t){const e=t.attributes.position.array,i=t.index.array,n=i.length/3,o=new Float32Array(6*n);for(let t=0;t<n;t++){const n=3*i[3*t+0],r=3*i[3*t+1],s=3*i[3*t+2];for(let i=0;i<3;i++){const a=e[n+i],c=e[r+i],u=e[s+i],l=Math.min(a,c,u),h=(Math.max(a,c,u)-l)/2;o[6*t+2*i+0]=l+h,o[6*t+2*i+1]=h}}return o}(t),this.sahplanes=null,e.strategy===Nt){const e=t.index.count/3;this.sahplanes=[new Array(e),new Array(e),new Array(e)];for(let t=0;t<e;t++)for(let e=0;e<3;e++)this.sahplanes[e][t]={p:this.bounds[6*t+2*e],tri:t}}}getAverage(t,e,i){let n=0;const o=this.bounds;for(let r=t,s=t+e;r<s;r++)n+=o[6*r+2*i];return n/e}getBounds(t,e,i){let n=Infinity,o=Infinity,r=Infinity,s=-Infinity,a=-Infinity,c=-Infinity;const u=this.bounds;for(let i=t,l=t+e;i<l;i++){const t=u[6*i+0],e=u[6*i+1];n=Math.min(n,t-e),s=Math.max(s,t+e);const l=u[6*i+2],h=u[6*i+3];o=Math.min(o,l-h),a=Math.max(a,l+h);const p=u[6*i+4],f=u[6*i+5];r=Math.min(r,p-f),c=Math.max(c,p+f)}return i[0]=n,i[1]=o,i[2]=r,i[3]=s,i[4]=a,i[5]=c,i}partition(t,e,i){let n=t,o=t+e-1;const r=i.pos,s=2*i.axis,a=this.geo.index.array,c=this.bounds,u=this.sahplanes;for(;;){for(;n<=o&&c[6*n+s]<r;)n++;for(;n<=o&&c[6*o+s]>=r;)o--;if(!(n<o))return n;for(let t=0;t<3;t++){let e=a[3*n+t];a[3*n+t]=a[3*o+t],a[3*o+t]=e;let i=c[6*n+2*t+0];c[6*n+2*t+0]=c[6*o+2*t+0],c[6*o+2*t+0]=i;let r=c[6*n+2*t+1];c[6*n+2*t+1]=c[6*o+2*t+1],c[6*o+2*t+1]=r}if(u)for(let t=0;t<3;t++){let e=u[t][n];u[t][n]=u[t][o],u[t][o]=e}n++,o--}}getOptimalSplit(t,e,i,n){let o=-1,r=0;if(n===Dt)-1!==(o=_t(t))&&(r=(t[o+3]+t[o])/2);else if(n===Wt)-1!==(o=_t(t))&&(r=this.getAverage(e,i,o));else if(n===Nt){const n=3,s=1,a=Tt(t,Ut),c=[a.max.x-a.min.x,a.max.y-a.min.y,a.max.z-a.min.z],u=2*(c[0]*c[1]+c[0]*c[2]+c[1]*c[2]),l=[[],[],[]];for(let t=e,n=e+i;t<n;t++)for(let e=0;e<3;e++)l[e].push(this.sahplanes[e][t]);l.forEach(t=>t.sort((t,e)=>t.p-e.p));const h=(t,e,i,o,r)=>n+s*(e/t*i+o/t*r);o=-1;let p=s*i;for(let t=0;t<3;t++){const e=(t+1)%3,n=(t+2)%3,s=a.min[Gt[t]],f=a.max[Gt[t]],d=l[t];let m=0,x=i;for(let i=0;i<d.length;i++){const a=d[i],l=a.p-s,y=f-a.p;let g=c[e],v=c[e],b=c[n],w=c[n];const M=h(u,2*(g*b+g*l+b*l),++m,2*(v*w+v*y+w*y),--x);M<p&&(o=t,r=a.p,p=M)}}}return{axis:o,pos:r}}}class qt{constructor(t,e={}){if(!t.isBufferGeometry)throw new Error("MeshBVH: Only BufferGeometries are supported.");if(t.attributes.position.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the position attribute.");if(t.index&&t.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.");(e=Object.assign({strategy:Dt,maxDepth:40,maxLeafTris:10,verbose:!0},e)).strategy=Math.max(0,Math.min(2,e.strategy)),this._roots=this._buildTree(t,e)}_ensureIndex(t){if(!t.index){const i=t.attributes.position.count,n=new(i>65535?Uint32Array:Uint16Array)(i);t.setIndex(new e.BufferAttribute(n,1));for(let t=0;t<i;t++)n[t]=t}}_getRootIndexRanges(t){if(!t.groups||!t.groups.length)return[{offset:0,count:t.index.count/3}];const e=[],i=new Set;for(const e of t.groups)i.add(e.start),i.add(e.start+e.count);const n=Array.from(i.values()).sort((t,e)=>t-e);for(let t=0;t<n.length-1;t++){const i=n[t];e.push({offset:i/3,count:(n[t+1]-i)/3})}return e}_buildTree(t,i){this._ensureIndex(t);const n=new Rt(t,i);let o=!1;const r=(t,e,s,a=0)=>{if(a>=i.maxDepth&&(o=!0),s<=i.maxLeafTris||a>=i.maxDepth)return t.offset=e,t.count=s,t;const c=n.getOptimalSplit(t.boundingData,e,s,i.strategy);if(-1===c.axis)return t.offset=e,t.count=s,t;const u=n.partition(e,s,c);if(u===e||u===e+s)t.offset=e,t.count=s;else{t.splitAxis=c.axis;const i=t.left=new St,o=e,l=u-e;i.boundingData=n.getBounds(o,l,new Float32Array(6)),r(i,o,l,a+1);const h=t.right=new St,p=u,f=s-l;h.boundingData=n.getBounds(p,f,new Float32Array(6)),r(h,p,f,a+1)}return t},s=[],a=this._getRootIndexRanges(t);if(1===a.length){const e=new St,i=a[0];e.boundingData=null!=t.boundingBox?function(t){const e=new Float32Array(6);return e[0]=t.min.x,e[1]=t.min.y,e[2]=t.min.z,e[3]=t.max.x,e[4]=t.max.y,e[5]=t.max.z,e}(t.boundingBox):n.getBounds(i.offset,i.count,new Float32Array(6)),r(e,i.offset,i.count),s.push(e)}else for(let t of a){const e=new St;e.boundingData=n.getBounds(t.offset,t.count,new Float32Array(6)),r(e,t.offset,t.count),s.push(e)}if(o&&i.verbose&&(console.warn(`MeshBVH: Max depth of ${i.maxDepth} reached when generating BVH. Consider increasing maxDepth.`),console.warn(this,t)),null==t.boundingBox){const i=new e.Box3;t.boundingBox=new e.Box3;for(let e of s)t.boundingBox.union(Tt(e.boundingData,i))}return s}raycast(t,e,i,n){for(const o of this._roots)o.raycast(t,e,i,n)}raycastFirst(t,e,i){let n=null;for(const o of this._roots){const r=o.raycastFirst(t,e,i);null!=r&&(null==n||r.distance<n.distance)&&(n=r)}return n}intersectsGeometry(t,e,i){for(const n of this._roots)if(n.intersectsGeometry(t,e,i))return!0;return!1}shapecast(t,e,i=null,n=null){for(const o of this._roots)if(o.shapecast(t,e,i,n))return!0;return!1}intersectsBox(t,e,i){for(const n of this._roots)if(n.intersectsBox(t,e,i))return!0;return!1}intersectsSphere(t,e){for(const i of this._roots)if(i.intersectsSphere(t,e))return!0;return!1}closestPointToGeometry(t,e,i,n,o,r,s){let a=Infinity;for(const c of this._roots){const u=c.closestPointToGeometry(t,e,i,n,o,r,s);if(u<a&&(a=u),u<r)return u}return a}distanceToGeometry(t,e,i,n,o){return this.closestPointToGeometry(t,e,i,null,null,n,o)}closestPointToPoint(t,e,i,n,o){let r=Infinity;for(const s of this._roots){const a=s.closestPointToPoint(t,e,i,n,o);if(a<r&&(r=a),a<n)return a}return r}distanceToPoint(t,e,i,n){return this.closestPointToPoint(t,e,null,i,n)}}new e.LineBasicMaterial({color:65416,transparent:!0,opacity:.3}),new e.Box3Helper,new e.Box3;const Ht=new e.Ray,kt=new e.Matrix4,Lt=e.Mesh.prototype.raycast;e.BufferGeometry.prototype.computeBoundsTree=function(t){return this.boundsTree=new qt(this,t),this.boundsTree},e.BufferGeometry.prototype.disposeBoundsTree=function(){this.boundsTree=null},e.Mesh.prototype.raycast=function(t,e){if(this.geometry.boundsTree){if(void 0===this.material)return;if(kt.getInverse(this.matrixWorld),Ht.copy(t.ray).applyMatrix4(kt),!0===t.firstHitOnly){const i=this.geometry.boundsTree.raycastFirst(this,t,Ht);i&&e.push(i)}else this.geometry.boundsTree.raycast(this,t,Ht,e)}else Lt.call(this,t,e)};var Qt=new e.Vector3;e.Object3D.prototype.updateMatrix=function(){var t=this.position,e=this.quaternion,i=this.scale;Qt.copy(i),0===Qt.x&&(Qt.x=1e-10),0===Qt.y&&(Qt.y=1e-10),0===Qt.z&&(Qt.z=1e-10),this.matrix.compose(t,e,i)},e.Object3D.prototype.updateMatrixWorld=function(t){this._inUpdateWorldMatrix||this.updateWorldMatrix(!1,!0,!0)},e.Object3D.prototype.updateWorldMatrix=function(t,e,i){void 0===i&&(i=!0);var n=this.parent;!0===t&&null!==n&&n.updateWorldMatrix(!0,!1,!0),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix);var o=this.children;if(!0===e)for(var r=0,s=o.length;r<s;r++)o[r].updateWorldMatrix(!1,!0,!1);if(!0===i){e&&this.layout.invalidateBounds(),this.layout.updateMatrix();var a=this.transitioner;a.matrixLocal.target.multiplyMatrices(this.layout.matrix,this.matrix);var c=a.active?a.matrixLocal.current:a.matrixLocal.target;if(null===n?(a.matrixWorldTarget.copy(a.matrixLocal.target),this.matrixWorld.copy(c)):(a.matrixWorldTarget.multiplyMatrices(n.transitioner.matrixWorldTarget,a.matrixLocal.target),this.matrixWorld.multiplyMatrices(n.matrixWorld,c)),!0===e)for(r=0,s=o.length;r<s;r++)o[r].updateWorldMatrix(!1,!0,!0)}this._inUpdateWorldMatrix=!0,this.updateMatrixWorld(),this._inUpdateWorldMatrix=!1},Object.defineProperty(e.Object3D.prototype,"layout",{get:function(){if(this!==e.Object3D.prototype)return Object.defineProperty(this,"layout",{value:new G(this),writable:!0,enumerable:!0}),this.layout}}),Object.defineProperty(e.Object3D.prototype,"transitioner",{get:function(){if(this!==e.Object3D.prototype)return Object.defineProperty(this,"transitioner",{value:new ft(this),writable:!0,enumerable:!0}),this.transitioner}});var Xt=function(t){function i(){t.call(this),this._transitional=new e.Object3D,this._transitionalBoxHelper=new e.Box3Helper(this._transitional.layout.inner),this._target=new e.Object3D,this._targetBoxHelper=new e.Box3Helper(this._target.layout.inner),this.add(this._transitional),this._transitional.layout.innerAutoUpdate=!1,this._transitional.layout.forceBoundsExclusion=!0,this._transitional.add(this._transitionalBoxHelper),this._transitionalBoxHelper.layout.forceBoundsExclusion=!0,this.add(this._target),this._target.layout.innerAutoUpdate=!1,this._target.layout.forceBoundsExclusion=!0,this._target.add(this._targetBoxHelper),this._targetBoxHelper.layout.forceBoundsExclusion=!0,this._targetBoxHelper.material.color.setStyle("magenta")}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.updateWorldMatrix=function(e,i,n){t.prototype.updateWorldMatrix.call(this,e,i,n),this.parent&&(this._target.layout.inner.copy(this.parent.layout.computedInnerBounds),this._target.matrixWorld.copy(this.parent.transitioner.matrixWorldTarget),this._targetBoxHelper.updateMatrixWorld(),this._transitional.layout.inner.copy(this.parent.layout.computedInnerBounds),this._transitional.updateMatrixWorld())},i}(e.Object3D),Yt=function(){},Zt=function(){};Zt.addBehavior=function(t,e){var i,n=t[Zt._getBehaviors]=t[Zt._getBehaviors]||[];(i="function"==typeof e?{object:t,update:e}:e).object=t,i.init&&i.init(),n.push(i)},Zt.getBehaviors=function(t){return t[Zt._getBehaviors]},Zt.update=function(t,e,i){Zt.currentScene=t,Zt.currentCamera=e,Zt.currentDeltaTime=i,t.updateWorldMatrix(!0,!0),Zt.ensureUpdate(e),t.traverse(Zt.ensureUpdate),Zt.currentScene=void 0,Zt.currentCamera=void 0,Zt.currentDeltaTime=void 0,Promise.resolve(t).then(Zt.clearUpdateFlag)},Zt.clearUpdateFlag=function(t){t.traverse(function(t){return t[Zt._didUpdate]=!1})},Zt.ensureUpdate=function(t){if(!Zt.currentScene)throw new Error("AdaptivityManager.ensureUpdate: must be called inside a Behavior callback");if(!t[Zt._didUpdate]){t[Zt._didUpdate]=!0,t.parent&&Zt.ensureUpdate(t.parent);var e=Zt.getBehaviors(t);if(ft.disableAllTransitions=!0,e)for(var i=0,n=e;i<n.length;i+=1){var o=n[i];o.update&&(o.update(Zt.currentDeltaTime),t.updateWorldMatrix(!1,!0))}if(ft.disableAllTransitions=!1,t.transitioner.update(Zt.currentDeltaTime,!1),e)for(var r=0,s=e;r<s.length;r+=1){var a=s[r];a.postUpdate&&(a.postUpdate(Zt.currentDeltaTime),t.updateWorldMatrix(!1,!0))}}},Zt._getBehaviors=Symbol("getBehaviors"),Zt._didUpdate=Symbol("didUpdate");var $t=function(t){function e(){t.apply(this,arguments),this._boxA=new O,this._boxB=new O,this.occluders=[],this.occluderInfluenceDelay=.5,this.occlusionTime=new WeakMap}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.update=function(t){var e=W.get(Zt.currentCamera),i=this.object;i.layout.clip.makeEmpty(),i.updateWorldMatrix(!0,!0);var n=W.get(i),o=e.getDistanceOf(i),r=this._boxA.copy(i.layout.computedInnerBounds);r.min.z=-Infinity,r.max.z=Infinity;for(var s=i.layout.clip,a=0;a<this.occluders.length;a++){var c=this.occluders[a];if(e.getDistanceOf(c)>o)this.occlusionTime.set(c,0);else{Zt.ensureUpdate(c);var u=n.getBoundsOf(c,this._boxB);if(u.min.z=-Infinity,u.max.z=Infinity,r.intersectsBox(u)){var l=(this.occlusionTime.get(c)||0)+t;if(this.occlusionTime.set(c,l),!(l<this.occluderInfluenceDelay)){var h=u.getCenter(f.get());h.x>0&&(s.max.x=isFinite(s.max.x)?Math.min(u.min.x,s.max.x):u.min.x),h.x<0&&(s.min.x=isFinite(s.min.x)?Math.max(u.max.x,s.min.x):u.max.x),h.y>0&&(s.max.y=isFinite(s.max.y)?Math.min(u.min.y,s.max.y):u.min.y),h.y<0&&(s.min.y=isFinite(s.min.y)?Math.max(u.max.y,s.min.y):u.max.y)}}else this.occlusionTime.set(c,0)}}},e.prototype.postUpdate=function(){},e}(Yt);t.SimplifiedHull=j,t.Box3=O,t.VisualFrustum=S,t.SpatialMetrics=W,t.LayoutFit={contain:"contain",contain3d:"contain3d",cover:"cover",cover3d:"cover3d",fill:"fill",fill3d:"fill3d"},t.Layout=G,t.easing=ut,t.TransitionTarget=function(t,e,i){this.value=t,this.duration=e,this.easing=i},t.Transitionable=ht,t.LocalMatrixTransitionable=pt,t.Transitioner=ft,t.LayoutHelper=Xt,t.Behavior=Yt,t.AdaptivityManager=Zt,t.AdaptiveClippingBehavior=$t,t.V_00=i,t.V_11=n,t.V_000=o,t.V_100=r,t.V_010=s,t.V_001=a,t.V_111=c,t.Q_IDENTITY=u,t.Pool=h,t.vectors2=p,t.vectors=f,t.vectors4=d,t.quaternions=m,t.matrices3=x,t.matrices=y,t.traverse=g});
//# sourceMappingURL=ethereal.umd.js.map
