var t,e,s,i=(t,e,s)=>{if(!e.has(t))throw TypeError("Cannot "+s)},r=(t,e,s)=>(i(t,e,"read from private field"),s?s.call(t):e.get(t)),n=(t,e,s,r)=>(i(t,e,"write to private field"),r?r.call(t,s):e.set(t,s),s);import{t as a,u as o,v as h,w as c,x as l,y as u,z as d,F as p,H as m,J as g,K as y,U as _,X as f,Y as v,Z as b,_ as w,$ as x,a0 as S,a1 as M,a2 as R,a3 as T,a4 as E,a5 as z,a6 as A,j as C,m as D,a7 as L,M as B,n as I,O as N,a8 as O,a9 as U,aa as F,ab as P,ac as k,ad as V,f as j,ae as G,af as W,ag as q,ah as $,ai as Q,aj as X}from"./vendor.1a9225bf.js";const H=Object.freeze(new a(0,0)),Y=Object.freeze(new a(1,1)),Z=Object.freeze(new o(0,0,0)),K=Object.freeze(new o(1,0,0)),J=Object.freeze(new o(0,1,0)),tt=Object.freeze(new o(0,0,1)),et=Object.freeze(new o(1,1,1)),st=Object.freeze(new h),it={RIGHT:Object.freeze(new o(1,0,0)),UP:Object.freeze(new o(0,1,0)),NEAR:Object.freeze(new o(0,0,1)),LEFT:Object.freeze(new o(-1,0,0)),DOWN:Object.freeze(new o(0,-1,0)),FAR:Object.freeze(new o(0,0,-1))};function rt(t,e){return"number"==typeof t?function(t,e){if(e===t)return 0;const s=Math.abs(e-t),i=(Math.abs(e)+Math.abs(t))/2;return s/i}(t,e):"isVector3"in t?function(t,e){if(e.equals(t))return 0;const s=e.distanceTo(t),i=(e.length()+t.length())/2;return s/i}(t,e):"isVector2"in t?function(t,e){if(e.equals(t))return 0;const s=e.distanceTo(t),i=(e.length()+t.length())/2;return s/i}(t,e):"isBox3"in t?function(t,e){if(t.equals(e))return 0;const s=nt,i=e.min.distanceTo(t.min),r=e.max.distanceTo(t.max),n=(i+r)/2,a=(e.getSize(s).length()+t.getSize(s).length())/2;return n/a}(t,e):"isQuaternion"in t?(i=e,(s=t).equals(i)?0:s.angleTo(i)/Math.PI):"isColor"in t?function(t,e){if(t.equals(e))return 0;return nt.set(Math.abs(e.r-t.r),Math.abs(e.g-t.g),Math.abs(e.b-t.b)).length()/at}(t,e):1/0;var s,i}const nt=new o;const at=Math.sqrt(3),ot=(t=1)=>{var e=Math.random();return(e%1e-8>5e-9?1:-1)*Math.sqrt(-Math.log(Math.max(1e-9,e)))*t},ht=(t=1)=>{const e=Math.sqrt(Math.sqrt(1/(2*t)));return 1/ot(e)**2},ct=(()=>{const t=2*Math.PI,e=new o(0,0,1),s=new h,i=new h,r=new o,n=new h;return function(a=1,o=1){var h=(Math.random()-.5)*t*a,c=Math.random()*t,l=Math.random()*Math.PI*o;return r.set(1,0,0).applyAxisAngle(e,c),s.setFromAxisAngle(e,h),i.setFromAxisAngle(r,l),n.multiplyQuaternions(i,s)}})();function lt(t,e){let s=0;for(let r=0;r<t.length;r++)s+=(null==e?void 0:e[r])||1;const i=Math.random()*s;s=0;for(let r=0;r<t.length;r++)if(s+=(null==e?void 0:e[r])||1,s>i)return t[r];return t[0]}const ut=(()=>{const t=new o;return function(e,s,i){const r=t.set(e.x,e.y,e.z),n=s.dot(r),a=t.copy(s).multiplyScalar(n),o=i.set(a.x,a.y,a.z,e.w).normalize();return n<0&&(o.x=-o.x,o.y=-o.y,o.z=-o.z,o.w=-o.w),o}})();class dt{constructor(){this.callbacks=[]}memoize(t,...e){e.push(this);const s=function(t){let e=pt;const s=()=>(s.needsUpdate&&(s.needsUpdate=!1,e=t()),e);return s.needsUpdate=!0,s}(t);for(const i of e)i.callbacks.push(s);return s}invalidateAll(){const t=this.callbacks;for(let e=0;e<this.callbacks.length;e++)t[e].needsUpdate=!0}isFullyInvalid(){const t=this.callbacks;for(let e=0;e<this.callbacks.length;e++)if(!t[e].needsUpdate)return!1;return!0}}const pt=Symbol("unset");class mt{constructor(){t.set(this,void 0),this._cache=new dt,this.isLayoutFrustum=!0,this._leftDegrees=-20,this._rightDegrees=20,this._bottomDegrees=-20,this._topDegrees=20,this._nearMeters=.5,this._farMeters=1e3,this._size=new a,this._center=new a,this._v1=new o,this._inverseProjection=new c,this._forwardDirection=new o(0,0,-1),this._fullNDC=new l(new o(-1,-1,-1),new o(1,1,1)),this._cachedPerspectiveProjectionMatrix=this._cache.memoize((()=>{const e=this.nearMeters,s=this.farMeters,i=e*Math.tan(this.leftDegrees*u.DEG2RAD),n=e*Math.tan(this.rightDegrees*u.DEG2RAD),a=e*Math.tan(this.topDegrees*u.DEG2RAD),o=e*Math.tan(this.bottomDegrees*u.DEG2RAD);return r(this,t).makePerspective(i,n,a,o,e,s)})),n(this,t,new c),this._boxA=new d,this._boxB=new d,this._overlapSize=new a}get leftDegrees(){return this._leftDegrees}set leftDegrees(t){t!==this._leftDegrees&&(this._leftDegrees=t,this._cache.invalidateAll())}get rightDegrees(){return this._rightDegrees}set rightDegrees(t){t!==this._rightDegrees&&(this._rightDegrees=t,this._cache.invalidateAll())}get bottomDegrees(){return this._bottomDegrees}set bottomDegrees(t){t!==this._bottomDegrees&&(this._bottomDegrees=t,this._cache.invalidateAll())}get topDegrees(){return this._topDegrees}set topDegrees(t){t!==this._topDegrees&&(this._topDegrees=t,this._cache.invalidateAll())}get nearMeters(){return this._nearMeters}set nearMeters(t){t!==this._nearMeters&&(this._nearMeters=t,this._cache.invalidateAll())}get farMeters(){return this._farMeters}set farMeters(t){t!==this._farMeters&&(this._farMeters=t,this._cache.invalidateAll())}get sizeDegrees(){return this._size.set(this.rightDegrees-this.leftDegrees,this.topDegrees-this.bottomDegrees),this._size}get diagonalDegrees(){const t=this.sizeDegrees;return Math.acos(Math.cos(t.x*u.DEG2RAD)*Math.cos(t.y*u.DEG2RAD))*u.RAD2DEG}get centerDegrees(){const t=this.sizeDegrees;return this._center.set(this.leftDegrees+t.x/2,this.bottomDegrees+t.y/2)}get angleToCenter(){const t=this.centerDegrees;return Math.acos(Math.cos(t.x*u.DEG2RAD)*Math.cos(t.y*u.DEG2RAD))*u.RAD2DEG}get angleToTopLeft(){return Math.acos(Math.cos(this.leftDegrees*u.DEG2RAD)*Math.cos(this.topDegrees*u.DEG2RAD))*u.RAD2DEG}get angleToTopRight(){return Math.acos(Math.cos(this.rightDegrees*u.DEG2RAD)*Math.cos(this.topDegrees*u.DEG2RAD))*u.RAD2DEG}get angleToBottomLeft(){return Math.acos(Math.cos(this.leftDegrees*u.DEG2RAD)*Math.cos(this.bottomDegrees*u.DEG2RAD))*u.RAD2DEG}get angleToBottomRight(){return Math.acos(Math.cos(this.rightDegrees*u.DEG2RAD)*Math.cos(this.bottomDegrees*u.DEG2RAD))*u.RAD2DEG}get angleToClosestPoint(){const t=Math.min(Math.max(0,this.leftDegrees),this.rightDegrees),e=Math.min(Math.max(0,this.bottomDegrees),this.topDegrees);return Math.acos(Math.cos(t*u.DEG2RAD)*Math.cos(e*u.DEG2RAD))*u.RAD2DEG}get angleToFarthestPoint(){return Math.max(this.angleToTopLeft,this.angleToTopRight,this.angleToBottomLeft,this.angleToBottomRight)}get depth(){return this.farMeters-this.nearMeters}get distance(){return this.nearMeters+this.depth/2}get aspectRatio(){const t=this.nearMeters,e=t*Math.tan(this.leftDegrees*u.DEG2RAD),s=t*Math.tan(this.rightDegrees*u.DEG2RAD);return(t*Math.tan(this.topDegrees*u.DEG2RAD)-t*Math.tan(this.bottomDegrees*u.DEG2RAD))/(s-e)}setFromPerspectiveProjectionMatrix(t,e=this._fullNDC){const s=this._inverseProjection.getInverse(t),i=this._v1,r=this._forwardDirection,n=Math.sign(e.min.x)*i.set(e.min.x,0,-1).applyMatrix4(s).angleTo(r)*u.RAD2DEG,a=Math.sign(e.max.x)*i.set(e.max.x,0,-1).applyMatrix4(s).angleTo(r)*u.RAD2DEG,o=Math.sign(e.max.y)*i.set(0,e.max.y,-1).applyMatrix4(s).angleTo(r)*u.RAD2DEG,h=Math.sign(e.min.y)*i.set(0,e.min.y,-1).applyMatrix4(s).angleTo(r)*u.RAD2DEG,c=-i.set(0,0,e.min.z).applyMatrix4(s).z,l=-i.set(0,0,e.max.z).applyMatrix4(s).z;return this.leftDegrees=n,this.rightDegrees=a,this.topDegrees=o,this.bottomDegrees=h,this.nearMeters=c,this.farMeters=l,this}get perspectiveProjectionMatrix(){return this._cachedPerspectiveProjectionMatrix()}overlapPercent(t){this._boxA.min.x=this.leftDegrees,this._boxA.max.x=this.rightDegrees,this._boxA.min.y=this.bottomDegrees,this._boxA.max.y=this.topDegrees,this._boxB.min.x=t.leftDegrees,this._boxB.max.x=t.rightDegrees,this._boxB.min.y=t.bottomDegrees,this._boxB.max.y=t.topDegrees;return this._boxA.intersect(this._boxB).getSize(this._overlapSize).length()/this.sizeDegrees.length()}}var gt,yt;t=new WeakMap;const _t=Symbol("current"),ft=Symbol("target");class vt{constructor(t,e){this.mode=t,this.metrics=e,this._cache=new dt,this._parent=null,this._cachedLocalMatrix=this._cache.memoize((()=>(this._localMatrix.decompose(this._localPosition,this._localOrientation,this._localScale),this._localOrientationInverse.copy(this._localOrientation).inverse(),this._localRotation.makeRotationFromQuaternion(this._localOrientation),this._localRotationInverse.makeRotationFromQuaternion(this._localOrientationInverse),this._localMatrix))),this._localMatrix=new c,this._localMatrixInverse=new c,this._localPosition=new o,this._localOrientation=new h,this._localOrientationInverse=new h,this._localScale=new o(1,1,1),this._localRotation=new c,this._localRotationInverse=new c,this._cachedWorldMatrix=this._cache.memoize((()=>{const t=this._worldMatrix.copy(this.localMatrix),e=this.parentState;return e&&t.premultiply(e.worldMatrix),t.decompose(this._worldPosition,this._worldOrientation,this._worldScale),this._worldMatrixInverse.getInverse(this._worldMatrix),this._worldOrientationInverse.copy(this._worldOrientation).inverse(),this._worldRotation.makeRotationFromQuaternion(this._worldOrientation),this._worldRotationInverse.makeRotationFromQuaternion(this._worldOrientationInverse),t})),this._worldPosition=new o,this._worldOrientation=new h,this._worldOrientationInverse=new h,this._worldScale=new o,this._worldMatrix=new c,this._worldMatrixInverse=new c,this._worldRotation=new c,this._worldRotationInverse=new c,this._cachedWorldCenter=this._cache.memoize((()=>this._worldCenter.copy(this.metrics.innerCenter).applyMatrix4(this.worldMatrix))),this._worldCenter=new o,this._cachedSpatialMatrix=this._cache.memoize((()=>{const t=this._spatialMatrix.compose(this.worldOrigin,this.worldOrientation,et);return this._spatialMatrixInverse.getInverse(this._spatialMatrix),this._localFromSpatial.multiplyMatrices(this.worldMatrixInverse,t),this._spatialFromLocal.getInverse(this._localFromSpatial),t})),this._spatialMatrix=new c,this._spatialMatrixInverse=new c,this._localFromSpatial=new c,this._spatialFromLocal=new c,this._cachedSpatialBounds=this._cache.memoize((()=>{this.metrics.innerBounds.isEmpty()?this._spatialBounds.setFromCenterAndSize(Z,et):this._spatialBounds.copy(this.metrics.innerBounds);const t=this._spatialBounds.applyMatrix4(this.spatialFromLocal);return t.getCenter(this._spatialCenter),t.getSize(this._spatialSize),t})),this._spatialBounds=new l,this._spatialSize=new o,this._spatialCenter=new o,this._cachedOuterBounds=this._cache.memoize((()=>{const t=this._outerBounds,e=this.outerState;if(!e||e.metrics.innerBounds.isEmpty())t.makeEmpty();else{t.copy(e.metrics.innerBounds);const s=this._spatialFromOuter.multiplyMatrices(this.spatialMatrixInverse,e.worldMatrix);t.applyMatrix4(s)}return t.getCenter(this._outerCenter),t.getSize(this._outerSize),t})),this._outerBounds=new l,this._outerCenter=new o,this._outerSize=new o,this._spatialFromOuter=new c,this._viewFromLocal=new c,this._viewFromSpatial=new c,this._spatialFromView=new c,this._cachedNDCBounds=this._cache.memoize((()=>{if(this.metrics.system.viewNode===this.metrics.node)return this._ndcBounds.min.setScalar(-1),this._ndcBounds.max.setScalar(1),this._ndcBounds;const t=this.metrics.system.viewFrustum.perspectiveProjectionMatrix,e=this.viewFromLocal,s=this._viewProjectionFromLocal.multiplyMatrices(t,e),i=this._ndcBounds.copy(this.metrics.innerBounds).applyMatrix4(s);return i.getCenter(this._ndcCenter),i.getSize(this._ndcSize),i}),this._viewState._cache),this._viewProjectionFromLocal=new c,this._ndcBounds=new l,this._ndcCenter=new o,this._ndcSize=new o,this._cachedVisualBounds=this._cache.memoize((()=>{const t=this.metrics.system,e=t.viewFrustum.perspectiveProjectionMatrix,s=this._inverseProjection.getInverse(e),i=this._visualBounds.copy(this.ndcBounds),r=this._v1,n=r.set(0,0,i.min.z).applyMatrix4(s).z,a=r.set(0,0,i.max.z).applyMatrix4(s).z;return i.min.z=a,i.max.z=n,i.min.x*=.5*t.viewResolution.x,i.max.x*=.5*t.viewResolution.x,i.min.y*=.5*t.viewResolution.y,i.max.y*=.5*t.viewResolution.y,i.getCenter(this._visualCenter),i.getSize(this._visualSize),i}),this._viewState._cache),this._visualBounds=new l,this._visualCenter=new o,this._visualSize=new o,this._v1=new o,this._inverseProjection=new c,this._viewPosition=new o,this._cachedViewAlignedOrientation=this._cache.memoize((()=>{const t=this._relativeViewMatrix.multiplyMatrices(this.worldMatrixInverse,this._viewState.worldMatrix),e=this._relativeViewRotation.extractRotation(t),s=this._relativeViewOrientation.setFromRotationMatrix(e),i=this._relativeViewForward.set(0,0,1).applyQuaternion(s),r=this._relativeViewUp.set(0,1,0).applyQuaternion(s);let n,a,o,h=1/0,c=1/0;for(o in it){const t=it[o];var l=r.distanceToSquared(t);l<c&&(c=l,a=t)}for(o in it){const t=it[o];if(t.x&&a.x)continue;if(t.y&&a.y)continue;if(t.z&&a.z)continue;const e=i.distanceToSquared(t);e<h&&(h=e,n=t)}const u=this._orthogonalRotation.identity();return u.lookAt(n,Z,a),this._orthogonalOrientation.setFromRotationMatrix(u)}),this._viewState._cache),this._relativeViewMatrix=new c,this._relativeViewRotation=new c,this._relativeViewOrientation=new h,this._relativeViewUp=new o,this._relativeViewForward=new o,this._orthogonalRotation=new c,this._orthogonalOrientation=new h,this._computeOcclusion=this._cache.memoize((()=>{this._occludingPercent=0,this._occludedPercent=0;const t=this.metrics;if(t.innerBounds.isEmpty())return;const e=t.system.nodeAdapters.values(),s=this.visualBounds,i=s.min.z,r=vt._boxA,n=vt._boxB;r.min.set(s.min.x,s.min.y),r.min.set(s.max.x,s.max.y);const a=r.getSize(vt._sizeA).length();for(const o of e){const e=o.metrics;if(e===t)continue;if(!e.isAdaptive||e.innerBounds.isEmpty())continue;if(e.containedByNode(o.node))continue;const h=("current"===this.mode?e.currentState:e.targetState).visualBounds;r.min.set(s.min.x,s.min.y),r.min.set(s.max.x,s.max.y),n.min.set(h.min.x,h.min.y),n.min.set(h.max.x,h.max.y);const c=r.intersect(n).getSize(vt._sizeB).length()/a;c>0&&(i<h.min.z?this._occludingPercent+=c:this._occludedPercent+=c)}}),this._viewState._cache),this._occludingPercent=0,this._occludedPercent=0}invalidate(){this._cache.invalidateAll()}get parent(){return this._parent}set parent(t){this._parent!==t&&(this._parent=t,this.invalidate())}get parentState(){const t=this.parent&&this.metrics.system.getMetrics(this.parent);return"current"===this.mode?null==t?void 0:t.currentState:null==t?void 0:t.targetState}get outerState(){const t=this.metrics.outerMetrics;return"current"===this.mode?null==t?void 0:t.currentState:null==t?void 0:t.targetState}get localMatrix(){return this._localMatrix}set localMatrix(t){this._localMatrix.equals(t)||(this.invalidate(),this._localMatrix.copy(t),this._localMatrixInverse.getInverse(this._localMatrix))}get localMatrixInverse(){return this._localMatrixInverse}get localPosition(){return this._cachedLocalMatrix(),this._localPosition}get localOrientation(){return this._cachedLocalMatrix(),this._localOrientation}get localOrientationInverse(){return this._cachedLocalMatrix(),this._localOrientationInverse}get localScale(){return this._cachedLocalMatrix(),this._localScale}get localRotation(){return this._cachedLocalMatrix(),this._localRotation}get localRotationInverse(){return this._cachedLocalMatrix(),this._localRotationInverse}get worldMatrix(){return this._cachedWorldMatrix()}get worldMatrixInverse(){return this.worldMatrix,this._worldMatrixInverse}get worldPosition(){return this.worldMatrix,this._worldPosition}get worldOrientation(){return this.worldMatrix,this._worldOrientation}get worldScale(){return this.worldMatrix,this._worldScale}get worldOrientationInverse(){return this._worldOrientationInverse}get worldRotation(){return this._worldRotation}get worldRotationInverse(){return this._worldRotationInverse}get worldCenter(){return this._cachedWorldCenter()}get worldOrigin(){var t,e;return null!=(e=null==(t=this.outerState)?void 0:t.worldCenter)?e:Z}get spatialMatrix(){return this._cachedSpatialMatrix()}get spatialMatrixInverse(){return this.spatialMatrix,this._spatialMatrixInverse}get localFromSpatial(){return this.spatialMatrix,this._localFromSpatial}get spatialFromLocal(){return this.spatialMatrix,this._spatialFromLocal}get spatialBounds(){return this._cachedSpatialBounds()}get spatialSize(){return this.spatialBounds,this._spatialSize}get spatialCenter(){return this.spatialBounds,this._spatialCenter}get outerBounds(){return this._cachedOuterBounds()}get outerCenter(){return this.outerBounds,this._outerCenter}get outerSize(){return this.outerBounds,this._outerSize}get _viewState(){if(this.metrics.system.viewNode===this.metrics.node)return this;const t=this.metrics.system.viewMetrics;return"current"===this.mode?t[_t]:t[ft]}get viewFromLocal(){return this._viewFromLocal.multiplyMatrices(this._viewState.worldMatrixInverse,this.worldMatrix)}get viewFromSpatial(){return this._viewFromSpatial.multiplyMatrices(this._viewState.worldMatrixInverse,this.spatialMatrix)}get spatialFromView(){return this._spatialFromView.getInverse(this.viewFromSpatial)}get ndcBounds(){return this._cachedNDCBounds()}get ndcCenter(){return this._cachedNDCBounds(),this._ndcCenter}get ndcSize(){return this._cachedNDCBounds(),this._ndcSize}get visualBounds(){return this._cachedVisualBounds()}get visualCenter(){return this._cachedVisualBounds(),this._visualCenter}get visualSize(){return this._cachedVisualBounds(),this._visualSize}get relativeViewPosition(){return this._viewPosition.copy(this._viewState.worldPosition).applyMatrix4(this.worldMatrixInverse)}get viewAlignedOrientation(){return this._cachedViewAlignedOrientation()}get occludingPercent(){return this._computeOcclusion(),this._occludingPercent}get occludedPercent(){return this._computeOcclusion(),this._occludedPercent}}vt._boxA=new d,vt._boxB=new d,vt._sizeA=new a,vt._sizeB=new a;class bt{constructor(t,e){this.system=t,this.node=e,this._cache=new dt,this.needsUpdate=!0,this._cachedInnerBounds=this._cache.memoize((()=>{const t=this._innerBounds;if(this.node!==this.system.viewNode&&this.parentNode){t.copy(this.intrinsicBounds);const e=this._childBounds;for(const s of this.boundsChildren){const i=this.system.getMetrics(s);e.copy(i.innerBounds),e.applyMatrix4(i.nodeState.localMatrix),t.union(e)}}const e=t.getCenter(this._innerCenter),s=t.getSize(this._innerSize);if(s.length()>0){const i=this.system.config.epsillonMeters;Math.abs(s.x)<=i&&(s.x=(Math.sign(s.x)||1)*i*1e3),Math.abs(s.y)<=i&&(s.y=(Math.sign(s.y)||1)*i*1e3),Math.abs(s.z)<=i&&(s.z=(Math.sign(s.z)||1)*i*1e3),t.setFromCenterAndSize(e,s)}return t})),this._childBounds=new l,this._innerBounds=new l,this._innerCenter=new o,this._innerSize=new o,this._intrinsicBoundsNeedsUpdate=!0,this._intrinsicBounds=new l,this._intrinsicCenter=new o,this._intrinsicSize=new o,this._cachedNodeChildren=this._cache.memoize((()=>(this.system.bindings.getChildren(this,this._nodeChildren),this._nodeChildren))),this._nodeChildren=new Array,this._cachedNodeState=this._cache.memoize((()=>(this.system.bindings.getState(this,this._nodeState),this._nodeState))),this._computeState=(()=>{const t=new c,e=new h,s=new o,i=new o,r=new c,n=new o,a=new h,l=new o,u=new o,d=new o,p=new o,m=new o;return function(o){var h;const c="current"===o.mode,g=this.system.nodeAdapters.get(this.node);e.copy((c?(null==g?void 0:g.orientation.enabled)&&(null==g?void 0:g.orientation.current):(null==g?void 0:g.orientation.enabled)&&(null==g?void 0:g.orientation.target))||this.nodeState.localOrientation);const y=c?(null==g?void 0:g.bounds.enabled)&&(null==g?void 0:g.bounds.current):(null==g?void 0:g.bounds.enabled)&&(null==g?void 0:g.bounds.target),_=this.parentMetrics;if(o.parent=null!=(h=null==_?void 0:_.node)?h:null,y){y.getCenter(u),y.getSize(d);const s=c?null==_?void 0:_.currentState:null==_?void 0:_.targetState,i=this.innerCenter,h=this.innerSize,g=this.system.config.epsillonMeters;Math.abs(d.x)<=g&&(d.x=(Math.sign(d.x)||1)*g*10),Math.abs(d.y)<=g&&(d.y=(Math.sign(d.y)||1)*g*10),Math.abs(d.z)<=g&&(d.z=(Math.sign(d.z)||1)*g*10),l.copy(d),Math.abs(h.x)>=g&&(l.x/=h.x),Math.abs(h.y)>=g&&(l.y/=h.y),Math.abs(h.z)>=g&&(l.z/=h.z),s?a.multiplyQuaternions(s.worldOrientation,e):a.copy(e),p.copy(u).applyQuaternion(a),m.copy(i).multiply(l).applyQuaternion(a),n.copy(o.worldOrigin).add(p).sub(m),r.compose(n,a,l),s?t.multiplyMatrices(s.worldMatrixInverse,r):t.copy(r)}else s.copy(this.nodeState.localPosition),i.copy(this.nodeState.localScale),t.compose(s,e,i);return o.localMatrix=t,o}})(),this._cachedCurrentState=this._cache.memoize((()=>this._computeState(this[_t]))),this[gt]=new vt("current",this),this._cachedTargetState=this._cache.memoize((()=>this._computeState(this[ft]))),this[yt]=new vt("target",this),this._cachedBoundsChildren=this._cache.memoize((()=>{const t=this.nodeChildren,e=this._children;e.length=0;for(const s of t){this.system.getMetrics(s).isAdaptive||e.push(s)}return e})),this._children=[]}update(){if(this.needsUpdate){this.needsUpdate=!1;const t=this.nodeState.parent,e=t&&this.system.getMetrics(t);null==e||e.update();const s=this.system.nodeAdapters.get(this.node);s?s._update():(this.invalidateInnerBounds(),this.invalidateNodeStates())}}get innerBounds(){return this._cachedInnerBounds()}get innerCenter(){return this.innerBounds,this._innerCenter}get innerSize(){return this.innerBounds,this._innerSize}get intrinsicBounds(){return this._intrinsicBoundsNeedsUpdate&&(this._intrinsicBoundsNeedsUpdate=!1,this.system.bindings.getIntrinsicBounds(this,this._intrinsicBounds),this._intrinsicBounds.getCenter(this._intrinsicCenter),this._intrinsicBounds.getSize(this._intrinsicSize)),this._intrinsicBounds}get intrinsicCenter(){return this.intrinsicBounds,this._intrinsicCenter}get intrinsicSize(){return this.intrinsicBounds,this._intrinsicSize}invalidateIntrinsicBounds(){this._intrinsicBoundsNeedsUpdate=!0;for(const t of this.boundsChildren){this.system.getMetrics(t).invalidateIntrinsicBounds()}}invalidateInnerBounds(){if(!this._cachedInnerBounds.needsUpdate){this._cachedNodeChildren.needsUpdate=!0,this._cachedBoundsChildren.needsUpdate=!0,this._cachedInnerBounds.needsUpdate=!0;for(const t of this.boundsChildren){this.system.getMetrics(t).invalidateInnerBounds()}}}containsNode(t){this.update();let e=this.system.getMetrics(t);for(;e;){if(e.parentMetrics===this)return e.node;e=e.parentMetrics}return!1}containedByNode(t){this.update();let e=this.parentMetrics;for(;e;){if(e.node===t)return e.node;e=e.parentMetrics}return!1}get nodeChildren(){return this._cachedNodeChildren()}get nodeState(){return this._nodeState||(this._nodeState=new vt("target",this)),this._cachedNodeState()}invalidateNodeStates(){this._cachedNodeState.needsUpdate=!0,this._nodeState.invalidate(),this._cachedCurrentState.needsUpdate=!0,this._cachedTargetState.needsUpdate=!0,this[_t].invalidate(),this[ft].invalidate()}get currentState(){return this.update(),this._cachedCurrentState()}get targetState(){return this.update(),this._cachedTargetState()}get parentNode(){this.update();const t=this.system.nodeAdapters.get(this.node);return void 0===(null==t?void 0:t.parentNode)?this.nodeState.parent:t.parentNode}get parentMetrics(){const t=this.parentNode;return t?this.system.getMetrics(t):null}get outerMetrics(){let t=this.parentMetrics;for(;t&&t.innerBounds.isEmpty();)t=t.parentMetrics;return t||this.system.viewMetrics}get boundsChildren(){return this._cachedBoundsChildren()}get isAdaptive(){return this.system.nodeAdapters.has(this.node)}}gt=_t,yt=ft;class wt{constructor(t){this.layout=t,this.relativeTolerance=void 0,this.absoluteTolerance=void 0,this.bestScore=-1e3,this.sortBlame=0,this.reduceFromOneOrManySpec=(t,e,s,i,r)=>{if(void 0===e)return 0;if(e instanceof Array){let n=-1/0;for(const a of e)n=Math.max(r(t,a,s,i),n);return n}return r(t,e,s,i)},this._getNumberScoreSingle=(t,e,s,i)=>{const r="relative"===s;let n=0,a=1;if("object"!=typeof e){const s=this.layout.adapter.measureNumber(e);n=Math.abs(t-s),r&&(a=Math.max(Math.abs(s),Math.abs(t)))}else{const s="gt"in e?this.layout.adapter.measureNumber(e.gt):void 0,i="lt"in e?this.layout.adapter.measureNumber(e.lt):void 0;void 0!==s&&t<s?(n=t-s,r&&(a=Math.max(Math.abs(s),Math.abs(t)))):void 0!==i&&t>i&&(n=i-t,r&&(a=Math.max(Math.abs(i),Math.abs(t))))}return r?0===a?i:-n/a+i:-n+i},this._getVector3ScoreSingle=(t,e,s,i)=>("x"in e&&void 0!==e.x?this.getNumberScore(t.x,e.x,s,i):0)+("y"in e&&void 0!==e.y?this.getNumberScore(t.y,e.y,s,i):0)+("z"in e&&void 0!==e.z?this.getNumberScore(t.z,e.z,s,i):0)+("magnitude"in e&&void 0!==e.magnitude?this.getNumberScore(t.length(),e.magnitude,s,i):0),this._quat=new h,this._euler=new p,this._getQuaternionScoreSingle=(t,e,s,i)=>{var r,n;if(void 0===e)return 0;if("x"in e){return-this._quat.copy(e).angleTo(t)*u.RAD2DEG+i}if("swingRange"in e){const s=this._euler.setFromQuaternion(t),a=s.x*u.RAD2DEG,o=s.y*u.RAD2DEG,h=s.z*u.RAD2DEG,c=this.layout.adapter.system.mathScope.degree,l=(null==(r=e.swingRange)?void 0:r.x)?this.layout.adapter.measureNumber(e.swingRange.x,c):0,d=(null==(n=e.swingRange)?void 0:n.y)?this.layout.adapter.measureNumber(e.swingRange.y,c):0,p=e.twistRange?this.layout.adapter.measureNumber(e.twistRange,c):0;return(1-(a/l)**2-(o/d)**2)*(Math.acos(Math.cos(l*u.DEG2RAD)*Math.cos(d*u.DEG2RAD))*u.RAD2DEG)+(p-Math.abs(h))+i}return 0},this._getMeasurePenaltySingle=(t,e,s,i,r)=>{if(void 0===e)return 0;if("object"==typeof e){if("gt"in e){const n=this.layout.adapter.measureBounds(e.gt,s,i);if(t<n)return t-n+r}if("lt"in e){const n=this.layout.adapter.measureBounds(e.lt,s,i);if(t>n)return n-t+r}return r}return-Math.abs(t-this.layout.adapter.measureBounds(e,s,i))+r}}static isDiscreteSpec(t){const e=typeof t;return"string"===e||"number"===e}static isContinuousSpec(t){return void 0!==t&&t instanceof Array==!1&&"object"==typeof t&&!0==("gt"in t||"lt"in t)}getNumberScore(t,e,s,i){return this.reduceFromOneOrManySpec(t,e,s,i,this._getNumberScoreSingle)}getVector3Score(t,e,s,i){return this.reduceFromOneOrManySpec(t,e,s,i,this._getVector3ScoreSingle)}getQuaternionScore(t,e,s){return this.reduceFromOneOrManySpec(t,e,"absolute",s,this._getQuaternionScoreSingle)}getBoundsScore(t,e){if(void 0===t)return 0;let s=1/0;for(const i in t){let r=i;if("size"===r||"center"===r){const i=t[r];for(const t in i){let n=t;s=Math.min(this.getBoundsMeasureScore(null==i?void 0:i[n],e,r+n),s)}}else s=Math.min(this.getBoundsMeasureScore(t[r],e,r),s)}return s}getBoundsMeasureScore(t,e,s){if(void 0===t)return 0;const i=this.layout.adapter.metrics.targetState,r=this.layout.adapter.system;let n,a,o;switch(e){case"spatial":n=i.spatialBounds,a=i.spatialCenter,o=i.spatialSize;break;case"visual":n=i.visualBounds,a=i.visualCenter,o=i.visualSize;break;case"view":const h=r.viewMetrics.targetState;n=h.visualBounds,a=h.visualCenter,o=h.visualSize;break;default:throw new Error(`Unknown measure type "${e}.${s}" in spec:\n "${t}"`)}let h=0;switch(s){case"left":h=n.min.x;break;case"right":h=n.max.x;break;case"bottom":h=n.min.y;break;case"top":h=n.max.y;break;case"back":h=n.min.z;break;case"front":h=n.max.z;break;case"centerx":h=a.x;break;case"centery":h=a.y;break;case"centerz":h=a.z;break;case"sizex":h=o.x;break;case"sizey":h=o.y;break;case"sizez":h=o.z;break;case"sizediagonal":h="spatial"===e?o.length():Math.sqrt(o.x**2+o.y**2);break;default:throw new Error(`Unknown measure subtype ${e}.${s} in spec "${t}"`)}const c="spatial"===e||"front"===s||"back"===s||"centerz"===s||"sizez"===s?r.mathScope.meter:r.mathScope.pixel,l=c===r.mathScope.meter?this.layout.spatialAccuracy:this.layout.visualAccuracy,u=this.layout.adapter.measureNumber(l,c);if(t instanceof Array){let i=-1/0;for(const r of t)i=Math.max(this._getMeasurePenaltySingle(h,r,e,s,u),i);return i}return this._getMeasurePenaltySingle(h,t,e,s,u)}attenuateVisualScore(t){let e=0;const s=this.layout.adapter.measureNumber(this.layout.visualAccuracy,this.layout.adapter.system.mathScope.pixel),i=this.layout.adapter,r=i.system.viewResolution,n=i.system.viewFrustum,a=r.x,o=r.y,h=i.metrics.targetState.visualBounds,c=h.min.x- -a/2+s,l=h.max.x-a/2-s,u=h.min.y- -o/2+s,d=h.max.y-o/2-s,p=h.max.z+n.nearMeters;return c<0&&(e+=10*Math.abs(c/a)),l>0&&(e+=10*Math.abs(l/a)),u<0&&(e+=10*Math.abs(u/o)),d>0&&(e+=10*Math.abs(d/o)),p>0&&(e+=p),t-Math.abs(t)*e**2}}class xt extends wt{evaluate(){const t=this.layout.adapter.system.mathScope,e=this.layout.adapter.metrics.targetState,s=this.layout.adapter.measureNumber(this.layout.relativeAccuracy,t.meter);return this.getVector3Score(e.localPosition,this.spec,"relative",s)}}class St extends wt{evaluate(){const t=this.layout.adapter.system.mathScope,e=this.layout.adapter.metrics.targetState,s=this.layout.adapter.measureNumber(this.layout.angularAccuracy,t.degree);return this.getQuaternionScore(e.localOrientation,this.spec,s)}}class Mt extends wt{evaluate(){const t=this.layout.adapter.metrics.targetState,e=this.layout.adapter.measureNumber(this.layout.relativeAccuracy);return this.getVector3Score(t.localScale,this.spec,"absolute",e)}}class Rt extends wt{constructor(){super(...arguments),this.mode="spatial",this._scale=new o}evaluate(){const t=this.layout.adapter.metrics.targetState,e=this.layout.adapter.measureNumber(this.layout.relativeAccuracy),s=this.mode;if(!s)return 0;const i=this._scale.copy(t.worldScale),r="spatial"===s?Math.max(Math.abs(i.x),Math.abs(i.y),Math.abs(i.z)):Math.max(Math.abs(i.x),Math.abs(i.y)),n=i.divideScalar(r);return this.getNumberScore(n.x,1,"absolute",e)+this.getNumberScore(n.y,1,"absolute",e)+("spatial"===s?this.getNumberScore(n.z,1,"absolute",e):n.z>1?1-n.z:0)}}class Tt extends wt{evaluate(){return this.getBoundsScore(this.spec,"spatial")}}class Et extends wt{evaluate(){var t;return this.attenuateVisualScore(this.getBoundsScore(this.spec,"visual")+this.getBoundsScore(null==(t=this.spec)?void 0:t.absolute,"view"))}}class zt extends wt{evaluate(){const t=this.layout.adapter.metrics.targetState.visualSize,e=this.layout.adapter.system.viewResolution;let s=Math.min(t.x*t.y,e.x*e.y);return this.attenuateVisualScore(s)}}class At{constructor(t){this.adapter=t,this.spatialAccuracy="10mm",this.visualAccuracy="1px",this.angularAccuracy="0.1deg",this.relativeAccuracy=.02,this.successRate=0,this.restartRate=0,this.objectives=new Array,this.solutions=new Array,this.iteration=0,this.compareSolutions=(t,e)=>{var s,i;const r=t.bounds.min,n=t.bounds.max;if(isNaN(r.x)||isNaN(r.y)||isNaN(r.z)||isNaN(n.x)||isNaN(n.y)||isNaN(n.z))return 1;const a=this.objectives;if(t.scores.length<a.length)return 1;const o=this.adapter.system.config.optimize,h=null!=(s=this.adapter.optimize.relativeTolerance)?s:o.relativeTolerance;let c=0;for(let l=0;l<a.length;l++){const s=t.scores[l],r=e.scores[l],n=a[l];if(s<0||r<0)return n.sortBlame++,r-s;const o=null!=(i=n.relativeTolerance)?i:h,u=n.bestScore,d=u-Math.abs(u)*o;if(s<d||r<d)return n.sortBlame++,r-s;r-s!=0&&(c=r-s)}return c}}attachedTo(t){return this.parentNode=t,this}localPosition(t,e){var s;const i=this.localPositionConstraint=null!=(s=this.localPositionConstraint)?s:new xt(this);return Object.assign(i,{spec:t},e),-1===this.objectives.indexOf(i)&&this.objectives.push(i),this}localOrientation(t,e){var s;const i=this.localOrientationConstraint=null!=(s=this.localOrientationConstraint)?s:new St(this);return Object.assign(i,{spec:t},e),-1===this.objectives.indexOf(i)&&this.objectives.push(i),this}localScale(t,e){var s;const i=this.localScaleConstraint=null!=(s=this.localScaleConstraint)?s:new Mt(this);return Object.assign(i,{spec:t},e),-1===this.objectives.indexOf(i)&&this.objectives.push(i),this}preserveAspect(t,e){var s;const i=this.preserveAspectConstraint=null!=(s=this.preserveAspectConstraint)?s:new Rt(this);return Object.assign(i,{mode:t},e),-1===this.objectives.indexOf(i)&&this.objectives.push(i),this}spatialOrientation(t,e){return this.localOrientation(t,e)}spatialBounds(t,e){var s;const i=this.spatialBoundsConstraint=null!=(s=this.spatialBoundsConstraint)?s:new Tt(this);return Object.assign(i,{spec:t},e),-1===this.objectives.indexOf(i)&&this.objectives.push(i),this}visualOrientation(t,e){}visualBounds(t,e){var s;const i=this.visualBoundsConstraint=null!=(s=this.visualBoundsConstraint)?s:new Et(this);return Object.assign(i,{spec:t},e),-1===this.objectives.indexOf(i)&&this.objectives.push(i),this}visualMaximize(t){var e;const s=this.visualMaximizeObjective=null!=(e=this.visualMaximizeObjective)?e:new zt(this);return Object.assign(s,{relativeTolerance:.9},t),-1===this.objectives.indexOf(s)&&this.objectives.push(s),this}visualForce(t){return this}get hasValidSolution(){var t;return!0===(null==(t=this.solutions[0])?void 0:t.isValid)}sortSolutions(){var t;let e=0;for(let s=0;s<this.objectives.length;s++){e=this.objectives[s].bestScore;for(let i=0;i<this.solutions.length;i++){const r=null!=(t=this.solutions[i].bestScores[s])?t:this.solutions[i].scores[s];r>e&&(e=r)}this.objectives[s].bestScore=1e-4*e+.9999*this.objectives[s].bestScore}this.solutions.sort(this.compareSolutions),this.bestSolution=this.solutions[0]}}At.compiledExpressions=new Map;class Ct{constructor(t){this.layout=void 0,this.orientation=new h,this.bounds=new l,this.scores=[],this.bestScores=[],this.mutationStrategies=[{type:"rotate",stepSize:.1,successRate:.2},{type:"centerx",stepSize:.1,successRate:.2},{type:"centery",stepSize:.1,successRate:.2},{type:"centerz",stepSize:.1,successRate:.2},{type:"sizeXYZ",stepSize:.1,successRate:.2},{type:"sizeX",stepSize:.1,successRate:.2},{type:"sizeY",stepSize:.1,successRate:.2},{type:"sizeZ",stepSize:.1,successRate:.2},{type:"minX",stepSize:.1,successRate:.2},{type:"minY",stepSize:.1,successRate:.2},{type:"minZ",stepSize:.1,successRate:.2},{type:"maxX",stepSize:.1,successRate:.2},{type:"maxY",stepSize:.1,successRate:.2},{type:"maxZ",stepSize:.1,successRate:.2},{type:"minXAspect",stepSize:.1,successRate:.2},{type:"minYAspect",stepSize:.1,successRate:.2},{type:"minZAspect",stepSize:.1,successRate:.2},{type:"maxXAspect",stepSize:.1,successRate:.2},{type:"maxYAspect",stepSize:.1,successRate:.2},{type:"maxZAspect",stepSize:.1,successRate:.2},{type:"corner000",stepSize:.1,successRate:.2},{type:"corner001",stepSize:.1,successRate:.2},{type:"corner010",stepSize:.1,successRate:.2},{type:"corner011",stepSize:.1,successRate:.2},{type:"corner100",stepSize:.1,successRate:.2},{type:"corner101",stepSize:.1,successRate:.2},{type:"corner110",stepSize:.1,successRate:.2},{type:"corner111",stepSize:.1,successRate:.2}],this._mutationWeights=[],t&&(this.layout=t)}get aspectPenalty(){return this.scores[this.layout.objectives.indexOf(this.layout.preserveAspectConstraint)]||0}get orientationPenalty(){return this.scores[this.layout.objectives.indexOf(this.layout.localOrientationConstraint)]||0}get spatialBoundsPenalty(){return this.scores[this.layout.objectives.indexOf(this.layout.spatialBoundsConstraint)]||0}get isValid(){for(let t=0;t<this.scores.length;t++){if(this.scores[t]<0)return!1}return!0}_selectStrategy(){const t=this.mutationStrategies,e=this._mutationWeights;for(let s=0;s<t.length;s++)e[s]=t[s].stepSize*t[s].successRate;return lt(t,e)}copy(t){this.layout=t.layout,this.orientation.copy(t.orientation),this.bounds.copy(t.bounds),this.scores.length=0,this.bestScores.length=0;for(let e=0;e<t.scores.length;e++)this.scores[e]=t.scores[e],this.bestScores[e]=t.bestScores[e];return this}randomize(t){const e=ht(t),s=Ct._scratchV1.set(0,0,-e),i=this.layout.adapter.system.viewMetrics.targetState;s.applyMatrix4(i.worldMatrix);const r=this.layout.adapter.metrics.targetState.parentState;r&&s.applyMatrix4(r.worldMatrixInverse),this.orientation.copy(i.worldOrientation),r&&this.orientation.multiply(r.worldOrientationInverse);const n=this.layout.adapter.metrics.innerBounds,a=n.isEmpty()?Ct._scratchV2.set(1,1,1):n.getSize(Ct._scratchV2);return a.normalize(),a.multiplyScalar(2*e*Math.tan(5*u.DEG2RAD)),this.bounds.setFromCenterAndSize(s,a),this}moveTowards(t,e,s){const i=this.bounds.getCenter(Ct._center),r=this.bounds.getSize(Ct._size),n=t.bounds,a=n.getCenter(Ct._otherCenter),o=n.getSize(Ct._otherSize);this.orientation.slerp(t.orientation,Ct.generatePulseFrequency(e,s)).normalize(),Math.random()<.5?(i.lerp(a,Ct.generatePulseFrequency(e,s)),r.lerp(o,Ct.generatePulseFrequency(e,s)),this.bounds.setFromCenterAndSize(i,r)):(this.bounds.min.lerp(n.min,Ct.generatePulseFrequency(e,s)),this.bounds.max.lerp(n.max,Ct.generatePulseFrequency(e,s)))}perturb(){var t,e,s,i,r,n,a,o,h,c,l,u,d,p,m,g,y,_,f,v;let b=this._selectStrategy();const w=b.type;let x=b.stepSize;if("rotate"===w){const e=null==(t=this.layout.localOrientationConstraint)?void 0:t.spec;if((null==e?void 0:e.isQuaternion)&&Math.random()<.01)return this.orientation.copy(e),b;x=b.stepSize=Math.min(x,1);const s=Math.min(ht(1e-4*x),1);return this.orientation.multiply(ct(s,s)).normalize(),b}const S=this.bounds,M=S.getCenter(Ct._center),R=S.getSize(Ct._size);if("centerz"===w){const t=null==(e=this.layout.spatialBoundsConstraint)?void 0:e.spec;M.x=this._perturbFromSpatialBoundsSpec(M.x,x*R.x,null==(s=null==t?void 0:t.center)?void 0:s.x,"centerx")}else if("centery"===w){const t=null==(i=this.layout.spatialBoundsConstraint)?void 0:i.spec;M.y=this._perturbFromSpatialBoundsSpec(M.y,x*R.y,null==(r=null==t?void 0:t.center)?void 0:r.y,"centery")}else if("centerz"===w){const t=null==(n=this.layout.spatialBoundsConstraint)?void 0:n.spec;M.z=this._perturbFromSpatialBoundsSpec(M.z,x*R.z,null==(a=null==t?void 0:t.center)?void 0:a.z,"centerz")}else if("sizeXYZ"===w){const t=4**ot(x);"visual"===(null==(o=this.layout.preserveAspectConstraint)?void 0:o.mode)?(R.x*=t,R.y*=t):R.multiplyScalar(t)}else if("sizeX"===w){const t=null==(h=this.layout.spatialBoundsConstraint)?void 0:h.spec;R.x=this._perturbFromSpatialBoundsSpec(R.x,x,null==(c=null==t?void 0:t.size)?void 0:c.x,"sizex")}else if("sizeY"===w){const t=null==(l=this.layout.spatialBoundsConstraint)?void 0:l.spec;R.y=this._perturbFromSpatialBoundsSpec(R.y,x,null==(u=null==t?void 0:t.size)?void 0:u.y,"sizey")}else if("sizeZ"===w){const t=null==(d=this.layout.spatialBoundsConstraint)?void 0:d.spec;R.z=this._perturbFromSpatialBoundsSpec(R.z,x,null==(p=null==t?void 0:t.size)?void 0:p.z,"sizez")}if(R.x=Math.abs(R.x),R.y=Math.abs(R.y),R.z=Math.abs(R.z),R.clampScalar(this.layout.adapter.system.config.epsillonMeters/10,1e20),S.setFromCenterAndSize(M,R),"minX"===w){const t=null==(m=this.layout.spatialBoundsConstraint)?void 0:m.spec;S.min.x=this._perturbFromSpatialBoundsSpec(S.min.x,x*R.x,null==t?void 0:t.left,"left")}else if("minY"===w){const t=null==(g=this.layout.spatialBoundsConstraint)?void 0:g.spec;S.min.y=this._perturbFromSpatialBoundsSpec(S.min.y,x*R.y,null==t?void 0:t.bottom,"bottom")}else if("minZ"===w){const t=null==(y=this.layout.spatialBoundsConstraint)?void 0:y.spec;S.min.z=this._perturbFromSpatialBoundsSpec(S.min.z,x*R.z,null==t?void 0:t.back,"back")}else if("maxX"===w){const t=null==(_=this.layout.spatialBoundsConstraint)?void 0:_.spec;S.max.x=this._perturbFromSpatialBoundsSpec(S.max.x,x*R.x,null==t?void 0:t.right,"right")}else if("maxY"===w){const t=null==(f=this.layout.spatialBoundsConstraint)?void 0:f.spec;S.max.y=this._perturbFromSpatialBoundsSpec(S.max.y,x*R.y,null==t?void 0:t.top,"top")}else if("maxZ"===w){const t=null==(v=this.layout.spatialBoundsConstraint)?void 0:v.spec;S.max.z=this._perturbFromSpatialBoundsSpec(S.max.z,x*R.z,null==t?void 0:t.front,"front")}else if("minXAspect"===w){const t=S.max.x,e=4**ot(x);R.multiplyScalar(e),S.setFromCenterAndSize(M,R),S.max.x=t,S.min.x=t-R.x}else if("minYAspect"===w){const t=S.max.y,e=4**ot(x);R.multiplyScalar(e),S.setFromCenterAndSize(M,R),S.max.y=t,S.min.y=t-R.y}else if("minZAspect"===w){const t=S.max.z,e=4**ot(x);R.multiplyScalar(e),S.setFromCenterAndSize(M,R),S.max.z=t,S.min.z=t-R.z}else if("maxXAspect"===w){const t=S.min.x,e=4**ot(x);R.multiplyScalar(e),S.setFromCenterAndSize(M,R),S.min.x=t,S.max.x=t+R.x}else if("maxYAspect"===w){const t=S.min.y,e=4**ot(x);R.multiplyScalar(e),S.setFromCenterAndSize(M,R),S.min.y=t,S.max.y=t+R.y}else if("maxZAspect"===w){const t=S.min.z,e=4**ot(x);R.multiplyScalar(e),S.setFromCenterAndSize(M,R),S.min.z=t,S.max.z=t+R.z}else"corner000"===w?Ct._mutateCorner(S,"min","min","min",x):"corner001"===w?Ct._mutateCorner(S,"min","min","max",x):"corner010"===w?Ct._mutateCorner(S,"min","max","min",x):"corner011"===w?Ct._mutateCorner(S,"min","max","max",x):"corner100"===w?Ct._mutateCorner(S,"max","min","min",x):"corner101"===w?Ct._mutateCorner(S,"max","min","max",x):"corner110"===w?Ct._mutateCorner(S,"max","max","min",x):"corner111"===w&&Ct._mutateCorner(S,"max","max","max",x);return b}_perturbFromSpatialBoundsSpec(t,e,s,i){if(void 0===s)return t+ot(e);if(s instanceof Array&&(s=lt(s)),wt.isDiscreteSpec(s))return this.layout.adapter.measureBounds(s,"spatial",i);const r=s,n="gt"in r?this.layout.adapter.measureBounds(r.gt,"spatial",i):void 0,a="lt"in r?this.layout.adapter.measureBounds(r.lt,"spatial",i):void 0;return void 0!==n&&void 0!==a&&(t<n||t>a)?n+Math.random()*(a-n):void 0!==n&&t<n?n+ht(e):void 0!==a&&t>a?a-ht(e):ot(e)}static generatePulseFrequency(t,e){return t+Math.random()*(e-t)}static _mutateCorner(t,e,s,i,r){const n=t.getCenter(this._center),a=Ct._scratchV1.set(t[e].x,t[s].y,t[i].z).sub(n),o=a.length()*4**ot(r);a.normalize().multiplyScalar(o),t[e].x=a.x+n.x,t[s].y=a.y+n.y,t[i].z=a.z+n.z}apply(t=!1){const e=this.layout,s=e.adapter;if(s.parentNode=e.parentNode,s.orientation.target=this.orientation,s.bounds.target=this.bounds,s.metrics.invalidateNodeStates(),t)for(let i=0;i<e.objectives.length;i++){const t=this.scores[i]=e.objectives[i].evaluate();isFinite(t)&&(this.bestScores[i]=Math.max(this.bestScores[i],t))}}}Ct._scratchV1=new o,Ct._scratchV2=new o,Ct._center=new o,Ct._size=new o,Ct._otherCenter=new o,Ct._otherSize=new o;const Dt=m;class Lt{constructor(t){t&&Object.assign(this,t)}}class Bt{constructor(t){t&&Object.assign(this,t)}}class It extends Bt{constructor(t,e,s,i=t.config.transition){super(s),this.system=t,this.parentConfig=i,this.needsUpdate=!1,this.queue=[],this.enabled=!1,this.forceWait=!1,this._forceCommit=!1,this._resolvedConfig=new Bt,this.delayTime=0,this.debounceTime=0,this.waitTime=0,this._previousStatus="unchanged",this._status="unchanged",this._scratchV2=new a,this._scratchV3=new o,this._scratchQ=new h,this._scratchBox=new l,this._scratchColor=new g,this._blackColor=new g(0,0,0),this._addTransitionToCurrent=(t,e,s)=>{if(0===s.elapsed)return;const i=s.easing(Math.min(s.elapsed/s.duration,1)),r=s.target;if("number"!=typeof r){if("isVector3"in r){const s=t,n=e,a=r,o=this._scratchV3.copy(a).sub(n).lerp(Z,1-i);this._current=s.add(o)}else if("isVector2"in r){const s=t,n=e,a=r,o=this._scratchV2.copy(a).sub(n).lerp(H,1-i);this._current=s.add(o)}else if("isQuaternion"in r){const s=t,n=e,a=r,o=this._scratchQ.copy(n).inverse().multiply(a).slerp(st,1-i);this._current=s.multiply(o).normalize()}else if("isColor"in r){const s=t,n=e,a=r,o=this._scratchColor.copy(a).sub(n).lerp(this._blackColor,1-i);this._current=s.add(o)}else if("isBox3"in r){const s=t,n=e,a=r,o=this._scratchBox.min.copy(a.min).sub(n.min).lerp(Z,1-i),h=this._scratchBox.max.copy(a.max).sub(n.max).lerp(Z,1-i);return s.min.add(o),s.max.add(h),void(this._current=s)}}else this._current=t+u.lerp(r-e,0,1-i)},this.reset(e),this._previousTarget=this._copy(this._previousTarget,this.target)}_copy(t,e){if(void 0!==e)return"number"==typeof e?e:t?t.copy(e):e.clone()}_isEqual(t,e){return void 0!==t&&void 0!==e&&(t===e||("number"==typeof t?t===e:(null==t?void 0:t.equals(e))||!1))}reset(t){this._start=this._copy(this._start,t),this._current=this._copy(this._current,t),this._target=this._copy(this._target,t),this.queue.length=0}set start(t){this._start=this._copy(this._start,t)}get start(){return this._start}set current(t){this._current=this._copy(this._current,t)}get current(){return this._current}set reference(t){this._reference=this._copy(this._reference,t)}get reference(){return this._reference}set target(t){this.enabled=!0,this._target=this._copy(this._target,t)}get target(){return this._target}get progress(){if(!this.enabled)return 1;if(this.queue.length>0){const t=this.queue[this.queue.length-1];return t.elapsed/t.duration}return 1}get forceCommit(){return this._forceCommit}set forceCommit(t){this._forceCommit!==t&&(this._forceCommit=t)}get relativeDifference(){var t;const e=(null==(t=this.queue[this.queue.length-1])?void 0:t.target)||this.start;return void 0!==this.target?rt(e,this.target):0}get referenceRelativeDifference(){return void 0!==this.reference&&void 0!==this.target?rt(this.reference,this.target):1/0}get resolvedConfig(){var t,e,s,i,r,n,a,o,h,c,l,u,d,p,m,g;const y=this._resolvedConfig,_=this.parentConfig,f=this.system.config.transition;return y.multiplier=null!=(e=null!=(t=this.multiplier)?t:null==_?void 0:_.multiplier)?e:f.multiplier,y.duration=null!=(i=null!=(s=this.duration)?s:null==_?void 0:_.duration)?i:f.duration,y.easing=null!=(n=null!=(r=this.easing)?r:null==_?void 0:_.easing)?n:f.easing,y.threshold=null!=(o=null!=(a=this.threshold)?a:null==_?void 0:_.threshold)?o:f.threshold,y.delay=null!=(c=null!=(h=this.delay)?h:null==_?void 0:_.delay)?c:f.delay,y.debounce=null!=(u=null!=(l=this.debounce)?l:null==_?void 0:_.debounce)?u:f.debounce,y.maxWait=null!=(p=null!=(d=this.maxWait)?d:null==_?void 0:_.maxWait)?p:f.maxWait,y.blend=null!=(g=null!=(m=this.blend)?m:null==_?void 0:_.blend)?g:f.blend,y}get previousStatus(){return this._previousStatus}get status(){return this.needsUpdate&&(this._previousStatus=this._status,this._status=this._computeStatus()),this._status}_computeStatus(){if(this.forceCommit)return"committing";const t=this.resolvedConfig,e=t.threshold,s=this.system.deltaTime*t.multiplier,i=this.delayTime+s,r=this.debounceTime+s,n=this.waitTime+s;if(!(this.relativeDifference>e))return"unchanged";if(!this.forceWait&&(i>=t.delay&&r>=t.debounce||n>=t.maxWait))return"committing";return!(this.referenceRelativeDifference<e)&&i>=t.delay?"changed":"settling"}_updateTransitionable(){var t,e,s,i,r;const n=this.system.deltaTime,a=this.resolvedConfig,o=this.queue,h=this.status,c=n*a.multiplier;for(;o.length&&o[0].elapsed>=o[0].duration;)this.start=o.shift().target;this.current=this.start;const l=this._current;let u=this.start;for(const d of o)if(this._addTransitionToCurrent(l,u,d),d.elapsed+=c,u=d.target,!d.blend)break;switch(h){case"changed":this.reference=this.target,this.debounceTime=0;case"settling":this.reference?(this.debounceTime+=c,this.waitTime+=c):this.delayTime+=c;break;case"unchanged":if(this.reference=void 0,this.delayTime=0,this.debounceTime=0,this.waitTime=0,this.relativeDifference>0)if(this.queue.length>0){const t=this.queue[this.queue.length-1];t.target=this._copy(t.target,this.target)}else this.start=this._copy(this.start,this.target);break;case"committing":const n="object"==typeof this.forceCommit?this.forceCommit:new Lt;n.target=null!=(t=n.target)?t:this._copy(void 0,this.target),n.duration=null!=(e=n.duration)?e:a.duration,n.easing=null!=(s=n.easing)?s:a.easing,n.blend=null!=(i=n.blend)?i:a.blend,n.elapsed=null!=(r=n.elapsed)?r:0,o.push(n),this.forceCommit=!1}this.forceWait=!1}update(t=!1){if(!this.needsUpdate&&!t)return;if(this._isEqual(this._previousTarget,this.target)||(this._target=this._target,this.enabled=!0),this._previousTarget=this._copy(this._previousTarget,this.target),!this.enabled)return;const e=this.syncGroup;if(!this.forceCommit&&e)for(const s of e)if(s.enabled&&"committing"===s.status){for(const t of e)t.needsUpdate&&!1===t.forceCommit&&(t.forceCommit=!0);break}this._updateTransitionable(),this.needsUpdate=!1}set syncGroup(t){this._syncGroup&&this._syncGroup.delete(this),this._syncGroup=t,null==t||t.add(this)}get syncGroup(){return this._syncGroup}}class Nt{constructor(t){t&&Object.assign(this,t)}}class Ot{constructor(t){e.set(this,void 0),s.set(this,void 0),this.system=t,this._config=new Nt,this._prevOrientation=new h,this._prevBounds=new l,n(this,e,new Ct),n(this,s,new Ct)}_setConfig(t){var e,s,i,r,n,a,o,h,c,l;const u=this.system.config.optimize;this._config.allowInvalidLayout=u.allowInvalidLayout,this._config.pulseRate=u.pulseRate,this._config.iterationsPerFrame=null!=(e=t.optimize.iterationsPerFrame)?e:u.iterationsPerFrame,this._config.swarmSize=null!=(s=t.optimize.swarmSize)?s:u.swarmSize,this._config.pulseFrequencyMin=null!=(i=t.optimize.pulseFrequencyMin)?i:u.pulseFrequencyMin,this._config.pulseFrequencyMax=null!=(r=t.optimize.pulseFrequencyMax)?r:u.pulseFrequencyMax,this._config.stepSizeMax=null!=(n=t.optimize.stepSizeMax)?n:u.stepSizeMax,this._config.stepSizeMin=null!=(a=t.optimize.stepSizeMin)?a:u.stepSizeMin,this._config.successRateMin=null!=(o=t.optimize.successRateMin)?o:u.successRateMin,this._config.stepSizeStart=null!=(h=t.optimize.stepSizeStart)?h:u.stepSizeStart,this._config.staleRestartRate=null!=(c=t.optimize.staleRestartRate)?c:u.staleRestartRate,this._config.successRateMovingAverage=null!=(l=t.optimize.successRateMovingAverage)?l:u.successRateMovingAverage}update(t){if(0===t.layouts.length||t.metrics.innerBounds.isEmpty())return t.activeLayout=null,!0;if(!t.hasValidContext)return!1;const e=t.parentNode,s=this._prevOrientation.copy(t.orientation.target),i=this._prevBounds.copy(t.bounds.target),r=t.activeLayout;this._setConfig(t);for(const o of t.layouts)this._updateLayout(t,o);let n,a;for(const o of t.layouts){const t=o.solutions[0];(this._config.allowInvalidLayout||t.isValid)&&(!a||o.compareSolutions(t,a)<0)&&(n=o,a=t)}return n?(a.apply(!1),t.activeLayout=n,!0):(t.parentNode=e,t.orientation.target=s,t.bounds.target=i,t.activeLayout=r,t.metrics.invalidateNodeStates(),!1)}_updateLayout(t,i){var n;t.measureBoundsCache.clear();const a=i.solutions,o=this._config,h=r(this,e),c=r(this,s),l=2/(o.successRateMovingAverage+1);let u=o.iterationsPerFrame;i.successRate<.01&&(null==(n=i.solutions[0])?void 0:n.isValid)&&(u=1),this._manageSolutionPopulation(t,i,o.swarmSize,o.stepSizeStart),a[0].apply(!0);for(let e=0;e<u;e++){i.iteration++,c.copy(a[0]);for(let t=0;t<a.length;t++){const e=a[t];let s;if(h.copy(e),h.mutationStrategies=e.mutationStrategies,Math.random()<o.pulseRate){const t=c!==e?c:a[1];let s;if(a.length>2)do{s=a[Math.floor(Math.random()*a.length)]}while(s===e);h.moveTowards(t,o.pulseFrequencyMin,o.pulseFrequencyMax),s&&i.compareSolutions(s,e)<=0&&h.moveTowards(s,o.pulseFrequencyMin,o.pulseFrequencyMax)}else s=h.perturb();h.apply(!0);const r=i.compareSolutions(h,e)<0;if(r&&e.copy(h),s)if(s.successRate=l*(r?1:0)+(1-l)*s.successRate,s.stepSize*=r?1.5:.9036020036098449,s.stepSize>o.stepSizeMax?s.stepSize=o.stepSizeMax:s.stepSize<o.stepSizeMin&&(s.stepSize=o.stepSizeMin),s.successRate<o.successRateMin&&Math.random()<o.staleRestartRate&&!r){i.restartRate=.001+.999*i.restartRate;for(const t of e.mutationStrategies)t.stepSize=o.stepSizeStart,t.successRate=.2;if(e!==a[0]){e.randomize(1),e.apply(!0),e.bestScores.length=0;for(const t of e.scores)e.bestScores.push(t)}}else i.restartRate=.999*i.restartRate}i.sortSolutions(),i.compareSolutions(c,a[0])<=0?i.successRate=.999*i.successRate:i.successRate=.001+.999*i.successRate}}_manageSolutionPopulation(t,e,s,i){if(s<=1)throw new Error("Swarm size must be larger than 1");if(e.solutions.length<s)for(;e.solutions.length<s;){const t=new Ct(e);for(const e of t.mutationStrategies)e.stepSize=i;t.randomize(1),e.solutions.push(t)}else if(e.solutions.length>s)for(;e.solutions.length>s;)e.solutions.pop()}}e=new WeakMap,s=new WeakMap;class Ut{constructor(t,e){this.system=t,this.node=e,this.measureNumberCache=new Map,this.measureBoundsCache=new Map,this.optimize=new Nt,this.transition=new Bt,this._parentAdapter=null,this.layouts=new Array,this._prevLayout=null,this._activeLayout=null,this._progress=1,this._hasValidContext=!1,this.syncWithParentAdapter=!1,this._prevNodeOrientation=new h,this._prevNodeBounds=new l,this.metrics=this.system.getMetrics(this.node),this._orientation=new It(this.system,new h,void 0,this.transition),this._bounds=new It(this.system,(new l).setFromCenterAndSize(Z,et),void 0,this.transition),this._opacity=new It(this.system,0,void 0,this.transition),this._orientation.syncGroup=this._bounds.syncGroup=this._opacity.syncGroup=new Set}measureNumber(t,e){var s,i;if("number"==typeof t)return t;if(null==(s=this.measureNumberCache)?void 0:s.has(t))return this.measureNumberCache.get(t);const r=this.system;if(!At.compiledExpressions.has(t)){const e=r.math.parse(t).compile();At.compiledExpressions.set(t,e)}const n=At.compiledExpressions.get(t),a=n.evaluate(r.mathScope),o="number"==typeof a?a:r.math.number(n.evaluate(r.mathScope),e);return null==(i=this.measureNumberCache)||i.set(t,o),o}measureBounds(t,e,s){var i,r;if("number"==typeof t)return t;const n=e+"-"+s+" = "+t;if(null==(i=this.measureBoundsCache)?void 0:i.has(n))return this.measureBoundsCache.get(n);const a=this.system,o=a.mathScope,h=a.math;if(!At.compiledExpressions.has(t)){const e=h.parse(t.replace("%","percent")).compile();At.compiledExpressions.set(t,e)}const c=At.compiledExpressions.get(t),l=this.metrics.targetState;let u,d;switch(e){case"spatial":u=l.outerBounds,d=l.outerCenter;break;case"visual":u=l.outerState.visualBounds,d=l.outerState.visualCenter;break;case"view":const t=l.metrics.system.viewMetrics.targetState;u=t.visualBounds,d=t.visualCenter;break;default:throw new Error(`Unknown measure type "${e}.${s}"`)}if(t.includes("%")){const t="spatial"===e?l.outerSize:l.outerState.visualSize;let i=0;switch(s){case"left":case"centerx":case"right":case"sizex":i=h.unit(t.x/100,"m");break;case"bottom":case"centery":case"top":case"sizey":i=h.unit(t.y/100,"m");break;case"back":case"centerz":case"front":case"sizez":i=h.unit(t.z/100,"m");break;case"sizediagonal":i="spatial"===e?h.unit(t.length()/100,"m"):h.unit(Math.sqrt(t.x**2+t.y**2)/100,"px");break;default:throw new Error(`Unknown measure subtype "${e}.${s}"`)}o.percent=i}let p=0;switch(s){case"left":p=u.min.x;break;case"centerx":p=d.x;break;case"right":p=u.max.x;break;case"bottom":p=u.min.y;break;case"top":p=u.max.y;break;case"centery":p=d.y;break;case"front":p=u.min.z;break;case"back":p=u.max.z;break;case"centerz":p=d.z}let m="spatial"===e||"front"===s||"back"===s||"centerz"===s||"sizez"===s?o.meter:o.pixel;const g=0===c.evaluate(a.mathScope)?0:h.number(c.evaluate(o),m)+p;return o.percent=void 0,null==(r=this.measureBoundsCache)||r.set(n,g),g}set parentNode(t){var e,s,i,r,n,a;const o=void 0!==this._parentNode?this._parentNode:this.metrics.nodeState.parent;if((void 0!==t?t:this.metrics.nodeState.parent)===o)return;const h=this.metrics.outerMetrics;if(h){const t=h.currentState.worldOrientation,r=h.currentState.worldCenter;this.orientation.start.premultiply(t),this.orientation.target.premultiply(t),null==(e=this.orientation.reference)||e.premultiply(t),this.orientation.current.premultiply(t);for(const e of this.orientation.queue)e.target.premultiply(t);this.bounds.start.min.add(r),this.bounds.start.max.add(r),this.bounds.target.min.add(r),this.bounds.target.max.add(r),null==(s=this.bounds.reference)||s.min.add(r),null==(i=this.bounds.reference)||i.max.add(r),this.bounds.current.min.add(r),this.bounds.current.max.add(r);for(const e of this.bounds.queue)e.target.min.add(r),e.target.max.add(r)}this._parentNode=t;const c=this.metrics.outerMetrics;if(this.metrics.parentNode&&this.metrics.containsNode(this.metrics.parentNode))throw new Error("Node cannot become it's own descendent");if(c){const t=c.currentState,e=t.worldOrientationInverse,s=t.worldCenter;this.orientation.start.premultiply(e),this.orientation.target.premultiply(e),null==(r=this.orientation.reference)||r.premultiply(e),this.orientation.current.premultiply(e);for(const i of this.orientation.queue)i.target.premultiply(e);this.bounds.start.min.sub(s),this.bounds.start.max.sub(s),this.bounds.target.min.sub(s),this.bounds.target.max.sub(s),null==(n=this.bounds.reference)||n.min.sub(s),null==(a=this.bounds.reference)||a.max.sub(s),this.bounds.current.min.sub(s),this.bounds.current.max.sub(s);for(const i of this.bounds.queue)i.target.min.sub(s),i.target.max.sub(s)}}get parentNode(){return this._parentNode}get parentAdapter(){return this._parentAdapter}_computeParentAdapter(){let t=this.metrics;for(;t=t.parentMetrics;){const e=this.system.nodeAdapters.get(t.node);if(e)return e}return null}get orientation(){return this._orientation}get bounds(){return this._bounds}get opacity(){return this._opacity}get previousLayout(){return this._prevLayout}set activeLayout(t){this._prevLayout=this._activeLayout,this._activeLayout=t}get activeLayout(){return this._activeLayout}get progress(){return this._progress}_computeProgress(){return Math.min(this.orientation.progress,this.bounds.progress,this.opacity.progress)}createLayout(){const t=new At(this);return this.layouts.push(t),t}get hasValidContext(){return this._hasValidContext}_computeHasValidContext(){var t;const e=this.parentAdapter;return!e||!!e.hasValidContext&&(0===e.layouts.length||!!(null==(t=e.activeLayout)?void 0:t.hasValidSolution))}_update(){var t,e;this._parentAdapter=this._computeParentAdapter(),this._hasValidContext=this._computeHasValidContext();const s=this.metrics;if(this.onUpdate){const t=s.nodeState,e=t.parent,i=this._prevNodeOrientation.copy(t.localOrientation),r=this._prevNodeBounds.copy(t.spatialBounds);this.onUpdate(),s.invalidateIntrinsicBounds(),s.invalidateInnerBounds(),s.invalidateNodeStates(),s.nodeState;const n=this.system.config,a=t.spatialBounds;e!==t.parent&&(this.parentNode=t.parent),i.angleTo(t.localOrientation)>n.epsillonRadians&&(this.orientation.target=t.localOrientation),(r.min.distanceTo(a.min)>n.epsillonMeters||r.max.distanceTo(a.max)>n.epsillonMeters)&&(this.bounds.target=a),this.system.optimizer.update(this)||(this.parentNode=e,this.orientation.target=i,this.bounds.target=r)}else s.invalidateIntrinsicBounds(),s.invalidateInnerBounds(),s.invalidateNodeStates(),this.system.optimizer.update(this);this.syncWithParentAdapter&&0===(null==(t=this.parentAdapter)?void 0:t.progress)&&(this.opacity.forceCommit=!0,this.orientation.forceCommit=!0,this.bounds.forceCommit=!0),this.opacity.update(),this.orientation.update(),this.bounds.update(),this._progress=this._computeProgress(),s.invalidateNodeStates(),this.system.bindings.apply(s,s.currentState),s.invalidateNodeStates(),null==(e=this.onPostUpdate)||e.call(this)}}Ut.behavior={fadeOnEnterExit(t){t.opacity.target>0&&!t.metrics.parentNode&&(t.opacity.target=0)},fadeOnPoseChange(t,e=.1){t.opacity.target},fadeOnLayoutChange(){},pauseMotionOnFade(t){}};const Ft=new o;class Pt{constructor(t=0,e=0,s=0){this.horizontalRadians=t,this.verticalRadians=e,this.distance=s}get horizontalDegrees(){return this.horizontalRadians*u.RAD2DEG}set horizontalDegrees(t){this.horizontalRadians=t*u.DEG2RAD}get verticalDegrees(){return this.verticalRadians*u.RAD2DEG}set verticalDegrees(t){this.verticalRadians=t*u.DEG2RAD}setWithRadians(t,e,s){return this.horizontalRadians=t,this.verticalRadians=e,this.distance=s,this}setWithDegrees(t,e,s){return this.horizontalDegrees=t,this.verticalDegrees=e,this.distance=s,this}fromCartesianDirection(t){const e=Ft.copy(t).normalize();return this.verticalRadians=Math.asin(e.y)*u.RAD2DEG,this.horizontalRadians=Math.atan2(e.x,-e.z)*u.RAD2DEG,this.distance=0,this}fromCartesianPosition(t){return this.fromCartesianDirection(t),this.distance=t.length(),this}toCartesianDirection(t){const e=this.verticalRadians,s=-Math.PI-this.horizontalRadians,i=Math.sin(e),r=Math.cos(e)*Math.sin(s),n=-Math.cos(e)*Math.cos(s);return t.set(r,i,n).normalize()}toCartesianPosition(t){return this.toCartesianDirection(t).multiplyScalar(this.distance)}}class kt{constructor(t,e){this.viewNode=t,this.bindings=e,this.math=y({evaluateDependencies:_,addDependencies:f,subtractDependencies:v,multiplyDependencies:b,divideDependencies:w,modDependencies:x,numberDependencies:S,createUnitDependencies:M,unitDependencies:R},{predictable:!0}),this.mathScope={degree:this.math.unit("degree"),meter:this.math.unit("meter"),pixel:this.math.createUnit("pixel",{aliases:["pixels","px"]}),percent:void 0,vdeg:void 0,vw:void 0,vh:void 0},this.config={epsillonMeters:1e-8,epsillonRadians:1e-8,epsillonRatio:1e-8,transition:new Bt({multiplier:1,duration:0,easing:Dt.easeInOut,threshold:.001,delay:0,debounce:0,maxWait:10,blend:!0}),optimize:new Nt({allowInvalidLayout:!0,relativeTolerance:.001,iterationsPerFrame:8,swarmSize:3,pulseFrequencyMin:0,pulseFrequencyMax:1.5,pulseRate:.3,stepSizeMin:1e-6,stepSizeMax:10,stepSizeStart:.8,staleRestartRate:.5,successRateMovingAverage:200,successRateMin:.05})},this.optimizer=new Ot(this),this.viewFrustum=new mt,this.viewResolution=new a(1e3,1e3),this.deltaTime=1/60,this.time=0,this.maxDeltaTime=1/60,this.nodeMetrics=new Map,this.nodeAdapters=new Map,this.transitionables=[],this.getMetrics=t=>{if(!t)throw new Error("node must be defined");let e=this.nodeMetrics.get(t);return e||(e=new bt(this,t),this.nodeMetrics.set(t,e)),e},this.getState=t=>{if(!t)throw new Error("node must be defined");return this.getMetrics(t).targetState},this.getAdapter=t=>{let e=this.nodeAdapters.get(t);return e||(e=new Ut(this,t),this.nodeAdapters.set(t,e)),e},this.createTransitionable=(t,e)=>{const s=new It(this,t,e,this.config.transition);return this.transitionables.push(s),s},this._prevResolution=new a,this._prevSize=new a}get viewMetrics(){if(!this.viewNode)throw new Error("EtherealSystem.viewNode must be defined");return this.getMetrics(this.viewNode)}update(t,e){this.deltaTime=Math.max(t,this.maxDeltaTime),this.time=e,this._prevResolution.equals(this.viewResolution)&&this._prevSize.equals(this.viewFrustum.sizeDegrees)||(this.mathScope.vdeg=this.math.unit(this.viewResolution.y/this.viewFrustum.sizeDegrees.y,"px"),this.mathScope.vw=this.math.unit(this.viewResolution.x/100,"px"),this.mathScope.vh=this.math.unit(this.viewResolution.y/100,"px")),this._prevResolution.copy(this.viewResolution),this._prevSize.copy(this.viewFrustum.sizeDegrees);for(const s of this.nodeMetrics.values()){s.needsUpdate=!0;const t=this.nodeAdapters.get(s.node);t&&(t.opacity.needsUpdate=!0,t.orientation.needsUpdate=!0,t.bounds.needsUpdate=!0)}for(const s of this.transitionables)s.needsUpdate=!0;for(const s of this.transitionables)s.update();this.viewMetrics.update();for(const s of this.nodeAdapters.values())s.metrics.update()}}function Vt(t,e,s,i=0){i++;for(let r=t.firstChild;r;r=r.nextSibling)if(r.nodeType===Node.ELEMENT_NODE){const t=r;e.call(s,t,i)&&Vt(t,e,s,i)}}function jt(t,e,s,i){"insertRule"in t?t.insertRule(e+"{"+s+"}",i):"addRule"in t&&t.addRule(e,s,i)}class Gt{constructor(){this.left=0,this.top=0,this.width=0,this.height=0}copy(t){return this.top=t.top,this.left=t.left,this.width=t.width,this.height=t.height,this}}class Wt{constructor(){this.left=0,this.top=0,this.right=0,this.bottom=0}copy(t){return this.top=t.top,this.left=t.left,this.right=t.right,this.bottom=t.bottom,this}}function qt(t,e=new Gt,s){const i=t.ownerDocument,r=t.ownerDocument.defaultView,n=i.documentElement,a=i.body;if(t===n)return function(t,e){const s=t.documentElement,i=t.body,r=getComputedStyle(s),n=getComputedStyle(i);return e.top=i.offsetTop+parseFloat(r.marginTop)||0+parseFloat(n.marginTop)||0,e.left=i.offsetLeft+parseFloat(r.marginLeft)||0+parseFloat(n.marginLeft)||0,e.width=Math.max(Math.max(i.scrollWidth,s.scrollWidth),Math.max(i.offsetWidth,s.offsetWidth),Math.max(i.clientWidth,s.clientWidth)),e.height=Math.max(Math.max(i.scrollHeight,s.scrollHeight),Math.max(i.offsetHeight,s.offsetHeight),Math.max(i.clientHeight,s.clientHeight)),e}(i,e);if(s===t)return e.left=0,e.top=0,e.width=t.offsetWidth,void(e.height=t.offsetHeight);let o,h=t,c=h.offsetParent,l=r.getComputedStyle(h,null),u=h.offsetTop,d=h.offsetLeft;for(c&&s&&c.contains(s)&&c!==s&&(qt(s,e,c),d-=e.left,u-=e.top);(h=h.parentNode)&&h!==a&&h!==n&&h!==s&&"fixed"!==l.position;)o=r.getComputedStyle(h,null),u-=h.scrollTop,d-=h.scrollLeft,h===c&&(u+=h.offsetTop,d+=h.offsetLeft,u+=parseFloat(o.borderTopWidth)||0,d+=parseFloat(o.borderLeftWidth)||0,c=h.offsetParent),l=o;return"fixed"===l.position&&(u+=Math.max(n.scrollTop,a.scrollTop),d+=Math.max(n.scrollLeft,a.scrollLeft)),e.left=d,e.top=u,e.width=t.offsetWidth,e.height=t.offsetHeight,e}const $t=document.createElement("div");$t.id="VIEWPORT",$t.style.position="fixed",$t.style.width="100vw",$t.style.height="100vh",$t.style.visibility="hidden",$t.style.pointerEvents="none";class Qt{constructor(t,e){this.element=t,this.eventCallback=e,this.needsRefresh=!0,this.needsRemoval=!1,this.psuedoStates={hover:!1,active:!1,focus:!1,target:!1},this.svgImage=new Image,this.bounds=new Gt,this.padding=new Wt,this.margin=new Wt,this.border=new Wt,this.childLayers=[],this.cachedBounds=new Map,this.cachedMargin=new Map,this._dynamicAttributes="",this._svgDocument="",this._rasterizingDocument="",this._svgSrc="",this._hashingCanvas=document.createElement("canvas"),Kt.layers.set(t,this),this.id=t.getAttribute(Kt.ELEMENT_UID_ATTRIBUTE)||Kt.generateElementUID(),t.setAttribute(Kt.ELEMENT_UID_ATTRIBUTE,this.id),t.setAttribute(Kt.LAYER_ATTRIBUTE,""),this.parentLayer=Kt.getClosestLayer(this.element.parentElement),this.eventCallback("layercreated",{target:t}),Qt.cachedCanvases.limit=Kt.layers.size*Qt.DEFAULT_CACHE_SIZE}set canvas(t){this._canvas!==t&&(this._canvas=t,this.eventCallback&&this.eventCallback("layerpainted",{target:this.element}))}get canvas(){return this._canvas}get depth(){const t=this.parentLayer;let e=0;if(t){let s=this.element;for(;s!==t.element;)s=s.parentElement,e++}return e}get rootLayer(){let t=this;for(;t.parentLayer;)t=t.parentLayer;return t}traverseParentLayers(t){const e=this.parentLayer;e&&(e.traverseParentLayers(t),t(e))}traverseLayers(t){t(this),this.traverseChildLayers(t)}traverseChildLayers(t){for(const e of this.childLayers)e.traverseLayers(t)}refresh(){qt(this.element,this.bounds,this.parentLayer&&this.parentLayer.element),this.needsRefresh=!1,this._updateParentAndChildLayers(),Kt.addToSerializeQueue(this)}_updateParentAndChildLayers(){const t=this.element,e=this.childLayers,s=e.slice(),i=this.parentLayer;this.parentLayer=Kt.getClosestLayer(this.element.parentElement),i!==this.parentLayer&&(this.parentLayer&&this.parentLayer.childLayers.push(this),this.eventCallback("layermoved",{target:t})),e.length=0,Vt(t,this._tryConvertElementToWebLayer,this);for(const r of s){Kt.getClosestLayer(r.element.parentElement)||(r.needsRemoval=!0,e.push(r))}}_tryConvertElementToWebLayer(t){if(this.needsRemoval)return!1;const e=t,s=getComputedStyle(e);e.getAttribute(Kt.ELEMENT_UID_ATTRIBUTE)||e.setAttribute(Kt.ELEMENT_UID_ATTRIBUTE,Kt.generateElementUID());if(e.hasAttribute(Kt.LAYER_ATTRIBUTE)||"VIDEO"===e.nodeName||"none"!==s.transform){let t=Kt.layers.get(e);return t||(t=new Qt(e,this.eventCallback)),this.childLayers.push(t),!1}return!0}_generateSVGDocument(){}async serialize(){if("VIDEO"===this.element.nodeName)return;const[t]=await Promise.all([Kt.getEmbeddedPageCSS(),Kt.embedExternalResources(this.element)]);let{width:e,height:s}=this.bounds;if(e*s>0){!function(t,e){let s=getComputedStyle(t);e.left=parseFloat(s.paddingLeft)||0,e.right=parseFloat(s.paddingRight)||0,e.top=parseFloat(s.paddingTop)||0,e.bottom=parseFloat(s.paddingBottom)||0}(this.element,this.padding),function(t,e){let s=getComputedStyle(t);e.left=parseFloat(s.marginLeft)||0,e.right=parseFloat(s.marginRight)||0,e.top=parseFloat(s.marginTop)||0,e.bottom=parseFloat(s.marginBottom)||0}(this.element,this.margin),function(t,e){let s=getComputedStyle(t);e.left=parseFloat(s.borderLeftWidth)||0,e.right=parseFloat(s.borderRightWidth)||0,e.top=parseFloat(s.borderTopWidth)||0,e.bottom=parseFloat(s.borderBottomWidth)||0}(this.element,this.border),e+=Math.max(this.margin.left,0)+Math.max(this.margin.right,0),s+=Math.max(this.margin.top,0)+Math.max(this.margin.bottom,0);const i=Kt.attributeHTML(Kt.ELEMENT_UID_ATTRIBUTE,""+this.id),r=this.element,n="inline"===getComputedStyle(r).display;Kt.updateInputAttributes(r);const a=Kt.serializer.serializeToString(r).replace(i,`${i} ${Kt.RENDERING_ATTRIBUTE}="" ${n?`${Kt.RENDERING_INLINE_ATTRIBUTE}="" `:" "} `+Kt.getPsuedoAttributes(this.psuedoStates)),o=this._getParentsHTML(r);o[0]=o[0].replace("html","html "+Kt.RENDERING_DOCUMENT_ATTRIBUTE+'="" ');const h='<svg width="'+e+'" height="'+s+'" xmlns="http://www.w3.org/2000/svg"><defs><style type="text/css"><![CDATA[a[href]{color:#0000EE;text-decoration:underline;}'+t.join("")+']]></style></defs><foreignObject x="0" y="0" width="'+e+'" height="'+s+'">'+o[0]+a+o[1]+"</foreignObject></svg>",c=this._svgDocument=h,l=Qt.canvasHashes.get(c);if(l&&Qt.cachedCanvases.has(l))return void(this.canvas=Qt.cachedCanvases.get(l));this.cachedBounds.set(c,(new Gt).copy(this.bounds)),this.cachedMargin.set(c,(new Wt).copy(this.margin)),Kt.addToRasterizeQueue(this)}}async rasterize(){return new Promise((t=>{this.svgImage.onload=()=>{Kt.addToRenderQueue(this),t()},this._rasterizingDocument=this._svgDocument,this.svgImage.src=this._svgSrc="data:image/svg+xml;utf8,"+encodeURIComponent(this._svgDocument),this.svgImage.complete&&this.svgImage.currentSrc===this.svgImage.src&&(Kt.addToRenderQueue(this),this.svgImage.onload=null,t())}))}render(){const t=this._rasterizingDocument;if(!this.cachedBounds.has(t)||!this.cachedMargin.has(t))return void(this.needsRefresh=!0);if(!this.svgImage.complete)return void Kt.addToRenderQueue(this);let{width:e,height:s}=this.cachedBounds.get(t),{left:i,top:r}=this.cachedMargin.get(t);const n=this._hashingCanvas;let a=n.width=Math.max(.05*e,40),o=n.height=Math.max(.05*s,40);const h=n.getContext("2d");h.clearRect(0,0,a,o),h.drawImage(this.svgImage,i,r,e,s,0,0,a,o);const c=h.getImageData(0,0,a,o).data,l=Kt.arrayBufferToBase64(E.hash(new Uint8Array(c)))+"?w="+e+";h="+s;Qt.canvasHashes.set(t,l);const u=Qt.blankRetryCounts.get(t)||0;if(Kt.isBlankImage(c)&&u<10)return Qt.blankRetryCounts.set(t,u+1),void setTimeout((()=>Kt.addToRenderQueue(this)),500);if(Qt.cachedCanvases.has(l))return void(this.canvas=Qt.cachedCanvases.get(l));const d=this.pixelRatio||parseFloat(this.element.getAttribute(Kt.PIXEL_RATIO_ATTRIBUTE))||window.devicePixelRatio,p=Qt.cachedCanvases.size===Qt.cachedCanvases.limit?Qt.cachedCanvases.shift()[1]:document.createElement("canvas");let m=p.width=e*d+2,g=p.height=s*d+2;const y=p.getContext("2d");y.clearRect(0,0,m,g),y.drawImage(this.svgImage,i,r,e,s,1,1,m-1,g-1),Qt.cachedCanvases.set(l,p),this.canvas=p}_getParentsHTML(t){const e=[],s=[];let i=t.parentElement;do{let t=i.tagName.toLowerCase(),r=" ";for(const e of i.attributes)"style"!==e.name&&(r+=`${e.name}="${e.value}" `);const n="<"+t+("html"===t?` xmlns="http://www.w3.org/1999/xhtml" style="--x-width:${this.bounds.width}px;--x-height:${this.bounds.height}px;--x-inline-top:${this.border.top+this.margin.top+this.padding.top}px" `:"")+r+`${Kt.RENDERING_PARENT_ATTRIBUTE}=""  >`;e.unshift(n);const a="</"+t+">";if(s.push(a),"html"==t)break}while(i=i.parentElement);return[e.join(""),s.join("")]}}Qt.DEFAULT_CACHE_SIZE=4,Qt.blankRetryCounts=new Map,Qt.canvasHashes=new T.LRUMap(1e3),Qt.cachedCanvases=new T.LRUMap(Qt.DEFAULT_CACHE_SIZE);const Xt=self.ResizeObserver||A;const Ht=new z,Yt=new z,Zt=new TextDecoder;class Kt{static get ELEMENT_UID_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-uid"}static get HOVER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-hover"}static get ACTIVE_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-active"}static get FOCUS_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-focus"}static get TARGET_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-target"}static get LAYER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-layer"}static get PIXEL_RATIO_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-pixel-ratio"}static get RENDERING_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering"}static get RENDERING_PARENT_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-parent"}static get RENDERING_CONTAINER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-container"}static get RENDERING_INLINE_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-inline"}static get RENDERING_DOCUMENT_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-document"}static generateElementUID(){return""+this._nextUID++}static getPsuedoAttributes(t){return`${t.hover?`${this.HOVER_ATTRIBUTE}="" `:" "}${t.focus?`${this.FOCUS_ATTRIBUTE}="" `:" "}${t.active?`${this.ACTIVE_ATTRIBUTE}="" `:" "}${t.target?`${this.TARGET_ATTRIBUTE}="" `:" "}`}static _init(){if(this._didInit)return;this._didInit=!0;const t=document.createElement("style");document.head.append(t);const e=t.sheet;let s=0;jt(e,`[${Kt.RENDERING_DOCUMENT_ATTRIBUTE}] *`,"transform: none !important;",s++),jt(e,`[${Kt.RENDERING_ATTRIBUTE}], [${Kt.RENDERING_ATTRIBUTE}] *`,"visibility: visible !important;",s++),jt(e,`[${Kt.RENDERING_ATTRIBUTE}] [${Kt.LAYER_ATTRIBUTE}], [${Kt.RENDERING_ATTRIBUTE}] [${Kt.LAYER_ATTRIBUTE}] *`,"visibility: hidden !important;",s++),jt(e,`[${Kt.RENDERING_ATTRIBUTE}]`,"position: relative; top: 0 !important; left: 0 !important; float: none; box-sizing:border-box; width:var(--x-width); height:var(--x-height);",s++),jt(e,`[${Kt.RENDERING_INLINE_ATTRIBUTE}]`,"top: var(--x-inline-top) !important; width:auto !important",s++),jt(e,`[${Kt.RENDERING_PARENT_ATTRIBUTE}]`,"transform: none !important; left: 0 !important; top: 0 !important; margin: 0 !important; border:0 !important; border-radius:0 !important; height:100% !important; padding:0 !important; position:static !important; text-align:left !important; display:block !important; background: rgba(0,0,0,0) none !important; box-shadow:none !important",s++),jt(e,`[${Kt.RENDERING_PARENT_ATTRIBUTE}]::before, [${Kt.RENDERING_PARENT_ATTRIBUTE}]::after`,"content:none !important; box-shadow:none !important;",s++);let i="";const r=()=>{if(i!=window.location.hash&&window.location.hash)try{this.targetElement=document.querySelector(window.location.hash)}catch(t){}i=window.location.hash};window.addEventListener("hashchange",r,!1),r(),window.addEventListener("focusin",(t=>{this.focusElement=t.target}),!1),window.addEventListener("focusout",(t=>{this.focusElement=null}),!1)}static addToSerializeQueue(t){-1===this.serializeQueue.indexOf(t)&&this.serializeQueue.push(t)}static addToRasterizeQueue(t){-1===this.rasterizeQueue.indexOf(t)&&this.rasterizeQueue.push(t)}static addToRenderQueue(t){-1===this.renderQueue.indexOf(t)&&this.renderQueue.push(t)}static _runTasks(){Kt.tasksPending=!1;const t=Kt.serializeQueue,e=Kt.rasterizeQueue,s=Kt.renderQueue;let i=performance.now();for(;t.length&&performance.now()-i<Kt.TASK_SERIALIZE_MAX_TIME;)t.shift().serialize();for(i=performance.now();e.length&&performance.now()-i<Kt.TASK_RASTERIZE_MAX_TIME&&Kt.rasterizeTaskCount<Kt.TASK_RASTERIZE_MAX_SIMULTANEOUS;)Kt.rasterizeTaskCount++,e.shift().rasterize().then((()=>{Kt.rasterizeTaskCount--}));for(i=performance.now();s.length&&performance.now()-i<Kt.TASK_RENDER_MAX_TIME/2;)s.shift().render()}static scheduleTasksIfNeeded(){this.tasksPending||0===Kt.serializeQueue.length&&0===Kt.rasterizeQueue.length&&0===Kt.renderQueue.length||(this.tasksPending=!0,Kt.scheduleIdle(Kt._runTasks))}static scheduleIdle(t){"requestIdleCallback"in self?requestIdleCallback(t):setTimeout(t,1)}static setLayerNeedsRefresh(t){t.needsRefresh=!0}static createLayerTree(t,e){if(Kt.getClosestLayer(t))throw new Error("A root WebLayer for the given element already exists");Kt._init(),function(t){const e=t.ownerDocument;if(e.contains(t))return t;const s=e.createElement("div");s.setAttribute(Kt.RENDERING_CONTAINER_ATTRIBUTE,""),s.style.position="fixed",s.style.width="100%",s.style.height="100%",s.style.top="-100000px",s.style.contain="strict",s.appendChild(t),e.documentElement.appendChild(s)}(t);const s=new MutationObserver(Kt._handleMutations);this.mutationObservers.set(t,s),this.startMutationObserver(t);const i=new Xt((t=>{for(const e of t){const t=this.getClosestLayer(e.target);t.traverseLayers(Kt.setLayerNeedsRefresh),t.traverseParentLayers(Kt.setLayerNeedsRefresh)}}));i.observe(t),this.resizeObservers.set(t,i),t.addEventListener("input",this._triggerRefresh,{capture:!0}),t.addEventListener("keydown",this._triggerRefresh,{capture:!0}),t.addEventListener("submit",this._triggerRefresh,{capture:!0}),t.addEventListener("change",this._triggerRefresh,{capture:!0}),t.addEventListener("focus",this._triggerRefresh,{capture:!0}),t.addEventListener("blur",this._triggerRefresh,{capture:!0}),t.addEventListener("transitionend",this._triggerRefresh,{capture:!0});const r=new Qt(t,e);return this.rootLayers.set(t,r),r}static disposeLayer(t){if(this.rootLayers.has(t.element)){this.rootLayers.delete(t.element);this.mutationObservers.get(t.element).disconnect(),this.mutationObservers.delete(t.element);this.resizeObservers.get(t.element).disconnect(),this.resizeObservers.delete(t.element),t.element.removeEventListener("input",this._triggerRefresh,{capture:!0}),t.element.removeEventListener("keydown",this._triggerRefresh,{capture:!0}),t.element.removeEventListener("submit",this._triggerRefresh,{capture:!0}),t.element.removeEventListener("change",this._triggerRefresh,{capture:!0}),t.element.removeEventListener("focus",this._triggerRefresh,{capture:!0}),t.element.removeEventListener("blur",this._triggerRefresh,{capture:!0}),t.element.removeEventListener("transitionend",this._triggerRefresh,{capture:!0})}}static getClosestLayer(t){const e=t&&t.closest(`[${Kt.LAYER_ATTRIBUTE}]`);return this.layers.get(e)}static getCSSTransformForElement(t,e=new z){const s=getComputedStyle(t);var i=s.transform;if(0==i.indexOf("matrix(")){e.identity();var r=i.substring(7,i.length-1).split(", ").map(parseFloat);e.elements[0]=r[0],e.elements[1]=r[1],e.elements[4]=r[2],e.elements[5]=r[3],e.elements[12]=r[4],e.elements[13]=r[5]}else{if(0!=i.indexOf("matrix3d("))return e.identity();r=i.substring(9,i.length-1).split(", ").map(parseFloat);e.fromArray(r)}var n=s.transformOrigin.split(" ").map(parseFloat),a=n[0],o=n[1],h=n[2]||0,c=Ht.identity().makeTranslation(-a,-o,-h),l=Yt.identity().makeTranslation(a,o,h);return e.premultiply(l).multiply(c)}static async embedExternalResources(t){const e=[],s=t.querySelectorAll("*");for(const r of s){const t=r.getAttributeNS("http://www.w3.org/1999/xlink","href");t&&e.push(Kt.getDataURL(t).then((t=>{r.removeAttributeNS("http://www.w3.org/1999/xlink","href"),r.setAttribute("href",t)})));const s=r;if("IMG"==r.tagName&&"data"!=s.src.substr(0,4)&&e.push(Kt.getDataURL(s.src).then((t=>{r.setAttribute("src",t)}))),"http://www.w3.org/1999/xhtml"==r.namespaceURI&&r.hasAttribute("style")){const t=r.getAttribute("style")||"";e.push(Kt.generateEmbeddedCSS(window.location.href,t).then((e=>{t!=e&&r.setAttribute("style",e)})))}}const i=t.querySelectorAll("style");for(const r of i)e.push(Kt.generateEmbeddedCSS(window.location.href,r.innerHTML).then((t=>{r.innerHTML!=t&&(r.innerHTML=t)})));return Promise.all(e)}static pauseMutationObservers(){const t=Kt.mutationObservers.values();for(const e of t)Kt._handleMutations(e.takeRecords()),e.disconnect()}static resumeMutationObservers(){for(const[t]of Kt.mutationObservers)this.startMutationObserver(t)}static startMutationObserver(t){Kt.mutationObservers.get(t).observe(t,{attributes:!0,childList:!0,subtree:!0,characterData:!0,characterDataOldValue:!0,attributeOldValue:!0})}static _addDynamicPseudoClassRulesToPage(){const t=document.styleSheets;for(let r=0;r<t.length;r++)try{const i=t[r],n=i.cssRules;if(!n)continue;const a=[];for(var e=0;e<n.length;e++){n[e].cssText.indexOf(":hover")>-1&&a.push(n[e].cssText.replace(new RegExp(":hover","g"),`[${Kt.HOVER_ATTRIBUTE}]`)),n[e].cssText.indexOf(":active")>-1&&a.push(n[e].cssText.replace(new RegExp(":active","g"),`[${Kt.ACTIVE_ATTRIBUTE}]`)),n[e].cssText.indexOf(":focus")>-1&&a.push(n[e].cssText.replace(new RegExp(":focus","g"),`[${Kt.FOCUS_ATTRIBUTE}]`)),n[e].cssText.indexOf(":target")>-1&&a.push(n[e].cssText.replace(new RegExp(":target","g"),`[${Kt.TARGET_ATTRIBUTE}]`));var s=a.indexOf(n[e].cssText);s>-1&&a.splice(s,1)}for(e=0;e<a.length;e++)i.insertRule(a[e])}catch(i){}}static arrayBufferToBase64(t){for(var e="",s=t.byteLength,i=0;i<s;i++)e+=String.fromCharCode(t[i]);return window.btoa(e)}static attributeCSS(t,e){return e?`[${t}]=${e}`:`[${t}]`}static attributeHTML(t,e){return e?`${t}="${e}"`:`${t}=""`}static async generateEmbeddedCSS(t,e){let s;const i=[];e=(e=(e=(e=e.replace(new RegExp(":hover","g"),this.attributeCSS(this.HOVER_ATTRIBUTE))).replace(new RegExp(":active","g"),this.attributeCSS(this.ACTIVE_ATTRIBUTE))).replace(new RegExp(":focus","g"),this.attributeCSS(this.FOCUS_ATTRIBUTE))).replace(new RegExp(":target","g"),this.attributeCSS(this.TARGET_ATTRIBUTE));const r=RegExp(/url\((?!['"]?(?:data):)['"]?([^'"\)]*)['"]?\)/gi);for(;s=r.exec(e);){const r=s[1];i.push(this.getDataURL(new URL(r,t).href).then((t=>{e=e.replace(r,t)})))}return await Promise.all(i),e}static async getURL(t){return t=new URL(t,window.location.href).href,new Promise((e=>{var s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="arraybuffer",s.onload=()=>{e(s)},s.onerror=()=>{e(s)},s.send()}))}static async getEmbeddedPageCSS(){const t=this._embeddedPageCSS,e=Array.from(document.querySelectorAll("style, link[type='text/css'], link[rel='stylesheet']"));let s=!1;for(const i of e)if(!t.has(i))if(s=!0,"STYLE"==i.tagName){const e=i.sheet;let s="";for(const t of e.cssRules)s+=t.cssText+"\n";t.set(i,this.generateEmbeddedCSS(window.location.href,s))}else t.set(i,this.getURL(i.getAttribute("href")).then((t=>{if(!t.response)return"";this._addDynamicPseudoClassRulesToPage();var e=Zt.decode(t.response);return this.generateEmbeddedCSS(window.location.href,e)})));return s&&this._addDynamicPseudoClassRulesToPage(),Promise.all(t.values())}static async getDataURL(t){var e;const s=await this.getURL(t),i=new Uint8Array(s.response),r=null==(e=s.getResponseHeader("Content-Type"))?void 0:e.split(";")[0];if("text/css"==r){let e=Zt.decode(i);e=await this.generateEmbeddedCSS(t,e);const s=window.btoa(e);return s.length>0?"data:"+r+";base64,"+s:""}return"data:"+r+";base64,"+this.arrayBufferToBase64(i)}static updateInputAttributes(t){t.matches("input")&&this._updateInputAttribute(t);for(const e of t.getElementsByTagName("input"))this._updateInputAttribute(e)}static _updateInputAttribute(t){t.hasAttribute("checked")?t.checked||t.removeAttribute("checked"):t.checked&&t.setAttribute("checked",""),t.getAttribute("value")!==t.value&&t.setAttribute("value",t.value)}static isBlankImage(t){return!new Uint32Array(t.buffer).some((t=>0!==t))}}Kt.ATTRIBUTE_PREFIX="xr",Kt._nextUID=0,Kt.serializer=new XMLSerializer,Kt.rootLayers=new Map,Kt.layers=new Map,Kt.mutationObservers=new Map,Kt.resizeObservers=new Map,Kt.serializeQueue=[],Kt.rasterizeQueue=[],Kt.renderQueue=[],Kt.focusElement=null,Kt.activeElement=null,Kt.targetElement=null,Kt._didInit=!1,Kt.TASK_SERIALIZE_MAX_TIME=200,Kt.TASK_RASTERIZE_MAX_TIME=200,Kt.TASK_RASTERIZE_MAX_SIMULTANEOUS=2,Kt.TASK_RENDER_MAX_TIME=300,Kt.rasterizeTaskCount=0,Kt.tasksPending=!1,Kt._handleMutations=t=>{for(const e of t){if("attributes"===e.type){if(e.target.getAttribute(e.attributeName)===e.oldValue)continue}if("characterData"===e.type){if(e.target.data===e.oldValue)continue}const t=e.target.nodeType===Node.ELEMENT_NODE?e.target:e.target.parentElement;if(!t)continue;const s=Kt.getClosestLayer(t);if(s){if("attributes"===e.type&&"class"===e.attributeName){if((e.oldValue?e.oldValue:"")===e.target.className)continue}s.parentLayer?s.parentLayer.traverseChildLayers(Kt.setLayerNeedsRefresh):s.traverseLayers(Kt.setLayerNeedsRefresh)}}},Kt._triggerRefresh=async t=>{const e=Kt.getClosestLayer(t.target);e&&(e.parentLayer?e.parentLayer.traverseChildLayers(Kt.setLayerNeedsRefresh):e.traverseLayers(Kt.setLayerNeedsRefresh))},Kt._embeddedPageCSS=new Map;const Jt=new C,te=new C,ee=new Gt,se=new Gt;class ie extends L{constructor(t,e={}){super(),this.options=e,this.textures=new Map,this.textureNeedsUpdate=!1,this.contentMesh=new B(re.GEOMETRY,new I({transparent:!0,alphaTest:.001,opacity:1})),this.cursor=new N,this.depthMaterial=new O({depthPacking:U,alphaTest:.01}),this.domLayout=new N,this.domSize=new C(1,1,1),this.childWebLayers=[],this.shouldApplyDOMLayout="auto",this._doUpdate=()=>{this.updateLayout(),this.updateContent(),this.needsRefresh&&this.options.autoRefresh&&this.refresh(),Kt.scheduleTasksIfNeeded()};const s=this.element="string"==typeof t?function(t){const e=document.createElement("div");e.innerHTML=t;const s=e.firstElementChild;return e.removeChild(s),s}(t):t;this.name=s.id,this._webLayer=Kt.getClosestLayer(s),this.add(this.contentMesh),this.cursor.visible=!1,this.contentMesh.visible=!1,this.contentMesh.customDepthMaterial=this.depthMaterial,re.layersByElement.set(this.element,this),re.layersByMesh.set(this.contentMesh,this)}get currentTexture(){if("VIDEO"===this._webLayer.element.tagName){const t=this._webLayer.element;let e=this.textures.get(t);return e||(e=new F(t),e.wrapS=P,e.wrapT=P,e.minFilter=k,this.textures.set(t,e)),e}const t=this._webLayer.canvas;let e=this.textures.get(t);return e?this.textureNeedsUpdate&&(this.textureNeedsUpdate=!1,e.needsUpdate=!0):(e=new V(t),e.needsUpdate=!0,e.wrapS=P,e.wrapT=P,e.minFilter=k,this.textures.set(t,e)),e}get pseudoStates(){return this._webLayer.psuedoStates}get depth(){return this._webLayer.depth}get index(){return this.parentWebLayer?this.parentWebLayer.childWebLayers.indexOf(this):0}get needsRefresh(){return this._webLayer.needsRefresh}setNeedsRefresh(){this._webLayer.traverseLayers(Kt.setLayerNeedsRefresh)}get needsRemoval(){return this._webLayer.needsRemoval}get bounds(){return this._webLayer.bounds}get parentWebLayer(){return this._webLayer.parentLayer&&re.layersByElement.get(this._webLayer.parentLayer.element)}refresh(t=!1){this._webLayer.refresh(),this.childWebLayers.length=0;for(const e of this._webLayer.childLayers){const s=re.getClosestLayerForElement(e.element);s&&(this.childWebLayers.push(s),t&&s.refresh(t))}this._refreshVideoBounds(),this._refreshDOMLayout()}updateLayout(){this.position.copy(this.domLayout.position),this.quaternion.copy(this.domLayout.quaternion),this.scale.copy(this.domLayout.scale),this.contentMesh.scale.copy(this.domSize);const t=this.contentMesh,e=t.material.opacity<.005;e?t.visible=!1:t.material.map&&(t.visible=!0),this.needsRemoval&&e&&(this.parent&&this.parent.remove(this),this.dispose())}updateContent(){const t=this.contentMesh,e=this.currentTexture,s=t.material;e.image&&s.map!==e&&(s.map=e,this.depthMaterial.map=e,this.depthMaterial.needsUpdate=!0,Math.abs(this.position.z)<1e-9&&this.parent==this.parentWebLayer?(s.depthWrite=!1,this.renderOrder=this.depth+.001*this.index):(s.depthWrite=!0,this.renderOrder=0),s.needsUpdate=!0)}update(t=!1){t?this.traverseLayersPreOrder(this._doUpdate):this._doUpdate()}querySelector(t){const e=this.element.querySelector(t);if(e)return re.layersByElement.get(e)}traverseLayerAncestors(t){const e=this.parentWebLayer;e&&(e.traverseLayerAncestors(t),t(e))}traverseLayersPreOrder(t){if(!1===t(this))return!1;for(const e of this.childWebLayers)if(!1===e.traverseLayersPreOrder(t))return!1;return!0}traverseLayersPostOrder(t){for(const e of this.childWebLayers)if(!1===e.traverseLayersPostOrder(t))return!1;return t(this)||!0}dispose(){for(const t of this.textures.values())t.dispose();this.contentMesh.geometry.dispose(),Kt.disposeLayer(this._webLayer);for(const t of this.childWebLayers)t.dispose()}_refreshVideoBounds(){if("VIDEO"===this.element.nodeName){const t=this.element,e=this.currentTexture,s=getComputedStyle(this.element),{objectFit:i}=s,{width:r,height:n}=this.bounds,{videoWidth:a,videoHeight:o}=t,h=a/o,c=r/n;switch(e.center.set(.5,.5),i){case"none":e.repeat.set(r/a,n/o).clampScalar(0,1);break;case"contain":case"scale-down":if(e.repeat.set(1,1),c>h){const t=this.bounds.height*h||0;this.bounds.left+=(this.bounds.width-t)/2,this.bounds.width=t}else{const t=this.bounds.width/h||0;this.bounds.top+=(this.bounds.height-t)/2,this.bounds.height=t}break;case"cover":if(e.repeat.set(r/a,n/o),c<h){const t=this.bounds.height*h||0;this.bounds.left+=(this.bounds.width-t)/2,this.bounds.width=t}else{const t=this.bounds.width/h||0;this.bounds.top+=(this.bounds.height-t)/2,this.bounds.height=t}break;default:case"fill":e.repeat.set(1,1)}}}_refreshDOMLayout(){if(this.needsRemoval)return;this.domLayout.position.set(0,0,0),this.domLayout.scale.set(1,1,1),this.domLayout.quaternion.set(0,0,0,1);const t=this.bounds,e=t.width,s=t.height,i=1/re.DEFAULT_PIXELS_PER_UNIT;if(this.domSize.set(Math.max(i*e,1e-5),Math.max(i*s,1e-5),1),!re.shouldApplyDOMLayout(this))return;const r=this.parentWebLayer instanceof ie?this.parentWebLayer.bounds:function(t){return $t.parentNode||document.documentElement.append($t),t.left=pageXOffset,t.top=pageYOffset,t.width=$t.offsetWidth,t.height=$t.offsetHeight,t}(ee),n=-r.width/2+e/2,a=r.height/2-s/2;this.options.layerSeparation||re.DEFAULT_LAYER_SEPARATION,this.domLayout.position.set(i*(n+t.left),i*(a-t.top),0)}}class re extends ie{constructor(t,e={}){super(t,e),this.options=e,this._interactionRays=[],this._raycaster=new j,this._hitIntersections=[],this._previousHoverLayers=new Set,this._contentMeshes=[],this._prepareHitTest=t=>{t.pseudoStates.hover&&this._previousHoverLayers.add(t),t.cursor.visible=!1,t.pseudoStates.hover=!1,this._contentMeshes.push(t.contentMesh)},this._webLayer=Kt.createLayerTree(this.element,((t,{target:e})=>{var s,i;if("layercreated"===t){if(e===this.element)return;const t=new ie(e,this.options);null==(s=t.parentWebLayer)||s.add(t),this.options.onLayerCreate&&this.options.onLayerCreate(t)}else if("layerpainted"===t){const t=Kt.layers.get(e);re.layersByElement.get(t.element).textureNeedsUpdate=!0}else if("layermoved"===t){const t=re.layersByElement.get(e);null==(i=t.parentWebLayer)||i.add(t)}})),this.options.onLayerCreate&&this.options.onLayerCreate(this),this.refresh(!0)}static computeNaturalDistance(t,e){let s=t;t.isCamera&&(s=t.projectionMatrix);const i=e.getPixelRatio(),r=e.domElement.width/i,n=re.DEFAULT_PIXELS_PER_UNIT*r,a=function(t){const e=ne,s=ae.getInverse(t),i=oe;return e.left=i.set(-1,0,-1).applyMatrix4(s).angleTo(he),e.right=i.set(1,0,-1).applyMatrix4(s).angleTo(he),e.top=i.set(0,1,-1).applyMatrix4(s).angleTo(he),e.bottom=i.set(0,-1,-1).applyMatrix4(s).angleTo(he),e.horizontal=e.right+e.left,e.vertical=e.top+e.bottom,e}(s).horizontal;return n/2/Math.tan(a/2)}static shouldApplyDOMLayout(t){const e=t.shouldApplyDOMLayout;return"always"===e||!0===e||"never"!==e&&!1!==e&&!("auto"!==e||!t.parentWebLayer||t.parent!==t.parentWebLayer)}get parentWebLayer(){return super.parentWebLayer}get interactionRays(){return this._interactionRays}set interactionRays(t){this._interactionRays=t}update(t=!1){this._updateInteractions(),super.update(t)}_updateInteractions(){const t=this._previousHoverLayers;t.clear(),this._contentMeshes.length=0,this.traverseLayersPreOrder(this._prepareHitTest);for(const e of this._interactionRays){e instanceof G?this._raycaster.ray.copy(e):this._raycaster.ray.set(e.getWorldPosition(Jt),e.getWorldDirection(te)),this._hitIntersections.length=0;const s=this._raycaster.intersectObjects(this._contentMeshes,!1,this._hitIntersections)[0];if(s){const e=s.object.parent;e.cursor.position.copy(s.point),e.cursor.visible=!0,e.pseudoStates.hover=!0,t.has(e)||e.setNeedsRefresh()}}for(const e of t)e.pseudoStates.hover||e.setNeedsRefresh()}static getLayerForQuery(t){const e=document.querySelector(t);return re.layersByElement.get(e)}static getClosestLayerForElement(t){const e=t&&t.closest(`[${Kt.LAYER_ATTRIBUTE}]`);return re.layersByElement.get(e)}hitTest(t){const e=this._raycaster,s=this._hitIntersections,i=re.layersByMesh;e.ray.copy(t),s.length=0,e.intersectObject(this,!0,s);for(const r of s){const t=i.get(r.object);if(!t)continue;const e=qt(t.element,ee);if(!e.width||!e.height)continue;let s=t.element;const n=r.uv.x*e.width,a=(1-r.uv.y)*e.height;return Vt(t.element,(t=>{if(!s.contains(t))return!1;const i=qt(t,se),r=i.left-e.left,o=i.top-e.top,{width:h,height:c}=i;return n>r&&n<r+h&&a>o&&a<o+c&&(s=t,!0)})),{layer:t,intersection:r,target:s}}}}re.layersByElement=new WeakMap,re.layersByMesh=new WeakMap,re.DEFAULT_LAYER_SEPARATION=.001,re.DEFAULT_PIXELS_PER_UNIT=1e3,re.GEOMETRY=new D(1,1,2,2);const ne=new class{constructor(){this.top=0,this.left=0,this.bottom=0,this.right=0,this.horizontal=0,this.vertical=0}},ae=new z,oe=new C,he=new C(0,0,-1);const ce={getChildren(t,e){const s=t.node;e.length=0;for(let i=0;i<s.children.length;i++)e[i]=s.children[i]},getState(t,e){if(t.system.viewNode===t.node){const e=t.node;e.updateMatrixWorld(),t.system.viewFrustum.setFromPerspectiveProjectionMatrix(e.projectionMatrix)}const s=t.node;s.matrixAutoUpdate&&s.updateMatrix(),e.localMatrix=s.matrix,e.parent=s.parent},getIntrinsicBounds(t,e){const s=t.node;return s.geometry?(s.geometry.boundingBox||s.geometry.computeBoundingBox(),e.copy(s.geometry.boundingBox)):e},apply(t,e){const s=t.node;if(e.parent!==s.parent){e.parent.add(s)}s.quaternion.copy(e.localOrientation),s.position.copy(e.localPosition),s.scale.copy(e.localScale),s.matrix.copy(e.localMatrix),s.matrixWorld.copy(e.worldMatrix)}},le={getChildren(t,e){t.node.isObject3D&&ce.getChildren(t,e)},getState(t,e){t.node.isObject3D&&ce.getState(t,e)},getIntrinsicBounds:(t,e)=>(t.node.isObject3D&&ce.getIntrinsicBounds(t,e),e),apply(t,e){t.node.isObject3D&&ce.apply(t,e)}};function ue(t,e=le){return new kt(t,e)}var de=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",ThreeBindings:ce,DefaultBindings:le,createSystem:ue,WebLayer3D:re,WebLayer3DBase:ie,WebRenderer:Kt,Matrix3:W,Matrix4:c,MathUtils:u,V_00:H,V_11:Y,V_000:Z,V_100:K,V_010:J,V_001:tt,V_111:et,Q_IDENTITY:st,DIRECTION:it,Vector2:a,Vector3:o,Vector4:q,Quaternion:h,Euler:p,Color:g,Box2:d,Box3:l,Ray:$,Line3:Q,Plane:X,computeRelativeDifference:rt,gaussian:ot,levy:ht,randomQuaternion:ct,randomSelect:lt,extractRotationAboutAxis:ut,LayoutFrustum:mt,NodeState:vt,SpatialMetrics:bt,SpatialAdapter:Ut,SpatialLayout:At,LayoutSolution:Ct,OptimizerConfig:Nt,SpatialOptimizer:Ot,easing:Dt,Transition:Lt,TransitionConfig:Bt,Transitionable:It,SphericalCoordinate:Pt,EtherealSystem:kt,MemoizationCache:dt});export{st as Q,Pt as S,Z as V,re as W,J as a,et as b,ue as c,de as e};
