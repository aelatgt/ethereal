var e=Object.defineProperty,t=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,n=(t,s,i)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i,r=(e,r)=>{for(var a in r||(r={}))s.call(r,a)&&n(e,a,r[a]);if(t)for(var a of t(r))i.call(r,a)&&n(e,a,r[a]);return e};import{e as a,P as o,W as c,C as d,V as h,k as l,aj as p,ak as m,O as u,v as y,al as g,q as b,am as w,M as v,an as x,ao as f,ap as S,aq as R,ar as E,as as P,T as A,at as T,u as L,au as k,av as M,aw as j,ax as z,ay as O,d as B,c as q,a as C,az as X,t as _,aA as W,aB as D,w as I,p as H,b as U,o as F,aC as N,aD as V,n as J,aE as Y,aF as G,aG as Q,aH as $,aI as K}from"./vendor.50e18ee9.js";import{W as Z,b as ee,Q as te,d as se,c as ie,e as ne}from"./ethereal.be25efe8.js";const re=P(r({},A));class ae{constructor(e){this.app=e,this.textureLoader=new T,this.stlLoader=new re,this.snubber=new u,this.poster=new v(new L(1.04,2),new y),this.snubberAnchor=new u,this.snubberAnchorPosition=(new b).set(-.33,.92,.18),this.lineMaterial=new S({color:16753920,depthTest:!1}),this._scratchMatrix=new k,this.annotations=[{text:"TEST",anchorPoint:[0,0,0]},{text:"Part A",anchorPoint:[-.18,.06,.09]},{text:"Part B",anchorPoint:[.05,.05,.12]},{text:"Part C",anchorPoint:[-.1,.05,.11]},{text:"Part D",anchorPoint:[.14,-.22,-.06]},{text:"Part E",anchorPoint:[.11,0,.1]},{text:"Part F",anchorPoint:[-.06,-.04,.02]}],this.annotationState=new Map,this.loadPoser(),this.loadSnubberMesh()}loadPoser(){this.poster.name="poster",this.textureLoader.load("./public/Treadmill.jpeg",(e=>{this.poster.material.map=e,this.poster.material.needsUpdate=!0})),this.poster.add(this.snubberAnchor),this.snubberAnchor.position.copy(this.snubberAnchorPosition)}loadSnubberMesh(){this.snubber.name="snubber";const e=new u;e.quaternion.setFromAxisAngle(new b(0,0,1),Math.PI),e.scale.setScalar(.01),this.stlLoader.load("./public/fullSnubberSimplified.stl",(t=>{t.computeBoundsTree();const s=new M,i=new v(t,s);this.snubberMesh=i,this.snubberMesh.scale.setScalar(.1),e.add(i),this.snubber.add(e)}))}async enterXR(e){}update(e){}}const oe="https://prideview-ar.traclabs.com:8025/AR_server/",ce={json:"",procedure:"Treadmill Monthly Maintenance",step:"",instruction:"test",image:"",video:"./public/armWiggleDemonstrated.mov",elementType:"",elementSubType:"",objects:{}};async function de(){const e=await fetch(oe+"ARready",{mode:"cors"}).catch(),t=await e.json().catch(),s=t&&t.procedureElementInfo&&t.procedureElementInfo.steplist;if(!s)return await de();if("continue procedure"===t.text)return await he(),await de();ce.json=t,ce.step=s[s.length-1].title,ce.instruction=t.text,ce.elementType=t.procedureElementInfo.elementType,ce.elementSubType=t.procedureElementInfo.elementData[ce.elementType.toLowerCase()+"Type"];const i=Object.keys(t).filter((e=>e.toLowerCase().includes("object")));for(const n of i){const e=t[n],s=ce.objects[e.name]={},i=e.properties;for(const t in i)if("realityaugmentation"===t){const e=i[t].split(";");for(const t of e){if(!t)continue;let[e,i]=t.split(":");if(e=e.trim(),i=i.trim(),"position"===e||"rotation"===e||"size"===e){const[t,n,r]=i.split(" ").map((e=>parseFloat(e)));s[e]={x:t,y:n,z:r}}else s[e]=isNaN(i)?i:parseFloat(i)}}else s[t]=i[t]}return t}async function he(e="none"){const t=await fetch(oe+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"done",value:e})});return de(),t.json()}var le={data:ce,get:de,getText:async function(){return(await fetch(oe+"ARready",{mode:"cors"})).text()},done:he,startProcedure:async function(e){return(await fetch(oe+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:e})})).json()},back:async function(){return(await fetch(oe+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"back",value:"none"})})).json()},skip:async function(){return(await fetch(oe+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"skip",value:"none"})})).json()},comment:async function(e){return(await fetch(oe+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"comment",value:e})})).json()}};class pe{constructor(){this.logo="./public/pride-view.png",this.pride=r({},le.data),this.immersiveMode=!1}async getPrideData(){await le.get(),this.pride=r({},le.data)}start(){return this.getPrideData(),this}}const me=Symbol("state");const ue=B({setup:()=>j(O(me))}),ye=I();H("data-v-01e4315a");const ge={"xr-layer":"",id:"procedure"},be={id:"flex"},we={"xr-layer":"",id:"content"},ve={id:"step","xr-layer":""},xe=X("Step: "),fe={id:"type"},Se={id:"instruction","xr-layer":""},Re={"xr-layer":"","xr-pixel-ratio":"0.1",id:"media"},Ee=C("div",{"xr-layer":"",id:"model"},null,-1),Pe={id:"controls"},Ae=C("div",{"xr-layer":"",class:"button",id:"back"},"Back",-1),Te={"xr-layer":"",class:"button",id:"done"},Le={"xr-layer":"",class:"button",id:"yes"},ke={"xr-layer":"",class:"button",id:"no"},Me={"xr-layer":"",class:"button",id:"record"},je={"xr-layer":"",class:"button",id:"immersive-toggle"};U();const ze=ye(((e,t,s,i,n,r)=>(F(),q("div",{id:"pride","xr-pixel-ratio":"0.01",class:{xr:e.immersiveMode}},[C("div",ge,[C("img",{"xr-layer":"",class:"logo",src:e.logo},null,8,["src"]),X("Procedure: "+_(e.pride.procedure),1)]),C("div",be,[C("div",we,[C("div",ve,[xe,C("span",fe,_(e.pride.elementSubType),1),X(" "+_(e.pride.step),1)]),C("div",Se,_(e.pride.instruction),1)]),C("div",Re,[W(C("video",{"xr-layer":"",id:"video",loop:"","webkit-playsinline":"",playsinline:"true",crossorigin:"anonymous",muted:"",src:e.pride.video},null,8,["src"]),[[D,e.pride.video]]),W(C("img",{"xr-layer":"",id:"image",crossorigin:"anonymous",src:e.pride.image},null,8,["src"]),[[D,e.pride.image]])]),Ee]),C("div",Pe,[Ae,W(C("div",Te,"Done",512),[[D,["ManualInstruction","ClarifyingInfo","VerifyInstruction"].indexOf(e.pride.elementSubType)>-1]]),W(C("div",Le,"Yes",512),[[D,"Conditional"===e.pride.elementSubType]]),W(C("div",ke,"No",512),[[D,"Conditional"===e.pride.elementSubType]]),W(C("div",Me,"Record",512),[[D,"RecordInstruction"===e.pride.elementSubType]]),C("div",je,[C("b",null,_(e.immersiveMode?"Flat":"Immersive"),1)])])],2))));ue.render=ze,ue.__scopeId="data-v-01e4315a";class Oe{constructor(e){this.app=e,this.augmentations={},this.state=z(new pe).start(),this.prideVue=N(ue).provide(me,this.state).mount(document.createElement("div")),this.pride=this.app.createWebLayerTree(this.prideVue.$el,{onLayerCreate:e=>{this.app.system.getAdapter(e).onUpdate=()=>{e.update()}}}),this.procedure=this.pride.querySelector("#procedure"),this.step=this.pride.querySelector("#step"),this.instruction=this.pride.querySelector("#instruction"),this.content=this.pride.querySelector("#content"),this.media=this.pride.querySelector("#media"),this.image=this.pride.querySelector("#image"),this.video=this.pride.querySelector("#video"),this.model=this.pride.querySelector("#model"),this.controls=this.pride.querySelector("#controls"),this.backButton=this.pride.querySelector("#back"),this.doneButton=this.pride.querySelector("#done"),this.recordButton=this.pride.querySelector("#record"),this.yesButton=this.pride.querySelector("#yes"),this.noButton=this.pride.querySelector("#no"),this.immersiveButton=this.pride.querySelector("#immersive-toggle"),this.immersiveAnchor=new u,this.snubberBox=new V(this.app.treadmill.snubber);(()=>{this.app.scene.add(this.immersiveAnchor);const e=this.app.system.getAdapter(this.immersiveAnchor),t=new b;e.onUpdate=()=>{t.set(0,this.app.xrPresenting?1.6:0,this.app.xrPresenting?-.7:-1.4),e.bounds.target.setFromCenterAndSize(t,ee)}})(),(()=>{this.app.scene.add(this.pride);const e=this.app.system.getAdapter(this.pride),t=e.createLayout().orientation(te).scale(ee).visualBounds({back:"-10m",center:{x:0,y:0}}).maximize(),s=e.createLayout().poseRelativeTo(this.app.camera).orientation(te).keepAspect().visualBounds({back:"-4m",size:{y:"100 vh"},center:{x:"0 vdeg",y:"0 vdeg"}}).maximize();e.onUpdate=()=>{this.pride.options.autoRefresh=this.app.timeSinceLastResize>100,this.pride.update(),"world"===this.app.interactionSpace&&this.state.immersiveMode?e.layouts=[t]:e.layouts=[s]};const i=this.app.system.getAdapter(this.pride.contentMesh);i.transition.duration=1,i.bounds.enabled=!0,i.onUpdate=()=>{this.state.immersiveMode?this.pride.contentMesh.position.set(0,0,-1):this.pride.contentMesh.position.set(0,0,0)},setTimeout((()=>this.video.element.play()),5e3)})(),(()=>{const e=this.app.system.getAdapter(this.content),t=e.createLayout().poseRelativeTo(this.app.treadmill.snubber).keepAspect("xyz").orientation(te).bounds({center:{distance:{lt:"1m"}}}).visualBounds({absolute:{left:{gt:"10px"},top:{lt:"-10px"},bottom:{gt:"10px"}},right:{lt:"-100% -10px"},size:{diagonal:{gt:"10px"}}}).magnetize().maximize();e.onUpdate=()=>{this.state.immersiveMode?e.layouts=[t]:e.layouts=[],this.content.update()}})(),(()=>{const t=this.app.treadmill.poster;this.app.scene.add(t);const s=e.system.getAdapter(t);s.onUpdate=()=>{this.state.immersiveMode?(t.position.set(0,0,-3),s.opacity.target=1):(t.position.set(0,0,-5),s.opacity.target=0)}})(),(()=>{const t=this.app.treadmill.snubber;t.position.set(10,-10,-10),this.app.scene.add(t),this.app.scene.add(this.snubberBox);const s=e.system.getAdapter(t);s.transition.duration=1,s.transition.maxWait=10;const i=s.createLayout().poseRelativeTo(this.model).orientation({swingRange:{x:"10deg",y:"10deg"},twistRange:"0deg"}).keepAspect("xyz").visualBounds({back:"0m",left:{gt:"10px"},right:{lt:"-10px"},bottom:{gt:"10px"},top:{lt:"-10px"}}).maximize({minAreaPercent:.1}),n=[s.createLayout().poseRelativeTo(this.app.treadmill.poster).scale(ee).bounds({center:this.app.treadmill.snubberAnchorPosition}).orientation(te)],r=[i];s.onUpdate=()=>{this.state.immersiveMode?s.layouts=n:s.layouts=r},s.onPostUpdate=()=>{this.snubberBox.update()}})(),this.backButton.element.addEventListener("click",(async()=>{await le.back(),le.get()})),this.doneButton.element.addEventListener("click",(async()=>{await le.done(),le.get()})),this.recordButton.element.addEventListener("click",(async()=>{await le.done(),le.get()})),this.yesButton.element.addEventListener("click",(async()=>{await le.done("yes"),le.get()})),this.noButton.element.addEventListener("click",(async()=>{await le.done("no"),le.get()})),this.immersiveButton.element.addEventListener("click",(async()=>{this.state.immersiveMode=!this.state.immersiveMode,this.state.immersiveMode&&this.app.enterXR()}))}updateAugmentations(){const e=le.data.objects;for(const t in e){const s=e[t];let i=this.augmentations[t];if(!i){switch(s.type){case"box":const e=s.size;i=new v(new Y(.01*e.x,.01*e.y,.01*e.z));break;case"sphere":i=new v(new J(.01*s.radius));break;default:i=new u}this.augmentations[t]=i}i.position.copy(s.position).multiplyScalar(.01),i.rotation.x=s.rotation.x*G.DEG2RAD,i.rotation.y=s.rotation.y*G.DEG2RAD,i.rotation.z=s.rotation.z*G.DEG2RAD}}update(e){}}x.prototype.computeBoundsTree=Q,x.prototype.disposeBoundsTree=$,v.prototype.raycast=K;const Be=new class extends class{constructor(e){this._config=e,this.scene=new a,this.camera=new o,this.uiView=new o,this.renderer=new c({desynchronized:!0,antialias:!1,alpha:!0}),this.clock=new d,this.pointer=new h,this.raycaster=new l,this.mouseRay=[this.raycaster.ray],this.immersiveRays=new Set,this.interactionRays=[],this.xrObjects=new Map,this.webLayers=new Set,this.onAnimate=()=>{const e=this.renderer.domElement;this.xrPresenting||this._setSize(e.clientWidth,e.clientHeight,window.devicePixelRatio);const t=Math.min(this.clock.getDelta(),1/60);this.update(t),this.renderer.render(this.scene,this.camera)},this._wasPresenting=!1,this.update=e=>{if(this.interactionRays.length=0,"world"===this.interactionSpace)for(const t of this.immersiveRays)this.interactionRays.push(t);else for(const t of this.mouseRay)this.interactionRays.push(t);if(this.xrPresenting){this.renderer.setClearColor(new p("blue")),this.renderer.setClearColor(new p("white"),0),this._wasPresenting=!0;const e=this.renderer.xr.getCamera(this.camera);this.camera.matrix.copy(e.matrix),this.camera.matrix.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.projectionMatrix.copy(e.projectionMatrix),this.camera.projectionMatrixInverse.getInverse(this.camera.projectionMatrix),this.camera.updateWorldMatrix(!0,!0)}else{this.renderer.setClearColor(new p("white")),this._wasPresenting&&(this._wasPresenting=!1,this._exitXR(),this.interactionSpace="screen");const e=this.renderer.domElement,t=e.clientWidth/e.clientHeight;this.camera.aspect=t,this.camera.near=.001,this.camera.far=1e3,this.camera.updateProjectionMatrix()}this.raycaster.setFromCamera(this.pointer,this.camera),this._config.onUpdate({type:"update",deltaTime:e,elapsedTime:this.clock.elapsedTime})},this.interactionSpace="screen",this.lastResize=0,this.lastWidth=window.innerWidth,this.lastHeight=window.innerHeight,this.timeSinceLastResize=0,this.scene.add(this.camera);const t=this.renderer;document.documentElement.append(this.renderer.domElement),t.outputEncoding=m,t.domElement.style.position="fixed",t.domElement.style.width="100%",t.domElement.style.height="100%",t.domElement.style.top="0",t.domElement.addEventListener("mousemove",(function(e){s(e.clientX,e.clientY)})),t.domElement.addEventListener("touchmove",(function(e){e.preventDefault(),s(e.touches[0].clientX,e.touches[0].clientY)}),{passive:!1}),t.domElement.addEventListener("touchstart",(function(e){s(e.touches[0].clientX,e.touches[0].clientY),i(e)}),{passive:!1}),t.domElement.addEventListener("touchend",(function(e){setTimeout((()=>s(-1/0,-1/0)),400)}),{passive:!1}),t.domElement.addEventListener("click",(function(e){i(e)}),!1),t.setAnimationLoop(this.onAnimate),window.addEventListener("vrdisplaypresentchange",(e=>{setTimeout((()=>{this.xrPresenting||this._exitXR()}))}),!1),document.documentElement.style.width="100%",document.documentElement.style.height="100%";const s=(e,t)=>{this.pointer.x=(e+window.pageXOffset)/document.documentElement.offsetWidth*2-1,this.pointer.y=-(t+window.pageYOffset)/document.documentElement.offsetHeight*2+1};const i=e=>{for(const t of this.webLayers){const s=t.hitTest(this.raycaster.ray);s&&(s.target.dispatchEvent(new e.constructor(e.type,e)),s.target.focus(),console.log("hit",s.target,s.layer))}},n=e=>{const s=14365238,i=new y({color:s}),n=t.xr.getController(e);this.scene.add(n),n.addEventListener("selectstart",(e=>{i.color.setHex(16040461),o()})),n.addEventListener("selectend",(e=>{i.color.setHex(s)})),n.add(new g(1)),this.immersiveRays.add(n);const r=new b,a=new b,o=()=>{n.getWorldPosition(r),n.getWorldDirection(a),this.raycaster.ray.set(r,a);for(const e of this.webLayers){const t=e.hitTest(this.raycaster.ray);t&&(t.target.click(),t.target.focus())}};let c;n.addEventListener("connected",(e=>{c=function(e){let t,s;switch(e.targetRayMode){case"tracked-pointer":return t=new x,t.setAttribute("position",new f([0,0,0,0,0,-1],3)),t.setAttribute("color",new f([.5,.5,.5,0,0,0],3)),s=new S({vertexColors:!0,blending:R}),new E(t,s);case"gaze":return t=new w(.02,.04,32).translate(0,0,-1),s=new y({opacity:.5,transparent:!0}),new v(t,s)}}(e),c&&n.add(c)})),n.addEventListener("disconnected",(()=>{c&&n.remove(c)}))};n(0),n(1)}createWebLayerTree(e,t){const s=new Z(e,t);return s.interactionRays=this.interactionRays,this.webLayers.add(s),s}getXRObject3D(e){let t=this.xrObjects.get(e);return t||(t=new u,t.xrCoordinateSystem=e,this.xrObjects.set(e,t),t)}async start(){return this.enterXR().catch((()=>{console.log("Enter XR failed"),this.renderer.domElement.style.backgroundColor="lightgrey"}))}get xrPresenting(){return this.renderer.xr.isPresenting}async enterXR(){if(this.xrPresenting)return;if(!navigator.xr)throw new Error("WebXR is not supported by this browser");const e=async e=>{this.session&&this.session.end(),this.session=e,this.interactionSpace="world",await this.renderer.xr.setSession(e),e.addEventListener("end",(()=>{this.session=void 0,this.frameOfReference=void 0,this._exitXR()})),this._enterXR()};if(navigator.xr.requestSession){var t={optionalFeatures:["local-floor","bounded-floor","hand-tracking"]};return await navigator.xr.isSessionSupported("immersive-ar",t)?(console.log("AR supported, trying AR"),navigator.xr.requestSession("immersive-ar",t).then(e)):(console.log("AR not supported, trying VR"),navigator.xr.requestSession("immersive-vr",t).then(e))}}_enterXR(){this.renderer.xr.enabled=!0,this._config.onEnterXR({type:"enterxr"})}_exitXR(){this._config.onExitXR({type:"exitxr"}),this.camera.position.set(0,0,0),this.camera.quaternion.set(0,0,0,1),this.interactionSpace="screen",this.renderer.xr.enabled=!1}_setSize(e,t,s=1){e===this.lastWidth&&t===this.lastHeight||(this.lastWidth=e,this.lastHeight=t,this.lastResize=performance.now());const i=this.renderer.domElement;this.timeSinceLastResize=performance.now()-this.lastResize,this.timeSinceLastResize>2e3&&(i.width!==e*s||i.height!==t*s)&&(this.renderer.setSize(e,t,!1),this.renderer.setPixelRatio(s))}}{constructor(){super(...arguments),this.pride=le,this.system=ie(new o),this.treadmill=new ae(this),this.ui=new Oe(this),this.ethereal=ne}}({onUpdate:e=>{Be.renderer.getSize(Be.system.viewResolution),Be.system.update(e.deltaTime,e.elapsedTime)},onEnterXR:e=>{},onExitXR:e=>{Be.ui.state.immersiveMode=!1}});Be.system.transition.duration=.4,Be.system.transition.delay=0,Be.system.transition.maxWait=4,Be.system.transition.easing=se.easeOut,Be.start().catch((e=>{console.log(e.stack),alert(e)})),Object.assign(window,{THREE:A,app:Be});
