import{H as e,J as t,K as s,U as i,X as r,Y as n,Z as a,_ as o,$ as h,a0 as l,a1 as c,a2 as u,a3 as d,a4 as p,a5 as m,a6 as g,a7 as y,a8 as _,a9 as f,aa as v,ab as w,ac as b,ad as x,ae as M,af as T,T as S,ag as R,ah as E,ai as C,aj as z,ak as B,al as L}from"./vendor.js";const A=Object.freeze(new e(0,0)),O=Object.freeze(new e(1,1)),I=Object.freeze(new t(0,0,0)),N=Object.freeze(new t(1,0,0)),D=Object.freeze(new t(0,1,0)),F=Object.freeze(new t(0,0,1)),U=Object.freeze(new t(1,1,1)),P=Object.freeze(new s),V={RIGHT:Object.freeze(new t(1,0,0)),UP:Object.freeze(new t(0,1,0)),NEAR:Object.freeze(new t(0,0,1)),LEFT:Object.freeze(new t(-1,0,0)),DOWN:Object.freeze(new t(0,-1,0)),FAR:Object.freeze(new t(0,0,-1))};function k(e,t){return"number"==typeof e?function(e,t){if(t===e)return 0;const s=Math.abs(t-e),i=(Math.abs(t)+Math.abs(e))/2;return s/i}(e,t):"isVector3"in e?function(e,t){if(t.equals(e))return 0;const s=t.distanceTo(e),i=(t.length()+e.length())/2;return s/i}(e,t):"isVector2"in e?function(e,t){if(t.equals(e))return 0;const s=t.distanceTo(e),i=(t.length()+e.length())/2;return s/i}(e,t):"isBox3"in e?function(e,t){if(e.equals(t))return 0;const s=j,i=t.min.distanceTo(e.min),r=t.max.distanceTo(e.max),n=(i+r)/2,a=(t.getSize(s).length()+e.getSize(s).length())/2;return n/a}(e,t):"isQuaternion"in e?(i=t,(s=e).equals(i)?0:s.angleTo(i)/Math.PI):"isColor"in e?function(e,t){if(e.equals(t))return 0;return j.set(Math.abs(t.r-e.r),Math.abs(t.g-e.g),Math.abs(t.b-e.b)).length()/W}(e,t):1/0;var s,i}const j=new t;const W=Math.sqrt(3),q=(e=1)=>{var t=Math.random();return(t%1e-8>5e-9?1:-1)*Math.sqrt(-Math.log(Math.max(1e-9,t)))*e},$=(e=1)=>{const t=Math.sqrt(Math.sqrt(1/(2*e)));return 1/q(t)**2},H=(()=>{const e=2*Math.PI,i=new t(0,0,1),r=new s,n=new s,a=new t,o=new s;return function(t=1,s=1){var h=(Math.random()-.5)*e*t,l=Math.random()*e,c=Math.random()*Math.PI*s;return a.set(1,0,0).applyAxisAngle(i,l),r.setFromAxisAngle(i,h),n.setFromAxisAngle(a,c),o.multiplyQuaternions(n,r)}})();function G(e,t){let s=0;for(let r=0;r<e.length;r++)s+=(null==t?void 0:t[r])||1;const i=Math.random()*s;s=0;for(let r=0;r<e.length;r++)if(s+=(null==t?void 0:t[r])||1,s>i)return e[r];return e[0]}const Q=(()=>{const e=new t;return function(t,s,i){const r=e.set(t.x,t.y,t.z),n=s.dot(r),a=e.copy(s).multiplyScalar(n),o=i.set(a.x,a.y,a.z,t.w).normalize();return n<0&&(o.x=-o.x,o.y=-o.y,o.z=-o.z,o.w=-o.w),o}})();class X{constructor(){this.callbacks=[]}memoize(e,...t){t.push(this);const s=function(e){let t;const s=()=>{if(s.needsUpdate&&(s.needsUpdate=!1,t=e()),undefined===t)throw new Error("Possible recursive memoization detected");return t};return s.needsUpdate=!0,s}(e);for(const i of t)i.callbacks.push(s);return s}invalidateAll(){const e=this.callbacks;for(let t=0;t<this.callbacks.length;t++)e[t].needsUpdate=!0}isFullyInvalid(){const e=this.callbacks;for(let t=0;t<this.callbacks.length;t++)if(!e[t].needsUpdate)return!1;return!0}}var Y,Z,K;const J=Symbol("current"),ee=Symbol("target"),te=Symbol("previousTarget"),se=class{constructor(e,i){this.mode=e,this.metrics=i,this._cache=new X,this.opacity=1,this._parent=null,this._localMatrix=new n,this._worldMatrix=new n,this._worldMatrixInverse=new n,this._worldPosition=new t,this._worldOrientation=new s,this._worldOrientationInverse=new s,this._worldScale=new t(1,1,1),this._worldRotation=new n,this._worldRotationInverse=new n,this._relativePosition=new t,this._relativeOrientation=new s,this._relativeScale=new t(1,1,1),this._cachedWorldCenter=this._cache.memoize((()=>this._worldCenter.copy(this.metrics.innerCenter).applyMatrix4(this.worldMatrix))),this._worldCenter=new t,this._cachedSpatialMatrix=this._cache.memoize((()=>{const e=this._worldFromSpatial.compose(this.outerOrigin,this.worldOrientation,U);this._spatialFromWorld.copy(this._worldFromSpatial).invert(),this._localFromSpatial.multiplyMatrices(this.worldMatrixInverse,e),this._spatialFromLocal.copy(this._localFromSpatial).invert();const t=this.referenceState;return t?this._spatialFromReference.multiplyMatrices(this._spatialFromWorld,t.worldMatrix):this._spatialFromReference.copy(this._spatialFromWorld),e})),this._worldFromSpatial=new n,this._spatialFromWorld=new n,this._localFromSpatial=new n,this._spatialFromLocal=new n,this._spatialFromReference=new n,this._cachedSpatialBounds=this._cache.memoize((()=>{this._spatialBounds.copy(this.metrics.innerBounds);const e=this._spatialBounds.applyMatrix4(this.spatialFromLocal);return e.getCenter(this._spatialCenter),e.getSize(this._spatialSize),e})),this._spatialBounds=new r,this._spatialSize=new t,this._spatialCenter=new t,this._cachedOuterBounds=this._cache.memoize((()=>{const e=this._outerBounds,t=this.metrics.system.nodeAdapters.get(this.metrics.node);if(t)e.copy(t.outerBounds[this.mode]);else{const t=this.referenceState;t?e.copy(t.metrics.innerBounds):e.setFromCenterAndSize(I,I),e.applyMatrix4(this.spatialFromReference)}return e.getCenter(this._outerCenter),e.getSize(this._outerSize),e})),this._outerBounds=new r,this._outerCenter=new t,this._outerSize=new t,this._cachedOuterVisualBounds=this._cache.memoize((()=>{const e=this._outerVisualBounds,t=this.metrics.system.nodeAdapters.get(this.metrics.node);if(t)e.copy(t.outerVisualBounds[this.mode]);else{const t=this.referenceState;t?e.copy(t.visualBounds):e.setFromCenterAndSize(I,I)}return e.getCenter(this._outerVisualCenter),e.getSize(this._outerVisualSize),e})),this._outerVisualBounds=new r,this._outerVisualCenter=new t,this._outerVisualSize=new t,this._viewFromWorld=new n,this._viewFromSpatial=new n,this._spatialFromView=new n,this._cachedNDCBounds=this._cache.memoize((()=>{if(this.metrics.system.viewNode===this.metrics.node)return this._ndcBounds.min.setScalar(-1),this._ndcBounds.max.setScalar(1),this._ndcBounds;const e=this.metrics.system.viewFrustum.perspectiveProjectionMatrix,t=this.viewFromWorld,s=this._viewProjectionFromWorld.multiplyMatrices(e,t),i=this._ndcBounds.copy(this.metrics.innerBounds).applyMatrix4(s);return i.getCenter(this._ndcCenter),i.getSize(this._ndcSize),isFinite(i.min.x)&&isFinite(i.min.y)&&isFinite(i.min.z)&&isFinite(i.max.x)&&isFinite(i.max.y)&&isFinite(i.max.z)||(i.min.setScalar(-1),i.max.setScalar(1),i.getCenter(this._ndcCenter),i.getSize(this._ndcSize)),i}),this._viewState._cache),this._viewProjectionFromWorld=new n,this._ndcBounds=new r,this._ndcCenter=new t,this._ndcSize=new t,this._cachedVisualBounds=this._cache.memoize((()=>{const e=this.metrics.system,t=e.viewFrustum.perspectiveProjectionMatrix,s=this._inverseProjection.copy(t).invert(),i=this._visualBounds.copy(this.ndcBounds),r=this._v1,n=r.set(0,0,i.min.z).applyMatrix4(s).z,a=r.set(0,0,i.max.z).applyMatrix4(s).z;return i.min.z=a,i.max.z=n,i.min.x*=.5*e.viewResolution.x,i.max.x*=.5*e.viewResolution.x,i.min.y*=.5*e.viewResolution.y,i.max.y*=.5*e.viewResolution.y,i.getCenter(this._visualCenter),i.getSize(this._visualSize),i}),this._viewState._cache),this._visualBounds=new r,this._visualCenter=new t,this._visualSize=new t,this._v1=new t,this._inverseProjection=new n,this._viewPosition=new t,this._cachedViewAlignedOrientation=this._cache.memoize((()=>{const e=this._relativeViewMatrix.multiplyMatrices(this.worldMatrixInverse,this._viewState.worldMatrix),t=this._relativeViewRotation.extractRotation(e),s=this._relativeViewOrientation.setFromRotationMatrix(t),i=this._relativeViewForward.set(0,0,1).applyQuaternion(s),r=this._relativeViewUp.set(0,1,0).applyQuaternion(s);let n,a,o,h=1/0,l=1/0;for(o in V){const e=V[o];var c=r.distanceToSquared(e);c<l&&(l=c,a=e)}for(o in V){const e=V[o];if(e.x&&a.x)continue;if(e.y&&a.y)continue;if(e.z&&a.z)continue;const t=i.distanceToSquared(e);t<h&&(h=t,n=e)}const u=this._orthogonalRotation.identity();return u.lookAt(n,I,a),this._orthogonalOrientation.setFromRotationMatrix(u)}),this._viewState._cache),this._relativeViewMatrix=new n,this._relativeViewRotation=new n,this._relativeViewOrientation=new s,this._relativeViewUp=new t,this._relativeViewForward=new t,this._orthogonalRotation=new n,this._orthogonalOrientation=new s,this._computeOcclusion=this._cache.memoize((()=>{this._occludingPercent=0,this._occludedPercent=0;const e=this.metrics;if(e.innerBounds.isEmpty())return;const t=e.system.nodeAdapters.values(),s=this.visualBounds,i=s.min.z,r=se._boxA,n=se._boxB;r.min.set(s.min.x,s.min.y),r.min.set(s.max.x,s.max.y);const a=r.getSize(se._sizeA).length();for(const o of t){const t=o.metrics;if(t===e)continue;if(!t.isAdaptive||t.innerBounds.isEmpty())continue;if(t.containedByNode(o.node))continue;const h=("current"===this.mode?t.current:t.target).visualBounds;r.min.set(s.min.x,s.min.y),r.min.set(s.max.x,s.max.y),n.min.set(h.min.x,h.min.y),n.min.set(h.max.x,h.max.y);const l=r.intersect(n).getSize(se._sizeB).length()/a;l>0&&(i<h.min.z?this._occludingPercent+=l:this._occludedPercent+=l)}}),this._viewState._cache),this._occludingPercent=0,this._occludedPercent=0}invalidate(){this._cache.invalidateAll()}get parent(){return this._parent}set parent(e){this._parent!==e&&(this._parent=e,this.invalidate())}get parentState(){var e;return null==(e=this.metrics.parentMetrics)?void 0:e[this.mode]}get localMatrix(){var e;const t=null==(e=this.parentState)?void 0:e.worldMatrixInverse;return t?this._localMatrix.multiplyMatrices(t,this.worldMatrix):this._localMatrix.copy(this.worldMatrix)}get referenceState(){var e;return null==(e=this.metrics.referenceMetrics)?void 0:e[this.mode]}get worldMatrix(){return this._worldMatrix}set worldMatrix(e){if(isNaN(e.elements[0])||isNaN(e.elements[15])||0===e.elements[0])throw new Error;this._worldMatrix.equals(e)||(this.invalidate(),this._worldMatrix.copy(e),this._worldMatrixInverse.copy(this._worldMatrix).invert(),this._worldMatrix.decompose(this._worldPosition,this._worldOrientation,this._worldScale),this._worldOrientationInverse.copy(this._worldOrientation).invert(),this._worldRotation.makeRotationFromQuaternion(this._worldOrientation),this._worldRotationInverse.makeRotationFromQuaternion(this._worldOrientationInverse))}get relativePosition(){var e;const t=null==(e=this.referenceState)?void 0:e.worldPosition;return t?this._relativePosition.subVectors(this.worldPosition,t):this._relativePosition.copy(this.worldPosition)}get relativeOrientation(){var e;const t=null==(e=this.referenceState)?void 0:e.worldOrientationInverse;return t?this._relativeOrientation.multiplyQuaternions(this.worldOrientation,t):this._relativeOrientation.copy(this.worldOrientation)}get relativeScale(){var e;const t=null==(e=this.referenceState)?void 0:e.worldScale;return t?this._relativeScale.copy(this.worldScale).divide(t):this._relativeScale.copy(this.worldScale)}get worldMatrixInverse(){return this._worldMatrixInverse}get worldPosition(){return this._worldPosition}get worldOrientation(){return this._worldOrientation}get worldScale(){return this._worldScale}get worldOrientationInverse(){return this._worldOrientationInverse}get worldRotation(){return this._worldRotation}get worldRotationInverse(){return this._worldRotationInverse}get worldCenter(){return this._cachedWorldCenter()}get spatialMatrix(){return this._cachedSpatialMatrix()}get spatialMatrixInverse(){return this.spatialMatrix,this._spatialFromWorld}get localFromSpatial(){return this.spatialMatrix,this._localFromSpatial}get spatialFromLocal(){return this.spatialMatrix,this._spatialFromLocal}get spatialFromReference(){return this.spatialMatrix,this._spatialFromReference}get spatialBounds(){return this._cachedSpatialBounds()}get spatialSize(){return this.spatialBounds,this._spatialSize}get spatialCenter(){return this.spatialBounds,this._spatialCenter}get outerBounds(){return this._cachedOuterBounds()}get outerCenter(){return this.outerBounds,this._outerCenter}get outerSize(){return this.outerBounds,this._outerSize}get outerOrigin(){return this.metrics.outerOrigin[this.mode]()}get outerOrientation(){var e,t;const s=this.metrics.system.nodeAdapters.get(this.metrics.node);return s?s.outerOrientation[this.mode]:null!=(t=null==(e=this.referenceState)?void 0:e.worldOrientation)?t:P}get outerVisualBounds(){return this._cachedOuterVisualBounds()}get outerVisualCenter(){return this.outerVisualBounds,this._outerVisualCenter}get outerVisualSize(){return this.outerVisualBounds,this._outerVisualSize}get _viewState(){if(this.metrics.system.viewNode===this.metrics.node)return this;const e=this.metrics.system.viewMetrics;return"current"===this.mode?e[J]:e[ee]}get viewFromWorld(){return this._viewFromWorld.multiplyMatrices(this._viewState.worldMatrixInverse,this.worldMatrix)}get viewFromSpatial(){return this._viewFromSpatial.multiplyMatrices(this._viewState.worldMatrixInverse,this.spatialMatrix)}get spatialFromView(){return this._spatialFromView.copy(this.viewFromSpatial).invert()}get ndcBounds(){return this._cachedNDCBounds()}get ndcCenter(){return this._cachedNDCBounds(),this._ndcCenter}get ndcSize(){return this._cachedNDCBounds(),this._ndcSize}get visualBounds(){return this._cachedVisualBounds()}get visualCenter(){return this._cachedVisualBounds(),this._visualCenter}get visualSize(){return this._cachedVisualBounds(),this._visualSize}get relativeViewPosition(){return this._viewPosition.copy(this._viewState.worldPosition).applyMatrix4(this.worldMatrixInverse)}get viewAlignedOrientation(){return this._cachedViewAlignedOrientation()}get occludingPercent(){return this._computeOcclusion(),this._occludingPercent}get occludedPercent(){return this._computeOcclusion(),this._occludedPercent}visualAverageEdgeLength(){}};let ie=se;ie._boxA=new i,ie._boxB=new i,ie._sizeA=new e,ie._sizeB=new e;class re{constructor(e,i){this.system=e,this.node=i,this._cache=new X,this.needsUpdate=!0,this._cachedInnerBounds=this._cache.memoize((()=>{const e=this._innerBounds;if(!this.raw.parent)return e.makeEmpty();if(this.node!==this.system.viewNode){e.copy(this.intrinsicBounds);const t=this._childBounds;for(const s of this.boundingChildMetrics)s.update(),t.copy(s.innerBounds),t.applyMatrix4(s.raw.relativeMatrix),e.union(t)}const t=e.getCenter(this._innerCenter),s=e.getSize(this._innerSize);if(s.length()>0){const i=this.system.epsillonMeters;Math.abs(s.x)<=i&&(s.x=(Math.sign(s.x)||1)*i*1e3),Math.abs(s.y)<=i&&(s.y=(Math.sign(s.y)||1)*i*1e3),Math.abs(s.z)<=i&&(s.z=(Math.sign(s.z)||1)*i*1e3,t.z-=1e3*i/2),e.setFromCenterAndSize(t,s)}return e})),this._childBounds=new r,this._innerBounds=new r,this._innerCenter=new t,this._innerSize=new t,this._intrinsicBoundsNeedsUpdate=!0,this._intrinsicBounds=new r,this._intrinsicCenter=new t,this._intrinsicSize=new t,this._cachedNodeChildren=this._cache.memoize((()=>(this.system.bindings.getChildren(this,this._nodeChildren),this._nodeChildren))),this._nodeChildren=new Array,this._computeState=(()=>{const e=new n,i=new s,r=new n,a=new t,o=new s,h=new t,l=new t,c=new t,u=new t,d=new t;return function(t){var s;t.parent=this.raw.parent;const n=this._adapter,p=null==(s=this.referenceMetrics)?void 0:s[t.mode];i.copy((null==n?void 0:n.orientation.enabled)&&(null==n?void 0:n.orientation[t.mode])||this.raw.relativeOrientation);const m=(null==n?void 0:n.bounds.enabled)&&(null==n?void 0:n.bounds[t.mode]);if(m){m.getCenter(l),m.getSize(c);const e=this.innerCenter,s=this.innerSize,n=this.system.epsillonMeters;Math.abs(c.x)<=n&&(c.x=(Math.sign(c.x)||1)*n*10),Math.abs(c.y)<=n&&(c.y=(Math.sign(c.y)||1)*n*10),Math.abs(c.z)<=n&&(c.z=(Math.sign(c.z)||1)*n*10),h.copy(c),Math.abs(s.x)>=n&&(h.x/=s.x),Math.abs(s.y)>=n&&(h.y/=s.y),Math.abs(s.z)>=n&&(h.z/=s.z),o.multiplyQuaternions(t.outerOrientation,i).normalize(),u.copy(l).applyQuaternion(o),d.copy(e).multiply(h).applyQuaternion(o),a.copy(t.outerOrigin).add(u).sub(d),r.compose(a,o,h),t.worldMatrix=r}else e.compose(this.raw.relativePosition,i,this.raw.relativeScale),t.worldMatrix=(null==p?void 0:p.worldMatrix)?r.multiplyMatrices(null==p?void 0:p.worldMatrix,e):e;const g=(null==n?void 0:n.opacity.enabled)&&(null==n?void 0:n.opacity[t.mode]);return t.opacity="number"==typeof g?g:1,t}})(),this.raw={parent:null,worldMatrix:new n,relativeMatrix:new n,opacity:0,worldPosition:new t,worldOrientation:new s,worldScale:new t,relativePosition:new t,relativeOrientation:new s,relativeScale:new t,spatialBounds:new r,worldFromSpatial:new n,localFromSpatial:new n,spatialFromLocal:new n},this.outerOrigin={current:()=>this._getOuterOrigin("current"),target:()=>this._getOuterOrigin("target")},this._cachedCurrentState=this._cache.memoize((()=>this._computeState(this[J]))),this[Y]=new ie("current",this),this._cachedTargetState=this._cache.memoize((()=>this._computeState(this[ee]))),this[Z]=new ie("target",this),this[K]=new ie("target",this),this._cachedBoundsChildren=this._cache.memoize((()=>{const e=this.nodeChildren,t=this._boundingChildren;t.length=0;for(const s of e){const e=this.system.getMetrics(s);e.isAdaptive||t.push(e)}return t})),this._boundingChildren=[]}update(){var e,t;if(this.needsUpdate){this.needsUpdate=!1;const s=this._adapter=this.system.nodeAdapters.get(this.node);this.parentNode=this.raw.parent,this.parentMetrics=this.parentNode&&this.system.getMetrics(this.parentNode);const i=(null==(e=null==s?void 0:s.activeLayout)?void 0:e.referenceNode)||(null==s?void 0:s.referenceNode)||this.parentNode;this.referenceMetrics=i&&this.system.getMetrics(i),null==(t=this.referenceMetrics)||t.update(),s?s._update():(this.invalidateInnerBounds(),this.invalidateStates(),this.updateRawState())}}get innerBounds(){return this._cachedInnerBounds()}get innerCenter(){return this.innerBounds,this._innerCenter}get innerSize(){return this.innerBounds,this._innerSize}get intrinsicBounds(){return this._intrinsicBoundsNeedsUpdate&&(this._intrinsicBoundsNeedsUpdate=!1,this.system.bindings.getIntrinsicBounds(this,this._intrinsicBounds),this._intrinsicBounds.getCenter(this._intrinsicCenter),this._intrinsicBounds.getSize(this._intrinsicSize)),this._intrinsicBounds}get intrinsicCenter(){return this.intrinsicBounds,this._intrinsicCenter}get intrinsicSize(){return this.intrinsicBounds,this._intrinsicSize}invalidateIntrinsicBounds(){this._intrinsicBoundsNeedsUpdate=!0;for(const e of this.boundingChildMetrics)e.invalidateIntrinsicBounds()}invalidateInnerBounds(){if(!this._cachedInnerBounds.needsUpdate){this._cachedNodeChildren.needsUpdate=!0,this._cachedBoundsChildren.needsUpdate=!0,this._cachedInnerBounds.needsUpdate=!0;for(const e of this.boundingChildMetrics)e.invalidateInnerBounds()}}containsNode(e){this.update();let t=this.system.getMetrics(e);for(;t;){if(t.parentMetrics===this)return t.node;t=t.parentMetrics}return!1}containedByNode(e){this.update();let t=this.parentMetrics;for(;t;){if(t.node===e)return t.node;t=t.parentMetrics}return!1}get nodeChildren(){return this._cachedNodeChildren()}invalidateStates(){this._cachedCurrentState.needsUpdate=!0,this._cachedTargetState.needsUpdate=!0,this[J].invalidate(),this[ee].invalidate()}updateRawState(){this.system.bindings.getState(this);const e=this.raw;e.worldMatrix.decompose(e.worldPosition,e.worldOrientation,e.worldScale),e.relativeMatrix.decompose(e.relativePosition,e.relativeOrientation,e.relativeScale),e.worldFromSpatial.compose(this.outerOrigin.target(),e.worldOrientation,U),e.localFromSpatial.copy(e.worldMatrix).invert().multiply(e.worldFromSpatial),e.spatialFromLocal.copy(e.localFromSpatial).invert(),e.spatialBounds.copy(this.innerBounds).applyMatrix4(e.spatialFromLocal)}_getOuterOrigin(e){var t,s,i;const r=this.system.nodeAdapters.get(this.node);return r?r.outerOrigin[e]:null!=(i=null==(s=null==(t=this.referenceMetrics)?void 0:t[e])?void 0:s.worldCenter)?i:I}get current(){return this.update(),this._cachedCurrentState()}get target(){return this.update(),this._cachedTargetState()}get previousTarget(){return this.update(),this[te]}get boundingChildMetrics(){return this._cachedBoundsChildren()}get isAdaptive(){return this.system.nodeAdapters.has(this.node)}}Y=J,Z=ee,K=te;class ne{constructor(e){e&&Object.assign(this,e)}}class ae{constructor(e){this.system=e,this._config=new ne,this._prevOrientation=new s,this._prevBounds=new r,this._scratchSolution=new ve,this._scratchBestSolution=new ve}_setConfig(e){var t,s,i,r,n,a,o,h,l,c;const u=this.system.optimize;this._config.minFeasibleTime=null!=(t=e.minFeasibleTime)?t:u.minFeasibleTime,this._config.maxInfeasibleTime=null!=(s=e.maxInfeasibleTime)?s:u.maxInfeasibleTime,this._config.pulseRate=null!=(i=e.pulseRate)?i:u.pulseRate,this._config.maxIterationsPerFrame=null!=(r=e.maxIterationsPerFrame)?r:u.maxIterationsPerFrame,this._config.swarmSize=null!=(n=e.swarmSize)?n:u.swarmSize,this._config.pulseFrequencyMin=null!=(a=e.pulseFrequencyMin)?a:u.pulseFrequencyMin,this._config.pulseFrequencyMax=null!=(o=e.pulseFrequencyMax)?o:u.pulseFrequencyMax,this._config.stepSizeMax=null!=(h=e.stepSizeMax)?h:u.stepSizeMax,this._config.stepSizeMin=null!=(l=e.stepSizeMin)?l:u.stepSizeMin,this._config.stepSizeStart=null!=(c=e.stepSizeStart)?c:u.stepSizeStart}update(e){if(0===e.layouts.length||e.metrics.innerBounds.isEmpty())return e.activeLayout=null,!1;const t=this._prevOrientation.copy(e.orientation.target),s=this._prevBounds.copy(e.bounds.target);for(const n of e.layouts)this._setConfig(n),this._updateLayout(e,n);let i,r;for(const n of e.layouts){const e=n.solutions[0];if((!r||!r.isFeasible&&e.isFeasible)&&(r=e,i=n,r.isFeasible))break}return e.layoutFeasibleTime+=e.system.deltaTime,e.layoutInfeasibleTime+=e.system.deltaTime,(null==r?void 0:r.isFeasible)||(e.layoutFeasibleTime=0),r&&r.isFeasible&&e.layoutFeasibleTime>=this._config.minFeasibleTime||e.layoutInfeasibleTime>=this._config.maxInfeasibleTime?(e.layoutInfeasibleTime=0,r.apply(!1)):(e.orientation.target=t,e.bounds.target=s,e.metrics.invalidateStates()),e.activeLayout=i,!0}_updateLayout(e,t){var s;e.measureBoundsCache.clear(),t.processObjectives();const i=t.solutions,r=this._config,n=this._scratchSolution,a=this._scratchBestSolution;let o=r.maxIterationsPerFrame;(null==(s=t.solutions[0])?void 0:s.isFeasible)&&(o=1),this._manageSolutionPopulation(e,t,r.swarmSize,r.stepSizeStart),i[0].apply();for(let h=0;h<o;h++){t.iteration++,a.copy(i[0]);let e=!1;for(let s=0;s<i.length;s++){const o=i[s];let h;if(n.copy(o),n.mutationStrategies=o.mutationStrategies,Math.random()<r.pulseRate){const e=a!==o?a:i[1];let s;if(i.length>2)do{s=i[Math.floor(Math.random()*i.length)]}while(s===o);n.moveTowards(e,r.pulseFrequencyMin,r.pulseFrequencyMax),s&&t.compareSolutions(s,o)<=0&&n.moveTowards(s,r.pulseFrequencyMin,r.pulseFrequencyMax)}else h=n.perturb();n.apply();const l=t.compareSolutions(n,o)<0;if(l&&(o.copy(n),o!==i[0]&&t.compareSolutions(o,i[0])<0&&i[0].copy(o),e=!0),h)if(h.stepSize*=l?1.5:.9036020036098449,!l&&h.stepSize<r.stepSizeMin||h.stepSize>r.stepSizeMax){for(const e of o.mutationStrategies)e.stepSize=r.stepSizeStart;o!==i[0]&&(t.restartRate=.001+.999*t.restartRate,o.randomize(1),o.apply(),e=!0)}else o!==i[0]&&(t.restartRate=.999*t.restartRate)}e&&t.sortSolutions(),t.compareSolutions(a,i[0])<=0?t.successRate=.995*t.successRate:t.successRate=.005+.995*t.successRate}}_manageSolutionPopulation(e,t,s,i){if(s<=1)throw new Error("Swarm size must be larger than 1");if(t.solutions.length<s)for(;t.solutions.length<s;){const e=new ve(t);for(const t of e.mutationStrategies)t.stepSize=i;e.randomize(1),t.solutions.push(e)}else if(t.solutions.length>s)for(;t.solutions.length>s;)t.solutions.pop()}}class oe{constructor(e){this.type="ratio",this.sortBlame=0,this.relativeTolerance=void 0,this.absoluteTolerance=void 0,this.computedAbsoluteTolerance=-1/0,this.computedRelativeTolerance=-1/0,this.priority=0,this.index=-1,this.reduceFromOneOrManySpec=(e,t,s)=>{if(void 0===t)return 0;if(t instanceof Array){let i=-1/0;for(const r of t)i=Math.max(s(e,r),i);return i}return s(e,t)},this._getNumberScoreSingle=(e,t)=>{let s=0;if("object"!=typeof t){const i=this.layout.adapter.system.measureNumber(t);s=-Math.abs(e-i)}else{const i="gt"in t?this.layout.adapter.system.measureNumber(t.gt):void 0,r="lt"in t?this.layout.adapter.system.measureNumber(t.lt):void 0;void 0!==i&&e<i?s=e-i:void 0!==r&&e>r&&(s=r-e)}return s},this._getVector3ScoreSingle=(e,t)=>("x"in t&&void 0!==t.x?this.getNumberScore(e.x,t.x):0)+("y"in t&&void 0!==t.y?this.getNumberScore(e.y,t.y):0)+("z"in t&&void 0!==t.z?this.getNumberScore(e.z,t.z):0)+("magnitude"in t&&void 0!==t.magnitude?this.getNumberScore(e.length(),t.magnitude):0),this._quat=new s,this._euler=new a,this._getQuaternionScoreSingle=(e,t)=>{var s,i;if(void 0===t)return 0;if("x"in t){return-this._quat.copy(t).angleTo(e)*o}if("swingRange"in t){const r=this._euler.setFromQuaternion(e),n=r.x*o,a=r.y*o,h=r.z*o,l=this.layout.adapter.system,c=l.mathScope.degree;let u=(null==(s=t.swingRange)?void 0:s.x)?l.measureNumber(t.swingRange.x,c):0,d=(null==(i=t.swingRange)?void 0:i.y)?l.measureNumber(t.swingRange.y,c):0;u=Math.max(u,.01),d=Math.max(d,.01);const p=1-(n/u)**2-(a/d)**2,m=(t.twistRange?l.measureNumber(t.twistRange,c):0)-Math.abs(h);return(p>0?0:p)+(m>0?0:m)}return 0},this._getBoundsMeasureScoreSingle=(e,t,s,i)=>{if(void 0===t)return 0;if("object"==typeof t){if("gt"in t){const r=this.layout.adapter.measureBounds(t.gt,s,i);if(e<r)return e-r}if("lt"in t){const r=this.layout.adapter.measureBounds(t.lt,s,i);if(e>r)return r-e}return 0}return-Math.abs(e-this.layout.adapter.measureBounds(t,s,i))},this.layout=e}static isDiscreteSpec(e){const t=typeof e;return"string"===t||"number"===t}static isContinuousSpec(e){return void 0!==e&&e instanceof Array==!1&&"object"==typeof e&&!0==("gt"in e||"lt"in e)}get bestScore(){return this.layout.solutions[0].scores[this.index]}getNumberScore(e,t){return this.reduceFromOneOrManySpec(e,t,this._getNumberScoreSingle)}getVector3Score(e,t){return this.reduceFromOneOrManySpec(e,t,this._getVector3ScoreSingle)}getQuaternionScore(e,t){return this.reduceFromOneOrManySpec(e,t,this._getQuaternionScoreSingle)}getBoundsScore(e,t){if(void 0===e)return 0;let s=0;for(const i in e){if("absolute"===i)continue;let r=i;if("size"===r||"center"===r){const i=e[r];for(const e of ue){let n=e;if("spatial"!==t){if("meter"===this.type&&"z"!==n)continue;if("pixel"===this.type&&"z"===n)continue}s+=this.getBoundsMeasureScore(null==i?void 0:i[n],t,r+n)}}else{if("spatial"!==t){if("meter"===this.type&&"back"!==r&&"front"!==r)continue;if("pixel"===this.type&&("back"===r||"front"===r))continue}s+=this.getBoundsMeasureScore(e[r],t,r)}}return s}getBoundsMeasureScore(e,t,s){if(void 0===e)return 0;const i=this.layout.adapter.metrics.target;let r,n,a;switch(t){case"spatial":r=i.spatialBounds,n=i.spatialCenter,a=i.spatialSize;break;case"visual":case"view":r=i.visualBounds,n=i.visualCenter,a=i.visualSize;break;default:throw new Error(`Unknown measure type "${t}.${s}" in spec:\n "${e}"`)}let o=0;switch(s){case"left":o=r.min.x;break;case"right":o=r.max.x;break;case"bottom":o=r.min.y;break;case"top":o=r.max.y;break;case"back":o=r.min.z;break;case"front":o=r.max.z;break;case"centerx":o=n.x;break;case"centery":o=n.y;break;case"centerz":o=n.z;break;case"centerdistance":o="spatial"===t?n.length():Math.sqrt(n.x**2+a.y**2);break;case"sizex":o=a.x;break;case"sizey":o=a.y;break;case"sizez":o=a.z;break;case"sizediagonal":o="spatial"===t?a.length():Math.sqrt(a.x**2+a.y**2);break;default:throw new Error(`Unknown measure subtype ${t}.${s} in spec "${e}"`)}if(e instanceof Array){let i=-1/0;for(const r of e)i=Math.max(this._getBoundsMeasureScoreSingle(o,r,t,s),i);return i}return this._getBoundsMeasureScoreSingle(o,e,t,s)}attenuateVisualScore(e){let t=0;const s=this.layout.getComputedAbsoluteTolerance("pixel"),i=this.layout.adapter,r=i.system.viewResolution,n=i.system.viewFrustum,a=r.x,o=r.y,h=r.length(),l=i.metrics.target.visualBounds,c=l.min.x- -a/2+s,u=l.max.x-a/2-s,d=l.min.y- -o/2+s,p=l.max.y-o/2-s,m=l.max.z+n.nearMeters;return c<0&&(t+=Math.abs(c/a)),u>0&&(t+=Math.abs(u/a)),d<0&&(t+=Math.abs(d/o)),p>0&&(t+=Math.abs(p/o)),m>0&&(t+=10*m),e-Math.abs(h)*t}}class he extends oe{constructor(e){super(e),this.type="degree"}evaluate(){const e=this.layout.adapter.metrics.target;return this.getQuaternionScore(e.relativeOrientation,this.spec)}}class le extends oe{constructor(e){super(e),this.type="ratio"}evaluate(){const e=this.layout.adapter.metrics.target;return this.getVector3Score(e.worldScale,this.spec)}}class ce extends oe{constructor(e){super(e),this.mode="xyz",this._scale=new t,this.type="ratio"}evaluate(){const e=this.layout.adapter.metrics.target,t=this.mode;if(!t)return 0;const s=this._scale.copy(e.worldScale),i="xyz"===t?Math.max(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z)):Math.max(Math.abs(s.x),Math.abs(s.y)),r=s.divideScalar(i);return-1/r.x+1+-1/r.y+1+("xyz"===t?-1/r.z+1:r.z>1?1-r.z:0)}}const ue=["x","y","z","diagonal","distance"];class de extends oe{constructor(e){super(e),this.type="meter"}evaluate(){return this.getBoundsScore(this.spec,"spatial")}}class pe extends oe{constructor(e){super(e),this.pixelTolerance=void 0,this.meterTolerance=void 0,this.type="pixel"}evaluate(){var e;return"meter"===this.type&&(this.absoluteTolerance=this.meterTolerance),"pixel"===this.type&&(this.absoluteTolerance=this.pixelTolerance),this.getBoundsScore(this.spec,"visual")+this.getBoundsScore(null==(e=this.spec)?void 0:e.absolute,"view")}}class me extends oe{constructor(e){super(e),this.minAreaPercent=0,this.type="pixel"}evaluate(){var e;const t=this.layout.adapter.metrics.target,s=t.visualSize,i=this.layout.adapter.system.viewResolution,r=Math.min(s.x*s.y,i.x*i.y),n=(null==(e=t.referenceState)?void 0:e.visualSize)||i,a=n.x*n.y;return this.attenuateVisualScore(r)-a*this.minAreaPercent}}class ge extends oe{constructor(e){super(e),this.type="meter",this.absoluteTolerance=1e10}evaluate(){return-this.layout.adapter.metrics.target.visualCenter.length()}}const ye=new t;class _e extends ne{constructor(e){super(),this.adapter=e,this.absoluteTolerance={meter:"10mm",pixel:"4px",degree:"0.002deg",ratio:.002},this.successRate=0,this.restartRate=0,this.objectives=new Array,this.referenceNode=null,this.solutions=new Array,this.iteration=0,this.compareSolutions=(e,t)=>{const s=this.objectives;if(e.scores.length<s.length)return 1;if(t.scores.length<s.length)return-1;if(e.boundsCenterDistance>1e20)return 1;if(t.boundsCenterDistance>1e10)return-1;if(e.boundsManhattanLength>1e20)return 1;if(t.boundsManhattanLength>1e10)return-1;const i=e.isFeasible,r=t.isFeasible;if(i&&!r)return-1;if(r&&!i)return 1;let n=0;const a=this.solutions[0].scores;for(let o=0;o<s.length;o++){const i=e.scores[o],r=t.scores[o];if(isNaN(i))return 1;if(isNaN(r))return-1;const h=s[o],l=h.computedRelativeTolerance,c=h.computedAbsoluteTolerance,u=Math.max(a[o],i,r),d=Math.min(u-Math.abs(u)*l,-c);if(i<d||r<d)return h.sortBlame++,r-i;r-i!=0&&(n=r-i)}return n}}getComputedAbsoluteTolerance(e){return this.adapter.system.measureNumber(this.absoluteTolerance[e],e)}poseRelativeTo(e){return this.referenceNode=e,this}maximize(e){var t;const s=this.maximizeObjective=null!=(t=this.maximizeObjective)?t:new me(this);return s.priority=-1e3,s.relativeTolerance=.1,this.addObjective(s,e)}orientation(e,t){var s;const i=this.orientationConstraint=null!=(s=this.orientationConstraint)?s:new he(this);return i.spec=e,i.priority=-999,this.addObjective(i,t)}keepAspect(e="xyz",t){var s;const i=this.keepAspectConstraint=null!=(s=this.keepAspectConstraint)?s:new ce(this);return i.mode=e,i.priority=-998,this.addObjective(i,t)}scale(e,t){var s;const i=this.scaleConstraint=null!=(s=this.scaleConstraint)?s:new le(this);return i.spec=e,i.priority=-2,this.addObjective(i,t)}bounds(e,t){var s;const i=this.boundsConstraint=null!=(s=this.boundsConstraint)?s:new de(this);return i.spec=e,this.addObjective(i,t)}visualOrientation(e,t){var s;const i=this.orientationConstraint=null!=(s=this.orientationConstraint)?s:new he(this);return i.spec=e,i.priority=-999,this.addObjective(i,t)}visualBounds(e,t){var s,i;const r=this.visualBoundsMeterConstraint=null!=(s=this.visualBoundsMeterConstraint)?s:new pe(this),n=this.visualBoundsPixelConstraint=null!=(i=this.visualBoundsPixelConstraint)?i:new pe(this);return r.spec=e,r.type="meter",n.spec=e,n.type="pixel",this.addObjective(r,t).addObjective(n,t)}magnetize(e){var t;const s=this.magnetizeObjective=null!=(t=this.magnetizeObjective)?t:new ge(this);return s.priority=-900,s.relativeTolerance=.95,this.addObjective(s,e)}avoidOcclusion(e){var t;const s=this.minimizeOcclusionObjective=null!=(t=this.minimizeOcclusionObjective)?t:new ge(this);return s.priority=11,this.addObjective(s,e)}addObjective(e,t){return Object.assign(e,t),-1===this.objectives.indexOf(e)&&this.objectives.push(e),this.processObjectives(),this}get hasValidSolution(){var e;return!0===(null==(e=this.solutions[0])?void 0:e.isFeasible)}processObjectives(){var e,t;const s=this.adapter.system,i=this.objectives;let r=0;for(const n of i)n.index=r++,n.computedAbsoluteTolerance=void 0!==n.absoluteTolerance?s.measureNumber(n.absoluteTolerance,s.mathScope[n.type]):this.getComputedAbsoluteTolerance(n.type),n.computedRelativeTolerance=null!=(t=null!=(e=n.relativeTolerance)?e:this.relativeTolerance)?t:this.adapter.system.optimize.relativeTolerance}sortSolutions(){this.solutions.sort(this.compareSolutions),this.bestSolution=this.solutions[0]}}const fe=class{constructor(e){this.layout=void 0,this.orientation=new s,this.bounds=new r,this.scores=[],this.isFeasible=!1,this.mutationStrategies=[{type:"rotate",stepSize:.1},{type:"center",stepSize:.1},{type:"size",stepSize:.1},{type:"minmax",stepSize:.1}],this._mutationWeights=[],e&&(this.layout=e)}get aspectPenalty(){return this.scores[this.layout.objectives.indexOf(this.layout.keepAspectConstraint)]||0}get orientationPenalty(){return this.scores[this.layout.objectives.indexOf(this.layout.orientationConstraint)]||0}get spatialBoundsPenalty(){return this.scores[this.layout.objectives.indexOf(this.layout.boundsConstraint)]||0}_selectStrategy(){const e=this.mutationStrategies,t=this._mutationWeights,s=this.layout.orientationConstraint,i=this.layout.keepAspectConstraint;for(let r=0;r<e.length;r++)t[r]=e[r].stepSize,s&&"rotate"==e[r].type&&this.orientationPenalty>-s.computedAbsoluteTolerance&&(t[r]*=.01),i&&"size"==e[r].type&&this.aspectPenalty<-i.computedAbsoluteTolerance&&(t[r]*=100);return G(e,t)}copy(e){this.layout=e.layout,this.orientation.copy(e.orientation),this.bounds.copy(e.bounds),this.scores.length=0;for(let t=0;t<e.scores.length;t++)this.scores[t]=e.scores[t];return this.isFeasible=e.isFeasible,this}randomize(e){const t=$(e),s=fe._scratchV1.set(0,0,-t),i=this.layout.adapter.system.viewMetrics.target;s.applyMatrix4(i.worldMatrix);const r=this.layout.adapter.metrics.target.parentState;r&&s.applyMatrix4(r.worldMatrixInverse),this.orientation.copy(i.worldOrientation),r&&this.orientation.multiply(r.worldOrientationInverse);const n=this.layout.adapter.metrics.innerBounds,a=n.isEmpty()?fe._scratchV2.set(1,1,1):n.getSize(fe._scratchV2);return a.normalize(),a.multiplyScalar(2*t*Math.tan(5*h)),this.bounds.setFromCenterAndSize(s,a),this}moveTowards(e,t,s){const i=this.bounds.getCenter(fe._center),r=this.bounds.getSize(fe._size),n=e.bounds,a=n.getCenter(fe._otherCenter),o=n.getSize(fe._otherSize);this.orientation.slerp(e.orientation,fe.generatePulseFrequency(t,s)).normalize(),Math.random()<.5?(i.lerp(a,fe.generatePulseFrequency(t,s)),r.lerp(o,fe.generatePulseFrequency(t,s)),this.bounds.setFromCenterAndSize(i,r)):(this.bounds.min.lerp(n.min,fe.generatePulseFrequency(t,s)),this.bounds.max.lerp(n.max,fe.generatePulseFrequency(t,s)))}perturb(){var e;const t=this._selectStrategy(),s=t.type;let i=t.stepSize;if("rotate"===s||Math.random()<.001){const t=null==(e=this.layout.orientationConstraint)?void 0:e.spec;if((null==t?void 0:t.isQuaternion)&&this.orientationPenalty<t.computedAbsoluteTolerance&&Math.random()<.01)this.orientation.copy(t);else{const e=Math.min($(1e-4*Math.min(i,1)),1);this.orientation.multiply(H(e,e)).normalize()}}const r=this.bounds,n=r.getCenter(fe._center),a=r.getSize(fe._size);if("center"===s){const e=fe._direction.set(0,0,1).applyQuaternion(H(1,1));e.setLength(q(i)).multiplyScalar(a.length()),n.add(e)}if("size"===s){const e=2**q(i);a.multiplyScalar(e)}if(a.clampScalar(this.layout.adapter.system.epsillonMeters/10,1e20),r.setFromCenterAndSize(n,a),"minmax"===s){const e=fe._direction.set(0,0,1).applyQuaternion(H(1,1));e.setLength(q(i)).multiply(a),Math.random(),r.min.add(e)}const o=r.min,h=r.max;return o.x>h.x&&this._swap(o,h,"x"),o.y>h.y&&this._swap(o,h,"y"),o.z>h.z&&this._swap(o,h,"z"),t}_swap(e,t,s){const i=e[s],r=t[s];e[s]=r,t[s]=i}static generatePulseFrequency(e,t){return e+Math.random()*(t-e)}apply(e=!0){const t=this.layout,s=t.adapter;if(s.orientation.target=this.orientation,s.bounds.target=this.bounds,s.metrics.invalidateStates(),e){this.isFeasible=!0;for(let e=0;e<t.objectives.length;e++){const s=t.objectives[e],i=this.scores[e]=s.evaluate();(i<-s.computedAbsoluteTolerance||!isFinite(i))&&(this.isFeasible=!1)}}this.boundsManhattanLength=this.bounds.getSize(ye).manhattanLength(),this.boundsCenterDistance=this.bounds.getCenter(ye).length()}};let ve=fe;ve._scratchV1=new t,ve._scratchV2=new t,ve._direction=new t,ve._center=new t,ve._size=new t,ve._otherCenter=new t,ve._otherSize=new t;const we=c;class be{constructor(e){e&&Object.assign(this,e)}}class xe{constructor(e){e&&Object.assign(this,e)}}const Me=new e,Te=new t,Se=new s,Re=new r,Ee=new l,Ce=new l(0,0,0);class ze extends xe{constructor(e,s,i,r=e.transition){super(i),this.system=e,this.parentConfig=r,this.needsUpdate=!1,this._size=new t,this.queue=[],this.enabled=!1,this.forceWait=!1,this._forceCommit=!1,this._resolvedConfig=new xe,this.delayTime=0,this.debounceTime=0,this._previousStatus="unchanged",this._status="unchanged",this.reset(s),this._previousTarget=this._copy(this._previousTarget,this.target)}_copy(e,t){if(void 0===t)return;if("number"==typeof t)return t;const s=e?e.copy(t):t.clone();if(s&&"isBox3"in s){const e=s,t=e.getSize(this._size);!e.isEmpty()&&isFinite(t.x)&&isFinite(t.y)&&isFinite(t.z)||e.setFromCenterAndSize(I,I)}return s}_isEqual(e,t){return void 0!==e&&void 0!==t&&(e===t||("number"==typeof e?e===t:(null==e?void 0:e.equals(t))||!1))}reset(e){this._start=this._copy(this._start,e),this._current=this._copy(this._current,e),this._target=this._copy(this._target,e),this.queue.length=0}set start(e){this._start=this._copy(this._start,e)}get start(){return this._start}set current(e){this._current=this._copy(this._current,e)}get current(){return this._current}set reference(e){this._reference=this._copy(this._reference,e)}get reference(){return this._reference}set target(e){this.enabled=!0,this._target=this._copy(this._target,e)}get target(){return this._target}get progress(){if(!this.enabled)return 1;if(this.queue.length>0){const e=this.queue[this.queue.length-1];return 0===e.duration?0:e.elapsed/e.duration}return 1}get forceCommit(){return this._forceCommit}set forceCommit(e){this._forceCommit!==e&&(this._forceCommit=e)}get relativeDifference(){var e,t;const s=null!=(t=null==(e=this.queue[this.queue.length-1])?void 0:e.target)?t:this.start;return void 0!==this.target?k(s,this.target):0}get referenceRelativeDifference(){return void 0!==this.reference&&void 0!==this.target?k(this.reference,this.target):1/0}get resolvedConfig(){var e,t,s,i,r,n,a,o,h,l,c,u,d,p,m,g;const y=this._resolvedConfig,_=this.parentConfig,f=this.system.transition;return y.multiplier=null!=(t=null!=(e=this.multiplier)?e:null==_?void 0:_.multiplier)?t:f.multiplier,y.duration=null!=(i=null!=(s=this.duration)?s:null==_?void 0:_.duration)?i:f.duration,y.easing=null!=(n=null!=(r=this.easing)?r:null==_?void 0:_.easing)?n:f.easing,y.threshold=null!=(o=null!=(a=this.threshold)?a:null==_?void 0:_.threshold)?o:f.threshold,y.delay=null!=(l=null!=(h=this.delay)?h:null==_?void 0:_.delay)?l:f.delay,y.debounce=null!=(u=null!=(c=this.debounce)?c:null==_?void 0:_.debounce)?u:f.debounce,y.maxWait=null!=(p=null!=(d=this.maxWait)?d:null==_?void 0:_.maxWait)?p:f.maxWait,y.blend=null!=(g=null!=(m=this.blend)?m:null==_?void 0:_.blend)?g:f.blend,y}get previousStatus(){return this._previousStatus}get status(){return this.needsUpdate&&(this._previousStatus=this._status,this._status=this._computeStatus()),this._status}_computeStatus(){if(this.forceCommit)return"committing";const e=this.resolvedConfig,t=e.threshold,s=this.system.deltaTime*e.multiplier,i=this.delayTime+s,r=this.debounceTime+s;if(!(this.relativeDifference>t))return"unchanged";if(!this.forceWait&&(i>=e.delay&&r>=e.debounce||i>=e.maxWait))return"committing";return this.referenceRelativeDifference<t?"settling":"changed"}_updateTransitionable(){var e,t,s,i,r;const n=this.system.deltaTime,a=this.resolvedConfig,o=this.queue,h=this.status,l=n*a.multiplier;for(;o.length&&o[0].elapsed>=o[0].duration;)this.start=o.shift().target;this.current=this.start;let c=this.start;for(let u=0;u<o.length;u++){const e=o[u];if(this._addTransitionToCurrent(c,e,l),c=e.target,!e.blend)break}switch(this.debounceTime+=l,h){case"settling":break;case"changed":this.delayTime+=l,this.reference=this.target;break;case"unchanged":this.reference=void 0,this.delayTime=0;break;case"committing":this.delayTime=0,this.debounceTime=0;const n="object"==typeof this.forceCommit?this.forceCommit:new be;n.target=null!=(e=n.target)?e:this._copy(void 0,this.target),n.duration=null!=(t=n.duration)?t:a.duration,n.easing=null!=(s=n.easing)?s:a.easing,n.blend=null!=(i=n.blend)?i:a.blend,n.elapsed=null!=(r=n.elapsed)?r:0,o.push(n),this.forceCommit=!1}this.forceWait=!1}_addTransitionToCurrent(e,t,s){const i=this._current,r=t.duration>0?t.easing(Math.min(t.elapsed/t.duration,1)):1,n=t.target;if(t.elapsed+=s,"number"!=typeof n){if("isVector3"in n){const t=i,s=e,a=n,o=Te.copy(a).sub(s).lerp(I,1-r);this._current=t.add(o)}else if("isVector2"in n){const t=i,s=e,a=n,o=Me.copy(a).sub(s).lerp(A,1-r);this._current=t.add(o)}else if("isQuaternion"in n){const t=i,s=e,a=n,o=Se.copy(s).invert().multiply(a).slerp(P,1-r);this._current=t.multiply(o).normalize()}else if("isColor"in n){const t=i,s=e,a=n,o=Ee.copy(a).sub(s).lerp(Ce,1-r);this._current=t.add(o)}else if("isBox3"in n){const t=i,s=e,a=n,o=Re.min.copy(a.min).sub(s.min).lerp(I,1-r),h=Re.max.copy(a.max).sub(s.max).lerp(I,1-r);return t.min.add(o),t.max.add(h),void(this._current=t)}}else this._current=i+u(n-e,0,1-r)}_swap(e,t,s){const i=e[s],r=t[s];e[s]=r,t[s]=i}update(e=!1){if(!this.needsUpdate&&!e)return;if(this._isEqual(this._previousTarget,this.target)||(this._target=this._target,this.enabled=!0),this._previousTarget=this._copy(this._previousTarget,this.target),!this.enabled)return;const t=this.syncGroup;if(!this.forceCommit&&t)for(const s of t)if(s.enabled&&"committing"===s.status){for(const e of t)e.needsUpdate&&!1===e.forceCommit&&e.relativeDifference>e.resolvedConfig.threshold&&(e.forceCommit=!0);break}this._updateTransitionable(),this.needsUpdate=!1}set syncGroup(e){this._syncGroup&&this._syncGroup.delete(this),this._syncGroup=e,null==e||e.add(this)}get syncGroup(){return this._syncGroup}}class Be{constructor(e,t){this.system=e,this.node=t,this.measureBoundsCache=new Map,this.transition=new xe,this.referenceNode=void 0,this._parentAdapter=null,this.layouts=new Array,this.layoutFeasibleTime=0,this.layoutInfeasibleTime=0,this._prevLayout=null,this._activeLayout=null,this._progress=1,this._hasValidContext=!1,this._prevNodeOrientation=new s,this._prevNodeBounds=new r,this.metrics=this.system.getMetrics(this.node);const i=this.metrics.target;this._orientation=new ze(this.system,i.relativeOrientation,void 0,this.transition),this._bounds=new ze(this.system,i.spatialBounds,void 0,this.transition),this._opacity=new ze(this.system,i.opacity,void 0,this.transition),this._outerOrigin=new ze(this.system,i.outerCenter,void 0,this.transition),this._outerOrientation=new ze(this.system,i.outerOrientation,void 0,this.transition),this._outerBounds=new ze(this.system,i.outerBounds,void 0,this.transition),this._outerVisualBounds=new ze(this.system,i.outerVisualBounds,void 0,this.transition),this._outerOrigin.debounce=0,this._outerOrigin.delay=0,this._outerOrientation.debounce=0,this._outerOrientation.delay=0,this._outerBounds.debounce=0,this._outerBounds.delay=0,this._outerVisualBounds.debounce=0,this._outerVisualBounds.delay=0,this._orientation.syncGroup=this._bounds.syncGroup=this._opacity.syncGroup=new Set}measureBounds(e,t,s){var i,r,n;const a=this.system,o=a.mathScope,h=a.math,l="spatial"===t||"front"===s||"back"===s||"centerz"===s||"sizez"===s?o.meter:o.pixel,c=l===o.meter?"m":"px";"number"==typeof e&&(e=""+e+c);const u=t+"-"+s+" = "+e;if(null==(i=this.measureBoundsCache)?void 0:i.has(u))return this.measureBoundsCache.get(u);if(!a.mathCompiledExpressions.has(e)){const t=h.parse(e.replace("%","percent")).compile();a.mathCompiledExpressions.set(e,t)}const d=a.mathCompiledExpressions.get(e),p=a.viewMetrics.target,m=this.metrics.target;let g,y,_;switch(t){case"spatial":g=m.outerBounds,y=m.outerCenter;break;case"visual":g=m.outerVisualBounds,y=m.outerVisualCenter;break;case"view":g=p.visualBounds,y=p.visualCenter;break;default:throw new Error(`Unknown measure type "${t}.${s}"`)}if(e.includes("%")){const e="spatial"===t?m.outerSize:null!=(r=m.outerVisualSize)?r:p.visualSize;let i=0;switch(s){case"left":case"centerx":case"right":case"sizex":i=h.unit(e.x/100,c);break;case"bottom":case"centery":case"top":case"sizey":i=h.unit(e.y/100,c);break;case"back":case"centerz":case"front":case"sizez":i=h.unit(e.z/100,"m");break;case"sizediagonal":i="spatial"===t?h.unit(e.length()/100,"m"):h.unit(Math.sqrt(e.x**2+e.y**2)/100,"px");break;default:throw new Error(`Invalid measure subtype "${t}.${s}" for percentage units`)}o.percent=i}switch(s){case"left":_=g.min.x;break;case"centerx":_=y.x;break;case"right":_=g.max.x;break;case"bottom":_=g.min.y;break;case"centery":_=y.y;break;case"top":_=g.max.y;break;case"front":_=g.max.z;break;case"centerz":_=y.z;break;case"back":_=g.min.z;break;case"centerdistance":default:_=0}let f=d.evaluate(o);return"object"==typeof f&&(f=h.number(f,l)),_+=f,o.percent=void 0,null==(n=this.measureBoundsCache)||n.set(u,_),_}get outerOrigin(){return this._outerOrigin}get outerOrientation(){return this._outerOrientation}get outerBounds(){return this._outerBounds}get outerVisualBounds(){return this._outerVisualBounds}get parentAdapter(){return this._parentAdapter}_computeParentAdapter(){let e=this.metrics;for(;e=e.parentMetrics;){const t=this.system.nodeAdapters.get(e.node);if(t)return t}return null}get orientation(){return this._orientation}get bounds(){return this._bounds}get opacity(){return this._opacity}get previousLayout(){return this._prevLayout}set activeLayout(e){this._prevLayout=this._activeLayout,this._activeLayout=e}get activeLayout(){return this._activeLayout}get progress(){return this._progress}_computeProgress(){return Math.min(this.orientation.progress,this.bounds.progress,this.opacity.progress)}createLayout(){const e=new _e(this);return this.layouts.push(e),e}get hasValidContext(){return this._hasValidContext}_computeHasValidContext(){var e;const t=this.parentAdapter;return!t||!!t.hasValidContext&&(0===t.layouts.length||!!(null==(e=t.activeLayout)?void 0:e.hasValidSolution))}_update(){var e;this._parentAdapter=this._computeParentAdapter(),this._hasValidContext=this._computeHasValidContext();const t=this.metrics;if(t.referenceMetrics&&(this.outerOrigin.target=t.referenceMetrics.target.worldCenter,this.outerOrientation.target=t.referenceMetrics.target.worldOrientation,this.outerBounds.target=t.referenceMetrics.innerBounds,this.outerBounds.target.applyMatrix4(t.target.spatialFromReference),this.outerVisualBounds.target=t.referenceMetrics.target.visualBounds),this.outerOrigin.update(),this.outerOrientation.update(),this.outerBounds.update(),this.outerVisualBounds.update(),this.onUpdate){this.onUpdate(),t.invalidateIntrinsicBounds(),t.invalidateInnerBounds(),t.invalidateStates(),t.updateRawState();const e=t.raw;if(!this.system.optimizer.update(this)){const t=this.orientation.current,s=this.orientation.target,i=e.relativeOrientation;s.angleTo(i)>this.system.epsillonRadians&&t.angleTo(i)>this.system.epsillonRadians&&(this.orientation.target=i);const r=this.bounds.current,n=this.bounds.target,a=e.spatialBounds;(n.min.distanceTo(a.min)>this.system.epsillonMeters||n.max.distanceTo(a.max)>this.system.epsillonMeters)&&(r.min.distanceTo(a.min)>this.system.epsillonMeters||r.max.distanceTo(a.max)>this.system.epsillonMeters)&&(this.bounds.target=a)}}else t.invalidateIntrinsicBounds(),t.invalidateInnerBounds(),t.invalidateStates(),this.system.optimizer.update(this);this.opacity.update(),this.orientation.update(),this.bounds.update(),this._progress=this._computeProgress(),t.invalidateStates(),this.system.bindings.apply(t,t.current),t.invalidateStates(),null==(e=this.onPostUpdate)||e.call(this)}}class Le{constructor(){this._cache=new X,this.isLayoutFrustum=!0,this._leftDegrees=-20,this._rightDegrees=20,this._bottomDegrees=-20,this._topDegrees=20,this._nearMeters=.5,this._farMeters=1e3,this._size=new e,this._center=new e,this._v1=new t,this._inverseProjection=new n,this._forwardDirection=new t(0,0,-1),this._fullNDC=new r(new t(-1,-1,-1),new t(1,1,1)),this._cachedPerspectiveProjectionMatrix=this._cache.memoize((()=>{const e=this.nearMeters,t=this.farMeters,s=e*Math.tan(this.leftDegrees*h),i=e*Math.tan(this.rightDegrees*h),r=e*Math.tan(this.topDegrees*h),n=e*Math.tan(this.bottomDegrees*h);return this._perspective.makePerspective(s,i,r,n,e,t)})),this._perspective=new n,this._boxA=new i,this._boxB=new i,this._overlapSize=new e}get leftDegrees(){return this._leftDegrees}set leftDegrees(e){e!==this._leftDegrees&&(this._leftDegrees=e,this._cache.invalidateAll())}get rightDegrees(){return this._rightDegrees}set rightDegrees(e){e!==this._rightDegrees&&(this._rightDegrees=e,this._cache.invalidateAll())}get bottomDegrees(){return this._bottomDegrees}set bottomDegrees(e){e!==this._bottomDegrees&&(this._bottomDegrees=e,this._cache.invalidateAll())}get topDegrees(){return this._topDegrees}set topDegrees(e){e!==this._topDegrees&&(this._topDegrees=e,this._cache.invalidateAll())}get nearMeters(){return this._nearMeters}set nearMeters(e){e!==this._nearMeters&&(this._nearMeters=e,this._cache.invalidateAll())}get farMeters(){return this._farMeters}set farMeters(e){e!==this._farMeters&&(this._farMeters=e,this._cache.invalidateAll())}get sizeDegrees(){return this._size.set(this.rightDegrees-this.leftDegrees,this.topDegrees-this.bottomDegrees),this._size}get diagonalDegrees(){const e=this.sizeDegrees;return Math.acos(Math.cos(e.x*h)*Math.cos(e.y*h))*o}get centerDegrees(){const e=this.sizeDegrees;return this._center.set(this.leftDegrees+e.x/2,this.bottomDegrees+e.y/2)}get angleToCenter(){const e=this.centerDegrees;return Math.acos(Math.cos(e.x*h)*Math.cos(e.y*h))*o}get angleToTopLeft(){return Math.acos(Math.cos(this.leftDegrees*h)*Math.cos(this.topDegrees*h))*o}get angleToTopRight(){return Math.acos(Math.cos(this.rightDegrees*h)*Math.cos(this.topDegrees*h))*o}get angleToBottomLeft(){return Math.acos(Math.cos(this.leftDegrees*h)*Math.cos(this.bottomDegrees*h))*o}get angleToBottomRight(){return Math.acos(Math.cos(this.rightDegrees*h)*Math.cos(this.bottomDegrees*h))*o}get angleToClosestPoint(){const e=Math.min(Math.max(0,this.leftDegrees),this.rightDegrees),t=Math.min(Math.max(0,this.bottomDegrees),this.topDegrees);return Math.acos(Math.cos(e*h)*Math.cos(t*h))*o}get angleToFarthestPoint(){return Math.max(this.angleToTopLeft,this.angleToTopRight,this.angleToBottomLeft,this.angleToBottomRight)}get depth(){return this.farMeters-this.nearMeters}get distance(){return this.nearMeters+this.depth/2}get aspectRatio(){const e=this.nearMeters,t=e*Math.tan(this.leftDegrees*h),s=e*Math.tan(this.rightDegrees*h);return(e*Math.tan(this.topDegrees*h)-e*Math.tan(this.bottomDegrees*h))/(s-t)}setFromPerspectiveProjectionMatrix(e,t=this._fullNDC){const s=this._inverseProjection.copy(e).invert(),i=this._v1,r=this._forwardDirection,n=Math.sign(t.min.x)*i.set(t.min.x,0,-1).applyMatrix4(s).angleTo(r)*o,a=Math.sign(t.max.x)*i.set(t.max.x,0,-1).applyMatrix4(s).angleTo(r)*o,h=Math.sign(t.max.y)*i.set(0,t.max.y,-1).applyMatrix4(s).angleTo(r)*o,l=Math.sign(t.min.y)*i.set(0,t.min.y,-1).applyMatrix4(s).angleTo(r)*o,c=-i.set(0,0,t.min.z).applyMatrix4(s).z,u=-i.set(0,0,t.max.z).applyMatrix4(s).z;return this.leftDegrees=n,this.rightDegrees=a,this.topDegrees=h,this.bottomDegrees=l,this.nearMeters=c,this.farMeters=u,this}get perspectiveProjectionMatrix(){return this._cachedPerspectiveProjectionMatrix()}overlapPercent(e){this._boxA.min.x=this.leftDegrees,this._boxA.max.x=this.rightDegrees,this._boxA.min.y=this.bottomDegrees,this._boxA.max.y=this.topDegrees,this._boxB.min.x=e.leftDegrees,this._boxB.max.x=e.rightDegrees,this._boxB.min.y=e.bottomDegrees,this._boxB.max.y=e.topDegrees;return this._boxA.intersect(this._boxB).getSize(this._overlapSize).length()/this.sizeDegrees.length()}}class Ae{constructor(t,s){this.viewNode=t,this.bindings=s,this.math=d({evaluateDependencies:p,addDependencies:m,subtractDependencies:g,multiplyDependencies:y,divideDependencies:_,modDependencies:f,numberDependencies:v,createUnitDependencies:w,unitDependencies:b},{predictable:!0}),this.mathCompiledExpressions=new Map,this.mathScope={ratio:void 0,degree:this.math.unit("degree"),meter:this.math.unit("meter"),pixel:this.math.createUnit("pixel",{aliases:["pixels","px"]}),percent:void 0,vdeg:void 0,vw:void 0,vh:void 0},this.epsillonMeters=1e-10,this.epsillonRadians=1e-10,this.epsillonRatio=1e-10,this.transition=new xe({multiplier:1,duration:0,easing:we.easeInOut,threshold:0,delay:0,debounce:0,maxWait:10,blend:!0}),this.optimize=new ne({minFeasibleTime:.02,maxInfeasibleTime:5,relativeTolerance:.001,maxIterationsPerFrame:10,swarmSize:10,pulseFrequencyMin:0,pulseFrequencyMax:1,pulseRate:.4,stepSizeMin:1e-4,stepSizeMax:4,stepSizeStart:1.5}),this.optimizer=new ae(this),this.viewFrustum=new Le,this.viewResolution=new e(1e3,1e3),this.deltaTime=1/60,this.time=0,this.maxDeltaTime=1/60,this.nodeMetrics=new Map,this.nodeAdapters=new Map,this.transitionables=[],this.getMetrics=e=>{if(!e)throw new Error("node must be defined");let t=this.nodeMetrics.get(e);return t||(t=new re(this,e),this.nodeMetrics.set(e,t)),t},this.getState=e=>{if(!e)throw new Error("node must be defined");return this.getMetrics(e).target},this.getAdapter=e=>{let t=this.nodeAdapters.get(e);return t||(t=new Be(this,e),this.nodeAdapters.set(e,t)),t},this.createTransitionable=(e,t)=>{const s=new ze(this,e,t,this.transition);return this.transitionables.push(s),s},this._prevResolution=new e,this._prevSize=new e,this.measureNumberCache={}}get viewMetrics(){if(!this.viewNode)throw new Error("EtherealSystem.viewNode must be defined");return this.getMetrics(this.viewNode)}update(e,t){this.deltaTime=Math.max(e,this.maxDeltaTime),this.time=t,this._prevResolution.equals(this.viewResolution)&&this._prevSize.equals(this.viewFrustum.sizeDegrees)||(this.mathScope.vdeg=this.math.unit(this.viewResolution.y/this.viewFrustum.sizeDegrees.y,"px"),this.mathScope.vw=this.math.unit(this.viewResolution.x/100,"px"),this.mathScope.vh=this.math.unit(this.viewResolution.y/100,"px"),this.measureNumberCache={}),this._prevResolution.copy(this.viewResolution),this._prevSize.copy(this.viewFrustum.sizeDegrees);for(const s of this.nodeMetrics.values()){s.needsUpdate=!0;const e=this.nodeAdapters.get(s.node);e&&(e.opacity.needsUpdate=!0,e.orientation.needsUpdate=!0,e.bounds.needsUpdate=!0,e.outerOrigin.needsUpdate=!0,e.outerOrientation.needsUpdate=!0,e.outerBounds.needsUpdate=!0,e.outerVisualBounds.needsUpdate=!0)}for(const s of this.transitionables)s.needsUpdate=!0;for(const s of this.transitionables)s.update();this.viewMetrics.update();for(const s of this.nodeAdapters.values())s.metrics.update()}measureNumber(e,t){if("number"==typeof e)return e;if(e in this.measureNumberCache)return this.measureNumberCache[e];if(!this.mathCompiledExpressions.has(e)){const t=this.math.parse(e).compile();this.mathCompiledExpressions.set(e,t)}const s=this.mathCompiledExpressions.get(e),i=s.evaluate(this.mathScope),r="number"==typeof i?i:this.math.number(s.evaluate(this.mathScope),t);return this.measureNumberCache[e]=r,r}}const Oe=new t;class Ie{constructor(e=0,t=0,s=0){this.horizontalRadians=e,this.verticalRadians=t,this.distance=s}get horizontalDegrees(){return this.horizontalRadians*o}set horizontalDegrees(e){this.horizontalRadians=e*h}get verticalDegrees(){return this.verticalRadians*o}set verticalDegrees(e){this.verticalRadians=e*h}setWithRadians(e,t,s){return this.horizontalRadians=e,this.verticalRadians=t,this.distance=s,this}setWithDegrees(e,t,s){return this.horizontalDegrees=e,this.verticalDegrees=t,this.distance=s,this}fromCartesianDirection(e){const t=Oe.copy(e).normalize();return this.verticalRadians=Math.asin(t.y)*o,this.horizontalRadians=Math.atan2(t.x,-t.z)*o,this.distance=0,this}fromCartesianPosition(e){return this.fromCartesianDirection(e),this.distance=e.length(),this}toCartesianDirection(e){const t=this.verticalRadians,s=-Math.PI-this.horizontalRadians,i=Math.sin(t),r=Math.cos(t)*Math.sin(s),n=-Math.cos(t)*Math.cos(s);return e.set(r,i,n).normalize()}toCartesianPosition(e){return this.toCartesianDirection(e).multiplyScalar(this.distance)}}function Ne(e,t,s,i=0){var r;i++;for(let n=(e=e.shadowRoot||e).firstElementChild;n;n=n.nextElementSibling){if(n.assignedSlot)continue;const e=null==(r=n.assignedElements)?void 0:r.call(n,{flatten:!0});if(e)for(const r of e)t.call(s,r,i)&&Ne(n,t,s,i);t.call(s,n,i)&&Ne(n,t,s,i)}}class De{constructor(){this.left=0,this.top=0,this.width=0,this.height=0}copy(e){return this.top=e.top,this.left=e.left,this.width=e.width,this.height=e.height,this}}class Fe{constructor(){this.left=0,this.top=0,this.right=0,this.bottom=0}copy(e){return this.top=e.top,this.left=e.left,this.right=e.right,this.bottom=e.bottom,this}}function Ue(e,t=new De,s){const i=e.ownerDocument,r=i.documentElement,n=i.body;if(e===r)return function(e,t){const s=e.documentElement,i=e.body,r=getComputedStyle(s),n=getComputedStyle(i);return t.top=i.offsetTop+parseFloat(r.marginTop)||0+parseFloat(n.marginTop)||0,t.left=i.offsetLeft+parseFloat(r.marginLeft)||0+parseFloat(n.marginLeft)||0,t.width=Math.max(Math.max(i.scrollWidth,s.scrollWidth),Math.max(i.offsetWidth,s.offsetWidth),Math.max(i.clientWidth,s.clientWidth)),t.height=Math.max(Math.max(i.scrollHeight,s.scrollHeight),Math.max(i.offsetHeight,s.offsetHeight),Math.max(i.clientHeight,s.clientHeight)),t}(i,t);if(s===e)return t.left=0,t.top=0,t.width=e.offsetWidth,void(t.height=e.offsetHeight);const a=e.ownerDocument.defaultView;let o,h=e,l=h.offsetParent,c=a.getComputedStyle(h,null),u=h.offsetTop,d=h.offsetLeft;for(l&&s&&l.contains(s)&&l!==s&&(Ue(s,t,l),d-=t.left,u-=t.top);(h=h.parentElement)&&h!==n&&h!==r&&h!==s&&"fixed"!==c.position;)o=a.getComputedStyle(h,null),u-=h.scrollTop,d-=h.scrollLeft,h===l&&(u+=h.offsetTop,d+=h.offsetLeft,u+=parseFloat(o.borderTopWidth)||0,d+=parseFloat(o.borderLeftWidth)||0,l=h.offsetParent),c=o;return"fixed"===c.position&&(u+=Math.max(r.scrollTop,n.scrollTop),d+=Math.max(r.scrollLeft,n.scrollLeft)),t.left=d,t.top=u,t.width=e.offsetWidth,t.height=e.offsetHeight,t}function Pe(e,t){if(null===e.offsetParent)return void(t.left=t.right=t.top=t.bottom=0);let s=getComputedStyle(e);t.left=parseFloat(s.marginLeft)||0,t.right=parseFloat(s.marginRight)||0,t.top=parseFloat(s.marginTop)||0,t.bottom=parseFloat(s.marginBottom)||0}const Ve=document.createElement("div");function ke(e){const t=document.createElement("div");t.innerHTML=e;const s=t.firstElementChild;return t.removeChild(s),s}function je(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function We(e,t){return" "+e+'="'+je(t)+'"'}async function qe(e,t){let s=[];for(const i of e.childNodes)s.push($e(i,t));return Promise.all(s).then((e=>e.join("")))}async function $e(e,t){var s;const i=null==(s=t.replacer)?void 0:s.call(t,e);if("string"==typeof i)return i;if("#document"===e.nodeName||"#document-fragment"===e.nodeName)return qe(e,t);if(e.tagName)return async function(e,t){const s=e.tagName.toLowerCase();let i="<"+s;i+=function(e,t){return e.hasAttribute("xmlns")||!t&&e.namespaceURI===e.parentElement.namespaceURI?"":' xmlns="'+e.namespaceURI+'"'}(e,0===t.depth);const r=qe(e,t);for(const n of e.attributes)"src"===n.name?i+=We(n.name,await Je.getDataURL(n.value)):i+=We(n.name,n.value);return e.childNodes.length>0?(t.depth++,i+=">",i+=await r,i+="</"+s+">",t.depth--):i+="/>",i}(e,t);if("#text"===e.nodeName)return function(e){return(e.nodeValue||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}(e);if("#comment"===e.nodeName);else if("#cdata-section"===e.nodeName)return function(e){return"<![CDATA["+e.nodeValue+"]]>"}(e);return""}Ve.id="VIEWPORT",Ve.style.position="fixed",Ve.style.width="100vw",Ve.style.height="100vh",Ve.style.visibility="hidden",Ve.style.pointerEvents="none";const He=new TextEncoder,Ge=class{constructor(e,t){this.element=e,this.eventCallback=t,this.needsRefresh=!0,this.needsRemoval=!1,this.pseudoStates={hover:!1,active:!1,focus:!1,target:!1},this.svgImage=new Image,this.bounds=new De,this.padding=new Fe,this.margin=new Fe,this.border=new Fe,this.childLayers=[],this.rasterizationCount=new Map,this.cachedBounds=new Map,this.cachedMargin=new Map,this._dynamicAttributes="",this._svgHash="",this._svgDocument="",this._svgHashRasterizing="",this._svgSrc="",this._hashingCanvas=document.createElement("canvas"),this.serializationReplacer=e=>{var t;if(this.element===e)return;const s=e,i=null==(t=s.tagName)?void 0:t.toLowerCase();if("style"===i||"link"===i)return"";const r=Je.layers.get(s);if(r){const e=r.bounds;let t="";const i=`box-sizing:border-box;max-width:${e.width+1}px;max-height:${e.height+1}px;min-width:${e.width}px;min-height:${e.height}px;visibility:hidden`;let n=!1;for(const s of r.element.attributes)"src"!==s.name&&("style"==s.name?(t+=We(s.name,s.value+";"+i),n=!0):t+=We(s.name,s.value));n||(t+=We("style",i));const a=s.tagName.toLowerCase();return`<${a} ${t}></${a}>`}},Je.layers.set(e,this),this.id=e.getAttribute(Je.ELEMENT_UID_ATTRIBUTE)||Je.generateElementUID(),e.setAttribute(Je.ELEMENT_UID_ATTRIBUTE,this.id),e.setAttribute(Je.LAYER_ATTRIBUTE,""),this.parentLayer=Je.getClosestLayer(this.element,!1),this.eventCallback("layercreated",{target:e}),Ge.cachedCanvases.limit=Je.layers.size*Ge.DEFAULT_CACHE_SIZE,this._hashingCanvas.width=20,this._hashingCanvas.height=20}trySetFromSVGHash(e){const t=this.cachedBounds.get(e),s=this.cachedMargin.get(e);if(e==this._currentSVGHash)return t&&s&&(this._currentBounds=t,this._currentMargin=s),!0;{const i=Ge.svgCanvasHash.get(this._currentSVGHash),r=Ge.svgCanvasHash.get(e),n=Ge.cachedCanvases.get(r);if(n&&t&&s)return this._currentSVGHash=e,this._currentCanvas=n,this._currentBounds=t,this._currentMargin=s,i!==r&&this.eventCallback&&this.eventCallback("layerpainted",{target:this.element}),!0}return!1}get currentCanvas(){return this._currentCanvas}get currentBounds(){return this._currentBounds}get currentMargin(){return this._currentMargin}get depth(){let e=0,t=this;for(;t.parentLayer;)t=t.parentLayer,e++;return e}get rootLayer(){let e=this;for(;e.parentLayer;)e=e.parentLayer;return e}traverseParentLayers(e){const t=this.parentLayer;t&&(t.traverseParentLayers(e),e(t))}traverseLayers(e){e(this),this.traverseChildLayers(e)}traverseChildLayers(e){for(const t of this.childLayers)t.traverseLayers(e)}refresh(){this._currentSVGHash||(Ue(this.element,this.bounds,this.parentLayer&&this.parentLayer.element),Pe(this.element,this.margin),this._currentBounds=this.bounds,this._currentMargin=this.margin),this.needsRefresh=!1,this._updateParentAndChildLayers(),Je.addToSerializeQueue(this)}_updateParentAndChildLayers(){const e=this.element,t=this.childLayers,s=t.slice(),i=this.parentLayer;this.parentLayer=Je.getClosestLayer(this.element,!1),i!==this.parentLayer&&(this.parentLayer&&this.parentLayer.childLayers.push(this),this.eventCallback("layermoved",{target:e})),t.length=0,Ne(e,this._tryConvertElementToWebLayer,this);for(const r of s){Je.getClosestLayer(r.element,!1)||(r.needsRemoval=!0,t.push(r))}}_tryConvertElementToWebLayer(e){if(this.needsRemoval)return!1;const t=e,s=getComputedStyle(t);t.getAttribute(Je.ELEMENT_UID_ATTRIBUTE)||t.setAttribute(Je.ELEMENT_UID_ATTRIBUTE,Je.generateElementUID());if(t.hasAttribute(Je.LAYER_ATTRIBUTE)||"VIDEO"===t.nodeName||"none"!==s.transform){let e=Je.layers.get(t);return e||(e=new Ge(t,this.eventCallback)),this.childLayers.push(e),!1}return!0}async serialize(){var e;const t=this.element;if("VIDEO"===t.nodeName)return;Ue(t,this.bounds,null==(e=this.parentLayer)?void 0:e.element),Pe(t,this.margin);let{width:s,height:i}=this.bounds;if(s+=Math.max(this.margin.left,0)+Math.max(this.margin.right,0),i+=Math.max(this.margin.top,0)+Math.max(this.margin.bottom,0),s*i>0){!function(e,t){let s=getComputedStyle(e);t.left=parseFloat(s.paddingLeft)||0,t.right=parseFloat(s.paddingRight)||0,t.top=parseFloat(s.paddingTop)||0,t.bottom=parseFloat(s.paddingBottom)||0}(t,this.padding),function(e,t){let s=getComputedStyle(e);t.left=parseFloat(s.borderLeftWidth)||0,t.right=parseFloat(s.borderRightWidth)||0,t.top=parseFloat(s.borderTopWidth)||0,t.bottom=parseFloat(s.borderBottomWidth)||0}(t,this.border);const e=Je.attributeHTML(Je.ELEMENT_UID_ATTRIBUTE,""+this.id),r="inline"===getComputedStyle(t).display;Je.updateInputAttributes(t);const n=this._getParentsHTML(t);n[0]=n[0].replace("html","html "+Je.RENDERING_DOCUMENT_ATTRIBUTE+'="" ');const a=await Je.getAllEmbeddedStyles(t);let o=await async function(e,t){return(await $e(e,{depth:0,replacer:t})).replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g,"")}(t,this.serializationReplacer);o=o.replace(e,`${e} ${Je.RENDERING_ATTRIBUTE}="" ${r?`${Je.RENDERING_INLINE_ATTRIBUTE}="" `:" "} `+Je.getPsuedoAttributes(this.pseudoStates));const h='<svg width="'+s+'" height="'+i+'" xmlns="http://www.w3.org/2000/svg"><defs><style type="text/css"><![CDATA[\n'+a.join("\n")+']]></style></defs><foreignObject x="0" y="0" width="'+(s+1)+'" height="'+(i+1)+'">'+n[0]+o+n[1]+"</foreignObject></svg>",l=this._svgDocument=h,c=this._svgHash=Je.arrayBufferToBase64(M.exports.hash(He.encode(l)))+"?w="+s+";h="+i;if(this.cachedBounds.set(c,(new De).copy(this.bounds)),this.cachedMargin.set(c,(new Fe).copy(this.margin)),this.trySetFromSVGHash(c))return;Je.addToRasterizeQueue(this)}else this._currentBounds.copy(this.bounds),this._currentMargin.copy(this.margin)}async rasterize(){return new Promise(((e,t)=>{const s=()=>{Je.addToRenderQueue(this),this.svgImage.onload=null,e()};this.svgImage.onload=()=>{setTimeout(s,10)},this.svgImage.onerror=e=>{t(e)},this._svgHashRasterizing=this._svgHash,this.svgImage.src=this._svgSrc="data:image/svg+xml;utf8,"+encodeURIComponent(this._svgDocument)}))}render(){if(!this.svgImage.complete||this.svgImage.currentSrc!==this.svgImage.src)return void setTimeout((()=>Je.addToRenderQueue(this)),100);const e=this._svgHashRasterizing;if(!this.cachedBounds.has(e)||!this.cachedMargin.has(e))return void(this.needsRefresh=!0);let{width:t,height:s}=this.cachedBounds.get(e),{left:i,top:r,right:n,bottom:a}=this.cachedMargin.get(e);const o=t+i+n,h=s+r+a,l=this._hashingCanvas;let c=l.width,u=l.height;const d=l.getContext("2d");d.clearRect(0,0,c,u),d.imageSmoothingEnabled=!1,d.drawImage(this.svgImage,0,0,o,h,0,0,c,u);const p=d.getImageData(0,0,c,u).data,m=Je.arrayBufferToBase64(M.exports.hash(new Uint8Array(p))),g=Ge.svgCanvasHash.get(e);Ge.svgCanvasHash.set(e,m),g!==m&&Ge.svgRetryCount.set(e,0);const y=Ge.svgRetryCount.get(e)||0;if(Ge.svgRetryCount.set(e,y+1),y>3&&Ge.cachedCanvases.has(m))return void(this._svgHash===this._svgHashRasterizing&&this.trySetFromSVGHash(this._svgHash));if(setTimeout((()=>Je.addToRenderQueue(this)),2*(500+1e3*Math.random())^y),g===m&&Ge.cachedCanvases.has(g))return;const _=this.pixelRatio||parseFloat(this.element.getAttribute(Je.PIXEL_RATIO_ATTRIBUTE))||window.devicePixelRatio,f=Ge.cachedCanvases.size===Ge.cachedCanvases.limit?Ge.cachedCanvases.shift()[1]:document.createElement("canvas");let v=f.width=o*_,w=f.height=h*_;const b=f.getContext("2d");b.imageSmoothingEnabled=!1,b.clearRect(0,0,v,w),b.drawImage(this.svgImage,0,0,o,h,0,0,v,w),Ge.cachedCanvases.set(m,f),this._svgHash===this._svgHashRasterizing&&this.trySetFromSVGHash(e)}_getParentsHTML(e){const t=[],s=[];let i=e.parentElement;i||(i=document.documentElement);do{let e=i.tagName.toLowerCase(),r=" ",n="";for(const t of i.attributes){const e=je(t.value);"style"!==t.name?r+=`${t.name}="${e}" `:n=e}const a="<"+e+("html"===e?` xmlns="http://www.w3.org/1999/xhtml" style="--x-width:${this.bounds.width}px;--x-height:${this.bounds.height}px;--x-inline-top:${this.border.top+this.margin.top+this.padding.top}px; ${n}" `:` style="${n}" `)+r+`${Je.RENDERING_PARENT_ATTRIBUTE}=""  >`;t.unshift(a);const o="</"+e+">";if(s.push(o),"html"==e)break}while(i=i!==document.documentElement?i.parentElement||document.documentElement:null);return[t.join(""),s.join("")]}};let Qe=Ge;Qe.DEFAULT_CACHE_SIZE=4,Qe.svgRetryCount=new Map,Qe.svgCanvasHash=new x.LRUMap(1e3),Qe.cachedCanvases=new x.LRUMap(Ge.DEFAULT_CACHE_SIZE);const Xe=self.ResizeObserver||T;const Ye=new n,Ze=new n;new TextDecoder,Promise.resolve();const Ke=class{static get ELEMENT_UID_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-uid"}static get HOVER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-hover"}static get ACTIVE_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-active"}static get FOCUS_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-focus"}static get TARGET_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-target"}static get LAYER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-layer"}static get PIXEL_RATIO_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-pixel-ratio"}static get RENDERING_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering"}static get RENDERING_PARENT_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-parent"}static get RENDERING_CONTAINER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-container"}static get RENDERING_INLINE_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-inline"}static get RENDERING_DOCUMENT_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-document"}static generateElementUID(){return""+this._nextUID++}static getPsuedoAttributes(e){return`${e.hover?`${this.HOVER_ATTRIBUTE}="" `:" "}${e.focus?`${this.FOCUS_ATTRIBUTE}="" `:" "}${e.active?`${this.ACTIVE_ATTRIBUTE}="" `:" "}${e.target?`${this.TARGET_ATTRIBUTE}="" `:" "}`}static initRootNodeObservation(e){const t=e.ownerDocument,s=e.getRootNode(),i="head"in s?s.head:s;if(this.rootNodeObservers.get(s))return;const r=this.containerStyleElement=t.createElement("style");t.head.appendChild(r),r.innerHTML=`\n      [${Ke.RENDERING_CONTAINER_ATTRIBUTE}] {\n        all: initial;\n        position: fixed;\n        width: 100%;\n        height: 100%;\n        top: 0px;\n      }\n    `;const n=`\n    [${Ke.RENDERING_DOCUMENT_ATTRIBUTE}] * {\n      transform: none !important;'\n    }\n    \n    [${Ke.RENDERING_DOCUMENT_ATTRIBUTE}] * {\n      transform: none !important;\n    }\n\n    [${Ke.RENDERING_ATTRIBUTE}], [${Ke.RENDERING_ATTRIBUTE}] * {\n      visibility: visible !important;\n    }\n    \n    [${Ke.RENDERING_ATTRIBUTE}] [${Ke.LAYER_ATTRIBUTE}], [${Ke.RENDERING_ATTRIBUTE}] [${Ke.LAYER_ATTRIBUTE}] * {\n      visibility: hidden !important;\n    }\n\n    [${Ke.RENDERING_ATTRIBUTE}] {\n      position: relative;\n      top: 0 !important;\n      left: 0 !important;\n      float: none;\n      box-sizing:border-box;\n      min-width:var(--x-width);\n      min-height:var(--x-height);\n      display:block !important;\n    }\n    \n    [${Ke.RENDERING_INLINE_ATTRIBUTE}] {\n      top: var(--x-inline-top) !important;\n      width:auto !important;\n    }\n\n    [${Ke.RENDERING_PARENT_ATTRIBUTE}] {\n      transform: none !important;\n      left: 0 !important;\n      top: 0 !important;\n      margin: 0 !important;\n      border:0 !important;\n      border-radius:0 !important;\n      width: 100% !important;\n      height:100% !important;\n      padding:0 !important;\n      background: rgba(0,0,0,0) none !important;\n      box-shadow:none !important';\n    }\n    \n    [${Ke.RENDERING_PARENT_ATTRIBUTE}]::before, [${Ke.RENDERING_PARENT_ATTRIBUTE}]::after {\n      content:none !important;\n      box-shadow:none !important;\n    }\n    `,a=t.createElement("style");if(a.textContent=n,i.append(a),s===t){let e="";const t=()=>{if(e!=window.location.hash&&window.location.hash)try{this.targetElement=s.querySelector(window.location.hash)}catch{}e=window.location.hash};window.addEventListener("hashchange",t,!1),t(),window.addEventListener("focusin",(e=>{this.focusElement=e.target}),!1),window.addEventListener("focusout",(e=>{this.focusElement=null}),!1),window.addEventListener("load",(e=>{o()}))}const o=()=>{for(const[e,t]of this.layers)t.needsRefresh=!0},h=e=>{var t=e.nodeName.toUpperCase();-1!==l.indexOf(t)&&e.addEventListener("load",o)},l=["STYLE","LINK"],c=new MutationObserver((e=>{for(const t of e){-1!==l.indexOf(t.target.nodeName.toUpperCase())&&o();for(const e of t.addedNodes)h(e)}}));c.observe(t,{childList:!0,attributes:!0,characterData:!0,subtree:!0,attributeOldValue:!0,characterDataOldValue:!0}),this.rootNodeObservers.set(s,c)}static addToSerializeQueue(e){-1===this.serializeQueue.indexOf(e)&&this.serializeQueue.push(e)}static addToRasterizeQueue(e){-1===this.rasterizeQueue.indexOf(e)&&this.rasterizeQueue.push(e)}static addToRenderQueue(e){-1===this.renderQueue.indexOf(e)&&this.renderQueue.push(e)}static _runTasks(){Ke.tasksPending=!1;const e=Ke.serializeQueue,t=Ke.rasterizeQueue,s=Ke.renderQueue,i=Ke.TASK_SYNC_MAX_TIME/2;let r=performance.now();for(;s.length&&performance.now()-r<i;)s.shift().render();for(r=performance.now();e.length&&performance.now()-r<i;)e.shift().serialize();t.length&&Ke.rasterizeTaskCount<Ke.TASK_ASYNC_MAX_COUNT&&(Ke.rasterizeTaskCount++,t.shift().rasterize().finally((()=>{Ke.rasterizeTaskCount--})))}static scheduleTasksIfNeeded(){this.tasksPending||0===Ke.serializeQueue.length&&0===Ke.renderQueue.length&&(0===Ke.rasterizeQueue.length||Ke.rasterizeTaskCount===Ke.TASK_ASYNC_MAX_COUNT)||(this.tasksPending=!0,Ke.scheduleIdle(Ke._runTasks))}static scheduleIdle(e){setTimeout(e,1)}static setLayerNeedsRefresh(e){e.needsRefresh=!0}static createLayerTree(e,t,s){if(Ke.getClosestLayer(e))throw new Error("A root WebLayer for the given element already exists");!function(e,t){if(document.contains(e))return e;const s=document.createElement("div");s.setAttribute(Je.RENDERING_CONTAINER_ATTRIBUTE,""),s.style.visibility="hidden",s.style.pointerEvents="none",s.style.touchAction="none",s.attachShadow({mode:"open"}).appendChild(e),document.documentElement.appendChild(s)}(e),Ke.initRootNodeObservation(e);const i=new MutationObserver(Ke._handleMutations);this.mutationObservers.set(e,i),this.startMutationObserver(e);const r=new Xe((e=>{for(const t of e){const e=this.getClosestLayer(t.target);e.traverseLayers(Ke.setLayerNeedsRefresh),e.traverseParentLayers(Ke.setLayerNeedsRefresh)}}));r.observe(e),this.resizeObservers.set(e,r),e.addEventListener("input",this._triggerRefresh,{capture:!0}),e.addEventListener("keydown",this._triggerRefresh,{capture:!0}),e.addEventListener("submit",this._triggerRefresh,{capture:!0}),e.addEventListener("change",this._triggerRefresh,{capture:!0}),e.addEventListener("focus",this._triggerRefresh,{capture:!0}),e.addEventListener("blur",this._triggerRefresh,{capture:!0}),e.addEventListener("transitionend",this._triggerRefresh,{capture:!0});const n=new Qe(e,s);return this.rootLayers.set(e,n),n}static disposeLayer(e){if(this.rootLayers.has(e.element)){this.rootLayers.delete(e.element);this.mutationObservers.get(e.element).disconnect(),this.mutationObservers.delete(e.element);this.resizeObservers.get(e.element).disconnect(),this.resizeObservers.delete(e.element),e.element.removeEventListener("input",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("keydown",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("submit",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("change",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("focus",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("blur",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("transitionend",this._triggerRefresh,{capture:!0})}}static getClosestLayer(e,t=!0){let s=t?e:e.parentElement;const i=null==s?void 0:s.closest(`[${Ke.LAYER_ATTRIBUTE}]`);if(!i){const s=(null==e?void 0:e.getRootNode()).host;if(s)return this.getClosestLayer(s,t)}return this.layers.get(i)}static parseCSSTransform(e,t,s,i,r=new n){const a=e.transform,o=e.transformOrigin;if(0==a.indexOf("matrix(")){r.identity();var h=a.substring(7,a.length-1).split(", ").map(parseFloat);r.elements[0]=h[0],r.elements[1]=h[1],r.elements[4]=h[2],r.elements[5]=h[3],r.elements[12]=h[4],r.elements[13]=h[5]}else{if(0!=a.indexOf("matrix3d("))return null;h=a.substring(9,a.length-1).split(", ").map(parseFloat);r.fromArray(h)}0===r.elements[0]&&(r.elements[0]=1e-15),0===r.elements[5]&&(r.elements[5]=1e-15),0===r.elements[10]&&(r.elements[10]=1e-15),r.elements[12]*=i,r.elements[13]*=-1*i;var l=o.split(" ").map(parseFloat),c=(l[0]-t/2)*i,u=(l[1]-s/2)*i*-1,d=l[2]||0,p=Ye.identity().makeTranslation(-c,-u,-d),m=Ze.identity().makeTranslation(c,u,d);for(const n of r.elements)if(isNaN(n))return null;return r.premultiply(m).multiply(p)}static pauseMutationObservers(){const e=Ke.mutationObservers.values();for(const t of e)Ke._handleMutations(t.takeRecords()),t.disconnect()}static resumeMutationObservers(){for(const[e]of Ke.mutationObservers)this.startMutationObserver(e)}static startMutationObserver(e){Ke.mutationObservers.get(e).observe(e,{attributes:!0,childList:!0,subtree:!0,characterData:!0,characterDataOldValue:!0,attributeOldValue:!0})}static _addDynamicPseudoClassRules(e){const t=e.styleSheets;for(let n=0;n<t.length;n++)try{const e=t[n],r=e.cssRules;if(!r)continue;const a=[];for(var s=0;s<r.length;s++){r[s].cssText.indexOf(":hover")>-1&&a.push(r[s].cssText.replace(new RegExp(":hover","g"),`[${Ke.HOVER_ATTRIBUTE}]`)),r[s].cssText.indexOf(":active")>-1&&a.push(r[s].cssText.replace(new RegExp(":active","g"),`[${Ke.ACTIVE_ATTRIBUTE}]`)),r[s].cssText.indexOf(":focus")>-1&&a.push(r[s].cssText.replace(new RegExp(":focus","g"),`[${Ke.FOCUS_ATTRIBUTE}]`)),r[s].cssText.indexOf(":target")>-1&&a.push(r[s].cssText.replace(new RegExp(":target","g"),`[${Ke.TARGET_ATTRIBUTE}]`));var i=a.indexOf(r[s].cssText);i>-1&&a.splice(i,1)}for(s=0;s<a.length;s++)e.insertRule(a[s])}catch(r){}}static arrayBufferToBase64(e){for(var t="",s=e.byteLength,i=0;i<s;i++)t+=String.fromCharCode(e[i]);return window.btoa(t)}static attributeCSS(e,t){return t?`[${e}]=${t}`:`[${e}]`}static attributeHTML(e,t){return t?`${e}="${t}"`:`${e}=""`}static async generateEmbeddedCSS(e,t){let s;const i=[];t=(t=(t=(t=t.replace(new RegExp(":hover","g"),this.attributeCSS(this.HOVER_ATTRIBUTE))).replace(new RegExp(":active","g"),this.attributeCSS(this.ACTIVE_ATTRIBUTE))).replace(new RegExp(":focus","g"),this.attributeCSS(this.FOCUS_ATTRIBUTE))).replace(new RegExp(":target","g"),this.attributeCSS(this.TARGET_ATTRIBUTE));const r=RegExp(/(@import.*?["']([^"']+)["'].*?|url\((?!['"]?(?:data):)['"]?([^'"\)]*)['"]?\))/gi);for(;s=r.exec(t);){const r=!!s[2]?"type/css":void 0,n=s[2]||s[3];i.push(this.getDataURL(new URL(n,e).href,r).then((e=>{t=t.replace(n,e)})))}return await Promise.all(i),t}static async getAllEmbeddedStyles(e){const t=e.getRootNode(),s=this.embeddedStyles.get(t)||new Map;this.embeddedStyles.set(t,s);const i=Array.from(t.querySelectorAll("style, link[type='text/css'], link[rel='stylesheet']")),r=e.getRootNode()instanceof ShadowRoot;for(const n of i)s.has(n)||s.set(n,new Promise((e=>{if("style"===n.tagName.toLowerCase())e(n.textContent||"");else{const t=n;e(this.getEmbeddedCSS(t.href))}})).then((e=>{const t=RegExp(/@font-face[^{]*{([^{}]|{[^{}]*})*}/gi),i=e.match(t);if(r&&i){const e=document.createElement("style");e.innerHTML=i.reduce(((e,t)=>t+"\n\n"+e),""),document.head.appendChild(e),s.set(e,Promise.resolve(""))}return this.generateEmbeddedCSS(window.location.href,e)})));return Promise.all(s.values())}static async getDataURL(e,t){if(e.startsWith("data"))return e;if(this.dataURLMap.has(e))return this.dataURLMap.get(e);const s=new Promise((async s=>{const i=await fetch(e,t?{headers:{accept:t}}:void 0),r=i.headers.get("content-type");if("text/css"==r){const t=await this.generateEmbeddedCSS(e,await i.text());this.embeddedCSSMap.set(e,t),s("data:"+r+";base64,"+window.btoa(t))}else{const e=new Uint8Array(await i.arrayBuffer());s("data:"+r+";base64,"+this.arrayBufferToBase64(e))}}));return this.dataURLMap.set(e,s),s}static async getEmbeddedCSS(e){if(this.embeddedCSSMap.has(e))return this.embeddedCSSMap.get(e);const t=await fetch(e,{headers:{accept:"text/css"}}),s=await this.generateEmbeddedCSS(e,await t.text());return this.embeddedCSSMap.set(e,s),this.embeddedCSSMap.get(e)}static updateInputAttributes(e){e.matches("input")&&this._updateInputAttribute(e);for(const t of e.getElementsByTagName("input"))this._updateInputAttribute(t)}static _updateInputAttribute(e){e.hasAttribute("checked")?e.checked||e.removeAttribute("checked"):e.checked&&e.setAttribute("checked",""),e.getAttribute("value")!==e.value&&e.setAttribute("value",e.value)}static isBlankImage(e){return!new Uint32Array(e.buffer).some((e=>0!==e))}};let Je=Ke;if(Je.ATTRIBUTE_PREFIX="xr",Je._nextUID=0,Je.serializer=new XMLSerializer,Je.rootLayers=new Map,Je.layers=new Map,Je.mutationObservers=new Map,Je.resizeObservers=new Map,Je.serializeQueue=[],Je.rasterizeQueue=[],Je.renderQueue=[],Je.focusElement=null,Je.activeElement=null,Je.targetElement=null,Je.rootNodeObservers=new Map,Je.TASK_ASYNC_MAX_COUNT=2,Je.TASK_SYNC_MAX_TIME=200,Je.rasterizeTaskCount=0,Je.tasksPending=!1,Je._handleMutations=e=>{for(const t of e){if("attributes"===t.type){if(t.target.getAttribute(t.attributeName)===t.oldValue)continue}if("characterData"===t.type){if(t.target.data===t.oldValue)continue}const e=t.target.nodeType===Node.ELEMENT_NODE?t.target:t.target.parentElement;if(!e)continue;const s=Ke.getClosestLayer(e);if(s){if("attributes"===t.type&&"class"===t.attributeName){if((t.oldValue?t.oldValue:"")===t.target.className)continue}s.parentLayer?s.parentLayer.traverseChildLayers(Ke.setLayerNeedsRefresh):s.traverseLayers(Ke.setLayerNeedsRefresh)}}},Je._triggerRefresh=async e=>{const t=Ke.getClosestLayer(e.target);t&&(t.parentLayer?t.parentLayer.traverseChildLayers(Ke.setLayerNeedsRefresh):t.traverseLayers(Ke.setLayerNeedsRefresh))},Je.embeddedStyles=new Map,Je.dataURLMap=new Map,Je.embeddedCSSMap=new Map,self.THREE)var et=self.THREE;else et=S;const tt=new et.Matrix4,st=new et.Vector3,it=new et.Vector3,rt=new De,nt=new De,at=Symbol("ON_BEFORE_UPDATE");class ot extends et.Object3D{constructor(e,t={}){super(),this.element=e,this.options=t,this.isRoot=!1,this._localZ=0,this._viewZ=0,this._renderZ=0,this.textures=new Map,this.textureNeedsUpdate=!1,this.contentMesh=new et.Mesh(lt.GEOMETRY,new et.MeshBasicMaterial({side:et.DoubleSide,depthWrite:!1,transparent:!0,alphaTest:.001,opacity:1})),this._boundsMesh=new et.Mesh(lt.GEOMETRY,new et.MeshBasicMaterial({visible:!1})),this.cursor=new et.Object3D,this.depthMaterial=new et.MeshDepthMaterial({depthPacking:et.RGBADepthPacking,alphaTest:.001}),this.domLayout=new et.Object3D,this.domSize=new et.Vector3(1,1,1),this.bounds=new De,this.margin=new Fe,this.childWebLayers=[],this.shouldApplyDOMLayout="auto",this.name=e.id,this._webLayer=Je.getClosestLayer(e),e.layer=this,this.add(this.contentMesh),this.add(this._boundsMesh),this.cursor.visible=!1,this.matrixAutoUpdate=!0,this.contentMesh.matrixAutoUpdate=!0,this.contentMesh.visible=!1,this.contentMesh.customDepthMaterial=this.depthMaterial,this.contentMesh.onBeforeRender=(e,t,s)=>{this._camera=s},this._boundsMesh.matrixAutoUpdate=!0,lt.layersByElement.set(this.element,this),lt.layersByMesh.set(this.contentMesh,this)}get currentTexture(){if("VIDEO"===this._webLayer.element.tagName){const e=this._webLayer.element;let t=this.textures.get(e);return t||(t=new et.VideoTexture(e),t.wrapS=et.ClampToEdgeWrapping,t.wrapT=et.ClampToEdgeWrapping,t.minFilter=et.LinearFilter,this.options.textureEncoding&&(t.encoding=this.options.textureEncoding),this.textures.set(e,t)),t}const e=this._webLayer.currentCanvas;let t=this.textures.get(e);return e&&!t&&(t=new et.Texture(e),t.needsUpdate=!0,t.wrapS=et.ClampToEdgeWrapping,t.wrapT=et.ClampToEdgeWrapping,t.minFilter=et.LinearFilter,this.options.textureEncoding&&(t.encoding=this.options.textureEncoding),this.textures.set(e,t)),t}get pseudoStates(){return this._webLayer.pseudoStates}get depth(){return this._webLayer.depth}get index(){return this.parentWebLayer?this.parentWebLayer.childWebLayers.indexOf(this):0}get needsRefresh(){return this._webLayer.needsRefresh}setNeedsRefresh(){this._webLayer.traverseLayers(Je.setLayerNeedsRefresh)}get needsRemoval(){return this._webLayer.needsRemoval}get parentWebLayer(){return this._webLayer.parentLayer&&lt.layersByElement.get(this._webLayer.parentLayer.element)}refresh(e=!1){var t;this._webLayer.refresh(),this.childWebLayers.length=0;for(const s of this._webLayer.childLayers){const i=lt.layersByElement.get(null==(t=Je.getClosestLayer(s.element))?void 0:t.element);i&&(this.childWebLayers.push(i),e&&i.refresh(e))}this._refreshVideoBounds()}updateLayout(){if(this._updateDOMLayout(),this._camera){this._localZ=Math.abs(st.setFromMatrixPosition(this.matrix).z+st.setFromMatrixPosition(this.contentMesh.matrix).z),this._viewZ=Math.abs(this.contentMesh.getWorldPosition(st).applyMatrix4(this._camera.matrixWorldInverse).z);let e=this.parentWebLayer?this.parentWebLayer._renderZ:this._viewZ;this._localZ<.001?this._renderZ=e:this._renderZ=this._viewZ,this.contentMesh.renderOrder=(this.options.renderOrderOffset||0)+(1-Math.log(this._renderZ+1)/Math.log(this._camera.far+1))+1e-7*(this.depth+.001*this.index)}}updateContent(){const e=this.contentMesh,t=this.currentTexture,s=e.material;if(t&&(t.image&&s.map!==t||this.textureNeedsUpdate)){const e=this.contentMesh.scale,i=Math.abs(e.x*this.scale.x/e.y*this.scale.y),r=this.domSize.x/this.domSize.y;Math.abs(r-i)<1e3&&(s.map=t,this.depthMaterial.map=t,this.textureNeedsUpdate=!1,s.needsUpdate=!0,t.needsUpdate=!0,this.depthMaterial.needsUpdate=!0)}s.transparent=!0;const i=e.material.opacity<.005;i?e.visible=!1:e.material.map&&(e.visible=!0),this.needsRemoval&&i&&(this.parent&&this.parent.remove(this),this.dispose())}get rootWebLayer(){return lt.layersByElement.get(this._webLayer.rootLayer.element)}[at](){}_doUpdate(){this[at](),this.updateContent(),this.updateLayout(),this.position.copy(this.domLayout.position),this.quaternion.copy(this.domLayout.quaternion),this.scale.copy(this.domLayout.scale),this.contentMesh.position.set(0,0,0),this.contentMesh.scale.copy(this.domSize),this.contentMesh.quaternion.set(0,0,0,1),this._boundsMesh.position.set(0,0,0),this._boundsMesh.scale.copy(this.domSize),this._boundsMesh.quaternion.set(0,0,0,1),this.needsRefresh&&!1!==this.options.autoRefresh&&this.refresh(),Je.scheduleTasksIfNeeded()}update(e=!1){e?this.traverseLayersPreOrder(this._doUpdate):this._doUpdate()}querySelector(e){var t;const s=this.element.querySelector(e)||(null==(t=this.element.shadowRoot)?void 0:t.querySelector(e));if(s)return lt.layersByElement.get(s)}traverseLayerAncestors(e){const t=this.parentWebLayer;t&&(t.traverseLayerAncestors(e),e.call(this,t))}traverseLayersPreOrder(e){if(!1===e.call(this,this))return!1;for(const t of this.childWebLayers)if(!1===t.traverseLayersPreOrder(e))return!1;return!0}traverseLayersPostOrder(e){for(const t of this.childWebLayers)if(!1===t.traverseLayersPostOrder(e))return!1;return e.call(this,this)||!0}dispose(){for(const e of this.textures.values())e.dispose();this.contentMesh.geometry.dispose(),this._boundsMesh.geometry.dispose(),Je.disposeLayer(this._webLayer);for(const e of this.childWebLayers)e.dispose()}_refreshVideoBounds(){if("VIDEO"===this.element.nodeName){const e=this.element,t=this.currentTexture,s=getComputedStyle(this.element),{objectFit:i}=s,{width:r,height:n}=this.bounds.copy(this._webLayer.currentBounds),{videoWidth:a,videoHeight:o}=e,h=a/o,l=r/n;switch(t.center.set(.5,.5),i){case"none":t.repeat.set(r/a,n/o).clampScalar(0,1);break;case"contain":case"scale-down":if(t.repeat.set(1,1),l>h){const e=this.bounds.height*h||0;this.bounds.left+=(this.bounds.width-e)/2,this.bounds.width=e}else{const e=this.bounds.width/h||0;this.bounds.top+=(this.bounds.height-e)/2,this.bounds.height=e}break;case"cover":if(t.repeat.set(r/a,n/o),l<h){const e=this.bounds.height*h||0;this.bounds.left+=(this.bounds.width-e)/2,this.bounds.width=e}else{const e=this.bounds.width/h||0;this.bounds.top+=(this.bounds.height-e)/2,this.bounds.height=e}break;default:case"fill":t.repeat.set(1,1)}}}_updateDOMLayout(){if(this.needsRemoval)return;const{currentBounds:e,currentMargin:t}=this._webLayer;this.domLayout.position.set(0,0,0),this.domLayout.scale.set(1,1,1),this.domLayout.quaternion.set(0,0,0,1);const s="VIDEO"===this.element.nodeName,i=s?this.bounds:this.bounds.copy(e),r=s?this.margin:this.margin.copy(t),n=i.width+r.left+r.right,a=i.height+r.top+r.bottom,o=i.width,h=i.height,l=1/lt.DEFAULT_PIXELS_PER_UNIT;if(this.domSize.set(Math.max(l*(o+r.left+r.right),1e-5),Math.max(l*(h+r.top+r.bottom),1e-5),1),!lt.shouldApplyDOMLayout(this))return;const c=this.parentWebLayer;if(!c)return;const u=c.bounds,d=c.margin,p=u.width+d.left+d.right,m=u.height+d.bottom+d.top,g=-p/2+d.left,y=m/2-d.top;this.domLayout.position.set(l*(g+n/2+i.left-r.left),l*(y-a/2-i.top+r.top),0);const _=getComputedStyle(this.element),f=_.transform;if(f&&"none"!==f){const e=Je.parseCSSTransform(_,i.width,i.height,l,tt);e&&(this.domLayout.updateMatrix(),this.domLayout.matrix.multiply(e),this.domLayout.matrix.decompose(this.domLayout.position,this.domLayout.quaternion,this.domLayout.scale))}}}const ht=class extends et.Object3D{constructor(e,t={}){super(),this.options=t,this._interactionRays=[],this._raycaster=new et.Raycaster,this._hitIntersections=[],this._previousHoverLayers=new Set,this._contentMeshes=[],this._prepareHitTest=e=>{e.pseudoStates.hover&&this._previousHoverLayers.add(e),e.cursor.visible=!1,e.pseudoStates.hover=!1,this._contentMeshes.push(e.contentMesh)};const s="string"==typeof e?ke(e):e;Je.createLayerTree(s,t,((e,{target:t})=>{var i,r,n,a,o,h;if("layercreated"===e){const e=new ot(t,this.options);t===s?(e[at]=()=>this._updateInteractions(),e.isRoot=!0,this.rootLayer=e,this.add(e)):null==(i=e.parentWebLayer)||i.add(e),null==(n=(r=this.options).onLayerCreate)||n.call(r,e)}else if("layerpainted"===e){const e=Je.layers.get(t),s=ht.layersByElement.get(e.element);s.textureNeedsUpdate=!0,null==(o=(a=this.options).onLayerPaint)||o.call(a,s)}else if("layermoved"===e){const e=ht.layersByElement.get(t);null==(h=e.parentWebLayer)||h.add(e)}})),this.refresh(),this.update()}static shouldApplyDOMLayout(e){const t=e.shouldApplyDOMLayout;return"always"===t||!0===t||"never"!==t&&!1!==t&&!("auto"!==t||!e.parentWebLayer||e.parent!==e.parentWebLayer)}get interactionRays(){return this._interactionRays}set interactionRays(e){this._interactionRays=e}querySelector(e){return this.rootLayer.querySelector(e)}refresh(){this.rootLayer.refresh(!0)}update(){this.rootLayer.update(!0)}get contentMesh(){return this.rootLayer.contentMesh}_intersectionSort(e,t){const s=e.object.parent,i=t.object.parent;return s.depth!==i.depth?i.depth-s.depth:i.index-s.index}_updateInteractions(){const e=this._previousHoverLayers;e.clear(),this._contentMeshes.length=0,this.rootLayer.traverseLayersPreOrder(this._prepareHitTest);for(const t of this._interactionRays){t instanceof et.Ray?this._raycaster.ray.copy(t):this._raycaster.ray.set(t.getWorldPosition(st),t.getWorldDirection(it).negate()),this._hitIntersections.length=0;const s=this._raycaster.intersectObjects(this._contentMeshes,!1,this._hitIntersections);s.sort(this._intersectionSort);const i=s[0];if(i){const t=i.object.parent;t.cursor.position.copy(i.point),t.cursor.visible=!0,t.pseudoStates.hover=!0,e.has(t)||t.setNeedsRefresh()}}for(const t of e)t.pseudoStates.hover||t.setNeedsRefresh()}hitTest(e){const t=this._raycaster,s=this._hitIntersections,i=ht.layersByMesh;e instanceof et.Ray?this._raycaster.ray.copy(e):this._raycaster.ray.set(e.getWorldPosition(st),e.getWorldDirection(it).negate()),s.length=0,t.intersectObject(this,!0,s),s.sort(this._intersectionSort);for(const r of s){const e=i.get(r.object);if(!e)continue;const t=Ue(e.element,rt);if(!t.width||!t.height)continue;let s=e.element;const n=r.uv.x*t.width,a=(1-r.uv.y)*t.height;return Ne(e.element,(e=>{if(!s.contains(e))return!1;const i=Ue(e,nt),r=i.left-t.left,o=i.top-t.top,{width:h,height:l}=i;return n>r&&n<r+h&&a>o&&a<o+l&&(s=e,!0)})),{layer:e,intersection:r,target:s}}}};let lt=ht;lt.layersByElement=new WeakMap,lt.layersByMesh=new WeakMap,lt.DEFAULT_LAYER_SEPARATION=.001,lt.DEFAULT_PIXELS_PER_UNIT=1e3,lt.GEOMETRY=new et.PlaneGeometry(1,1,2,2);const ct=new n,ut=new n,dt={getChildren(e,t){const s=e.node;if(s.isObject3D){t.length=0;for(let e=0;e<s.children.length;e++)t[e]=s.children[e]}},getState(e){var t;if(e.system.viewNode===e.node){const t=e.node;t.updateMatrixWorld(),e.system.viewFrustum.setFromPerspectiveProjectionMatrix(t.projectionMatrix)}const s=e.node;if(!s.isObject3D)return;let i,r;if(e.isAdaptive){const n=null==(t=e.referenceMetrics)?void 0:t.target.worldMatrix;r=ct.compose(s.position,s.quaternion,s.scale),i=n?ut.multiplyMatrices(n,r):r}else i=s.matrixWorld,r=s.matrix;e.raw.parent=s.parent,e.raw.worldMatrix.copy(i),e.raw.relativeMatrix.copy(r),e.raw.opacity=pt(e)||1},getIntrinsicBounds(e,t){const s=e.node;if(s.isObject3D)return s.geometry?(s.geometry.boundingBox||s.geometry.computeBoundingBox(),t.copy(s.geometry.boundingBox)):t},apply(e,t){const s=e.node;if(!s.isObject3D)return;if(t.parent!==s.parent){const e=t.parent;e&&e.add(s)}let i=t.localMatrix;if(isNaN(i.elements[0])||isNaN(i.elements[13])||isNaN(i.elements[14])||isNaN(i.elements[15])||0===i.elements[0])throw new Error;if(i=t.worldMatrix,isNaN(i.elements[0])||isNaN(i.elements[13])||isNaN(i.elements[14])||isNaN(i.elements[15])||0===i.elements[0])throw new Error;s.matrixAutoUpdate=!1,s.matrix.copy(t.localMatrix),s.matrixWorld.copy(t.worldMatrix),mt(e,t.opacity)}};function pt(e){const t=e.node;if(t.material){const e=t.material;if(e.length){for(const t of e)if(void 0!==t.opacity)return t.opacity}else if("opacity"in t.material)return t.material.opacity}for(const s of e.boundingChildMetrics){const e=pt(s);if(void 0!==e)return e}}function mt(e,t){const s=e.node;if(s.material){const e=s.material;if(e.length)for(const s of e)"opacity"in s&&(s.opacity=t);else s.material.opacity=t}for(const i of e.boundingChildMetrics)mt(i,t)}const gt={getChildren(e,t){e.node.isObject3D&&dt.getChildren(e,t)},getState(e){e.node.isObject3D&&dt.getState(e)},getIntrinsicBounds:(e,t)=>(e.node.isObject3D&&dt.getIntrinsicBounds(e,t),t),apply(e,t){e.node.isObject3D&&dt.apply(e,t)}};function yt(e,t=gt){return new Ae(e,t)}var _t=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",ThreeBindings:dt,DefaultBindings:gt,createLayoutSystem:yt,WebLayer3D:lt,WebLayer3DContent:ot,WebRenderer:Je,get THREE(){return et},toDOM:ke,EtherealLayoutSystem:Ae,MathUtils:R,Matrix3:E,Matrix4:n,V_00:A,V_11:O,V_000:I,V_100:N,V_010:D,V_001:F,V_111:U,Q_IDENTITY:P,DIRECTION:V,Vector2:e,Vector3:t,Vector4:C,Quaternion:s,Euler:a,Color:l,Box2:i,Box3:r,Ray:z,Line3:B,Plane:L,computeRelativeDifference:k,gaussian:q,levy:$,randomQuaternion:H,randomSelect:G,extractRotationAboutAxis:Q,LayoutFrustum:Le,NodeState:ie,SpatialMetrics:re,SpatialAdapter:Be,SpatialLayout:_e,LayoutSolution:ve,OptimizerConfig:ne,SpatialOptimizer:ae,easing:we,Transition:be,TransitionConfig:xe,Transitionable:ze,SphericalCoordinate:Ie,MemoizationCache:X});export{P as Q,Ie as S,I as V,lt as W,D as a,U as b,yt as c,we as d,_t as e};
