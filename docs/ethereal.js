import{H as e,J as t,K as s,U as i,X as r,Y as n,Z as a,_ as o,$ as h,a0 as c,a1 as l,a2 as u,a3 as d,a4 as p,a5 as m,a6 as g,a7 as y,a8 as _,a9 as f,aa as v,ab as b,ac as w,ad as x,ae as M,af as T,T as S,ag as R,ah as E,ai as z,aj as C,ak as L,al as B}from"./vendor.js";const A=Object.freeze(new e(0,0)),I=Object.freeze(new e(1,1)),O=Object.freeze(new t(0,0,0)),N=Object.freeze(new t(1,0,0)),D=Object.freeze(new t(0,1,0)),F=Object.freeze(new t(0,0,1)),U=Object.freeze(new t(1,1,1)),P=Object.freeze(new s),k={RIGHT:Object.freeze(new t(1,0,0)),UP:Object.freeze(new t(0,1,0)),NEAR:Object.freeze(new t(0,0,1)),LEFT:Object.freeze(new t(-1,0,0)),DOWN:Object.freeze(new t(0,-1,0)),FAR:Object.freeze(new t(0,0,-1))};function V(e,t){return"number"==typeof e?function(e,t){if(t===e)return 0;const s=Math.abs(t-e),i=(Math.abs(t)+Math.abs(e))/2;return s/i}(e,t):"isVector3"in e?function(e,t){if(t.equals(e))return 0;const s=t.distanceTo(e),i=(t.length()+e.length())/2;return s/i}(e,t):"isVector2"in e?function(e,t){if(t.equals(e))return 0;const s=t.distanceTo(e),i=(t.length()+e.length())/2;return s/i}(e,t):"isBox3"in e?function(e,t){if(e.equals(t))return 0;const s=j,i=t.min.distanceTo(e.min),r=t.max.distanceTo(e.max),n=(i+r)/2,a=(t.getSize(s).length()+e.getSize(s).length())/2;return n/a}(e,t):"isQuaternion"in e?(i=t,(s=e).equals(i)?0:s.angleTo(i)/Math.PI):"isColor"in e?function(e,t){if(e.equals(t))return 0;return j.set(Math.abs(t.r-e.r),Math.abs(t.g-e.g),Math.abs(t.b-e.b)).length()/W}(e,t):1/0;var s,i}const j=new t;const W=Math.sqrt(3),q=(e=1)=>{var t=Math.random();return(t%1e-8>5e-9?1:-1)*Math.sqrt(-Math.log(Math.max(1e-9,t)))*e},$=(e=1)=>{const t=Math.sqrt(Math.sqrt(1/(2*e)));return 1/q(t)**2},Q=(()=>{const e=2*Math.PI,i=new t(0,0,1),r=new s,n=new s,a=new t,o=new s;return function(t=1,s=1){var h=(Math.random()-.5)*e*t,c=Math.random()*e,l=Math.random()*Math.PI*s;return a.set(1,0,0).applyAxisAngle(i,c),r.setFromAxisAngle(i,h),n.setFromAxisAngle(a,l),o.multiplyQuaternions(n,r)}})();function G(e,t){let s=0;for(let r=0;r<e.length;r++)s+=(null==t?void 0:t[r])||1;const i=Math.random()*s;s=0;for(let r=0;r<e.length;r++)if(s+=(null==t?void 0:t[r])||1,s>i)return e[r];return e[0]}const H=(()=>{const e=new t;return function(t,s,i){const r=e.set(t.x,t.y,t.z),n=s.dot(r),a=e.copy(s).multiplyScalar(n),o=i.set(a.x,a.y,a.z,t.w).normalize();return n<0&&(o.x=-o.x,o.y=-o.y,o.z=-o.z,o.w=-o.w),o}})();class X{constructor(){this.callbacks=[]}memoize(e,...t){t.push(this);const s=function(e){let t;const s=()=>(s.needsUpdate&&(s.needsUpdate=!1,t=e()),t);return s.needsUpdate=!0,s}(e);for(const i of t)i.callbacks.push(s);return s}invalidateAll(){const e=this.callbacks;for(let t=0;t<this.callbacks.length;t++)e[t].needsUpdate=!0}isFullyInvalid(){const e=this.callbacks;for(let t=0;t<this.callbacks.length;t++)if(!e[t].needsUpdate)return!1;return!0}}var Y,Z,K,J;const ee=Symbol("raw"),te=Symbol("current"),se=Symbol("target"),ie=Symbol("previousTarget"),re=class{constructor(e,i){this.mode=e,this.metrics=i,this._cache=new X,this.opacity=1,this._parent=null,this._cachedLocalMatrix=this._cache.memoize((()=>(this._localMatrix.decompose(this._localPosition,this._localOrientation,this._localScale),this._localOrientation.normalize(),this._localOrientationInverse.copy(this._localOrientation).invert(),this._localRotation.makeRotationFromQuaternion(this._localOrientation),this._localRotationInverse.makeRotationFromQuaternion(this._localOrientationInverse),this._localMatrix))),this._localMatrix=new n,this._localMatrixInverse=new n,this._localPosition=new t,this._localOrientation=new s,this._localOrientationInverse=new s,this._localScale=new t(1,1,1),this._localRotation=new n,this._localRotationInverse=new n,this._cachedWorldMatrix=this._cache.memoize((()=>{const e=this._worldMatrix.copy(this.localMatrix),t=this.parentState;return t&&e.premultiply(t.worldMatrix),e.decompose(this._worldPosition,this._worldOrientation,this._worldScale),this._worldMatrixInverse.copy(this._worldMatrix).invert(),this._worldOrientationInverse.copy(this._worldOrientation).invert(),this._worldRotation.makeRotationFromQuaternion(this._worldOrientation),this._worldRotationInverse.makeRotationFromQuaternion(this._worldOrientationInverse),e})),this._worldPosition=new t,this._worldOrientation=new s,this._worldOrientationInverse=new s,this._worldScale=new t,this._worldMatrix=new n,this._worldMatrixInverse=new n,this._worldRotation=new n,this._worldRotationInverse=new n,this._cachedWorldCenter=this._cache.memoize((()=>this._worldCenter.copy(this.metrics.innerCenter).applyMatrix4(this.worldMatrix))),this._worldCenter=new t,this._cachedSpatialMatrix=this._cache.memoize((()=>{const e=this._spatialMatrix.compose(this.outerOrigin,this.worldOrientation,U);this._spatialMatrixInverse.copy(this._spatialMatrix).invert(),this._localFromSpatial.multiplyMatrices(this.worldMatrixInverse,e),this._spatialFromLocal.copy(this._localFromSpatial).invert();const t=this.referenceState;return t?this._spatialFromReference.multiplyMatrices(this._spatialMatrixInverse,t.worldMatrix):this._spatialFromReference.copy(this._spatialMatrixInverse),e})),this._spatialMatrix=new n,this._spatialMatrixInverse=new n,this._localFromSpatial=new n,this._spatialFromLocal=new n,this._spatialFromReference=new n,this._cachedSpatialBounds=this._cache.memoize((()=>{this._spatialBounds.copy(this.metrics.innerBounds);const e=this._spatialBounds.applyMatrix4(this.spatialFromLocal);return e.getCenter(this._spatialCenter),e.getSize(this._spatialSize),e})),this._spatialBounds=new r,this._spatialSize=new t,this._spatialCenter=new t,this._cachedOuterBounds=this._cache.memoize((()=>{const e=this._outerBounds,t=this.metrics.system.nodeAdapters.get(this.metrics.node);if(t)e.copy(t.outerBounds[this.mode]);else{const t=this.referenceState;t?e.copy(t.metrics.innerBounds):e.setFromCenterAndSize(O,O),e.applyMatrix4(this.spatialFromReference)}return e.getCenter(this._outerCenter),e.getSize(this._outerSize),e})),this._outerBounds=new r,this._outerCenter=new t,this._outerSize=new t,this._cachedOuterVisualBounds=this._cache.memoize((()=>{const e=this._outerVisualBounds,t=this.metrics.system.nodeAdapters.get(this.metrics.node);if(t)e.copy(t.outerVisualBounds[this.mode]);else{const t=this.referenceState;t?e.copy(t.visualBounds):e.setFromCenterAndSize(O,O)}return e.getCenter(this._outerVisualCenter),e.getSize(this._outerVisualSize),e})),this._outerVisualBounds=new r,this._outerVisualCenter=new t,this._outerVisualSize=new t,this._viewFromWorld=new n,this._viewFromSpatial=new n,this._spatialFromView=new n,this._cachedNDCBounds=this._cache.memoize((()=>{if(this.metrics.system.viewNode===this.metrics.node)return this._ndcBounds.min.setScalar(-1),this._ndcBounds.max.setScalar(1),this._ndcBounds;const e=this.metrics.system.viewFrustum.perspectiveProjectionMatrix,t=this.viewFromWorld,s=this._viewProjectionFromWorld.multiplyMatrices(e,t),i=this._ndcBounds.copy(this.metrics.innerBounds).applyMatrix4(s);return i.getCenter(this._ndcCenter),i.getSize(this._ndcSize),isFinite(i.min.x)&&isFinite(i.min.y)&&isFinite(i.min.z)&&isFinite(i.max.x)&&isFinite(i.max.y)&&isFinite(i.max.z)||(i.min.setScalar(-1),i.max.setScalar(1),i.getCenter(this._ndcCenter),i.getSize(this._ndcSize)),i}),this._viewState._cache),this._viewProjectionFromWorld=new n,this._ndcBounds=new r,this._ndcCenter=new t,this._ndcSize=new t,this._cachedVisualBounds=this._cache.memoize((()=>{const e=this.metrics.system,t=e.viewFrustum.perspectiveProjectionMatrix,s=this._inverseProjection.copy(t).invert(),i=this._visualBounds.copy(this.ndcBounds),r=this._v1,n=r.set(0,0,i.min.z).applyMatrix4(s).z,a=r.set(0,0,i.max.z).applyMatrix4(s).z;return i.min.z=a,i.max.z=n,i.min.x*=.5*e.viewResolution.x,i.max.x*=.5*e.viewResolution.x,i.min.y*=.5*e.viewResolution.y,i.max.y*=.5*e.viewResolution.y,i.getCenter(this._visualCenter),i.getSize(this._visualSize),i}),this._viewState._cache),this._visualBounds=new r,this._visualCenter=new t,this._visualSize=new t,this._v1=new t,this._inverseProjection=new n,this._viewPosition=new t,this._cachedViewAlignedOrientation=this._cache.memoize((()=>{const e=this._relativeViewMatrix.multiplyMatrices(this.worldMatrixInverse,this._viewState.worldMatrix),t=this._relativeViewRotation.extractRotation(e),s=this._relativeViewOrientation.setFromRotationMatrix(t),i=this._relativeViewForward.set(0,0,1).applyQuaternion(s),r=this._relativeViewUp.set(0,1,0).applyQuaternion(s);let n,a,o,h=1/0,c=1/0;for(o in k){const e=k[o];var l=r.distanceToSquared(e);l<c&&(c=l,a=e)}for(o in k){const e=k[o];if(e.x&&a.x)continue;if(e.y&&a.y)continue;if(e.z&&a.z)continue;const t=i.distanceToSquared(e);t<h&&(h=t,n=e)}const u=this._orthogonalRotation.identity();return u.lookAt(n,O,a),this._orthogonalOrientation.setFromRotationMatrix(u)}),this._viewState._cache),this._relativeViewMatrix=new n,this._relativeViewRotation=new n,this._relativeViewOrientation=new s,this._relativeViewUp=new t,this._relativeViewForward=new t,this._orthogonalRotation=new n,this._orthogonalOrientation=new s,this._computeOcclusion=this._cache.memoize((()=>{this._occludingPercent=0,this._occludedPercent=0;const e=this.metrics;if(e.innerBounds.isEmpty())return;const t=e.system.nodeAdapters.values(),s=this.visualBounds,i=s.min.z,r=re._boxA,n=re._boxB;r.min.set(s.min.x,s.min.y),r.min.set(s.max.x,s.max.y);const a=r.getSize(re._sizeA).length();for(const o of t){const t=o.metrics;if(t===e)continue;if(!t.isAdaptive||t.innerBounds.isEmpty())continue;if(t.containedByNode(o.node))continue;const h=("current"===this.mode?t.current:t.target).visualBounds;r.min.set(s.min.x,s.min.y),r.min.set(s.max.x,s.max.y),n.min.set(h.min.x,h.min.y),n.min.set(h.max.x,h.max.y);const c=r.intersect(n).getSize(re._sizeB).length()/a;c>0&&(i<h.min.z?this._occludingPercent+=c:this._occludedPercent+=c)}}),this._viewState._cache),this._occludingPercent=0,this._occludedPercent=0}invalidate(){this._cache.invalidateAll()}get parent(){return this._parent}set parent(e){this._parent!==e&&(this._parent=e,this.invalidate())}get parentState(){const e=this.parent&&this.metrics.system.getMetrics(this.parent);return null==e?void 0:e[this.mode]}get referenceState(){var e;return null==(e=this.metrics.referenceMetrics)?void 0:e[this.mode]}get localMatrix(){return this._localMatrix}set localMatrix(e){if(isNaN(e.elements[0]))throw new Error;this._localMatrix.equals(e)||(this.invalidate(),this._localMatrix.copy(e),this._localMatrixInverse.copy(this._localMatrix).invert())}get localMatrixInverse(){return this._localMatrixInverse}get localPosition(){return this._cachedLocalMatrix(),this._localPosition}get localOrientation(){return this._cachedLocalMatrix(),this._localOrientation}get localOrientationInverse(){return this._cachedLocalMatrix(),this._localOrientationInverse}get localScale(){return this._cachedLocalMatrix(),this._localScale}get localRotation(){return this._cachedLocalMatrix(),this._localRotation}get localRotationInverse(){return this._cachedLocalMatrix(),this._localRotationInverse}get worldMatrix(){return this._cachedWorldMatrix()}get worldMatrixInverse(){return this.worldMatrix,this._worldMatrixInverse}get worldPosition(){return this.worldMatrix,this._worldPosition}get worldOrientation(){return this.worldMatrix,this._worldOrientation}get worldScale(){return this.worldMatrix,this._worldScale}get worldOrientationInverse(){return this._worldOrientationInverse}get worldRotation(){return this._worldRotation}get worldRotationInverse(){return this._worldRotationInverse}get worldCenter(){return this._cachedWorldCenter()}get spatialMatrix(){return this._cachedSpatialMatrix()}get spatialMatrixInverse(){return this.spatialMatrix,this._spatialMatrixInverse}get localFromSpatial(){return this.spatialMatrix,this._localFromSpatial}get spatialFromLocal(){return this.spatialMatrix,this._spatialFromLocal}get spatialFromReference(){return this.spatialMatrix,this._spatialFromReference}get spatialBounds(){return this._cachedSpatialBounds()}get spatialSize(){return this.spatialBounds,this._spatialSize}get spatialCenter(){return this.spatialBounds,this._spatialCenter}get outerBounds(){return this._cachedOuterBounds()}get outerCenter(){return this.outerBounds,this._outerCenter}get outerSize(){return this.outerBounds,this._outerSize}get outerOrigin(){var e,t;const s=this.metrics.system.nodeAdapters.get(this.metrics.node);return s?s.outerOrigin[this.mode]:null!=(t=null==(e=this.referenceState)?void 0:e.worldCenter)?t:O}get outerOrientation(){var e,t;const s=this.metrics.system.nodeAdapters.get(this.metrics.node);return s?s.outerOrientation[this.mode]:null!=(t=null==(e=this.referenceState)?void 0:e.worldOrientation)?t:P}get outerVisualBounds(){return this._cachedOuterVisualBounds()}get outerVisualCenter(){return this.outerVisualBounds,this._outerVisualCenter}get outerVisualSize(){return this.outerVisualBounds,this._outerVisualSize}get _viewState(){if(this.metrics.system.viewNode===this.metrics.node)return this;const e=this.metrics.system.viewMetrics;return"current"===this.mode?e[te]:e[se]}get viewFromWorld(){return this._viewFromWorld.multiplyMatrices(this._viewState.worldMatrixInverse,this.worldMatrix)}get viewFromSpatial(){return this._viewFromSpatial.multiplyMatrices(this._viewState.worldMatrixInverse,this.spatialMatrix)}get spatialFromView(){return this._spatialFromView.copy(this.viewFromSpatial).invert()}get ndcBounds(){return this._cachedNDCBounds()}get ndcCenter(){return this._cachedNDCBounds(),this._ndcCenter}get ndcSize(){return this._cachedNDCBounds(),this._ndcSize}get visualBounds(){return this._cachedVisualBounds()}get visualCenter(){return this._cachedVisualBounds(),this._visualCenter}get visualSize(){return this._cachedVisualBounds(),this._visualSize}get relativeViewPosition(){return this._viewPosition.copy(this._viewState.worldPosition).applyMatrix4(this.worldMatrixInverse)}get viewAlignedOrientation(){return this._cachedViewAlignedOrientation()}get occludingPercent(){return this._computeOcclusion(),this._occludingPercent}get occludedPercent(){return this._computeOcclusion(),this._occludedPercent}visualAverageEdgeLength(){}};let ne=re;ne._boxA=new i,ne._boxB=new i,ne._sizeA=new e,ne._sizeB=new e;class ae{constructor(e,i){this.system=e,this.node=i,this._cache=new X,this.needsUpdate=!0,this._cachedInnerBounds=this._cache.memoize((()=>{const e=this._innerBounds;if(this.node!==this.system.viewNode){e.copy(this.intrinsicBounds);const t=this._childBounds;for(const s of this.boundsChildren){const i=this.system.getMetrics(s);i.invalidateStates(),t.copy(i.innerBounds),t.applyMatrix4(i.raw.localMatrix),e.union(t)}}const t=e.getCenter(this._innerCenter),s=e.getSize(this._innerSize);if(s.length()>0){const i=this.system.epsillonMeters;Math.abs(s.x)<=i&&(s.x=(Math.sign(s.x)||1)*i*1e3),Math.abs(s.y)<=i&&(s.y=(Math.sign(s.y)||1)*i*1e3),Math.abs(s.z)<=i&&(s.z=(Math.sign(s.z)||1)*i*1e3,t.z-=1e3*i/2),e.setFromCenterAndSize(t,s)}return e})),this._childBounds=new r,this._innerBounds=new r,this._innerCenter=new t,this._innerSize=new t,this._intrinsicBoundsNeedsUpdate=!0,this._intrinsicBounds=new r,this._intrinsicCenter=new t,this._intrinsicSize=new t,this._cachedNodeChildren=this._cache.memoize((()=>(this.system.bindings.getChildren(this,this._nodeChildren),this._nodeChildren))),this._nodeChildren=new Array,this._computeState=(()=>{const e=new n,i=new s,r=new t,a=new t,o=new n,h=new t,c=new s,l=new t,u=new t,d=new t,p=new t,m=new t;return function(t){var s;const n="current"===t.mode,g=this.system.nodeAdapters.get(this.node);i.copy((n?(null==g?void 0:g.orientation.enabled)&&(null==g?void 0:g.orientation.current):(null==g?void 0:g.orientation.enabled)&&(null==g?void 0:g.orientation.target))||this.raw.localOrientation);const y=n?(null==g?void 0:g.bounds.enabled)&&(null==g?void 0:g.bounds.current):(null==g?void 0:g.bounds.enabled)&&(null==g?void 0:g.bounds.target),_=this.parentMetrics;if(t.parent=null!=(s=null==_?void 0:_.node)?s:null,y){y.getCenter(u),y.getSize(d);const s=n?null==_?void 0:_.current:null==_?void 0:_.target,r=this.innerCenter,a=this.innerSize,g=this.system.epsillonMeters;Math.abs(d.x)<=g&&(d.x=(Math.sign(d.x)||1)*g*10),Math.abs(d.y)<=g&&(d.y=(Math.sign(d.y)||1)*g*10),Math.abs(d.z)<=g&&(d.z=(Math.sign(d.z)||1)*g*10),l.copy(d),Math.abs(a.x)>=g&&(l.x/=a.x),Math.abs(a.y)>=g&&(l.y/=a.y),Math.abs(a.z)>=g&&(l.z/=a.z),c.multiplyQuaternions(t.outerOrientation,i).normalize(),p.copy(u).applyQuaternion(c),m.copy(r).multiply(l).applyQuaternion(c),h.copy(t.outerOrigin).add(p).sub(m),o.compose(h,c,l),s?e.multiplyMatrices(s.worldMatrixInverse,o):e.copy(o)}else r.copy(this.raw.localPosition),a.copy(this.raw.localScale),e.compose(r,i,a);return t.localMatrix=e,t}})(),this._cachedRawState=this._cache.memoize((()=>(this.system.bindings.getState(this,this[ee]),this[ee]))),this[Y]=new ne("target",this),this._cachedCurrentState=this._cache.memoize((()=>this._computeState(this[te]))),this[Z]=new ne("current",this),this._cachedTargetState=this._cache.memoize((()=>this._computeState(this[se]))),this[K]=new ne("target",this),this[J]=new ne("target",this),this._cachedBoundsChildren=this._cache.memoize((()=>{const e=this.nodeChildren,t=this._children;t.length=0;for(const s of e){this.system.getMetrics(s).isAdaptive||t.push(s)}return t})),this._children=[]}update(){var e,t;if(this.needsUpdate){this.needsUpdate=!1,this.previousTarget.parent=this.target.parent,this.previousTarget.localMatrix=this.target.localMatrix,null==(e=this.parentMetrics)||e.update(),null==(t=this.referenceMetrics)||t.update();const s=this.system.nodeAdapters.get(this.node);s?s._update():(this.invalidateInnerBounds(),this.invalidateStates())}}get innerBounds(){return this._cachedInnerBounds()}get innerCenter(){return this.innerBounds,this._innerCenter}get innerSize(){return this.innerBounds,this._innerSize}get intrinsicBounds(){return this._intrinsicBoundsNeedsUpdate&&(this._intrinsicBoundsNeedsUpdate=!1,this.system.bindings.getIntrinsicBounds(this,this._intrinsicBounds),this._intrinsicBounds.getCenter(this._intrinsicCenter),this._intrinsicBounds.getSize(this._intrinsicSize)),this._intrinsicBounds}get intrinsicCenter(){return this.intrinsicBounds,this._intrinsicCenter}get intrinsicSize(){return this.intrinsicBounds,this._intrinsicSize}invalidateIntrinsicBounds(){this._intrinsicBoundsNeedsUpdate=!0;for(const e of this.boundsChildren){this.system.getMetrics(e).invalidateIntrinsicBounds()}}invalidateInnerBounds(){if(!this._cachedInnerBounds.needsUpdate){this._cachedNodeChildren.needsUpdate=!0,this._cachedBoundsChildren.needsUpdate=!0,this._cachedInnerBounds.needsUpdate=!0;for(const e of this.boundsChildren){this.system.getMetrics(e).invalidateInnerBounds()}}}containsNode(e){this.update();let t=this.system.getMetrics(e);for(;t;){if(t.parentMetrics===this)return t.node;t=t.parentMetrics}return!1}containedByNode(e){this.update();let t=this.parentMetrics;for(;t;){if(t.node===e)return t.node;t=t.parentMetrics}return!1}get nodeChildren(){return this._cachedNodeChildren()}invalidateStates(){this._cachedRawState.needsUpdate=!0,this._cachedCurrentState.needsUpdate=!0,this._cachedTargetState.needsUpdate=!0,this[ee].invalidate(),this[te].invalidate(),this[se].invalidate()}get raw(){return this._cachedRawState()}get current(){return this.update(),this._cachedCurrentState()}get target(){return this.update(),this._cachedTargetState()}get previousTarget(){return this.update(),this[ie]}get referenceNode(){this.update();const e=this.system.nodeAdapters.get(this.node);return void 0===(null==e?void 0:e.referenceNode)?this.parentNode:e.referenceNode}get referenceMetrics(){const e=this.system.nodeAdapters.get(this.node);if(null==e?void 0:e.referenceNode)return this.system.getMetrics(e.referenceNode);return this.parentNode?this.system.getMetrics(this.parentNode):null}get parentNode(){return this.update(),this.raw.parent}get parentMetrics(){const e=this.parentNode;return e?this.system.getMetrics(e):null}get boundsChildren(){return this._cachedBoundsChildren()}get isAdaptive(){return this.system.nodeAdapters.has(this.node)}}Y=ee,Z=te,K=se,J=ie;class oe{constructor(e){e&&Object.assign(this,e)}}class he{constructor(e){this.system=e,this._config=new oe,this._prevOrientation=new s,this._prevBounds=new r,this._scratchSolution=new be,this._scratchBestSolution=new be}_setConfig(e){var t,s,i,r,n,a,o,h,c,l;const u=this.system.optimize;this._config.minFeasibleTime=null!=(t=e.minFeasibleTime)?t:u.minFeasibleTime,this._config.maxInfeasibleTime=null!=(s=e.maxInfeasibleTime)?s:u.maxInfeasibleTime,this._config.pulseRate=null!=(i=e.pulseRate)?i:u.pulseRate,this._config.maxIterationsPerFrame=null!=(r=e.maxIterationsPerFrame)?r:u.maxIterationsPerFrame,this._config.swarmSize=null!=(n=e.swarmSize)?n:u.swarmSize,this._config.pulseFrequencyMin=null!=(a=e.pulseFrequencyMin)?a:u.pulseFrequencyMin,this._config.pulseFrequencyMax=null!=(o=e.pulseFrequencyMax)?o:u.pulseFrequencyMax,this._config.stepSizeMax=null!=(h=e.stepSizeMax)?h:u.stepSizeMax,this._config.stepSizeMin=null!=(c=e.stepSizeMin)?c:u.stepSizeMin,this._config.stepSizeStart=null!=(l=e.stepSizeStart)?l:u.stepSizeStart}update(e){if(0===e.layouts.length||e.metrics.innerBounds.isEmpty())return e.activeLayout=null,!1;const t=e.referenceNode,s=this._prevOrientation.copy(e.orientation.target),i=this._prevBounds.copy(e.bounds.target),r=e.activeLayout;for(const o of e.layouts)this._setConfig(o),this._updateLayout(e,o);let n,a;for(const o of e.layouts){const e=o.solutions[0];if((!a||!a.isFeasible&&e.isFeasible)&&(a=e,n=o,a.isFeasible))break}return e.layoutFeasibleTime+=e.system.deltaTime,e.layoutInfeasibleTime+=e.system.deltaTime,(null==a?void 0:a.isFeasible)||(e.layoutFeasibleTime=0),a&&a.isFeasible&&e.layoutFeasibleTime>=this._config.minFeasibleTime||e.layoutInfeasibleTime>=this._config.maxInfeasibleTime?(e.layoutInfeasibleTime=0,a.apply(),e.activeLayout=n):(e.referenceNode=t,e.orientation.target=s,e.bounds.target=i,e.activeLayout=r,e.metrics.invalidateStates()),!0}_updateLayout(e,t){var s;e.measureBoundsCache.clear();const i=t.solutions,r=this._config,n=this._scratchSolution,a=this._scratchBestSolution;let o=r.maxIterationsPerFrame;(null==(s=t.solutions[0])?void 0:s.isFeasible)&&(o=1),this._manageSolutionPopulation(e,t,r.swarmSize,r.stepSizeStart);for(const h of i)h.apply();t.sortSolutions();for(let h=0;h<o;h++){t.iteration++,a.copy(i[0]);for(let e=0;e<i.length;e++){const s=i[e];let o;if(n.copy(s),n.mutationStrategies=s.mutationStrategies,Math.random()<r.pulseRate){const e=a!==s?a:i[1];let o;if(i.length>2)do{o=i[Math.floor(Math.random()*i.length)]}while(o===s);n.moveTowards(e,r.pulseFrequencyMin,r.pulseFrequencyMax),o&&t.compareSolutions(o,s)<=0&&n.moveTowards(o,r.pulseFrequencyMin,r.pulseFrequencyMax)}else o=n.perturb();n.apply();const h=t.compareSolutions(n,s)<0;if(h&&(s.copy(n),s!==i[0]&&t.compareSolutions(s,i[0])<0&&i[0].copy(s)),o)if(o.stepSize*=h?1.5:.9036020036098449,!h&&o.stepSize<r.stepSizeMin||o.stepSize>r.stepSizeMax){for(const e of s.mutationStrategies)e.stepSize=r.stepSizeStart;s!==i[0]&&(t.restartRate=.001+.999*t.restartRate,s.randomize(1),s.apply())}else s!==i[0]&&(t.restartRate=.999*t.restartRate)}t.sortSolutions(),t.compareSolutions(a,i[0])<=0?t.successRate=.995*t.successRate:t.successRate=.005+.995*t.successRate}}_manageSolutionPopulation(e,t,s,i){if(s<=1)throw new Error("Swarm size must be larger than 1");if(t.solutions.length<s)for(;t.solutions.length<s;){const e=new be(t);for(const t of e.mutationStrategies)t.stepSize=i;e.randomize(1),t.solutions.push(e)}else if(t.solutions.length>s)for(;t.solutions.length>s;)t.solutions.pop()}}class ce{constructor(e){this.type="ratio",this.sortBlame=0,this.relativeTolerance=void 0,this.absoluteTolerance=void 0,this.priority=0,this.index=-1,this.reduceFromOneOrManySpec=(e,t,s)=>{if(void 0===t)return 0;if(t instanceof Array){let i=-1/0;for(const r of t)i=Math.max(s(e,r),i);return i}return s(e,t)},this._getNumberScoreSingle=(e,t)=>{let s=0;if("object"!=typeof t){const i=this.layout.adapter.system.measureNumber(t);s=-Math.abs(e-i)}else{const i="gt"in t?this.layout.adapter.system.measureNumber(t.gt):void 0,r="lt"in t?this.layout.adapter.system.measureNumber(t.lt):void 0;void 0!==i&&e<i?s=e-i:void 0!==r&&e>r&&(s=r-e)}return s},this._getVector3ScoreSingle=(e,t)=>("x"in t&&void 0!==t.x?this.getNumberScore(e.x,t.x):0)+("y"in t&&void 0!==t.y?this.getNumberScore(e.y,t.y):0)+("z"in t&&void 0!==t.z?this.getNumberScore(e.z,t.z):0)+("magnitude"in t&&void 0!==t.magnitude?this.getNumberScore(e.length(),t.magnitude):0),this._quat=new s,this._euler=new a,this._getQuaternionScoreSingle=(e,t)=>{var s,i;if(void 0===t)return 0;if("x"in t){return-this._quat.copy(t).angleTo(e)*o}if("swingRange"in t){const r=this._euler.setFromQuaternion(e),n=r.x*o,a=r.y*o,h=r.z*o,c=this.layout.adapter.system,l=c.mathScope.degree;let u=(null==(s=t.swingRange)?void 0:s.x)?c.measureNumber(t.swingRange.x,l):0,d=(null==(i=t.swingRange)?void 0:i.y)?c.measureNumber(t.swingRange.y,l):0;u=Math.max(u,.01),d=Math.max(d,.01);const p=1-(n/u)**2-(a/d)**2,m=(t.twistRange?c.measureNumber(t.twistRange,l):0)-Math.abs(h);return(p>0?0:p)+(m>0?0:m)}return 0},this._getBoundsMeasureScoreSingle=(e,t,s,i)=>{if(void 0===t)return 0;if("object"==typeof t){if("gt"in t){const r=this.layout.adapter.measureBounds(t.gt,s,i);if(e<r)return e-r}if("lt"in t){const r=this.layout.adapter.measureBounds(t.lt,s,i);if(e>r)return r-e}return 0}return-Math.abs(e-this.layout.adapter.measureBounds(t,s,i))},this.layout=e}static isDiscreteSpec(e){const t=typeof e;return"string"===t||"number"===t}static isContinuousSpec(e){return void 0!==e&&e instanceof Array==!1&&"object"==typeof e&&!0==("gt"in e||"lt"in e)}get bestScore(){return this.layout.solutions[0].scores[this.index]}get computedRelativeTolerance(){var e,t;return null!=(t=null!=(e=this.relativeTolerance)?e:this.layout.relativeTolerance)?t:this.layout.adapter.system.optimize.relativeTolerance}get computedAbsoluteTolerance(){const e=this.layout.adapter.system;return void 0!==this.absoluteTolerance?e.measureNumber(this.absoluteTolerance,e.mathScope[this.type]):this.layout.getComputedAbsoluteTolerance(this.type)}getNumberScore(e,t){return this.reduceFromOneOrManySpec(e,t,this._getNumberScoreSingle)}getVector3Score(e,t){return this.reduceFromOneOrManySpec(e,t,this._getVector3ScoreSingle)}getQuaternionScore(e,t){return this.reduceFromOneOrManySpec(e,t,this._getQuaternionScoreSingle)}getBoundsScore(e,t){if(void 0===e)return 0;let s=0;for(const i in e){if("absolute"===i)continue;let r=i;if("size"===r||"center"===r){const i=e[r];for(const e of pe){let n=e;if("spatial"!==t){if("meter"===this.type&&"z"!==n)continue;if("pixel"===this.type&&"z"===n)continue}s+=this.getBoundsMeasureScore(null==i?void 0:i[n],t,r+n)}}else{if("spatial"!==t){if("meter"===this.type&&"back"!==r&&"front"!==r)continue;if("pixel"===this.type&&("back"===r||"front"===r))continue}s+=this.getBoundsMeasureScore(e[r],t,r)}}return s}getBoundsMeasureScore(e,t,s){if(void 0===e)return 0;const i=this.layout.adapter.metrics.target;let r,n,a;switch(t){case"spatial":r=i.spatialBounds,n=i.spatialCenter,a=i.spatialSize;break;case"visual":case"view":r=i.visualBounds,n=i.visualCenter,a=i.visualSize;break;default:throw new Error(`Unknown measure type "${t}.${s}" in spec:\n "${e}"`)}let o=0;switch(s){case"left":o=r.min.x;break;case"right":o=r.max.x;break;case"bottom":o=r.min.y;break;case"top":o=r.max.y;break;case"back":o=r.min.z;break;case"front":o=r.max.z;break;case"centerx":o=n.x;break;case"centery":o=n.y;break;case"centerz":o=n.z;break;case"centerdistance":o="spatial"===t?n.length():Math.sqrt(n.x**2+a.y**2);break;case"sizex":o=a.x;break;case"sizey":o=a.y;break;case"sizez":o=a.z;break;case"sizediagonal":o="spatial"===t?a.length():Math.sqrt(a.x**2+a.y**2);break;default:throw new Error(`Unknown measure subtype ${t}.${s} in spec "${e}"`)}if(e instanceof Array){let i=-1/0;for(const r of e)i=Math.max(this._getBoundsMeasureScoreSingle(o,r,t,s),i);return i}return this._getBoundsMeasureScoreSingle(o,e,t,s)}attenuateVisualScore(e){let t=0;const s=this.layout.getComputedAbsoluteTolerance("pixel"),i=this.layout.adapter,r=i.system.viewResolution,n=i.system.viewFrustum,a=r.x,o=r.y,h=r.length(),c=i.metrics.target.visualBounds,l=c.min.x- -a/2+s,u=c.max.x-a/2-s,d=c.min.y- -o/2+s,p=c.max.y-o/2-s,m=c.max.z+n.nearMeters;return l<0&&(t+=Math.abs(l/a)),u>0&&(t+=Math.abs(u/a)),d<0&&(t+=Math.abs(d/o)),p>0&&(t+=Math.abs(p/o)),m>0&&(t+=10*m),e-Math.abs(h)*t}}class le extends ce{constructor(e){super(e),this.type="degree"}evaluate(){const e=this.layout.adapter.metrics.target;return this.getQuaternionScore(e.localOrientation,this.spec)}}class ue extends ce{constructor(e){super(e),this.type="ratio"}evaluate(){const e=this.layout.adapter.metrics.target;return this.getVector3Score(e.worldScale,this.spec)}}class de extends ce{constructor(e){super(e),this.mode="xyz",this._scale=new t,this.type="ratio"}evaluate(){const e=this.layout.adapter.metrics.target,t=this.mode;if(!t)return 0;const s=this._scale.copy(e.worldScale),i="xyz"===t?Math.max(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z)):Math.max(Math.abs(s.x),Math.abs(s.y)),r=s.divideScalar(i);return r.x-1+(r.y-1)+("xyz"===t?r.z-1:r.z>1?1-r.z:0)}}const pe=["x","y","z","diagonal","distance"];class me extends ce{constructor(e){super(e),this.type="meter"}evaluate(){return this.getBoundsScore(this.spec,"spatial")}}class ge extends ce{constructor(e){super(e),this.type="pixel"}evaluate(){var e;return this.attenuateVisualScore(this.getBoundsScore(this.spec,"visual")+this.getBoundsScore(null==(e=this.spec)?void 0:e.absolute,"view"))}}class ye extends ce{constructor(e){super(e),this.minAreaPercent=.2,this.type="pixel"}evaluate(){var e;const t=this.layout.adapter.metrics.target,s=t.visualSize,i=this.layout.adapter.system.viewResolution,r=Math.min(s.x*s.y,i.x*i.y),n=(null==(e=t.referenceState)?void 0:e.visualSize)||i,a=n.x*n.y,o=this.attenuateVisualScore(r)-a*this.minAreaPercent;return 0===o&&console.log(o),o}}class _e extends ce{constructor(e){super(e),this.type="meter",this.absoluteTolerance=1e10}evaluate(){return-this.layout.adapter.metrics.target.visualCenter.length()}}class fe extends oe{constructor(e){super(),this.adapter=e,this.absoluteTolerance={meter:"4mm",pixel:"4px",degree:"0.002deg",ratio:.005},this.successRate=0,this.restartRate=0,this.objectives=new Array,this.referenceNode=null,this.solutions=new Array,this.iteration=0,this.compareSolutions=(e,t)=>{const s=e.bounds.min,i=e.bounds.max;if(isNaN(s.x)||isNaN(s.y)||isNaN(s.z)||isNaN(i.x)||isNaN(i.y)||isNaN(i.z))return 1;const r=this.objectives;if(e.scores.length<r.length)return 1;if(t.scores.length<r.length)return-1;const n=e.isFeasible,a=t.isFeasible;if(n&&!a)return-1;if(a&&!n)return 1;let o=0;const h=this.solutions[0].scores;for(let c=0;c<r.length;c++){const s=e.scores[c],i=t.scores[c];if(isNaN(s))return 1;if(isNaN(i))return-1;const n=r[c],a=n.computedRelativeTolerance,l=n.computedAbsoluteTolerance,u=Math.max(h[c],s,i),d=Math.min(u-Math.abs(u)*a,-l);if(s<d||i<d)return n.sortBlame++,i-s;i-s!=0&&(o=i-s)}return o}}getComputedAbsoluteTolerance(e){return this.adapter.system.measureNumber(this.absoluteTolerance[e],e)}poseRelativeTo(e){return this.referenceNode=e,this}maximize(e){var t;const s=this.maximizeObjective=null!=(t=this.maximizeObjective)?t:new ye(this);return s.priority=-1e3,s.relativeTolerance=.99,this.addObjective(s,e)}orientation(e,t){var s;const i=this.orientationConstraint=null!=(s=this.orientationConstraint)?s:new le(this);return i.spec=e,i.priority=-999,this.addObjective(i,t)}keepAspect(e="xyz",t){var s;const i=this.keepAspectConstraint=null!=(s=this.keepAspectConstraint)?s:new de(this);return i.mode=e,i.priority=-998,this.addObjective(i,t)}scale(e,t){var s;const i=this.scaleConstraint=null!=(s=this.scaleConstraint)?s:new ue(this);return i.spec=e,i.priority=-2,this.addObjective(i,t)}bounds(e,t){var s;const i=this.boundsConstraint=null!=(s=this.boundsConstraint)?s:new me(this);return i.spec=e,this.addObjective(i,t)}visualOrientation(e,t){}visualBounds(e,t){var s,i;const r=this.visualBoundsMeterConstraint=null!=(s=this.visualBoundsMeterConstraint)?s:new ge(this),n=this.visualBoundsPixelConstraint=null!=(i=this.visualBoundsPixelConstraint)?i:new ge(this);return r.spec=e,r.type="meter",n.spec=e,n.type="pixel",this.addObjective(r,t).addObjective(n,t)}magnetize(e){var t;const s=this.magnetizeObjective=null!=(t=this.magnetizeObjective)?t:new _e(this);return s.priority=1e3,s.relativeTolerance=.99,this.addObjective(s,e)}avoidOcclusion(e){var t;const s=this.minimizeOcclusionObjective=null!=(t=this.minimizeOcclusionObjective)?t:new _e(this);return s.priority=11,this.addObjective(s,e)}addObjective(e,t){return Object.assign(e,t),-1===this.objectives.indexOf(e)&&this.objectives.push(e),this.sortObjectives(),this}get hasValidSolution(){var e;return!0===(null==(e=this.solutions[0])?void 0:e.isFeasible)}_prioritySort(e,t){return e.priority===t.priority?e.index-t.index:e.priority-t.priority}sortObjectives(){const e=this.objectives;let t=0;for(const s of e)s.index=t++;e.sort(this._prioritySort)}sortSolutions(){this.solutions.sort(this.compareSolutions),this.bestSolution=this.solutions[0]}}const ve=class{constructor(e){this.layout=void 0,this.orientation=new s,this.bounds=new r,this.scores=[],this.isFeasible=!1,this.mutationStrategies=[{type:"rotate",stepSize:.1},{type:"center",stepSize:.1},{type:"size",stepSize:.1},{type:"minmax",stepSize:.1}],this._mutationWeights=[],e&&(this.layout=e)}get aspectPenalty(){return this.scores[this.layout.objectives.indexOf(this.layout.keepAspectConstraint)]||0}get orientationPenalty(){return this.scores[this.layout.objectives.indexOf(this.layout.orientationConstraint)]||0}get spatialBoundsPenalty(){return this.scores[this.layout.objectives.indexOf(this.layout.boundsConstraint)]||0}_selectStrategy(){const e=this.mutationStrategies,t=this._mutationWeights,s=this.layout.orientationConstraint,i=this.layout.keepAspectConstraint;for(let r=0;r<e.length;r++)t[r]=e[r].stepSize,s&&"rotate"==e[r].type&&this.orientationPenalty>-s.computedAbsoluteTolerance&&(t[r]*=.01),i&&"size"==e[r].type&&this.aspectPenalty<-i.computedAbsoluteTolerance&&(t[r]*=100);return G(e,t)}copy(e){this.layout=e.layout,this.orientation.copy(e.orientation),this.bounds.copy(e.bounds),this.scores.length=0;for(let t=0;t<e.scores.length;t++)this.scores[t]=e.scores[t];return this.isFeasible=e.isFeasible,this}randomize(e){const t=$(e),s=ve._scratchV1.set(0,0,-t),i=this.layout.adapter.system.viewMetrics.target;s.applyMatrix4(i.worldMatrix);const r=this.layout.adapter.metrics.target.parentState;r&&s.applyMatrix4(r.worldMatrixInverse),this.orientation.copy(i.worldOrientation),r&&this.orientation.multiply(r.worldOrientationInverse);const n=this.layout.adapter.metrics.innerBounds,a=n.isEmpty()?ve._scratchV2.set(1,1,1):n.getSize(ve._scratchV2);return a.normalize(),a.multiplyScalar(2*t*Math.tan(5*h)),this.bounds.setFromCenterAndSize(s,a),this}moveTowards(e,t,s){const i=this.bounds.getCenter(ve._center),r=this.bounds.getSize(ve._size),n=e.bounds,a=n.getCenter(ve._otherCenter),o=n.getSize(ve._otherSize);this.orientation.slerp(e.orientation,ve.generatePulseFrequency(t,s)).normalize(),Math.random()<.5?(i.lerp(a,ve.generatePulseFrequency(t,s)),r.lerp(o,ve.generatePulseFrequency(t,s)),this.bounds.setFromCenterAndSize(i,r)):(this.bounds.min.lerp(n.min,ve.generatePulseFrequency(t,s)),this.bounds.max.lerp(n.max,ve.generatePulseFrequency(t,s)))}perturb(){var e;const t=this._selectStrategy(),s=t.type;let i=t.stepSize;if("rotate"===s||Math.random()<.001){const t=null==(e=this.layout.orientationConstraint)?void 0:e.spec;if((null==t?void 0:t.isQuaternion)&&this.orientationPenalty<t.computedAbsoluteTolerance&&Math.random()<.01)this.orientation.copy(t);else{const e=Math.min($(1e-4*Math.min(i,1)),1);this.orientation.multiply(Q(e,e)).normalize()}}const r=this.bounds,n=r.getCenter(ve._center),a=r.getSize(ve._size);if("center"===s){const e=ve._direction.set(0,0,1).applyQuaternion(Q(1,1));e.setLength(q(i)).multiplyScalar(a.length()),n.add(e)}if("size"===s){const e=2**q(i);a.multiplyScalar(e)}if(a.clampScalar(this.layout.adapter.system.epsillonMeters/10,1e20),r.setFromCenterAndSize(n,a),"minmax"===s){const e=ve._direction.set(0,0,1).applyQuaternion(Q(1,1));e.setLength(q(i)).multiply(a),Math.random(),r.min.add(e)}const o=r.min,h=r.max;return o.x>h.x&&this._swap(o,h,"x"),o.y>h.y&&this._swap(o,h,"y"),o.z>h.z&&this._swap(o,h,"z"),t}_swap(e,t,s){const i=e[s],r=t[s];e[s]=r,t[s]=i}static generatePulseFrequency(e,t){return e+Math.random()*(t-e)}apply(e=!0){const t=this.layout,s=t.adapter;if(s.referenceNode=t.referenceNode,s.orientation.target=this.orientation,s.bounds.target=this.bounds,s.metrics.invalidateStates(),e){this.isFeasible=!0;for(let e=0;e<t.objectives.length;e++){const s=t.objectives[e],i=this.scores[e]=s.evaluate();(i<-s.computedAbsoluteTolerance||!isFinite(i))&&(this.isFeasible=!1)}}}};let be=ve;be._scratchV1=new t,be._scratchV2=new t,be._direction=new t,be._center=new t,be._size=new t,be._otherCenter=new t,be._otherSize=new t;const we=c;class xe{constructor(e){e&&Object.assign(this,e)}}class Me{constructor(e){e&&Object.assign(this,e)}}class Te extends Me{constructor(i,n,a,o=i.transition){super(a),this.system=i,this.parentConfig=o,this.needsUpdate=!1,this._size=new t,this.queue=[],this.enabled=!1,this.forceWait=!1,this._forceCommit=!1,this._resolvedConfig=new Me,this.delayTime=0,this.debounceTime=0,this._previousStatus="unchanged",this._status="unchanged",this._scratchV2=new e,this._scratchV3=new t,this._scratchQ=new s,this._scratchBox=new r,this._scratchColor=new l,this._blackColor=new l(0,0,0),this._addTransitionToCurrent=(e,t,s)=>{const i=s.duration>0?s.easing(Math.min(s.elapsed/s.duration,1)):1,r=s.target;if("number"!=typeof r){if("isVector3"in r){const s=e,n=t,a=r,o=this._scratchV3.copy(a).sub(n).lerp(O,1-i);this._current=s.add(o)}else if("isVector2"in r){const s=e,n=t,a=r,o=this._scratchV2.copy(a).sub(n).lerp(A,1-i);this._current=s.add(o)}else if("isQuaternion"in r){const s=e,n=t,a=r,o=this._scratchQ.copy(n).invert().multiply(a).slerp(P,1-i);this._current=s.multiply(o).normalize()}else if("isColor"in r){const s=e,n=t,a=r,o=this._scratchColor.copy(a).sub(n).lerp(this._blackColor,1-i);this._current=s.add(o)}else if("isBox3"in r){const s=e,n=t,a=r,o=this._scratchBox.min.copy(a.min).sub(n.min).lerp(O,1-i),h=this._scratchBox.max.copy(a.max).sub(n.max).lerp(O,1-i);return s.min.add(o),s.max.add(h),void(this._current=s)}}else this._current=e+u(r-t,0,1-i)},this.reset(n),this._previousTarget=this._copy(this._previousTarget,this.target)}_copy(e,t){if(void 0===t)return;if("number"==typeof t)return t;const s=e?e.copy(t):t.clone();if(s&&"isBox3"in s){const e=s,t=e.getSize(this._size);!e.isEmpty()&&isFinite(t.x)&&isFinite(t.y)&&isFinite(t.z)||e.setFromCenterAndSize(O,O)}return s}_isEqual(e,t){return void 0!==e&&void 0!==t&&(e===t||("number"==typeof e?e===t:(null==e?void 0:e.equals(t))||!1))}reset(e){this._start=this._copy(this._start,e),this._current=this._copy(this._current,e),this._target=this._copy(this._target,e),this.queue.length=0}set start(e){this._start=this._copy(this._start,e)}get start(){return this._start}set current(e){this._current=this._copy(this._current,e)}get current(){return this._current}set reference(e){this._reference=this._copy(this._reference,e)}get reference(){return this._reference}set target(e){this.enabled=!0,this._target=this._copy(this._target,e)}get target(){return this._target}get progress(){if(!this.enabled)return 1;if(this.queue.length>0){const e=this.queue[this.queue.length-1];return 0===e.duration?0:e.elapsed/e.duration}return 1}get forceCommit(){return this._forceCommit}set forceCommit(e){this._forceCommit!==e&&(this._forceCommit=e)}get relativeDifference(){var e;const t=(null==(e=this.queue[this.queue.length-1])?void 0:e.target)||this.start;return void 0!==this.target?V(t,this.target):0}get referenceRelativeDifference(){return void 0!==this.reference&&void 0!==this.target?V(this.reference,this.target):1/0}get resolvedConfig(){var e,t,s,i,r,n,a,o,h,c,l,u,d,p,m,g;const y=this._resolvedConfig,_=this.parentConfig,f=this.system.transition;return y.multiplier=null!=(t=null!=(e=this.multiplier)?e:null==_?void 0:_.multiplier)?t:f.multiplier,y.duration=null!=(i=null!=(s=this.duration)?s:null==_?void 0:_.duration)?i:f.duration,y.easing=null!=(n=null!=(r=this.easing)?r:null==_?void 0:_.easing)?n:f.easing,y.threshold=null!=(o=null!=(a=this.threshold)?a:null==_?void 0:_.threshold)?o:f.threshold,y.delay=null!=(c=null!=(h=this.delay)?h:null==_?void 0:_.delay)?c:f.delay,y.debounce=null!=(u=null!=(l=this.debounce)?l:null==_?void 0:_.debounce)?u:f.debounce,y.maxWait=null!=(p=null!=(d=this.maxWait)?d:null==_?void 0:_.maxWait)?p:f.maxWait,y.blend=null!=(g=null!=(m=this.blend)?m:null==_?void 0:_.blend)?g:f.blend,y}get previousStatus(){return this._previousStatus}get status(){return this.needsUpdate&&(this._previousStatus=this._status,this._status=this._computeStatus()),this._status}_computeStatus(){if(this.forceCommit)return"committing";const e=this.resolvedConfig,t=e.threshold,s=this.system.deltaTime*e.multiplier,i=this.delayTime+s,r=this.debounceTime+s;if(!(this.relativeDifference>t))return"unchanged";if(!this.forceWait&&(i>=e.delay&&r>=e.debounce||i>=e.maxWait))return"committing";return this.referenceRelativeDifference<t?"settling":"changed"}_updateTransitionable(){var e,t,s,i,r;const n=this.system.deltaTime,a=this.resolvedConfig,o=this.queue,h=this.status,c=n*a.multiplier;for(;o.length&&o[0].elapsed>=o[0].duration;)this.start=o.shift().target;this.current=this.start;const l=this._current;let u=this.start;for(const d of o)if(this._addTransitionToCurrent(l,u,d),u=d.target,d.elapsed+=c,!d.blend)break;switch(this.debounceTime+=c,h){case"settling":break;case"changed":this.delayTime+=c,this.reference=this.target;break;case"unchanged":this.reference=void 0,this.delayTime=0;break;case"committing":this.delayTime=0,this.debounceTime=0;const n="object"==typeof this.forceCommit?this.forceCommit:new xe;n.target=null!=(e=n.target)?e:this._copy(void 0,this.target),n.duration=null!=(t=n.duration)?t:a.duration,n.easing=null!=(s=n.easing)?s:a.easing,n.blend=null!=(i=n.blend)?i:a.blend,n.elapsed=null!=(r=n.elapsed)?r:0,o.push(n),this.forceCommit=!1}this.forceWait=!1}_swap(e,t,s){const i=e[s],r=t[s];e[s]=r,t[s]=i}update(e=!1){if(!this.needsUpdate&&!e)return;if(this._isEqual(this._previousTarget,this.target)||(this._target=this._target,this.enabled=!0),this._previousTarget=this._copy(this._previousTarget,this.target),!this.enabled)return;const t=this.syncGroup;if(!this.forceCommit&&t)for(const s of t)if(s.enabled&&"committing"===s.status){for(const e of t)e.needsUpdate&&!1===e.forceCommit&&(e.forceCommit=!0);break}this._updateTransitionable(),this.needsUpdate=!1}set syncGroup(e){this._syncGroup&&this._syncGroup.delete(this),this._syncGroup=e,null==e||e.add(this)}get syncGroup(){return this._syncGroup}}class Se{constructor(e,t){this.system=e,this.node=t,this.measureBoundsCache=new Map,this.transition=new Me,this.referenceNode=void 0,this._parentAdapter=null,this.layouts=new Array,this.layoutFeasibleTime=0,this.layoutInfeasibleTime=0,this._prevLayout=null,this._activeLayout=null,this._progress=1,this._hasValidContext=!1,this._prevNodeOrientation=new s,this._prevNodeBounds=new r,this.metrics=this.system.getMetrics(this.node);const i=this.metrics.raw;this._orientation=new Te(this.system,i.localOrientation,void 0,this.transition),this._bounds=new Te(this.system,i.spatialBounds,void 0,this.transition),this._opacity=new Te(this.system,i.opacity,void 0,this.transition),this._outerOrigin=new Te(this.system,i.outerOrigin,void 0,this.transition),this._outerOrientation=new Te(this.system,i.outerOrientation,void 0,this.transition),this._outerBounds=new Te(this.system,i.outerBounds,void 0,this.transition),this._outerVisualBounds=new Te(this.system,i.outerVisualBounds,void 0,this.transition),this._outerOrigin.debounce=0,this._outerOrigin.delay=0,this._outerOrientation.debounce=0,this._outerOrientation.delay=0,this._outerBounds.debounce=0,this._outerBounds.delay=0,this._outerVisualBounds.debounce=0,this._outerVisualBounds.delay=0,this._orientation.syncGroup=this._bounds.syncGroup=this._opacity.syncGroup=new Set}measureBounds(e,t,s){var i,r,n;const a=this.system,o=a.mathScope,h=a.math,c="spatial"===t||"front"===s||"back"===s||"centerz"===s||"sizez"===s?o.meter:o.pixel,l=c===o.meter?"m":"px";"number"==typeof e&&(e=""+e+l);const u=t+"-"+s+" = "+e;if(null==(i=this.measureBoundsCache)?void 0:i.has(u))return this.measureBoundsCache.get(u);if(!a.mathCompiledExpressions.has(e)){const t=h.parse(e.replace("%","percent")).compile();a.mathCompiledExpressions.set(e,t)}const d=a.mathCompiledExpressions.get(e),p=a.viewMetrics.target,m=this.metrics.target;let g,y,_;switch(t){case"spatial":g=m.outerBounds,y=m.outerCenter;break;case"visual":g=m.outerVisualBounds,y=m.outerVisualCenter;break;case"view":g=p.visualBounds,y=p.visualCenter;break;default:throw new Error(`Unknown measure type "${t}.${s}"`)}if(e.includes("%")){const e="spatial"===t?m.outerSize:null!=(r=m.outerVisualSize)?r:p.visualSize;let i=0;switch(s){case"left":case"centerx":case"right":case"sizex":i=h.unit(e.x/100,l);break;case"bottom":case"centery":case"top":case"sizey":i=h.unit(e.y/100,l);break;case"back":case"centerz":case"front":case"sizez":i=h.unit(e.z/100,"m");break;case"sizediagonal":i="spatial"===t?h.unit(e.length()/100,"m"):h.unit(Math.sqrt(e.x**2+e.y**2)/100,"px");break;default:throw new Error(`Invalid measure subtype "${t}.${s}" for percentage units`)}o.percent=i}switch(s){case"left":_=g.min.x;break;case"centerx":_=y.x;break;case"right":_=g.max.x;break;case"bottom":_=g.min.y;break;case"centery":_=y.y;break;case"top":_=g.max.y;break;case"front":_=g.min.z;break;case"centerz":_=y.z;break;case"back":_=g.max.z;break;case"centerdistance":default:_=0}let f=d.evaluate(o);return"object"==typeof f&&(f=h.number(f,c)),_+=f,o.percent=void 0,null==(n=this.measureBoundsCache)||n.set(u,_),_}get outerOrigin(){return this._outerOrigin}get outerOrientation(){return this._outerOrientation}get outerBounds(){return this._outerBounds}get outerVisualBounds(){return this._outerVisualBounds}get parentAdapter(){return this._parentAdapter}_computeParentAdapter(){let e=this.metrics;for(;e=e.parentMetrics;){const t=this.system.nodeAdapters.get(e.node);if(t)return t}return null}get orientation(){return this._orientation}get bounds(){return this._bounds}get opacity(){return this._opacity}get previousLayout(){return this._prevLayout}set activeLayout(e){this._prevLayout=this._activeLayout,this._activeLayout=e}get activeLayout(){return this._activeLayout}get progress(){return this._progress}_computeProgress(){return Math.min(this.orientation.progress,this.bounds.progress,this.opacity.progress)}createLayout(){const e=new fe(this);return this.layouts.push(e),e}get hasValidContext(){return this._hasValidContext}_computeHasValidContext(){var e;const t=this.parentAdapter;return!t||!!t.hasValidContext&&(0===t.layouts.length||!!(null==(e=t.activeLayout)?void 0:e.hasValidSolution))}_update(){var e;this._parentAdapter=this._computeParentAdapter(),this._hasValidContext=this._computeHasValidContext();const t=this.metrics;if(t.referenceMetrics&&(this.outerOrigin.target.copy(t.referenceMetrics.target.worldCenter),this.outerOrientation.target.copy(t.referenceMetrics.target.worldOrientation),this.outerBounds.target.copy(t.referenceMetrics.innerBounds),this.outerBounds.target.applyMatrix4(t.target.spatialFromReference),this.outerVisualBounds.target.copy(t.referenceMetrics.target.visualBounds)),this.outerOrigin.update(),this.outerOrientation.update(),this.outerBounds.update(),this.outerVisualBounds.update(),this.onUpdate){this.onUpdate(),t.invalidateIntrinsicBounds(),t.invalidateInnerBounds(),t.invalidateStates();const e=t.raw;if(!this.system.optimizer.update(this)){const s=t.target.parent!==e.parent;s&&(this.referenceNode=void 0);const i=t.target.localOrientation,r=e.localOrientation;(s||i.angleTo(r)>this.system.epsillonRadians)&&(this.orientation.target=r);const n=t.target.spatialBounds,a=e.spatialBounds;(s||n.min.distanceTo(a.min)>this.system.epsillonMeters||n.max.distanceTo(a.max)>this.system.epsillonMeters)&&(this.bounds.target=a)}}else t.invalidateIntrinsicBounds(),t.invalidateInnerBounds(),t.invalidateStates(),this.system.optimizer.update(this);this.opacity.update(),this.orientation.update(),this.bounds.update(),this._progress=this._computeProgress(),t.invalidateStates(),this.system.bindings.apply(t,t.current),t.invalidateStates(),null==(e=this.onPostUpdate)||e.call(this)}}class Re{constructor(){this._cache=new X,this.isLayoutFrustum=!0,this._leftDegrees=-20,this._rightDegrees=20,this._bottomDegrees=-20,this._topDegrees=20,this._nearMeters=.5,this._farMeters=1e3,this._size=new e,this._center=new e,this._v1=new t,this._inverseProjection=new n,this._forwardDirection=new t(0,0,-1),this._fullNDC=new r(new t(-1,-1,-1),new t(1,1,1)),this._cachedPerspectiveProjectionMatrix=this._cache.memoize((()=>{const e=this.nearMeters,t=this.farMeters,s=e*Math.tan(this.leftDegrees*h),i=e*Math.tan(this.rightDegrees*h),r=e*Math.tan(this.topDegrees*h),n=e*Math.tan(this.bottomDegrees*h);return this._perspective.makePerspective(s,i,r,n,e,t)})),this._perspective=new n,this._boxA=new i,this._boxB=new i,this._overlapSize=new e}get leftDegrees(){return this._leftDegrees}set leftDegrees(e){e!==this._leftDegrees&&(this._leftDegrees=e,this._cache.invalidateAll())}get rightDegrees(){return this._rightDegrees}set rightDegrees(e){e!==this._rightDegrees&&(this._rightDegrees=e,this._cache.invalidateAll())}get bottomDegrees(){return this._bottomDegrees}set bottomDegrees(e){e!==this._bottomDegrees&&(this._bottomDegrees=e,this._cache.invalidateAll())}get topDegrees(){return this._topDegrees}set topDegrees(e){e!==this._topDegrees&&(this._topDegrees=e,this._cache.invalidateAll())}get nearMeters(){return this._nearMeters}set nearMeters(e){e!==this._nearMeters&&(this._nearMeters=e,this._cache.invalidateAll())}get farMeters(){return this._farMeters}set farMeters(e){e!==this._farMeters&&(this._farMeters=e,this._cache.invalidateAll())}get sizeDegrees(){return this._size.set(this.rightDegrees-this.leftDegrees,this.topDegrees-this.bottomDegrees),this._size}get diagonalDegrees(){const e=this.sizeDegrees;return Math.acos(Math.cos(e.x*h)*Math.cos(e.y*h))*o}get centerDegrees(){const e=this.sizeDegrees;return this._center.set(this.leftDegrees+e.x/2,this.bottomDegrees+e.y/2)}get angleToCenter(){const e=this.centerDegrees;return Math.acos(Math.cos(e.x*h)*Math.cos(e.y*h))*o}get angleToTopLeft(){return Math.acos(Math.cos(this.leftDegrees*h)*Math.cos(this.topDegrees*h))*o}get angleToTopRight(){return Math.acos(Math.cos(this.rightDegrees*h)*Math.cos(this.topDegrees*h))*o}get angleToBottomLeft(){return Math.acos(Math.cos(this.leftDegrees*h)*Math.cos(this.bottomDegrees*h))*o}get angleToBottomRight(){return Math.acos(Math.cos(this.rightDegrees*h)*Math.cos(this.bottomDegrees*h))*o}get angleToClosestPoint(){const e=Math.min(Math.max(0,this.leftDegrees),this.rightDegrees),t=Math.min(Math.max(0,this.bottomDegrees),this.topDegrees);return Math.acos(Math.cos(e*h)*Math.cos(t*h))*o}get angleToFarthestPoint(){return Math.max(this.angleToTopLeft,this.angleToTopRight,this.angleToBottomLeft,this.angleToBottomRight)}get depth(){return this.farMeters-this.nearMeters}get distance(){return this.nearMeters+this.depth/2}get aspectRatio(){const e=this.nearMeters,t=e*Math.tan(this.leftDegrees*h),s=e*Math.tan(this.rightDegrees*h);return(e*Math.tan(this.topDegrees*h)-e*Math.tan(this.bottomDegrees*h))/(s-t)}setFromPerspectiveProjectionMatrix(e,t=this._fullNDC){const s=this._inverseProjection.copy(e).invert(),i=this._v1,r=this._forwardDirection,n=Math.sign(t.min.x)*i.set(t.min.x,0,-1).applyMatrix4(s).angleTo(r)*o,a=Math.sign(t.max.x)*i.set(t.max.x,0,-1).applyMatrix4(s).angleTo(r)*o,h=Math.sign(t.max.y)*i.set(0,t.max.y,-1).applyMatrix4(s).angleTo(r)*o,c=Math.sign(t.min.y)*i.set(0,t.min.y,-1).applyMatrix4(s).angleTo(r)*o,l=-i.set(0,0,t.min.z).applyMatrix4(s).z,u=-i.set(0,0,t.max.z).applyMatrix4(s).z;return this.leftDegrees=n,this.rightDegrees=a,this.topDegrees=h,this.bottomDegrees=c,this.nearMeters=l,this.farMeters=u,this}get perspectiveProjectionMatrix(){return this._cachedPerspectiveProjectionMatrix()}overlapPercent(e){this._boxA.min.x=this.leftDegrees,this._boxA.max.x=this.rightDegrees,this._boxA.min.y=this.bottomDegrees,this._boxA.max.y=this.topDegrees,this._boxB.min.x=e.leftDegrees,this._boxB.max.x=e.rightDegrees,this._boxB.min.y=e.bottomDegrees,this._boxB.max.y=e.topDegrees;return this._boxA.intersect(this._boxB).getSize(this._overlapSize).length()/this.sizeDegrees.length()}}class Ee{constructor(t,s){this.viewNode=t,this.bindings=s,this.math=d({evaluateDependencies:p,addDependencies:m,subtractDependencies:g,multiplyDependencies:y,divideDependencies:_,modDependencies:f,numberDependencies:v,createUnitDependencies:b,unitDependencies:w},{predictable:!0}),this.mathCompiledExpressions=new Map,this.mathScope={ratio:void 0,degree:this.math.unit("degree"),meter:this.math.unit("meter"),pixel:this.math.createUnit("pixel",{aliases:["pixels","px"]}),percent:void 0,vdeg:void 0,vw:void 0,vh:void 0},this.epsillonMeters=1e-10,this.epsillonRadians=1e-10,this.epsillonRatio=1e-10,this.transition=new Me({multiplier:1,duration:0,easing:we.easeInOut,threshold:0,delay:0,debounce:0,maxWait:10,blend:!0}),this.optimize=new oe({minFeasibleTime:.05,maxInfeasibleTime:10,relativeTolerance:.6,maxIterationsPerFrame:30,swarmSize:40,pulseFrequencyMin:0,pulseFrequencyMax:1,pulseRate:.1,stepSizeMin:1e-6,stepSizeMax:4,stepSizeStart:1.5}),this.optimizer=new he(this),this.viewFrustum=new Re,this.viewResolution=new e(1e3,1e3),this.deltaTime=1/60,this.time=0,this.maxDeltaTime=1/60,this.nodeMetrics=new Map,this.nodeAdapters=new Map,this.transitionables=[],this.getMetrics=e=>{if(!e)throw new Error("node must be defined");let t=this.nodeMetrics.get(e);return t||(t=new ae(this,e),this.nodeMetrics.set(e,t)),t},this.getState=e=>{if(!e)throw new Error("node must be defined");return this.getMetrics(e).target},this.getAdapter=e=>{let t=this.nodeAdapters.get(e);return t||(t=new Se(this,e),this.nodeAdapters.set(e,t)),t},this.createTransitionable=(e,t)=>{const s=new Te(this,e,t,this.transition);return this.transitionables.push(s),s},this._prevResolution=new e,this._prevSize=new e,this.measureNumberCache=new Map}get viewMetrics(){if(!this.viewNode)throw new Error("EtherealSystem.viewNode must be defined");return this.getMetrics(this.viewNode)}update(e,t){this.deltaTime=Math.max(e,this.maxDeltaTime),this.time=t,this._prevResolution.equals(this.viewResolution)&&this._prevSize.equals(this.viewFrustum.sizeDegrees)||(this.mathScope.vdeg=this.math.unit(this.viewResolution.y/this.viewFrustum.sizeDegrees.y,"px"),this.mathScope.vw=this.math.unit(this.viewResolution.x/100,"px"),this.mathScope.vh=this.math.unit(this.viewResolution.y/100,"px"),this.measureNumberCache.clear()),this._prevResolution.copy(this.viewResolution),this._prevSize.copy(this.viewFrustum.sizeDegrees);for(const s of this.nodeMetrics.values()){s.needsUpdate=!0;const e=this.nodeAdapters.get(s.node);e&&(e.opacity.needsUpdate=!0,e.orientation.needsUpdate=!0,e.bounds.needsUpdate=!0,e.outerOrigin.needsUpdate=!0,e.outerOrientation.needsUpdate=!0,e.outerBounds.needsUpdate=!0,e.outerVisualBounds.needsUpdate=!0)}for(const s of this.transitionables)s.needsUpdate=!0;for(const s of this.transitionables)s.update();this.viewMetrics.update();for(const s of this.nodeAdapters.values())s.metrics.update()}measureNumber(e,t){var s,i;if("number"==typeof e)return e;if(null==(s=this.measureNumberCache)?void 0:s.has(e))return this.measureNumberCache.get(e);if(!this.mathCompiledExpressions.has(e)){const t=this.math.parse(e).compile();this.mathCompiledExpressions.set(e,t)}const r=this.mathCompiledExpressions.get(e),n=r.evaluate(this.mathScope),a="number"==typeof n?n:this.math.number(r.evaluate(this.mathScope),t);return null==(i=this.measureNumberCache)||i.set(e,a),a}}const ze=new t;class Ce{constructor(e=0,t=0,s=0){this.horizontalRadians=e,this.verticalRadians=t,this.distance=s}get horizontalDegrees(){return this.horizontalRadians*o}set horizontalDegrees(e){this.horizontalRadians=e*h}get verticalDegrees(){return this.verticalRadians*o}set verticalDegrees(e){this.verticalRadians=e*h}setWithRadians(e,t,s){return this.horizontalRadians=e,this.verticalRadians=t,this.distance=s,this}setWithDegrees(e,t,s){return this.horizontalDegrees=e,this.verticalDegrees=t,this.distance=s,this}fromCartesianDirection(e){const t=ze.copy(e).normalize();return this.verticalRadians=Math.asin(t.y)*o,this.horizontalRadians=Math.atan2(t.x,-t.z)*o,this.distance=0,this}fromCartesianPosition(e){return this.fromCartesianDirection(e),this.distance=e.length(),this}toCartesianDirection(e){const t=this.verticalRadians,s=-Math.PI-this.horizontalRadians,i=Math.sin(t),r=Math.cos(t)*Math.sin(s),n=-Math.cos(t)*Math.cos(s);return e.set(r,i,n).normalize()}toCartesianPosition(e){return this.toCartesianDirection(e).multiplyScalar(this.distance)}}function Le(e,t,s,i=0){i++;for(let r=e.firstChild;r;r=r.nextSibling)if(r.nodeType===Node.ELEMENT_NODE){const e=r;t.call(s,e,i)&&Le(e,t,s,i)}}function Be(e,t,s,i){"insertRule"in e?e.insertRule(t+"{"+s+"}",i):"addRule"in e&&e.addRule(t,s,i)}class Ae{constructor(){this.left=0,this.top=0,this.width=0,this.height=0}copy(e){return this.top=e.top,this.left=e.left,this.width=e.width,this.height=e.height,this}}class Ie{constructor(){this.left=0,this.top=0,this.right=0,this.bottom=0}copy(e){return this.top=e.top,this.left=e.left,this.right=e.right,this.bottom=e.bottom,this}}function Oe(e,t=new Ae,s){const i=e.ownerDocument,r=i.documentElement,n=i.body;if(e===r)return function(e,t){const s=e.documentElement,i=e.body,r=getComputedStyle(s),n=getComputedStyle(i);return t.top=i.offsetTop+parseFloat(r.marginTop)||0+parseFloat(n.marginTop)||0,t.left=i.offsetLeft+parseFloat(r.marginLeft)||0+parseFloat(n.marginLeft)||0,t.width=Math.max(Math.max(i.scrollWidth,s.scrollWidth),Math.max(i.offsetWidth,s.offsetWidth),Math.max(i.clientWidth,s.clientWidth)),t.height=Math.max(Math.max(i.scrollHeight,s.scrollHeight),Math.max(i.offsetHeight,s.offsetHeight),Math.max(i.clientHeight,s.clientHeight)),t}(i,t);if(s===e)return t.left=0,t.top=0,t.width=e.offsetWidth,void(t.height=e.offsetHeight);const a=e.ownerDocument.defaultView;let o,h=e,c=h.offsetParent,l=a.getComputedStyle(h,null),u=h.offsetTop,d=h.offsetLeft;for(c&&s&&c.contains(s)&&c!==s&&(Oe(s,t,c),d-=t.left,u-=t.top);(h=h.parentElement)&&h!==n&&h!==r&&h!==s&&"fixed"!==l.position;)o=a.getComputedStyle(h,null),u-=h.scrollTop,d-=h.scrollLeft,h===c&&(u+=h.offsetTop,d+=h.offsetLeft,u+=parseFloat(o.borderTopWidth)||0,d+=parseFloat(o.borderLeftWidth)||0,c=h.offsetParent),l=o;return"fixed"===l.position&&(u+=Math.max(r.scrollTop,n.scrollTop),d+=Math.max(r.scrollLeft,n.scrollLeft)),t.left=d,t.top=u,t.width=e.offsetWidth,t.height=e.offsetHeight,t}const Ne=document.createElement("div");function De(e){const t=document.createElement("div");t.innerHTML=e;const s=t.firstElementChild;return t.removeChild(s),s}Ne.id="VIEWPORT",Ne.style.position="fixed",Ne.style.width="100vw",Ne.style.height="100vh",Ne.style.visibility="hidden",Ne.style.pointerEvents="none";const Fe=class{constructor(e,t){this.element=e,this.eventCallback=t,this.needsRefresh=!0,this.needsRemoval=!1,this.psuedoStates={hover:!1,active:!1,focus:!1,target:!1},this.svgImage=new Image,this.bounds=new Ae,this.padding=new Ie,this.margin=new Ie,this.border=new Ie,this.childLayers=[],this.cachedBounds=new Map,this.cachedMargin=new Map,this._dynamicAttributes="",this._svgDocument="",this._rasterizingDocument="",this._svgSrc="",this._hashingCanvas=document.createElement("canvas"),qe.layers.set(e,this),this.id=e.getAttribute(qe.ELEMENT_UID_ATTRIBUTE)||qe.generateElementUID(),e.setAttribute(qe.ELEMENT_UID_ATTRIBUTE,this.id),e.setAttribute(qe.LAYER_ATTRIBUTE,""),this.parentLayer=qe.getClosestLayer(this.element.parentElement),this.eventCallback("layercreated",{target:e}),Fe.cachedCanvases.limit=qe.layers.size*Fe.DEFAULT_CACHE_SIZE,this._hashingCanvas.width=20,this._hashingCanvas.height=20}set canvas(e){this._canvas!==e&&(this._canvas=e,this.eventCallback&&this.eventCallback("layerpainted",{target:this.element}))}get canvas(){return this._canvas}get depth(){let e=0,t=this;for(;t.parentLayer;)t=t.parentLayer,e++;return e}get rootLayer(){let e=this;for(;e.parentLayer;)e=e.parentLayer;return e}traverseParentLayers(e){const t=this.parentLayer;t&&(t.traverseParentLayers(e),e(t))}traverseLayers(e){e(this),this.traverseChildLayers(e)}traverseChildLayers(e){for(const t of this.childLayers)t.traverseLayers(e)}refresh(){Oe(this.element,this.bounds,this.parentLayer&&this.parentLayer.element),this.needsRefresh=!1,this._updateParentAndChildLayers(),qe.addToSerializeQueue(this)}_updateParentAndChildLayers(){const e=this.element,t=this.childLayers,s=t.slice(),i=this.parentLayer;this.parentLayer=qe.getClosestLayer(this.element.parentElement),i!==this.parentLayer&&(this.parentLayer&&this.parentLayer.childLayers.push(this),this.eventCallback("layermoved",{target:e})),t.length=0,Le(e,this._tryConvertElementToWebLayer,this);for(const r of s){qe.getClosestLayer(r.element.parentElement)||(r.needsRemoval=!0,t.push(r))}}_tryConvertElementToWebLayer(e){if(this.needsRemoval)return!1;const t=e,s=getComputedStyle(t);t.getAttribute(qe.ELEMENT_UID_ATTRIBUTE)||t.setAttribute(qe.ELEMENT_UID_ATTRIBUTE,qe.generateElementUID());if(t.hasAttribute(qe.LAYER_ATTRIBUTE)||"VIDEO"===t.nodeName||"none"!==s.transform){let e=qe.layers.get(t);return e||(e=new Fe(t,this.eventCallback)),this.childLayers.push(e),!1}return!0}async serialize(){if("VIDEO"===this.element.nodeName)return;let{width:e,height:t}=this.bounds;if(e*t>0){!function(e,t){let s=getComputedStyle(e);t.left=parseFloat(s.paddingLeft)||0,t.right=parseFloat(s.paddingRight)||0,t.top=parseFloat(s.paddingTop)||0,t.bottom=parseFloat(s.paddingBottom)||0}(this.element,this.padding),function(e,t){let s=getComputedStyle(e);t.left=parseFloat(s.marginLeft)||0,t.right=parseFloat(s.marginRight)||0,t.top=parseFloat(s.marginTop)||0,t.bottom=parseFloat(s.marginBottom)||0}(this.element,this.margin),function(e,t){let s=getComputedStyle(e);t.left=parseFloat(s.borderLeftWidth)||0,t.right=parseFloat(s.borderRightWidth)||0,t.top=parseFloat(s.borderTopWidth)||0,t.bottom=parseFloat(s.borderBottomWidth)||0}(this.element,this.border),e+=Math.max(this.margin.left,0)+Math.max(this.margin.right,0),t+=Math.max(this.margin.top,0)+Math.max(this.margin.bottom,0);const s=qe.attributeHTML(qe.ELEMENT_UID_ATTRIBUTE,""+this.id),i=this.element,r="inline"===getComputedStyle(i).display;qe.updateInputAttributes(i);const n=qe.serializer.serializeToString(i).replace(s,`${s} ${qe.RENDERING_ATTRIBUTE}="" ${r?`${qe.RENDERING_INLINE_ATTRIBUTE}="" `:" "} `+qe.getPsuedoAttributes(this.psuedoStates)),a=this._getParentsHTML(i);a[0]=a[0].replace("html","html "+qe.RENDERING_DOCUMENT_ATTRIBUTE+'="" ');const[o]=await Promise.all([qe.getEmbeddedCSS(this.element),qe.embedExternalResources(this.element)]),h='<svg width="'+e+'" height="'+t+'" xmlns="http://www.w3.org/2000/svg"><defs><style type="text/css"><![CDATA[a[href]{color:#0000EE;text-decoration:underline;}'+o.join("")+']]></style></defs><foreignObject x="0" y="0" width="'+e+'" height="'+t+'">'+a[0]+n+a[1]+"</foreignObject></svg>",c=this._svgDocument=h,l=Fe.canvasHashes.get(c);if(l&&Fe.cachedCanvases.has(l))return void(this.canvas=Fe.cachedCanvases.get(l));this.cachedBounds.set(c,(new Ae).copy(this.bounds)),this.cachedMargin.set(c,(new Ie).copy(this.margin)),qe.addToRasterizeQueue(this)}}async rasterize(){return new Promise((e=>{this.svgImage.onload=()=>{qe.addToRenderQueue(this),e()},this._rasterizingDocument=this._svgDocument,this.svgImage.src=this._svgSrc="data:image/svg+xml;utf8,"+encodeURIComponent(this._svgDocument),this.svgImage.complete&&this.svgImage.currentSrc===this.svgImage.src&&(qe.addToRenderQueue(this),this.svgImage.onload=null,e())}))}render(){const e=this._rasterizingDocument;if(!this.cachedBounds.has(e)||!this.cachedMargin.has(e))return void(this.needsRefresh=!0);if(!this.svgImage.complete)return void qe.addToRenderQueue(this);let{width:t,height:s}=this.cachedBounds.get(e),{left:i,top:r}=this.cachedMargin.get(e);const n=this._hashingCanvas;let a=n.width,o=n.height;const h=n.getContext("2d");h.clearRect(0,0,a,o),h.imageSmoothingEnabled=!1,h.drawImage(this.svgImage,i,r,t,s,0,0,a,o);const c=h.getImageData(0,0,a,o).data,l=qe.arrayBufferToBase64(M.exports.hash(new Uint8Array(c)))+"?w="+t+";h="+s;Fe.canvasHashes.set(e,l);const u=Fe.blankRetryCounts.get(e)||0;if(qe.isBlankImage(c)&&u<10)return Fe.blankRetryCounts.set(e,u+1),void setTimeout((()=>qe.addToRenderQueue(this)),500);if(Fe.cachedCanvases.has(l))return void(this.canvas=Fe.cachedCanvases.get(l));const d=this.pixelRatio||parseFloat(this.element.getAttribute(qe.PIXEL_RATIO_ATTRIBUTE))||window.devicePixelRatio,p=Fe.cachedCanvases.size===Fe.cachedCanvases.limit?Fe.cachedCanvases.shift()[1]:document.createElement("canvas");let m=p.width=t*d,g=p.height=s*d;const y=p.getContext("2d");y.imageSmoothingEnabled=!1,y.clearRect(0,0,m,g),y.drawImage(this.svgImage,i,r,t,s,0,0,m,g),Fe.cachedCanvases.set(l,p),this.canvas=p}_getParentsHTML(e){const t=[],s=[];let i=e.parentElement;i||(i=document.documentElement);do{let e=i.tagName.toLowerCase(),r=" ";for(const t of i.attributes)"style"!==t.name&&(r+=`${t.name}="${t.value}" `);const n="<"+e+("html"===e?` xmlns="http://www.w3.org/1999/xhtml" style="--x-width:${this.bounds.width}px;--x-height:${this.bounds.height}px;--x-inline-top:${this.border.top+this.margin.top+this.padding.top}px" `:"")+r+`${qe.RENDERING_PARENT_ATTRIBUTE}=""  >`;t.unshift(n);const a="</"+e+">";if(s.push(a),"html"==e)break}while(i=i.parentElement);return[t.join(""),s.join("")]}};let Ue=Fe;Ue.DEFAULT_CACHE_SIZE=4,Ue.blankRetryCounts=new Map,Ue.canvasHashes=new x.LRUMap(1e3),Ue.cachedCanvases=new x.LRUMap(Fe.DEFAULT_CACHE_SIZE);const Pe=self.ResizeObserver||T;const ke=new n,Ve=new n,je=new TextDecoder,We=class{static get ELEMENT_UID_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-uid"}static get HOVER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-hover"}static get ACTIVE_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-active"}static get FOCUS_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-focus"}static get TARGET_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-target"}static get LAYER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-layer"}static get PIXEL_RATIO_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-pixel-ratio"}static get RENDERING_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering"}static get RENDERING_PARENT_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-parent"}static get RENDERING_CONTAINER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-container"}static get RENDERING_INLINE_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-inline"}static get RENDERING_DOCUMENT_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-document"}static generateElementUID(){return""+this._nextUID++}static getPsuedoAttributes(e){return`${e.hover?`${this.HOVER_ATTRIBUTE}="" `:" "}${e.focus?`${this.FOCUS_ATTRIBUTE}="" `:" "}${e.active?`${this.ACTIVE_ATTRIBUTE}="" `:" "}${e.target?`${this.TARGET_ATTRIBUTE}="" `:" "}`}static initRootNodeObservation(e){const t=e.ownerDocument,s=e.getRootNode(),i="head"in s?s.head:s;if(this.rootNodeObservers.get(s))return;const r=t.createElement("style");i.append(r);const n=r.sheet;let a=0;if(Be(n,`[${We.RENDERING_DOCUMENT_ATTRIBUTE}] *`,"transform: none !important;",a++),Be(n,`[${We.RENDERING_ATTRIBUTE}], [${We.RENDERING_ATTRIBUTE}] *`,"visibility: visible !important;",a++),Be(n,`[${We.RENDERING_ATTRIBUTE}] [${We.LAYER_ATTRIBUTE}], [${We.RENDERING_ATTRIBUTE}] [${We.LAYER_ATTRIBUTE}] *`,"visibility: hidden !important;",a++),Be(n,`[${We.RENDERING_ATTRIBUTE}]`,"position: relative; top: 0 !important; left: 0 !important; float: none; box-sizing:border-box; min-width:var(--x-width); min-height:var(--x-height); display:block !important;",a++),Be(n,`[${We.RENDERING_INLINE_ATTRIBUTE}]`,"top: var(--x-inline-top) !important; width:auto !important",a++),Be(n,`[${We.RENDERING_PARENT_ATTRIBUTE}]`,"transform: none !important; left: 0 !important; top: 0 !important; margin: 0 !important; border:0 !important; border-radius:0 !important; height:100% !important; padding:0 !important; position:static !important; display:block !important; background: rgba(0,0,0,0) none !important; box-shadow:none !important",a++),Be(n,`[${We.RENDERING_PARENT_ATTRIBUTE}]::before, [${We.RENDERING_PARENT_ATTRIBUTE}]::after`,"content:none !important; box-shadow:none !important;",a++),s===t){let e="";const t=()=>{if(e!=window.location.hash&&window.location.hash)try{this.targetElement=s.querySelector(window.location.hash)}catch{}e=window.location.hash};window.addEventListener("hashchange",t,!1),t(),window.addEventListener("focusin",(e=>{this.focusElement=e.target}),!1),window.addEventListener("focusout",(e=>{this.focusElement=null}),!1),window.addEventListener("load",(e=>{o()}))}const o=()=>{for(const[e,t]of this.layers)t.needsRefresh=!0},h=e=>{var t=e.nodeName.toUpperCase();-1!==c.indexOf(t)&&e.addEventListener("load",o)},c=["STYLE","LINK"],l=new MutationObserver((e=>{var s;for(const i of e){-1!==c.indexOf(i.target.nodeName.toUpperCase())&&(o(),null==(s=this.embeddedCSS.get(t))||s.delete(i.target));for(const e of i.addedNodes)h(e)}}));l.observe(t,{childList:!0,attributes:!0,characterData:!0,subtree:!0,attributeOldValue:!0,characterDataOldValue:!0}),this.rootNodeObservers.set(s,l)}static addToSerializeQueue(e){-1===this.serializeQueue.indexOf(e)&&this.serializeQueue.push(e)}static addToRasterizeQueue(e){-1===this.rasterizeQueue.indexOf(e)&&this.rasterizeQueue.push(e)}static addToRenderQueue(e){-1===this.renderQueue.indexOf(e)&&this.renderQueue.push(e)}static _runTasks(){We.tasksPending=!1;const e=We.serializeQueue,t=We.rasterizeQueue,s=We.renderQueue,i=We.TASK_SYNC_MAX_TIME/2;let r=performance.now();for(;s.length&&performance.now()-r<i;)s.shift().render();for(r=performance.now();e.length&&performance.now()-r<i;)e.shift().serialize();t.length&&We.rasterizeTaskCount<We.TASK_ASYNC_MAX_COUNT&&(We.rasterizeTaskCount++,t.shift().rasterize().then((()=>{We.rasterizeTaskCount--})))}static scheduleTasksIfNeeded(){this.tasksPending||0===We.serializeQueue.length&&0===We.renderQueue.length&&(0===We.rasterizeQueue.length||We.rasterizeTaskCount===We.TASK_ASYNC_MAX_COUNT)||(this.tasksPending=!0,We.scheduleIdle(We._runTasks))}static scheduleIdle(e){setTimeout(e,1)}static setLayerNeedsRefresh(e){e.needsRefresh=!0}static createLayerTree(e,t){if(We.getClosestLayer(e))throw new Error("A root WebLayer for the given element already exists");!function(e){const t=e.ownerDocument,s=e.getRootNode();if(t.contains(e)||t.contains(null==s?void 0:s.host))return e;const i=s.host||t.createElement("div");i.setAttribute(qe.RENDERING_CONTAINER_ATTRIBUTE,""),i.style.position="fixed",i.style.width="100%",i.style.height="100%",i.style.top="-100000px",i.style.contain="strict",s.host||i.appendChild(e),t.documentElement.appendChild(i)}(e),We.initRootNodeObservation(e);const s=new MutationObserver(We._handleMutations);this.mutationObservers.set(e,s),this.startMutationObserver(e);const i=new Pe((e=>{for(const t of e){const e=this.getClosestLayer(t.target);e.traverseLayers(We.setLayerNeedsRefresh),e.traverseParentLayers(We.setLayerNeedsRefresh)}}));i.observe(e),this.resizeObservers.set(e,i),e.addEventListener("input",this._triggerRefresh,{capture:!0}),e.addEventListener("keydown",this._triggerRefresh,{capture:!0}),e.addEventListener("submit",this._triggerRefresh,{capture:!0}),e.addEventListener("change",this._triggerRefresh,{capture:!0}),e.addEventListener("focus",this._triggerRefresh,{capture:!0}),e.addEventListener("blur",this._triggerRefresh,{capture:!0}),e.addEventListener("transitionend",this._triggerRefresh,{capture:!0});const r=new Ue(e,t);return this.rootLayers.set(e,r),r}static disposeLayer(e){if(this.rootLayers.has(e.element)){this.rootLayers.delete(e.element);this.mutationObservers.get(e.element).disconnect(),this.mutationObservers.delete(e.element);this.resizeObservers.get(e.element).disconnect(),this.resizeObservers.delete(e.element),e.element.removeEventListener("input",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("keydown",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("submit",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("change",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("focus",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("blur",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("transitionend",this._triggerRefresh,{capture:!0})}}static getClosestLayer(e){const t=e&&e.closest(`[${We.LAYER_ATTRIBUTE}]`);return this.layers.get(t)}static parseCSSTransform(e,t,s,i,r=new n){const a=e.transform,o=e.transformOrigin;if(0==a.indexOf("matrix(")){r.identity();var h=a.substring(7,a.length-1).split(", ").map(parseFloat);r.elements[0]=h[0],r.elements[1]=h[1],r.elements[4]=h[2],r.elements[5]=h[3],r.elements[12]=h[4],r.elements[13]=h[5]}else{if(0!=a.indexOf("matrix3d("))return null;h=a.substring(9,a.length-1).split(", ").map(parseFloat);r.fromArray(h)}0===r.elements[0]&&(r.elements[0]=1e-15),0===r.elements[5]&&(r.elements[5]=1e-15),0===r.elements[10]&&(r.elements[10]=1e-15),r.elements[12]*=i,r.elements[13]*=i;var c=o.split(" ").map(parseFloat),l=(c[0]-t/2)*i,u=(c[1]-s/2)*i,d=c[2]||0,p=ke.identity().makeTranslation(-l,-u,-d),m=Ve.identity().makeTranslation(l,u,d);for(const n of r.elements)if(isNaN(n))return null;return r.premultiply(m).multiply(p)}static async embedExternalResources(e){const t=[],s=e.querySelectorAll("*");for(const r of s){const e=r.getAttributeNS("http://www.w3.org/1999/xlink","href");e&&t.push(We.getDataURL(e).then((e=>{r.removeAttributeNS("http://www.w3.org/1999/xlink","href"),r.setAttribute("href",e)})));const s=r;if("IMG"==r.tagName&&"data"!=s.src.substr(0,4)&&t.push(We.getDataURL(s.src).then((e=>{r.setAttribute("src",e)}))),"http://www.w3.org/1999/xhtml"==r.namespaceURI&&r.hasAttribute("style")){const e=r.getAttribute("style")||"";t.push(We.generateEmbeddedCSS(window.location.href,e).then((t=>{e!=t&&r.setAttribute("style",t)})))}}const i=e.querySelectorAll("style");for(const r of i)t.push(We.generateEmbeddedCSS(window.location.href,r.innerHTML).then((e=>{r.innerHTML!=e&&(r.innerHTML=e)})));return Promise.all(t)}static pauseMutationObservers(){const e=We.mutationObservers.values();for(const t of e)We._handleMutations(t.takeRecords()),t.disconnect()}static resumeMutationObservers(){for(const[e]of We.mutationObservers)this.startMutationObserver(e)}static startMutationObserver(e){We.mutationObservers.get(e).observe(e,{attributes:!0,childList:!0,subtree:!0,characterData:!0,characterDataOldValue:!0,attributeOldValue:!0})}static _addDynamicPseudoClassRules(e){const t=e.styleSheets;for(let n=0;n<t.length;n++)try{const e=t[n],r=e.cssRules;if(!r)continue;const a=[];for(var s=0;s<r.length;s++){r[s].cssText.indexOf(":hover")>-1&&a.push(r[s].cssText.replace(new RegExp(":hover","g"),`[${We.HOVER_ATTRIBUTE}]`)),r[s].cssText.indexOf(":active")>-1&&a.push(r[s].cssText.replace(new RegExp(":active","g"),`[${We.ACTIVE_ATTRIBUTE}]`)),r[s].cssText.indexOf(":focus")>-1&&a.push(r[s].cssText.replace(new RegExp(":focus","g"),`[${We.FOCUS_ATTRIBUTE}]`)),r[s].cssText.indexOf(":target")>-1&&a.push(r[s].cssText.replace(new RegExp(":target","g"),`[${We.TARGET_ATTRIBUTE}]`));var i=a.indexOf(r[s].cssText);i>-1&&a.splice(i,1)}for(s=0;s<a.length;s++)e.insertRule(a[s])}catch(r){}}static arrayBufferToBase64(e){for(var t="",s=e.byteLength,i=0;i<s;i++)t+=String.fromCharCode(e[i]);return window.btoa(t)}static attributeCSS(e,t){return t?`[${e}]=${t}`:`[${e}]`}static attributeHTML(e,t){return t?`${e}="${t}"`:`${e}=""`}static async generateEmbeddedCSS(e,t){let s;const i=[];t=(t=(t=(t=t.replace(new RegExp(":hover","g"),this.attributeCSS(this.HOVER_ATTRIBUTE))).replace(new RegExp(":active","g"),this.attributeCSS(this.ACTIVE_ATTRIBUTE))).replace(new RegExp(":focus","g"),this.attributeCSS(this.FOCUS_ATTRIBUTE))).replace(new RegExp(":target","g"),this.attributeCSS(this.TARGET_ATTRIBUTE));const r=RegExp(/url\((?!['"]?(?:data):)['"]?([^'"\)]*)['"]?\)/gi);for(;s=r.exec(t);){const r=s[1];i.push(this.getDataURL(new URL(r,e).href).then((e=>{t=t.replace(r,e)})))}return await Promise.all(i),t}static async getURL(e){return e=new URL(e,window.location.href).href,new Promise((t=>{var s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onload=()=>{t(s)},s.onerror=()=>{t(s)},s.send()}))}static async getEmbeddedCSS(e){const t=e.getRootNode(),s=this.embeddedCSS.get(t)||new Map;this.embeddedCSS.set(t,s);const i=Array.from(t.querySelectorAll("style, link[type='text/css'], link[rel='stylesheet']"));let r=!1;for(const n of i)if(!s.has(n))if(r=!0,"STYLE"==n.tagName){const e=n.sheet;let t="";for(const s of e.cssRules)t+=s.cssText+"\n";s.set(n,this.generateEmbeddedCSS(window.location.href,t))}else s.set(n,this.getURL(n.getAttribute("href")).then((e=>{if(!e.response)return"";this._addDynamicPseudoClassRules(t);var s=je.decode(e.response);return this.generateEmbeddedCSS(window.location.href,s)})));return r&&this._addDynamicPseudoClassRules(t),Promise.all(s.values())}static async getDataURL(e){var t;const s=await this.getURL(e),i=new Uint8Array(s.response),r=null==(t=s.getResponseHeader("Content-Type"))?void 0:t.split(";")[0];if("text/css"==r){let t=je.decode(i);t=await this.generateEmbeddedCSS(e,t);const s=window.btoa(t);return s.length>0?"data:"+r+";base64,"+s:""}return"data:"+r+";base64,"+this.arrayBufferToBase64(i)}static updateInputAttributes(e){e.matches("input")&&this._updateInputAttribute(e);for(const t of e.getElementsByTagName("input"))this._updateInputAttribute(t)}static _updateInputAttribute(e){e.hasAttribute("checked")?e.checked||e.removeAttribute("checked"):e.checked&&e.setAttribute("checked",""),e.getAttribute("value")!==e.value&&e.setAttribute("value",e.value)}static isBlankImage(e){return!new Uint32Array(e.buffer).some((e=>0!==e))}};let qe=We;if(qe.ATTRIBUTE_PREFIX="xr",qe._nextUID=0,qe.serializer=new XMLSerializer,qe.rootLayers=new Map,qe.layers=new Map,qe.mutationObservers=new Map,qe.resizeObservers=new Map,qe.serializeQueue=[],qe.rasterizeQueue=[],qe.renderQueue=[],qe.focusElement=null,qe.activeElement=null,qe.targetElement=null,qe.rootNodeObservers=new Map,qe.TASK_ASYNC_MAX_COUNT=2,qe.TASK_SYNC_MAX_TIME=200,qe.rasterizeTaskCount=0,qe.tasksPending=!1,qe._handleMutations=e=>{for(const t of e){if("attributes"===t.type){if(t.target.getAttribute(t.attributeName)===t.oldValue)continue}if("characterData"===t.type){if(t.target.data===t.oldValue)continue}const e=t.target.nodeType===Node.ELEMENT_NODE?t.target:t.target.parentElement;if(!e)continue;const s=We.getClosestLayer(e);if(s){if("attributes"===t.type&&"class"===t.attributeName){if((t.oldValue?t.oldValue:"")===t.target.className)continue}s.parentLayer?s.parentLayer.traverseChildLayers(We.setLayerNeedsRefresh):s.traverseLayers(We.setLayerNeedsRefresh)}}},qe._triggerRefresh=async e=>{const t=We.getClosestLayer(e.target);t&&(t.parentLayer?t.parentLayer.traverseChildLayers(We.setLayerNeedsRefresh):t.traverseLayers(We.setLayerNeedsRefresh))},qe.embeddedCSS=new Map,self.THREE)var $e=self.THREE;else $e=S;const Qe=new $e.Matrix4,Ge=new $e.Vector3,He=new $e.Vector3,Xe=new Ae,Ye=new Ae,Ze=Symbol("ON_BEFORE_UPDATE");class Ke extends $e.Object3D{constructor(e,t={}){super(),this.element=e,this.options=t,this.isRoot=!1,this._localZ=0,this._viewZ=0,this._renderZ=0,this.textures=new Map,this.textureNeedsUpdate=!1,this.contentMesh=new $e.Mesh(et.GEOMETRY,new $e.MeshBasicMaterial({side:$e.DoubleSide,transparent:!0,alphaTest:.001,opacity:1})),this._boundsMesh=new $e.Mesh(et.GEOMETRY,new $e.MeshBasicMaterial({visible:!1})),this.cursor=new $e.Object3D,this.depthMaterial=new $e.MeshDepthMaterial({depthPacking:$e.RGBADepthPacking,alphaTest:.001}),this.domLayout=new $e.Object3D,this.domSize=new $e.Vector3(1,1,1),this.childWebLayers=[],this.shouldApplyDOMLayout="auto",this.name=e.id,this._webLayer=qe.getClosestLayer(e),this.add(this.contentMesh),this.add(this._boundsMesh),this.cursor.visible=!1,this.matrixAutoUpdate=!0,this.contentMesh.matrixAutoUpdate=!0,this.contentMesh.visible=!1,this.contentMesh.customDepthMaterial=this.depthMaterial,this.contentMesh.onBeforeRender=(e,t,s)=>{this._camera=s},this._boundsMesh.matrixAutoUpdate=!0,et.layersByElement.set(this.element,this),et.layersByMesh.set(this.contentMesh,this)}get currentTexture(){if("VIDEO"===this._webLayer.element.tagName){const e=this._webLayer.element;let t=this.textures.get(e);return t||(t=new $e.VideoTexture(e),t.wrapS=$e.ClampToEdgeWrapping,t.wrapT=$e.ClampToEdgeWrapping,t.minFilter=$e.LinearFilter,this.options.textureEncoding&&(t.encoding=this.options.textureEncoding),this.textures.set(e,t)),t}const e=this._webLayer.canvas;let t=this.textures.get(e);return t?this.textureNeedsUpdate&&(this.textureNeedsUpdate=!1,t.needsUpdate=!0):(t=new $e.Texture(e),t.needsUpdate=!0,t.wrapS=$e.ClampToEdgeWrapping,t.wrapT=$e.ClampToEdgeWrapping,t.minFilter=$e.LinearFilter,this.options.textureEncoding&&(t.encoding=this.options.textureEncoding),this.textures.set(e,t)),t}get pseudoStates(){return this._webLayer.psuedoStates}get depth(){return this._webLayer.depth}get index(){return this.parentWebLayer?this.parentWebLayer.childWebLayers.indexOf(this):0}get needsRefresh(){return this._webLayer.needsRefresh}setNeedsRefresh(){this._webLayer.traverseLayers(qe.setLayerNeedsRefresh)}get needsRemoval(){return this._webLayer.needsRemoval}get bounds(){return this._webLayer.bounds}get parentWebLayer(){return this._webLayer.parentLayer&&et.layersByElement.get(this._webLayer.parentLayer.element)}refresh(e=!1){this._webLayer.refresh(),this.childWebLayers.length=0;for(const t of this._webLayer.childLayers){const s=et.getClosestLayerForElement(t.element);s&&(this.childWebLayers.push(s),e&&s.refresh(e))}this._refreshVideoBounds(),this._refreshDOMLayout()}updateLayout(){this.position.copy(this.domLayout.position),this.quaternion.copy(this.domLayout.quaternion),this.scale.copy(this.domLayout.scale),this.contentMesh.position.set(0,0,0),this.contentMesh.scale.copy(this.domSize),this.contentMesh.quaternion.set(0,0,0,1),this._boundsMesh.position.set(0,0,0),this._boundsMesh.scale.copy(this.domSize),this._boundsMesh.quaternion.set(0,0,0,1);const e=this.contentMesh,t=e.material.opacity<.005;t?e.visible=!1:e.material.map&&(e.visible=!0),this.needsRemoval&&t&&(this.parent&&this.parent.remove(this),this.dispose())}updateContent(){const e=this.contentMesh,t=this.currentTexture,s=e.material;if(t.image&&s.map!==t&&(s.map=t,s.depthWrite=!1,s.needsUpdate=!0,this.depthMaterial.map=t,this.depthMaterial.needsUpdate=!0),s.transparent=!0,!this._camera)return;this._localZ=Ge.setFromMatrixPosition(this.matrix).z+Ge.setFromMatrixPosition(this.contentMesh.matrix).z,this._viewZ=this.contentMesh.getWorldPosition(Ge).distanceTo(this._camera.getWorldPosition(He));let i=this.parentWebLayer?this.parentWebLayer._renderZ:this._viewZ;Math.abs(this._localZ)<1e-8?this._renderZ=i:this._renderZ=this._viewZ,this.contentMesh.renderOrder=(this.options.renderOrderOffset||0)+(1-Math.log(this._renderZ+1)/Math.log(this._camera.far+1))+1e-6*(this.depth+.001*this.index)}get rootWebLayer(){return et.layersByElement.get(this._webLayer.rootLayer.element)}[Ze](){}_doUpdate(){this[Ze](),this.updateLayout(),this.updateContent(),this.needsRefresh&&!1!==this.options.autoRefresh&&this.refresh(),qe.scheduleTasksIfNeeded()}update(e=!1){e?this.traverseLayersPreOrder(this._doUpdate):this._doUpdate()}querySelector(e){const t=this.element.querySelector(e);if(t)return et.layersByElement.get(t)}traverseLayerAncestors(e){const t=this.parentWebLayer;t&&(t.traverseLayerAncestors(e),e.call(this,t))}traverseLayersPreOrder(e){if(!1===e.call(this,this))return!1;for(const t of this.childWebLayers)if(!1===t.traverseLayersPreOrder(e))return!1;return!0}traverseLayersPostOrder(e){for(const t of this.childWebLayers)if(!1===t.traverseLayersPostOrder(e))return!1;return e.call(this,this)||!0}dispose(){for(const e of this.textures.values())e.dispose();this.contentMesh.geometry.dispose(),this._boundsMesh.geometry.dispose(),qe.disposeLayer(this._webLayer);for(const e of this.childWebLayers)e.dispose()}_refreshVideoBounds(){if("VIDEO"===this.element.nodeName){const e=this.element,t=this.currentTexture,s=getComputedStyle(this.element),{objectFit:i}=s,{width:r,height:n}=this.bounds,{videoWidth:a,videoHeight:o}=e,h=a/o,c=r/n;switch(t.center.set(.5,.5),i){case"none":t.repeat.set(r/a,n/o).clampScalar(0,1);break;case"contain":case"scale-down":if(t.repeat.set(1,1),c>h){const e=this.bounds.height*h||0;this.bounds.left+=(this.bounds.width-e)/2,this.bounds.width=e}else{const e=this.bounds.width/h||0;this.bounds.top+=(this.bounds.height-e)/2,this.bounds.height=e}break;case"cover":if(t.repeat.set(r/a,n/o),c<h){const e=this.bounds.height*h||0;this.bounds.left+=(this.bounds.width-e)/2,this.bounds.width=e}else{const e=this.bounds.width/h||0;this.bounds.top+=(this.bounds.height-e)/2,this.bounds.height=e}break;default:case"fill":t.repeat.set(1,1)}}}_refreshDOMLayout(){if(this.needsRemoval)return;this.domLayout.position.set(0,0,0),this.domLayout.scale.set(1,1,1),this.domLayout.quaternion.set(0,0,0,1);const e=this.bounds,t=e.width,s=e.height,i=1/et.DEFAULT_PIXELS_PER_UNIT;if(this.domSize.set(Math.max(i*t,1e-5),Math.max(i*s,1e-5),1),!et.shouldApplyDOMLayout(this))return;const r=this.parentWebLayer instanceof Ke?this.parentWebLayer.bounds:function(e){return Ne.parentNode||document.documentElement.append(Ne),e.left=pageXOffset,e.top=pageYOffset,e.width=Ne.offsetWidth,e.height=Ne.offsetHeight,e}(Xe),n=-r.width/2+t/2,a=r.height/2-s/2;this.domLayout.position.set(i*(n+e.left),i*(a-e.top),0);const o=getComputedStyle(this.element);if(o.transform){const e=qe.parseCSSTransform(o,t,s,i,Qe);e&&(this.domLayout.updateMatrix(),this.domLayout.matrix.multiply(e),this.domLayout.matrix.decompose(this.domLayout.position,this.domLayout.quaternion,this.domLayout.scale))}}}const Je=class extends $e.Object3D{constructor(e,t={}){super(),this.options=t,this._interactionRays=[],this._raycaster=new $e.Raycaster,this._hitIntersections=[],this._previousHoverLayers=new Set,this._contentMeshes=[],this._prepareHitTest=e=>{e.pseudoStates.hover&&this._previousHoverLayers.add(e),e.cursor.visible=!1,e.pseudoStates.hover=!1,this._contentMeshes.push(e.contentMesh)};const s="string"==typeof e?De(e):e;qe.createLayerTree(s,((e,{target:t})=>{var i,r;if("layercreated"===e){const e=new Ke(t,this.options);t===s?(e[Ze]=()=>this._updateInteractions(),e.isRoot=!0,this.rootLayer=e,this.add(e)):null==(i=e.parentWebLayer)||i.add(e),this.options.onLayerCreate&&this.options.onLayerCreate(e)}else if("layerpainted"===e){const e=qe.layers.get(t);Je.layersByElement.get(e.element).textureNeedsUpdate=!0}else if("layermoved"===e){const e=Je.layersByElement.get(t);null==(r=e.parentWebLayer)||r.add(e)}})),this.refresh(),this.update()}static shouldApplyDOMLayout(e){const t=e.shouldApplyDOMLayout;return"always"===t||!0===t||"never"!==t&&!1!==t&&!("auto"!==t||!e.parentWebLayer||e.parent!==e.parentWebLayer)}get interactionRays(){return this._interactionRays}set interactionRays(e){this._interactionRays=e}querySelector(e){return this.rootLayer.querySelector(e)}refresh(){this.rootLayer.refresh(!0)}update(){this.rootLayer.update(!0)}get contentMesh(){return this.rootLayer.contentMesh}_intersectionSort(e,t){const s=e.object.parent,i=t.object.parent;return s.depth!==i.depth?i.depth-s.depth:i.index-s.index}_updateInteractions(){const e=this._previousHoverLayers;e.clear(),this._contentMeshes.length=0,this.rootLayer.traverseLayersPreOrder(this._prepareHitTest);for(const t of this._interactionRays){t instanceof $e.Ray?this._raycaster.ray.copy(t):this._raycaster.ray.set(t.getWorldPosition(Ge),t.getWorldDirection(He)),this._hitIntersections.length=0;const s=this._raycaster.intersectObjects(this._contentMeshes,!1,this._hitIntersections);s.sort(this._intersectionSort);const i=s[0];if(i){const t=i.object.parent;t.cursor.position.copy(i.point),t.cursor.visible=!0,t.pseudoStates.hover=!0,e.has(t)||t.setNeedsRefresh()}}for(const t of e)t.pseudoStates.hover||t.setNeedsRefresh()}static getLayerForQuery(e){const t=document.querySelector(e);return Je.layersByElement.get(t)}static getClosestLayerForElement(e){const t=e&&e.closest(`[${qe.LAYER_ATTRIBUTE}]`);return Je.layersByElement.get(t)}hitTest(e){const t=this._raycaster,s=this._hitIntersections,i=Je.layersByMesh;t.ray.copy(e),s.length=0,t.intersectObject(this,!0,s),s.sort(this._intersectionSort);for(const r of s){const e=i.get(r.object);if(!e)continue;const t=Oe(e.element,Xe);if(!t.width||!t.height)continue;let s=e.element;const n=r.uv.x*t.width,a=(1-r.uv.y)*t.height;return Le(e.element,(e=>{if(!s.contains(e))return!1;const i=Oe(e,Ye),r=i.left-t.left,o=i.top-t.top,{width:h,height:c}=i;return n>r&&n<r+h&&a>o&&a<o+c&&(s=e,!0)})),{layer:e,intersection:r,target:s}}}};let et=Je;et.layersByElement=new WeakMap,et.layersByMesh=new WeakMap,et.DEFAULT_LAYER_SEPARATION=.001,et.DEFAULT_PIXELS_PER_UNIT=1e3,et.GEOMETRY=new $e.PlaneGeometry(1,1,2,2);const tt={getChildren(e,t){const s=e.node;if(s.isObject3D){t.length=0;for(let e=0;e<s.children.length;e++)t[e]=s.children[e]}},getState(e,t){if(e.system.viewNode===e.node){const t=e.node;t.updateMatrixWorld(),e.system.viewFrustum.setFromPerspectiveProjectionMatrix(t.projectionMatrix)}const s=e.node;s.isObject3D&&(s.matrixAutoUpdate&&s.updateMatrix(),t.localMatrix=s.matrix,t.parent=s.parent,t.opacity=st(e)||1)},getIntrinsicBounds(e,t){const s=e.node;if(s.isObject3D)return s.geometry?(s.geometry.boundingBox||s.geometry.computeBoundingBox(),t.copy(s.geometry.boundingBox)):t},apply(e,t){const s=e.node;if(s.isObject3D){if(t.parent!==s.parent){t.parent.add(s)}if(s.quaternion.copy(t.localOrientation),s.position.copy(t.localPosition),s.scale.copy(t.localScale),s.matrix.copy(t.localMatrix),s.matrixWorld.copy(t.worldMatrix),it(e,t.opacity),isNaN(t.localPosition.x))throw new Error}}};function st(e){const t=e.node;if(t.material){const e=t.material;if(e.length){for(const t of e)if(void 0!==t.opacity)return t.opacity}else if("opacity"in t.material)return t.material.opacity}for(const s of e.boundsChildren){const t=st(e.system.getMetrics(s));if(void 0!==t)return t}}function it(e,t){const s=e.node;if(s.material){const e=s.material;if(e.length)for(const s of e)"opacity"in s&&(s.opacity=t);else s.material.opacity=t}for(const i of e.boundsChildren)it(e.system.getMetrics(i),t)}const rt={getChildren(e,t){e.node.isObject3D&&tt.getChildren(e,t)},getState(e,t){e.node.isObject3D&&tt.getState(e,t)},getIntrinsicBounds:(e,t)=>(e.node.isObject3D&&tt.getIntrinsicBounds(e,t),t),apply(e,t){e.node.isObject3D&&tt.apply(e,t)}};function nt(e,t=rt){return new Ee(e,t)}var at=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",ThreeBindings:tt,DefaultBindings:rt,createLayoutSystem:nt,WebLayer3D:et,WebLayer3DContent:Ke,WebRenderer:qe,get THREE(){return $e},toDOM:De,EtherealLayoutSystem:Ee,MathUtils:R,Matrix3:E,Matrix4:n,V_00:A,V_11:I,V_000:O,V_100:N,V_010:D,V_001:F,V_111:U,Q_IDENTITY:P,DIRECTION:k,Vector2:e,Vector3:t,Vector4:z,Quaternion:s,Euler:a,Color:l,Box2:i,Box3:r,Ray:C,Line3:L,Plane:B,computeRelativeDifference:V,gaussian:q,levy:$,randomQuaternion:Q,randomSelect:G,extractRotationAboutAxis:H,LayoutFrustum:Re,NodeState:ne,SpatialMetrics:ae,SpatialAdapter:Se,SpatialLayout:fe,LayoutSolution:be,OptimizerConfig:oe,SpatialOptimizer:he,easing:we,Transition:xe,TransitionConfig:Me,Transitionable:Te,SphericalCoordinate:Ce,MemoizationCache:X});export{P as Q,Ce as S,O as V,et as W,D as a,U as b,nt as c,we as d,at as e};
