var A=Object.defineProperty;var T=(d,e,t)=>e in d?A(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var i=(d,e,t)=>(T(d,typeof e!="symbol"?e+"":e,t),t);import{W as b,V as v,e as D,c as O,a as P,b as C,S as z}from"./WebContainer3D.js";import{S as U,b as W,O as u,P as j,W as I,C as X,I as k,E as _,R as F,N as H,c as E,e as B,f as G,B as V,g as Y,h as q,V as R,i as $,D as Q,j as N,M as f,k as S,l as Z,m as y,n as J,T as K,G as ee,o as te,q as se,Q as ie,r as ae,s as ne,L as re,t as oe,u as ce,A as he,v as de}from"./vendor.js";window.addEventListener("vrdisplayconnect",d=>{},!1);var x=new U;x.showPanel(1);document.body.appendChild(x.dom);class le{constructor(){this.scene=new W,this.dolly=new u,this.camera=new j,this.renderer=new I({antialias:!1,alpha:!0,logarithmicDepthBuffer:!0}),this.clock=new X,this.imageLoader=new k,this.composer=new _(this.renderer),this.renderPass=new F(this.scene,this.camera),this.normalPass=new H(this.scene,this.camera,{resolutionScale:1}),this.areaImage=this.imageLoader.load(E.areaImageDataURL),this.searchImage=this.imageLoader.load(E.searchImageDataURL),this.smaaEffect=new E(this.searchImage,this.areaImage,B.ULTRA),this.ssaoEffect=new G(this.camera,this.normalPass.renderTarget.texture,{blendFunction:V.MULTIPLY,samples:11,rings:4,distanceThreshold:0,distanceFalloff:1,rangeThreshold:0,rangeFalloff:1,luminanceInfluence:.2,radius:18,scale:.6,bias:.8}),this.bloomEffect=new Y,this.effectPass=new q(this.camera,this.smaaEffect,this.ssaoEffect),this.pointer=new R,this.raycaster=new $,this.xrObjects=new Map,this.loaded=new Promise(s=>{Q.onLoad=()=>{s()}}),this.webLayers=new Set,this.animate=()=>{if(x.begin(),!this.xrPresenting){const r=this.renderer.domElement;this._setSize(r.clientWidth,r.clientHeight,window.devicePixelRatio*.6)}const s=Math.min(this.clock.getDelta(),1/60);this.update(s),this.composer.render(s),x.end()},this._wasPresenting=!1,this.update=s=>{if(this.xrPresenting){this._wasPresenting=!0;const h=this.renderer.xr.getCamera(this.camera).cameras[0];this.camera.matrix.identity(),this.camera.applyMatrix4(h.matrix),this.camera.projectionMatrix.copy(h.projectionMatrix),this.camera.projectionMatrixInverse.getInverse(this.camera.projectionMatrix),this.camera.updateMatrixWorld(!0)}else{this._wasPresenting&&(this._wasPresenting=!1,this._exitXR());const r=this.renderer.domElement,h=r.clientWidth,m=r.clientHeight,p=h/m;this.camera.aspect=p,this.camera.near=.001,this.camera.far=1e5,this.camera.updateProjectionMatrix()}if(this.session)for(const r of this.xrObjects.values()){const h=r.xrCoordinateSystem,m=h.getTransformTo(this.frameOfReference);m?(r.matrixAutoUpdate=!1,r.matrix.fromArray(m),r.updateMatrixWorld(!0),r.parent!==this.scene&&(this.scene.add(r),console.log("added xrObject "+h.uid||""))):r.parent&&(this.scene.remove(r),console.log("removed xrObject "+h.uid||""))}this.raycaster.setFromCamera(this.pointer,this.camera),this.clock.elapsedTime,this.onUpdate({type:"update",deltaTime:s,elapsedTime:this.clock.elapsedTime})},this.lastResize=-1/0,this.lastWidth=window.innerWidth,this.lastHeight=window.innerHeight,this.timeSinceLastResize=1/0,this.onUpdate=s=>{},this.onEnterXR=s=>{},this.onExitXR=s=>{},this.scene.add(this.dolly),this.dolly.add(this.camera);const e=this.renderer;document.documentElement.append(this.renderer.domElement),e.domElement.style.position="fixed",e.domElement.style.zIndex="-1",e.domElement.style.width="100%",e.domElement.style.height="100%",e.domElement.style.top="0",document.documentElement.addEventListener("mousemove",c),document.documentElement.addEventListener("touchmove",n,{passive:!1}),document.documentElement.addEventListener("touchstart",o,{passive:!1}),document.documentElement.addEventListener("touchend",a,{passive:!1}),document.documentElement.addEventListener("click",l,!1),window.addEventListener("vrdisplaypresentchange",s=>{this.xrPresenting||this._exitXR()},!1),document.documentElement.style.width="100%",document.documentElement.style.height="100%";const t=(s,r)=>{this.pointer.x=s/document.documentElement.offsetWidth*2-1,this.pointer.y=-r/document.documentElement.offsetHeight*2+1};function c(s){t(s.clientX,s.clientY)}function l(s){g(s)}function n(s){s.touches.length>1&&(s.preventDefault(),t(s.touches[0].clientX,s.touches[0].clientY))}function o(s){s.touches.length>1&&(t(s.touches[0].clientX,s.touches[0].clientY),g(s))}function a(s){}const g=s=>{for(const r of this.webLayers){const h=r.hitTest(this.raycaster.ray);h&&(h.target.dispatchEvent(new s.constructor(s.type,s)),h.target.focus(),console.log("hit",h.target,h.layer))}}}registerWebLayer(e){e.interactionRays=[this.raycaster.ray],this.webLayers.add(e)}getXRObject3D(e){let t=this.xrObjects.get(e);return t||(t=new u,t.xrCoordinateSystem=e,this.xrObjects.set(e,t),t)}async start(){return await this.loaded,this.renderPass.renderToScreen=!0,this.composer.addPass(this.renderPass),this.renderer.setAnimationLoop(this.animate),this.enterXR().then(()=>{document.documentElement.style.backgroundColor="transparent"}).catch(()=>{})}get xrPresenting(){return this.renderer.xr.isPresenting}async enterXR(){if(this.xrPresenting)return;const e="local";this.renderer.xr.setReferenceSpaceType(e);const t=async c=>{this.session&&this.session.end(),this.session=c,this.renderer.xr.setSession(c),this.frameOfReference=await c.requestFrameOfReference(e),c.addEventListener("end",()=>{this.session=void 0,this.frameOfReference=void 0,this.renderer.vr.setSession(null),this._exitXR()}),this._enterXR()};return navigator.xr.requestDevice().then(c=>c.requestSession({immersive:!0,type:"augmentation"}).then(t))}_enterXR(){this.renderer.xr.enabled=!0,this.onEnterXR({type:"enterxr"})}_exitXR(){this.renderer.xr.enabled=!1,this.onExitXR({type:"exitxr"})}_setSize(e,t,c=1){(e!==this.lastWidth||t!==this.lastHeight)&&(this.lastWidth=e,this.lastHeight=t,this.lastResize=performance.now()),this.timeSinceLastResize=performance.now()-this.lastResize,this.timeSinceLastResize>2e3&&(this.renderer.setSize(e,t,!1),this.composer.setSize(e,t,!1),this.renderer.setPixelRatio(c),this.lastResize=-1/0)}}class me{constructor(){this.container=new u,this.view=new u}}class pe extends me{constructor(e){super();i(this,"orientedContainerTop",new u);i(this,"logo",new b(`
        <div id="logo" class=${S({display:"inline",color:"rgb(180,120,250)",font:'400 100px/1.3 "Berkshire Swash"',textShadow:`3px 3px 0 #000,
                        -1px -1px 0 #000,  
                        1px -1px 0 #000,
                        -1px 1px 0 #000,
                        1px 1px 0 #000`})}>ethereal.js</div>
    `));i(this,"info",new b(`
        <div id="info" class=${S({display:"inline",color:"white",fontSize:"20px",textShadow:`3px 3px 0 #000,
                        -1px -1px 0 #000,  
                        1px -1px 0 #000,
                        -1px 1px 0 #000,
                        1px 1px 0 #000`})}></div>
    `,{pixelRatio:1}));i(this,"logoOccluders",[]);i(this,"_euler",new Z);i(this,"currentInfoText","");this.app=e;const t=o=>{const a=new y,g=new y(1,1,1),s=Math.random(),r=Math.random()-.5,h=Math.random()-.5,m=Math.random()-.5;let p=0;const L=new y((.5-Math.random())*7,(.5-Math.random())*7,(.5-Math.random())*7);o.position.copy(L);const w=e.system.getAdapter(o);w.onUpdate=()=>{p+=w.system.deltaTime*s,a.x=r*Math.sin(p),a.y=h*Math.sin(p),a.z=m*Math.cos(p),a.multiplyScalar(5),a.add(L),w.bounds.target.setFromCenterAndSize(a,g)}},c=new N;for(let o=0;o<10;o++){const a=new f(c);this.container.add(a),this.logoOccluders.push(a),t(a)}(()=>{this.container.add(this.orientedContainerTop);const o=e.system.getAdapter(this.orientedContainerTop);o.onUpdate=()=>{}})(),(()=>{const o=this.logo;o.contentMesh.material.side=J,this.container.add(o);const a=e.system.getAdapter(o);a.transition.duration=.8,a.transition.delay=.4,a.transition.debounce=.2,a.onUpdate=()=>{o.update()},a.bounds.start.setFromCenterAndSize(v,v)})()}}class ue extends le{constructor(){super();i(this,"ethereal",D);i(this,"system",O(this.camera));i(this,"publicUrl","/");i(this,"gltfLoader",new ee);i(this,"cubeTextureLoader",new te);i(this,"room",new u);i(this,"sky");i(this,"demos",[]);i(this,"plane",new se);i(this,"surfaceWallA",new f(this.plane));i(this,"surfaceWallB",new f(this.plane));i(this,"surfaceWallC",new f(this.plane));i(this,"surfaceWallD",new f(this.plane));i(this,"surfaceAboveBed",new f(this.plane));i(this,"dollyPosition",new y);i(this,"dollyOrientation",new ie);i(this,"cameraVerticalDegrees",0);i(this,"cameraHorizonalDegrees",0);i(this,"cameraDistance",1);i(this,"cameraWorldUp",!1);i(this,"resolution",new R);this.loadRoom(),this.loadSky(),this.setupLights(),this.camera.rotateZ(Math.PI);const e=()=>{const n=this.system.getAdapter(this.room);n.onUpdate=()=>{},n.onPostUpdate=()=>{}},t=()=>{const n=this.system.getAdapter(this.dolly);this.dolly.position.set(0,-10,0),n.transition.duration=1.5,n.onUpdate=()=>{n.bounds.target.setFromCenterAndSize(this.dollyPosition,C),n.orientation.target.copy(this.dollyOrientation)}},c=()=>{const n=this.system.getAdapter(this.camera),o=new z;n.transition.duration=.2,n.onUpdate=()=>{if(!this.xrPresenting){const a=this.system.getState(this.dolly);o.setWithDegrees(this.cameraHorizonalDegrees,this.cameraVerticalDegrees,this.cameraDistance),o.toCartesianPosition(this.camera.position),this.cameraWorldUp?this.camera.up.set(0,1,0):this.camera.up.set(0,1,0).applyQuaternion(a.worldOrientation),this.camera.lookAt(a.worldPosition)}}};e(),t(),c();let l=0;this.onUpdate=n=>{if(this.resolution.set(this.renderer.domElement.width,this.renderer.domElement.height),!this.xrPresenting){l=document.body.scrollTop/document.body.clientHeight;e:{if(this.cameraHorizonalDegrees=-this.pointer.x*80,this.cameraVerticalDegrees=-this.pointer.y*80,l<.03){this.dollyPosition.set(0,-30,0),this.dollyOrientation.setFromAxisAngle(P,-Math.PI/4),this.cameraVerticalDegrees=-89,this.cameraWorldUp=!0,this.cameraDistance=1;break e}this.cameraWorldUp=!1,this.cameraDistance=20,l>.03&&(this.dollyPosition.set(0,2,0),this.dollyOrientation.setFromAxisAngle(P,Math.PI/4))}}this.system.viewFrustum.setFromPerspectiveProjectionMatrix(this.camera.projectionMatrix),this.system.update(n.deltaTime,n.elapsedTime)},this.onEnterXR=n=>{},this.onExitXR=n=>{},this.demos.push(new pe(this))}loadSky(){const e=`${this.publicUrl}static/textures/skies/space5/`,t=".jpg",c=[e+"px"+t,e+"nx"+t,e+"py"+t,e+"ny"+t,e+"pz"+t,e+"nz"+t];this.sky=this.cubeTextureLoader.load(c,l=>{this.scene.background=l})}loadRoom(){this.scene.add(this.room),this.gltfLoader.load(`${this.publicUrl}static/models/stylized_room/scene-lowpoly.gltf`,e=>{const t=e.scene.children[0];t.material=new ae({color:13421772,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1});const c=new ne(t.geometry,15),l=new re().setPositions(c.attributes.position.array),n=new oe({color:6645093,linewidth:1.5}),o=new ce(l,n);t.add(o),this.room.add(e.scene);const a=this.system.getAdapter(o);a.onUpdate=()=>{n.resolution=this.resolution},this.system.nodeAdapters.get(this.room).metrics.invalidateIntrinsicBounds()})}setupLights(){const e=new he(11184810,1),t=new de(8961023,1);t.position.set(1,1,2),t.target.position.copy(this.scene.position),this.scene.add(t),this.scene.add(e)}}const M=new ue;M.start().catch(d=>{console.error(d),alert(d)});Object.assign(window,{THREE:K,app:M});
