var e=Object.defineProperty,t=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,n=(t,s,i)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i,a=(e,a)=>{for(var r in a||(a={}))s.call(a,r)&&n(e,r,a[r]);if(t)for(var r of t(a))i.call(a,r)&&n(e,r,a[r]);return e};import{e as r,P as o,W as c,C as d,V as h,k as l,am as m,O as p,v as u,an as y,ao as g,M as b,ap as v,aq as w,ar as f,as as x,at as S,au as R,T as E,av as P,u as A,q as T,aw as L,ax as k,d as M,c as z,a as j,ay as O,t as B,az as q,aA as C,o as X,aB as _,aC as W,aD as D,aE as I,aF as U,n as H,aG as F,aH as N,aI as J,aJ as Y,aK as G}from"./vendor.js";import{W as V,b as $,Q as K,d as Q,c as Z,e as ee}from"./ethereal.js";const te=R(a({},E));class se{constructor(e){this.app=e,this.textureLoader=new P,this.stlLoader=new te,this.snubber=new p,this.poster=new b(new A(1.04,2),new u),this.snubberAnchor=new p,this.snubberAnchorPosition=(new T).set(-.33,.92,.18),this.lineMaterial=new f({color:16753920,depthTest:!1}),this._scratchMatrix=new L,this.annotations=[{text:"TEST",anchorPoint:[0,0,0]},{text:"Part A",anchorPoint:[-.18,.06,.09]},{text:"Part B",anchorPoint:[.05,.05,.12]},{text:"Part C",anchorPoint:[-.1,.05,.11]},{text:"Part D",anchorPoint:[.14,-.22,-.06]},{text:"Part E",anchorPoint:[.11,0,.1]},{text:"Part F",anchorPoint:[-.06,-.04,.02]}],this.annotationState=new Map,this.loadPoser(),this.loadSnubberMesh()}loadPoser(){this.poster.name="poster",this.textureLoader.load("./public/Treadmill.jpeg",(e=>{this.poster.material.map=e,this.poster.material.needsUpdate=!0})),this.poster.add(this.snubberAnchor),this.snubberAnchor.position.copy(this.snubberAnchorPosition)}loadSnubberMesh(){this.snubber.name="snubber";const e=new p;e.quaternion.setFromAxisAngle(new T(0,0,1),Math.PI),e.scale.setScalar(.01),this.stlLoader.load("./public/fullSnubberSimplified.stl",(t=>{t.computeBoundsTree();const s=new k,i=new b(t,s);this.snubberMesh=i,this.snubberMesh.scale.setScalar(.1),e.add(i),this.snubber.add(e)}))}async enterXR(e){}update(e){}}const ie=M({setup:()=>_(W(Le))}),ne=j("link",{crossorigin:"anonymous",href:"https://fonts.googleapis.com/css?family=Inconsolata:400,700",rel:"stylesheet"},null,-1),ae=j("link",{rel:"stylesheet",href:"./modules/Pride.css"},null,-1),re={"xr-layer":"",id:"procedure"},oe={id:"flex"},ce={"xr-layer":"",id:"content"},de={id:"step","xr-layer":""},he=O("Step: "),le={id:"type"},me={id:"instruction","xr-layer":""},pe={"xr-layer":"",id:"media"},ue=j("div",{"xr-layer":"",id:"model"},null,-1),ye={id:"controls"},ge=j("div",{"xr-layer":"",class:"button",id:"back"},"Back",-1),be={"xr-layer":"",class:"button",id:"done"},ve={"xr-layer":"",class:"button",id:"yes"},we={"xr-layer":"",class:"button",id:"no"},fe={"xr-layer":"",class:"button",id:"record"},xe={"xr-layer":"",class:"button",id:"immersive-toggle"};ie.render=function(e,t,s,i,n,a){return X(),z("div",{id:"pride","xr-pixel-ratio":"0.01",class:e.immersiveMode},[ne,ae,j("div",re,[j("img",{"xr-layer":"",class:"logo",src:e.logo},null,8,["src"]),O("Procedure: "+B(e.pride.procedure),1)]),j("div",oe,[j("div",ce,[j("div",de,[he,j("span",le,B(e.pride.elementSubType),1),O(" "+B(e.pride.step),1)]),j("div",me,B(e.pride.instruction),1)]),j("div",pe,[q(j("video",{"xr-layer":"",id:"video",loop:"","webkit-playsinline":"",playsinline:"true",crossorigin:"anonymous",muted:"",src:e.pride.video},null,8,["src"]),[[C,e.pride.video]]),q(j("img",{"xr-layer":"",id:"image",crossorigin:"anonymous",src:e.pride.image},null,8,["src"]),[[C,e.pride.image]])]),ue]),j("div",ye,[ge,q(j("div",be,"Done",512),[[C,["ManualInstruction","ClarifyingInfo","VerifyInstruction"].indexOf(e.pride.elementSubType)>-1]]),q(j("div",ve,"Yes",512),[[C,"Conditional"===e.pride.elementSubType]]),q(j("div",we,"No",512),[[C,"Conditional"===e.pride.elementSubType]]),q(j("div",fe,"Record",512),[[C,"RecordInstruction"===e.pride.elementSubType]]),j("div",xe,[j("b",null,B(e.immersiveMode?"Flat":"Immersive"),1)])])],2)};const Se="https://prideview-ar.traclabs.com:8025/AR_server/",Re={json:"",procedure:"Treadmill Monthly Maintenance",step:"",instruction:"Loading...",image:"",video:"./public/armWiggleDemonstrated.mov",elementType:"",elementSubType:"",objects:{}};async function Ee(){const e=await fetch(Se+"ARready",{mode:"cors"}).catch(),t=await e.json().catch(),s=t&&t.procedureElementInfo&&t.procedureElementInfo.steplist;if(!s)return await Ee();if("continue procedure"===t.text)return await Pe(),await Ee();Re.json=t,Re.step=s[s.length-1].title,Re.instruction=t.text,Re.elementType=t.procedureElementInfo.elementType,Re.elementSubType=t.procedureElementInfo.elementData[Re.elementType.toLowerCase()+"Type"];const i=Object.keys(t).filter((e=>e.toLowerCase().includes("object")));for(const n of i){const e=t[n],s=Re.objects[e.name]={},i=e.properties;for(const t in i)if("realityaugmentation"===t){const e=i[t].split(";");for(const t of e){if(!t)continue;let[e,i]=t.split(":");if(e=e.trim(),i=i.trim(),"position"===e||"rotation"===e||"size"===e){const[t,n,a]=i.split(" ").map((e=>parseFloat(e)));s[e]={x:t,y:n,z:a}}else s[e]=isNaN(i)?i:parseFloat(i)}}else s[t]=i[t]}return t}async function Pe(e="none"){const t=await fetch(Se+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"done",value:e})});return Ee(),t.json()}var Ae={data:Re,get:Ee,getText:async function(){return(await fetch(Se+"ARready",{mode:"cors"})).text()},done:Pe,startProcedure:async function(e){return(await fetch(Se+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:e})})).json()},back:async function(){return(await fetch(Se+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"back",value:"none"})})).json()},skip:async function(){return(await fetch(Se+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"skip",value:"none"})})).json()},comment:async function(e){return(await fetch(Se+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"comment",value:e})})).json()}};class Te{constructor(){this.logo="./public/pride-view.png",this.pride=a({},Ae.data),this.immersiveMode=!1}async get(){await Ae.get(),this.pride=a({},Ae.data)}async back(){await Ae.back(),this.get()}async done(e){await Ae.done(e),this.get()}start(){return this.get(),this}}const Le=Symbol("state");const ke=M({setup:()=>_(W(ze))}),Me={class:"label"};ke.render=function(e,t,s,i,n,a){return X(),z("div",Me,B(e.message),1)};const ze=Symbol("state");function je(e=""){const t=D({message:""});t.message=e;return{state:t,vue:I(ke).provide(ze,t).mount(document.createElement("div"))}}class Oe{constructor(e){this.app=e,this.augmentations={},this.pride=function(){const e=D(new Te).start();return{state:e,vue:I(ie).provide(Le,e).mount(document.createElement("div"))}}(),this.state=this.pride.state,this.main=this.app.createWebLayerTree(this.pride.vue.$el,{onLayerCreate:e=>{this.app.system.getAdapter(e).onUpdate=()=>e.update()}}),this.procedure=this.main.querySelector("#procedure"),this.step=this.main.querySelector("#step"),this.instruction=this.main.querySelector("#instruction"),this.content=this.main.querySelector("#content"),this.media=this.main.querySelector("#media"),this.image=this.main.querySelector("#image"),this.video=this.main.querySelector("#video"),this.model=this.main.querySelector("#model"),this.controls=this.main.querySelector("#controls"),this.backButton=this.main.querySelector("#back"),this.doneButton=this.main.querySelector("#done"),this.recordButton=this.main.querySelector("#record"),this.yesButton=this.main.querySelector("#yes"),this.noButton=this.main.querySelector("#no"),this.immersiveButton=this.main.querySelector("#immersive-toggle"),this.immersiveAnchor=new p,this.snubberBox=new U(this.app.treadmill.snubber);(()=>{this.app.scene.add(this.immersiveAnchor);const e=this.app.system.getAdapter(this.immersiveAnchor),t=new T;e.onUpdate=()=>{t.set(0,this.app.xrPresenting?1.6:0,this.app.xrPresenting?-.7:-1.4),e.bounds.target.setFromCenterAndSize(t,$)}})(),(()=>{const e=this.app.system.getAdapter(this.main);e.createLayout().orientation(K).scale($).visualBounds({front:"-10m",center:{x:0,y:0}}).maximize();const t=e.createLayout().poseRelativeTo(this.app.camera).orientation(K).keepAspect().visualBounds({front:"-4m",size:{y:"100 vh"},center:{x:"0 vdeg",y:"0 vdeg"}}).maximize();e.onUpdate=()=>{this.main.options.autoRefresh=this.app.timeSinceLastResize>100,this.main.update(),"world"===this.app.interactionSpace?e.layouts=[]:e.layouts=[t]};const s=this.app.system.getAdapter(this.main.contentMesh);s.bounds.enabled=!0,s.onUpdate=()=>{this.state.immersiveMode?(this.main.contentMesh.position.set(0,0,-1),e.opacity.target=0):(this.main.contentMesh.position.set(0,0,0),e.opacity.target=1)},setTimeout((()=>this.video.element.play()),5e3)})(),(()=>{const e=this.app.system.getAdapter(this.content),t=e.createLayout().poseRelativeTo(this.app.treadmill.snubber).keepAspect("xyz").orientation(K).bounds({back:{gt:"0m"},front:{lt:"0m"},top:{lt:"0m"},bottom:{gt:"-100%"}}).visualBounds({right:{lt:"-100% -10px"}}).magnetize().maximize();e.onUpdate=()=>{this.state.immersiveMode?e.layouts=[t]:e.layouts=[],this.content.update()}})(),(()=>{const t=this.app.treadmill.poster;this.app.scene.add(t);const s=e.system.getAdapter(t);s.onUpdate=()=>{if(this.state.immersiveMode){const e="screen"===this.app.interactionSpace;t.position.set(0,e?0:.5,e?-5:-1),s.opacity.target=1}else t.position.set(0,0,-5),s.opacity.target=0}})(),(()=>{const t=this.app.treadmill.snubber;t.position.set(10,-10,-10),this.app.scene.add(t),this.app.scene.add(this.snubberBox);const s=e.system.getAdapter(t);s.transition.maxWait=10;const i=s.createLayout().poseRelativeTo(this.model).orientation({swingRange:{x:"10deg",y:"10deg"},twistRange:"0deg"}).keepAspect("xyz").visualBounds({back:"100%",left:{gt:"10px"},right:{lt:"-10px"},bottom:{gt:"10px"},top:{lt:"-10px"}}).maximize({minAreaPercent:.1}),n=[s.createLayout().poseRelativeTo(this.app.treadmill.poster).scale($).bounds({center:this.app.treadmill.snubberAnchorPosition}).orientation(K)],a=[i];s.onUpdate=()=>{this.state.immersiveMode?s.layouts=n:s.layouts=a},s.onPostUpdate=()=>{this.snubberBox.update()}})(),(()=>{const e=this.media,t=this.app.system.getAdapter(e),s=t.createLayout().poseRelativeTo(this.app.treadmill.poster).keepAspect("xyz").orientation(K).bounds({back:"100%",center:{x:0,y:0},size:{x:"100%"}});t.onUpdate=()=>{this.state.immersiveMode?t.layouts=[s]:t.layouts=[],e.update()}})(),this.backButton.element.addEventListener("click",(async()=>{this.state.back()})),this.doneButton.element.addEventListener("click",(async()=>{this.state.done()})),this.recordButton.element.addEventListener("click",(async()=>{this.state.done()})),this.yesButton.element.addEventListener("click",(async()=>{this.state.done("yes")})),this.noButton.element.addEventListener("click",(async()=>{this.state.done("no")})),this.immersiveButton.element.addEventListener("click",(async()=>{this.state.immersiveMode=!this.state.immersiveMode,this.state.immersiveMode&&this.app.enterXR()}))}updateAugmentations(){const e=this.state.pride.objects;for(const t in e){const s=e[t];let i=this.augmentations[t];if(!i){switch(s.type){case"box":const e=s.size;i=new b(new F(.01*e.x,.01*e.y,.01*e.z));break;case"sphere":i=new b(new H(.01*s.radius));break;case"label":const t=je(s.text);i=new V(t.vue.$el);default:i=new p}this.augmentations[t]=i}i.position.copy(s.position).multiplyScalar(.01),i.rotation.x=s.rotation.x*N.DEG2RAD,i.rotation.y=s.rotation.y*N.DEG2RAD,i.rotation.z=s.rotation.z*N.DEG2RAD}}update(e){}}v.prototype.computeBoundsTree=J,v.prototype.disposeBoundsTree=Y,b.prototype.raycast=G;const Be=new class extends class{constructor(e){this._config=e,this.scene=new r,this.camera=new o,this.uiView=new o,this.renderer=new c({desynchronized:!0,antialias:!1,alpha:!0}),this.clock=new d,this.pointer=new h,this.raycaster=new l,this.mouseRay=[this.raycaster.ray],this.immersiveRays=new Set,this.interactionRays=[],this.xrObjects=new Map,this.webLayers=new Set,this.onAnimate=()=>{const e=this.renderer.domElement;this._setSize(e.clientWidth,e.clientHeight,window.devicePixelRatio);const t=Math.min(this.clock.getDelta(),1/60);this.update(t),this.renderer.render(this.scene,this.camera)},this._wasPresenting=!1,this.update=e=>{if(this.interactionRays.length=0,"world"===this.interactionSpace)for(const t of this.immersiveRays)this.interactionRays.push(t);else for(const t of this.mouseRay)this.interactionRays.push(t);if(this.xrPresenting){this.renderer.setClearColor(new m("blue")),this.renderer.setClearColor(new m("white"),0),this._wasPresenting=!0;const e=this.renderer.xr.getCamera(this.camera);this.camera.matrix.copy(e.matrix),this.camera.matrix.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.projectionMatrix.copy(e.projectionMatrix),this.camera.projectionMatrixInverse.copy(this.camera.projectionMatrix).invert(),this.camera.updateWorldMatrix(!0,!0)}else{this.renderer.setClearColor(new m("white")),this._wasPresenting&&(this._wasPresenting=!1,this._exitXR(),this.interactionSpace="screen");const e=this.renderer.domElement,t=e.clientWidth/e.clientHeight;this.camera.aspect=t,this.camera.near=.001,this.camera.far=1e3,this.camera.updateProjectionMatrix()}this.raycaster.setFromCamera(this.pointer,this.camera),this._config.onUpdate({type:"update",deltaTime:e,elapsedTime:this.clock.elapsedTime})},this.interactionSpace="screen",this.lastResize=0,this.lastWidth=window.innerWidth,this.lastHeight=window.innerHeight,this.timeSinceLastResize=0,this.scene.add(this.camera);const t=this.renderer;document.documentElement.append(this.renderer.domElement),t.domElement.style.position="fixed",t.domElement.style.width="100%",t.domElement.style.height="100%",t.domElement.style.top="0",t.domElement.addEventListener("mousemove",(function(e){s(e.clientX,e.clientY)})),t.domElement.addEventListener("touchmove",(function(e){e.preventDefault(),s(e.touches[0].clientX,e.touches[0].clientY)}),{passive:!1}),t.domElement.addEventListener("touchstart",(function(e){s(e.touches[0].clientX,e.touches[0].clientY),i(e)}),{passive:!1}),t.domElement.addEventListener("touchend",(function(e){setTimeout((()=>s(-1/0,-1/0)),400)}),{passive:!1}),t.domElement.addEventListener("click",(function(e){i(e)}),!1),t.setAnimationLoop(this.onAnimate),window.addEventListener("vrdisplaypresentchange",(e=>{setTimeout((()=>{this.xrPresenting||this._exitXR()}))}),!1),document.documentElement.style.width="100%",document.documentElement.style.height="100%";const s=(e,t)=>{this.pointer.x=(e+window.pageXOffset)/document.documentElement.offsetWidth*2-1,this.pointer.y=-(t+window.pageYOffset)/document.documentElement.offsetHeight*2+1};const i=e=>{for(const t of this.webLayers){const s=t.hitTest(this.raycaster.ray);s&&(s.target.dispatchEvent(new e.constructor(e.type,e)),s.target.focus(),console.log("hit",s.target,s.layer))}},n=e=>{const s=14365238,i=new u({color:s}),n=t.xr.getController(e);this.scene.add(n),n.addEventListener("selectstart",(e=>{i.color.setHex(16040461),a()})),n.addEventListener("selectend",(e=>{i.color.setHex(s)})),n.add(new y(1)),this.immersiveRays.add(n);const a=()=>{for(const e of this.webLayers){const t=e.hitTest(n);t&&(t.target.click(),t.target.focus())}};let r;n.addEventListener("connected",(e=>{r=function(e){let t,s;switch(e.targetRayMode){case"tracked-pointer":return t=new v,t.setAttribute("position",new w([0,0,0,0,0,-1],3)),t.setAttribute("color",new w([.5,.5,.5,0,0,0],3)),s=new f({vertexColors:!0,blending:x}),new S(t,s);case"gaze":return t=new g(.02,.04,32).translate(0,0,-1),s=new u({opacity:.5,transparent:!0}),new b(t,s)}}(e),r&&n.add(r)})),n.addEventListener("disconnected",(()=>{r&&n.remove(r)}))};n(0),n(1)}createWebLayerTree(e,t){const s=new V(e,t);return s.interactionRays=this.interactionRays,this.webLayers.add(s),this.scene.add(s),s.rootLayer}getXRObject3D(e){let t=this.xrObjects.get(e);return t||(t=new p,t.xrCoordinateSystem=e,this.xrObjects.set(e,t),t)}async start(){return this.enterXR().catch((()=>{console.log("Enter XR failed"),this.renderer.domElement.style.backgroundColor="lightgrey"}))}get xrPresenting(){return this.renderer.xr.isPresenting}async enterXR(){if(this.xrPresenting)return;if(!navigator.xr)throw new Error("WebXR is not supported by this browser");const e=async e=>{this.session&&this.session.end(),this.session=e,this.interactionSpace="world",await this.renderer.xr.setSession(e),e.addEventListener("end",(()=>{this.session=void 0,this.frameOfReference=void 0,this._exitXR()})),this._enterXR()};if(navigator.xr.requestSession){var t={optionalFeatures:["local-floor","bounded-floor","hand-tracking"]};return await navigator.xr.isSessionSupported("immersive-ar",t)?(console.log("AR supported, trying AR"),navigator.xr.requestSession("immersive-ar",t).then(e)):(console.log("AR not supported, trying VR"),navigator.xr.requestSession("immersive-vr",t).then(e))}}_enterXR(){this.renderer.xr.enabled=!0,this._config.onEnterXR({type:"enterxr"})}_exitXR(){this._config.onExitXR({type:"exitxr"}),this.camera.position.set(0,0,0),this.camera.quaternion.set(0,0,0,1),this.interactionSpace="screen",this.renderer.xr.enabled=!1}_setSize(e,t,s=1){if(this.timeSinceLastResize=performance.now()-this.lastResize,this.xrPresenting)return;e===this.lastWidth&&t===this.lastHeight||(this.lastWidth=e,this.lastHeight=t,this.lastResize=performance.now());const i=this.renderer.domElement;this.timeSinceLastResize>2e3&&(i.width!==e*s||i.height!==t*s)&&(this.renderer.setSize(e,t,!1),this.renderer.setPixelRatio(s))}}{constructor(){super(...arguments),this.pride=Ae,this.system=Z(this.camera),this.treadmill=new se(this),this.ui=new Oe(this),this.ethereal=ee}}({onUpdate:e=>{Be.renderer.getSize(Be.system.viewResolution),Be.system.update(e.deltaTime,e.elapsedTime)},onEnterXR:e=>{},onExitXR:e=>{Be.ui.state.immersiveMode=!1}});Be.system.transition.duration=1.5,Be.system.transition.easing=Q.easeOut,Be.start().catch((e=>{console.log(e.stack),alert(e)})),Object.assign(window,{THREE:E,app:Be});
