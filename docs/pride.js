var se=Object.defineProperty;var W=Object.getOwnPropertySymbols;var ne=Object.prototype.hasOwnProperty,ie=Object.prototype.propertyIsEnumerable;var B=(n,e,t)=>e in n?se(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,P=(n,e)=>{for(var t in e||(e={}))ne.call(e,t)&&B(n,t,e[t]);if(W)for(var t of W(e))ie.call(e,t)&&B(n,t,e[t]);return n};var s=(n,e,t)=>(B(n,typeof e!="symbol"?e+"":e,t),t);import{d as ae,W as C,Q as b,b as re,f as oe,c as ce,e as de}from"./WebContainer3D.js";import{ao as le,b as pe,P as U,W as ue,C as me,V as he,i as ye,O as k,ap as fe,r as j,M as L,aq as O,ar as $,as as D,at as I,au as ge,av as be,T as N,aw as ve,q as we,m as q,ag as xe,ax as Se,d as V,ay as F,az as l,aA as X,aB as E,aC as T,aD as _,aE as H,aF as G,aG as J,aH as Y,aI as K,j as Re,aJ as Le,aK as Ee,aL as Te,aM as _e,aN as Ae}from"./vendor.js";var Q=(n,e)=>{const t=n.__vccOpts||n;for(const[a,p]of e)t[a]=p;return t};class Me{constructor(e){s(this,"scene",new pe);s(this,"camera",new U);s(this,"uiView",new U);s(this,"renderer",new ue({antialias:!1,alpha:!0,powerPreference:"high-performance"}));s(this,"clock",new me);s(this,"pointer",new he);s(this,"raycaster",new ye);s(this,"mouseRay",[this.raycaster.ray]);s(this,"immersiveRays",new Set);s(this,"interactionRays",[]);s(this,"xrObjects",new Map);s(this,"controllers",{});s(this,"webContainers",new Set);s(this,"onAnimate",()=>{const e=this.renderer.domElement;this._setSize(e.clientWidth,e.clientHeight,window.devicePixelRatio);const t=Math.min(this.clock.getDelta(),1/60);this.update(t),this.renderer.render(this.scene,this.camera)});s(this,"_wasPresenting",!1);s(this,"update",e=>{if(this.interactionRays.length=0,this.interactionSpace==="world")for(const t of this.immersiveRays)this.interactionRays.push(t);else for(const t of this.mouseRay)this.interactionRays.push(t);if(this.xrPresenting){this._wasPresenting=!0;const t=this.renderer.xr.getCamera(this.camera);this.camera.matrix.copy(t.matrix),this.camera.matrix.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.projectionMatrix.copy(t.projectionMatrix),this.camera.projectionMatrixInverse.copy(this.camera.projectionMatrix).invert(),this.camera.updateWorldMatrix(!0,!0)}else{this._wasPresenting&&(this._wasPresenting=!1,this._exitXR(),this.interactionSpace="screen");const t=this.renderer.domElement,a=t.clientWidth,p=t.clientHeight,d=a/p;this.camera.aspect=d,this.camera.near=.001,this.camera.far=1e3,this.camera.updateProjectionMatrix()}this.raycaster.setFromCamera(this.pointer,this.camera),this._config.onUpdate({type:"update",deltaTime:e,elapsedTime:this.clock.elapsedTime})});s(this,"interactionSpace","screen");s(this,"session");s(this,"vuforia");s(this,"frameOfReference");s(this,"lastResize",0);s(this,"lastWidth",window.innerWidth);s(this,"lastHeight",window.innerHeight);s(this,"timeSinceLastResize",0);this._config=e,ae.initialize(this.renderer),this.scene.add(this.camera);const t=this.renderer;document.documentElement.append(this.renderer.domElement),t.domElement.style.backgroundColor="darkgray",t.domElement.style.position="fixed",t.domElement.style.width="100%",t.domElement.style.height="100%",t.domElement.style.top="0",t.domElement.addEventListener("mousemove",p),t.domElement.addEventListener("touchmove",m,{passive:!1}),t.domElement.addEventListener("touchstart",f,{passive:!1}),t.domElement.addEventListener("touchend",g,{passive:!1}),t.domElement.addEventListener("click",d,!1),t.setAnimationLoop(this.onAnimate),t.setClearColor(new le("white"),0),window.addEventListener("vrdisplaypresentchange",i=>{setTimeout(()=>{this.xrPresenting||this._exitXR()})},!1),document.documentElement.style.width="100%",document.documentElement.style.height="100%";const a=(i,c)=>{this.pointer.x=(i+window.pageXOffset)/document.documentElement.offsetWidth*2-1,this.pointer.y=-(c+window.pageYOffset)/document.documentElement.offsetHeight*2+1};function p(i){a(i.clientX,i.clientY)}function d(i){o(i)}function m(i){i.preventDefault(),a(i.touches[0].clientX,i.touches[0].clientY)}function f(i){a(i.touches[0].clientX,i.touches[0].clientY),o(i)}function g(i){setTimeout(()=>a(-1/0,-1/0),400)}const o=i=>{for(const c of this.webContainers){const u=c.hitTest(this.raycaster.ray);u&&(u.target.dispatchEvent(new i.constructor(i.type,i)),u.target.focus(),console.log("hit",u.target,u.layer))}},r=i=>{const c=t.xr.getController(i);if(!c)return;const u=t.xr.getControllerGrip(i);this.scene.add(c),u&&this.scene.add(u),c.addEventListener("selectstart",S=>{for(const h of this.webContainers){const y=h.hitTest(c);y&&(y.target.click(),y.target.focus())}}),c.addEventListener("selectend",S=>{});function M(S){let h,y;switch(S.targetRayMode){case"tracked-pointer":return h=new O,h.setAttribute("position",new $([0,0,0,0,0,-30],3)),h.setAttribute("color",new $([.9,.9,.9,0,0,0],3)),y=new D({vertexColors:!0,blending:I,linewidth:3}),new ge(h,y);case"gaze":return h=new fe(.02,.04,32).translate(0,0,-1),y=new j({opacity:.5,transparent:!0}),new L(h,y)}}let x;c.addEventListener("connected",S=>{const y=t.xr.getSession().inputSources[i];x=M(y),x&&c.add(x),this.immersiveRays.add(c),this.controllers[y.handedness]={ray:c,grip:u}}),c.addEventListener("disconnected",()=>{x&&c.remove(x),this.immersiveRays.delete(c);const h=t.xr.getSession().inputSources[i];delete this.controllers[h.handedness]})};r(0),r(1),r(2)}createWebLayerTree(e,t){const a=new C(e,t);return a.interactionRays=this.interactionRays,this.webContainers.add(a),this.scene.add(a),a.rootLayer}getXRObject3D(e){let t=this.xrObjects.get(e);return t||(t=new k,t.xrCoordinateSystem=e,this.xrObjects.set(e,t),t)}async start(){return this.enterXR().catch(()=>{console.log("Enter XR failed"),this.renderer.domElement.style.backgroundColor="lightgrey"})}get xrPresenting(){return this.renderer.xr.isPresenting}async enterXR(){if(this.xrPresenting)return;if(!navigator.xr)throw new Error("WebXR is not supported by this browser");const e=async a=>{this.session&&this.session.end(),this.session=a,this.interactionSpace="world",await this.renderer.xr.setSession(a),a.addEventListener("end",()=>{this.session=void 0,this.frameOfReference=void 0,this._exitXR()}),this._enterXR()};if(navigator.xr.requestSession){var t={optionalFeatures:["local-floor","bounded-floor","hand-tracking"]};return await navigator.xr.isSessionSupported("immersive-ar",t)?(console.log("AR supported, trying AR"),navigator.xr.requestSession("immersive-ar",t).then(e)):(console.log("AR not supported, trying VR"),navigator.xr.requestSession("immersive-vr",t).then(e))}}_enterXR(){this.renderer.xr.enabled=!0,this._config.onEnterXR({type:"enterxr"})}_exitXR(){this._config.onExitXR({type:"exitxr"}),this.camera.position.set(0,0,0),this.camera.quaternion.set(0,0,0,1),this.interactionSpace="screen",this.renderer.xr.enabled=!1}_setSize(e,t,a=1){if(this.timeSinceLastResize=performance.now()-this.lastResize,this.xrPresenting)return;(e!==this.lastWidth||t!==this.lastHeight)&&(this.lastWidth=e,this.lastHeight=t,this.lastResize=performance.now());const p=this.renderer.domElement;this.timeSinceLastResize>2e3&&(p.width!==e*a||p.height!==t*a)&&(this.renderer.setSize(e,t,!1),this.renderer.setPixelRatio(a))}}const ke=be(P({},N));class Pe{constructor(e){s(this,"textureLoader",new ve);s(this,"stlLoader",new ke);s(this,"snubber",new k);s(this,"poster",new L(new we(1.04,2),new j));s(this,"snubberAnchor",new k);s(this,"snubberAnchorPosition",new q().set(-.33,.92,.18));s(this,"snubberMesh");s(this,"lineMaterial",new D({color:16753920,depthTest:!1}));s(this,"_scratchMatrix",new xe);s(this,"annotations",[{text:"TEST",anchorPoint:[0,0,0]},{text:"Part A",anchorPoint:[-.18,.06,.09]},{text:"Part B",anchorPoint:[.05,.05,.12]},{text:"Part C",anchorPoint:[-.1,.05,.11]},{text:"Part D",anchorPoint:[.14,-.22,-.06]},{text:"Part E",anchorPoint:[.11,0,.1]},{text:"Part F",anchorPoint:[-.06,-.04,.02]}]);s(this,"annotationState",new Map);this.app=e,this.loadPoser(),this.loadSnubberMesh()}loadPoser(){this.poster.name="poster",this.textureLoader.load("./public/Treadmill.jpeg",e=>{this.poster.material.map=e,this.poster.material.needsUpdate=!0}),this.poster.add(this.snubberAnchor),this.snubberAnchor.position.copy(this.snubberAnchorPosition)}loadSnubberMesh(){this.snubber.name="snubber";const e=new k;e.quaternion.setFromAxisAngle(new q(0,0,1),Math.PI),e.scale.setScalar(.01),this.stlLoader.load("./public/fullSnubberSimplified.stl",t=>{t.computeBoundsTree();const a=new Se,p=new L(t,a);this.snubberMesh=p,this.snubberMesh.scale.setScalar(.1),e.add(p),this.snubber.add(e)})}async enterXR(e){}update(e){}}const je=V({setup(){return it()}}),ze=l("link",{crossorigin:"anonymous",href:"https://fonts.googleapis.com/css?family=Inconsolata:400,700",rel:"stylesheet"},null,-1),Be=l("link",{rel:"stylesheet",href:"./modules/Pride.css"},null,-1),Ce={"xr-layer":"",id:"procedure"},Oe={id:"flex"},Ie={"xr-layer":"",id:"content"},qe={id:"step","xr-layer":""},Xe=X("Step: "),We={id:"type"},Ue={id:"instruction","xr-layer":""},$e={"xr-layer":"",id:"media"},De=l("div",{"xr-layer":"",id:"model"},null,-1),Ne=l("div",{"xr-layer":"",class:"button",id:"back"},"Back",-1),Ve={"xr-layer":"",class:"button",id:"done"},Fe={"xr-layer":"",class:"button",id:"yes"},He={"xr-layer":"",class:"button",id:"no"},Ge={"xr-layer":"",class:"button",id:"record"},Je={"xr-layer":"",class:"button",id:"immersive-toggle"};function Ye(n,e,t,a,p,d){return H(),F("div",{id:"pride","xr-pixel-ratio":"0.01",class:{xr:n.immersiveMode}},[ze,Be,l("div",Ce,[l("img",{"xr-layer":"",class:"logo",src:n.logo},null,8,["src"]),X("Procedure: "+E(n.pride.procedure),1)]),l("div",Oe,[l("div",Ie,[l("div",qe,[Xe,l("span",We,E(n.pride.elementSubType),1),X(" "+E(n.pride.step),1)]),l("div",Ue,E(n.pride.instruction),1)]),l("div",$e,[T(l("video",{"xr-layer":"",id:"video",loop:"","webkit-playsinline":"",playsinline:"true",crossorigin:"anonymous",muted:"",src:n.pride.video},null,8,["src"]),[[_,n.pride.video]]),T(l("img",{"xr-layer":"",id:"image",crossorigin:"anonymous",src:n.pride.image},null,8,["src"]),[[_,n.pride.image]])]),De]),l("div",{id:"controls",class:{worldInteraction:n.worldInteraction},"xr-layer":""},[Ne,T(l("div",Ve,"Done",512),[[_,["ManualInstruction","ClarifyingInfo","VerifyInstruction"].indexOf(n.pride.elementSubType)>-1]]),T(l("div",Fe,"Yes",512),[[_,n.pride.elementSubType==="Conditional"]]),T(l("div",He,"No",512),[[_,n.pride.elementSubType==="Conditional"]]),T(l("div",Ge,"Record",512),[[_,n.pride.elementSubType==="RecordInstruction"]]),l("div",Je,[l("b",null,E(n.immersiveMode?"Flat":"Immersive"),1)])],2)],2)}var Ke=Q(je,[["render",Ye]]);const R="https://prideview-ar.traclabs.com:8025/AR_server/",v={json:"",procedure:"Treadmill Monthly Maintenance",step:"",instruction:"Loading...",image:"",video:"./public/armWiggleDemonstrated.mov",elementType:"",elementSubType:"",objects:{}};async function z(){const e=await(await fetch(R+"ARready",{mode:"cors"}).catch()).json().catch(),t=e&&e.procedureElementInfo&&e.procedureElementInfo.steplist;if(!t)return await z();if(e.text==="continue procedure")return await Z(),await z();v.json=e,v.step=t[t.length-1].title,v.instruction=e.text,v.elementType=e.procedureElementInfo.elementType,v.elementSubType=e.procedureElementInfo.elementData[v.elementType.toLowerCase()+"Type"];const a=Object.keys(e).filter(p=>p.toLowerCase().includes("object"));for(const p of a){const d=e[p],m=v.objects[d.name]={},f=d.properties;for(const g in f)if(g==="realityaugmentation"){const o=f[g].split(";");for(const r of o){if(!r)continue;let[i,c]=r.split(":");if(i=i.trim(),c=c.trim(),i==="position"||i==="rotation"||i==="size"){const[u,M,x]=c.split(" ").map(S=>parseFloat(S));m[i]={x:u,y:M,z:x}}else m[i]=isNaN(c)?c:parseFloat(c)}}else m[g]=f[g]}return e}async function Qe(){return(await fetch(R+"ARready",{mode:"cors"})).text()}async function Z(n="none"){const e=await fetch(R+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"done",value:n})});return z(),e.json()}async function Ze(n){return(await fetch(R+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:n})})).json()}async function et(){return(await fetch(R+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"back",value:"none"})})).json()}async function tt(){return(await fetch(R+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"skip",value:"none"})})).json()}async function st(n){return(await fetch(R+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"comment",value:n})})).json()}var A={data:v,get:z,getText:Qe,done:Z,startProcedure:Ze,back:et,skip:tt,comment:st};class nt{constructor(){s(this,"logo","./public/pride-view.png");s(this,"pride",P({},A.data));s(this,"immersiveMode",!1);s(this,"worldInteraction",!1)}async get(){await A.get(),this.pride=P({},A.data)}async back(){await A.back(),this.get()}async done(e){await A.done(e),this.get()}start(){return this.get(),this}}const ee=Symbol("state");function it(){return G(J(ee))}function at(){const n=Y(new nt).start(),e=K(Ke).provide(ee,n).mount(document.createElement("div"));return{state:n,vue:e}}const rt=V({setup(){return mt()}}),ot={class:"label"},ct=l("link",{rel:"stylesheet",href:"./modules/Label.css"},null,-1),dt=l("link",{crossorigin:"anonymous",href:"https://fonts.googleapis.com/css?family=Inconsolata:400,700",rel:"stylesheet"},null,-1);function lt(n,e,t,a,p,d){return H(),F("div",ot,[ct,dt,l("span",null,E(n.message),1)])}var pt=Q(rt,[["render",lt]]);function ut(){return Y({message:""})}const te=Symbol("state");function mt(){return G(J(te))}function ht(n=""){const e=ut();e.message=n;const t=K(pt).provide(te,e).mount(document.createElement("div"));return{state:e,vue:t}}class yt{constructor(e){this.app=e}}class ft extends yt{constructor(e){super(e);s(this,"augmentations",{});s(this,"pride",at());s(this,"state",this.pride.state);s(this,"main",this.app.createWebLayerTree(this.pride.vue.$el,{onLayerCreate:e=>{const t=this.app.system.getAdapter(e);t.opacity.enabled=!0,t.onUpdate=()=>e.update()}}));s(this,"procedure",this.main.querySelector("#procedure"));s(this,"step",this.main.querySelector("#step"));s(this,"instruction",this.main.querySelector("#instruction"));s(this,"content",this.main.querySelector("#content"));s(this,"media",this.main.querySelector("#media"));s(this,"image",this.main.querySelector("#image"));s(this,"video",this.main.querySelector("#video"));s(this,"model",this.main.querySelector("#model"));s(this,"controls",this.main.querySelector("#controls"));s(this,"backButton",this.main.querySelector("#back"));s(this,"doneButton",this.main.querySelector("#done"));s(this,"recordButton",this.main.querySelector("#record"));s(this,"yesButton",this.main.querySelector("#yes"));s(this,"noButton",this.main.querySelector("#no"));s(this,"immersiveButton",this.main.querySelector("#immersive-toggle"));this.app=e;const t=()=>{const o=this.app.system.getAdapter(this.main),r=o.createLayout().bounds({center:{x:0,y:1.5,z:-1}}).orientation(b).scale(new q(.5,.5,.5)),i=o.createLayout().poseRelativeTo(this.app.camera).orientation(b).keepAspect().visualBounds({front:"-4m",size:{y:"100 vh"},center:{x:"0 vdeg",y:"0 vdeg"}}).maximize();o.onUpdate=()=>{this.main.options.autoRefresh=this.app.timeSinceLastResize>100,this.main.update(),this.state.worldInteraction=this.app.interactionSpace==="world",this.app.interactionSpace==="world"?o.layouts=[r]:this.app.interactionSpace==="screen"?o.layouts=[i]:o.layouts=[]};const c=this.app.system.getAdapter(this.main.contentMesh);c.onUpdate=()=>{this.state.immersiveMode?(this.main.contentMesh.position.set(0,0,-1),c.opacity.target=0):(this.main.contentMesh.position.set(0,0,0),c.opacity.target=1)},setTimeout(()=>this.video.element.play(),5e3)},a=()=>{const o=this.app.treadmill.poster;o.material.transparent=!0,this.app.scene.add(o);const r=e.system.getAdapter(o);r.onUpdate=()=>{if(this.state.immersiveMode){const i=this.app.interactionSpace==="screen";o.position.set(0,i?-.8:.5,i?-2:-1),r.opacity.target=1}else o.position.set(0,0,-5),r.opacity.target=0}},p=()=>{const o=this.app.treadmill.snubber;this.app.scene.add(o);const r=e.system.getAdapter(o);r.transition.maxWait=10;const i=r.createLayout().poseRelativeTo(this.model).orientation(b).keepAspect("xyz").visualBounds({back:"100%",left:{gt:"10px"},right:{lt:"-10px"},bottom:{gt:"10px"},top:{lt:"-10px"}}).maximize({minAreaPercent:.1}),u=[r.createLayout().poseRelativeTo(this.app.treadmill.poster).scale(re).bounds({center:this.app.treadmill.snubberAnchorPosition}).orientation(b)],M=[i];r.onUpdate=()=>{this.state.immersiveMode?r.layouts=u:r.layouts=M,this.updateAugmentations()},r.onPostUpdate=()=>{}},d=()=>{const o=this.app.system.getAdapter(this.content),r=o.createLayout().poseRelativeTo(this.app.treadmill.snubber).keepAspect("xyz").orientation(b).bounds({back:"0m",top:"0m",size:{x:"150%"},right:"-100% - 10cm"});o.onUpdate=()=>{this.state.immersiveMode?o.layouts=[r]:o.layouts=[],r.orientation(e.system.getState(this.app.treadmill.snubber).viewAlignedOrientation),this.content.update()}},m=()=>{const o=this.media,r=this.app.system.getAdapter(o),i=r.createLayout().poseRelativeTo(this.app.treadmill.poster).keepAspect("xyz").orientation(b).bounds({back:"0m",top:"0m",size:{x:"100%"},left:"100% + 10cm"});r.onUpdate=()=>{this.state.immersiveMode?r.layouts=[i]:r.layouts=[],o.update()}},f=()=>{const o=this.procedure,r=this.app.system.getAdapter(o),i=r.createLayout().poseRelativeTo(this.app.treadmill.poster).keepAspect("xyz").orientation(b).bounds({back:"100%",size:{x:"100%"},left:{gt:"-20%"},right:{lt:"20%"},bottom:"100% + 20cm"}).magnetize();r.onUpdate=()=>{this.state.immersiveMode?r.layouts=[i]:r.layouts=[],o.update()}},g=()=>{const o=this.controls,r=this.app.system.getAdapter(o),i=r.createLayout().poseRelativeTo(this.content).keepAspect("xyz").orientation(b).bounds({back:"0m",center:{x:"0m"},top:"-100% - 10cm",size:{x:"100%"}});r.createLayout().keepAspect("xyz").orientation(new Ee.exports.Quaternion(1,0,0,1)).bounds({center:{x:0,y:0,z:0}}),r.onUpdate=()=>{this.state.immersiveMode?r.layouts=[i]:r.layouts=[],o.update()}};t(),d(),a(),p(),m(),f(),g(),this.backButton.element.addEventListener("click",async()=>{this.state.back()}),this.doneButton.element.addEventListener("click",async()=>{this.state.done()}),this.recordButton.element.addEventListener("click",async()=>{this.state.done()}),this.yesButton.element.addEventListener("click",async()=>{this.state.done("yes")}),this.noButton.element.addEventListener("click",async()=>{this.state.done("no")}),this.immersiveButton.element.addEventListener("click",async()=>{this.state.immersiveMode=!this.state.immersiveMode,this.state.immersiveMode&&this.app.enterXR()})}updateAugmentations(){const e=this.state.pride.objects;for(const t in this.augmentations)this.augmentations[t].scale.setScalar(1e-5);for(const t in e){const a=e[t],p=JSON.stringify(a);let d=this.augmentations[t];if(!d||d.userData.pride!==p){switch(delete this.augmentations[t],a.type){case"box":const m=a.size;d=new L(new Le(m.x*.01,m.y*.01,m.z*.01),new j({transparent:!0,blending:I}));break;case"sphere":d=new L(new Re(a.radius*.01),new j({transparent:!0,blending:I}));break;case"label":const f=ht(a.label);d=new C(f.vue.$el);break;default:d=new k;break}d.userData.pride=p,this.augmentations[t]=d}a.position&&(d.scale.setScalar(1),this.app.treadmill.snubber.add(d),d.position.copy(a.position).multiplyScalar(.01),d instanceof C&&d.update()),a.rotation,d.updateMatrix()}}update(e){}}O.prototype.computeBoundsTree=Te;O.prototype.disposeBoundsTree=_e;L.prototype.raycast=Ae;class gt extends Me{constructor(){super(...arguments);s(this,"pride",A);s(this,"system",ce(this.camera));s(this,"treadmill",new Pe(this));s(this,"ui",new ft(this));s(this,"ethereal",de)}}const w=new gt({onUpdate:n=>{w.renderer.getSize(w.system.viewResolution),w.system.update(n.deltaTime,n.elapsedTime)},onEnterXR:n=>{},onExitXR:n=>{w.ui.state.immersiveMode=!1}});w.system.transition.duration=1.5;w.system.transition.easing=oe.easeOut;w.start().catch(n=>{console.log(n.stack),alert(n)});Object.assign(window,{THREE:N,app:w});
