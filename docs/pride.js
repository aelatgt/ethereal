var ne=Object.defineProperty;var U=Object.getOwnPropertySymbols;var ie=Object.prototype.hasOwnProperty,ae=Object.prototype.propertyIsEnumerable;var B=(n,e,t)=>e in n?ne(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,P=(n,e)=>{for(var t in e||(e={}))ie.call(e,t)&&B(n,t,e[t]);if(U)for(var t of U(e))ae.call(e,t)&&B(n,t,e[t]);return n};var s=(n,e,t)=>(B(n,typeof e!="symbol"?e+"":e,t),t);import{d as W,W as C,Q as b,b as oe,f as re,c as ce,e as de}from"./WebContainer3D.js";import{ar as le,at as pe,b as ue,P as $,W as me,C as he,V as ye,i as fe,O as k,au as ge,r as j,M as A,av as X,aw as D,ax as N,ay as O,az as be,aA as ve,T as V,ah as we,q as xe,m as I,ae as Se,aB as Re,d as F,aC as H,aD as l,aE as q,aF as T,aG as L,aH as E,aI as G,aJ as J,aK as Y,aL as Q,aM as K,j as Le,aN as Ee,aO as Te,aP as _e,aQ as Ae,aR as Me}from"./vendor.js";var Z=(n,e)=>{const t=n.__vccOpts||n;for(const[a,p]of e)t[a]=p;return t};class ke{constructor(e){s(this,"scene",new ue);s(this,"camera",new $);s(this,"uiView",new $);s(this,"renderer",new me({antialias:!1,alpha:!0,powerPreference:"high-performance"}));s(this,"clock",new he);s(this,"pointer",new ye);s(this,"raycaster",new fe);s(this,"mouseRay",[this.raycaster.ray]);s(this,"immersiveRays",new Set);s(this,"interactionRays",[]);s(this,"xrObjects",new Map);s(this,"controllers",{});s(this,"webContainers",new Set);s(this,"onAnimate",()=>{const e=this.renderer.domElement;this._setSize(e.clientWidth,e.clientHeight,window.devicePixelRatio);const t=Math.min(this.clock.getDelta(),1/60);this.update(t),this.renderer.render(this.scene,this.camera)});s(this,"_wasPresenting",!1);s(this,"update",e=>{if(this.interactionRays.length=0,this.interactionSpace==="world")for(const t of this.immersiveRays)this.interactionRays.push(t);else for(const t of this.mouseRay)this.interactionRays.push(t);if(this.xrPresenting){this._wasPresenting=!0;const t=this.renderer.xr.getCamera(this.camera);this.camera.matrix.copy(t.matrix),this.camera.matrix.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.projectionMatrix.copy(t.projectionMatrix),this.camera.projectionMatrixInverse.copy(this.camera.projectionMatrix).invert(),this.camera.updateWorldMatrix(!0,!0)}else{this._wasPresenting&&(this._wasPresenting=!1,this._exitXR(),this.interactionSpace="screen");const t=this.renderer.domElement,a=t.clientWidth,p=t.clientHeight,d=a/p;this.camera.aspect=d,this.camera.near=.001,this.camera.far=1e3,this.camera.updateProjectionMatrix()}this.raycaster.setFromCamera(this.pointer,this.camera),this._config.onUpdate({type:"update",deltaTime:e,elapsedTime:this.clock.elapsedTime})});s(this,"interactionSpace","screen");s(this,"session");s(this,"vuforia");s(this,"frameOfReference");s(this,"lastResize",0);s(this,"lastWidth",window.innerWidth);s(this,"lastHeight",window.innerHeight);s(this,"timeSinceLastResize",0);this._config=e,W.initialize(this.renderer),W.instance.importCache("./public/web.pride.cache"),this.scene.add(this.camera);const t=this.renderer;document.documentElement.append(this.renderer.domElement),t.outputEncoding=le,t.domElement.style.backgroundColor="darkgray",t.domElement.style.position="fixed",t.domElement.style.width="100%",t.domElement.style.height="100%",t.domElement.style.top="0",t.domElement.addEventListener("mousemove",p),t.domElement.addEventListener("touchmove",m,{passive:!1}),t.domElement.addEventListener("touchstart",f,{passive:!1}),t.domElement.addEventListener("touchend",g,{passive:!1}),t.domElement.addEventListener("click",d,!1),t.setAnimationLoop(this.onAnimate),t.setClearColor(new pe("white"),0),window.addEventListener("vrdisplaypresentchange",i=>{setTimeout(()=>{this.xrPresenting||this._exitXR()})},!1),document.documentElement.style.width="100%",document.documentElement.style.height="100%";const a=(i,c)=>{this.pointer.x=(i+window.pageXOffset)/document.documentElement.offsetWidth*2-1,this.pointer.y=-(c+window.pageYOffset)/document.documentElement.offsetHeight*2+1};function p(i){a(i.clientX,i.clientY)}function d(i){r(i)}function m(i){i.preventDefault(),a(i.touches[0].clientX,i.touches[0].clientY)}function f(i){a(i.touches[0].clientX,i.touches[0].clientY),r(i)}function g(i){setTimeout(()=>a(-1/0,-1/0),400)}const r=i=>{for(const c of this.webContainers){const u=c.hitTest(this.raycaster.ray);u&&(u.target.dispatchEvent(new i.constructor(i.type,i)),u.target.focus(),console.log("hit",u.target,u.layer))}},o=i=>{const c=t.xr.getController(i);if(!c)return;const u=t.xr.getControllerGrip(i);this.scene.add(c),u&&this.scene.add(u),c.addEventListener("selectstart",S=>{for(const h of this.webContainers){const y=h.hitTest(c);y&&(y.target.click(),y.target.focus())}}),c.addEventListener("selectend",S=>{});function M(S){let h,y;switch(S.targetRayMode){case"tracked-pointer":return h=new X,h.setAttribute("position",new D([0,0,0,0,0,-30],3)),h.setAttribute("color",new D([.9,.9,.9,0,0,0],3)),y=new N({vertexColors:!0,blending:O,linewidth:3}),new be(h,y);case"gaze":return h=new ge(.02,.04,32).translate(0,0,-1),y=new j({opacity:.5,transparent:!0}),new A(h,y)}}let x;c.addEventListener("connected",S=>{const y=t.xr.getSession().inputSources[i];x=M(y),x&&c.add(x),this.immersiveRays.add(c),this.controllers[y.handedness]={ray:c,grip:u}}),c.addEventListener("disconnected",()=>{x&&c.remove(x),this.immersiveRays.delete(c);const h=t.xr.getSession().inputSources[i];delete this.controllers[h.handedness]})};o(0),o(1),o(2)}createWebLayerTree(e,t){const a=new C(e,t);return a.interactionRays=this.interactionRays,this.webContainers.add(a),this.scene.add(a),a.rootLayer}getXRObject3D(e){let t=this.xrObjects.get(e);return t||(t=new k,t.xrCoordinateSystem=e,this.xrObjects.set(e,t),t)}async start(){return this.enterXR().catch(()=>{console.log("Enter XR failed"),this.renderer.domElement.style.backgroundColor="lightgrey"})}get xrPresenting(){return this.renderer.xr.isPresenting}async enterXR(){if(this.xrPresenting)return;if(!navigator.xr)throw new Error("WebXR is not supported by this browser");const e=async a=>{this.session&&this.session.end(),this.session=a,this.interactionSpace="world",await this.renderer.xr.setSession(a),a.addEventListener("end",()=>{this.session=void 0,this.frameOfReference=void 0,this._exitXR()}),this._enterXR()};if(navigator.xr.requestSession){var t={optionalFeatures:["local-floor","bounded-floor","hand-tracking"]};return await navigator.xr.isSessionSupported("immersive-ar",t)?(console.log("AR supported, trying AR"),navigator.xr.requestSession("immersive-ar",t).then(e)):(console.log("AR not supported, trying VR"),navigator.xr.requestSession("immersive-vr",t).then(e))}}_enterXR(){this.renderer.xr.enabled=!0,this._config.onEnterXR({type:"enterxr"})}_exitXR(){this._config.onExitXR({type:"exitxr"}),this.camera.position.set(0,0,0),this.camera.quaternion.set(0,0,0,1),this.interactionSpace="screen",this.renderer.xr.enabled=!1}_setSize(e,t,a=1){if(this.timeSinceLastResize=performance.now()-this.lastResize,this.xrPresenting)return;(e!==this.lastWidth||t!==this.lastHeight)&&(this.lastWidth=e,this.lastHeight=t,this.lastResize=performance.now());const p=this.renderer.domElement;this.timeSinceLastResize>2e3&&(p.width!==e*a||p.height!==t*a)&&(this.renderer.setSize(e,t,!1),this.renderer.setPixelRatio(a))}}const Pe=ve(P({},V));class je{constructor(e){s(this,"textureLoader",new we);s(this,"stlLoader",new Pe);s(this,"snubber",new k);s(this,"poster",new A(new xe(1.04,2),new j));s(this,"snubberAnchor",new k);s(this,"snubberAnchorPosition",new I().set(-.33,.92,.18));s(this,"snubberMesh");s(this,"lineMaterial",new N({color:16753920,depthTest:!1}));s(this,"_scratchMatrix",new Se);s(this,"annotations",[{text:"TEST",anchorPoint:[0,0,0]},{text:"Part A",anchorPoint:[-.18,.06,.09]},{text:"Part B",anchorPoint:[.05,.05,.12]},{text:"Part C",anchorPoint:[-.1,.05,.11]},{text:"Part D",anchorPoint:[.14,-.22,-.06]},{text:"Part E",anchorPoint:[.11,0,.1]},{text:"Part F",anchorPoint:[-.06,-.04,.02]}]);s(this,"annotationState",new Map);this.app=e,this.loadPoser(),this.loadSnubberMesh()}loadPoser(){this.poster.name="poster",this.textureLoader.load("./public/Treadmill.jpeg",e=>{this.poster.material.map=e,this.poster.material.needsUpdate=!0}),this.poster.add(this.snubberAnchor),this.snubberAnchor.position.copy(this.snubberAnchorPosition)}loadSnubberMesh(){this.snubber.name="snubber";const e=new k;e.quaternion.setFromAxisAngle(new I(0,0,1),Math.PI),e.scale.setScalar(.01),this.stlLoader.load("./public/fullSnubberSimplified.stl",t=>{t.computeBoundsTree();const a=new Re,p=new A(t,a);this.snubberMesh=p,this.snubberMesh.scale.setScalar(.1),e.add(p),this.snubber.add(e)})}async enterXR(e){}update(e){}}const ze=F({setup(){return at()}}),Be=l("link",{crossorigin:"anonymous",href:"https://fonts.googleapis.com/css?family=Inconsolata:400,700",rel:"stylesheet"},null,-1),Ce=l("link",{rel:"stylesheet",href:"./modules/Pride.css"},null,-1),Oe={"xr-layer":"",id:"procedure"},Ie={id:"flex"},qe={"xr-layer":"",id:"content"},Xe={id:"step","xr-layer":""},Ue=q("Step: "),We={id:"type"},$e={id:"instruction","xr-layer":""},De={"xr-layer":"",id:"media"},Ne=l("div",{"xr-layer":"",id:"model"},null,-1),Ve=l("div",{"xr-layer":"",class:"button",id:"back"},"Back",-1),Fe={"xr-layer":"",class:"button",id:"done"},He={"xr-layer":"",class:"button",id:"yes"},Ge={"xr-layer":"",class:"button",id:"no"},Je={"xr-layer":"",class:"button",id:"record"},Ye={"xr-layer":"",class:"button",id:"immersive-toggle"};function Qe(n,e,t,a,p,d){return G(),H("div",{id:"pride","xr-pixel-ratio":"0.01",class:{xr:n.immersiveMode}},[Be,Ce,l("div",Oe,[l("img",{"xr-layer":"",class:"logo",src:n.logo},null,8,["src"]),q("Procedure: "+T(n.pride.procedure),1)]),l("div",Ie,[l("div",qe,[l("div",Xe,[Ue,l("span",We,T(n.pride.elementSubType),1),q(" "+T(n.pride.step),1)]),l("div",$e,T(n.pride.instruction),1)]),l("div",De,[L(l("video",{"xr-layer":"",id:"video",loop:"","webkit-playsinline":"",playsinline:"true",crossorigin:"anonymous",muted:"",src:n.pride.video},null,8,["src"]),[[E,n.pride.video]]),L(l("img",{"xr-layer":"",id:"image",crossorigin:"anonymous",src:n.pride.image},null,8,["src"]),[[E,n.pride.image]])]),Ne]),l("div",{id:"controls",class:{worldInteraction:n.worldInteraction},"xr-layer":""},[Ve,L(l("div",Fe,"Done",512),[[E,["ManualInstruction","ClarifyingInfo","VerifyInstruction"].indexOf(n.pride.elementSubType)>-1]]),L(l("div",He,"Yes",512),[[E,n.pride.elementSubType==="Conditional"]]),L(l("div",Ge,"No",512),[[E,n.pride.elementSubType==="Conditional"]]),L(l("div",Je,"Record",512),[[E,n.pride.elementSubType==="RecordInstruction"]]),l("div",Ye,[l("b",null,T(n.immersiveMode?"Flat":"Immersive"),1)])],2)],2)}var Ke=Z(ze,[["render",Qe]]);const R="https://prideview-ar.traclabs.com:8025/AR_server/",v={json:"",procedure:"Treadmill Monthly Maintenance",step:"",instruction:"Loading...",image:"",video:"./public/armWiggleDemonstrated.mov",elementType:"",elementSubType:"",objects:{}};async function z(){const e=await(await fetch(R+"ARready",{mode:"cors"}).catch()).json().catch(),t=e&&e.procedureElementInfo&&e.procedureElementInfo.steplist;if(!t)return await z();if(e.text==="continue procedure")return await ee(),await z();v.json=e,v.step=t[t.length-1].title,v.instruction=e.text,v.elementType=e.procedureElementInfo.elementType,v.elementSubType=e.procedureElementInfo.elementData[v.elementType.toLowerCase()+"Type"];const a=Object.keys(e).filter(p=>p.toLowerCase().includes("object"));for(const p of a){const d=e[p],m=v.objects[d.name]={},f=d.properties;for(const g in f)if(g==="realityaugmentation"){const r=f[g].split(";");for(const o of r){if(!o)continue;let[i,c]=o.split(":");if(i=i.trim(),c=c.trim(),i==="position"||i==="rotation"||i==="size"){const[u,M,x]=c.split(" ").map(S=>parseFloat(S));m[i]={x:u,y:M,z:x}}else m[i]=isNaN(c)?c:parseFloat(c)}}else m[g]=f[g]}return e}async function Ze(){return(await fetch(R+"ARready",{mode:"cors"})).text()}async function ee(n="none"){const e=await fetch(R+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"done",value:n})});return z(),e.json()}async function et(n){return(await fetch(R+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:n})})).json()}async function tt(){return(await fetch(R+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"back",value:"none"})})).json()}async function st(){return(await fetch(R+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"skip",value:"none"})})).json()}async function nt(n){return(await fetch(R+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"comment",value:n})})).json()}var _={data:v,get:z,getText:Ze,done:ee,startProcedure:et,back:tt,skip:st,comment:nt};class it{constructor(){s(this,"logo","./public/pride-view.png");s(this,"pride",P({},_.data));s(this,"immersiveMode",!1);s(this,"worldInteraction",!1)}async get(){await _.get(),this.pride=P({},_.data)}async back(){await _.back(),this.get()}async done(e){await _.done(e),this.get()}start(){return this.get(),this}}const te=Symbol("state");function at(){return J(Y(te))}function ot(){const n=Q(new it).start(),e=K(Ke).provide(te,n).mount(document.createElement("div"));return{state:n,vue:e}}const rt=F({setup(){return ht()}}),ct={class:"label"},dt=l("link",{rel:"stylesheet",href:"./modules/Label.css"},null,-1),lt=l("link",{crossorigin:"anonymous",href:"https://fonts.googleapis.com/css?family=Inconsolata:400,700",rel:"stylesheet"},null,-1);function pt(n,e,t,a,p,d){return G(),H("div",ct,[dt,lt,l("span",null,T(n.message),1)])}var ut=Z(rt,[["render",pt]]);function mt(){return Q({message:""})}const se=Symbol("state");function ht(){return J(Y(se))}function yt(n=""){const e=mt();e.message=n;const t=K(ut).provide(se,e).mount(document.createElement("div"));return{state:e,vue:t}}class ft{constructor(e){this.app=e}}class gt extends ft{constructor(e){super(e);s(this,"augmentations",{});s(this,"pride",ot());s(this,"state",this.pride.state);s(this,"main",this.app.createWebLayerTree(this.pride.vue.$el,{onLayerCreate:e=>{const t=this.app.system.getAdapter(e);t.opacity.enabled=!0,t.onUpdate=()=>e.update()}}));s(this,"procedure",this.main.querySelector("#procedure"));s(this,"step",this.main.querySelector("#step"));s(this,"instruction",this.main.querySelector("#instruction"));s(this,"content",this.main.querySelector("#content"));s(this,"media",this.main.querySelector("#media"));s(this,"image",this.main.querySelector("#image"));s(this,"video",this.main.querySelector("#video"));s(this,"model",this.main.querySelector("#model"));s(this,"controls",this.main.querySelector("#controls"));s(this,"backButton",this.main.querySelector("#back"));s(this,"doneButton",this.main.querySelector("#done"));s(this,"recordButton",this.main.querySelector("#record"));s(this,"yesButton",this.main.querySelector("#yes"));s(this,"noButton",this.main.querySelector("#no"));s(this,"immersiveButton",this.main.querySelector("#immersive-toggle"));this.app=e;const t=()=>{const r=this.app.system.getAdapter(this.main),o=r.createLayout().bounds({center:{x:0,y:1.5,z:-1}}).orientation(b).scale(new I(.5,.5,.5)),i=r.createLayout().poseRelativeTo(this.app.camera).orientation(b).keepAspect().visualBounds({front:"-4m",size:{y:"100 vh"},center:{x:"0 vdeg",y:"0 vdeg"}}).maximize();r.onUpdate=()=>{this.main.container.options.autoRefresh=this.app.timeSinceLastResize>100,this.main.update(),this.state.worldInteraction=this.app.interactionSpace==="world",this.app.interactionSpace==="world"?r.layouts=[o]:this.app.interactionSpace==="screen"?r.layouts=[i]:r.layouts=[]};const c=this.app.system.getAdapter(this.main.contentMesh);c.onUpdate=()=>{this.state.immersiveMode?(this.main.contentMesh.position.set(0,0,-1),c.opacity.target=0):(this.main.contentMesh.position.set(0,0,0),c.opacity.target=1)},setTimeout(()=>this.video.element.play(),5e3)},a=()=>{const r=this.app.treadmill.poster;r.material.transparent=!0,this.app.scene.add(r);const o=e.system.getAdapter(r);o.onUpdate=()=>{if(this.state.immersiveMode){const i=this.app.interactionSpace==="screen";r.position.set(0,i?-.8:.5,i?-2:-1),o.opacity.target=1}else r.position.set(0,0,-5),o.opacity.target=0}},p=()=>{const r=this.app.treadmill.snubber;this.app.scene.add(r);const o=e.system.getAdapter(r);o.transition.maxWait=10;const i=o.createLayout().poseRelativeTo(this.model).orientation(b).keepAspect("xyz").visualBounds({back:"100%",left:{gt:"10px"},right:{lt:"-10px"},bottom:{gt:"10px"},top:{lt:"-10px"}}).maximize({minAreaPercent:.1}),u=[o.createLayout().poseRelativeTo(this.app.treadmill.poster).scale(oe).bounds({center:this.app.treadmill.snubberAnchorPosition}).orientation(b)],M=[i];o.onUpdate=()=>{this.state.immersiveMode?o.layouts=u:o.layouts=M,this.updateAugmentations()},o.onPostUpdate=()=>{}},d=()=>{const r=this.app.system.getAdapter(this.content),o=r.createLayout().poseRelativeTo(this.app.treadmill.snubber).keepAspect("xyz").orientation(b).bounds({back:"0m",top:"0m",size:{x:"150%"},right:"-100% - 10cm"});r.onUpdate=()=>{this.state.immersiveMode?r.layouts=[o]:r.layouts=[],o.orientation(e.system.getState(this.app.treadmill.snubber).viewAlignedOrientation),this.content.update()}},m=()=>{const r=this.media,o=this.app.system.getAdapter(r),i=o.createLayout().poseRelativeTo(this.app.treadmill.poster).keepAspect("xyz").orientation(b).bounds({back:"0m",top:"0m",size:{x:"100%"},left:"100% + 10cm"});o.onUpdate=()=>{this.state.immersiveMode?o.layouts=[i]:o.layouts=[],r.update()}},f=()=>{const r=this.procedure,o=this.app.system.getAdapter(r),i=o.createLayout().poseRelativeTo(this.app.treadmill.poster).keepAspect("xyz").orientation(b).bounds({back:"100%",size:{x:"100%"},left:{gt:"-20%"},right:{lt:"20%"},bottom:"100% + 20cm"}).magnetize();o.onUpdate=()=>{this.state.immersiveMode?o.layouts=[i]:o.layouts=[],r.update()}},g=()=>{const r=this.controls,o=this.app.system.getAdapter(r),i=o.createLayout().poseRelativeTo(this.content).keepAspect("xyz").orientation(b).bounds({back:"0m",center:{x:"0m"},top:"-100% - 10cm",size:{x:"100%"}});o.createLayout().keepAspect("xyz").orientation(new Te.exports.Quaternion(1,0,0,1)).bounds({center:{x:0,y:0,z:0}}),o.onUpdate=()=>{this.state.immersiveMode?o.layouts=[i]:o.layouts=[],r.update()}};t(),d(),a(),p(),m(),f(),g(),this.backButton.element.addEventListener("click",async()=>{this.state.back()}),this.doneButton.element.addEventListener("click",async()=>{this.state.done()}),this.recordButton.element.addEventListener("click",async()=>{this.state.done()}),this.yesButton.element.addEventListener("click",async()=>{this.state.done("yes")}),this.noButton.element.addEventListener("click",async()=>{this.state.done("no")}),this.immersiveButton.element.addEventListener("click",async()=>{this.state.immersiveMode=!this.state.immersiveMode,this.state.immersiveMode&&this.app.enterXR()})}updateAugmentations(){const e=this.state.pride.objects;for(const t in this.augmentations)this.augmentations[t].scale.setScalar(1e-5);for(const t in e){const a=e[t],p=JSON.stringify(a);let d=this.augmentations[t];if(!d||d.userData.pride!==p){switch(delete this.augmentations[t],a.type){case"box":const m=a.size;d=new A(new Ee(m.x*.01,m.y*.01,m.z*.01),new j({transparent:!0,blending:O}));break;case"sphere":d=new A(new Le(a.radius*.01),new j({transparent:!0,blending:O}));break;case"label":const f=yt(a.label);d=new C(f.vue.$el);break;default:d=new k;break}d.userData.pride=p,this.augmentations[t]=d}a.position&&(d.scale.setScalar(1),this.app.treadmill.snubber.add(d),d.position.copy(a.position).multiplyScalar(.01),d instanceof C&&d.update()),a.rotation,d.updateMatrix()}}update(e){}}X.prototype.computeBoundsTree=_e;X.prototype.disposeBoundsTree=Ae;A.prototype.raycast=Me;class bt extends ke{constructor(){super(...arguments);s(this,"pride",_);s(this,"system",ce(this.camera));s(this,"treadmill",new je(this));s(this,"ui",new gt(this));s(this,"ethereal",de)}}const w=new bt({onUpdate:n=>{w.renderer.getSize(w.system.viewResolution),w.system.update(n.deltaTime,n.elapsedTime)},onEnterXR:n=>{},onExitXR:n=>{w.ui.state.immersiveMode=!1}});w.system.transition.duration=1.5;w.system.transition.easing=re.easeOut;w.start().catch(n=>{console.log(n.stack),alert(n)});Object.assign(window,{THREE:V,app:w});
