var e=Object.defineProperty,t=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,n=(t,s,i)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i,a=(e,a)=>{for(var r in a||(a={}))s.call(a,r)&&n(e,r,a[r]);if(t)for(var r of t(a))i.call(a,r)&&n(e,r,a[r]);return e};import{e as r,P as o,W as c,C as d,V as l,k as h,am as p,O as m,an as u,v as y,M as g,ao as b,ap as v,aq as w,ar as f,as as x,at as S,T as R,au as E,u as k,q as L,av as P,aw as T,d as A,c as M,a as z,ax as j,t as O,ay as q,az as X,o as B,aA as C,aB as I,aC as _,aD as W,n as U,aE as D,aF as H,aG as N,aH as F,aI as J}from"./vendor.js";import{W as Y,Q as V,b as G,d as Q,c as $,e as K}from"./ethereal.js";const Z=S(a({},R));class ee{constructor(e){this.app=e,this.textureLoader=new E,this.stlLoader=new Z,this.snubber=new m,this.poster=new g(new k(1.04,2),new y),this.snubberAnchor=new m,this.snubberAnchorPosition=(new L).set(-.33,.92,.18),this.lineMaterial=new w({color:16753920,depthTest:!1}),this._scratchMatrix=new P,this.annotations=[{text:"TEST",anchorPoint:[0,0,0]},{text:"Part A",anchorPoint:[-.18,.06,.09]},{text:"Part B",anchorPoint:[.05,.05,.12]},{text:"Part C",anchorPoint:[-.1,.05,.11]},{text:"Part D",anchorPoint:[.14,-.22,-.06]},{text:"Part E",anchorPoint:[.11,0,.1]},{text:"Part F",anchorPoint:[-.06,-.04,.02]}],this.annotationState=new Map,this.loadPoser(),this.loadSnubberMesh()}loadPoser(){this.poster.name="poster",this.textureLoader.load("./public/Treadmill.jpeg",(e=>{this.poster.material.map=e,this.poster.material.needsUpdate=!0})),this.poster.add(this.snubberAnchor),this.snubberAnchor.position.copy(this.snubberAnchorPosition)}loadSnubberMesh(){this.snubber.name="snubber";const e=new m;e.quaternion.setFromAxisAngle(new L(0,0,1),Math.PI),e.scale.setScalar(.01),this.stlLoader.load("./public/fullSnubberSimplified.stl",(t=>{t.computeBoundsTree();const s=new T,i=new g(t,s);this.snubberMesh=i,this.snubberMesh.scale.setScalar(.1),e.add(i),this.snubber.add(e)}))}async enterXR(e){}update(e){}}const te=A({setup:()=>C(I(ke))}),se=z("link",{crossorigin:"anonymous",href:"https://fonts.googleapis.com/css?family=Inconsolata:400,700",rel:"stylesheet"},null,-1),ie=z("link",{rel:"stylesheet",href:"./modules/Pride.css"},null,-1),ne={"xr-layer":"",id:"procedure"},ae={id:"flex"},re={"xr-layer":"",id:"content"},oe={id:"step","xr-layer":""},ce=j("Step: "),de={id:"type"},le={id:"instruction","xr-layer":""},he={"xr-layer":"",id:"media"},pe=z("div",{"xr-layer":"",id:"model"},null,-1),me=z("div",{"xr-layer":"",class:"button",id:"back"},"Back",-1),ue={"xr-layer":"",class:"button",id:"done"},ye={"xr-layer":"",class:"button",id:"yes"},ge={"xr-layer":"",class:"button",id:"no"},be={"xr-layer":"",class:"button",id:"record"},ve={"xr-layer":"",class:"button",id:"immersive-toggle"};te.render=function(e,t,s,i,n,a){return B(),M("div",{id:"pride","xr-pixel-ratio":"0.01",class:{xr:e.immersiveMode}},[se,ie,z("div",ne,[z("img",{"xr-layer":"",class:"logo",src:e.logo},null,8,["src"]),j("Procedure: "+O(e.pride.procedure),1)]),z("div",ae,[z("div",re,[z("div",oe,[ce,z("span",de,O(e.pride.elementSubType),1),j(" "+O(e.pride.step),1)]),z("div",le,O(e.pride.instruction),1)]),z("div",he,[q(z("video",{"xr-layer":"",id:"video",loop:"","webkit-playsinline":"",playsinline:"true",crossorigin:"anonymous",muted:"",src:e.pride.video},null,8,["src"]),[[X,e.pride.video]]),q(z("img",{"xr-layer":"",id:"image",crossorigin:"anonymous",src:e.pride.image},null,8,["src"]),[[X,e.pride.image]])]),pe]),z("div",{id:"controls",class:{worldInteraction:e.worldInteraction},"xr-layer":""},[me,q(z("div",ue,"Done",512),[[X,["ManualInstruction","ClarifyingInfo","VerifyInstruction"].indexOf(e.pride.elementSubType)>-1]]),q(z("div",ye,"Yes",512),[[X,"Conditional"===e.pride.elementSubType]]),q(z("div",ge,"No",512),[[X,"Conditional"===e.pride.elementSubType]]),q(z("div",be,"Record",512),[[X,"RecordInstruction"===e.pride.elementSubType]]),z("div",ve,[z("b",null,O(e.immersiveMode?"Flat":"Immersive"),1)])],2)],2)};const we="https://prideview-ar.traclabs.com:8025/AR_server/",fe={json:"",procedure:"Treadmill Monthly Maintenance",step:"",instruction:"Loading...",image:"",video:"./public/armWiggleDemonstrated.mov",elementType:"",elementSubType:"",objects:{}};async function xe(){const e=await fetch(we+"ARready",{mode:"cors"}).catch(),t=await e.json().catch(),s=t&&t.procedureElementInfo&&t.procedureElementInfo.steplist;if(!s)return await xe();if("continue procedure"===t.text)return await Se(),await xe();fe.json=t,fe.step=s[s.length-1].title,fe.instruction=t.text,fe.elementType=t.procedureElementInfo.elementType,fe.elementSubType=t.procedureElementInfo.elementData[fe.elementType.toLowerCase()+"Type"];const i=Object.keys(t).filter((e=>e.toLowerCase().includes("object")));for(const n of i){const e=t[n],s=fe.objects[e.name]={},i=e.properties;for(const t in i)if("realityaugmentation"===t){const e=i[t].split(";");for(const t of e){if(!t)continue;let[e,i]=t.split(":");if(e=e.trim(),i=i.trim(),"position"===e||"rotation"===e||"size"===e){const[t,n,a]=i.split(" ").map((e=>parseFloat(e)));s[e]={x:t,y:n,z:a}}else s[e]=isNaN(i)?i:parseFloat(i)}}else s[t]=i[t]}return t}async function Se(e="none"){const t=await fetch(we+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"done",value:e})});return xe(),t.json()}var Re={data:fe,get:xe,getText:async function(){return(await fetch(we+"ARready",{mode:"cors"})).text()},done:Se,startProcedure:async function(e){return(await fetch(we+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:e})})).json()},back:async function(){return(await fetch(we+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"back",value:"none"})})).json()},skip:async function(){return(await fetch(we+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"skip",value:"none"})})).json()},comment:async function(e){return(await fetch(we+"ARready",{mode:"cors",method:"POST",body:JSON.stringify({action:"comment",value:e})})).json()}};class Ee{constructor(){this.logo="./public/pride-view.png",this.pride=a({},Re.data),this.immersiveMode=!1,this.worldInteraction=!1}async get(){await Re.get(),this.pride=a({},Re.data)}async back(){await Re.back(),this.get()}async done(e){await Re.done(e),this.get()}start(){return this.get(),this}}const ke=Symbol("state");const Le=A({setup:()=>C(I(Me))}),Pe={class:"label"},Te=z("link",{rel:"stylesheet",href:"./modules/Label.css"},null,-1),Ae=z("link",{crossorigin:"anonymous",href:"https://fonts.googleapis.com/css?family=Inconsolata:400,700",rel:"stylesheet"},null,-1);Le.render=function(e,t,s,i,n,a){return B(),M("div",Pe,[Te,Ae,z("span",null,O(e.message),1)])};const Me=Symbol("state");function ze(e=""){const t=_({message:""});t.message=e;return{state:t,vue:W(Le).provide(Me,t).mount(document.createElement("div"))}}class je{constructor(e){this.app=e,this.augmentations={},this.pride=function(){const e=_(new Ee).start();return{state:e,vue:W(te).provide(ke,e).mount(document.createElement("div"))}}(),this.state=this.pride.state,this.main=this.app.createWebLayerTree(this.pride.vue.$el,{onLayerCreate:e=>{const t=this.app.system.getAdapter(e);t.opacity.enabled=!0,t.onUpdate=()=>e.update()}}),this.procedure=this.main.querySelector("#procedure"),this.step=this.main.querySelector("#step"),this.instruction=this.main.querySelector("#instruction"),this.content=this.main.querySelector("#content"),this.media=this.main.querySelector("#media"),this.image=this.main.querySelector("#image"),this.video=this.main.querySelector("#video"),this.model=this.main.querySelector("#model"),this.controls=this.main.querySelector("#controls"),this.backButton=this.main.querySelector("#back"),this.doneButton=this.main.querySelector("#done"),this.recordButton=this.main.querySelector("#record"),this.yesButton=this.main.querySelector("#yes"),this.noButton=this.main.querySelector("#no"),this.immersiveButton=this.main.querySelector("#immersive-toggle");(()=>{const e=this.app.system.getAdapter(this.main),t=e.createLayout().bounds({center:{x:0,y:1.5,z:-1}}).orientation(V).scale(new L(.5,.5,.5)),s=e.createLayout().poseRelativeTo(this.app.camera).orientation(V).keepAspect().visualBounds({front:"-4m",size:{y:"100 vh"},center:{x:"0 vdeg",y:"0 vdeg"}}).maximize();e.onUpdate=()=>{this.main.options.autoRefresh=this.app.timeSinceLastResize>100,this.main.update(),this.state.worldInteraction="world"===this.app.interactionSpace,"world"===this.app.interactionSpace?e.layouts=[t]:"screen"===this.app.interactionSpace?e.layouts=[s]:e.layouts=[]};const i=this.app.system.getAdapter(this.main.contentMesh);i.onUpdate=()=>{this.state.immersiveMode?(this.main.contentMesh.position.set(0,0,-1),i.opacity.target=0):(this.main.contentMesh.position.set(0,0,0),i.opacity.target=1)},setTimeout((()=>this.video.element.play()),5e3)})(),(()=>{const t=this.app.system.getAdapter(this.content),s=t.createLayout().poseRelativeTo(this.app.treadmill.snubber).keepAspect("xyz").orientation(V).bounds({back:"0m",top:"0m",size:{x:"150%"},right:"-100% - 10cm"});t.onUpdate=()=>{this.state.immersiveMode?t.layouts=[s]:t.layouts=[],s.orientation(e.system.getState(this.app.treadmill.snubber).viewAlignedOrientation),this.content.update()}})(),(()=>{const t=this.app.treadmill.poster;t.material.transparent=!0,this.app.scene.add(t);const s=e.system.getAdapter(t);s.onUpdate=()=>{if(this.state.immersiveMode){const e="screen"===this.app.interactionSpace;t.position.set(0,e?-.8:.5,e?-2:-1),s.opacity.target=1}else t.position.set(0,0,-5),s.opacity.target=0}})(),(()=>{const t=this.app.treadmill.snubber;this.app.scene.add(t);const s=e.system.getAdapter(t);s.transition.maxWait=10;const i=s.createLayout().poseRelativeTo(this.model).orientation(V).keepAspect("xyz").visualBounds({back:"100%",left:{gt:"10px"},right:{lt:"-10px"},bottom:{gt:"10px"},top:{lt:"-10px"}}).maximize({minAreaPercent:.1}),n=[s.createLayout().poseRelativeTo(this.app.treadmill.poster).scale(G).bounds({center:this.app.treadmill.snubberAnchorPosition}).orientation(V)],a=[i];s.onUpdate=()=>{this.state.immersiveMode?s.layouts=n:s.layouts=a,this.updateAugmentations()},s.onPostUpdate=()=>{}})(),(()=>{const e=this.media,t=this.app.system.getAdapter(e),s=t.createLayout().poseRelativeTo(this.app.treadmill.poster).keepAspect("xyz").orientation(V).bounds({back:"0m",top:"0m",size:{x:"100%"},left:"100% + 10cm"});t.onUpdate=()=>{this.state.immersiveMode?t.layouts=[s]:t.layouts=[],e.update()}})(),(()=>{const e=this.procedure,t=this.app.system.getAdapter(e),s=t.createLayout().poseRelativeTo(this.app.treadmill.poster).keepAspect("xyz").orientation(V).bounds({back:"100%",size:{x:"100%"},left:{gt:"-20%"},right:{lt:"20%"},bottom:"100% + 20cm"}).magnetize();t.onUpdate=()=>{this.state.immersiveMode?t.layouts=[s]:t.layouts=[],e.update()}})(),(()=>{const e=this.controls,t=this.app.system.getAdapter(e),s=t.createLayout().poseRelativeTo(this.content).keepAspect("xyz").orientation(V).bounds({back:"0m",center:{x:"0m"},top:"-100% - 10cm",size:{x:"100%"}});t.createLayout().keepAspect("xyz").orientation(new H.exports.Quaternion(1,0,0,1)).bounds({center:{x:0,y:0,z:0}}),t.onUpdate=()=>{this.state.immersiveMode?t.layouts=[s]:t.layouts=[],e.update()}})(),this.backButton.element.addEventListener("click",(async()=>{this.state.back()})),this.doneButton.element.addEventListener("click",(async()=>{this.state.done()})),this.recordButton.element.addEventListener("click",(async()=>{this.state.done()})),this.yesButton.element.addEventListener("click",(async()=>{this.state.done("yes")})),this.noButton.element.addEventListener("click",(async()=>{this.state.done("no")})),this.immersiveButton.element.addEventListener("click",(async()=>{this.state.immersiveMode=!this.state.immersiveMode,this.state.immersiveMode&&this.app.enterXR()}))}updateAugmentations(){const e=this.state.pride.objects;for(const t in this.augmentations){this.augmentations[t].scale.setScalar(1e-5)}for(const t in e){const s=e[t],i=JSON.stringify(s);let n=this.augmentations[t];if(!n||n.userData.pride!==i){switch(delete this.augmentations[t],s.type){case"box":const e=s.size;n=new g(new D(.01*e.x,.01*e.y,.01*e.z),new y({transparent:!0,blending:f}));break;case"sphere":n=new g(new U(.01*s.radius),new y({transparent:!0,blending:f}));break;case"label":const t=ze(s.label);n=new Y(t.vue.$el);break;default:n=new m}n.userData.pride=i,this.augmentations[t]=n}s.position&&(n.scale.setScalar(1),this.app.treadmill.snubber.add(n),n.position.copy(s.position).multiplyScalar(.01),n instanceof Y&&n.update()),s.rotation,n.updateMatrix()}}update(e){}}b.prototype.computeBoundsTree=N,b.prototype.disposeBoundsTree=F,g.prototype.raycast=J;const Oe=new class extends class{constructor(e){this._config=e,this.scene=new r,this.camera=new o,this.uiView=new o,this.renderer=new c({antialias:!1,alpha:!0,powerPreference:"high-performance"}),this.clock=new d,this.pointer=new l,this.raycaster=new h,this.mouseRay=[this.raycaster.ray],this.immersiveRays=new Set,this.interactionRays=[],this.xrObjects=new Map,this.controllers={},this.webLayers=new Set,this.onAnimate=()=>{const e=this.renderer.domElement;this._setSize(e.clientWidth,e.clientHeight,window.devicePixelRatio);const t=Math.min(this.clock.getDelta(),1/60);this.update(t),this.renderer.render(this.scene,this.camera)},this._wasPresenting=!1,this.update=e=>{if(this.interactionRays.length=0,"world"===this.interactionSpace)for(const t of this.immersiveRays)this.interactionRays.push(t);else for(const t of this.mouseRay)this.interactionRays.push(t);if(this.xrPresenting){this._wasPresenting=!0;const e=this.renderer.xr.getCamera(this.camera);this.camera.matrix.copy(e.matrix),this.camera.matrix.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.projectionMatrix.copy(e.projectionMatrix),this.camera.projectionMatrixInverse.copy(this.camera.projectionMatrix).invert(),this.camera.updateWorldMatrix(!0,!0)}else{this._wasPresenting&&(this._wasPresenting=!1,this._exitXR(),this.interactionSpace="screen");const e=this.renderer.domElement,t=e.clientWidth/e.clientHeight;this.camera.aspect=t,this.camera.near=.001,this.camera.far=1e3,this.camera.updateProjectionMatrix()}this.raycaster.setFromCamera(this.pointer,this.camera),this._config.onUpdate({type:"update",deltaTime:e,elapsedTime:this.clock.elapsedTime})},this.interactionSpace="screen",this.lastResize=0,this.lastWidth=window.innerWidth,this.lastHeight=window.innerHeight,this.timeSinceLastResize=0,this.scene.add(this.camera);const t=this.renderer;document.documentElement.append(this.renderer.domElement),t.domElement.style.backgroundColor="darkgray",t.domElement.style.position="fixed",t.domElement.style.width="100%",t.domElement.style.height="100%",t.domElement.style.top="0",t.domElement.addEventListener("mousemove",(function(e){s(e.clientX,e.clientY)})),t.domElement.addEventListener("touchmove",(function(e){e.preventDefault(),s(e.touches[0].clientX,e.touches[0].clientY)}),{passive:!1}),t.domElement.addEventListener("touchstart",(function(e){s(e.touches[0].clientX,e.touches[0].clientY),i(e)}),{passive:!1}),t.domElement.addEventListener("touchend",(function(e){setTimeout((()=>s(-1/0,-1/0)),400)}),{passive:!1}),t.domElement.addEventListener("click",(function(e){i(e)}),!1),t.setAnimationLoop(this.onAnimate),t.setClearColor(new p("white"),0),window.addEventListener("vrdisplaypresentchange",(e=>{setTimeout((()=>{this.xrPresenting||this._exitXR()}))}),!1),document.documentElement.style.width="100%",document.documentElement.style.height="100%";const s=(e,t)=>{this.pointer.x=(e+window.pageXOffset)/document.documentElement.offsetWidth*2-1,this.pointer.y=-(t+window.pageYOffset)/document.documentElement.offsetHeight*2+1};const i=e=>{for(const t of this.webLayers){const s=t.hitTest(this.raycaster.ray);s&&(s.target.dispatchEvent(new e.constructor(e.type,e)),s.target.focus(),console.log("hit",s.target,s.layer))}},n=e=>{const s=t.xr.getController(e);if(!s)return;const i=t.xr.getControllerGrip(e);let n;this.scene.add(s),i&&this.scene.add(i),s.addEventListener("selectstart",(e=>{for(const t of this.webLayers){const e=t.hitTest(s);e&&(e.target.click(),e.target.focus())}})),s.addEventListener("selectend",(e=>{})),s.addEventListener("connected",(a=>{const r=t.xr.getSession().inputSources[e];n=function(e){let t,s;switch(e.targetRayMode){case"tracked-pointer":return t=new b,t.setAttribute("position",new v([0,0,0,0,0,-30],3)),t.setAttribute("color",new v([.9,.9,.9,0,0,0],3)),s=new w({vertexColors:!0,blending:f,linewidth:3}),new x(t,s);case"gaze":return t=new u(.02,.04,32).translate(0,0,-1),s=new y({opacity:.5,transparent:!0}),new g(t,s)}}(r),n&&s.add(n),this.immersiveRays.add(s),this.controllers[r.handedness]={ray:s,grip:i}})),s.addEventListener("disconnected",(()=>{n&&s.remove(n),this.immersiveRays.delete(s);const i=t.xr.getSession().inputSources[e];delete this.controllers[i.handedness]}))};n(0),n(1),n(2)}createWebLayerTree(e,t){const s=new Y(e,t);return s.interactionRays=this.interactionRays,this.webLayers.add(s),this.scene.add(s),s.rootLayer}getXRObject3D(e){let t=this.xrObjects.get(e);return t||(t=new m,t.xrCoordinateSystem=e,this.xrObjects.set(e,t),t)}async start(){return this.enterXR().catch((()=>{console.log("Enter XR failed"),this.renderer.domElement.style.backgroundColor="lightgrey"}))}get xrPresenting(){return this.renderer.xr.isPresenting}async enterXR(){if(this.xrPresenting)return;if(!navigator.xr)throw new Error("WebXR is not supported by this browser");const e=async e=>{this.session&&this.session.end(),this.session=e,this.interactionSpace="world",await this.renderer.xr.setSession(e),e.addEventListener("end",(()=>{this.session=void 0,this.frameOfReference=void 0,this._exitXR()})),this._enterXR()};if(navigator.xr.requestSession){var t={optionalFeatures:["local-floor","bounded-floor","hand-tracking"]};return await navigator.xr.isSessionSupported("immersive-ar",t)?(console.log("AR supported, trying AR"),navigator.xr.requestSession("immersive-ar",t).then(e)):(console.log("AR not supported, trying VR"),navigator.xr.requestSession("immersive-vr",t).then(e))}}_enterXR(){this.renderer.xr.enabled=!0,this._config.onEnterXR({type:"enterxr"})}_exitXR(){this._config.onExitXR({type:"exitxr"}),this.camera.position.set(0,0,0),this.camera.quaternion.set(0,0,0,1),this.interactionSpace="screen",this.renderer.xr.enabled=!1}_setSize(e,t,s=1){if(this.timeSinceLastResize=performance.now()-this.lastResize,this.xrPresenting)return;e===this.lastWidth&&t===this.lastHeight||(this.lastWidth=e,this.lastHeight=t,this.lastResize=performance.now());const i=this.renderer.domElement;this.timeSinceLastResize>2e3&&(i.width!==e*s||i.height!==t*s)&&(this.renderer.setSize(e,t,!1),this.renderer.setPixelRatio(s))}}{constructor(){super(...arguments),this.pride=Re,this.system=$(this.camera),this.treadmill=new ee(this),this.ui=new je(this),this.ethereal=K}}({onUpdate:e=>{Oe.renderer.getSize(Oe.system.viewResolution),Oe.system.update(e.deltaTime,e.elapsedTime)},onEnterXR:e=>{},onExitXR:e=>{Oe.ui.state.immersiveMode=!1}});Oe.system.transition.duration=1.5,Oe.system.transition.easing=Q.easeOut,Oe.start().catch((e=>{console.log(e.stack),alert(e)})),Object.assign(window,{THREE:R,app:Oe});
