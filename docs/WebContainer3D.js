var st=Object.defineProperty;var it=(a,e,t)=>e in a?st(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var r=(a,e,t)=>(it(a,typeof e!="symbol"?e+"":e,t),t);import{w as L,x as g,y as z,z as _,F as O,H as W,J as we,K as B,U as M,X as ce,Y as rt,Z as nt,_ as at,$ as ot,a0 as ct,a1 as lt,a2 as ut,a3 as ht,a4 as dt,a5 as pt,a6 as mt,a7 as ft,a8 as gt,a9 as yt,aa as wt,ab as _t,ac as bt,ad as vt,ae as le,af as xt,m as K,ag as St,O as Y,q as _e,M as be,r as ve,n as Mt,ah as Tt,ai as Z,aj as xe,ak as Et,al as Rt,am as zt,an as Bt,ao as Ct,ap as Ot,i as Lt}from"./vendor.js";const At=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerpolicy&&(n.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?n.credentials="include":i.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}};At();const Se=Object.freeze(new L(0,0)),Dt=Object.freeze(new L(1,1)),A=Object.freeze(new g(0,0,0)),Nt=Object.freeze(new g(1,0,0)),It=Object.freeze(new g(0,1,0)),Pt=Object.freeze(new g(0,0,1)),ue=Object.freeze(new g(1,1,1)),he=Object.freeze(new z),q={RIGHT:Object.freeze(new g(1,0,0)),UP:Object.freeze(new g(0,1,0)),NEAR:Object.freeze(new g(0,0,1)),LEFT:Object.freeze(new g(-1,0,0)),DOWN:Object.freeze(new g(0,-1,0)),FAR:Object.freeze(new g(0,0,-1))};function de(a,e){return typeof a=="number"?Ut(a,e):"isVector3"in a?Ft(a,e):"isVector2"in a?kt(a,e):"isBox3"in a?Vt(a,e):"isQuaternion"in a?jt(a,e):"isColor"in a?Wt(a,e):1/0}function Ut(a,e){if(e===a)return 0;const t=Math.abs(e-a),s=(Math.abs(e)+Math.abs(a))/2;return t/s}function Ft(a,e){if(e.equals(a))return 0;const t=e.distanceTo(a),s=(e.length()+a.length())/2;return t/s}function kt(a,e){if(e.equals(a))return 0;const t=e.distanceTo(a),s=(e.length()+a.length())/2;return t/s}function Vt(a,e){if(a.equals(e))return 0;const t=Me,s=e.min.distanceTo(a.min),i=e.max.distanceTo(a.max),n=(s+i)/2,o=(e.getSize(t).length()+a.getSize(t).length())/2;return n/o}const Me=new g;function jt(a,e){return a.equals(e)?0:a.angleTo(e)/Math.PI}function Wt(a,e){return a.equals(e)?0:Me.set(Math.abs(e.r-a.r),Math.abs(e.g-a.g),Math.abs(e.b-a.b)).length()/qt}const qt=Math.sqrt(3),$=(a=1)=>{var e=Math.random();return(e%1e-8>5e-9?1:-1)*Math.sqrt(-Math.log(Math.max(1e-9,e)))*a},pe=(a=1)=>{const e=Math.sqrt(Math.sqrt(1/(2*a)));return 1/$(e)**2},J=(()=>{const a=Math.PI*2,e=new g(0,0,1),t=new z,s=new z,i=new g,n=new z;return function(l=1,c=1){var u=(Math.random()-.5)*a*l,h=Math.random()*a,p=Math.random()*Math.PI*c;return i.set(1,0,0).applyAxisAngle(e,h),t.setFromAxisAngle(e,u),s.setFromAxisAngle(i,p),n.multiplyQuaternions(s,t)}})();function Te(a,e){let t=0;for(let i=0;i<a.length;i++)t+=(e==null?void 0:e[i])||1;const s=Math.random()*t;t=0;for(let i=0;i<a.length;i++)if(t+=(e==null?void 0:e[i])||1,t>s)return a[i];return a[0]}const $t=(()=>{const a=new g;return function(t,s,i){const n=a.set(t.x,t.y,t.z),o=s.dot(n),l=a.copy(s).multiplyScalar(o),c=i.set(l.x,l.y,l.z,t.w).normalize();return o<0&&(c.x=-c.x,c.y=-c.y,c.z=-c.z,c.w=-c.w),c}})();class ee{constructor(){r(this,"callbacks",[])}memoize(e,...t){t.push(this);const s=Gt(e);for(const i of t)i.callbacks.push(s);return s}invalidateAll(){const e=this.callbacks;for(let t=0;t<this.callbacks.length;t++)e[t].needsUpdate=!0}isFullyInvalid(){const e=this.callbacks;for(let t=0;t<this.callbacks.length;t++)if(!e[t].needsUpdate)return!1;return!0}}const Ee=void 0;function Gt(a){let e=Ee;const t=()=>{if(t.needsUpdate&&(t.needsUpdate=!1,e=a()),e===Ee)throw new Error("Possible recursive memoization detected");return e};return t.needsUpdate=!0,t}const te=Symbol("current"),se=Symbol("target"),Re=Symbol("previousTarget");class ze{constructor(e,t){this.mode=e,this.metrics=t}}const j=class extends ze{constructor(e,t){super(e,t);r(this,"_cache",new ee);r(this,"opacity",1);r(this,"_parent",null);r(this,"_localMatrix",new _);r(this,"_worldMatrix",new _);r(this,"_worldMatrixInverse",new _);r(this,"_worldPosition",new g);r(this,"_worldOrientation",new z);r(this,"_worldOrientationInverse",new z);r(this,"_worldScale",new g(1,1,1));r(this,"_worldRotation",new _);r(this,"_worldRotationInverse",new _);r(this,"_relativePosition",new g);r(this,"_relativeOrientation",new z);r(this,"_relativeScale",new g(1,1,1));r(this,"_cachedWorldCenter",this._cache.memoize(()=>this._worldCenter.copy(this.metrics.innerCenter).applyMatrix4(this.worldMatrix)));r(this,"_worldCenter",new g);r(this,"_cachedSpatialMatrix",this._cache.memoize(()=>{const e=this._worldFromSpatial.compose(this.outerOrigin,this.worldOrientation,ue);this._spatialFromWorld.copy(this._worldFromSpatial).invert(),this._localFromSpatial.multiplyMatrices(this.worldMatrixInverse,e),this._spatialFromLocal.copy(this._localFromSpatial).invert();const t=this.referenceState;return t?this._spatialFromReference.multiplyMatrices(this._spatialFromWorld,t.worldMatrix):this._spatialFromReference.copy(this._spatialFromWorld),e}));r(this,"_worldFromSpatial",new _);r(this,"_spatialFromWorld",new _);r(this,"_localFromSpatial",new _);r(this,"_spatialFromLocal",new _);r(this,"_spatialFromReference",new _);r(this,"_cachedSpatialBounds",this._cache.memoize(()=>{this._spatialBounds.copy(this.metrics.innerBounds);const e=this._spatialBounds.applyMatrix4(this.spatialFromLocal);return e.getCenter(this._spatialCenter),e.getSize(this._spatialSize),e}));r(this,"_spatialBounds",new O);r(this,"_spatialSize",new g);r(this,"_spatialCenter",new g);r(this,"_cachedOuterBounds",this._cache.memoize(()=>{const e=this._outerBounds,t=this.metrics.system.nodeAdapters.get(this.metrics.node);if(t)e.copy(t.outerBounds[this.mode]);else{const s=this.referenceState;s?e.copy(s.metrics.innerBounds):e.setFromCenterAndSize(A,A),e.applyMatrix4(this.spatialFromReference)}return e.getCenter(this._outerCenter),e.getSize(this._outerSize),e}));r(this,"_outerBounds",new O);r(this,"_outerCenter",new g);r(this,"_outerSize",new g);r(this,"_cachedOuterVisualBounds",this._cache.memoize(()=>{const e=this._outerVisualBounds,t=this.metrics.system.nodeAdapters.get(this.metrics.node);if(t)e.copy(t.outerVisualBounds[this.mode]);else{const s=this.referenceState;s?e.copy(s.visualBounds):e.setFromCenterAndSize(A,A)}return e.getCenter(this._outerVisualCenter),e.getSize(this._outerVisualSize),e}));r(this,"_outerVisualBounds",new O);r(this,"_outerVisualCenter",new g);r(this,"_outerVisualSize",new g);r(this,"_viewFromWorld",new _);r(this,"_viewFromSpatial",new _);r(this,"_spatialFromView",new _);r(this,"_cachedNDCBounds",this._cache.memoize(()=>{if(this.metrics.system.viewNode===this.metrics.node)return this._ndcBounds.min.setScalar(-1),this._ndcBounds.max.setScalar(1),this._ndcBounds;const t=this.metrics.system.viewFrustum.perspectiveProjectionMatrix,s=this.viewFromWorld,i=this._viewProjectionFromWorld.multiplyMatrices(t,s),n=this._ndcBounds.copy(this.metrics.innerBounds).applyMatrix4(i);return n.getCenter(this._ndcCenter),n.getSize(this._ndcSize),(!isFinite(n.min.x)||!isFinite(n.min.y)||!isFinite(n.min.z)||!isFinite(n.max.x)||!isFinite(n.max.y)||!isFinite(n.max.z))&&(n.min.setScalar(-1),n.max.setScalar(1),n.getCenter(this._ndcCenter),n.getSize(this._ndcSize)),n},this._viewState._cache));r(this,"_viewProjectionFromWorld",new _);r(this,"_ndcBounds",new O);r(this,"_ndcCenter",new g);r(this,"_ndcSize",new g);r(this,"_cachedVisualBounds",this._cache.memoize(()=>{const e=this.metrics.system,t=e.viewFrustum.perspectiveProjectionMatrix,s=this._inverseProjection.copy(t).invert(),i=this._visualBounds.copy(this.ndcBounds),n=this._v1,o=n.set(0,0,i.min.z).applyMatrix4(s).z,l=n.set(0,0,i.max.z).applyMatrix4(s).z;return i.min.z=l,i.max.z=o,i.min.x*=.5*e.viewResolution.x,i.max.x*=.5*e.viewResolution.x,i.min.y*=.5*e.viewResolution.y,i.max.y*=.5*e.viewResolution.y,i.getCenter(this._visualCenter),i.getSize(this._visualSize),i},this._viewState._cache));r(this,"_visualBounds",new O);r(this,"_visualCenter",new g);r(this,"_visualSize",new g);r(this,"_v1",new g);r(this,"_inverseProjection",new _);r(this,"_viewPosition",new g);r(this,"_cachedViewAlignedOrientation",this._cache.memoize(()=>{const e=this._relativeViewMatrix.multiplyMatrices(this.worldMatrixInverse,this._viewState.worldMatrix),t=this._relativeViewRotation.extractRotation(e),s=this._relativeViewOrientation.setFromRotationMatrix(t),i=this._relativeViewForward.set(0,0,1).applyQuaternion(s),n=this._relativeViewUp.set(0,1,0).applyQuaternion(s);let o=1/0,l=1/0,c,u,h;for(h in q){const m=q[h];var p=n.distanceToSquared(m);p<l&&(l=p,u=m)}for(h in q){const m=q[h];if(m.x&&u.x||m.y&&u.y||m.z&&u.z)continue;const f=i.distanceToSquared(m);f<o&&(o=f,c=m)}const d=this._orthogonalRotation.identity();return d.lookAt(c,A,u),this._orthogonalOrientation.setFromRotationMatrix(d)},this._viewState._cache));r(this,"_relativeViewMatrix",new _);r(this,"_relativeViewRotation",new _);r(this,"_relativeViewOrientation",new z);r(this,"_relativeViewUp",new g);r(this,"_relativeViewForward",new g);r(this,"_orthogonalRotation",new _);r(this,"_orthogonalOrientation",new z);r(this,"_computeOcclusion",this._cache.memoize(()=>{this._occludingPercent=0,this._occludedPercent=0;const e=this.metrics;if(e.innerBounds.isEmpty())return;const s=e.system.nodeAdapters.values(),i=this.visualBounds,n=i.min.z,o=j._boxA,l=j._boxB;o.min.set(i.min.x,i.min.y),o.min.set(i.max.x,i.max.y);const c=o.getSize(j._sizeA).length();for(const u of s){const h=u.metrics;if(h===e||!h.isAdaptive||h.innerBounds.isEmpty()||h.containedByNode(u.node))continue;const d=(this.mode==="current"?h.current:h.target).visualBounds;o.min.set(i.min.x,i.min.y),o.min.set(i.max.x,i.max.y),l.min.set(d.min.x,d.min.y),l.min.set(d.max.x,d.max.y);const m=o.intersect(l).getSize(j._sizeB).length()/c;m>0&&(n<d.min.z?this._occludingPercent+=m:this._occludedPercent+=m)}},this._viewState._cache));r(this,"_occludingPercent",0);r(this,"_occludedPercent",0)}invalidate(){this._cache.invalidateAll()}get parent(){return this._parent}set parent(e){this._parent!==e&&(this._parent=e,this.invalidate())}get parentState(){var e;return(e=this.metrics.parentMetrics)==null?void 0:e[this.mode]}get localMatrix(){var t;const e=(t=this.parentState)==null?void 0:t.worldMatrixInverse;return e?this._localMatrix.multiplyMatrices(e,this.worldMatrix):this._localMatrix.copy(this.worldMatrix)}get referenceState(){var e;return(e=this.metrics.referenceMetrics)==null?void 0:e[this.mode]}get worldMatrix(){return this._worldMatrix}set worldMatrix(e){if(isNaN(e.elements[0])||isNaN(e.elements[15])||e.elements[0]===0)throw new Error;this._worldMatrix.equals(e)||(this.invalidate(),this._worldMatrix.copy(e),this._worldMatrixInverse.copy(this._worldMatrix).invert(),this._worldMatrix.decompose(this._worldPosition,this._worldOrientation,this._worldScale),this._worldOrientationInverse.copy(this._worldOrientation).invert(),this._worldRotation.makeRotationFromQuaternion(this._worldOrientation),this._worldRotationInverse.makeRotationFromQuaternion(this._worldOrientationInverse))}get relativePosition(){var t;const e=(t=this.referenceState)==null?void 0:t.worldPosition;return e?this._relativePosition.subVectors(this.worldPosition,e):this._relativePosition.copy(this.worldPosition)}get relativeOrientation(){var t;const e=(t=this.referenceState)==null?void 0:t.worldOrientationInverse;return e?this._relativeOrientation.multiplyQuaternions(this.worldOrientation,e):this._relativeOrientation.copy(this.worldOrientation)}get relativeScale(){var t;const e=(t=this.referenceState)==null?void 0:t.worldScale;return e?this._relativeScale.copy(this.worldScale).divide(e):this._relativeScale.copy(this.worldScale)}get worldMatrixInverse(){return this._worldMatrixInverse}get worldPosition(){return this._worldPosition}get worldOrientation(){return this._worldOrientation}get worldScale(){return this._worldScale}get worldOrientationInverse(){return this._worldOrientationInverse}get worldRotation(){return this._worldRotation}get worldRotationInverse(){return this._worldRotationInverse}get worldCenter(){return this._cachedWorldCenter()}get spatialMatrix(){return this._cachedSpatialMatrix()}get spatialMatrixInverse(){return this.spatialMatrix,this._spatialFromWorld}get localFromSpatial(){return this.spatialMatrix,this._localFromSpatial}get spatialFromLocal(){return this.spatialMatrix,this._spatialFromLocal}get spatialFromReference(){return this.spatialMatrix,this._spatialFromReference}get spatialBounds(){return this._cachedSpatialBounds()}get spatialSize(){return this.spatialBounds,this._spatialSize}get spatialCenter(){return this.spatialBounds,this._spatialCenter}get outerBounds(){return this._cachedOuterBounds()}get outerCenter(){return this.outerBounds,this._outerCenter}get outerSize(){return this.outerBounds,this._outerSize}get outerOrigin(){return this.metrics.outerOrigin[this.mode]()}get outerOrientation(){var t,s;const e=this.metrics.system.nodeAdapters.get(this.metrics.node);return e?e.outerOrientation[this.mode]:(s=(t=this.referenceState)==null?void 0:t.worldOrientation)!=null?s:he}get outerVisualBounds(){return this._cachedOuterVisualBounds()}get outerVisualCenter(){return this.outerVisualBounds,this._outerVisualCenter}get outerVisualSize(){return this.outerVisualBounds,this._outerVisualSize}get _viewState(){if(this.metrics.system.viewNode===this.metrics.node)return this;const e=this.metrics.system.viewMetrics;return this.mode==="current"?e[te]:e[se]}get viewFromWorld(){return this._viewFromWorld.multiplyMatrices(this._viewState.worldMatrixInverse,this.worldMatrix)}get viewFromSpatial(){return this._viewFromSpatial.multiplyMatrices(this._viewState.worldMatrixInverse,this.spatialMatrix)}get spatialFromView(){return this._spatialFromView.copy(this.viewFromSpatial).invert()}get ndcBounds(){return this._cachedNDCBounds()}get ndcCenter(){return this._cachedNDCBounds(),this._ndcCenter}get ndcSize(){return this._cachedNDCBounds(),this._ndcSize}get visualBounds(){return this._cachedVisualBounds()}get visualCenter(){return this._cachedVisualBounds(),this._visualCenter}get visualSize(){return this._cachedVisualBounds(),this._visualSize}get relativeViewPosition(){return this._viewPosition.copy(this._viewState.worldPosition).applyMatrix4(this.worldMatrixInverse)}get viewAlignedOrientation(){return this._cachedViewAlignedOrientation()}get occludingPercent(){return this._computeOcclusion(),this._occludingPercent}get occludedPercent(){return this._computeOcclusion(),this._occludedPercent}visualAverageEdgeLength(){}};let N=j;r(N,"_boxA",new W),r(N,"_boxB",new W),r(N,"_sizeA",new L),r(N,"_sizeB",new L);class Ht{constructor(e,t){this.system=e,this.node=t}}var Gs,Hs,Qs;class Be extends Ht{constructor(e,t){super(e,t);r(this,"_cache",new ee);r(this,"needsUpdate",!0);r(this,"parentNode");r(this,"parentMetrics");r(this,"referenceMetrics");r(this,"_adapter");r(this,"_cachedInnerBounds",this._cache.memoize(()=>{const e=this._innerBounds;if(!this.raw.parent)return e.makeEmpty();if(this.node!==this.system.viewNode){e.copy(this.intrinsicBounds);const i=this._childBounds;for(const n of this.boundingChildMetrics)n.update(),i.copy(n.innerBounds),i.applyMatrix4(n.raw.relativeMatrix),e.union(i)}const t=e.getCenter(this._innerCenter),s=e.getSize(this._innerSize);if(s.length()>0){const i=this.system.epsillonMeters;Math.abs(s.x)<=i&&(s.x=(Math.sign(s.x)||1)*i*1e3),Math.abs(s.y)<=i&&(s.y=(Math.sign(s.y)||1)*i*1e3),Math.abs(s.z)<=i&&(s.z=(Math.sign(s.z)||1)*i*1e3,t.z-=i*1e3/2),e.setFromCenterAndSize(t,s)}return e}));r(this,"_childBounds",new O);r(this,"_innerBounds",new O);r(this,"_innerCenter",new g);r(this,"_innerSize",new g);r(this,"_intrinsicBoundsNeedsUpdate",!0);r(this,"_intrinsicBounds",new O);r(this,"_intrinsicCenter",new g);r(this,"_intrinsicSize",new g);r(this,"_cachedNodeChildren",this._cache.memoize(()=>(this.system.bindings.getChildren(this,this._nodeChildren),this._nodeChildren)));r(this,"_nodeChildren",new Array);r(this,"_computeState",(()=>{const e=new _,t=new z,s=new _,i=new g,n=new z,o=new g,l=new g,c=new g,u=new g,h=new g;return function(d){var S;d.parent=this.raw.parent;const m=this._adapter,f=(S=this.referenceMetrics)==null?void 0:S[d.mode];t.copy((m==null?void 0:m.orientation.enabled)&&(m==null?void 0:m.orientation[d.mode])||this.raw.relativeOrientation);const y=(m==null?void 0:m.bounds.enabled)&&(m==null?void 0:m.bounds[d.mode]);if(y){y.getCenter(l),y.getSize(c);const T=this.innerCenter,E=this.innerSize,x=this.system.epsillonMeters;Math.abs(c.x)<=x&&(c.x=(Math.sign(c.x)||1)*x*10),Math.abs(c.y)<=x&&(c.y=(Math.sign(c.y)||1)*x*10),Math.abs(c.z)<=x&&(c.z=(Math.sign(c.z)||1)*x*10),o.copy(c),Math.abs(E.x)>=x&&(o.x/=E.x),Math.abs(E.y)>=x&&(o.y/=E.y),Math.abs(E.z)>=x&&(o.z/=E.z),n.multiplyQuaternions(d.outerOrientation,t).normalize(),u.copy(l).applyQuaternion(n),h.copy(T).multiply(o).applyQuaternion(n),i.copy(d.outerOrigin).add(u).sub(h),s.compose(i,n,o),d.worldMatrix=s}else e.compose(this.raw.relativePosition,t,this.raw.relativeScale),d.worldMatrix=(f==null?void 0:f.worldMatrix)?s.multiplyMatrices(f==null?void 0:f.worldMatrix,e):e;const v=(m==null?void 0:m.opacity.enabled)&&(m==null?void 0:m.opacity[d.mode]);return d.opacity=typeof v=="number"?v:1,d}})());r(this,"raw",{parent:null,worldMatrix:new _,relativeMatrix:new _,opacity:0,worldPosition:new g,worldOrientation:new z,worldScale:new g,relativePosition:new g,relativeOrientation:new z,relativeScale:new g,spatialBounds:new O,worldFromSpatial:new _,localFromSpatial:new _,spatialFromLocal:new _});r(this,"outerOrigin",{current:()=>this._getOuterOrigin("current"),target:()=>this._getOuterOrigin("target")});r(this,"_cachedCurrentState",this._cache.memoize(()=>this._computeState(this[te])));r(this,Gs,new N("current",this));r(this,"_cachedTargetState",this._cache.memoize(()=>this._computeState(this[se])));r(this,Hs,new N("target",this));r(this,Qs,new N("target",this));r(this,"_cachedBoundsChildren",this._cache.memoize(()=>{const e=this.nodeChildren,t=this._boundingChildren;t.length=0;for(const s of e){const i=this.system.getMetrics(s);i.isAdaptive||t.push(i)}return t}));r(this,"_boundingChildren",[])}update(){var e,t;if(this.needsUpdate){this.needsUpdate=!1;const s=this._adapter=this.system.nodeAdapters.get(this.node);this.parentNode=this.raw.parent,this.parentMetrics=this.parentNode&&this.system.getMetrics(this.parentNode);const i=((e=s==null?void 0:s.activeLayout)==null?void 0:e.referenceNode)||(s==null?void 0:s.referenceNode)||this.parentNode;this.referenceMetrics=i&&this.system.getMetrics(i),(t=this.referenceMetrics)==null||t.update(),s?s._update():(this.invalidateInnerBounds(),this.invalidateStates(),this.updateRawState())}}get innerBounds(){return this._cachedInnerBounds()}get innerCenter(){return this.innerBounds,this._innerCenter}get innerSize(){return this.innerBounds,this._innerSize}get intrinsicBounds(){return this._intrinsicBoundsNeedsUpdate&&(this._intrinsicBoundsNeedsUpdate=!1,this.system.bindings.getIntrinsicBounds(this,this._intrinsicBounds),this._intrinsicBounds.getCenter(this._intrinsicCenter),this._intrinsicBounds.getSize(this._intrinsicSize)),this._intrinsicBounds}get intrinsicCenter(){return this.intrinsicBounds,this._intrinsicCenter}get intrinsicSize(){return this.intrinsicBounds,this._intrinsicSize}invalidateIntrinsicBounds(){this._intrinsicBoundsNeedsUpdate=!0;for(const e of this.boundingChildMetrics)e.invalidateIntrinsicBounds()}invalidateInnerBounds(){if(!this._cachedInnerBounds.needsUpdate){this._cachedNodeChildren.needsUpdate=!0,this._cachedBoundsChildren.needsUpdate=!0,this._cachedInnerBounds.needsUpdate=!0;for(const e of this.boundingChildMetrics)e.invalidateInnerBounds()}}containsNode(e){this.update();let t=this.system.getMetrics(e);for(;t;){if(t.parentMetrics===this)return t.node;t=t.parentMetrics}return!1}containedByNode(e){this.update();let t=this.parentMetrics;for(;t;){if(t.node===e)return t.node;t=t.parentMetrics}return!1}get nodeChildren(){return this._cachedNodeChildren()}invalidateStates(){this._cachedCurrentState.needsUpdate=!0,this._cachedTargetState.needsUpdate=!0,this[te].invalidate(),this[se].invalidate()}updateRawState(){this.system.bindings.getState(this);const e=this.raw;e.worldMatrix.decompose(e.worldPosition,e.worldOrientation,e.worldScale),e.relativeMatrix.decompose(e.relativePosition,e.relativeOrientation,e.relativeScale),e.worldFromSpatial.compose(this.outerOrigin.target(),e.worldOrientation,ue),e.localFromSpatial.copy(e.worldMatrix).invert().multiply(e.worldFromSpatial),e.spatialFromLocal.copy(e.localFromSpatial).invert(),e.spatialBounds.copy(this.innerBounds).applyMatrix4(e.spatialFromLocal)}_getOuterOrigin(e){var s,i,n;const t=this.system.nodeAdapters.get(this.node);return t?t.outerOrigin[e]:(n=(i=(s=this.referenceMetrics)==null?void 0:s[e])==null?void 0:i.worldCenter)!=null?n:A}get current(){return this.update(),this._cachedCurrentState()}get target(){return this.update(),this._cachedTargetState()}get previousTarget(){return this.update(),this[Re]}get boundingChildMetrics(){return this._cachedBoundsChildren()}get isAdaptive(){return this.system.nodeAdapters.has(this.node)}}Gs=te,Hs=se,Qs=Re;class ie{constructor(e){r(this,"relativeTolerance");r(this,"stepSizeMin");r(this,"stepSizeMax");r(this,"stepSizeStart");r(this,"minFeasibleTime");r(this,"maxInfeasibleTime");r(this,"maxIterationsPerFrame");r(this,"swarmSize");r(this,"pulseRate");r(this,"pulseFrequencyMin");r(this,"pulseFrequencyMax");e&&Object.assign(this,e)}}class Ce{constructor(e){r(this,"_config",new ie);r(this,"_prevOrientation",new z);r(this,"_prevBounds",new O);r(this,"_scratchSolution",new D);r(this,"_scratchBestSolution",new D);this.system=e}_setConfig(e){var s,i,n,o,l,c,u,h,p,d;const t=this.system.optimize;this._config.minFeasibleTime=(s=e.minFeasibleTime)!=null?s:t.minFeasibleTime,this._config.maxInfeasibleTime=(i=e.maxInfeasibleTime)!=null?i:t.maxInfeasibleTime,this._config.pulseRate=(n=e.pulseRate)!=null?n:t.pulseRate,this._config.maxIterationsPerFrame=(o=e.maxIterationsPerFrame)!=null?o:t.maxIterationsPerFrame,this._config.swarmSize=(l=e.swarmSize)!=null?l:t.swarmSize,this._config.pulseFrequencyMin=(c=e.pulseFrequencyMin)!=null?c:t.pulseFrequencyMin,this._config.pulseFrequencyMax=(u=e.pulseFrequencyMax)!=null?u:t.pulseFrequencyMax,this._config.stepSizeMax=(h=e.stepSizeMax)!=null?h:t.stepSizeMax,this._config.stepSizeMin=(p=e.stepSizeMin)!=null?p:t.stepSizeMin,this._config.stepSizeStart=(d=e.stepSizeStart)!=null?d:t.stepSizeStart}update(e){if(e.layouts.length===0||e.metrics.innerBounds.isEmpty())return e.activeLayout=null,!1;const t=this._prevOrientation.copy(e.orientation.target),s=this._prevBounds.copy(e.bounds.target);for(const o of e.layouts)this._setConfig(o),this._updateLayout(e,o);let i,n;for(const o of e.layouts){const l=o.solutions[0];if((!n||!n.isFeasible&&l.isFeasible)&&(n=l,i=o,n.isFeasible))break}return e.layoutFeasibleTime+=e.system.deltaTime,e.layoutInfeasibleTime+=e.system.deltaTime,(n==null?void 0:n.isFeasible)||(e.layoutFeasibleTime=0),n&&n.isFeasible&&e.layoutFeasibleTime>=this._config.minFeasibleTime||e.layoutInfeasibleTime>=this._config.maxInfeasibleTime?(e.layoutInfeasibleTime=0,n.apply(!1)):(e.orientation.target=t,e.bounds.target=s,e.metrics.invalidateStates()),e.activeLayout=i,!0}_updateLayout(e,t){var h;e.measureBoundsCache.clear(),t.processObjectives();const s=t.solutions,i=this._config,n=this._scratchSolution,o=this._scratchBestSolution,l=1.5,c=1.5**(-1/4);let u=i.maxIterationsPerFrame;((h=t.solutions[0])==null?void 0:h.isFeasible)&&(u=1),this._manageSolutionPopulation(e,t,i.swarmSize,i.stepSizeStart),s[0].apply();for(let p=0;p<u;p++){t.iteration++,o.copy(s[0]);let d=!1;for(let m=0;m<s.length;m++){const f=s[m];n.copy(f),n.mutationStrategies=f.mutationStrategies;let y;if(Math.random()<i.pulseRate){const S=o!==f?o:s[1];let T;if(s.length>2)do T=s[Math.floor(Math.random()*s.length)];while(T===f);n.moveTowards(S,i.pulseFrequencyMin,i.pulseFrequencyMax),T&&t.compareSolutions(T,f)<=0&&n.moveTowards(T,i.pulseFrequencyMin,i.pulseFrequencyMax)}else y=n.perturb();n.apply();const v=t.compareSolutions(n,f)<0;if(v&&(f.copy(n),f!==s[0]&&t.compareSolutions(f,s[0])<0&&s[0].copy(f),d=!0),y)if(y.stepSize*=v?l:c,!v&&y.stepSize<i.stepSizeMin||y.stepSize>i.stepSizeMax){for(const S of f.mutationStrategies)S.stepSize=i.stepSizeStart;f!==s[0]&&(t.restartRate=.001+(1-.001)*t.restartRate,f.randomize(1),f.apply(),d=!0)}else f!==s[0]&&(t.restartRate=(1-.001)*t.restartRate)}d&&t.sortSolutions(),t.compareSolutions(o,s[0])<=0?t.successRate=(1-.005)*t.successRate:t.successRate=.005+(1-.005)*t.successRate}}_manageSolutionPopulation(e,t,s,i){if(s<=1)throw new Error("Swarm size must be larger than 1");if(t.solutions.length<s)for(;t.solutions.length<s;){const n=new D(t);for(const o of n.mutationStrategies)o.stepSize=i;n.randomize(1),t.solutions.push(n)}else if(t.solutions.length>s)for(;t.solutions.length>s;)t.solutions.pop()}}class P{constructor(e){r(this,"type","ratio");r(this,"sortBlame",0);r(this,"relativeTolerance");r(this,"absoluteTolerance");r(this,"computedAbsoluteTolerance",-1/0);r(this,"computedRelativeTolerance",-1/0);r(this,"priority",0);r(this,"index",-1);r(this,"layout");r(this,"reduceFromOneOrManySpec",(e,t,s)=>{if(t===void 0)return 0;if(t instanceof Array){let i=-1/0;for(const n of t)i=Math.max(s(e,n),i);return i}return s(e,t)});r(this,"_getNumberScoreSingle",(e,t)=>{let s=0;if(typeof t!="object"){const i=this.layout.adapter.system.measureNumber(t);s=-Math.abs(e-i)}else{const i="gt"in t?this.layout.adapter.system.measureNumber(t.gt):void 0,n="lt"in t?this.layout.adapter.system.measureNumber(t.lt):void 0;i!==void 0&&e<i?s=e-i:n!==void 0&&e>n&&(s=n-e)}return s});r(this,"_getVector3ScoreSingle",(e,t)=>{const s="x"in t&&typeof t.x!="undefined"?this.getNumberScore(e.x,t.x):0,i="y"in t&&typeof t.y!="undefined"?this.getNumberScore(e.y,t.y):0,n="z"in t&&typeof t.z!="undefined"?this.getNumberScore(e.z,t.z):0,o="magnitude"in t&&typeof t.magnitude!="undefined"?this.getNumberScore(e.length(),t.magnitude):0;return s+i+n+o});r(this,"_quat",new z);r(this,"_euler",new we);r(this,"_getQuaternionScoreSingle",(e,t)=>{var s,i;if(t===void 0)return 0;if("x"in t)return-this._quat.copy(t).angleTo(e)*B;if("swingRange"in t){const n=this._euler.setFromQuaternion(e),o=n.x*B,l=n.y*B,c=n.z*B,u=this.layout.adapter.system,h=u.mathScope.degree;let p=((s=t.swingRange)==null?void 0:s.x)?u.measureNumber(t.swingRange.x,h):0,d=((i=t.swingRange)==null?void 0:i.y)?u.measureNumber(t.swingRange.y,h):0;p=Math.max(p,.01),d=Math.max(d,.01);const m=t.twistRange?u.measureNumber(t.twistRange,h):0,f=1-(o/p)**2-(l/d)**2,y=m-Math.abs(c);return(f>0?0:f)+(y>0?0:y)}return 0});r(this,"_getBoundsMeasureScoreSingle",(e,t,s,i)=>{if(t===void 0)return 0;if(typeof t=="object"){if("gt"in t){const n=this.layout.adapter.measureBounds(t.gt,s,i);if(e<n)return e-n}if("lt"in t){const n=this.layout.adapter.measureBounds(t.lt,s,i);if(e>n)return n-e}return 0}return-Math.abs(e-this.layout.adapter.measureBounds(t,s,i))});this.layout=e}static isDiscreteSpec(e){const t=typeof e;return t==="string"||t==="number"}static isContinuousSpec(e){return e!==void 0&&!(e instanceof Array)&&typeof e=="object"&&("gt"in e||"lt"in e)}get bestScore(){return this.layout.solutions[0].scores[this.index]}getNumberScore(e,t){return this.reduceFromOneOrManySpec(e,t,this._getNumberScoreSingle)}getVector3Score(e,t){return this.reduceFromOneOrManySpec(e,t,this._getVector3ScoreSingle)}getQuaternionScore(e,t){return this.reduceFromOneOrManySpec(e,t,this._getQuaternionScoreSingle)}getBoundsScore(e,t){if(e===void 0)return 0;let s=0;for(const i in e){if(i==="absolute")continue;let n=i;if(n==="size"||n==="center"){const o=e[n];for(const l of Kt){let c=l;t!=="spatial"&&(this.type==="meter"&&c!=="z"||this.type==="pixel"&&c==="z")||(s+=this.getBoundsMeasureScore(o==null?void 0:o[c],t,n+c))}}else{if(t!=="spatial"&&(this.type==="meter"&&n!=="back"&&n!=="front"||this.type==="pixel"&&(n==="back"||n==="front")))continue;s+=this.getBoundsMeasureScore(e[n],t,n)}}return s}getBoundsMeasureScore(e,t,s){if(e===void 0)return 0;const i=this.layout.adapter.metrics.target;let n,o,l;switch(t){case"spatial":n=i.spatialBounds,o=i.spatialCenter,l=i.spatialSize;break;case"visual":case"view":n=i.visualBounds,o=i.visualCenter,l=i.visualSize;break;default:throw new Error(`Unknown measure type "${t}.${s}" in spec:
 "${e}"`)}let c=0;switch(s){case"left":c=n.min.x;break;case"right":c=n.max.x;break;case"bottom":c=n.min.y;break;case"top":c=n.max.y;break;case"back":c=n.min.z;break;case"front":c=n.max.z;break;case"centerx":c=o.x;break;case"centery":c=o.y;break;case"centerz":c=o.z;break;case"centerdistance":c=t==="spatial"?o.length():Math.sqrt(o.x**2+l.y**2);break;case"sizex":c=l.x;break;case"sizey":c=l.y;break;case"sizez":c=l.z;break;case"sizediagonal":c=t==="spatial"?l.length():Math.sqrt(l.x**2+l.y**2);break;default:throw new Error(`Unknown measure subtype ${t}.${s} in spec "${e}"`)}if(e instanceof Array){let u=-1/0;for(const h of e)u=Math.max(this._getBoundsMeasureScoreSingle(c,h,t,s),u);return u}return this._getBoundsMeasureScoreSingle(c,e,t,s)}attenuateVisualScore(e){let t=0;const s=this.layout.getComputedAbsoluteTolerance("pixel"),i=this.layout.adapter,n=i.system.viewResolution,o=i.system.viewFrustum,l=n.x,c=n.y,u=n.length(),h=i.metrics.target.visualBounds,p=h.min.x- -l/2+s,d=h.max.x-l/2-s,m=h.min.y- -c/2+s,f=h.max.y-c/2-s,y=h.max.z+o.nearMeters;return p<0&&(t+=Math.abs(p/l)),d>0&&(t+=Math.abs(d/l)),m<0&&(t+=Math.abs(m/c)),f>0&&(t+=Math.abs(f/c)),y>0&&(t+=y*10),e-Math.abs(u)*t}}class Oe extends P{constructor(e){super(e);r(this,"spec");this.type="degree"}evaluate(){const e=this.layout.adapter.metrics.target;return this.getQuaternionScore(e.relativeOrientation,this.spec)}}class Qt extends P{constructor(e){super(e);r(this,"spec");this.type="ratio"}evaluate(){const e=this.layout.adapter.metrics.target;return this.getVector3Score(e.worldScale,this.spec)}}class Xt extends P{constructor(e){super(e);r(this,"mode","xyz");r(this,"_scale",new g);this.type="ratio"}evaluate(){const e=this.layout.adapter.metrics.target,t=this.mode;if(!t)return 0;const s=this._scale.copy(e.worldScale),i=t==="xyz"?Math.max(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z)):Math.max(Math.abs(s.x),Math.abs(s.y)),n=s.divideScalar(i);return-(1/n.x)+1+-(1/n.y)+1+(t==="xyz"?-(1/n.z)+1:n.z>1?1-n.z:0)}}const Kt=["x","y","z","diagonal","distance"];class Yt extends P{constructor(e){super(e);r(this,"spec");this.type="meter"}evaluate(){return this.getBoundsScore(this.spec,"spatial")}}class Le extends P{constructor(e){super(e);r(this,"spec");r(this,"pixelTolerance");r(this,"meterTolerance");this.type="pixel"}evaluate(){var e;return this.type==="meter"&&(this.absoluteTolerance=this.meterTolerance),this.type==="pixel"&&(this.absoluteTolerance=this.pixelTolerance),this.getBoundsScore(this.spec,"visual")+this.getBoundsScore((e=this.spec)==null?void 0:e.absolute,"view")}}class Zt extends P{constructor(e){super(e);r(this,"minAreaPercent",0);this.type="pixel"}evaluate(){var c;const e=this.layout.adapter.metrics.target,t=e.visualSize,s=this.layout.adapter.system.viewResolution,i=Math.min(t.x*t.y,s.x*s.y),n=((c=e.referenceState)==null?void 0:c.visualSize)||s,o=n.x*n.y;return this.attenuateVisualScore(i)-o*this.minAreaPercent}}class Ae extends P{constructor(e){super(e);this.type="meter",this.absoluteTolerance=1e10}evaluate(){return-this.layout.adapter.metrics.target.visualCenter.length()}}const De=new g;class Ne extends ie{constructor(e){super();r(this,"absoluteTolerance",{meter:"10mm",pixel:"4px",degree:"0.002deg",ratio:.002});r(this,"successRate",0);r(this,"restartRate",0);r(this,"objectives",new Array);r(this,"referenceNode",null);r(this,"maximizeObjective");r(this,"orientationConstraint");r(this,"keepAspectConstraint");r(this,"scaleConstraint");r(this,"boundsConstraint");r(this,"visualBoundsMeterConstraint");r(this,"visualBoundsPixelConstraint");r(this,"magnetizeObjective");r(this,"minimizeOcclusionObjective");r(this,"solutions",new Array);r(this,"iteration",0);r(this,"bestSolution");r(this,"compareSolutions",(e,t)=>{const s=this.objectives;if(e.scores.length<s.length)return 1;if(t.scores.length<s.length)return-1;if(e.boundsCenterDistance>1e20)return 1;if(t.boundsCenterDistance>1e10)return-1;if(e.boundsManhattanLength>1e20)return 1;if(t.boundsManhattanLength>1e10)return-1;const i=e.isFeasible,n=t.isFeasible;if(i&&!n)return-1;if(n&&!i)return 1;let o=0;const l=this.solutions[0].scores;for(let c=0;c<s.length;c++){const u=e.scores[c],h=t.scores[c];if(isNaN(u))return 1;if(isNaN(h))return-1;const p=s[c],d=p.computedRelativeTolerance,m=p.computedAbsoluteTolerance,f=Math.max(l[c],u,h),y=Math.min(f-Math.abs(f)*d,-m);if(u<y||h<y)return p.sortBlame++,h-u;h-u!=0&&(o=h-u)}return o});this.adapter=e}getComputedAbsoluteTolerance(e){return this.adapter.system.measureNumber(this.absoluteTolerance[e],e)}poseRelativeTo(e){return this.referenceNode=e,this}maximize(e){var s;const t=this.maximizeObjective=(s=this.maximizeObjective)!=null?s:new Zt(this);return t.priority=-1e3,t.relativeTolerance=.1,this.addObjective(t,e)}orientation(e,t){var i;const s=this.orientationConstraint=(i=this.orientationConstraint)!=null?i:new Oe(this);return s.spec=e,s.priority=-999,this.addObjective(s,t)}keepAspect(e="xyz",t){var i;const s=this.keepAspectConstraint=(i=this.keepAspectConstraint)!=null?i:new Xt(this);return s.mode=e,s.priority=-998,this.addObjective(s,t)}scale(e,t){var i;const s=this.scaleConstraint=(i=this.scaleConstraint)!=null?i:new Qt(this);return s.spec=e,s.priority=-2,this.addObjective(s,t)}bounds(e,t){var i;const s=this.boundsConstraint=(i=this.boundsConstraint)!=null?i:new Yt(this);return s.spec=e,this.addObjective(s,t)}visualOrientation(e,t){var i;const s=this.orientationConstraint=(i=this.orientationConstraint)!=null?i:new Oe(this);return s.spec=e,s.priority=-999,this.addObjective(s,t)}visualBounds(e,t){var n,o;const s=this.visualBoundsMeterConstraint=(n=this.visualBoundsMeterConstraint)!=null?n:new Le(this),i=this.visualBoundsPixelConstraint=(o=this.visualBoundsPixelConstraint)!=null?o:new Le(this);return s.spec=e,s.type="meter",i.spec=e,i.type="pixel",this.addObjective(s,t).addObjective(i,t)}magnetize(e){var s;const t=this.magnetizeObjective=(s=this.magnetizeObjective)!=null?s:new Ae(this);return t.priority=-900,t.relativeTolerance=.95,this.addObjective(t,e)}avoidOcclusion(e){var s;const t=this.minimizeOcclusionObjective=(s=this.minimizeOcclusionObjective)!=null?s:new Ae(this);return t.priority=11,this.addObjective(t,e)}addObjective(e,t){return Object.assign(e,t),this.objectives.indexOf(e)===-1&&this.objectives.push(e),this.processObjectives(),this}get hasValidSolution(){var e;return((e=this.solutions[0])==null?void 0:e.isFeasible)===!0}processObjectives(){var i,n;const e=this.adapter.system,t=this.objectives;let s=0;for(const o of t)o.index=s++,o.computedAbsoluteTolerance=o.absoluteTolerance!==void 0?e.measureNumber(o.absoluteTolerance,e.mathScope[o.type]):this.getComputedAbsoluteTolerance(o.type),o.computedRelativeTolerance=(n=(i=o.relativeTolerance)!=null?i:this.relativeTolerance)!=null?n:this.adapter.system.optimize.relativeTolerance}sortSolutions(){this.solutions.sort(this.compareSolutions),this.bestSolution=this.solutions[0]}}const C=class{constructor(e){r(this,"layout");r(this,"orientation",new z);r(this,"bounds",new O);r(this,"scores",[]);r(this,"isFeasible",!1);r(this,"mutationStrategies",[{type:"rotate",stepSize:.1},{type:"center",stepSize:.1},{type:"size",stepSize:.1},{type:"minmax",stepSize:.1}]);r(this,"_mutationWeights",[]);r(this,"boundsManhattanLength");r(this,"boundsCenterDistance");e&&(this.layout=e)}get aspectPenalty(){return this.scores[this.layout.objectives.indexOf(this.layout.keepAspectConstraint)]||0}get orientationPenalty(){return this.scores[this.layout.objectives.indexOf(this.layout.orientationConstraint)]||0}get spatialBoundsPenalty(){return this.scores[this.layout.objectives.indexOf(this.layout.boundsConstraint)]||0}_selectStrategy(){const e=this.mutationStrategies,t=this._mutationWeights,s=this.layout.orientationConstraint,i=this.layout.keepAspectConstraint;for(let n=0;n<e.length;n++)t[n]=e[n].stepSize,s&&e[n].type=="rotate"&&this.orientationPenalty>-s.computedAbsoluteTolerance&&(t[n]*=.01),i&&e[n].type=="size"&&this.aspectPenalty<-i.computedAbsoluteTolerance&&(t[n]*=100);return Te(e,t)}copy(e){this.layout=e.layout,this.orientation.copy(e.orientation),this.bounds.copy(e.bounds),this.scores.length=0;for(let t=0;t<e.scores.length;t++)this.scores[t]=e.scores[t];return this.isFeasible=e.isFeasible,this}randomize(e){const t=pe(e),s=C._scratchV1.set(0,0,-t),i=this.layout.adapter.system.viewMetrics.target;s.applyMatrix4(i.worldMatrix);const n=this.layout.adapter.metrics.target.parentState;n&&s.applyMatrix4(n.worldMatrixInverse),this.orientation.copy(i.worldOrientation),n&&this.orientation.multiply(n.worldOrientationInverse);const o=this.layout.adapter.metrics.innerBounds,l=o.isEmpty()?C._scratchV2.set(1,1,1):o.getSize(C._scratchV2);return l.normalize(),l.multiplyScalar(t*2*Math.tan(5*M)),this.bounds.setFromCenterAndSize(s,l),this}moveTowards(e,t,s){const i=this.bounds.getCenter(C._center),n=this.bounds.getSize(C._size),o=e.bounds,l=o.getCenter(C._otherCenter),c=o.getSize(C._otherSize);this.orientation.slerp(e.orientation,C.generatePulseFrequency(t,s)).normalize(),Math.random()<.5?(i.lerp(l,C.generatePulseFrequency(t,s)),n.lerp(c,C.generatePulseFrequency(t,s)),this.bounds.setFromCenterAndSize(i,n)):(this.bounds.min.lerp(o.min,C.generatePulseFrequency(t,s)),this.bounds.max.lerp(o.max,C.generatePulseFrequency(t,s)))}perturb(){var u;const e=this._selectStrategy(),t=e.type;let s=e.stepSize;if(t==="rotate"||Math.random()<.001){const h=(u=this.layout.orientationConstraint)==null?void 0:u.spec;if((h==null?void 0:h.isQuaternion)&&this.orientationPenalty<h.computedAbsoluteTolerance&&Math.random()<.01)this.orientation.copy(h);else{const p=Math.min(pe(Math.min(s,1)*1e-4),1);this.orientation.multiply(J(p,p)).normalize()}}const i=this.bounds,n=i.getCenter(C._center),o=i.getSize(C._size);if(t==="center"){const h=C._direction.set(0,0,1).applyQuaternion(J(1,1));h.setLength($(s)).multiplyScalar(o.length()),n.add(h)}if(t==="size"){const h=2**$(s);o.multiplyScalar(h)}if(o.clampScalar(this.layout.adapter.system.epsillonMeters/10,1e20),i.setFromCenterAndSize(n,o),t==="minmax"){const h=C._direction.set(0,0,1).applyQuaternion(J(1,1));h.setLength($(s)).multiply(o),Math.random()<.5,i.min.add(h)}const l=i.min,c=i.max;return l.x>c.x&&this._swap(l,c,"x"),l.y>c.y&&this._swap(l,c,"y"),l.z>c.z&&this._swap(l,c,"z"),e}_swap(e,t,s){const i=e[s],n=t[s];e[s]=n,t[s]=i}static generatePulseFrequency(e,t){return e+Math.random()*(t-e)}apply(e=!0){const t=this.layout,s=t.adapter;if(s.orientation.target=this.orientation,s.bounds.target=this.bounds,s.metrics.invalidateStates(),e){this.isFeasible=!0;for(let i=0;i<t.objectives.length;i++){const n=t.objectives[i],o=this.scores[i]=n.evaluate();(o<-n.computedAbsoluteTolerance||!isFinite(o))&&(this.isFeasible=!1)}}this.boundsManhattanLength=this.bounds.getSize(De).manhattanLength(),this.boundsCenterDistance=this.bounds.getCenter(De).length()}};let D=C;r(D,"_scratchV1",new g),r(D,"_scratchV2",new g),r(D,"_direction",new g),r(D,"_center",new g),r(D,"_size",new g),r(D,"_otherCenter",new g),r(D,"_otherSize",new g);const Ie=rt;class Pe{constructor(e){r(this,"target");r(this,"duration");r(this,"easing");r(this,"blend");r(this,"elapsed");e&&Object.assign(this,e)}}class G{constructor(e){r(this,"multiplier");r(this,"duration");r(this,"easing");r(this,"threshold");r(this,"delay");r(this,"debounce");r(this,"maxWait");r(this,"blend");e&&Object.assign(this,e)}}const Jt=new L,es=new g,ts=new z,Ue=new O,ss=new ce,is=new ce(0,0,0);class I extends G{constructor(e,t,s,i=e.transition){super(s);r(this,"needsUpdate",!1);r(this,"_size",new g);r(this,"_start");r(this,"_current");r(this,"_reference");r(this,"_target");r(this,"queue",[]);r(this,"enabled",!1);r(this,"forceWait",!1);r(this,"_forceCommit",!1);r(this,"_resolvedConfig",new G);r(this,"delayTime",0);r(this,"debounceTime",0);r(this,"_previousStatus","unchanged");r(this,"_status","unchanged");r(this,"_previousTarget");r(this,"_syncGroup");this.system=e,this.parentConfig=i,this.reset(t),this._previousTarget=this._copy(this._previousTarget,this.target)}_copy(e,t){if(typeof t=="undefined")return;if(typeof t=="number")return t;const s=e?e.copy(t):t.clone();if(s&&"isBox3"in s){const i=s,n=i.getSize(this._size);(i.isEmpty()||!isFinite(n.x)||!isFinite(n.y)||!isFinite(n.z))&&i.setFromCenterAndSize(A,A)}return s}_isEqual(e,t){return e===void 0||t===void 0?!1:e===t?!0:typeof e=="number"?e===t:(e==null?void 0:e.equals(t))||!1}reset(e){this._start=this._copy(this._start,e),this._current=this._copy(this._current,e),this._target=this._copy(this._target,e),this.queue.length=0}set start(e){this._start=this._copy(this._start,e)}get start(){return this._start}set current(e){this._current=this._copy(this._current,e)}get current(){return this._current}set reference(e){this._reference=this._copy(this._reference,e)}get reference(){return this._reference}set target(e){this.enabled=!0,this._target=this._copy(this._target,e)}get target(){return this._target}get progress(){if(!this.enabled)return 1;if(this.queue.length>0){const e=this.queue[this.queue.length-1];return e.duration===0?0:e.elapsed/e.duration}return 1}get forceCommit(){return this._forceCommit}set forceCommit(e){this._forceCommit!==e&&(this._forceCommit=e)}get relativeDifference(){var t,s;const e=(s=(t=this.queue[this.queue.length-1])==null?void 0:t.target)!=null?s:this.start;return typeof this.target!="undefined"?de(e,this.target):0}get referenceRelativeDifference(){return typeof this.reference!="undefined"&&typeof this.target!="undefined"?de(this.reference,this.target):1/0}get resolvedConfig(){var i,n,o,l,c,u,h,p,d,m,f,y,v,S,T,E;const e=this._resolvedConfig,t=this.parentConfig,s=this.system.transition;return e.multiplier=(n=(i=this.multiplier)!=null?i:t==null?void 0:t.multiplier)!=null?n:s.multiplier,e.duration=(l=(o=this.duration)!=null?o:t==null?void 0:t.duration)!=null?l:s.duration,e.easing=(u=(c=this.easing)!=null?c:t==null?void 0:t.easing)!=null?u:s.easing,e.threshold=(p=(h=this.threshold)!=null?h:t==null?void 0:t.threshold)!=null?p:s.threshold,e.delay=(m=(d=this.delay)!=null?d:t==null?void 0:t.delay)!=null?m:s.delay,e.debounce=(y=(f=this.debounce)!=null?f:t==null?void 0:t.debounce)!=null?y:s.debounce,e.maxWait=(S=(v=this.maxWait)!=null?v:t==null?void 0:t.maxWait)!=null?S:s.maxWait,e.blend=(E=(T=this.blend)!=null?T:t==null?void 0:t.blend)!=null?E:s.blend,e}get previousStatus(){return this._previousStatus}get status(){return this.needsUpdate&&(this._previousStatus=this._status,this._status=this._computeStatus()),this._status}_computeStatus(){if(this.forceCommit)return"committing";const e=this.resolvedConfig,t=e.threshold,s=this.system.deltaTime*e.multiplier,i=this.delayTime+s,n=this.debounceTime+s;return this.relativeDifference>t?!this.forceWait&&(i>=e.delay&&n>=e.debounce||i>=e.maxWait)?"committing":this.referenceRelativeDifference<t?"settling":"changed":"unchanged"}_updateTransitionable(){var l,c,u,h,p;const e=this.system.deltaTime,t=this.resolvedConfig,s=this.queue,i=this.status,n=e*t.multiplier;for(;s.length&&s[0].elapsed>=s[0].duration;)this.start=s.shift().target;this.current=this.start;let o=this.start;for(let d=0;d<s.length;d++){const m=s[d];if(this._addTransitionToCurrent(o,m,n),o=m.target,!m.blend)break}switch(this.debounceTime+=n,i){case"settling":break;case"changed":this.delayTime+=n,this.reference=this.target;break;case"unchanged":this.reference=void 0,this.delayTime=0;break;case"committing":this.delayTime=0,this.debounceTime=0;const d=typeof this.forceCommit=="object"?this.forceCommit:new Pe;d.target=(l=d.target)!=null?l:this._copy(void 0,this.target),d.duration=(c=d.duration)!=null?c:t.duration,d.easing=(u=d.easing)!=null?u:t.easing,d.blend=(h=d.blend)!=null?h:t.blend,d.elapsed=(p=d.elapsed)!=null?p:0,s.push(d),this.forceCommit=!1;break}this.forceWait=!1}_addTransitionToCurrent(e,t,s){const i=this._current,n=t.duration>0?t.easing(Math.min(t.elapsed/t.duration,1)):1,o=t.target;if(t.elapsed+=s,typeof o=="number"){this._current=i+nt(o-e,0,1-n);return}if("isVector3"in o){const l=i,c=e,u=o,h=es.copy(u).sub(c).lerp(A,1-n);this._current=l.add(h);return}if("isVector2"in o){const l=i,c=e,u=o,h=Jt.copy(u).sub(c).lerp(Se,1-n);this._current=l.add(h);return}if("isQuaternion"in o){const l=i,c=e,u=o,h=ts.copy(c).invert().multiply(u).slerp(he,1-n);this._current=l.multiply(h).normalize();return}if("isColor"in o){const l=i,c=e,u=o,h=ss.copy(u).sub(c).lerp(is,1-n);this._current=l.add(h);return}if("isBox3"in o){const l=i,c=e,u=o,h=Ue.min.copy(u.min).sub(c.min).lerp(A,1-n),p=Ue.max.copy(u.max).sub(c.max).lerp(A,1-n);l.min.add(h),l.max.add(p),this._current=l;return}}_swap(e,t,s){const i=e[s],n=t[s];e[s]=n,t[s]=i}update(e=!1){if(!this.needsUpdate&&!e||(this._isEqual(this._previousTarget,this.target)||(this._target=this._target,this.enabled=!0),this._previousTarget=this._copy(this._previousTarget,this.target),!this.enabled))return;const t=this.syncGroup;if(!this.forceCommit&&t){for(const s of t)if(s.enabled&&s.status==="committing"){for(const i of t)i.needsUpdate&&i.forceCommit===!1&&i.relativeDifference>i.resolvedConfig.threshold&&(i.forceCommit=!0);break}}this._updateTransitionable(),this.needsUpdate=!1}set syncGroup(e){this._syncGroup&&this._syncGroup.delete(this),this._syncGroup=e,e==null||e.add(this)}get syncGroup(){return this._syncGroup}}class Fe{constructor(e,t){r(this,"measureBoundsCache",new Map);r(this,"metrics");r(this,"transition",new G);r(this,"referenceNode");r(this,"_outerOrigin");r(this,"_outerOrientation");r(this,"_outerBounds");r(this,"_outerVisualBounds");r(this,"_parentAdapter",null);r(this,"_orientation");r(this,"_bounds");r(this,"_opacity");r(this,"layouts",new Array);r(this,"layoutFeasibleTime",0);r(this,"layoutInfeasibleTime",0);r(this,"_prevLayout",null);r(this,"_activeLayout",null);r(this,"_progress",1);r(this,"_hasValidContext",!1);r(this,"onUpdate");r(this,"onPostUpdate");r(this,"_prevNodeOrientation",new z);r(this,"_prevNodeBounds",new O);this.system=e,this.node=t,this.metrics=this.system.getMetrics(this.node);const s=this.metrics.target;this._orientation=new I(this.system,s.relativeOrientation,void 0,this.transition),this._bounds=new I(this.system,s.spatialBounds,void 0,this.transition),this._opacity=new I(this.system,s.opacity,void 0,this.transition),this._outerOrigin=new I(this.system,s.outerCenter,void 0,this.transition),this._outerOrientation=new I(this.system,s.outerOrientation,void 0,this.transition),this._outerBounds=new I(this.system,s.outerBounds,void 0,this.transition),this._outerVisualBounds=new I(this.system,s.outerVisualBounds,void 0,this.transition),this._outerOrigin.debounce=0,this._outerOrigin.delay=0,this._outerOrientation.debounce=0,this._outerOrientation.delay=0,this._outerBounds.debounce=0,this._outerBounds.delay=0,this._outerVisualBounds.debounce=0,this._outerVisualBounds.delay=0,this._orientation.syncGroup=this._bounds.syncGroup=this._opacity.syncGroup=new Set}measureBounds(e,t,s){var S,T,E;const i=this.system,n=i.mathScope,o=i.math,l=t==="spatial"||s==="front"||s==="back"||s==="centerz"||s==="sizez"?n.meter:n.pixel,c=l===n.meter?"m":"px";typeof e=="number"&&(e=""+e+c);const u=t+"-"+s+" = "+e;if((S=this.measureBoundsCache)==null?void 0:S.has(u))return this.measureBoundsCache.get(u);if(!i.mathCompiledExpressions.has(e)){const R=o.parse(e.replace("%","percent")).compile();i.mathCompiledExpressions.set(e,R)}const h=i.mathCompiledExpressions.get(e),p=i.viewMetrics.target,d=this.metrics.target;let m,f;switch(t){case"spatial":m=d.outerBounds,f=d.outerCenter;break;case"visual":m=d.outerVisualBounds,f=d.outerVisualCenter;break;case"view":m=p.visualBounds,f=p.visualCenter;break;default:throw new Error(`Unknown measure type "${t}.${s}"`)}if(e.includes("%")){const x=t==="spatial"?d.outerSize:(T=d.outerVisualSize)!=null?T:p.visualSize;let R=0;switch(s){case"left":case"centerx":case"right":case"sizex":R=o.unit(x.x/100,c);break;case"bottom":case"centery":case"top":case"sizey":R=o.unit(x.y/100,c);break;case"back":case"centerz":case"front":case"sizez":R=o.unit(x.z/100,"m");break;case"sizediagonal":R=t==="spatial"?o.unit(x.length()/100,"m"):o.unit(Math.sqrt(x.x**2+x.y**2)/100,"px");break;default:throw new Error(`Invalid measure subtype "${t}.${s}" for percentage units`)}n.percent=R}let y;switch(s){case"left":y=m.min.x;break;case"centerx":y=f.x;break;case"right":y=m.max.x;break;case"bottom":y=m.min.y;break;case"centery":y=f.y;break;case"top":y=m.max.y;break;case"front":y=m.max.z;break;case"centerz":y=f.z;break;case"back":y=m.min.z;break;case"centerdistance":default:y=0}let v=h.evaluate(n);return typeof v=="object"&&(v=o.number(v,l)),y+=v,n.percent=void 0,(E=this.measureBoundsCache)==null||E.set(u,y),y}get outerOrigin(){return this._outerOrigin}get outerOrientation(){return this._outerOrientation}get outerBounds(){return this._outerBounds}get outerVisualBounds(){return this._outerVisualBounds}get parentAdapter(){return this._parentAdapter}_computeParentAdapter(){let e=this.metrics;for(;e=e.parentMetrics;){const t=this.system.nodeAdapters.get(e.node);if(t)return t}return null}get orientation(){return this._orientation}get bounds(){return this._bounds}get opacity(){return this._opacity}get previousLayout(){return this._prevLayout}set activeLayout(e){this._prevLayout=this._activeLayout,this._activeLayout=e}get activeLayout(){return this._activeLayout}get progress(){return this._progress}_computeProgress(){return Math.min(this.orientation.progress,this.bounds.progress,this.opacity.progress)}createLayout(){const e=new Ne(this);return this.layouts.push(e),e}get hasValidContext(){return this._hasValidContext}_computeHasValidContext(){var t;const e=this.parentAdapter;return e?e.hasValidContext?!!(e.layouts.length===0||((t=e.activeLayout)==null?void 0:t.hasValidSolution)):!1:!0}_update(){var t;this._parentAdapter=this._computeParentAdapter(),this._hasValidContext=this._computeHasValidContext();const e=this.metrics;if(e.referenceMetrics&&(this.outerOrigin.target=e.referenceMetrics.target.worldCenter,this.outerOrientation.target=e.referenceMetrics.target.worldOrientation,this.outerBounds.target=e.referenceMetrics.innerBounds,this.outerBounds.target.applyMatrix4(e.target.spatialFromReference),this.outerVisualBounds.target=e.referenceMetrics.target.visualBounds),this.outerOrigin.update(),this.outerOrientation.update(),this.outerBounds.update(),this.outerVisualBounds.update(),this.onUpdate){this.onUpdate(),e.invalidateIntrinsicBounds(),e.invalidateInnerBounds(),e.invalidateStates(),e.updateRawState();const s=e.raw;if(!this.system.optimizer.update(this)){const i=this.orientation.current,n=this.orientation.target,o=s.relativeOrientation;n.angleTo(o)>this.system.epsillonRadians&&i.angleTo(o)>this.system.epsillonRadians&&(this.orientation.target=o);const l=this.bounds.current,c=this.bounds.target,u=s.spatialBounds;(c.min.distanceTo(u.min)>this.system.epsillonMeters||c.max.distanceTo(u.max)>this.system.epsillonMeters)&&(l.min.distanceTo(u.min)>this.system.epsillonMeters||l.max.distanceTo(u.max)>this.system.epsillonMeters)&&(this.bounds.target=u)}}else e.invalidateIntrinsicBounds(),e.invalidateInnerBounds(),e.invalidateStates(),this.system.optimizer.update(this);this.opacity.update(),this.orientation.update(),this.bounds.update(),this._progress=this._computeProgress(),e.invalidateStates(),this.system.bindings.apply(e,e.current),e.invalidateStates(),(t=this.onPostUpdate)==null||t.call(this)}}class ke{constructor(){r(this,"_cache",new ee);r(this,"isLayoutFrustum",!0);r(this,"_leftDegrees",-20);r(this,"_rightDegrees",20);r(this,"_bottomDegrees",-20);r(this,"_topDegrees",20);r(this,"_nearMeters",.5);r(this,"_farMeters",1e3);r(this,"_size",new L);r(this,"_center",new L);r(this,"_v1",new g);r(this,"_inverseProjection",new _);r(this,"_forwardDirection",new g(0,0,-1));r(this,"_fullNDC",new O(new g(-1,-1,-1),new g(1,1,1)));r(this,"_cachedPerspectiveProjectionMatrix",this._cache.memoize(()=>{const e=this.nearMeters,t=this.farMeters,s=e*Math.tan(this.leftDegrees*M),i=e*Math.tan(this.rightDegrees*M),n=e*Math.tan(this.topDegrees*M),o=e*Math.tan(this.bottomDegrees*M);return this._perspective.makePerspective(s,i,n,o,e,t)}));r(this,"_perspective",new _);r(this,"_boxA",new W);r(this,"_boxB",new W);r(this,"_overlapSize",new L)}get leftDegrees(){return this._leftDegrees}set leftDegrees(e){e!==this._leftDegrees&&(this._leftDegrees=e,this._cache.invalidateAll())}get rightDegrees(){return this._rightDegrees}set rightDegrees(e){e!==this._rightDegrees&&(this._rightDegrees=e,this._cache.invalidateAll())}get bottomDegrees(){return this._bottomDegrees}set bottomDegrees(e){e!==this._bottomDegrees&&(this._bottomDegrees=e,this._cache.invalidateAll())}get topDegrees(){return this._topDegrees}set topDegrees(e){e!==this._topDegrees&&(this._topDegrees=e,this._cache.invalidateAll())}get nearMeters(){return this._nearMeters}set nearMeters(e){e!==this._nearMeters&&(this._nearMeters=e,this._cache.invalidateAll())}get farMeters(){return this._farMeters}set farMeters(e){e!==this._farMeters&&(this._farMeters=e,this._cache.invalidateAll())}get sizeDegrees(){return this._size.set(this.rightDegrees-this.leftDegrees,this.topDegrees-this.bottomDegrees),this._size}get diagonalDegrees(){const e=this.sizeDegrees;return Math.acos(Math.cos(e.x*M)*Math.cos(e.y*M))*B}get centerDegrees(){const e=this.sizeDegrees;return this._center.set(this.leftDegrees+e.x/2,this.bottomDegrees+e.y/2)}get angleToCenter(){const e=this.centerDegrees;return Math.acos(Math.cos(e.x*M)*Math.cos(e.y*M))*B}get angleToTopLeft(){return Math.acos(Math.cos(this.leftDegrees*M)*Math.cos(this.topDegrees*M))*B}get angleToTopRight(){return Math.acos(Math.cos(this.rightDegrees*M)*Math.cos(this.topDegrees*M))*B}get angleToBottomLeft(){return Math.acos(Math.cos(this.leftDegrees*M)*Math.cos(this.bottomDegrees*M))*B}get angleToBottomRight(){return Math.acos(Math.cos(this.rightDegrees*M)*Math.cos(this.bottomDegrees*M))*B}get angleToClosestPoint(){const e=Math.min(Math.max(0,this.leftDegrees),this.rightDegrees),t=Math.min(Math.max(0,this.bottomDegrees),this.topDegrees);return Math.acos(Math.cos(e*M)*Math.cos(t*M))*B}get angleToFarthestPoint(){return Math.max(this.angleToTopLeft,this.angleToTopRight,this.angleToBottomLeft,this.angleToBottomRight)}get depth(){return this.farMeters-this.nearMeters}get distance(){return this.nearMeters+this.depth/2}get aspectRatio(){const e=this.nearMeters,t=e*Math.tan(this.leftDegrees*M),s=e*Math.tan(this.rightDegrees*M),i=e*Math.tan(this.topDegrees*M),n=e*Math.tan(this.bottomDegrees*M);return(i-n)/(s-t)}setFromPerspectiveProjectionMatrix(e,t=this._fullNDC){const s=this._inverseProjection.copy(e).invert(),i=this._v1,n=this._forwardDirection,o=Math.sign(t.min.x)*i.set(t.min.x,0,-1).applyMatrix4(s).angleTo(n)*B,l=Math.sign(t.max.x)*i.set(t.max.x,0,-1).applyMatrix4(s).angleTo(n)*B,c=Math.sign(t.max.y)*i.set(0,t.max.y,-1).applyMatrix4(s).angleTo(n)*B,u=Math.sign(t.min.y)*i.set(0,t.min.y,-1).applyMatrix4(s).angleTo(n)*B,h=-i.set(0,0,t.min.z).applyMatrix4(s).z,p=-i.set(0,0,t.max.z).applyMatrix4(s).z;return this.leftDegrees=o,this.rightDegrees=l,this.topDegrees=c,this.bottomDegrees=u,this.nearMeters=h,this.farMeters=p,this}get perspectiveProjectionMatrix(){return this._cachedPerspectiveProjectionMatrix()}overlapPercent(e){return this._boxA.min.x=this.leftDegrees,this._boxA.max.x=this.rightDegrees,this._boxA.min.y=this.bottomDegrees,this._boxA.max.y=this.topDegrees,this._boxB.min.x=e.leftDegrees,this._boxB.max.x=e.rightDegrees,this._boxB.min.y=e.bottomDegrees,this._boxB.max.y=e.topDegrees,this._boxA.intersect(this._boxB).getSize(this._overlapSize).length()/this.sizeDegrees.length()}}class Ve{constructor(e,t){r(this,"math",at({evaluateDependencies:ot,addDependencies:ct,subtractDependencies:lt,multiplyDependencies:ut,divideDependencies:ht,modDependencies:dt,numberDependencies:pt,createUnitDependencies:mt,unitDependencies:ft},{predictable:!0}));r(this,"mathCompiledExpressions",new Map);r(this,"mathScope",{ratio:void 0,degree:this.math.unit("degree"),meter:this.math.unit("meter"),pixel:this.math.createUnit("pixel",{aliases:["pixels","px"]}),percent:void 0,vdeg:void 0,vw:void 0,vh:void 0});r(this,"epsillonMeters",1e-10);r(this,"epsillonRadians",1e-10);r(this,"epsillonRatio",1e-10);r(this,"transition",new G({multiplier:1,duration:0,easing:Ie.easeInOut,threshold:0,delay:0,debounce:0,maxWait:10,blend:!0}));r(this,"optimize",new ie({minFeasibleTime:.02,maxInfeasibleTime:5,relativeTolerance:.001,maxIterationsPerFrame:10,swarmSize:10,pulseFrequencyMin:0,pulseFrequencyMax:1,pulseRate:.4,stepSizeMin:1e-4,stepSizeMax:4,stepSizeStart:1.5}));r(this,"optimizer",new Ce(this));r(this,"viewFrustum",new ke);r(this,"viewResolution",new L(1e3,1e3));r(this,"deltaTime",1/60);r(this,"time",0);r(this,"maxDeltaTime",1/60);r(this,"nodeMetrics",new Map);r(this,"nodeAdapters",new Map);r(this,"transitionables",[]);r(this,"getMetrics",e=>{if(!e)throw new Error("node must be defined");let t=this.nodeMetrics.get(e);return t||(t=new Be(this,e),this.nodeMetrics.set(e,t)),t});r(this,"getState",e=>{if(!e)throw new Error("node must be defined");return this.getMetrics(e).target});r(this,"getAdapter",e=>{let t=this.nodeAdapters.get(e);return t||(t=new Fe(this,e),this.nodeAdapters.set(e,t)),t});r(this,"createTransitionable",(e,t)=>{const s=new I(this,e,t,this.transition);return this.transitionables.push(s),s});r(this,"_prevResolution",new L);r(this,"_prevSize",new L);r(this,"measureNumberCache",{});this.viewNode=e,this.bindings=t}get viewMetrics(){if(!this.viewNode)throw new Error("EtherealSystem.viewNode must be defined");return this.getMetrics(this.viewNode)}update(e,t){this.deltaTime=Math.max(e,this.maxDeltaTime),this.time=t,(!this._prevResolution.equals(this.viewResolution)||!this._prevSize.equals(this.viewFrustum.sizeDegrees))&&(this.mathScope.vdeg=this.math.unit(this.viewResolution.y/this.viewFrustum.sizeDegrees.y,"px"),this.mathScope.vw=this.math.unit(this.viewResolution.x/100,"px"),this.mathScope.vh=this.math.unit(this.viewResolution.y/100,"px"),this.measureNumberCache={}),this._prevResolution.copy(this.viewResolution),this._prevSize.copy(this.viewFrustum.sizeDegrees);for(const s of this.nodeMetrics.values()){s.needsUpdate=!0;const i=this.nodeAdapters.get(s.node);i&&(i.opacity.needsUpdate=!0,i.orientation.needsUpdate=!0,i.bounds.needsUpdate=!0,i.outerOrigin.needsUpdate=!0,i.outerOrientation.needsUpdate=!0,i.outerBounds.needsUpdate=!0,i.outerVisualBounds.needsUpdate=!0)}for(const s of this.transitionables)s.needsUpdate=!0;for(const s of this.transitionables)s.update();this.viewMetrics.update();for(const s of this.nodeAdapters.values())s.metrics.update()}measureNumber(e,t){if(typeof e=="number")return e;if(e in this.measureNumberCache)return this.measureNumberCache[e];if(!this.mathCompiledExpressions.has(e)){const l=this.math.parse(e).compile();this.mathCompiledExpressions.set(e,l)}const s=this.mathCompiledExpressions.get(e),i=s.evaluate(this.mathScope),n=typeof i=="number"?i:this.math.number(s.evaluate(this.mathScope),t);return this.measureNumberCache[e]=n,n}}const rs=new g;class ns{constructor(e=0,t=0,s=0){this.horizontalRadians=e,this.verticalRadians=t,this.distance=s}get horizontalDegrees(){return this.horizontalRadians*B}set horizontalDegrees(e){this.horizontalRadians=e*M}get verticalDegrees(){return this.verticalRadians*B}set verticalDegrees(e){this.verticalRadians=e*M}setWithRadians(e,t,s){return this.horizontalRadians=e,this.verticalRadians=t,this.distance=s,this}setWithDegrees(e,t,s){return this.horizontalDegrees=e,this.verticalDegrees=t,this.distance=s,this}fromCartesianDirection(e){const t=rs.copy(e).normalize();return this.verticalRadians=Math.asin(t.y)*B,this.horizontalRadians=Math.atan2(t.x,-t.z)*B,this.distance=0,this}fromCartesianPosition(e){return this.fromCartesianDirection(e),this.distance=e.length(),this}toCartesianDirection(e){const t=this.verticalRadians,s=-Math.PI-this.horizontalRadians,i=Math.sin(t),n=Math.cos(t)*Math.sin(s),o=-Math.cos(t)*Math.cos(s);return e.set(n,i,o).normalize()}toCartesianPosition(e){return this.toCartesianDirection(e).multiplyScalar(this.distance)}}const as=new _,os=new _,H={getChildren(a,e){const t=a.node;if(!!t.isObject3D){e.length=0;for(let s=0;s<t.children.length;s++)e[s]=t.children[s]}},getState(a){var i;if(a.system.viewNode===a.node){const n=a.node;n.updateMatrixWorld(),a.system.viewFrustum.setFromPerspectiveProjectionMatrix(n.projectionMatrix)}const e=a.node;if(!e.isObject3D)return;let t,s;if(a.isAdaptive){const n=(i=a.referenceMetrics)==null?void 0:i.target.worldMatrix;s=as.compose(e.position,e.quaternion,e.scale),t=n?os.multiplyMatrices(n,s):s}else t=e.matrixWorld,s=e.matrix;a.raw.parent=e.parent,a.raw.worldMatrix.copy(t),a.raw.relativeMatrix.copy(s),a.raw.opacity=je(a)||1},getIntrinsicBounds(a,e){const t=a.node;if(!!t.isObject3D)return t.geometry?(t.geometry.boundingBox||t.geometry.computeBoundingBox(),e.copy(t.geometry.boundingBox)):e},apply(a,e){const t=a.node;if(!t.isObject3D)return;if(e.parent!==t.parent){const i=e.parent;i&&i.add(t)}let s=e.localMatrix;if(isNaN(s.elements[0])||isNaN(s.elements[13])||isNaN(s.elements[14])||isNaN(s.elements[15])||s.elements[0]===0)throw new Error;if(s=e.worldMatrix,isNaN(s.elements[0])||isNaN(s.elements[13])||isNaN(s.elements[14])||isNaN(s.elements[15])||s.elements[0]===0)throw new Error;t.matrixAutoUpdate=!1,t.matrix.copy(e.localMatrix),t.matrixWorld.copy(e.worldMatrix),We(a,e.opacity)}};function je(a){const e=a.node;if(e.material){const t=e.material;if(t.length){for(const s of t)if(s.opacity!==void 0)return s.opacity}else if("opacity"in e.material)return e.material.opacity}for(const t of a.boundingChildMetrics){const s=je(t);if(s!==void 0)return s}}function We(a,e){const t=a.node;if(t.material){const s=t.material;if(s.length)for(const i of s)"opacity"in i&&(i.opacity=e);else t.material.opacity=e}for(const s of a.boundingChildMetrics)We(s,e)}const qe={getChildren(a,e){a.node.isObject3D&&H.getChildren(a,e)},getState(a){a.node.isObject3D&&H.getState(a)},getIntrinsicBounds(a,e){return a.node.isObject3D&&H.getIntrinsicBounds(a,e),e},apply(a,e){a.node.isObject3D&&H.apply(a,e)}};function cs(a,e=qe){return new Ve(a,e)}var Ws=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",ThreeBindings:H,DefaultBindings:qe,createLayoutSystem:cs,EtherealLayoutSystem:Ve,MathUtils:gt,Matrix3:yt,Matrix4:_,V_00:Se,V_11:Dt,V_000:A,V_100:Nt,V_010:It,V_001:Pt,V_111:ue,Q_IDENTITY:he,DIRECTION:q,Vector2:L,Vector3:g,Vector4:wt,Quaternion:z,Euler:we,Color:ce,Box2:W,Box3:O,Ray:_t,Line3:bt,Plane:vt,computeRelativeDifference:de,gaussian:$,levy:pe,randomQuaternion:J,randomSelect:Te,extractRotationAboutAxis:$t,LayoutFrustum:ke,NodeStateBase:ze,NodeState:N,SpatialMetrics:Be,SpatialAdapter:Fe,SpatialLayout:Ne,LayoutSolution:D,OptimizerConfig:ie,SpatialOptimizer:Ce,easing:Ie,Transition:Pe,TransitionConfig:G,Transitionable:I,SphericalCoordinate:ns,MemoizationCache:ee});function re(a,e,t,s=0){var i;s++,a=a.shadowRoot||a;for(let n=a.firstElementChild;n;n=n.nextElementSibling){if(n.assignedSlot)continue;const o=(i=n.assignedElements)==null?void 0:i.call(n,{flatten:!0});if(o)for(const l of o)e.call(t,l,s)&&re(n,e,t,s);e.call(t,n,s)&&re(n,e,t,s)}}class F{constructor(){r(this,"left",0);r(this,"top",0);r(this,"width",0);r(this,"height",0)}copy(e){return this.top=e.top,this.left=e.left,this.width=e.width,this.height=e.height,this}}class Q{constructor(){r(this,"left",0);r(this,"top",0);r(this,"right",0);r(this,"bottom",0)}copy(e){return this.top=e.top,this.left=e.left,this.right=e.right,this.bottom=e.bottom,this}}function ne(a,e=new F,t){const s=a.ownerDocument,i=s.documentElement,n=s.body;if(a===i)return ds(s,e);if(t===a){e.left=0,e.top=0,e.width=a.offsetWidth,e.height=a.offsetHeight;return}const o=a.ownerDocument.defaultView;let l=a,c,u=l.offsetParent,h=o.getComputedStyle(l,null),p=l.offsetTop,d=l.offsetLeft;for(u&&t&&(u.contains(t)||u.contains(t.getRootNode().host))&&u!==t&&(ne(t,e,u),d-=e.left,p-=e.top);(l=l.parentElement)&&l!==n&&l!==i&&l!==t&&h.position!=="fixed";)c=o.getComputedStyle(l,null),p-=l.scrollTop,d-=l.scrollLeft,l===u&&(p+=l.offsetTop,d+=l.offsetLeft,p+=parseFloat(c.borderTopWidth)||0,d+=parseFloat(c.borderLeftWidth)||0,u=l.offsetParent),h=c;return h.position==="fixed"&&(p+=Math.max(i.scrollTop,n.scrollTop),d+=Math.max(i.scrollLeft,n.scrollLeft)),e.left=d,e.top=p,e.width=a.offsetWidth,e.height=a.offsetHeight,e}function ls(a,e){if(a.offsetParent===null){e.left=e.right=e.top=e.bottom=0;return}let t=getComputedStyle(a);e.left=parseFloat(t.marginLeft)||0,e.right=parseFloat(t.marginRight)||0,e.top=parseFloat(t.marginTop)||0,e.bottom=parseFloat(t.marginBottom)||0}function us(a,e){let t=getComputedStyle(a);e.left=parseFloat(t.borderLeftWidth)||0,e.right=parseFloat(t.borderRightWidth)||0,e.top=parseFloat(t.borderTopWidth)||0,e.bottom=parseFloat(t.borderBottomWidth)||0}function hs(a,e){let t=getComputedStyle(a);e.left=parseFloat(t.paddingLeft)||0,e.right=parseFloat(t.paddingRight)||0,e.top=parseFloat(t.paddingTop)||0,e.bottom=parseFloat(t.paddingBottom)||0}const k=document.createElement("div");k.id="VIEWPORT";k.style.position="fixed";k.style.width="100vw";k.style.height="100vh";k.style.visibility="hidden";k.style.pointerEvents="none";function ds(a,e){const t=a.documentElement,s=a.body,i=getComputedStyle(t),n=getComputedStyle(s);return e.top=s.offsetTop+parseFloat(i.marginTop)||0+parseFloat(n.marginTop)||0,e.left=s.offsetLeft+parseFloat(i.marginLeft)||0+parseFloat(n.marginLeft)||0,e.width=Math.max(Math.max(s.scrollWidth,t.scrollWidth),Math.max(s.offsetWidth,t.offsetWidth),Math.max(s.clientWidth,t.clientWidth)),e.height=Math.max(Math.max(s.scrollHeight,t.scrollHeight),Math.max(s.offsetHeight,t.offsetHeight),Math.max(s.clientHeight,t.clientHeight)),e}function ps(a){const e=document.createElement("div");e.innerHTML=a;const t=e.firstElementChild;return e.removeChild(t),t}(function(a){function e(){}function t(c,u){if(c=c===void 0?"utf-8":c,u=u===void 0?{fatal:!1}:u,o.indexOf(c.toLowerCase())===-1)throw new RangeError("Failed to construct 'TextDecoder': The encoding label provided ('"+c+"') is invalid.");if(u.fatal)throw Error("Failed to construct 'TextDecoder': the 'fatal' option is unsupported.")}function s(c){return Buffer.from(c.buffer,c.byteOffset,c.byteLength).toString("utf-8")}function i(c){var u=URL.createObjectURL(new Blob([c],{type:"text/plain;charset=UTF-8"}));try{var h=new XMLHttpRequest;return h.open("GET",u,!1),h.send(),h.responseText}catch{return n(c)}finally{URL.revokeObjectURL(u)}}function n(c){for(var u=0,h=Math.min(65536,c.length+1),p=new Uint16Array(h),d=[],m=0;;){var f=u<c.length;if(!f||m>=h-1){if(d.push(String.fromCharCode.apply(null,p.subarray(0,m))),!f)return d.join("");c=c.subarray(u),m=u=0}if(f=c[u++],(f&128)==0)p[m++]=f;else if((f&224)==192){var y=c[u++]&63;p[m++]=(f&31)<<6|y}else if((f&240)==224){y=c[u++]&63;var v=c[u++]&63;p[m++]=(f&31)<<12|y<<6|v}else if((f&248)==240){y=c[u++]&63,v=c[u++]&63;var S=c[u++]&63;f=(f&7)<<18|y<<12|v<<6|S,65535<f&&(f-=65536,p[m++]=f>>>10&1023|55296,f=56320|f&1023),p[m++]=f}}}if(a.TextEncoder&&a.TextDecoder)return!1;var o=["utf-8","utf8","unicode-1-1-utf-8"];Object.defineProperty(e.prototype,"encoding",{value:"utf-8"}),e.prototype.encode=function(c,u){if(u=u===void 0?{stream:!1}:u,u.stream)throw Error("Failed to encode: the 'stream' option is unsupported.");u=0;for(var h=c.length,p=0,d=Math.max(32,h+(h>>>1)+7),m=new Uint8Array(d>>>3<<3);u<h;){var f=c.charCodeAt(u++);if(55296<=f&&56319>=f){if(u<h){var y=c.charCodeAt(u);(y&64512)==56320&&(++u,f=((f&1023)<<10)+(y&1023)+65536)}if(55296<=f&&56319>=f)continue}if(p+4>m.length&&(d+=8,d*=1+u/c.length*2,d=d>>>3<<3,y=new Uint8Array(d),y.set(m),m=y),(f&4294967168)==0)m[p++]=f;else{if((f&4294965248)==0)m[p++]=f>>>6&31|192;else if((f&4294901760)==0)m[p++]=f>>>12&15|224,m[p++]=f>>>6&63|128;else if((f&4292870144)==0)m[p++]=f>>>18&7|240,m[p++]=f>>>12&63|128,m[p++]=f>>>6&63|128;else continue;m[p++]=f&63|128}}return m.slice?m.slice(0,p):m.subarray(0,p)},Object.defineProperty(t.prototype,"encoding",{value:"utf-8"}),Object.defineProperty(t.prototype,"fatal",{value:!1}),Object.defineProperty(t.prototype,"ignoreBOM",{value:!1});var l=n;typeof Buffer=="function"&&Buffer.from?l=s:typeof Blob=="function"&&typeof URL=="function"&&typeof URL.createObjectURL=="function"&&(l=i),t.prototype.decode=function(c,u){if(u=u===void 0?{stream:!1}:u,u.stream)throw Error("Failed to decode: the 'stream' option is unsupported.");return c=c instanceof Uint8Array?c:c.buffer instanceof ArrayBuffer?new Uint8Array(c.buffer):new Uint8Array(c),l(c)},a.TextEncoder=e,a.TextDecoder=t})(typeof window!="undefined"?window:typeof le!="undefined"?le:le);class me{constructor(e,t,s){r(this,"manager");r(this,"element");r(this,"eventCallback");r(this,"id");r(this,"desiredPseudoState",{hover:!1,active:!1,focus:!1,target:!1});r(this,"needsRefresh",!0);r(this,"needsRemoval",!1);r(this,"parentLayer");r(this,"childLayers",[]);r(this,"pixelRatio");r(this,"previousDOMStateHash");r(this,"currentDOMStateHash");r(this,"domMetrics",{bounds:new F,padding:new Q,margin:new Q,border:new Q});if(this.manager=e,this.element=t,this.eventCallback=s,!e)throw new Error("WebLayerManager must be initialized");w.layers.set(t,this),this.id=t.getAttribute(w.ELEMENT_UID_ATTRIBUTE)||w.generateElementUID(),t.setAttribute(w.ELEMENT_UID_ATTRIBUTE,this.id),t.setAttribute(w.LAYER_ATTRIBUTE,""),this.parentLayer=w.getClosestLayer(this.element,!1),this.eventCallback("layercreated",{target:t})}setNeedsRefresh(e=!1){if(this.needsRefresh=!0,e)for(const t of this.childLayers)t.setNeedsRefresh(e)}get previousDOMState(){return this.previousDOMStateHash?this.manager.getLayerState(this.previousDOMStateHash):void 0}get currentDOMState(){return this.currentDOMStateHash?this.manager.getLayerState(this.currentDOMStateHash):void 0}get depth(){let e=0,t=this;for(;t.parentLayer;)t=t.parentLayer,e++;return e}get rootLayer(){let e=this;for(;e.parentLayer;)e=e.parentLayer;return e}traverseParentLayers(e){const t=this.parentLayer;t&&(t.traverseParentLayers(e),e(t))}traverseLayers(e){e(this),this.traverseChildLayers(e)}traverseChildLayers(e){for(const t of this.childLayers)t.traverseLayers(e)}update(){const e=this.previousDOMState,t=this.currentDOMState;(e==null?void 0:e.texture.url)!==(t==null?void 0:t.texture.url)&&this.eventCallback("layerpainted",{target:this.element}),this.previousDOMStateHash=this.currentDOMStateHash}async refresh(){this.currentDOMStateHash=void 0,this.needsRefresh=!1,this._updateParentAndChildLayers();const e=await this.manager.addToSerializeQueue(this);e.needsRasterize&&await this.manager.addToRasterizeQueue(e.svgHash,e.svgUrl)}_updateParentAndChildLayers(){const e=this.element,t=this.childLayers,s=t.slice(),i=this.parentLayer;this.parentLayer=w.getClosestLayer(this.element,!1),i!==this.parentLayer&&(this.parentLayer&&this.parentLayer.childLayers.push(this),this.eventCallback("layermoved",{target:e})),t.length=0,re(e,this._tryConvertElementToWebLayer,this);for(const n of s)w.getClosestLayer(n.element,!1)||(n.needsRemoval=!0,t.push(n))}_tryConvertElementToWebLayer(e){if(this.needsRemoval)return!1;const t=e,s=getComputedStyle(t);if(t.getAttribute(w.ELEMENT_UID_ATTRIBUTE)||t.setAttribute(w.ELEMENT_UID_ATTRIBUTE,w.generateElementUID()),t.hasAttribute(w.LAYER_ATTRIBUTE)||t.nodeName==="VIDEO"||s.transform!=="none"){let o=w.layers.get(t);return o||(o=new me(this.manager,t,this.eventCallback)),this.childLayers.push(o),!1}return!0}}const ms=self.ResizeObserver||xt;function fs(a,e){if(document.contains(a))return a;const t=document.createElement("div");return t.setAttribute(w.RENDERING_CONTAINER_ATTRIBUTE,""),t.style.visibility="hidden",t.style.pointerEvents="none",t.style.touchAction="none",t.attachShadow({mode:"open"}).appendChild(a),document.documentElement.appendChild(t),a}const gs=new _,ys=new _,b=class{static get ELEMENT_UID_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-uid"}static get HOVER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-hover"}static get ACTIVE_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-active"}static get FOCUS_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-focus"}static get TARGET_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-target"}static get LAYER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-layer"}static get PIXEL_RATIO_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-pixel-ratio"}static get RENDERING_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering"}static get RENDERING_PARENT_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-parent"}static get RENDERING_CONTAINER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-container"}static get RENDERING_INLINE_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-inline"}static get RENDERING_DOCUMENT_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-document"}static generateElementUID(){return""+this._nextUID++}static getPsuedoAttributes(e){return`${e.hover?`${this.HOVER_ATTRIBUTE}="" `:" "}${e.focus?`${this.FOCUS_ATTRIBUTE}="" `:" "}${e.active?`${this.ACTIVE_ATTRIBUTE}="" `:" "}${e.target?`${this.TARGET_ATTRIBUTE}="" `:" "}`}static initRootNodeObservation(e){const t=e.ownerDocument,s=e.getRootNode(),i="head"in s?s.head:s;if(this.rootNodeObservers.get(s))return;if(!this.containerStyleElement){const p=this.containerStyleElement=t.createElement("style");t.head.appendChild(p),p.innerHTML=`
        [${b.RENDERING_CONTAINER_ATTRIBUTE}] {
          all: initial;
          position: fixed;
          width: 100%;
          height: 100%;
          top: 0px;
        }
      `}const n=`
    [${b.RENDERING_DOCUMENT_ATTRIBUTE}] * {
      transform: none !important;
    }

    [${b.RENDERING_ATTRIBUTE}], [${b.RENDERING_ATTRIBUTE}] * {
      visibility: visible !important;
      /* the following is a hack for Safari; 
      without some kind of css filter active, 
      any box-shadow effect will fail to rasterize properly */
      filter: opacity(1);
    }
    
    [${b.RENDERING_ATTRIBUTE}] [${b.LAYER_ATTRIBUTE}], [${b.RENDERING_ATTRIBUTE}] [${b.LAYER_ATTRIBUTE}] * {
      visibility: hidden !important;
    }

    [${b.RENDERING_ATTRIBUTE}] {
      position: relative !important;
      top: 0 !important;
      left: 0 !important;
      float: left !important; /* prevent margin-collapse in SVG foreign-element for Webkit */
      box-sizing:border-box;
      min-width:var(--x-width);
      min-height:var(--x-height);
    }
    
    [${b.RENDERING_INLINE_ATTRIBUTE}] {
      top: var(--x-inline-top) !important;
      width:auto !important;
    }

    [${b.RENDERING_PARENT_ATTRIBUTE}] {
      transform: none !important;
      left: 0 !important;
      top: 0 !important;
      margin: 0 !important;
      border:0 !important;
      border-radius:0 !important;
      width: 100% !important;
      height:100% !important;
      padding:0 !important;
      visibility:hidden !important;
      filter:none !important;
    }
    
    [${b.RENDERING_PARENT_ATTRIBUTE}]::before, [${b.RENDERING_PARENT_ATTRIBUTE}]::after {
      content:none !important;
      box-shadow:none !important;
    }
    `,o=t.createElement("style");if(o.textContent=n,i.append(o),s===t){let p="";const d=()=>{if(p!=window.location.hash&&window.location.hash)try{this.targetElement=s.querySelector(window.location.hash)}catch{}p=window.location.hash};window.addEventListener("hashchange",d,!1),d(),window.addEventListener("focusin",m=>{this.focusElement=m.target},!1),window.addEventListener("focusout",m=>{this.focusElement=null},!1),window.addEventListener("load",m=>{l()})}const l=()=>{for(const[p,d]of this.layers)d.needsRefresh=!0},c=p=>{var d=p.nodeName.toUpperCase();u.indexOf(d)!==-1&&p.addEventListener("load",l)},u=["STYLE","LINK"],h=new MutationObserver(p=>{for(const d of p){u.indexOf(d.target.nodeName.toUpperCase())!==-1&&l();for(const m of d.addedNodes)c(m)}});h.observe(t,{childList:!0,attributes:!0,characterData:!0,subtree:!0,attributeOldValue:!0,characterDataOldValue:!0}),this.rootNodeObservers.set(s,h)}static setLayerNeedsRefresh(e){e.needsRefresh=!0}static createLayerTree(e,t,s){if(b.getClosestLayer(e))throw new Error("A root WebLayer for the given element already exists");fs(e),b.initRootNodeObservation(e);const i=new MutationObserver(b._handleMutations);this.mutationObservers.set(e,i),this.startMutationObserver(e);const n=new ms(l=>{for(const c of l){const u=this.getClosestLayer(c.target);u.traverseLayers(b.setLayerNeedsRefresh),u.traverseParentLayers(b.setLayerNeedsRefresh)}});n.observe(e),this.resizeObservers.set(e,n),e.addEventListener("input",this._triggerRefresh,{capture:!0}),e.addEventListener("keydown",this._triggerRefresh,{capture:!0}),e.addEventListener("submit",this._triggerRefresh,{capture:!0}),e.addEventListener("change",this._triggerRefresh,{capture:!0}),e.addEventListener("focus",this._triggerRefresh,{capture:!0}),e.addEventListener("blur",this._triggerRefresh,{capture:!0}),e.addEventListener("transitionend",this._triggerRefresh,{capture:!0});const o=new me(t.manager,e,s);return this.rootLayers.set(e,o),o}static disposeLayer(e){this.rootLayers.has(e.element)&&(this.rootLayers.delete(e.element),this.mutationObservers.get(e.element).disconnect(),this.mutationObservers.delete(e.element),this.resizeObservers.get(e.element).disconnect(),this.resizeObservers.delete(e.element),e.element.removeEventListener("input",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("keydown",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("submit",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("change",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("focus",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("blur",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("transitionend",this._triggerRefresh,{capture:!0}))}static getClosestLayer(e,t=!0){let s=t?e:e.parentElement;const i=s==null?void 0:s.closest(`[${b.LAYER_ATTRIBUTE}]`);if(!i){const n=e==null?void 0:e.getRootNode().host;if(n)return this.getClosestLayer(n,t)}return this.layers.get(i)}static parseCSSTransform(e,t,s,i,n=new _){const o=e.transform,l=e.transformOrigin;if(o.indexOf("matrix(")==0){n.identity();var c=o.substring(7,o.length-1).split(", ").map(parseFloat);n.elements[0]=c[0],n.elements[1]=c[1],n.elements[4]=c[2],n.elements[5]=c[3],n.elements[12]=c[4],n.elements[13]=c[5]}else if(o.indexOf("matrix3d(")==0){var c=o.substring(9,o.length-1).split(", ").map(parseFloat);n.fromArray(c)}else return null;n.elements[0]===0&&(n.elements[0]=1e-15),n.elements[5]===0&&(n.elements[5]=1e-15),n.elements[10]===0&&(n.elements[10]=1e-15),n.elements[12]*=i,n.elements[13]*=i*-1;var u=l.split(" ").map(parseFloat),h=(u[0]-t/2)*i,p=(u[1]-s/2)*i*-1,d=u[2]||0,m=gs.identity().makeTranslation(-h,-p,-d),f=ys.identity().makeTranslation(h,p,d);for(const y of n.elements)if(isNaN(y))return null;return n.premultiply(f).multiply(m)}static pauseMutationObservers(){const e=b.mutationObservers.values();for(const t of e)b._handleMutations(t.takeRecords()),t.disconnect()}static resumeMutationObservers(){for(const[e]of b.mutationObservers)this.startMutationObserver(e)}static startMutationObserver(e){b.mutationObservers.get(e).observe(e,{attributes:!0,childList:!0,subtree:!0,characterData:!0,characterDataOldValue:!0,attributeOldValue:!0})}static arrayBufferToBase64(e){for(var t="",s=e.byteLength,i=0;i<s;i++)t+=String.fromCharCode(e[i]);return window.btoa(t)}static attributeCSS(e,t){return t?`[${e}]=${t}`:`[${e}]`}static attributeHTML(e,t){return t?`${e}="${t}"`:`${e}=""`}static async generateEmbeddedCSS(e,t){let s;const i=[];t=t.replace(new RegExp(":hover","g"),this.attributeCSS(this.HOVER_ATTRIBUTE)),t=t.replace(new RegExp(":active","g"),this.attributeCSS(this.ACTIVE_ATTRIBUTE)),t=t.replace(new RegExp(":focus","g"),this.attributeCSS(this.FOCUS_ATTRIBUTE)),t=t.replace(new RegExp(":target","g"),this.attributeCSS(this.TARGET_ATTRIBUTE));const n=RegExp(/(@import.*?["']([^"']+)["'].*?|url\((?!['"]?(?:data):)['"]?([^'"\)]*)['"]?\))/gi);for(;s=n.exec(t);){const l=!!s[2]?"type/css":void 0,c=s[2]||s[3];i.push(this.getDataURL(new URL(c,e).href,l).then(u=>{t=t.replace(c,u)}))}return await Promise.all(i),t}static async getAllEmbeddedStyles(e){const t=e.getRootNode(),s=this.embeddedStyles.get(t)||new Map;this.embeddedStyles.set(t,s);const i=Array.from(t.querySelectorAll("style, link[type='text/css'], link[rel='stylesheet']")),n=e.getRootNode()instanceof ShadowRoot;for(const o of i)s.has(o)||s.set(o,new Promise(l=>{if(o.tagName.toLowerCase()==="style")l(o.textContent||"");else{const c=o;l(this.getEmbeddedCSS(c.href))}}).then(l=>{const c=RegExp(/@font-face[^{]*{([^{}]|{[^{}]*})*}/gi),u=l.match(c);if(n&&u)for(const h of u){if(this.fontStyles.has(h))continue;const p=document.createElement("style");p.innerHTML=u.reduce((d,m)=>m+`

`+d,""),document.head.appendChild(p),this.fontStyles.set(h,p),s.set(p,Promise.resolve(""))}return this.generateEmbeddedCSS(window.location.href,l)}));return Promise.all(s.values())}static deleteEmbeddedStyle(e){const t=e.getRootNode(),s=this.embeddedStyles.get(t);s==null||s.delete(e)}static async getDataURL(e,t){if(e.startsWith("data"))return e;if(this.dataURLMap.has(e))return this.dataURLMap.get(e);const s=new Promise(async i=>{const n=await fetch(e,t?{headers:{accept:t}}:void 0),o=n.headers.get("content-type");if(o=="text/css"){const l=await this.generateEmbeddedCSS(e,await n.text());this.embeddedCSSMap.set(e,l),i("data:"+o+";base64,"+window.btoa(l))}else{const l=new Uint8Array(await n.arrayBuffer());i("data:"+o+";base64,"+this.arrayBufferToBase64(l))}});return this.dataURLMap.set(e,s),s}static async getEmbeddedCSS(e){if(this.embeddedCSSMap.has(e))return this.embeddedCSSMap.get(e);const t=await fetch(e,{headers:{accept:"text/css"}}),s=await this.generateEmbeddedCSS(e,await t.text());return this.embeddedCSSMap.set(e,s),this.embeddedCSSMap.get(e)}static updateInputAttributes(e){e.matches("input")&&this._updateInputAttribute(e);for(const t of e.getElementsByTagName("input"))this._updateInputAttribute(t)}static _updateInputAttribute(e){e.hasAttribute("checked")?e.checked||e.removeAttribute("checked"):e.checked&&e.setAttribute("checked",""),e.getAttribute("value")!==e.value&&e.setAttribute("value",e.value)}static isBlankImage(e){return!new Uint32Array(e.buffer).some(s=>s!==0)}};let w=b;r(w,"ATTRIBUTE_PREFIX","xr"),r(w,"_nextUID",0),r(w,"serializer",new XMLSerializer),r(w,"rootLayers",new Map),r(w,"layers",new Map),r(w,"focusElement",null),r(w,"activeElement",null),r(w,"targetElement",null),r(w,"mutationObservers",new Map),r(w,"resizeObservers",new Map),r(w,"rootNodeObservers",new Map),r(w,"containerStyleElement"),r(w,"_handleMutations",e=>{var t,s;for(const i of e){if(i.type==="attributes"&&i.target.getAttribute(i.attributeName)===i.oldValue)continue;if(i.type==="characterData"){const l=i.target;if(l.data===i.oldValue)continue;if(((t=l.parentElement)==null?void 0:t.tagName.toLowerCase())==="style"){const c=l.parentElement,u=c.getRootNode();(s=b.embeddedStyles.get(u))==null||s.delete(c)}}const n=i.target.nodeType===Node.ELEMENT_NODE?i.target:i.target.parentElement;if(!n)continue;const o=b.getClosestLayer(n);if(!!o){if(i.type==="attributes"&&i.attributeName==="class"){const l=i.oldValue?i.oldValue:"",c=i.target.className;if(l===c)continue}o.parentLayer?o.parentLayer.traverseChildLayers(b.setLayerNeedsRefresh):o.traverseLayers(b.setLayerNeedsRefresh)}}}),r(w,"_triggerRefresh",async e=>{const t=b.getClosestLayer(e.target);t&&(t.parentLayer?t.parentLayer.traverseChildLayers(b.setLayerNeedsRefresh):t.traverseLayers(b.setLayerNeedsRefresh))}),r(w,"embeddedStyles",new Map),r(w,"fontStyles",new Map),r(w,"dataURLMap",new Map),r(w,"embeddedCSSMap",new Map);const fe=Symbol("ON_BEFORE_UPDATE"),ge=new K,ws=new St;function $e(a){const e=a.attributes.uv;for(let t=0;t<e.count;t++)e.setY(t,1-e.getY(t));return a}const X=class extends Y{constructor(e,t){super();r(this,"element");r(this,"container");r(this,"_camera");r(this,"_webLayer");r(this,"_localZ",0);r(this,"_viewZ",0);r(this,"_renderZ",0);r(this,"_mediaTexture");r(this,"textures",new Set);r(this,"_previousTexture");r(this,"contentMesh");r(this,"_boundsMesh");r(this,"cursor",new Y);r(this,"depthMaterial",new Et({depthPacking:Rt,alphaTest:.001}));r(this,"domLayout",new Y);r(this,"domSize",new K(1,1,1));r(this,"bounds",new F);r(this,"margin",new Q);r(this,"childWebLayers",[]);r(this,"shouldApplyDOMLayout","auto");this.element=e,this.container=t,this.name=e.id,this._webLayer=w.getClosestLayer(e),e.layer=this;const s=this.element.nodeName==="VIDEO"?X.GEOMETRY:X.FLIPPED_GEOMETRY;this.contentMesh=new be(s,new ve({side:Mt,depthWrite:!1,transparent:!0,alphaTest:.001,opacity:1,toneMapped:!1})),this._boundsMesh=new be(s,new ve({visible:!1})),this.add(this.contentMesh),this.add(this._boundsMesh),this.cursor.visible=!1,this.matrixAutoUpdate=!0,this.contentMesh.matrixAutoUpdate=!0,this.contentMesh.visible=!1,this.contentMesh.customDepthMaterial=this.depthMaterial,this.contentMesh.onBeforeRender=(i,n,o)=>{this._camera=o},this._boundsMesh.matrixAutoUpdate=!0,this.container.options.manager.layersByElement.set(this.element,this),this.container.options.manager.layersByMesh.set(this.contentMesh,this)}static shouldApplyDOMLayout(e){const t=e.shouldApplyDOMLayout;return t==="always"||t===!0?!0:t==="never"||t===!1?!1:!!(t==="auto"&&e.parentWebLayer&&e.parent===e.parentWebLayer)}get domState(){return this._webLayer.currentDOMState}get texture(){var i;const e=this.container.manager;if(this.element.tagName==="VIDEO"){const n=this.element;let o=this._mediaTexture;return o||(o=new Tt(n),o.wrapS=Z,o.wrapT=Z,o.minFilter=xe,e.textureEncoding&&(o.encoding=e.textureEncoding),this._mediaTexture=o),o}const t=(i=this._webLayer.currentDOMState)==null?void 0:i.texture.url;let s=t?e.getTexture(t,this):void 0;return s&&this.textures.add(s),s}get desiredPseudoStates(){return this._webLayer.desiredPseudoState}get pseudoStates(){var e;return(e=this._webLayer.currentDOMState)==null?void 0:e.pseudo}get depth(){return this._webLayer.depth}get index(){return this.parentWebLayer?this.parentWebLayer.childWebLayers.indexOf(this):0}get needsRefresh(){return this._webLayer.needsRefresh}setNeedsRefresh(e=!0){this._webLayer.setNeedsRefresh(e)}get needsRemoval(){return this._webLayer.needsRemoval}get parentWebLayer(){return this._webLayer.parentLayer&&this.container.manager.layersByElement.get(this._webLayer.parentLayer.element)}async refresh(e=!1){var s;const t=[];t.push(this._webLayer.refresh()),this.childWebLayers.length=0;for(const i of this._webLayer.childLayers){const n=this.container.manager.layersByElement.get((s=w.getClosestLayer(i.element))==null?void 0:s.element);!n||(this.childWebLayers.push(n),e&&t.push(n.refresh(e)))}return Promise.all(t).then(()=>{})}updateLayout(){if(this._updateDOMLayout(),this._camera){this._localZ=Math.abs(ge.setFromMatrixPosition(this.matrix).z+ge.setFromMatrixPosition(this.contentMesh.matrix).z),this._viewZ=Math.abs(this.contentMesh.getWorldPosition(ge).applyMatrix4(this._camera.matrixWorldInverse).z);let e=this.parentWebLayer?this.parentWebLayer._renderZ:this._viewZ;this._localZ<.001?this._renderZ=e:this._renderZ=this._viewZ,this.contentMesh.renderOrder=(this.container.options.renderOrderOffset||0)+(1-Math.log(this._renderZ+1)/Math.log(this._camera.far+1))+(this.depth+this.index*.001)*1e-7}}updateContent(){const e=this.contentMesh,t=this.texture,s=e.material;if(t&&s.map!==t){const o=this.contentMesh.scale,l=Math.abs(o.x*this.scale.x/o.y*this.scale.y),c=this.domSize.x/this.domSize.y;Math.abs(c-l)<1e3&&(s.map=t,this.depthMaterial.map=t,s.needsUpdate=!0,this.depthMaterial.needsUpdate=!0)}s.transparent=!0;const i=e.material,n=i.opacity<.005;n?e.visible=!1:i.map&&(e.visible=!0),this.needsRemoval&&n&&(this.parent&&this.parent.remove(this),this.dispose()),this._refreshVideoBounds()}[fe](){}_doUpdate(){var e,t;this[fe](),this.updateContent(),this.updateLayout(),X.shouldApplyDOMLayout(this)&&(this.position.copy(this.domLayout.position),this.quaternion.copy(this.domLayout.quaternion),this.scale.copy(this.domLayout.scale)),this.contentMesh.position.set(0,0,0),this.contentMesh.scale.copy(this.domSize),this.contentMesh.quaternion.set(0,0,0,1),this._boundsMesh.position.set(0,0,0),this._boundsMesh.scale.copy(this.domSize),this._boundsMesh.quaternion.set(0,0,0,1),this.needsRefresh&&this.container.options.autoRefresh!==!1&&this.refresh(),this._previousTexture!==this.texture&&(this.texture&&this.container.manager.renderer.initTexture(this.texture),this._previousTexture=this.texture,(t=(e=this.container.options).onLayerPaint)==null||t.call(e,this)),this._webLayer.update(),this.container.manager.scheduleTasksIfNeeded()}update(e=!1){e?this.traverseLayersPreOrder(this._doUpdate):this._doUpdate()}querySelector(e){var s;const t=this.element.querySelector(e)||((s=this.element.shadowRoot)==null?void 0:s.querySelector(e));if(t)return this.container.manager.layersByElement.get(t)}traverseLayerAncestors(e){const t=this.parentWebLayer;t&&(t.traverseLayerAncestors(e),e.call(this,t))}traverseLayersPreOrder(e){if(e.call(this,this)===!1)return!1;for(const t of this.childWebLayers)if(t.traverseLayersPreOrder(e)===!1)return!1;return!0}traverseLayersPostOrder(e){for(const t of this.childWebLayers)if(t.traverseLayersPostOrder(e)===!1)return!1;return e.call(this,this)||!0}dispose(){w.disposeLayer(this._webLayer),this.container.manager.disposeLayer(this);for(const e of this.childWebLayers)e.dispose()}_refreshVideoBounds(){if(this.element.nodeName==="VIDEO"){const e=this.domState;if(!e)return;const t=this.element,s=this.texture,i=getComputedStyle(this.element),{objectFit:n}=i,{width:o,height:l}=this.bounds.copy(e.bounds),{videoWidth:c,videoHeight:u}=t,h=c/u,p=o/l;switch(s.center.set(.5,.5),n){case"none":s.repeat.set(o/c,l/u).clampScalar(0,1);break;case"contain":case"scale-down":if(s.repeat.set(1,1),p>h){const d=this.bounds.height*h||0;this.bounds.left+=(this.bounds.width-d)/2,this.bounds.width=d}else{const d=this.bounds.width/h||0;this.bounds.top+=(this.bounds.height-d)/2,this.bounds.height=d}break;case"cover":if(s.repeat.set(o/c,l/u),p<h){const d=this.bounds.height*h||0;this.bounds.left+=(this.bounds.width-d)/2,this.bounds.width=d}else{const d=this.bounds.width/h||0;this.bounds.top+=(this.bounds.height-d)/2,this.bounds.height=d}break;default:case"fill":s.repeat.set(1,1);break}e.bounds.copy(this.bounds)}}_updateDOMLayout(){if(this.needsRemoval)return;const e=this._webLayer.currentDOMState;if(!e)return;const{bounds:t,margin:s}=e;this.domLayout.position.set(0,0,0),this.domLayout.scale.set(1,1,1),this.domLayout.quaternion.set(0,0,0,1);const i=this.bounds.copy(t),n=this.margin.copy(s),o=i.width+n.left+n.right,l=i.height+n.top+n.bottom,c=i.width,u=i.height,h=1/this.container.manager.pixelsPerUnit;this.domSize.set(Math.max(h*(c+n.left+n.right),1e-5),Math.max(h*(u+n.top+n.bottom),1e-5),1);const p=this.parentWebLayer;if(!p)return;const d=p.bounds,m=p.margin,f=d.width+m.left+m.right,y=d.height+m.bottom+m.top,v=-f/2+m.left,S=y/2-m.top;this.domLayout.position.set(h*(v+o/2+i.left-n.left),h*(S-l/2-i.top+n.top),0);const T=getComputedStyle(this.element),E=T.transform;if(E&&E!=="none"){const x=w.parseCSSTransform(T,i.width,i.height,h,ws);x&&(this.domLayout.updateMatrix(),this.domLayout.matrix.multiply(x),this.domLayout.matrix.decompose(this.domLayout.position,this.domLayout.quaternion,this.domLayout.scale))}}};let ae=X;r(ae,"GEOMETRY",$e(new _e(1,1,2,2))),r(ae,"FLIPPED_GEOMETRY",$e(new _e(1,1,2,2)));var _s=`(() => {
  var __create = Object.create;
  var __defProp = Object.defineProperty;
  var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
  var __getOwnPropNames = Object.getOwnPropertyNames;
  var __getProtoOf = Object.getPrototypeOf;
  var __hasOwnProp = Object.prototype.hasOwnProperty;
  var __markAsModule = (target) => __defProp(target, "__esModule", { value: true });
  var __commonJS = (cb, mod) => function __require() {
    return mod || (0, cb[__getOwnPropNames(cb)[0]])((mod = { exports: {} }).exports, mod), mod.exports;
  };
  var __reExport = (target, module, copyDefault, desc) => {
    if (module && typeof module === "object" || typeof module === "function") {
      for (let key of __getOwnPropNames(module))
        if (!__hasOwnProp.call(target, key) && (copyDefault || key !== "default"))
          __defProp(target, key, { get: () => module[key], enumerable: !(desc = __getOwnPropDesc(module, key)) || desc.enumerable });
    }
    return target;
  };
  var __toESM = (module, isNodeMode) => {
    return __reExport(__markAsModule(__defProp(module != null ? __create(__getProtoOf(module)) : {}, "default", !isNodeMode && module && module.__esModule ? { get: () => module.default, enumerable: true } : { value: module, enumerable: true })), module);
  };

  // (disabled):../../node_modules/@loaders.gl/worker-utils/dist/esm/lib/node/require-utils.node
  var require_require_utils = __commonJS({
    "(disabled):../../node_modules/@loaders.gl/worker-utils/dist/esm/lib/node/require-utils.node"() {
    }
  });

  // ../../node_modules/@loaders.gl/textures/dist/esm/lib/utils/version.js
  var VERSION = true ? "3.1.4" : "latest";

  // ../../node_modules/@loaders.gl/worker-utils/dist/esm/lib/env-utils/assert.js
  function assert(condition, message) {
    if (!condition) {
      throw new Error(message || "loaders.gl assertion failed.");
    }
  }

  // ../../node_modules/@loaders.gl/worker-utils/dist/esm/lib/env-utils/globals.js
  var globals = {
    self: typeof self !== "undefined" && self,
    window: typeof window !== "undefined" && window,
    global: typeof global !== "undefined" && global,
    document: typeof document !== "undefined" && document
  };
  var self_ = globals.self || globals.window || globals.global || {};
  var window_ = globals.window || globals.self || globals.global || {};
  var global_ = globals.global || globals.self || globals.window || {};
  var document_ = globals.document || {};
  var isBrowser = typeof process !== "object" || String(process) !== "[object process]" || process.browser;
  var isWorker = typeof importScripts === "function";
  var isMobile = typeof window !== "undefined" && typeof window.orientation !== "undefined";
  var matches = typeof process !== "undefined" && process.version && /v([0-9]*)/.exec(process.version);
  var nodeVersion = matches && parseFloat(matches[1]) || 0;

  // ../../node_modules/@loaders.gl/worker-utils/dist/esm/lib/library-utils/library-utils.js
  var node = __toESM(require_require_utils());
  var VERSION2 = true ? "3.1.4" : LATEST;
  var loadLibraryPromises = {};
  async function loadLibrary(libraryUrl, moduleName = null, options = {}) {
    if (moduleName) {
      libraryUrl = getLibraryUrl(libraryUrl, moduleName, options);
    }
    loadLibraryPromises[libraryUrl] = loadLibraryPromises[libraryUrl] || loadLibraryFromFile(libraryUrl);
    return await loadLibraryPromises[libraryUrl];
  }
  function getLibraryUrl(library, moduleName, options) {
    if (library.startsWith("http")) {
      return library;
    }
    const modules = options.modules || {};
    if (modules[library]) {
      return modules[library];
    }
    if (!isBrowser) {
      return "modules/".concat(moduleName, "/dist/libs/").concat(library);
    }
    if (options.CDN) {
      assert(options.CDN.startsWith("http"));
      return "".concat(options.CDN, "/").concat(moduleName, "@").concat(VERSION2, "/dist/libs/").concat(library);
    }
    if (isWorker) {
      return "../src/libs/".concat(library);
    }
    return "modules/".concat(moduleName, "/src/libs/").concat(library);
  }
  async function loadLibraryFromFile(libraryUrl) {
    if (libraryUrl.endsWith("wasm")) {
      const response2 = await fetch(libraryUrl);
      return await response2.arrayBuffer();
    }
    if (!isBrowser) {
      try {
        return node && node.requireFromFile && await node.requireFromFile(libraryUrl);
      } catch {
        return null;
      }
    }
    if (isWorker) {
      return importScripts(libraryUrl);
    }
    const response = await fetch(libraryUrl);
    const scriptSource = await response.text();
    return loadLibraryFromString(scriptSource, libraryUrl);
  }
  function loadLibraryFromString(scriptSource, id) {
    if (!isBrowser) {
      return node.requireFromString && node.requireFromString(scriptSource, id);
    }
    if (isWorker) {
      eval.call(global_, scriptSource);
      return null;
    }
    const script = document.createElement("script");
    script.id = id;
    try {
      script.appendChild(document.createTextNode(scriptSource));
    } catch (e) {
      script.text = scriptSource;
    }
    document.body.appendChild(script);
    return null;
  }

  // ../../node_modules/@loaders.gl/textures/dist/esm/lib/parsers/basis-module-loader.js
  var VERSION3 = true ? "3.1.4" : "latest";
  var BASIS_CDN_ENCODER_WASM = "https://unpkg.com/@loaders.gl/textures@".concat(VERSION3, "/dist/libs/basis_encoder.wasm");
  var BASIS_CDN_ENCODER_JS = "https://unpkg.com/@loaders.gl/textures@".concat(VERSION3, "/dist/libs/basis_encoder.js");
  var loadBasisEncoderPromise;
  async function loadBasisEncoderModule(options) {
    const modules = options.modules || {};
    if (modules.basisEncoder) {
      return modules.basisEncoder;
    }
    loadBasisEncoderPromise = loadBasisEncoderPromise || loadBasisEncoder(options);
    return await loadBasisEncoderPromise;
  }
  async function loadBasisEncoder(options) {
    let BASIS_ENCODER = null;
    let wasmBinary = null;
    [BASIS_ENCODER, wasmBinary] = await Promise.all([await loadLibrary(BASIS_CDN_ENCODER_JS, "textures", options), await loadLibrary(BASIS_CDN_ENCODER_WASM, "textures", options)]);
    BASIS_ENCODER = BASIS_ENCODER || globalThis.BASIS;
    return await initializeBasisEncoderModule(BASIS_ENCODER, wasmBinary);
  }
  function initializeBasisEncoderModule(BasisEncoderModule, wasmBinary) {
    const options = {};
    if (wasmBinary) {
      options.wasmBinary = wasmBinary;
    }
    return new Promise((resolve) => {
      BasisEncoderModule(options).then((module) => {
        const {
          BasisFile,
          KTX2File,
          initializeBasis,
          BasisEncoder
        } = module;
        initializeBasis();
        resolve({
          BasisFile,
          KTX2File,
          BasisEncoder
        });
      });
    });
  }

  // ../../node_modules/@loaders.gl/textures/dist/esm/lib/encoders/encode-ktx2-basis-texture.js
  async function encodeKTX2BasisTexture(image, options = {}) {
    const {
      useSRGB = false,
      qualityLevel = 10,
      encodeUASTC = false,
      mipmaps = false
    } = options;
    const {
      BasisEncoder
    } = await loadBasisEncoderModule(options);
    const basisEncoder = new BasisEncoder();
    try {
      const basisFileData = new Uint8Array(image.width * image.height * 4);
      basisEncoder.setCreateKTX2File(true);
      basisEncoder.setKTX2UASTCSupercompression(true);
      basisEncoder.setKTX2SRGBTransferFunc(true);
      basisEncoder.setSliceSourceImage(0, image.data, image.width, image.height, false);
      basisEncoder.setPerceptual(useSRGB);
      basisEncoder.setMipSRGB(useSRGB);
      basisEncoder.setQualityLevel(qualityLevel);
      basisEncoder.setUASTC(encodeUASTC);
      basisEncoder.setMipGen(mipmaps);
      const numOutputBytes = basisEncoder.encode(basisFileData);
      const actualKTX2FileData = basisFileData.subarray(0, numOutputBytes).buffer;
      return actualKTX2FileData;
    } catch (error) {
      console.error("Basis Universal Supercompressed GPU Texture encoder Error: ", error);
      throw error;
    } finally {
      basisEncoder.delete();
    }
  }

  // ../../node_modules/@loaders.gl/textures/dist/esm/ktx2-basis-universal-texture-writer.js
  var KTX2BasisUniversalTextureWriter = {
    name: "Basis Universal Supercompressed GPU Texture",
    id: "ktx2-basis-supercompressed-texture",
    module: "textures",
    version: VERSION,
    extensions: ["ktx2"],
    options: {
      useSRGB: false,
      qualityLevel: 10,
      encodeUASTC: false,
      mipmaps: false
    },
    encode: encodeKTX2BasisTexture
  };

  // core/textures/KTX2Worker.ts
  var worker = self;
  worker.onmessage = async (msg) => {
    try {
      const texture = await KTX2BasisUniversalTextureWriter.encode(msg.data);
      const response = { texture };
      worker.postMessage(response, [texture]);
    } catch (err) {
      worker.postMessage({ error: err.message });
    }
  };
})();
`,bs=class{constructor(a=4){r(this,"pool");r(this,"queue",[]);r(this,"workers",[]);r(this,"workersResolve",[]);r(this,"workerStatus",0);r(this,"workerCreator");this.pool=a}_initWorker(a){if(!this.workers[a]){const e=this.workerCreator();e.addEventListener("message",this._onMessage.bind(this,a)),this.workers[a]=e}}_getIdleWorker(){for(let a=0;a<this.pool;a++)if(!(this.workerStatus&1<<a))return a;return-1}_onMessage(a,e){const t=this.workersResolve[a];if(t&&t(e),this.queue.length){const{resolve:s,msg:i,transfer:n}=this.queue.shift();this.workersResolve[a]=s,this.workers[a].postMessage(i,n)}else this.workerStatus^=1<<a}setWorkerCreator(a){this.workerCreator=a}setWorkerLimit(a){this.pool=a}postMessage(a,e){return new Promise(t=>{const s=this._getIdleWorker();s!==-1?(this._initWorker(s),this.workerStatus|=1<<s,this.workersResolve[s]=t,this.workers[s].postMessage(a,e)):this.queue.push({resolve:t,msg:a,transfer:e})})}dispose(){this.workers.forEach(a=>a.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}},vs=new Blob([_s],{type:"text/javascript"}),xs=URL.createObjectURL(vs),Ss=class{constructor(){r(this,"pool",new bs(2));this.pool.setWorkerCreator(()=>new Worker(xs))}async encode(a){const e=await this.pool.postMessage(a,[a.data.buffer]);if(e.data.error)throw new Error(e.data.error);if(!e.data.texture)throw new Error("Encoding failed");return e.data.texture}};function Ms(a){return a.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g,"")}function Ge(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function Ts(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function V(a,e){return" "+a+'="'+Ge(e)+'"'}function Es(a,e){return!a.hasAttribute("xmlns")&&(e||a.namespaceURI!==a.parentElement.namespaceURI)?' xmlns="'+a.namespaceURI+'"':""}async function He(a,e){let t=[];for(const s of a.childNodes)t.push(Qe(s,e));return Promise.all(t).then(s=>s.join(""))}async function Rs(a,e){const t=a.tagName.toLowerCase();let s="<"+t;s+=Es(a,e.depth===0);const i=He(a,e);for(const n of a.attributes)n.name==="src"?a.nodeName==="IMG"?s+=V(n.name,await w.getDataURL(n.value)):s+=V("data-src",n.value):s+=V(n.name,n.value);return a.childNodes.length>0?(e.depth++,s+=">",s+=await i,s+="</"+t+">",e.depth--):s+="/>",s}function zs(a){var e=a.nodeValue||"";return Ts(e)}function Bs(a){return"<![CDATA["+a.nodeValue+"]]>"}async function Qe(a,e){var s;const t=(s=e.replacer)==null?void 0:s.call(e,e.target,a);if(typeof t=="string")return t;if(a.nodeName==="#document"||a.nodeName==="#document-fragment")return He(a,e);if(a.tagName)return Rs(a,e);if(a.nodeName==="#text")return zs(a);if(a.nodeName!=="#comment"){if(a.nodeName==="#cdata-section")return Bs(a)}return""}async function Cs(a,e=Os){return Ms(await Qe(a,{depth:0,target:a,replacer:e}))}const Os=(a,e)=>{var n;if(a===e)return;const t=e,s=(n=t.tagName)==null?void 0:n.toLowerCase();if(s==="style"||s==="link")return"";const i=w.layers.get(t);if(i){const o=i.domMetrics.bounds;let l="";const c=`box-sizing:border-box;max-width:${o.width}px;max-height:${o.height}px;min-width:${o.width}px;min-height:${o.height}px;visibility:hidden`;let u=!1;for(const p of i.element.attributes)p.name!=="src"&&(p.name=="style"?(l+=V(p.name,p.value+";"+c),u=!0):l+=V(p.name,p.value));u||(l+=V("style",c));const h=t.tagName.toLowerCase();return`<${h} ${l}></${h}>`}};function Ls(a,e,t,s){const i=[],n=[],o=a.domMetrics;let l=a.element.parentElement;l||(l=document.documentElement);do{let c=l.tagName.toLowerCase(),u=" ",h="";for(const m of l.attributes){const f=Ge(m.value);if(m.name==="style"){h=f;continue}u+=`${m.name}="${f}" `}const p="<"+c+(c==="html"?` ${w.RENDERING_DOCUMENT_ATTRIBUTE}="" xmlns="http://www.w3.org/1999/xhtml"
                    style="${As(s)} --x-width:${o.bounds.width}px; --x-height:${o.bounds.height}px; --x-inline-top:${o.border.top+o.margin.top+o.padding.top}px; ${h} width:${e}px; height:${t}px;" `:` style="${h}" ${w.RENDERING_PARENT_ATTRIBUTE}="" `)+u+" >";i.unshift(p);const d="</"+c+">";if(n.push(d),c=="html")break}while(l=l!==document.documentElement?l.parentElement||document.documentElement:null);return[i.join(""),n.join("")]}function As(a){return Ds.test(navigator.userAgent)?`zoom:${a}; `:`transform: scale(${a}); transform-origin: top left; `}const Ds=/^((?!chrome|android).)*safari/i,Xe=new Array(255);for(let a=0;a<=255;++a){const e=a.toString(16).padStart(2,"0");Xe[a]=e}function Ns(a){const e=a.length;let t="";for(let s=0;s<e;++s)t+=Xe[a[s]];return t}function Ke(a){return Ns(new Uint8Array(a))}class Is extends zt{constructor(e){super(e);r(this,"textures");this.version(1).stores({textures:"&hash, lastUsedTime"})}}function Ps(a){return 1<<31-Math.clz32(a)}function Ye(a){return Ps((a-1)*2)}class Us{constructor(e="web-layer-cache"){r(this,"WebRenderer",w);r(this,"_textureStore");r(this,"_textureUrls",new Map);r(this,"_textureData",new Map);r(this,"_layerState",new Map);r(this,"serializeQueue",[]);r(this,"rasterizeQueue",[]);r(this,"MINIMUM_RENDER_ATTEMPTS",3);r(this,"canvasPool",[]);r(this,"imagePool",[]);r(this,"textEncoder",new TextEncoder);r(this,"ktx2Encoder",new Ss);r(this,"useCreateImageBitmap",!1);r(this,"tasksPending",!1);r(this,"serializePendingCount",0);r(this,"rasterizePendingCount",0);r(this,"MAX_SERIALIZE_TASK_COUNT",10);r(this,"MAX_RASTERIZE_TASK_COUNT",10);r(this,"_runTasks",()=>{const e=this.serializeQueue,t=this.rasterizeQueue;for(console.log("serialize task size",e.length,e),console.log("rasterize task size",t.length,t);e.length>0&&this.serializePendingCount<this.MAX_RASTERIZE_TASK_COUNT;){this.serializePendingCount++;const{layer:s,resolve:i}=e.shift();this.serialize(s).then(n=>{this.serializePendingCount--,i(n)})}for(;t.length>0&&this.rasterizePendingCount<this.MAX_SERIALIZE_TASK_COUNT;){this.rasterizePendingCount++;const{hash:s,url:i,resolve:n}=t.shift();this.rasterize(s,i).finally(()=>{this.rasterizePendingCount--,n(void 0)})}this.tasksPending=!1});this._textureStore=new Is(e),window.addEventListener("blur",t=>{this._textureStore.textures.bulkPut(Array.from(this._textureData.values()))})}getLayerState(e){let t=this._layerState.get(e);return t||(t={bounds:new F,margin:new Q,fullWidth:0,fullHeight:0,renderAttempts:0,texture:{hash:void 0,url:void 0,width:32,height:32,pixelRatio:1},pseudo:{hover:!1,active:!1,focus:!1,target:!1}},this._layerState.set(e,t)),t.texture.hash&&(t.texture.url=this.getTextureURL(t.texture.hash)),t}async updateTexture(e,t){const s=await this.ktx2Encoder.encode(t),i=this._textureData.get(e)||{hash:e,renderAttempts:0,lastUsedTime:Date.now(),texture:void 0};i.texture=s,this._textureData.set(e,i)}async requestTextureData(e){if(!this._textureData.has(e)){const i=await this._textureStore.textures.get(e);i&&!this._textureData.has(e)&&this._textureData.set(e,i)}const t=this._textureData.get(e),s=t==null?void 0:t.texture;return!this._textureUrls.has(e)&&s&&await void this._textureUrls.set(e,URL.createObjectURL(new Blob([s],{type:"image/ktx2"}))),this._textureData.get(e)}getTextureData(e){return this._textureData.has(e)||setTimeout(()=>this.requestTextureData(e),1),this._textureData.get(e)}getTextureURL(e){return this._textureUrls.has(e)||setTimeout(()=>this.requestTextureData(e),1),this._textureUrls.get(e)}scheduleTasksIfNeeded(){this.tasksPending||this.serializeQueue.length===0&&this.rasterizeQueue.length===0||(this.tasksPending=!0,setTimeout(this._runTasks,1))}addToSerializeQueue(e){const t=this.serializeQueue.find(n=>n.layer===e);if(t)return console.log("in serialize queue"),t.promise;e.currentDOMStateHash=void 0;let s;const i=new Promise(n=>{s=n});return this.serializeQueue.push({layer:e,resolve:s,promise:i}),i}async serialize(e){var ye;const t=e.element,s=e.domMetrics;ne(t,s.bounds,(ye=e.parentLayer)==null?void 0:ye.element),ls(t,s.margin);const{width:i,height:n}=s.bounds,o=i+Math.max(s.margin.left,0)+Math.max(s.margin.right,0),l=n+Math.max(s.margin.top,0)+Math.max(s.margin.bottom,0);hs(t,s.padding),us(t,s.border);const c=e.pixelRatio||parseFloat(e.element.getAttribute(w.PIXEL_RATIO_ATTRIBUTE))||window.devicePixelRatio,u=w.attributeHTML(w.ELEMENT_UID_ATTRIBUTE,""+e.id),p=getComputedStyle(t).display==="inline";w.updateInputAttributes(t);const d=Ls(e,o,l,c),m=await w.getAllEmbeddedStyles(t);let f=await Cs(t);f=f.replace(u,`${u} ${w.RENDERING_ATTRIBUTE}="" ${p?`${w.RENDERING_INLINE_ATTRIBUTE}="" `:" "} `+w.getPsuedoAttributes(e.desiredPseudoState));const y=Math.max(Ye(o*c),32),v=Math.max(Ye(l*c),32),S='<svg width="'+y+'" height="'+v+`" xmlns="http://www.w3.org/2000/svg"><defs><style type="text/css"><![CDATA[
`+m.join(`
`)+']]></style></defs><foreignObject x="0" y="0" width="'+o*c+'" height="'+l*c+'">'+d[0]+f+d[1]+"</foreignObject></svg>",T="data:image/svg+xml;utf8,"+encodeURIComponent(S),E=await crypto.subtle.digest("SHA-1",this.textEncoder.encode(S)),x=Ke(E)+"?w="+o+";h="+l+";tw="+y+";th="+v;e.currentDOMStateHash=x;const R=this.getLayerState(x);R.bounds.copy(s.bounds),R.margin.copy(s.margin),R.fullWidth=o,R.fullHeight=l,R.texture.width=y,R.texture.height=v,R.texture.pixelRatio=c,e._svgUrl=T;const et=e.element.nodeName,tt=o*l>0&&et!=="VIDEO"&&(R.renderAttempts<this.MINIMUM_RENDER_ATTEMPTS||!R.texture.hash);return{svgHash:x,svgUrl:T,needsRasterize:tt}}async rasterize(e,t){const s=this.getLayerState(e),i=this.imagePool.pop()||new Image;if(await new Promise((E,x)=>{i.onload=()=>{E()},i.onerror=R=>{x(R)},i.width=s.texture.width,i.height=s.texture.height,i.src=t}),!i.complete||i.currentSrc!==t)throw new Error("Rasterization Failed");const{fullWidth:n,fullHeight:o,texture:l}=s,{width:c,height:u,pixelRatio:h}=l,p=Math.floor(n*h),d=Math.floor(o*h),m=await this.getImageData(i,p,d,30,30),f=await crypto.subtle.digest("SHA-1",m.data),y=Ke(f)+"?w="+c+";h="+u,v=s.texture.hash;if(s.texture.hash=y,v!==y&&(s.renderAttempts=0),s.renderAttempts++,s.renderAttempts>this.MINIMUM_RENDER_ATTEMPTS&&s.texture)return;setTimeout(()=>this.addToRasterizeQueue(e,t),(500+Math.random()*1e3)*2^s.renderAttempts);const S=this.getTextureData(y);if(S==null?void 0:S.texture)return;const T=await this.getImageData(i,p,d,c,u);try{await this.updateTexture(y,T)}finally{this.imagePool.push(i)}}async getImageData(e,t,s,i,n){const o=this.canvasPool.pop()||document.createElement("canvas");o.width=i,o.height=n;const l=o.getContext("2d");l.imageSmoothingEnabled=!1,l.clearRect(0,0,i,n);let c;if(this.useCreateImageBitmap){const u=await createImageBitmap(e,0,0,t*devicePixelRatio,s*devicePixelRatio,{resizeWidth:i,resizeHeight:n,resizeQuality:"high"});l.drawImage(u,0,0,t,s,0,0,i,n)}else l.drawImage(e,0,0,t,s,0,0,i,n);try{c=l.getImageData(0,0,i,n)}catch{return this.useCreateImageBitmap=!1,this.getImageData(e,t,s,i,n)}return setTimeout(()=>this.canvasPool.push(o),10),c}addToRasterizeQueue(e,t){const s=this.rasterizeQueue.find(o=>o.hash===e);if(s)return console.log("in rasterize queue"),s.promise;let i;const n=new Promise(o=>{i=o});return this.rasterizeQueue.push({hash:e,url:t,resolve:i,promise:n}),n}}const U=class extends Us{constructor(){super();r(this,"renderer");r(this,"textureEncoding",Ct);r(this,"texturesByUrl",new Map);r(this,"layersUsingTexture",new WeakMap);r(this,"textureLoader",new Ot);r(this,"layersByElement",new WeakMap);r(this,"layersByMesh",new WeakMap);r(this,"pixelsPerUnit",1e3);this.textureLoader.setTranscoderPath(U.DEFAULT_TRANSCODER_PATH)}static initialize(e){U.instance=new U,U.instance.renderer=e,U.instance.textureLoader.detectSupport(e)}getTexture(e,t){var n;let s=this.texturesByUrl.get(e);if(typeof s!="string")return s?(t&&((n=this.layersUsingTexture.get(s))==null||n.add(t)),s):(this.textureLoader.loadAsync(e).then(o=>{o.wrapS=Z,o.wrapT=Z,o.minFilter=xe,o.encoding=this.textureEncoding,this.layersUsingTexture.set(o,new Set),this.texturesByUrl.set(e,o)}).catch(()=>{this.texturesByUrl.set(e,"error")}),this.texturesByUrl.set(e,"pending"),s)}requestTexture(e,t){}disposeLayer(e){for(const t of e.textures){const s=this.layersUsingTexture.get(t);s.delete(e),s.size===0&&t.dispose()}}};let oe=U;r(oe,"DEFAULT_TRANSCODER_PATH",`https://unpkg.com/@loaders.gl/textures@${Bt}/dist/libs/`),r(oe,"instance");const Ze=new K,Je=new K,Fs=new F,ks=new F;class qs extends Y{constructor(e,t={}){super();r(this,"options");r(this,"rootLayer");r(this,"_interactionRays",[]);r(this,"_raycaster",new Lt);r(this,"_hitIntersections",[]);r(this,"_previousHoverLayers",new Set);r(this,"_contentMeshes",[]);r(this,"_prepareHitTest",e=>{e.desiredPseudoStates.hover&&this._previousHoverLayers.add(e),e.cursor.visible=!1,e.desiredPseudoStates.hover=!1,this._contentMeshes.push(e.contentMesh)});t.manager||(t.manager=oe.instance),this.options=t;const s=typeof e=="string"?ps(e):e;w.createLayerTree(s,t,(i,{target:n})=>{var o,l,c,u;if(i==="layercreated"){const h=n.layer||new ae(n,this);n===s?(h[fe]=()=>this._updateInteractions(),this.rootLayer=h,this.add(h)):(o=h.parentWebLayer)==null||o.add(h),(c=(l=this.options).onLayerCreate)==null||c.call(l,h)}else if(i==="layermoved"){const h=this.options.manager.layersByElement.get(n);(u=h.parentWebLayer)==null||u.add(h)}}),this.refresh(),this.update()}get manager(){return this.options.manager}get interactionRays(){return this._interactionRays}set interactionRays(e){this._interactionRays=e}async updateUntilReady(){const e=setInterval(()=>{this.update()},20);await this.rootLayer.refresh(!0),this.manager.ktx2Encoder.pool.dispose(),clearInterval(e)}update(){this.rootLayer.update(!0)}refresh(){this.rootLayer.refresh(!0)}querySelector(e){return this.rootLayer.querySelector(e)}get contentMesh(){return this.rootLayer.contentMesh}_intersectionSort(e,t){const s=e.object.parent,i=t.object.parent;return s.depth!==i.depth?i.depth-s.depth:i.index-s.index}_updateInteractions(){const e=this._previousHoverLayers;e.clear(),this._contentMeshes.length=0,this.rootLayer.traverseLayersPreOrder(this._prepareHitTest);for(const t of this._interactionRays){"isObject3D"in t&&t.isObject3D?this._raycaster.ray.set(t.getWorldPosition(Ze),t.getWorldDirection(Je).negate()):this._raycaster.ray.copy(t),this._hitIntersections.length=0;const s=this._raycaster.intersectObjects(this._contentMeshes,!1,this._hitIntersections);s.sort(this._intersectionSort);const i=s[0];if(i){const n=i.object.parent;n.cursor.position.copy(i.point),n.cursor.visible=!0,n.desiredPseudoStates.hover=!0,e.has(n)||n.setNeedsRefresh()}}for(const t of e)t.desiredPseudoStates.hover||t.setNeedsRefresh()}hitTest(e){const t=this._raycaster,s=this._hitIntersections,i=this.options.manager.layersByMesh;"isObject3D"in e&&e.isObject3D?this._raycaster.ray.set(e.getWorldPosition(Ze),e.getWorldDirection(Je).negate()):this._raycaster.ray.copy(e),s.length=0,t.intersectObject(this,!0,s),s.sort(this._intersectionSort);for(const n of s){const o=i.get(n.object);if(!o)continue;const l=ne(o.element,Fs);if(!l.width||!l.height)continue;let c=o.element;const u=n.uv.x*l.width,h=(1-n.uv.y)*l.height;return re(o.element,p=>{if(!c.contains(p))return!1;const d=ne(p,ks),m=d.left-l.left,f=d.top-l.top,{width:y,height:v}=d,S=m+y,T=f+v;return u>m&&u<S&&h>f&&h<T?(c=p,!0):!1}),{layer:o,intersection:n,target:c}}}}export{he as Q,ns as S,A as V,qs as W,It as a,ue as b,cs as c,oe as d,Ws as e,Ie as f};
