var pt=Object.defineProperty;var ft=(a,e,t)=>e in a?pt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var r=(a,e,t)=>(ft(a,typeof e!="symbol"?e+"":e,t),t);import{w as N,x as y,y as z,z as _,F as O,H as K,J as Ve,K as E,U as R,X as we,Y as gt,Z as yt,_ as wt,$ as _t,a0 as bt,a1 as vt,a2 as xt,a3 as St,a4 as Mt,a5 as Tt,a6 as Rt,a7 as Et,a8 as zt,a9 as Ct,aa as Bt,ab as Lt,ac as Ot,ad as Dt,ae as At,m as le,O as se,q as Te,M as Re,r as Ee,n as Nt,af as It,ag as je,ah as Pt,ai as V,aj as Ft,ak as Ut,al as kt,am as Vt,an as jt,ao as ze,ap as Ce,aq as Wt,ar as qt,as as Ht,at as Be,i as $t}from"./vendor.js";const Gt=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerpolicy&&(n.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?n.credentials="include":i.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}};Gt();const We=Object.freeze(new N(0,0)),Qt=Object.freeze(new N(1,1)),A=Object.freeze(new y(0,0,0)),Kt=Object.freeze(new y(1,0,0)),Xt=Object.freeze(new y(0,1,0)),Yt=Object.freeze(new y(0,0,1)),_e=Object.freeze(new y(1,1,1)),be=Object.freeze(new z),H={RIGHT:Object.freeze(new y(1,0,0)),UP:Object.freeze(new y(0,1,0)),NEAR:Object.freeze(new y(0,0,1)),LEFT:Object.freeze(new y(-1,0,0)),DOWN:Object.freeze(new y(0,-1,0)),FAR:Object.freeze(new y(0,0,-1))};function pe(a,e){return typeof a=="number"?Zt(a,e):"isVector3"in a?Jt(a,e):"isVector2"in a?es(a,e):"isBox3"in a?ts(a,e):"isQuaternion"in a?ss(a,e):"isColor"in a?is(a,e):1/0}function Zt(a,e){if(e===a)return 0;const t=Math.abs(e-a),s=(Math.abs(e)+Math.abs(a))/2;return t/s}function Jt(a,e){if(e.equals(a))return 0;const t=e.distanceTo(a),s=(e.length()+a.length())/2;return t/s}function es(a,e){if(e.equals(a))return 0;const t=e.distanceTo(a),s=(e.length()+a.length())/2;return t/s}function ts(a,e){if(a.equals(e))return 0;const t=qe,s=e.min.distanceTo(a.min),i=e.max.distanceTo(a.max),n=(s+i)/2,o=(e.getSize(t).length()+a.getSize(t).length())/2;return n/o}const qe=new y;function ss(a,e){return a.equals(e)?0:a.angleTo(e)/Math.PI}function is(a,e){return a.equals(e)?0:qe.set(Math.abs(e.r-a.r),Math.abs(e.g-a.g),Math.abs(e.b-a.b)).length()/rs}const rs=Math.sqrt(3),G=(a=1)=>{var e=Math.random();return(e%1e-8>5e-9?1:-1)*Math.sqrt(-Math.log(Math.max(1e-9,e)))*a},fe=(a=1)=>{const e=Math.sqrt(Math.sqrt(1/(2*a)));return 1/G(e)**2},ie=(()=>{const a=Math.PI*2,e=new y(0,0,1),t=new z,s=new z,i=new y,n=new z;return function(l=1,c=1){var u=(Math.random()-.5)*a*l,h=Math.random()*a,p=Math.random()*Math.PI*c;return i.set(1,0,0).applyAxisAngle(e,h),t.setFromAxisAngle(e,u),s.setFromAxisAngle(i,p),n.multiplyQuaternions(s,t)}})();function He(a,e){let t=0;for(let i=0;i<a.length;i++)t+=(e==null?void 0:e[i])||1;const s=Math.random()*t;t=0;for(let i=0;i<a.length;i++)if(t+=(e==null?void 0:e[i])||1,t>s)return a[i];return a[0]}const ns=(()=>{const a=new y;return function(t,s,i){const n=a.set(t.x,t.y,t.z),o=s.dot(n),l=a.copy(s).multiplyScalar(o),c=i.set(l.x,l.y,l.z,t.w).normalize();return o<0&&(c.x=-c.x,c.y=-c.y,c.z=-c.z,c.w=-c.w),c}})();class ue{constructor(){r(this,"callbacks",[])}memoize(e,...t){t.push(this);const s=as(e);for(const i of t)i.callbacks.push(s);return s}invalidateAll(){const e=this.callbacks;for(let t=0;t<this.callbacks.length;t++)e[t].needsUpdate=!0}isFullyInvalid(){const e=this.callbacks;for(let t=0;t<this.callbacks.length;t++)if(!e[t].needsUpdate)return!1;return!0}}const Le=void 0;function as(a){let e=Le;const t=()=>{if(t.needsUpdate&&(t.needsUpdate=!1,e=a()),e===Le)throw new Error("Possible recursive memoization detected");return e};return t.needsUpdate=!0,t}const re=Symbol("current"),ne=Symbol("target"),Oe=Symbol("previousTarget");class $e{constructor(e,t){this.mode=e,this.metrics=t}}const j=class extends $e{constructor(e,t){super(e,t);r(this,"_cache",new ue);r(this,"opacity",1);r(this,"_parent",null);r(this,"_localMatrix",new _);r(this,"_worldMatrix",new _);r(this,"_worldMatrixInverse",new _);r(this,"_worldPosition",new y);r(this,"_worldOrientation",new z);r(this,"_worldOrientationInverse",new z);r(this,"_worldScale",new y(1,1,1));r(this,"_worldRotation",new _);r(this,"_worldRotationInverse",new _);r(this,"_relativePosition",new y);r(this,"_relativeOrientation",new z);r(this,"_relativeScale",new y(1,1,1));r(this,"_cachedWorldCenter",this._cache.memoize(()=>this._worldCenter.copy(this.metrics.innerCenter).applyMatrix4(this.worldMatrix)));r(this,"_worldCenter",new y);r(this,"_cachedSpatialMatrix",this._cache.memoize(()=>{const e=this._worldFromSpatial.compose(this.outerOrigin,this.worldOrientation,_e);this._spatialFromWorld.copy(this._worldFromSpatial).invert(),this._localFromSpatial.multiplyMatrices(this.worldMatrixInverse,e),this._spatialFromLocal.copy(this._localFromSpatial).invert();const t=this.referenceState;return t?this._spatialFromReference.multiplyMatrices(this._spatialFromWorld,t.worldMatrix):this._spatialFromReference.copy(this._spatialFromWorld),e}));r(this,"_worldFromSpatial",new _);r(this,"_spatialFromWorld",new _);r(this,"_localFromSpatial",new _);r(this,"_spatialFromLocal",new _);r(this,"_spatialFromReference",new _);r(this,"_cachedSpatialBounds",this._cache.memoize(()=>{this._spatialBounds.copy(this.metrics.innerBounds);const e=this._spatialBounds.applyMatrix4(this.spatialFromLocal);return e.getCenter(this._spatialCenter),e.getSize(this._spatialSize),e}));r(this,"_spatialBounds",new O);r(this,"_spatialSize",new y);r(this,"_spatialCenter",new y);r(this,"_cachedOuterBounds",this._cache.memoize(()=>{const e=this._outerBounds,t=this.metrics.system.nodeAdapters.get(this.metrics.node);if(t)e.copy(t.outerBounds[this.mode]);else{const s=this.referenceState;s?e.copy(s.metrics.innerBounds):e.setFromCenterAndSize(A,A),e.applyMatrix4(this.spatialFromReference)}return e.getCenter(this._outerCenter),e.getSize(this._outerSize),e}));r(this,"_outerBounds",new O);r(this,"_outerCenter",new y);r(this,"_outerSize",new y);r(this,"_cachedOuterVisualBounds",this._cache.memoize(()=>{const e=this._outerVisualBounds,t=this.metrics.system.nodeAdapters.get(this.metrics.node);if(t)e.copy(t.outerVisualBounds[this.mode]);else{const s=this.referenceState;s?e.copy(s.visualBounds):e.setFromCenterAndSize(A,A)}return e.getCenter(this._outerVisualCenter),e.getSize(this._outerVisualSize),e}));r(this,"_outerVisualBounds",new O);r(this,"_outerVisualCenter",new y);r(this,"_outerVisualSize",new y);r(this,"_viewFromWorld",new _);r(this,"_viewFromSpatial",new _);r(this,"_spatialFromView",new _);r(this,"_cachedNDCBounds",this._cache.memoize(()=>{if(this.metrics.system.viewNode===this.metrics.node)return this._ndcBounds.min.setScalar(-1),this._ndcBounds.max.setScalar(1),this._ndcBounds;const t=this.metrics.system.viewFrustum.perspectiveProjectionMatrix,s=this.viewFromWorld,i=this._viewProjectionFromWorld.multiplyMatrices(t,s),n=this._ndcBounds.copy(this.metrics.innerBounds).applyMatrix4(i);return n.getCenter(this._ndcCenter),n.getSize(this._ndcSize),(!isFinite(n.min.x)||!isFinite(n.min.y)||!isFinite(n.min.z)||!isFinite(n.max.x)||!isFinite(n.max.y)||!isFinite(n.max.z))&&(n.min.setScalar(-1),n.max.setScalar(1),n.getCenter(this._ndcCenter),n.getSize(this._ndcSize)),n},this._viewState._cache));r(this,"_viewProjectionFromWorld",new _);r(this,"_ndcBounds",new O);r(this,"_ndcCenter",new y);r(this,"_ndcSize",new y);r(this,"_cachedVisualBounds",this._cache.memoize(()=>{const e=this.metrics.system,t=e.viewFrustum.perspectiveProjectionMatrix,s=this._inverseProjection.copy(t).invert(),i=this._visualBounds.copy(this.ndcBounds),n=this._v1,o=n.set(0,0,i.min.z).applyMatrix4(s).z,l=n.set(0,0,i.max.z).applyMatrix4(s).z;return i.min.z=l,i.max.z=o,i.min.x*=.5*e.viewResolution.x,i.max.x*=.5*e.viewResolution.x,i.min.y*=.5*e.viewResolution.y,i.max.y*=.5*e.viewResolution.y,i.getCenter(this._visualCenter),i.getSize(this._visualSize),i},this._viewState._cache));r(this,"_visualBounds",new O);r(this,"_visualCenter",new y);r(this,"_visualSize",new y);r(this,"_v1",new y);r(this,"_inverseProjection",new _);r(this,"_viewPosition",new y);r(this,"_cachedViewAlignedOrientation",this._cache.memoize(()=>{const e=this._relativeViewMatrix.multiplyMatrices(this.worldMatrixInverse,this._viewState.worldMatrix),t=this._relativeViewRotation.extractRotation(e),s=this._relativeViewOrientation.setFromRotationMatrix(t),i=this._relativeViewForward.set(0,0,1).applyQuaternion(s),n=this._relativeViewUp.set(0,1,0).applyQuaternion(s);let o=1/0,l=1/0,c,u,h;for(h in H){const m=H[h];var p=n.distanceToSquared(m);p<l&&(l=p,u=m)}for(h in H){const m=H[h];if(m.x&&u.x||m.y&&u.y||m.z&&u.z)continue;const f=i.distanceToSquared(m);f<o&&(o=f,c=m)}const d=this._orthogonalRotation.identity();return d.lookAt(c,A,u),this._orthogonalOrientation.setFromRotationMatrix(d)},this._viewState._cache));r(this,"_relativeViewMatrix",new _);r(this,"_relativeViewRotation",new _);r(this,"_relativeViewOrientation",new z);r(this,"_relativeViewUp",new y);r(this,"_relativeViewForward",new y);r(this,"_orthogonalRotation",new _);r(this,"_orthogonalOrientation",new z);r(this,"_computeOcclusion",this._cache.memoize(()=>{this._occludingPercent=0,this._occludedPercent=0;const e=this.metrics;if(e.innerBounds.isEmpty())return;const s=e.system.nodeAdapters.values(),i=this.visualBounds,n=i.min.z,o=j._boxA,l=j._boxB;o.min.set(i.min.x,i.min.y),o.min.set(i.max.x,i.max.y);const c=o.getSize(j._sizeA).length();for(const u of s){const h=u.metrics;if(h===e||!h.isAdaptive||h.innerBounds.isEmpty()||h.containedByNode(u.node))continue;const d=(this.mode==="current"?h.current:h.target).visualBounds;o.min.set(i.min.x,i.min.y),o.min.set(i.max.x,i.max.y),l.min.set(d.min.x,d.min.y),l.min.set(d.max.x,d.max.y);const m=o.intersect(l).getSize(j._sizeB).length()/c;m>0&&(n<d.min.z?this._occludingPercent+=m:this._occludedPercent+=m)}},this._viewState._cache));r(this,"_occludingPercent",0);r(this,"_occludedPercent",0)}invalidate(){this._cache.invalidateAll()}get parent(){return this._parent}set parent(e){this._parent!==e&&(this._parent=e,this.invalidate())}get parentState(){var e;return(e=this.metrics.parentMetrics)==null?void 0:e[this.mode]}get localMatrix(){var t;const e=(t=this.parentState)==null?void 0:t.worldMatrixInverse;return e?this._localMatrix.multiplyMatrices(e,this.worldMatrix):this._localMatrix.copy(this.worldMatrix)}get referenceState(){var e;return(e=this.metrics.referenceMetrics)==null?void 0:e[this.mode]}get worldMatrix(){return this._worldMatrix}set worldMatrix(e){if(isNaN(e.elements[0])||isNaN(e.elements[15])||e.elements[0]===0)throw new Error;this._worldMatrix.equals(e)||(this.invalidate(),this._worldMatrix.copy(e),this._worldMatrixInverse.copy(this._worldMatrix).invert(),this._worldMatrix.decompose(this._worldPosition,this._worldOrientation,this._worldScale),this._worldOrientationInverse.copy(this._worldOrientation).invert(),this._worldRotation.makeRotationFromQuaternion(this._worldOrientation),this._worldRotationInverse.makeRotationFromQuaternion(this._worldOrientationInverse))}get relativePosition(){var t;const e=(t=this.referenceState)==null?void 0:t.worldPosition;return e?this._relativePosition.subVectors(this.worldPosition,e):this._relativePosition.copy(this.worldPosition)}get relativeOrientation(){var t;const e=(t=this.referenceState)==null?void 0:t.worldOrientationInverse;return e?this._relativeOrientation.multiplyQuaternions(this.worldOrientation,e):this._relativeOrientation.copy(this.worldOrientation)}get relativeScale(){var t;const e=(t=this.referenceState)==null?void 0:t.worldScale;return e?this._relativeScale.copy(this.worldScale).divide(e):this._relativeScale.copy(this.worldScale)}get worldMatrixInverse(){return this._worldMatrixInverse}get worldPosition(){return this._worldPosition}get worldOrientation(){return this._worldOrientation}get worldScale(){return this._worldScale}get worldOrientationInverse(){return this._worldOrientationInverse}get worldRotation(){return this._worldRotation}get worldRotationInverse(){return this._worldRotationInverse}get worldCenter(){return this._cachedWorldCenter()}get spatialMatrix(){return this._cachedSpatialMatrix()}get spatialMatrixInverse(){return this.spatialMatrix,this._spatialFromWorld}get localFromSpatial(){return this.spatialMatrix,this._localFromSpatial}get spatialFromLocal(){return this.spatialMatrix,this._spatialFromLocal}get spatialFromReference(){return this.spatialMatrix,this._spatialFromReference}get spatialBounds(){return this._cachedSpatialBounds()}get spatialSize(){return this.spatialBounds,this._spatialSize}get spatialCenter(){return this.spatialBounds,this._spatialCenter}get outerBounds(){return this._cachedOuterBounds()}get outerCenter(){return this.outerBounds,this._outerCenter}get outerSize(){return this.outerBounds,this._outerSize}get outerOrigin(){return this.metrics.outerOrigin[this.mode]()}get outerOrientation(){var t,s;const e=this.metrics.system.nodeAdapters.get(this.metrics.node);return e?e.outerOrientation[this.mode]:(s=(t=this.referenceState)==null?void 0:t.worldOrientation)!=null?s:be}get outerVisualBounds(){return this._cachedOuterVisualBounds()}get outerVisualCenter(){return this.outerVisualBounds,this._outerVisualCenter}get outerVisualSize(){return this.outerVisualBounds,this._outerVisualSize}get _viewState(){if(this.metrics.system.viewNode===this.metrics.node)return this;const e=this.metrics.system.viewMetrics;return this.mode==="current"?e[re]:e[ne]}get viewFromWorld(){return this._viewFromWorld.multiplyMatrices(this._viewState.worldMatrixInverse,this.worldMatrix)}get viewFromSpatial(){return this._viewFromSpatial.multiplyMatrices(this._viewState.worldMatrixInverse,this.spatialMatrix)}get spatialFromView(){return this._spatialFromView.copy(this.viewFromSpatial).invert()}get ndcBounds(){return this._cachedNDCBounds()}get ndcCenter(){return this._cachedNDCBounds(),this._ndcCenter}get ndcSize(){return this._cachedNDCBounds(),this._ndcSize}get visualBounds(){return this._cachedVisualBounds()}get visualCenter(){return this._cachedVisualBounds(),this._visualCenter}get visualSize(){return this._cachedVisualBounds(),this._visualSize}get relativeViewPosition(){return this._viewPosition.copy(this._viewState.worldPosition).applyMatrix4(this.worldMatrixInverse)}get viewAlignedOrientation(){return this._cachedViewAlignedOrientation()}get occludingPercent(){return this._computeOcclusion(),this._occludingPercent}get occludedPercent(){return this._computeOcclusion(),this._occludedPercent}visualAverageEdgeLength(){}};let P=j;r(P,"_boxA",new K),r(P,"_boxB",new K),r(P,"_sizeA",new N),r(P,"_sizeB",new N);class os{constructor(e,t){this.system=e,this.node=t}}var ci,li,ui;class Ge extends os{constructor(e,t){super(e,t);r(this,"_cache",new ue);r(this,"needsUpdate",!0);r(this,"parentNode");r(this,"parentMetrics");r(this,"referenceMetrics");r(this,"_adapter");r(this,"_cachedInnerBounds",this._cache.memoize(()=>{const e=this._innerBounds;if(!this.raw.parent)return e.makeEmpty();if(this.node!==this.system.viewNode){e.copy(this.intrinsicBounds);const i=this._childBounds;for(const n of this.boundingChildMetrics)n.update(),i.copy(n.innerBounds),i.applyMatrix4(n.raw.relativeMatrix),e.union(i)}const t=e.getCenter(this._innerCenter),s=e.getSize(this._innerSize);if(s.length()>0){const i=this.system.epsillonMeters;Math.abs(s.x)<=i&&(s.x=(Math.sign(s.x)||1)*i*1e3),Math.abs(s.y)<=i&&(s.y=(Math.sign(s.y)||1)*i*1e3),Math.abs(s.z)<=i&&(s.z=(Math.sign(s.z)||1)*i*1e3,t.z-=i*1e3/2),e.setFromCenterAndSize(t,s)}return e}));r(this,"_childBounds",new O);r(this,"_innerBounds",new O);r(this,"_innerCenter",new y);r(this,"_innerSize",new y);r(this,"_intrinsicBoundsNeedsUpdate",!0);r(this,"_intrinsicBounds",new O);r(this,"_intrinsicCenter",new y);r(this,"_intrinsicSize",new y);r(this,"_cachedNodeChildren",this._cache.memoize(()=>(this.system.bindings.getChildren(this,this._nodeChildren),this._nodeChildren)));r(this,"_nodeChildren",new Array);r(this,"_computeState",(()=>{const e=new _,t=new z,s=new _,i=new y,n=new z,o=new y,l=new y,c=new y,u=new y,h=new y;return function(d){var b;d.parent=this.raw.parent;const m=this._adapter,f=(b=this.referenceMetrics)==null?void 0:b[d.mode];t.copy((m==null?void 0:m.orientation.enabled)&&(m==null?void 0:m.orientation[d.mode])||this.raw.relativeOrientation);const w=(m==null?void 0:m.bounds.enabled)&&(m==null?void 0:m.bounds[d.mode]);if(w){w.getCenter(l),w.getSize(c);const T=this.innerCenter,S=this.innerSize,M=this.system.epsillonMeters;Math.abs(c.x)<=M&&(c.x=(Math.sign(c.x)||1)*M*10),Math.abs(c.y)<=M&&(c.y=(Math.sign(c.y)||1)*M*10),Math.abs(c.z)<=M&&(c.z=(Math.sign(c.z)||1)*M*10),o.copy(c),Math.abs(S.x)>=M&&(o.x/=S.x),Math.abs(S.y)>=M&&(o.y/=S.y),Math.abs(S.z)>=M&&(o.z/=S.z),n.multiplyQuaternions(d.outerOrientation,t).normalize(),u.copy(l).applyQuaternion(n),h.copy(T).multiply(o).applyQuaternion(n),i.copy(d.outerOrigin).add(u).sub(h),s.compose(i,n,o),d.worldMatrix=s}else e.compose(this.raw.relativePosition,t,this.raw.relativeScale),d.worldMatrix=(f==null?void 0:f.worldMatrix)?s.multiplyMatrices(f==null?void 0:f.worldMatrix,e):e;const x=(m==null?void 0:m.opacity.enabled)&&(m==null?void 0:m.opacity[d.mode]);return d.opacity=typeof x=="number"?x:1,d}})());r(this,"raw",{parent:null,worldMatrix:new _,relativeMatrix:new _,opacity:0,worldPosition:new y,worldOrientation:new z,worldScale:new y,relativePosition:new y,relativeOrientation:new z,relativeScale:new y,spatialBounds:new O,worldFromSpatial:new _,localFromSpatial:new _,spatialFromLocal:new _});r(this,"outerOrigin",{current:()=>this._getOuterOrigin("current"),target:()=>this._getOuterOrigin("target")});r(this,"_cachedCurrentState",this._cache.memoize(()=>this._computeState(this[re])));r(this,ci,new P("current",this));r(this,"_cachedTargetState",this._cache.memoize(()=>this._computeState(this[ne])));r(this,li,new P("target",this));r(this,ui,new P("target",this));r(this,"_cachedBoundsChildren",this._cache.memoize(()=>{const e=this.nodeChildren,t=this._boundingChildren;t.length=0;for(const s of e){const i=this.system.getMetrics(s);i.isAdaptive||t.push(i)}return t}));r(this,"_boundingChildren",[])}update(){var e,t;if(this.needsUpdate){this.needsUpdate=!1;const s=this._adapter=this.system.nodeAdapters.get(this.node);this.parentNode=this.raw.parent,this.parentMetrics=this.parentNode&&this.system.getMetrics(this.parentNode);const i=((e=s==null?void 0:s.activeLayout)==null?void 0:e.referenceNode)||(s==null?void 0:s.referenceNode)||this.parentNode;this.referenceMetrics=i&&this.system.getMetrics(i),(t=this.referenceMetrics)==null||t.update(),s?s._update():(this.invalidateInnerBounds(),this.invalidateStates(),this.updateRawState())}}get innerBounds(){return this._cachedInnerBounds()}get innerCenter(){return this.innerBounds,this._innerCenter}get innerSize(){return this.innerBounds,this._innerSize}get intrinsicBounds(){return this._intrinsicBoundsNeedsUpdate&&(this._intrinsicBoundsNeedsUpdate=!1,this.system.bindings.getIntrinsicBounds(this,this._intrinsicBounds),this._intrinsicBounds.getCenter(this._intrinsicCenter),this._intrinsicBounds.getSize(this._intrinsicSize)),this._intrinsicBounds}get intrinsicCenter(){return this.intrinsicBounds,this._intrinsicCenter}get intrinsicSize(){return this.intrinsicBounds,this._intrinsicSize}invalidateIntrinsicBounds(){this._intrinsicBoundsNeedsUpdate=!0;for(const e of this.boundingChildMetrics)e.invalidateIntrinsicBounds()}invalidateInnerBounds(){if(!this._cachedInnerBounds.needsUpdate){this._cachedNodeChildren.needsUpdate=!0,this._cachedBoundsChildren.needsUpdate=!0,this._cachedInnerBounds.needsUpdate=!0;for(const e of this.boundingChildMetrics)e.invalidateInnerBounds()}}containsNode(e){this.update();let t=this.system.getMetrics(e);for(;t;){if(t.parentMetrics===this)return t.node;t=t.parentMetrics}return!1}containedByNode(e){this.update();let t=this.parentMetrics;for(;t;){if(t.node===e)return t.node;t=t.parentMetrics}return!1}get nodeChildren(){return this._cachedNodeChildren()}invalidateStates(){this._cachedCurrentState.needsUpdate=!0,this._cachedTargetState.needsUpdate=!0,this[re].invalidate(),this[ne].invalidate()}updateRawState(){this.system.bindings.getState(this);const e=this.raw;e.worldMatrix.decompose(e.worldPosition,e.worldOrientation,e.worldScale),e.relativeMatrix.decompose(e.relativePosition,e.relativeOrientation,e.relativeScale),e.worldFromSpatial.compose(this.outerOrigin.target(),e.worldOrientation,_e),e.localFromSpatial.copy(e.worldMatrix).invert().multiply(e.worldFromSpatial),e.spatialFromLocal.copy(e.localFromSpatial).invert(),e.spatialBounds.copy(this.innerBounds).applyMatrix4(e.spatialFromLocal)}_getOuterOrigin(e){var s,i,n;const t=this.system.nodeAdapters.get(this.node);return t?t.outerOrigin[e]:(n=(i=(s=this.referenceMetrics)==null?void 0:s[e])==null?void 0:i.worldCenter)!=null?n:A}get current(){return this.update(),this._cachedCurrentState()}get target(){return this.update(),this._cachedTargetState()}get previousTarget(){return this.update(),this[Oe]}get boundingChildMetrics(){return this._cachedBoundsChildren()}get isAdaptive(){return this.system.nodeAdapters.has(this.node)}}ci=re,li=ne,ui=Oe;class he{constructor(e){r(this,"relativeTolerance");r(this,"stepSizeMin");r(this,"stepSizeMax");r(this,"stepSizeStart");r(this,"minFeasibleTime");r(this,"maxInfeasibleTime");r(this,"maxIterationsPerFrame");r(this,"swarmSize");r(this,"pulseRate");r(this,"pulseFrequencyMin");r(this,"pulseFrequencyMax");e&&Object.assign(this,e)}}class Qe{constructor(e){r(this,"_config",new he);r(this,"_prevOrientation",new z);r(this,"_prevBounds",new O);r(this,"_scratchSolution",new D);r(this,"_scratchBestSolution",new D);this.system=e}_setConfig(e){var s,i,n,o,l,c,u,h,p,d;const t=this.system.optimize;this._config.minFeasibleTime=(s=e.minFeasibleTime)!=null?s:t.minFeasibleTime,this._config.maxInfeasibleTime=(i=e.maxInfeasibleTime)!=null?i:t.maxInfeasibleTime,this._config.pulseRate=(n=e.pulseRate)!=null?n:t.pulseRate,this._config.maxIterationsPerFrame=(o=e.maxIterationsPerFrame)!=null?o:t.maxIterationsPerFrame,this._config.swarmSize=(l=e.swarmSize)!=null?l:t.swarmSize,this._config.pulseFrequencyMin=(c=e.pulseFrequencyMin)!=null?c:t.pulseFrequencyMin,this._config.pulseFrequencyMax=(u=e.pulseFrequencyMax)!=null?u:t.pulseFrequencyMax,this._config.stepSizeMax=(h=e.stepSizeMax)!=null?h:t.stepSizeMax,this._config.stepSizeMin=(p=e.stepSizeMin)!=null?p:t.stepSizeMin,this._config.stepSizeStart=(d=e.stepSizeStart)!=null?d:t.stepSizeStart}update(e){if(e.layouts.length===0||e.metrics.innerBounds.isEmpty())return e.activeLayout=null,!1;const t=this._prevOrientation.copy(e.orientation.target),s=this._prevBounds.copy(e.bounds.target);for(const o of e.layouts)this._setConfig(o),this._updateLayout(e,o);let i,n;for(const o of e.layouts){const l=o.solutions[0];if((!n||!n.isFeasible&&l.isFeasible)&&(n=l,i=o,n.isFeasible))break}return e.layoutFeasibleTime+=e.system.deltaTime,e.layoutInfeasibleTime+=e.system.deltaTime,(n==null?void 0:n.isFeasible)||(e.layoutFeasibleTime=0),n&&n.isFeasible&&e.layoutFeasibleTime>=this._config.minFeasibleTime||e.layoutInfeasibleTime>=this._config.maxInfeasibleTime?(e.layoutInfeasibleTime=0,n.apply(!1)):(e.orientation.target=t,e.bounds.target=s,e.metrics.invalidateStates()),e.activeLayout=i,!0}_updateLayout(e,t){var h;e.measureBoundsCache.clear(),t.processObjectives();const s=t.solutions,i=this._config,n=this._scratchSolution,o=this._scratchBestSolution,l=1.5,c=1.5**(-1/4);let u=i.maxIterationsPerFrame;((h=t.solutions[0])==null?void 0:h.isFeasible)&&(u=1),this._manageSolutionPopulation(e,t,i.swarmSize,i.stepSizeStart),s[0].apply();for(let p=0;p<u;p++){t.iteration++,o.copy(s[0]);let d=!1;for(let m=0;m<s.length;m++){const f=s[m];n.copy(f),n.mutationStrategies=f.mutationStrategies;let w;if(Math.random()<i.pulseRate){const b=o!==f?o:s[1];let T;if(s.length>2)do T=s[Math.floor(Math.random()*s.length)];while(T===f);n.moveTowards(b,i.pulseFrequencyMin,i.pulseFrequencyMax),T&&t.compareSolutions(T,f)<=0&&n.moveTowards(T,i.pulseFrequencyMin,i.pulseFrequencyMax)}else w=n.perturb();n.apply();const x=t.compareSolutions(n,f)<0;if(x&&(f.copy(n),f!==s[0]&&t.compareSolutions(f,s[0])<0&&s[0].copy(f),d=!0),w)if(w.stepSize*=x?l:c,!x&&w.stepSize<i.stepSizeMin||w.stepSize>i.stepSizeMax){for(const b of f.mutationStrategies)b.stepSize=i.stepSizeStart;f!==s[0]&&(t.restartRate=.001+(1-.001)*t.restartRate,f.randomize(1),f.apply(),d=!0)}else f!==s[0]&&(t.restartRate=(1-.001)*t.restartRate)}d&&t.sortSolutions(),t.compareSolutions(o,s[0])<=0?t.successRate=(1-.005)*t.successRate:t.successRate=.005+(1-.005)*t.successRate}}_manageSolutionPopulation(e,t,s,i){if(s<=1)throw new Error("Swarm size must be larger than 1");if(t.solutions.length<s)for(;t.solutions.length<s;){const n=new D(t);for(const o of n.mutationStrategies)o.stepSize=i;n.randomize(1),t.solutions.push(n)}else if(t.solutions.length>s)for(;t.solutions.length>s;)t.solutions.pop()}}class k{constructor(e){r(this,"type","ratio");r(this,"sortBlame",0);r(this,"relativeTolerance");r(this,"absoluteTolerance");r(this,"computedAbsoluteTolerance",-1/0);r(this,"computedRelativeTolerance",-1/0);r(this,"priority",0);r(this,"index",-1);r(this,"layout");r(this,"reduceFromOneOrManySpec",(e,t,s)=>{if(t===void 0)return 0;if(t instanceof Array){let i=-1/0;for(const n of t)i=Math.max(s(e,n),i);return i}return s(e,t)});r(this,"_getNumberScoreSingle",(e,t)=>{let s=0;if(typeof t!="object"){const i=this.layout.adapter.system.measureNumber(t);s=-Math.abs(e-i)}else{const i="gt"in t?this.layout.adapter.system.measureNumber(t.gt):void 0,n="lt"in t?this.layout.adapter.system.measureNumber(t.lt):void 0;i!==void 0&&e<i?s=e-i:n!==void 0&&e>n&&(s=n-e)}return s});r(this,"_getVector3ScoreSingle",(e,t)=>{const s="x"in t&&typeof t.x!="undefined"?this.getNumberScore(e.x,t.x):0,i="y"in t&&typeof t.y!="undefined"?this.getNumberScore(e.y,t.y):0,n="z"in t&&typeof t.z!="undefined"?this.getNumberScore(e.z,t.z):0,o="magnitude"in t&&typeof t.magnitude!="undefined"?this.getNumberScore(e.length(),t.magnitude):0;return s+i+n+o});r(this,"_quat",new z);r(this,"_euler",new Ve);r(this,"_getQuaternionScoreSingle",(e,t)=>{var s,i;if(t===void 0)return 0;if("x"in t)return-this._quat.copy(t).angleTo(e)*E;if("swingRange"in t){const n=this._euler.setFromQuaternion(e),o=n.x*E,l=n.y*E,c=n.z*E,u=this.layout.adapter.system,h=u.mathScope.degree;let p=((s=t.swingRange)==null?void 0:s.x)?u.measureNumber(t.swingRange.x,h):0,d=((i=t.swingRange)==null?void 0:i.y)?u.measureNumber(t.swingRange.y,h):0;p=Math.max(p,.01),d=Math.max(d,.01);const m=t.twistRange?u.measureNumber(t.twistRange,h):0,f=1-(o/p)**2-(l/d)**2,w=m-Math.abs(c);return(f>0?0:f)+(w>0?0:w)}return 0});r(this,"_getBoundsMeasureScoreSingle",(e,t,s,i)=>{if(t===void 0)return 0;if(typeof t=="object"){if("gt"in t){const n=this.layout.adapter.measureBounds(t.gt,s,i);if(e<n)return e-n}if("lt"in t){const n=this.layout.adapter.measureBounds(t.lt,s,i);if(e>n)return n-e}return 0}return-Math.abs(e-this.layout.adapter.measureBounds(t,s,i))});this.layout=e}static isDiscreteSpec(e){const t=typeof e;return t==="string"||t==="number"}static isContinuousSpec(e){return e!==void 0&&!(e instanceof Array)&&typeof e=="object"&&("gt"in e||"lt"in e)}get bestScore(){return this.layout.solutions[0].scores[this.index]}getNumberScore(e,t){return this.reduceFromOneOrManySpec(e,t,this._getNumberScoreSingle)}getVector3Score(e,t){return this.reduceFromOneOrManySpec(e,t,this._getVector3ScoreSingle)}getQuaternionScore(e,t){return this.reduceFromOneOrManySpec(e,t,this._getQuaternionScoreSingle)}getBoundsScore(e,t){if(e===void 0)return 0;let s=0;for(const i in e){if(i==="absolute")continue;let n=i;if(n==="size"||n==="center"){const o=e[n];for(const l of us){let c=l;t!=="spatial"&&(this.type==="meter"&&c!=="z"||this.type==="pixel"&&c==="z")||(s+=this.getBoundsMeasureScore(o==null?void 0:o[c],t,n+c))}}else{if(t!=="spatial"&&(this.type==="meter"&&n!=="back"&&n!=="front"||this.type==="pixel"&&(n==="back"||n==="front")))continue;s+=this.getBoundsMeasureScore(e[n],t,n)}}return s}getBoundsMeasureScore(e,t,s){if(e===void 0)return 0;const i=this.layout.adapter.metrics.target;let n,o,l;switch(t){case"spatial":n=i.spatialBounds,o=i.spatialCenter,l=i.spatialSize;break;case"visual":case"view":n=i.visualBounds,o=i.visualCenter,l=i.visualSize;break;default:throw new Error(`Unknown measure type "${t}.${s}" in spec:
 "${e}"`)}let c=0;switch(s){case"left":c=n.min.x;break;case"right":c=n.max.x;break;case"bottom":c=n.min.y;break;case"top":c=n.max.y;break;case"back":c=n.min.z;break;case"front":c=n.max.z;break;case"centerx":c=o.x;break;case"centery":c=o.y;break;case"centerz":c=o.z;break;case"centerdistance":c=t==="spatial"?o.length():Math.sqrt(o.x**2+l.y**2);break;case"sizex":c=l.x;break;case"sizey":c=l.y;break;case"sizez":c=l.z;break;case"sizediagonal":c=t==="spatial"?l.length():Math.sqrt(l.x**2+l.y**2);break;default:throw new Error(`Unknown measure subtype ${t}.${s} in spec "${e}"`)}if(e instanceof Array){let u=-1/0;for(const h of e)u=Math.max(this._getBoundsMeasureScoreSingle(c,h,t,s),u);return u}return this._getBoundsMeasureScoreSingle(c,e,t,s)}attenuateVisualScore(e){let t=0;const s=this.layout.getComputedAbsoluteTolerance("pixel"),i=this.layout.adapter,n=i.system.viewResolution,o=i.system.viewFrustum,l=n.x,c=n.y,u=n.length(),h=i.metrics.target.visualBounds,p=h.min.x- -l/2+s,d=h.max.x-l/2-s,m=h.min.y- -c/2+s,f=h.max.y-c/2-s,w=h.max.z+o.nearMeters;return p<0&&(t+=Math.abs(p/l)),d>0&&(t+=Math.abs(d/l)),m<0&&(t+=Math.abs(m/c)),f>0&&(t+=Math.abs(f/c)),w>0&&(t+=w*10),e-Math.abs(u)*t}}class De extends k{constructor(e){super(e);r(this,"spec");this.type="degree"}evaluate(){const e=this.layout.adapter.metrics.target;return this.getQuaternionScore(e.relativeOrientation,this.spec)}}class cs extends k{constructor(e){super(e);r(this,"spec");this.type="ratio"}evaluate(){const e=this.layout.adapter.metrics.target;return this.getVector3Score(e.worldScale,this.spec)}}class ls extends k{constructor(e){super(e);r(this,"mode","xyz");r(this,"_scale",new y);this.type="ratio"}evaluate(){const e=this.layout.adapter.metrics.target,t=this.mode;if(!t)return 0;const s=this._scale.copy(e.worldScale),i=t==="xyz"?Math.max(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z)):Math.max(Math.abs(s.x),Math.abs(s.y)),n=s.divideScalar(i);return-(1/n.x)+1+-(1/n.y)+1+(t==="xyz"?-(1/n.z)+1:n.z>1?1-n.z:0)}}const us=["x","y","z","diagonal","distance"];class hs extends k{constructor(e){super(e);r(this,"spec");this.type="meter"}evaluate(){return this.getBoundsScore(this.spec,"spatial")}}class Ae extends k{constructor(e){super(e);r(this,"spec");r(this,"pixelTolerance");r(this,"meterTolerance");this.type="pixel"}evaluate(){var e;return this.type==="meter"&&(this.absoluteTolerance=this.meterTolerance),this.type==="pixel"&&(this.absoluteTolerance=this.pixelTolerance),this.getBoundsScore(this.spec,"visual")+this.getBoundsScore((e=this.spec)==null?void 0:e.absolute,"view")}}class ds extends k{constructor(e){super(e);r(this,"minAreaPercent",0);this.type="pixel"}evaluate(){var c;const e=this.layout.adapter.metrics.target,t=e.visualSize,s=this.layout.adapter.system.viewResolution,i=Math.min(t.x*t.y,s.x*s.y),n=((c=e.referenceState)==null?void 0:c.visualSize)||s,o=n.x*n.y;return this.attenuateVisualScore(i)-o*this.minAreaPercent}}class Ne extends k{constructor(e){super(e);this.type="meter",this.absoluteTolerance=1e10}evaluate(){return-this.layout.adapter.metrics.target.visualCenter.length()}}const Ie=new y;class Ke extends he{constructor(e){super();r(this,"absoluteTolerance",{meter:"10mm",pixel:"4px",degree:"0.002deg",ratio:.002});r(this,"successRate",0);r(this,"restartRate",0);r(this,"objectives",new Array);r(this,"referenceNode",null);r(this,"maximizeObjective");r(this,"orientationConstraint");r(this,"keepAspectConstraint");r(this,"scaleConstraint");r(this,"boundsConstraint");r(this,"visualBoundsMeterConstraint");r(this,"visualBoundsPixelConstraint");r(this,"magnetizeObjective");r(this,"minimizeOcclusionObjective");r(this,"solutions",new Array);r(this,"iteration",0);r(this,"bestSolution");r(this,"compareSolutions",(e,t)=>{const s=this.objectives;if(e.scores.length<s.length)return 1;if(t.scores.length<s.length)return-1;if(e.boundsCenterDistance>1e20)return 1;if(t.boundsCenterDistance>1e10)return-1;if(e.boundsManhattanLength>1e20)return 1;if(t.boundsManhattanLength>1e10)return-1;const i=e.isFeasible,n=t.isFeasible;if(i&&!n)return-1;if(n&&!i)return 1;let o=0;const l=this.solutions[0].scores;for(let c=0;c<s.length;c++){const u=e.scores[c],h=t.scores[c];if(isNaN(u))return 1;if(isNaN(h))return-1;const p=s[c],d=p.computedRelativeTolerance,m=p.computedAbsoluteTolerance,f=Math.max(l[c],u,h),w=Math.min(f-Math.abs(f)*d,-m);if(u<w||h<w)return p.sortBlame++,h-u;h-u!==0&&(o=h-u)}return o});this.adapter=e}getComputedAbsoluteTolerance(e){return this.adapter.system.measureNumber(this.absoluteTolerance[e],e)}poseRelativeTo(e){return this.referenceNode=e,this}maximize(e){var s;const t=this.maximizeObjective=(s=this.maximizeObjective)!=null?s:new ds(this);return t.priority=-1e3,t.relativeTolerance=.1,this.addObjective(t,e)}orientation(e,t){var i;const s=this.orientationConstraint=(i=this.orientationConstraint)!=null?i:new De(this);return s.spec=e,s.priority=-999,this.addObjective(s,t)}keepAspect(e="xyz",t){var i;const s=this.keepAspectConstraint=(i=this.keepAspectConstraint)!=null?i:new ls(this);return s.mode=e,s.priority=-998,this.addObjective(s,t)}scale(e,t){var i;const s=this.scaleConstraint=(i=this.scaleConstraint)!=null?i:new cs(this);return s.spec=e,s.priority=-2,this.addObjective(s,t)}bounds(e,t){var i;const s=this.boundsConstraint=(i=this.boundsConstraint)!=null?i:new hs(this);return s.spec=e,this.addObjective(s,t)}visualOrientation(e,t){var i;const s=this.orientationConstraint=(i=this.orientationConstraint)!=null?i:new De(this);return s.spec=e,s.priority=-999,this.addObjective(s,t)}visualBounds(e,t){var n,o;const s=this.visualBoundsMeterConstraint=(n=this.visualBoundsMeterConstraint)!=null?n:new Ae(this),i=this.visualBoundsPixelConstraint=(o=this.visualBoundsPixelConstraint)!=null?o:new Ae(this);return s.spec=e,s.type="meter",i.spec=e,i.type="pixel",this.addObjective(s,t).addObjective(i,t)}magnetize(e){var s;const t=this.magnetizeObjective=(s=this.magnetizeObjective)!=null?s:new Ne(this);return t.priority=-900,t.relativeTolerance=.95,this.addObjective(t,e)}avoidOcclusion(e){var s;const t=this.minimizeOcclusionObjective=(s=this.minimizeOcclusionObjective)!=null?s:new Ne(this);return t.priority=11,this.addObjective(t,e)}addObjective(e,t){return Object.assign(e,t),this.objectives.indexOf(e)===-1&&this.objectives.push(e),this.processObjectives(),this}get hasValidSolution(){var e;return((e=this.solutions[0])==null?void 0:e.isFeasible)===!0}processObjectives(){var i,n;const e=this.adapter.system,t=this.objectives;let s=0;for(const o of t)o.index=s++,o.computedAbsoluteTolerance=o.absoluteTolerance!==void 0?e.measureNumber(o.absoluteTolerance,e.mathScope[o.type]):this.getComputedAbsoluteTolerance(o.type),o.computedRelativeTolerance=(n=(i=o.relativeTolerance)!=null?i:this.relativeTolerance)!=null?n:this.adapter.system.optimize.relativeTolerance}sortSolutions(){this.solutions.sort(this.compareSolutions),this.bestSolution=this.solutions[0]}}const B=class{constructor(e){r(this,"layout");r(this,"orientation",new z);r(this,"bounds",new O);r(this,"scores",[]);r(this,"isFeasible",!1);r(this,"mutationStrategies",[{type:"rotate",stepSize:.1},{type:"center",stepSize:.1},{type:"size",stepSize:.1},{type:"minmax",stepSize:.1}]);r(this,"_mutationWeights",[]);r(this,"boundsManhattanLength");r(this,"boundsCenterDistance");e&&(this.layout=e)}get aspectPenalty(){return this.scores[this.layout.objectives.indexOf(this.layout.keepAspectConstraint)]||0}get orientationPenalty(){return this.scores[this.layout.objectives.indexOf(this.layout.orientationConstraint)]||0}get spatialBoundsPenalty(){return this.scores[this.layout.objectives.indexOf(this.layout.boundsConstraint)]||0}_selectStrategy(){const e=this.mutationStrategies,t=this._mutationWeights,s=this.layout.orientationConstraint,i=this.layout.keepAspectConstraint;for(let n=0;n<e.length;n++)t[n]=e[n].stepSize,s&&e[n].type=="rotate"&&this.orientationPenalty>-s.computedAbsoluteTolerance&&(t[n]*=.01),i&&e[n].type=="size"&&this.aspectPenalty<-i.computedAbsoluteTolerance&&(t[n]*=100);return He(e,t)}copy(e){this.layout=e.layout,this.orientation.copy(e.orientation),this.bounds.copy(e.bounds),this.scores.length=0;for(let t=0;t<e.scores.length;t++)this.scores[t]=e.scores[t];return this.isFeasible=e.isFeasible,this}randomize(e){const t=fe(e),s=B._scratchV1.set(0,0,-t),i=this.layout.adapter.system.viewMetrics.target;s.applyMatrix4(i.worldMatrix);const n=this.layout.adapter.metrics.target.parentState;n&&s.applyMatrix4(n.worldMatrixInverse),this.orientation.copy(i.worldOrientation),n&&this.orientation.multiply(n.worldOrientationInverse);const o=this.layout.adapter.metrics.innerBounds,l=o.isEmpty()?B._scratchV2.set(1,1,1):o.getSize(B._scratchV2);return l.normalize(),l.multiplyScalar(t*2*Math.tan(5*R)),this.bounds.setFromCenterAndSize(s,l),this}moveTowards(e,t,s){const i=this.bounds.getCenter(B._center),n=this.bounds.getSize(B._size),o=e.bounds,l=o.getCenter(B._otherCenter),c=o.getSize(B._otherSize);this.orientation.slerp(e.orientation,B.generatePulseFrequency(t,s)).normalize(),Math.random()<.5?(i.lerp(l,B.generatePulseFrequency(t,s)),n.lerp(c,B.generatePulseFrequency(t,s)),this.bounds.setFromCenterAndSize(i,n)):(this.bounds.min.lerp(o.min,B.generatePulseFrequency(t,s)),this.bounds.max.lerp(o.max,B.generatePulseFrequency(t,s)))}perturb(){var u;const e=this._selectStrategy(),t=e.type;let s=e.stepSize;if(t==="rotate"||Math.random()<.001){const h=(u=this.layout.orientationConstraint)==null?void 0:u.spec;if((h==null?void 0:h.isQuaternion)&&this.orientationPenalty<h.computedAbsoluteTolerance&&Math.random()<.01)this.orientation.copy(h);else{const p=Math.min(fe(Math.min(s,1)*1e-4),1);this.orientation.multiply(ie(p,p)).normalize()}}const i=this.bounds,n=i.getCenter(B._center),o=i.getSize(B._size);if(t==="center"){const h=B._direction.set(0,0,1).applyQuaternion(ie(1,1));h.setLength(G(s)).multiplyScalar(o.length()),n.add(h)}if(t==="size"){const h=2**G(s);o.multiplyScalar(h)}if(o.clampScalar(this.layout.adapter.system.epsillonMeters/10,1e20),i.setFromCenterAndSize(n,o),t==="minmax"){const h=B._direction.set(0,0,1).applyQuaternion(ie(1,1));h.setLength(G(s)).multiply(o),Math.random()<.5,i.min.add(h)}const l=i.min,c=i.max;return l.x>c.x&&this._swap(l,c,"x"),l.y>c.y&&this._swap(l,c,"y"),l.z>c.z&&this._swap(l,c,"z"),e}_swap(e,t,s){const i=e[s],n=t[s];e[s]=n,t[s]=i}static generatePulseFrequency(e,t){return e+Math.random()*(t-e)}apply(e=!0){const t=this.layout,s=t.adapter;if(s.orientation.target=this.orientation,s.bounds.target=this.bounds,s.metrics.invalidateStates(),e){this.isFeasible=!0;for(let i=0;i<t.objectives.length;i++){const n=t.objectives[i],o=this.scores[i]=n.evaluate();(o<-n.computedAbsoluteTolerance||!isFinite(o))&&(this.isFeasible=!1)}}this.boundsManhattanLength=this.bounds.getSize(Ie).manhattanLength(),this.boundsCenterDistance=this.bounds.getCenter(Ie).length()}};let D=B;r(D,"_scratchV1",new y),r(D,"_scratchV2",new y),r(D,"_direction",new y),r(D,"_center",new y),r(D,"_size",new y),r(D,"_otherCenter",new y),r(D,"_otherSize",new y);const Xe=gt;class Ye{constructor(e){r(this,"target");r(this,"duration");r(this,"easing");r(this,"blend");r(this,"elapsed");e&&Object.assign(this,e)}}class X{constructor(e){r(this,"multiplier");r(this,"duration");r(this,"easing");r(this,"threshold");r(this,"delay");r(this,"debounce");r(this,"maxWait");r(this,"blend");e&&Object.assign(this,e)}}const ms=new N,ps=new y,fs=new z,Pe=new O,gs=new we,ys=new we(0,0,0);class I extends X{constructor(e,t,s,i=e.transition){super(s);r(this,"needsUpdate",!1);r(this,"_size",new y);r(this,"_start");r(this,"_current");r(this,"_reference");r(this,"_target");r(this,"queue",[]);r(this,"enabled",!1);r(this,"forceWait",!1);r(this,"_forceCommit",!1);r(this,"_resolvedConfig",new X);r(this,"delayTime",0);r(this,"debounceTime",0);r(this,"_previousStatus","unchanged");r(this,"_status","unchanged");r(this,"_previousTarget");r(this,"_syncGroup");this.system=e,this.parentConfig=i,this.reset(t),this._previousTarget=this._copy(this._previousTarget,this.target)}_copy(e,t){if(typeof t=="undefined")return;if(typeof t=="number")return t;const s=e?e.copy(t):t.clone();if(s&&"isBox3"in s){const i=s,n=i.getSize(this._size);(i.isEmpty()||!isFinite(n.x)||!isFinite(n.y)||!isFinite(n.z))&&i.setFromCenterAndSize(A,A)}return s}_isEqual(e,t){return e===void 0||t===void 0?!1:e===t?!0:typeof e=="number"?e===t:(e==null?void 0:e.equals(t))||!1}reset(e){this._start=this._copy(this._start,e),this._current=this._copy(this._current,e),this._target=this._copy(this._target,e),this.queue.length=0}set start(e){this._start=this._copy(this._start,e)}get start(){return this._start}set current(e){this._current=this._copy(this._current,e)}get current(){return this._current}set reference(e){this._reference=this._copy(this._reference,e)}get reference(){return this._reference}set target(e){this.enabled=!0,this._target=this._copy(this._target,e)}get target(){return this._target}get progress(){if(!this.enabled)return 1;if(this.queue.length>0){const e=this.queue[this.queue.length-1];return e.duration===0?0:e.elapsed/e.duration}return 1}get forceCommit(){return this._forceCommit}set forceCommit(e){this._forceCommit!==e&&(this._forceCommit=e)}get relativeDifference(){var t,s;const e=(s=(t=this.queue[this.queue.length-1])==null?void 0:t.target)!=null?s:this.start;return typeof this.target!="undefined"?pe(e,this.target):0}get referenceRelativeDifference(){return typeof this.reference!="undefined"&&typeof this.target!="undefined"?pe(this.reference,this.target):1/0}get resolvedConfig(){var i,n,o,l,c,u,h,p,d,m,f,w,x,b,T,S;const e=this._resolvedConfig,t=this.parentConfig,s=this.system.transition;return e.multiplier=(n=(i=this.multiplier)!=null?i:t==null?void 0:t.multiplier)!=null?n:s.multiplier,e.duration=(l=(o=this.duration)!=null?o:t==null?void 0:t.duration)!=null?l:s.duration,e.easing=(u=(c=this.easing)!=null?c:t==null?void 0:t.easing)!=null?u:s.easing,e.threshold=(p=(h=this.threshold)!=null?h:t==null?void 0:t.threshold)!=null?p:s.threshold,e.delay=(m=(d=this.delay)!=null?d:t==null?void 0:t.delay)!=null?m:s.delay,e.debounce=(w=(f=this.debounce)!=null?f:t==null?void 0:t.debounce)!=null?w:s.debounce,e.maxWait=(b=(x=this.maxWait)!=null?x:t==null?void 0:t.maxWait)!=null?b:s.maxWait,e.blend=(S=(T=this.blend)!=null?T:t==null?void 0:t.blend)!=null?S:s.blend,e}get previousStatus(){return this._previousStatus}get status(){return this.needsUpdate&&(this._previousStatus=this._status,this._status=this._computeStatus()),this._status}_computeStatus(){if(this.forceCommit)return"committing";const e=this.resolvedConfig,t=e.threshold,s=this.system.deltaTime*e.multiplier,i=this.delayTime+s,n=this.debounceTime+s;return this.relativeDifference>t?!this.forceWait&&(i>=e.delay&&n>=e.debounce||i>=e.maxWait)?"committing":this.referenceRelativeDifference<t?"settling":"changed":"unchanged"}_updateTransitionable(){var l,c,u,h,p;const e=this.system.deltaTime,t=this.resolvedConfig,s=this.queue,i=this.status,n=e*t.multiplier;for(;s.length&&s[0].elapsed>=s[0].duration;)this.start=s.shift().target;this.current=this.start;let o=this.start;for(let d=0;d<s.length;d++){const m=s[d];if(this._addTransitionToCurrent(o,m,n),o=m.target,!m.blend)break}switch(this.debounceTime+=n,i){case"settling":break;case"changed":this.delayTime+=n,this.reference=this.target;break;case"unchanged":this.reference=void 0,this.delayTime=0;break;case"committing":this.delayTime=0,this.debounceTime=0;const d=typeof this.forceCommit=="object"?this.forceCommit:new Ye;d.target=(l=d.target)!=null?l:this._copy(void 0,this.target),d.duration=(c=d.duration)!=null?c:t.duration,d.easing=(u=d.easing)!=null?u:t.easing,d.blend=(h=d.blend)!=null?h:t.blend,d.elapsed=(p=d.elapsed)!=null?p:0,s.push(d),this.forceCommit=!1;break}this.forceWait=!1}_addTransitionToCurrent(e,t,s){const i=this._current,n=t.duration>0?t.easing(Math.min(t.elapsed/t.duration,1)):1,o=t.target;if(t.elapsed+=s,typeof o=="number"){this._current=i+yt(o-e,0,1-n);return}if("isVector3"in o){const l=i,c=e,u=o,h=ps.copy(u).sub(c).lerp(A,1-n);this._current=l.add(h);return}if("isVector2"in o){const l=i,c=e,u=o,h=ms.copy(u).sub(c).lerp(We,1-n);this._current=l.add(h);return}if("isQuaternion"in o){const l=i,c=e,u=o,h=fs.copy(c).invert().multiply(u).slerp(be,1-n);this._current=l.multiply(h).normalize();return}if("isColor"in o){const l=i,c=e,u=o,h=gs.copy(u).sub(c).lerp(ys,1-n);this._current=l.add(h);return}if("isBox3"in o){const l=i,c=e,u=o,h=Pe.min.copy(u.min).sub(c.min).lerp(A,1-n),p=Pe.max.copy(u.max).sub(c.max).lerp(A,1-n);l.min.add(h),l.max.add(p),this._current=l;return}}_swap(e,t,s){const i=e[s],n=t[s];e[s]=n,t[s]=i}update(e=!1){if(!this.needsUpdate&&!e||(this._isEqual(this._previousTarget,this.target)||(this._target=this._target,this.enabled=!0),this._previousTarget=this._copy(this._previousTarget,this.target),!this.enabled))return;const t=this.syncGroup;if(!this.forceCommit&&t){for(const s of t)if(s.enabled&&s.status==="committing"){for(const i of t)i.needsUpdate&&i.forceCommit===!1&&i.relativeDifference>i.resolvedConfig.threshold&&(i.forceCommit=!0);break}}this._updateTransitionable(),this.needsUpdate=!1}set syncGroup(e){this._syncGroup&&this._syncGroup.delete(this),this._syncGroup=e,e==null||e.add(this)}get syncGroup(){return this._syncGroup}}class Ze{constructor(e,t){r(this,"measureBoundsCache",new Map);r(this,"metrics");r(this,"transition",new X);r(this,"referenceNode");r(this,"_outerOrigin");r(this,"_outerOrientation");r(this,"_outerBounds");r(this,"_outerVisualBounds");r(this,"_parentAdapter",null);r(this,"_orientation");r(this,"_bounds");r(this,"_opacity");r(this,"layouts",new Array);r(this,"layoutFeasibleTime",0);r(this,"layoutInfeasibleTime",0);r(this,"_prevLayout",null);r(this,"_activeLayout",null);r(this,"_progress",1);r(this,"_hasValidContext",!1);r(this,"onUpdate");r(this,"onPostUpdate");r(this,"_prevNodeOrientation",new z);r(this,"_prevNodeBounds",new O);this.system=e,this.node=t,this.metrics=this.system.getMetrics(this.node);const s=this.metrics.target;this._orientation=new I(this.system,s.relativeOrientation,void 0,this.transition),this._bounds=new I(this.system,s.spatialBounds,void 0,this.transition),this._opacity=new I(this.system,s.opacity,void 0,this.transition),this._outerOrigin=new I(this.system,s.outerCenter,void 0,this.transition),this._outerOrientation=new I(this.system,s.outerOrientation,void 0,this.transition),this._outerBounds=new I(this.system,s.outerBounds,void 0,this.transition),this._outerVisualBounds=new I(this.system,s.outerVisualBounds,void 0,this.transition),this._outerOrigin.debounce=0,this._outerOrigin.delay=0,this._outerOrientation.debounce=0,this._outerOrientation.delay=0,this._outerBounds.debounce=0,this._outerBounds.delay=0,this._outerVisualBounds.debounce=0,this._outerVisualBounds.delay=0,this._orientation.syncGroup=this._bounds.syncGroup=this._opacity.syncGroup=new Set}measureBounds(e,t,s){var b,T,S;const i=this.system,n=i.mathScope,o=i.math,l=t==="spatial"||s==="front"||s==="back"||s==="centerz"||s==="sizez"?n.meter:n.pixel,c=l===n.meter?"m":"px";typeof e=="number"&&(e=""+e+c);const u=t+"-"+s+" = "+e;if((b=this.measureBoundsCache)==null?void 0:b.has(u))return this.measureBoundsCache.get(u);if(!i.mathCompiledExpressions.has(e)){const C=o.parse(e.replace("%","percent")).compile();i.mathCompiledExpressions.set(e,C)}const h=i.mathCompiledExpressions.get(e),p=i.viewMetrics.target,d=this.metrics.target;let m,f;switch(t){case"spatial":m=d.outerBounds,f=d.outerCenter;break;case"visual":m=d.outerVisualBounds,f=d.outerVisualCenter;break;case"view":m=p.visualBounds,f=p.visualCenter;break;default:throw new Error(`Unknown measure type "${t}.${s}"`)}if(e.includes("%")){const M=t==="spatial"?d.outerSize:(T=d.outerVisualSize)!=null?T:p.visualSize;let C=0;switch(s){case"left":case"centerx":case"right":case"sizex":C=o.unit(M.x/100,c);break;case"bottom":case"centery":case"top":case"sizey":C=o.unit(M.y/100,c);break;case"back":case"centerz":case"front":case"sizez":C=o.unit(M.z/100,"m");break;case"sizediagonal":C=t==="spatial"?o.unit(M.length()/100,"m"):o.unit(Math.sqrt(M.x**2+M.y**2)/100,"px");break;default:throw new Error(`Invalid measure subtype "${t}.${s}" for percentage units`)}n.percent=C}let w;switch(s){case"left":w=m.min.x;break;case"centerx":w=f.x;break;case"right":w=m.max.x;break;case"bottom":w=m.min.y;break;case"centery":w=f.y;break;case"top":w=m.max.y;break;case"front":w=m.max.z;break;case"centerz":w=f.z;break;case"back":w=m.min.z;break;case"centerdistance":default:w=0}let x=h.evaluate(n);return typeof x=="object"&&(x=o.number(x,l)),w+=x,n.percent=void 0,(S=this.measureBoundsCache)==null||S.set(u,w),w}get outerOrigin(){return this._outerOrigin}get outerOrientation(){return this._outerOrientation}get outerBounds(){return this._outerBounds}get outerVisualBounds(){return this._outerVisualBounds}get parentAdapter(){return this._parentAdapter}_computeParentAdapter(){let e=this.metrics;for(;e=e.parentMetrics;){const t=this.system.nodeAdapters.get(e.node);if(t)return t}return null}get orientation(){return this._orientation}get bounds(){return this._bounds}get opacity(){return this._opacity}get previousLayout(){return this._prevLayout}set activeLayout(e){this._prevLayout=this._activeLayout,this._activeLayout=e}get activeLayout(){return this._activeLayout}get progress(){return this._progress}_computeProgress(){return Math.min(this.orientation.progress,this.bounds.progress,this.opacity.progress)}createLayout(){const e=new Ke(this);return this.layouts.push(e),e}get hasValidContext(){return this._hasValidContext}_computeHasValidContext(){var t;const e=this.parentAdapter;return e?e.hasValidContext?!!(e.layouts.length===0||((t=e.activeLayout)==null?void 0:t.hasValidSolution)):!1:!0}_update(){var t;this._parentAdapter=this._computeParentAdapter(),this._hasValidContext=this._computeHasValidContext();const e=this.metrics;if(e.referenceMetrics&&(this.outerOrigin.target=e.referenceMetrics.target.worldCenter,this.outerOrientation.target=e.referenceMetrics.target.worldOrientation,this.outerBounds.target=e.referenceMetrics.innerBounds,this.outerBounds.target.applyMatrix4(e.target.spatialFromReference),this.outerVisualBounds.target=e.referenceMetrics.target.visualBounds),this.outerOrigin.update(),this.outerOrientation.update(),this.outerBounds.update(),this.outerVisualBounds.update(),this.onUpdate){this.onUpdate(),e.invalidateIntrinsicBounds(),e.invalidateInnerBounds(),e.invalidateStates(),e.updateRawState();const s=e.raw;if(!this.system.optimizer.update(this)){const i=this.orientation.current,n=this.orientation.target,o=s.relativeOrientation;n.angleTo(o)>this.system.epsillonRadians&&i.angleTo(o)>this.system.epsillonRadians&&(this.orientation.target=o);const l=this.bounds.current,c=this.bounds.target,u=s.spatialBounds;(c.min.distanceTo(u.min)>this.system.epsillonMeters||c.max.distanceTo(u.max)>this.system.epsillonMeters)&&(l.min.distanceTo(u.min)>this.system.epsillonMeters||l.max.distanceTo(u.max)>this.system.epsillonMeters)&&(this.bounds.target=u)}}else e.invalidateIntrinsicBounds(),e.invalidateInnerBounds(),e.invalidateStates(),this.system.optimizer.update(this);this.opacity.update(),this.orientation.update(),this.bounds.update(),this._progress=this._computeProgress(),e.invalidateStates(),this.system.bindings.apply(e,e.current),e.invalidateStates(),(t=this.onPostUpdate)==null||t.call(this)}}class Je{constructor(){r(this,"_cache",new ue);r(this,"isLayoutFrustum",!0);r(this,"_leftDegrees",-20);r(this,"_rightDegrees",20);r(this,"_bottomDegrees",-20);r(this,"_topDegrees",20);r(this,"_nearMeters",.5);r(this,"_farMeters",1e3);r(this,"_size",new N);r(this,"_center",new N);r(this,"_v1",new y);r(this,"_inverseProjection",new _);r(this,"_forwardDirection",new y(0,0,-1));r(this,"_fullNDC",new O(new y(-1,-1,-1),new y(1,1,1)));r(this,"_cachedPerspectiveProjectionMatrix",this._cache.memoize(()=>{const e=this.nearMeters,t=this.farMeters,s=e*Math.tan(this.leftDegrees*R),i=e*Math.tan(this.rightDegrees*R),n=e*Math.tan(this.topDegrees*R),o=e*Math.tan(this.bottomDegrees*R);return this._perspective.makePerspective(s,i,n,o,e,t)}));r(this,"_perspective",new _);r(this,"_boxA",new K);r(this,"_boxB",new K);r(this,"_overlapSize",new N)}get leftDegrees(){return this._leftDegrees}set leftDegrees(e){e!==this._leftDegrees&&(this._leftDegrees=e,this._cache.invalidateAll())}get rightDegrees(){return this._rightDegrees}set rightDegrees(e){e!==this._rightDegrees&&(this._rightDegrees=e,this._cache.invalidateAll())}get bottomDegrees(){return this._bottomDegrees}set bottomDegrees(e){e!==this._bottomDegrees&&(this._bottomDegrees=e,this._cache.invalidateAll())}get topDegrees(){return this._topDegrees}set topDegrees(e){e!==this._topDegrees&&(this._topDegrees=e,this._cache.invalidateAll())}get nearMeters(){return this._nearMeters}set nearMeters(e){e!==this._nearMeters&&(this._nearMeters=e,this._cache.invalidateAll())}get farMeters(){return this._farMeters}set farMeters(e){e!==this._farMeters&&(this._farMeters=e,this._cache.invalidateAll())}get sizeDegrees(){return this._size.set(this.rightDegrees-this.leftDegrees,this.topDegrees-this.bottomDegrees),this._size}get diagonalDegrees(){const e=this.sizeDegrees;return Math.acos(Math.cos(e.x*R)*Math.cos(e.y*R))*E}get centerDegrees(){const e=this.sizeDegrees;return this._center.set(this.leftDegrees+e.x/2,this.bottomDegrees+e.y/2)}get angleToCenter(){const e=this.centerDegrees;return Math.acos(Math.cos(e.x*R)*Math.cos(e.y*R))*E}get angleToTopLeft(){return Math.acos(Math.cos(this.leftDegrees*R)*Math.cos(this.topDegrees*R))*E}get angleToTopRight(){return Math.acos(Math.cos(this.rightDegrees*R)*Math.cos(this.topDegrees*R))*E}get angleToBottomLeft(){return Math.acos(Math.cos(this.leftDegrees*R)*Math.cos(this.bottomDegrees*R))*E}get angleToBottomRight(){return Math.acos(Math.cos(this.rightDegrees*R)*Math.cos(this.bottomDegrees*R))*E}get angleToClosestPoint(){const e=Math.min(Math.max(0,this.leftDegrees),this.rightDegrees),t=Math.min(Math.max(0,this.bottomDegrees),this.topDegrees);return Math.acos(Math.cos(e*R)*Math.cos(t*R))*E}get angleToFarthestPoint(){return Math.max(this.angleToTopLeft,this.angleToTopRight,this.angleToBottomLeft,this.angleToBottomRight)}get depth(){return this.farMeters-this.nearMeters}get distance(){return this.nearMeters+this.depth/2}get aspectRatio(){const e=this.nearMeters,t=e*Math.tan(this.leftDegrees*R),s=e*Math.tan(this.rightDegrees*R),i=e*Math.tan(this.topDegrees*R),n=e*Math.tan(this.bottomDegrees*R);return(i-n)/(s-t)}setFromPerspectiveProjectionMatrix(e,t=this._fullNDC){const s=this._inverseProjection.copy(e).invert(),i=this._v1,n=this._forwardDirection,o=Math.sign(t.min.x)*i.set(t.min.x,0,-1).applyMatrix4(s).angleTo(n)*E,l=Math.sign(t.max.x)*i.set(t.max.x,0,-1).applyMatrix4(s).angleTo(n)*E,c=Math.sign(t.max.y)*i.set(0,t.max.y,-1).applyMatrix4(s).angleTo(n)*E,u=Math.sign(t.min.y)*i.set(0,t.min.y,-1).applyMatrix4(s).angleTo(n)*E,h=-i.set(0,0,t.min.z).applyMatrix4(s).z,p=-i.set(0,0,t.max.z).applyMatrix4(s).z;return this.leftDegrees=o,this.rightDegrees=l,this.topDegrees=c,this.bottomDegrees=u,this.nearMeters=h,this.farMeters=p,this}get perspectiveProjectionMatrix(){return this._cachedPerspectiveProjectionMatrix()}overlapPercent(e){return this._boxA.min.x=this.leftDegrees,this._boxA.max.x=this.rightDegrees,this._boxA.min.y=this.bottomDegrees,this._boxA.max.y=this.topDegrees,this._boxB.min.x=e.leftDegrees,this._boxB.max.x=e.rightDegrees,this._boxB.min.y=e.bottomDegrees,this._boxB.max.y=e.topDegrees,this._boxA.intersect(this._boxB).getSize(this._overlapSize).length()/this.sizeDegrees.length()}}class et{constructor(e,t){r(this,"math",wt({evaluateDependencies:_t,addDependencies:bt,subtractDependencies:vt,multiplyDependencies:xt,divideDependencies:St,modDependencies:Mt,numberDependencies:Tt,createUnitDependencies:Rt,unitDependencies:Et},{predictable:!0}));r(this,"mathCompiledExpressions",new Map);r(this,"mathScope",{ratio:void 0,degree:this.math.unit("degree"),meter:this.math.unit("meter"),pixel:this.math.createUnit("pixel",{aliases:["pixels","px"]}),percent:void 0,vdeg:void 0,vw:void 0,vh:void 0});r(this,"epsillonMeters",1e-10);r(this,"epsillonRadians",1e-10);r(this,"epsillonRatio",1e-10);r(this,"transition",new X({multiplier:1,duration:0,easing:Xe.easeInOut,threshold:0,delay:0,debounce:0,maxWait:10,blend:!0}));r(this,"optimize",new he({minFeasibleTime:.02,maxInfeasibleTime:5,relativeTolerance:.001,maxIterationsPerFrame:10,swarmSize:10,pulseFrequencyMin:0,pulseFrequencyMax:1,pulseRate:.4,stepSizeMin:1e-4,stepSizeMax:4,stepSizeStart:1.5}));r(this,"optimizer",new Qe(this));r(this,"viewFrustum",new Je);r(this,"viewResolution",new N(1e3,1e3));r(this,"deltaTime",1/60);r(this,"time",0);r(this,"maxDeltaTime",1/60);r(this,"nodeMetrics",new Map);r(this,"nodeAdapters",new Map);r(this,"transitionables",[]);r(this,"getMetrics",e=>{if(!e)throw new Error("node must be defined");let t=this.nodeMetrics.get(e);return t||(t=new Ge(this,e),this.nodeMetrics.set(e,t)),t});r(this,"getState",e=>{if(!e)throw new Error("node must be defined");return this.getMetrics(e).target});r(this,"getAdapter",e=>{let t=this.nodeAdapters.get(e);return t||(t=new Ze(this,e),this.nodeAdapters.set(e,t)),t});r(this,"createTransitionable",(e,t)=>{const s=new I(this,e,t,this.transition);return this.transitionables.push(s),s});r(this,"_prevResolution",new N);r(this,"_prevSize",new N);r(this,"measureNumberCache",{});this.viewNode=e,this.bindings=t}get viewMetrics(){if(!this.viewNode)throw new Error("EtherealSystem.viewNode must be defined");return this.getMetrics(this.viewNode)}update(e,t){this.deltaTime=Math.max(e,this.maxDeltaTime),this.time=t,(!this._prevResolution.equals(this.viewResolution)||!this._prevSize.equals(this.viewFrustum.sizeDegrees))&&(this.mathScope.vdeg=this.math.unit(this.viewResolution.y/this.viewFrustum.sizeDegrees.y,"px"),this.mathScope.vw=this.math.unit(this.viewResolution.x/100,"px"),this.mathScope.vh=this.math.unit(this.viewResolution.y/100,"px"),this.measureNumberCache={}),this._prevResolution.copy(this.viewResolution),this._prevSize.copy(this.viewFrustum.sizeDegrees);for(const s of this.nodeMetrics.values()){s.needsUpdate=!0;const i=this.nodeAdapters.get(s.node);i&&(i.opacity.needsUpdate=!0,i.orientation.needsUpdate=!0,i.bounds.needsUpdate=!0,i.outerOrigin.needsUpdate=!0,i.outerOrientation.needsUpdate=!0,i.outerBounds.needsUpdate=!0,i.outerVisualBounds.needsUpdate=!0)}for(const s of this.transitionables)s.needsUpdate=!0;for(const s of this.transitionables)s.update();this.viewMetrics.update();for(const s of this.nodeAdapters.values())s.metrics.update()}measureNumber(e,t){if(typeof e=="number")return e;if(e in this.measureNumberCache)return this.measureNumberCache[e];if(!this.mathCompiledExpressions.has(e)){const l=this.math.parse(e).compile();this.mathCompiledExpressions.set(e,l)}const s=this.mathCompiledExpressions.get(e),i=s.evaluate(this.mathScope),n=typeof i=="number"?i:this.math.number(s.evaluate(this.mathScope),t);return this.measureNumberCache[e]=n,n}}const ws=new y;class _s{constructor(e=0,t=0,s=0){this.horizontalRadians=e,this.verticalRadians=t,this.distance=s}get horizontalDegrees(){return this.horizontalRadians*E}set horizontalDegrees(e){this.horizontalRadians=e*R}get verticalDegrees(){return this.verticalRadians*E}set verticalDegrees(e){this.verticalRadians=e*R}setWithRadians(e,t,s){return this.horizontalRadians=e,this.verticalRadians=t,this.distance=s,this}setWithDegrees(e,t,s){return this.horizontalDegrees=e,this.verticalDegrees=t,this.distance=s,this}fromCartesianDirection(e){const t=ws.copy(e).normalize();return this.verticalRadians=Math.asin(t.y)*E,this.horizontalRadians=Math.atan2(t.x,-t.z)*E,this.distance=0,this}fromCartesianPosition(e){return this.fromCartesianDirection(e),this.distance=e.length(),this}toCartesianDirection(e){const t=this.verticalRadians,s=-Math.PI-this.horizontalRadians,i=Math.sin(t),n=Math.cos(t)*Math.sin(s),o=-Math.cos(t)*Math.cos(s);return e.set(n,i,o).normalize()}toCartesianPosition(e){return this.toCartesianDirection(e).multiplyScalar(this.distance)}}const bs=new _,vs=new _,$={getChildren(a,e){const t=a.node;if(!!t.isObject3D){e.length=0;for(let s=0;s<t.children.length;s++)e[s]=t.children[s]}},getState(a){var i;if(a.system.viewNode===a.node){const n=a.node;n.updateMatrixWorld(),a.system.viewFrustum.setFromPerspectiveProjectionMatrix(n.projectionMatrix)}const e=a.node;if(!e.isObject3D)return;let t,s;if(a.isAdaptive){const n=(i=a.referenceMetrics)==null?void 0:i.target.worldMatrix;s=bs.compose(e.position,e.quaternion,e.scale),t=n?vs.multiplyMatrices(n,s):s}else t=e.matrixWorld,s=e.matrix;a.raw.parent=e.parent,a.raw.worldMatrix.copy(t),a.raw.relativeMatrix.copy(s),a.raw.opacity=tt(a)||1},getIntrinsicBounds(a,e){const t=a.node;if(!!t.isObject3D)return t.geometry?(t.geometry.boundingBox||t.geometry.computeBoundingBox(),e.copy(t.geometry.boundingBox)):e},apply(a,e){const t=a.node;if(!t.isObject3D)return;if(e.parent!==t.parent){const i=e.parent;i&&i.add(t)}let s=e.localMatrix;if(isNaN(s.elements[0])||isNaN(s.elements[13])||isNaN(s.elements[14])||isNaN(s.elements[15])||s.elements[0]===0)throw new Error;if(s=e.worldMatrix,isNaN(s.elements[0])||isNaN(s.elements[13])||isNaN(s.elements[14])||isNaN(s.elements[15])||s.elements[0]===0)throw new Error;t.matrixAutoUpdate=!1,t.matrix.copy(e.localMatrix),t.matrixWorld.copy(e.worldMatrix),st(a,e.opacity)}};function tt(a){const e=a.node;if(e.material){const t=e.material;if(t.length){for(const s of t)if(s.opacity!==void 0)return s.opacity}else if("opacity"in e.material)return e.material.opacity}for(const t of a.boundingChildMetrics){const s=tt(t);if(s!==void 0)return s}}function st(a,e){const t=a.node;if(t.material){const s=t.material;if(s.length)for(const i of s)"opacity"in i&&(i.opacity=e);else t.material.opacity=e}for(const s of a.boundingChildMetrics)st(s,e)}const it={getChildren(a,e){a.node.isObject3D&&$.getChildren(a,e)},getState(a){a.node.isObject3D&&$.getState(a)},getIntrinsicBounds(a,e){return a.node.isObject3D&&$.getIntrinsicBounds(a,e),e},apply(a,e){a.node.isObject3D&&$.apply(a,e)}};function xs(a,e=it){return new et(a,e)}var ni=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",ThreeBindings:$,DefaultBindings:it,createLayoutSystem:xs,EtherealLayoutSystem:et,MathUtils:zt,Matrix3:Ct,Matrix4:_,V_00:We,V_11:Qt,V_000:A,V_100:Kt,V_010:Xt,V_001:Yt,V_111:_e,Q_IDENTITY:be,DIRECTION:H,Vector2:N,Vector3:y,Vector4:Bt,Quaternion:z,Euler:Ve,Color:we,Box2:K,Box3:O,Ray:Lt,Line3:Ot,Plane:Dt,computeRelativeDifference:pe,gaussian:G,levy:fe,randomQuaternion:ie,randomSelect:He,extractRotationAboutAxis:ns,LayoutFrustum:Je,NodeStateBase:$e,NodeState:P,SpatialMetrics:Ge,SpatialAdapter:Ze,SpatialLayout:Ke,LayoutSolution:D,OptimizerConfig:he,SpatialOptimizer:Qe,easing:Xe,Transition:Ye,TransitionConfig:X,Transitionable:I,SphericalCoordinate:_s,MemoizationCache:ue});function ce(a,e,t,s=0){var i;s++,a=a.shadowRoot||a;for(let n=a.firstElementChild;n;n=n.nextElementSibling){if(n.assignedSlot)continue;const o=(i=n.assignedElements)==null?void 0:i.call(n,{flatten:!0});if(o)for(const l of o)e.call(t,l,s)&&ce(n,e,t,s);e.call(t,n,s)&&ce(n,e,t,s)}}class Y{constructor(){r(this,"left",0);r(this,"top",0);r(this,"width",0);r(this,"height",0)}copy(e){return this.top=e.top,this.left=e.left,this.width=e.width,this.height=e.height,this}}class U{constructor(){r(this,"left",0);r(this,"top",0);r(this,"right",0);r(this,"bottom",0)}copy(e){return this.top=e.top,this.left=e.left,this.right=e.right,this.bottom=e.bottom,this}}function ve(a,e=new Y,t){const s=a.ownerDocument,i=s.documentElement,n=s.body;if(a===i)return Rs(s,e);if(t===a){e.left=0,e.top=0,e.width=a.offsetWidth,e.height=a.offsetHeight;return}const o=a.ownerDocument.defaultView;let l=a,c,u=l.offsetParent,h=o.getComputedStyle(l,null),p=l.offsetTop,d=l.offsetLeft;for(u&&t&&(u.contains(t)||u.contains(t.getRootNode().host))&&u!==t&&(ve(t,e,u),d-=e.left,p-=e.top);(l=l.parentElement)&&l!==n&&l!==i&&l!==t&&h.position!=="fixed";)c=o.getComputedStyle(l,null),p-=l.scrollTop,d-=l.scrollLeft,l===u&&(p+=l.offsetTop,d+=l.offsetLeft,p+=parseFloat(c.borderTopWidth)||0,d+=parseFloat(c.borderLeftWidth)||0,u=l.offsetParent),h=c;return h.position==="fixed"&&(p+=Math.max(i.scrollTop,n.scrollTop),d+=Math.max(i.scrollLeft,n.scrollLeft)),e.left=d,e.top=p,e.width=a.offsetWidth,e.height=a.offsetHeight,e}function Ss(a,e){if(a.offsetParent===null){e.left=e.right=e.top=e.bottom=0;return}let t=getComputedStyle(a);e.left=parseFloat(t.marginLeft)||0,e.right=parseFloat(t.marginRight)||0,e.top=parseFloat(t.marginTop)||0,e.bottom=parseFloat(t.marginBottom)||0}function Ms(a,e){let t=getComputedStyle(a);e.left=parseFloat(t.borderLeftWidth)||0,e.right=parseFloat(t.borderRightWidth)||0,e.top=parseFloat(t.borderTopWidth)||0,e.bottom=parseFloat(t.borderBottomWidth)||0}function Ts(a,e){let t=getComputedStyle(a);e.left=parseFloat(t.paddingLeft)||0,e.right=parseFloat(t.paddingRight)||0,e.top=parseFloat(t.paddingTop)||0,e.bottom=parseFloat(t.paddingBottom)||0}const q=document.createElement("div");q.id="VIEWPORT";q.style.position="fixed";q.style.width="100vw";q.style.height="100vh";q.style.visibility="hidden";q.style.pointerEvents="none";function Rs(a,e){const t=a.documentElement,s=a.body,i=getComputedStyle(t),n=getComputedStyle(s);return e.top=s.offsetTop+parseFloat(i.marginTop)||0+parseFloat(n.marginTop)||0,e.left=s.offsetLeft+parseFloat(i.marginLeft)||0+parseFloat(n.marginLeft)||0,e.width=Math.max(Math.max(s.scrollWidth,t.scrollWidth),Math.max(s.offsetWidth,t.offsetWidth),Math.max(s.clientWidth,t.clientWidth)),e.height=Math.max(Math.max(s.scrollHeight,t.scrollHeight),Math.max(s.offsetHeight,t.offsetHeight),Math.max(s.clientHeight,t.clientHeight)),e}function Es(a){const e=document.createElement("div");e.innerHTML=a;const t=e.firstElementChild;return e.removeChild(t),t}const rt=function(a,e){const t=document.createElement("a");t.download=e,t.href=window.URL.createObjectURL(a),t.dataset.downloadurl=["application/octet-stream",t.download,t.href].join(":"),t.click()},zs=new _,Cs=new _;function Bs(a,e,t,s,i=new _){const n=a.transform,o=a.transformOrigin;if(n.indexOf("matrix(")==0){i.identity();var l=n.substring(7,n.length-1).split(", ").map(parseFloat);i.elements[0]=l[0],i.elements[1]=l[1],i.elements[4]=l[2],i.elements[5]=l[3],i.elements[12]=l[4],i.elements[13]=l[5]}else if(n.indexOf("matrix3d(")==0){var l=n.substring(9,n.length-1).split(", ").map(parseFloat);i.fromArray(l)}else return null;i.elements[0]===0&&(i.elements[0]=1e-15),i.elements[5]===0&&(i.elements[5]=1e-15),i.elements[10]===0&&(i.elements[10]=1e-15),i.elements[12]*=s,i.elements[13]*=s*-1;var c=o.split(" ").map(parseFloat),u=(c[0]-e/2)*s,h=(c[1]-t/2)*s*-1,p=c[2]||0,d=zs.identity().makeTranslation(-u,-h,-p),m=Cs.identity().makeTranslation(u,h,p);for(const f of i.elements)if(isNaN(f))return null;return i.premultiply(m).multiply(d)}class xe{constructor(e,t,s){r(this,"manager");r(this,"element");r(this,"eventCallback");r(this,"isMediaElement",!1);r(this,"isVideoElement",!1);r(this,"isCanvasElement",!1);r(this,"desiredPseudoState",{hover:!1,active:!1,focus:!1,target:!1});r(this,"needsRefresh",!0);r(this,"needsRemoval",!1);r(this,"parentLayer");r(this,"childLayers",[]);r(this,"allStateHashes",new Set);r(this,"previousDOMStateKey");r(this,"desiredDOMStateKey");r(this,"currentDOMStateKey");r(this,"lastSVGUrl");r(this,"domMetrics",{bounds:new Y,padding:new U,margin:new U,border:new U});if(this.manager=e,this.element=t,this.eventCallback=s,!e)throw new Error("WebLayerManager must be initialized");g.layers.set(t,this),t.setAttribute(g.LAYER_ATTRIBUTE,""),this.parentLayer=g.getClosestLayer(this.element,!1),this.isVideoElement=t.nodeName==="VIDEO",this.isMediaElement=this.isVideoElement||t.nodeName==="IMG"||t.nodeName==="CANVAS",this.eventCallback("layercreated",{target:t})}setNeedsRefresh(e=!1){if(this.needsRefresh=!0,e)for(const t of this.childLayers)t.setNeedsRefresh(e)}set pixelRatio(e){typeof e=="number"?this.element.setAttribute(g.PIXEL_RATIO_ATTRIBUTE,e.toString()):this.element.removeAttribute(g.PIXEL_RATIO_ATTRIBUTE)}get pixelRatio(){const e=this.element.getAttribute(g.PIXEL_RATIO_ATTRIBUTE);return e?parseFloat(e):null}get computedPixelRatio(){var e,t,s;return(s=(t=this.pixelRatio)!=null?t:(e=this.parentLayer)==null?void 0:e.computedPixelRatio)!=null?s:1}get previousDOMState(){return this.previousDOMStateKey?this.manager.getLayerState(this.previousDOMStateKey):void 0}get desiredDOMState(){return this.desiredDOMStateKey?this.manager.getLayerState(this.desiredDOMStateKey):void 0}get currentDOMState(){return this.currentDOMStateKey?this.manager.getLayerState(this.currentDOMStateKey):void 0}get depth(){let e=0,t=this;for(;t.parentLayer;)t=t.parentLayer,e++;return e}get rootLayer(){let e=this;for(;e.parentLayer;)e=e.parentLayer;return e}traverseParentLayers(e){const t=this.parentLayer;t&&(t.traverseParentLayers(e),e(t))}traverseLayers(e){e(this),this.traverseChildLayers(e)}traverseChildLayers(e){for(const t of this.childLayers)t.traverseLayers(e)}update(){var s,i,n,o,l,c,u,h,p,d,m,f;if(this.desiredDOMStateKey!==this.currentDOMStateKey){const w=this.desiredDOMState;w&&(this.isMediaElement||((s=w.texture)==null?void 0:s.ktx2Url)||((i=w.texture)==null?void 0:i.canvas)||w.fullWidth*w.fullHeight===0)&&(this.currentDOMStateKey=this.desiredDOMStateKey)}const e=(u=(o=(n=this.previousDOMState)==null?void 0:n.texture)==null?void 0:o.ktx2Url)!=null?u:(c=(l=this.previousDOMState)==null?void 0:l.texture)==null?void 0:c.canvas,t=(f=(p=(h=this.currentDOMState)==null?void 0:h.texture)==null?void 0:p.ktx2Url)!=null?f:(m=(d=this.previousDOMState)==null?void 0:d.texture)==null?void 0:m.canvas;t&&e!==t&&this.eventCallback("layerpainted",{target:this.element}),this.previousDOMStateKey=this.currentDOMStateKey}async refresh(){this.needsRefresh=!1,this._updateParentAndChildLayers();const e=await this.manager.addToSerializeQueue(this);e.needsRasterize&&typeof e.stateKey=="string"&&e.svgUrl&&await this.manager.addToRasterizeQueue(e.stateKey,e.svgUrl)}_updateParentAndChildLayers(){const e=this.element,t=this.childLayers,s=t.slice(),i=this.parentLayer;this.parentLayer=g.getClosestLayer(this.element,!1),i!==this.parentLayer&&(this.parentLayer&&this.parentLayer.childLayers.push(this),this.eventCallback("layermoved",{target:e})),t.length=0,ce(e,this._tryConvertElementToWebLayer,this);for(const n of s)g.getClosestLayer(n.element,!1)||(n.needsRemoval=!0,t.push(n))}_tryConvertElementToWebLayer(e){if(this.needsRemoval)return!1;const t=e,s=getComputedStyle(t);if(t.hasAttribute(g.LAYER_ATTRIBUTE)||t.nodeName==="VIDEO"||s.transform!=="none"){let n=g.layers.get(t);return n||(n=new xe(this.manager,t,this.eventCallback)),this.childLayers.push(n),!1}return!0}}const Ls=self.ResizeObserver||At;function Os(a,e){if(document.contains(a))return a;const t=document.createElement("div");return t.id=a.id?"container-"+a.id:"",t.setAttribute(g.RENDERING_CONTAINER_ATTRIBUTE,""),t.style.visibility="hidden",t.style.pointerEvents="none",t.style.touchAction="none",t.attachShadow({mode:"open"}).appendChild(a),document.documentElement.appendChild(t),t}const v=class{static get HOVER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-hover"}static get ACTIVE_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-active"}static get FOCUS_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-focus"}static get TARGET_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-target"}static get LAYER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-layer"}static get PIXEL_RATIO_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-pixel-ratio"}static get RENDERING_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering"}static get RENDERING_PARENT_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-parent"}static get RENDERING_CONTAINER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-container"}static get RENDERING_INLINE_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-inline"}static get RENDERING_DOCUMENT_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-document"}static getPsuedoAttributes(e){return`${e.hover?`${this.HOVER_ATTRIBUTE}="" `:" "}${e.focus?`${this.FOCUS_ATTRIBUTE}="" `:" "}${e.active?`${this.ACTIVE_ATTRIBUTE}="" `:" "}${e.target?`${this.TARGET_ATTRIBUTE}="" `:" "}`}static initRootNodeObservation(e){const t=e.ownerDocument,s=e.getRootNode(),i="head"in s?s.head:s;if(this.rootNodeObservers.get(s))return;if(!this.containerStyleElement){const p=this.containerStyleElement=t.createElement("style");t.head.appendChild(p),p.innerHTML=`
        [${v.RENDERING_CONTAINER_ATTRIBUTE}] {
          all: initial;
          position: fixed;
          width: 100%;
          height: 100%;
          top: 0px;
        }
      `}const n=`
    a {
      color: blue;
      text-decoration: underline;
    }

    :host > [${v.LAYER_ATTRIBUTE}] {
      display: flow-root;
    }

    [${v.RENDERING_DOCUMENT_ATTRIBUTE}] * {
      transform: none !important;
    }

    [${v.RENDERING_ATTRIBUTE}], [${v.RENDERING_ATTRIBUTE}] * {
      visibility: visible !important;
      /* the following is a hack for Safari; 
      without some kind of css filter active, 
      any box-shadow effect will fail to rasterize properly */
      filter: opacity(1);
    }
    
    [${v.RENDERING_ATTRIBUTE}] [${v.LAYER_ATTRIBUTE}], [${v.RENDERING_ATTRIBUTE}] [${v.LAYER_ATTRIBUTE}] * {
      visibility: hidden !important;
    }

    [${v.RENDERING_ATTRIBUTE}] {
      position: relative !important;
      top: 0 !important;
      left: 0 !important;
      float: left !important; /* prevent margin-collapse in SVG foreign-element for Webkit */
      box-sizing:border-box;
      min-width:var(--x-width);
      min-height:var(--x-height);
    }

    [${v.RENDERING_PARENT_ATTRIBUTE}] {
      transform: none !important;
      left: 0 !important;
      top: 0 !important;
      margin: 0 !important;
      border:0 !important;
      border-radius:0 !important;
      width: 100% !important;
      height:100% !important;
      padding:0 !important;
      visibility:hidden !important;
      filter:none !important;
    }
    
    [${v.RENDERING_PARENT_ATTRIBUTE}]::before, [${v.RENDERING_PARENT_ATTRIBUTE}]::after {
      content:none !important;
      box-shadow:none !important;
    }
    `,o=t.createElement("style");if(o.textContent=n,i.append(o),s===t){let p="";const d=()=>{if(p!=window.location.hash&&window.location.hash)try{this.targetElement=s.querySelector(window.location.hash)}catch{}p=window.location.hash};window.addEventListener("hashchange",d,!1),d(),window.addEventListener("focusin",m=>{this.focusElement=m.target},!1),window.addEventListener("focusout",m=>{this.focusElement=null},!1),window.addEventListener("load",m=>{l()})}const l=()=>{for(const[p,d]of this.layers)d.needsRefresh=!0},c=p=>{var d=p.nodeName.toUpperCase();u.indexOf(d)!==-1&&p.addEventListener("load",l)},u=["STYLE","LINK"],h=new MutationObserver(p=>{for(const d of p){u.indexOf(d.target.nodeName.toUpperCase())!==-1&&(l(),this.embeddedStyles.delete(d.target));for(const m of d.addedNodes)c(m)}});h.observe(t,{childList:!0,attributes:!0,characterData:!0,subtree:!0,attributeOldValue:!0,characterDataOldValue:!0}),this.rootNodeObservers.set(s,h)}static setLayerNeedsRefresh(e){e.needsRefresh=!0}static createLayerTree(e,t,s){if(v.getClosestLayer(e))throw new Error("A root WebLayer for the given element already exists");const i=Os(e);v.initRootNodeObservation(e);const n=new MutationObserver(v._handleMutations);this.mutationObservers.set(e,n),this.startMutationObserver(e);const o=new Ls(c=>{for(const u of c){const h=this.getClosestLayer(u.target);h.traverseLayers(v.setLayerNeedsRefresh),h.traverseParentLayers(v.setLayerNeedsRefresh)}});o.observe(e),this.resizeObservers.set(e,o),e.addEventListener("input",this._triggerRefresh,{capture:!0}),e.addEventListener("keydown",this._triggerRefresh,{capture:!0}),e.addEventListener("submit",this._triggerRefresh,{capture:!0}),e.addEventListener("change",this._triggerRefresh,{capture:!0}),e.addEventListener("focus",this._triggerRefresh,{capture:!0}),e.addEventListener("blur",this._triggerRefresh,{capture:!0}),e.addEventListener("transitionend",this._triggerRefresh,{capture:!0});const l=new xe(t.manager,e,s);return this.rootLayers.set(e,l),i}static disposeLayer(e){this.rootLayers.has(e.element)&&(this.rootLayers.delete(e.element),this.mutationObservers.get(e.element).disconnect(),this.mutationObservers.delete(e.element),this.resizeObservers.get(e.element).disconnect(),this.resizeObservers.delete(e.element),e.element.removeEventListener("input",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("keydown",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("submit",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("change",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("focus",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("blur",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("transitionend",this._triggerRefresh,{capture:!0}))}static getClosestLayer(e,t=!0){let s=t?e:e.parentElement;const i=s==null?void 0:s.closest(`[${v.LAYER_ATTRIBUTE}]`);if(!i){const n=e==null?void 0:e.getRootNode().host;if(n)return this.getClosestLayer(n,t)}return this.layers.get(i)}static pauseMutationObservers(){const e=v.mutationObservers.values();for(const t of e)v._handleMutations(t.takeRecords()),t.disconnect()}static resumeMutationObservers(){for(const[e]of v.mutationObservers)this.startMutationObserver(e)}static startMutationObserver(e){v.mutationObservers.get(e).observe(e,{attributes:!0,childList:!0,subtree:!0,characterData:!0,characterDataOldValue:!0,attributeOldValue:!0})}static arrayBufferToBase64(e){for(var t="",s=e.byteLength,i=0;i<s;i++)t+=String.fromCharCode(e[i]);return window.btoa(t)}static attributeCSS(e,t){return t?`[${e}]=${t}`:`[${e}]`}static attributeHTML(e,t){return t?`${e}="${t}"`:`${e}=""`}static updateInputAttributes(e){e.matches("input")&&this._updateInputAttribute(e);for(const t of e.getElementsByTagName("input"))this._updateInputAttribute(t)}static _updateInputAttribute(e){e.hasAttribute("checked")?e.checked||e.removeAttribute("checked"):e.checked&&e.setAttribute("checked",""),e.getAttribute("value")!==e.value&&e.setAttribute("value",e.value)}static isBlankImage(e){return!new Uint32Array(e.buffer).some(s=>s!==0)}};let g=v;r(g,"ATTRIBUTE_PREFIX","xr"),r(g,"serializer",new XMLSerializer),r(g,"textEncoder",new TextEncoder),r(g,"rootLayers",new Map),r(g,"layers",new Map),r(g,"focusElement",null),r(g,"activeElement",null),r(g,"targetElement",null),r(g,"mutationObservers",new Map),r(g,"resizeObservers",new Map),r(g,"rootNodeObservers",new Map),r(g,"containerStyleElement"),r(g,"dataURLMap",new Map),r(g,"embeddedCSSMap",new Map),r(g,"embeddedStyles",new Map),r(g,"fontStyles",new Map),r(g,"_handleMutations",e=>{var t;for(const s of e){if(s.type==="attributes"&&s.target.getAttribute(s.attributeName)===s.oldValue)continue;if(s.type==="characterData"){const o=s.target;if(o.data===s.oldValue)continue;if(((t=o.parentElement)==null?void 0:t.tagName.toLowerCase())==="style"){const l=o.parentElement;l.getRootNode(),v.embeddedStyles.delete(l)}}const i=s.target.nodeType===Node.ELEMENT_NODE?s.target:s.target.parentElement;if(!i)continue;const n=v.getClosestLayer(i);if(!!n){if(s.type==="attributes"&&s.attributeName==="class"){const o=s.oldValue?s.oldValue:"",l=s.target.className;if(o===l)continue}n.parentLayer?n.parentLayer.traverseChildLayers(v.setLayerNeedsRefresh):n.traverseLayers(v.setLayerNeedsRefresh)}}}),r(g,"_triggerRefresh",async e=>{const t=v.getClosestLayer(e.target);t&&(t.parentLayer?t.parentLayer.traverseChildLayers(v.setLayerNeedsRefresh):t.traverseLayers(v.setLayerNeedsRefresh))});const ge=Symbol("ON_BEFORE_UPDATE"),me=new le;function Ds(a){const e=a.attributes.uv;for(let t=0;t<e.count;t++)e.setY(t,1-e.getY(t));return a}const Q=class extends se{constructor(e,t){super();r(this,"element");r(this,"container");r(this,"_camera");r(this,"_webLayer");r(this,"_localZ",0);r(this,"_viewZ",0);r(this,"_renderZ",0);r(this,"_mediaSrc");r(this,"_mediaTexture");r(this,"textures",new Set);r(this,"_previousTexture");r(this,"_textureMap",new Map);r(this,"contentMesh");r(this,"_boundsMesh");r(this,"cursor",new se);r(this,"depthMaterial",new Ut({depthPacking:kt,alphaTest:.001}));r(this,"domLayout",new se);r(this,"domSize",new le(1,1,1));r(this,"bounds",new Y);r(this,"margin",new U);r(this,"childWebLayers",[]);r(this,"shouldApplyDOMLayout","auto");this.element=e,this.container=t,this.name=e.id,this._webLayer=g.getClosestLayer(e),e.layer=this;const s=this._webLayer.isMediaElement?Q.GEOMETRY:Q.FLIPPED_GEOMETRY;this.contentMesh=new Re(s,new Ee({side:Nt,depthWrite:!1,transparent:!0,alphaTest:.001,opacity:1,toneMapped:!1})),this._boundsMesh=new Re(s,new Ee({visible:!1})),this.add(this.contentMesh),this.add(this._boundsMesh),this.cursor.visible=!1,this.matrixAutoUpdate=!0,this.contentMesh.matrixAutoUpdate=!0,this.contentMesh.visible=!1,this.contentMesh.customDepthMaterial=this.depthMaterial,this.contentMesh.onBeforeRender=(i,n,o)=>{this._camera=o},this._boundsMesh.matrixAutoUpdate=!0,this.container.options.manager.layersByElement.set(this.element,this),this.container.options.manager.layersByMesh.set(this.contentMesh,this)}static shouldApplyDOMLayout(e){const t=e.shouldApplyDOMLayout;return t==="always"||t===!0?!0:t==="never"||t===!1?!1:!!(t==="auto"&&e.parentWebLayer&&e.parent===e.parentWebLayer)}get allStateHashes(){return this._webLayer.allStateHashes}get domState(){return this._webLayer.currentDOMState}get texture(){var i,n,o,l;const e=this.container.manager,t=this._webLayer;if(t.isMediaElement){const c=this.element;let u=this._mediaTexture;return(!u||u.image&&c.src!==u.image.src)&&(u&&u.dispose(),u=t.isVideoElement?new It(c):t.isCanvasElement?new je(c):new Pt().load(c.src),u.wrapS=V,u.wrapT=V,u.minFilter=Ft,e.textureEncoding&&(u.encoding=e.textureEncoding),this._mediaTexture=u),u}const s=(n=(i=this._webLayer.currentDOMState)==null?void 0:i.texture)==null?void 0:n.hash;if(s){this._textureMap.has(s)||this._textureMap.set(s,{});const c=e.getTexture(s),u=this._textureMap.get(s);return c.compressedTexture&&!u.compressedTexture&&((o=u.canvasTexture)==null||o.dispose(),u.canvasTexture=void 0,u.compressedTexture=c.compressedTexture.clone(),u.compressedTexture.needsUpdate=!0),c.canvasTexture&&!u.canvasTexture&&(u.canvasTexture=c.canvasTexture.clone(),u.canvasTexture.needsUpdate=!0),(l=u.compressedTexture)!=null?l:u.canvasTexture}}get desiredPseudoStates(){return this._webLayer.desiredPseudoState}get pseudoStates(){var e;return(e=this._webLayer.currentDOMState)==null?void 0:e.pseudo}get depth(){return this._webLayer.depth}get index(){return this.parentWebLayer?this.parentWebLayer.childWebLayers.indexOf(this):0}get needsRefresh(){return this._webLayer.needsRefresh}setNeedsRefresh(e=!0){this._webLayer.setNeedsRefresh(e)}get needsRemoval(){return this._webLayer.needsRemoval}get parentWebLayer(){return this._webLayer.parentLayer&&this.container.manager.layersByElement.get(this._webLayer.parentLayer.element)}async refresh(e=!1){var s;const t=[];t.push(this._webLayer.refresh()),this.childWebLayers.length=0;for(const i of this._webLayer.childLayers){const n=this.container.manager.layersByElement.get((s=g.getClosestLayer(i.element))==null?void 0:s.element);!n||(this.childWebLayers.push(n),e&&t.push(n.refresh(e)))}return Promise.all(t).then(()=>{})}updateLayout(){if(this._updateDOMLayout(),this._camera){this._localZ=Math.abs(me.setFromMatrixPosition(this.matrix).z+me.setFromMatrixPosition(this.contentMesh.matrix).z),this._viewZ=Math.abs(this.contentMesh.getWorldPosition(me).applyMatrix4(this._camera.matrixWorldInverse).z);let e=this.parentWebLayer?this.parentWebLayer._renderZ:this._viewZ;this._localZ<.001?this._renderZ=e:this._renderZ=this._viewZ,this.contentMesh.renderOrder=(this.container.options.renderOrderOffset||0)+(1-Math.log(this._renderZ+1)/Math.log(this._camera.far+1))+(this.depth+this.index*.001)*1e-7}}updateContent(){if(this.parentWebLayer&&!this.parentWebLayer.domLayout)return;const e=this.contentMesh,t=this.texture,s=e.material;if(t&&s.map!==t){const o=this.contentMesh.scale,l=Math.abs(o.x*this.scale.x/o.y*this.scale.y),c=this.domSize.x/this.domSize.y;Math.abs(c-l)<1e3&&(s.map=t,this.depthMaterial.map=t,s.needsUpdate=!0,this.depthMaterial.needsUpdate=!0)}const i=e.material,n=i.opacity<.005;n?e.visible=!1:i.map&&(e.visible=!0),this.needsRemoval&&n&&(this.parent&&this.parent.remove(this),this.dispose()),this._refreshMediaBounds()}[ge](){}_doUpdate(){var e,t;this[ge](),this.updateContent(),this.updateLayout(),Q.shouldApplyDOMLayout(this)&&(this.position.copy(this.domLayout.position),this.quaternion.copy(this.domLayout.quaternion),this.scale.copy(this.domLayout.scale)),this.contentMesh.position.set(0,0,0),this.contentMesh.scale.copy(this.domSize),this.contentMesh.quaternion.set(0,0,0,1),this._boundsMesh.position.set(0,0,0),this._boundsMesh.scale.copy(this.domSize),this._boundsMesh.quaternion.set(0,0,0,1),this.needsRefresh&&this.container.options.autoRefresh!==!1&&this.refresh(),this._previousTexture!==this.texture&&(this.texture&&this.container.manager.renderer.initTexture(this.texture),this._previousTexture=this.texture,(t=(e=this.container.options).onLayerPaint)==null||t.call(e,this)),this._webLayer.update(),this.container.manager.scheduleTasksIfNeeded()}get pixelRatio(){return this._webLayer.pixelRatio}set pixelRatio(e){this._webLayer.pixelRatio=e}get computedPixelRatio(){return this._webLayer.computedPixelRatio}update(e=!1){e?this.traverseLayersPreOrder(this._doUpdate):this._doUpdate()}querySelector(e){var s;const t=this.element.querySelector(e)||((s=this.element.shadowRoot)==null?void 0:s.querySelector(e));if(t)return this.container.manager.layersByElement.get(t)}querySelectorAll(e){var s;const t=this.element.querySelectorAll(e)||((s=this.element.shadowRoot)==null?void 0:s.querySelectorAll(e));return Array.from(t).map(i=>this.container.manager.layersByElement.get(i)).filter(i=>i)}traverseLayerAncestors(e){const t=this.parentWebLayer;t&&(t.traverseLayerAncestors(e),e.call(this,t))}traverseLayersPreOrder(e){if(e.call(this,this)===!1)return!1;for(const t of this.childWebLayers)if(t.traverseLayersPreOrder(e)===!1)return!1;return!0}traverseLayersPostOrder(e){for(const t of this.childWebLayers)if(t.traverseLayersPostOrder(e)===!1)return!1;return e.call(this,this)||!0}dispose(){g.disposeLayer(this._webLayer);for(const e of this.textures)e.dispose();for(const e of this.childWebLayers)e.dispose()}_refreshMediaBounds(){if(this._webLayer.isMediaElement){const e=this._webLayer.isVideoElement,t=this.domState;if(!t)return;const s=this.element,i=this.texture,n=getComputedStyle(this.element),{objectFit:o}=n,{width:l,height:c}=this.bounds.copy(t.bounds),u=e?s.videoWidth:s.naturalWidth,h=e?s.videoHeight:s.naturalHeight,p=u/h,d=l/c;switch(i.center.set(.5,.5),o){case"none":i.repeat.set(l/u,c/h).clampScalar(0,1);break;case"contain":case"scale-down":if(i.repeat.set(1,1),d>p){const m=this.bounds.height*p||0;this.bounds.left+=(this.bounds.width-m)/2,this.bounds.width=m}else{const m=this.bounds.width/p||0;this.bounds.top+=(this.bounds.height-m)/2,this.bounds.height=m}break;case"cover":if(i.repeat.set(l/u,c/h),d<p){const m=this.bounds.height*p||0;this.bounds.left+=(this.bounds.width-m)/2,this.bounds.width=m}else{const m=this.bounds.width/p||0;this.bounds.top+=(this.bounds.height-m)/2,this.bounds.height=m}break;default:case"fill":i.repeat.set(1,1);break}t.bounds.copy(this.bounds)}}_updateDOMLayout(){if(this.needsRemoval)return;const e=this._webLayer.currentDOMState;if(!e)return;const{bounds:t,margin:s,cssTransform:i}=e,n=this._webLayer.isMediaElement;this.domLayout.position.set(0,0,0),this.domLayout.scale.set(1,1,1),this.domLayout.quaternion.set(0,0,0,1);const o=this.bounds.copy(t),l=this.margin.copy(s),c=o.width,u=o.height,h=n?0:l.left,p=n?0:l.right,d=n?0:l.top,m=n?0:l.bottom,f=c+h+p,w=u+d+m,x=1/this.container.manager.pixelsPerMeter;this.domSize.set(Math.max(x*f,1e-5),Math.max(x*w,1e-5),1);const b=this.parentWebLayer;if(!b)return;const T=b.bounds,S=b.margin,M=T.width+S.left+S.right,C=T.height+S.bottom+S.top,L=-M/2+S.left,Z=C/2-S.top;this.domLayout.position.set(x*(L+f/2+o.left-h),x*(Z-w/2-o.top+d),0),i&&(this.domLayout.updateMatrix(),this.domLayout.matrix.multiply(i),this.domLayout.matrix.decompose(this.domLayout.position,this.domLayout.quaternion,this.domLayout.scale))}};let ae=Q;r(ae,"GEOMETRY",new Te(1,1,2,2)),r(ae,"FLIPPED_GEOMETRY",Ds(new Te(1,1,2,2)));var As=`(() => {
  var __create = Object.create;
  var __defProp = Object.defineProperty;
  var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
  var __getOwnPropNames = Object.getOwnPropertyNames;
  var __getProtoOf = Object.getPrototypeOf;
  var __hasOwnProp = Object.prototype.hasOwnProperty;
  var __markAsModule = (target) => __defProp(target, "__esModule", { value: true });
  var __commonJS = (cb, mod) => function __require() {
    return mod || (0, cb[__getOwnPropNames(cb)[0]])((mod = { exports: {} }).exports, mod), mod.exports;
  };
  var __reExport = (target, module, copyDefault, desc) => {
    if (module && typeof module === "object" || typeof module === "function") {
      for (let key of __getOwnPropNames(module))
        if (!__hasOwnProp.call(target, key) && (copyDefault || key !== "default"))
          __defProp(target, key, { get: () => module[key], enumerable: !(desc = __getOwnPropDesc(module, key)) || desc.enumerable });
    }
    return target;
  };
  var __toESM = (module, isNodeMode) => {
    return __reExport(__markAsModule(__defProp(module != null ? __create(__getProtoOf(module)) : {}, "default", !isNodeMode && module && module.__esModule ? { get: () => module.default, enumerable: true } : { value: module, enumerable: true })), module);
  };

  // (disabled):../../node_modules/@loaders.gl/worker-utils/dist/esm/lib/node/require-utils.node
  var require_require_utils = __commonJS({
    "(disabled):../../node_modules/@loaders.gl/worker-utils/dist/esm/lib/node/require-utils.node"() {
    }
  });

  // ../../node_modules/@loaders.gl/textures/dist/esm/lib/utils/version.js
  var VERSION = true ? "3.1.4" : "latest";

  // ../../node_modules/@loaders.gl/worker-utils/dist/esm/lib/env-utils/assert.js
  function assert(condition, message) {
    if (!condition) {
      throw new Error(message || "loaders.gl assertion failed.");
    }
  }

  // ../../node_modules/@loaders.gl/worker-utils/dist/esm/lib/env-utils/globals.js
  var globals = {
    self: typeof self !== "undefined" && self,
    window: typeof window !== "undefined" && window,
    global: typeof global !== "undefined" && global,
    document: typeof document !== "undefined" && document
  };
  var self_ = globals.self || globals.window || globals.global || {};
  var window_ = globals.window || globals.self || globals.global || {};
  var global_ = globals.global || globals.self || globals.window || {};
  var document_ = globals.document || {};
  var isBrowser = typeof process !== "object" || String(process) !== "[object process]" || process.browser;
  var isWorker = typeof importScripts === "function";
  var isMobile = typeof window !== "undefined" && typeof window.orientation !== "undefined";
  var matches = typeof process !== "undefined" && process.version && /v([0-9]*)/.exec(process.version);
  var nodeVersion = matches && parseFloat(matches[1]) || 0;

  // ../../node_modules/@loaders.gl/worker-utils/dist/esm/lib/library-utils/library-utils.js
  var node = __toESM(require_require_utils());
  var VERSION2 = true ? "3.1.4" : LATEST;
  var loadLibraryPromises = {};
  async function loadLibrary(libraryUrl, moduleName = null, options = {}) {
    if (moduleName) {
      libraryUrl = getLibraryUrl(libraryUrl, moduleName, options);
    }
    loadLibraryPromises[libraryUrl] = loadLibraryPromises[libraryUrl] || loadLibraryFromFile(libraryUrl);
    return await loadLibraryPromises[libraryUrl];
  }
  function getLibraryUrl(library, moduleName, options) {
    if (library.startsWith("http")) {
      return library;
    }
    const modules = options.modules || {};
    if (modules[library]) {
      return modules[library];
    }
    if (!isBrowser) {
      return "modules/".concat(moduleName, "/dist/libs/").concat(library);
    }
    if (options.CDN) {
      assert(options.CDN.startsWith("http"));
      return "".concat(options.CDN, "/").concat(moduleName, "@").concat(VERSION2, "/dist/libs/").concat(library);
    }
    if (isWorker) {
      return "../src/libs/".concat(library);
    }
    return "modules/".concat(moduleName, "/src/libs/").concat(library);
  }
  async function loadLibraryFromFile(libraryUrl) {
    if (libraryUrl.endsWith("wasm")) {
      const response2 = await fetch(libraryUrl);
      return await response2.arrayBuffer();
    }
    if (!isBrowser) {
      try {
        return node && node.requireFromFile && await node.requireFromFile(libraryUrl);
      } catch {
        return null;
      }
    }
    if (isWorker) {
      return importScripts(libraryUrl);
    }
    const response = await fetch(libraryUrl);
    const scriptSource = await response.text();
    return loadLibraryFromString(scriptSource, libraryUrl);
  }
  function loadLibraryFromString(scriptSource, id) {
    if (!isBrowser) {
      return node.requireFromString && node.requireFromString(scriptSource, id);
    }
    if (isWorker) {
      eval.call(global_, scriptSource);
      return null;
    }
    const script = document.createElement("script");
    script.id = id;
    try {
      script.appendChild(document.createTextNode(scriptSource));
    } catch (e) {
      script.text = scriptSource;
    }
    document.body.appendChild(script);
    return null;
  }

  // ../../node_modules/@loaders.gl/textures/dist/esm/lib/parsers/basis-module-loader.js
  var VERSION3 = true ? "3.1.4" : "latest";
  var BASIS_CDN_ENCODER_WASM = "https://unpkg.com/@loaders.gl/textures@".concat(VERSION3, "/dist/libs/basis_encoder.wasm");
  var BASIS_CDN_ENCODER_JS = "https://unpkg.com/@loaders.gl/textures@".concat(VERSION3, "/dist/libs/basis_encoder.js");
  var loadBasisEncoderPromise;
  async function loadBasisEncoderModule(options) {
    const modules = options.modules || {};
    if (modules.basisEncoder) {
      return modules.basisEncoder;
    }
    loadBasisEncoderPromise = loadBasisEncoderPromise || loadBasisEncoder(options);
    return await loadBasisEncoderPromise;
  }
  async function loadBasisEncoder(options) {
    let BASIS_ENCODER = null;
    let wasmBinary = null;
    [BASIS_ENCODER, wasmBinary] = await Promise.all([await loadLibrary(BASIS_CDN_ENCODER_JS, "textures", options), await loadLibrary(BASIS_CDN_ENCODER_WASM, "textures", options)]);
    BASIS_ENCODER = BASIS_ENCODER || globalThis.BASIS;
    return await initializeBasisEncoderModule(BASIS_ENCODER, wasmBinary);
  }
  function initializeBasisEncoderModule(BasisEncoderModule, wasmBinary) {
    const options = {};
    if (wasmBinary) {
      options.wasmBinary = wasmBinary;
    }
    return new Promise((resolve) => {
      BasisEncoderModule(options).then((module) => {
        const {
          BasisFile,
          KTX2File,
          initializeBasis,
          BasisEncoder
        } = module;
        initializeBasis();
        resolve({
          BasisFile,
          KTX2File,
          BasisEncoder
        });
      });
    });
  }

  // ../../node_modules/@loaders.gl/textures/dist/esm/lib/encoders/encode-ktx2-basis-texture.js
  async function encodeKTX2BasisTexture(image, options = {}) {
    const {
      useSRGB = false,
      qualityLevel = 10,
      encodeUASTC = false,
      mipmaps = false
    } = options;
    const {
      BasisEncoder
    } = await loadBasisEncoderModule(options);
    const basisEncoder = new BasisEncoder();
    try {
      const basisFileData = new Uint8Array(image.width * image.height * 4);
      basisEncoder.setCreateKTX2File(true);
      basisEncoder.setKTX2UASTCSupercompression(true);
      basisEncoder.setKTX2SRGBTransferFunc(true);
      basisEncoder.setSliceSourceImage(0, image.data, image.width, image.height, false);
      basisEncoder.setPerceptual(useSRGB);
      basisEncoder.setMipSRGB(useSRGB);
      basisEncoder.setQualityLevel(qualityLevel);
      basisEncoder.setUASTC(encodeUASTC);
      basisEncoder.setMipGen(mipmaps);
      const numOutputBytes = basisEncoder.encode(basisFileData);
      const actualKTX2FileData = basisFileData.subarray(0, numOutputBytes).buffer;
      return actualKTX2FileData;
    } catch (error) {
      console.error("Basis Universal Supercompressed GPU Texture encoder Error: ", error);
      throw error;
    } finally {
      basisEncoder.delete();
    }
  }

  // ../../node_modules/@loaders.gl/textures/dist/esm/ktx2-basis-universal-texture-writer.js
  var KTX2BasisUniversalTextureWriter = {
    name: "Basis Universal Supercompressed GPU Texture",
    id: "ktx2-basis-supercompressed-texture",
    module: "textures",
    version: VERSION,
    extensions: ["ktx2"],
    options: {
      useSRGB: false,
      qualityLevel: 10,
      encodeUASTC: false,
      mipmaps: false
    },
    encode: encodeKTX2BasisTexture
  };

  // core/textures/KTX2Worker.ts
  var worker = self;
  worker.onmessage = async (msg) => {
    try {
      const texture = await KTX2BasisUniversalTextureWriter.encode(msg.data, {
        useSRGB: true,
        encodeUASTC: true,
        mipmaps: true
      });
      const response = { texture };
      worker.postMessage(response, [texture]);
    } catch (err) {
      worker.postMessage({ error: err.message });
    }
  };
})();
`,Ns=class{constructor(a=4){r(this,"limit");r(this,"queue",[]);r(this,"workers",[]);r(this,"workersResolve",[]);r(this,"workerStatus",0);r(this,"workerCreator");this.limit=a}_initWorker(a){if(!this.workers[a]){const e=this.workerCreator();e.addEventListener("message",this._onMessage.bind(this,a)),this.workers[a]=e}}_getIdleWorker(){for(let a=0;a<this.limit;a++)if(!(this.workerStatus&1<<a))return a;return-1}_onMessage(a,e){const t=this.workersResolve[a];if(t&&t(e),this.queue.length){const{resolve:s,msg:i,transfer:n}=this.queue.shift();this.workersResolve[a]=s,this.workers[a].postMessage(i,n)}else this.workerStatus^=1<<a}setWorkerCreator(a){this.workerCreator=a}setWorkerLimit(a){this.limit=a}postMessage(a,e){return new Promise(t=>{const s=this._getIdleWorker();s!==-1?(this._initWorker(s),this.workerStatus|=1<<s,this.workersResolve[s]=t,this.workers[s].postMessage(a,e)):this.queue.push({resolve:t,msg:a,transfer:e})})}dispose(){this.workers.forEach(a=>a.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}},Is=new Blob([As],{type:"text/javascript"}),Ps=URL.createObjectURL(Is),Fs=class{constructor(){r(this,"pool",new Ns(1));this.pool.setWorkerCreator(()=>new Worker(Ps))}setWorkerLimit(a){this.pool.setWorkerLimit(a)}async encode(a){const e=await this.pool.postMessage(a,[a.data.buffer]);if(e.data.error)throw new Error(e.data.error);if(!e.data.texture)throw new Error("Encoding failed");return e.data.texture}};async function Us(a){if(g.embeddedCSSMap.has(a))return g.embeddedCSSMap.get(a);const e=await fetch(a,{headers:{accept:"text/css"}}),t=await Se(a,await e.text());return g.embeddedCSSMap.set(a,t),g.embeddedCSSMap.get(a)}async function Se(a,e){let t;const s=[];e=e.replace(new RegExp(":hover","g"),g.attributeCSS(g.HOVER_ATTRIBUTE)),e=e.replace(new RegExp(":active","g"),g.attributeCSS(g.ACTIVE_ATTRIBUTE)),e=e.replace(new RegExp(":focus","g"),g.attributeCSS(g.FOCUS_ATTRIBUTE)),e=e.replace(new RegExp(":target","g"),g.attributeCSS(g.TARGET_ATTRIBUTE));const i=RegExp(/(@import.*?["']([^"']+)["'].*?|url\((?!['"]?(?:data):)['"]?([^'"\)]*)['"]?\))/gi);for(;t=i.exec(e);){const o=!!t[2]?"type/css":void 0,l=t[2]||t[3];s.push(nt(new URL(l,a).href,o).then(c=>{e=e.replace(l,c)}))}return await Promise.all(s),e}async function nt(a,e){if(a.startsWith("data"))return a;if(g.dataURLMap.has(a))return g.dataURLMap.get(a);const t=new Promise(async s=>{const i=await fetch(a,e?{headers:{accept:e}}:void 0),n=i.headers.get("content-type");if(n=="text/css"){const o=await Se(a,await i.text());g.embeddedCSSMap.set(a,o),s("data:"+n+";base64,"+window.btoa(o))}else{const o=new Uint8Array(await i.arrayBuffer());s("data:"+n+";base64,"+g.arrayBufferToBase64(o))}});return g.dataURLMap.set(a,t),t}function ks(a){return a.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g,"")}function at(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function Vs(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function W(a,e){return" "+a+'="'+at(e)+'"'}function js(a,e){return!a.hasAttribute("xmlns")&&(e||a.namespaceURI!==a.parentElement.namespaceURI)?' xmlns="'+a.namespaceURI+'"':""}async function ot(a,e){let t=[];for(const s of a.childNodes)t.push(ct(s,e));return Promise.all(t).then(s=>s.join(""))}async function Ws(a,e){const t=a.tagName.toLowerCase();let s="<"+t;s+=js(a,e.depth===0);const i=ot(a,e);for(const n of a.attributes)n.name==="src"?a.nodeName==="IMG"?s+=W(n.name,await nt(n.value)):s+=W("data-src",n.value):s+=W(n.name,n.value);return a.childNodes.length>0?(e.depth++,s+=">",s+=await i,s+="</"+t+">",e.depth--):s+="/>",s}function qs(a){var e=a.nodeValue||"";return Vs(e)}function Hs(a){return"<![CDATA["+a.nodeValue+"]]>"}async function ct(a,e){var s;const t=(s=e.replacer)==null?void 0:s.call(e,e.target,a);if(typeof t=="string")return t;if(a.nodeName==="#document"||a.nodeName==="#document-fragment")return ot(a,e);if(a.tagName)return Ws(a,e);if(a.nodeName==="#text")return qs(a);if(a.nodeName!=="#comment"){if(a.nodeName==="#cdata-section")return Hs(a)}return""}async function $s(a,e=Gs){return ks(await ct(a,{depth:0,target:a,replacer:e}))}const Gs=(a,e)=>{var l;if(a===e||e.nodeType!==Node.ELEMENT_NODE)return;const t=e,s=(l=t.tagName)==null?void 0:l.toLowerCase(),i=getComputedStyle(t),n=i.display==="inline"||i.display==="inline-block";if(s==="style"||s==="link")return"";if(n)return;const o=g.layers.get(t);if(o){o.manager.updateDOMMetrics(o);const c=o.domMetrics.bounds;let u="";const h=`box-sizing:border-box;max-width:${c.width}px;max-height:${c.height}px;min-width:${c.width}px;min-height:${c.height}px;visibility:hidden`;let p=!1;for(const m of o.element.attributes)m.name!=="src"&&(m.name=="style"?(u+=W(m.name,m.value+";"+h),p=!0):u+=W(m.name,m.value));p||(u+=W("style",h));const d=t.tagName.toLowerCase();return`<${d} ${u}></${d}>`}};function Qs(a,e,t,s,i){const n=[],o=[];a.manager.updateDOMMetrics(a);const l=a.domMetrics;let c=a.element.parentElement;c||(c=document.documentElement);do{let u=c.tagName.toLowerCase(),h=" ",p="";for(const f of c.attributes){const w=at(f.value);if(f.name==="style"){p=w;continue}h+=`${f.name}="${w}" `}const d="<"+u+(u==="html"?` ${g.RENDERING_DOCUMENT_ATTRIBUTE}="" xmlns="http://www.w3.org/1999/xhtml"
                    style="${Ks(s/e,i/t)} --x-width:${l.bounds.width}px; --x-height:${l.bounds.height}px; ${p} width:${e}px; height:${t}px;" `:` style="${p}" ${g.RENDERING_PARENT_ATTRIBUTE}="" `)+h+" >";n.unshift(d);const m="</"+u+">";if(o.push(m),u=="html")break}while(c=c!==document.documentElement?c.parentElement||document.documentElement:null);return[n.join(""),o.join("")]}function Ks(a,e){return`transform: scale(${a},${e}); transform-origin: top left; `}const lt=new Array(255);for(let a=0;a<=255;++a){const e=a.toString(16).padStart(2,"0");lt[a]=e}function Xs(a){const e=a.length;let t="";for(let s=0;s<e;++s)t+=lt[a[s]];return t}function ye(a){return Xs(new Uint8Array(a))}async function Ys(a){const e=a.getRootNode(),t=g.embeddedStyles,s=Array.from(e.querySelectorAll("style, link[type='text/css'], link[rel='stylesheet']")),i=a.getRootNode()instanceof ShadowRoot,n=[];for(const o of s)t.has(o)||t.set(o,new Promise(l=>{o.tagName.toLowerCase()==="style"?l(Se(window.location.href,o.textContent||"")):l(Us(o.href))}).then(async l=>{const c=RegExp(/@font-face[^{]*{([^{}]|{[^{}]*})*}/gi),u=l.match(c);if(i&&u)for(const p of u){if(g.fontStyles.has(p))continue;const d=document.createElement("style");d.innerHTML=p,document.head.appendChild(d),g.fontStyles.set(p,d),t.set(d,Promise.resolve({serialized:"",hash:""}))}const h=await crypto.subtle.digest("SHA-1",g.textEncoder.encode(l));return{serialized:l,hash:ye(h)}})),n.push(t.get(o));return Promise.all(n)}const Zs=new _;class Js extends Wt{constructor(e){super(e);r(this,"states");r(this,"textures");this.version(3).stores({states:"&hash",textures:"&hash, timestamp"})}}function ei(a){return 1<<31-Math.clz32(a)}function Fe(a){return ei((a-1)*2)}class ti{constructor(e="ethereal-web-store"){r(this,"MINIMUM_RENDER_ATTEMPTS",3);r(this,"MAX_SERIALIZE_TASK_COUNT",10);r(this,"MAX_RASTERIZE_TASK_COUNT",5);r(this,"tasksPending",!1);r(this,"serializePendingCount",0);r(this,"rasterizePendingCount",0);r(this,"WebRenderer",g);r(this,"autosave",!0);r(this,"autosaveDelay",10*1e3);r(this,"_autosaveTimer");r(this,"pixelsPerMeter",1e3);r(this,"store");r(this,"serializeQueue",[]);r(this,"rasterizeQueue",[]);r(this,"optimizeQueue",[]);r(this,"ktx2Encoder",new Fs);r(this,"_unsavedTextureData",new Map);r(this,"_stateData",new Map);r(this,"_textureData",new Map);r(this,"_imagePool",[]);r(this,"_packr",new Vt({structuredClone:!0}));r(this,"_unpackr",new jt({structuredClone:!0}));r(this,"_statesRequestedFromStore",new Set);r(this,"_texturesRequestedFromStore",new Set);r(this,"_runTasks",()=>{const e=this.serializeQueue,t=this.rasterizeQueue;for(;e.length>0&&this.serializePendingCount<this.MAX_SERIALIZE_TASK_COUNT;){this.serializePendingCount++;const{layer:s,resolve:i}=e.shift();this.serialize(s).then(n=>{this.serializePendingCount--,i(n)})}for(;t.length>0&&this.rasterizePendingCount<this.MAX_RASTERIZE_TASK_COUNT;){this.rasterizePendingCount++;const{hash:s,svgUrl:i,resolve:n}=t.shift();this.rasterize(s,i).finally(()=>{this.rasterizePendingCount--,n(void 0),this._autosaveTimer&&clearTimeout(this._autosaveTimer),this.autosave&&this._unsavedTextureData.size&&(this._autosaveTimer=setTimeout(()=>{this.saveStore()},this.autosaveDelay/this._unsavedTextureData.size))})}this.tasksPending=!1});this.store=new Js(e)}get pixelPerUnit(){return this.pixelsPerMeter}saveStore(){const e=Array.from(this._stateData.entries()).filter(([s,i])=>typeof s=="string").map(([s,i])=>{var n;return{hash:s,textureHash:(n=i.texture)==null?void 0:n.hash}}),t=Array.from(this._unsavedTextureData.values());return this._unsavedTextureData.clear(),this.loadIntoStore({stateData:e,textureData:t})}async importCache(e){try{const s=await(await fetch(e)).arrayBuffer(),i=await new Promise((o,l)=>{ze(new Uint8Array(s),{consume:!0},(c,u)=>{if(c)return l(c);o(u)})}),n=this._unpackr.unpack(i);return n.textureData=n.textureData.filter(o=>o&&o.hash&&o.texture),console.log(`Importing weblayer cache data from ${e} with `+n.stateData.length+" states and "+n.textureData.length+" textures"),console.log(n),this.loadIntoStore(n)}catch(t){console.warn("Failed to import cache",t)}}getActiveStateHashes(){return Array.from(this._stateData.keys()).filter(e=>typeof e=="string")}async exportCache(e=this.getActiveStateHashes()){const t=await this.store.states.bulkGet(e);let s=await this.store.textures.bulkGet(t.map(o=>o.textureHash).filter(o=>typeof o=="string"));s=s.filter(o=>o&&typeof o.hash=="string"&&o.texture);const i={stateData:t,textureData:s},n=this._packr.pack(i);return new Promise((o,l)=>{Ce(n,{consume:!0},(c,u)=>{if(c)return l(c);o(new Blob([u.buffer]))})})}async downloadCache(){var s;await this.saveStore();const e=await this.exportCache(),t=location.pathname.split("/").filter(i=>i);rt(e,"web."+location.host+"."+((s=t[t.length-1])!=null?s:"")+".cache")}async loadIntoStore(e){for(const t of e.textureData){const s=this._textureData.get(t.hash)||{hash:t.hash,canvas:void 0,ktx2Url:void 0};!s.ktx2Url&&t.texture&&(s.ktx2Url=URL.createObjectURL(new Blob([t.texture],{type:"image/ktx2"})))}for(const t of e.stateData){const s=this.getLayerState(t.hash);if(!s.texture&&t.textureHash){const i=this._textureData.get(t.textureHash);s.texture=i}}return Promise.all([this.store.states.bulkPut(e.stateData),this.store.textures.bulkPut(e.textureData)])}getLayerState(e){let t=this._stateData.get(e);return t||(t={cssTransform:void 0,bounds:new Y,margin:new U,padding:new U,border:new U,fullWidth:0,fullHeight:0,renderAttempts:0,textureWidth:32,textureHeight:32,pixelRatio:1,texture:void 0,pseudo:{hover:!1,active:!1,focus:!1,target:!1}},this._stateData.set(e,t)),t}getTextureState(e){let t=this._textureData.get(e);return t||(t={hash:e,canvas:void 0,ktx2Url:void 0},this._textureData.set(e,t)),t}async requestStoredData(e){const t=this.getLayerState(e);if(typeof e!="string")return t;if(!this._statesRequestedFromStore.has(e)){this._statesRequestedFromStore.add(e);const i=await this.store.states.get(e);(i==null?void 0:i.textureHash)&&(t.texture=this.getTextureState(i.textureHash))}const s=t.texture;if(s&&s.hash&&!s.canvas&&!s.ktx2Url&&!this._texturesRequestedFromStore.has(s==null?void 0:s.hash)){this._texturesRequestedFromStore.add(s.hash);const i=await this.store.textures.get(s.hash);if((i==null?void 0:i.texture)&&!s.canvas){const n=await new Promise((o,l)=>{ze(i.texture,{consume:!0},(c,u)=>{if(c)return l(c);o(u)})});s.canvas||(s.ktx2Url=URL.createObjectURL(new Blob([n.buffer],{type:"image/ktx2"})))}}return t}async compressTexture(e){const t=this._textureData.get(e),s=t==null?void 0:t.canvas;if(!s)throw new Error("Missing texture canvas");if(this.ktx2Encoder.pool.limit===0)return;const i=this.getImageData(s);let n;try{n=await this.ktx2Encoder.encode(i)}catch(c){console.error(`KTX2 encoding failed for image (${s.width}, ${s.height}) `,c),this.ktx2Encoder.pool.dispose();return}const o=this._unsavedTextureData.get(e)||{hash:e,timestamp:Date.now(),texture:void 0};t.ktx2Url=URL.createObjectURL(new Blob([n],{type:"image/ktx2"}));const l=await new Promise((c,u)=>{Ce(new Uint8Array(n),{consume:!0},(h,p)=>{if(h)return u(h);c(p)})});o.texture=l,this._unsavedTextureData.set(e,o)}scheduleTasksIfNeeded(){this.tasksPending||this.serializeQueue.length===0&&this.rasterizeQueue.length===0||(this.tasksPending=!0,setTimeout(this._runTasks,1))}addToSerializeQueue(e){const t=this.serializeQueue.find(n=>n.layer===e);if(t)return t.promise;let s;const i=new Promise(n=>{s=n});return this.serializeQueue.push({layer:e,resolve:s,promise:i}),i}updateDOMMetrics(e){var s;const t=e.domMetrics;ve(e.element,t.bounds,(s=e.parentLayer)==null?void 0:s.element),Ss(e.element,t.margin),Ts(e.element,t.padding),Ms(e.element,t.border)}async serialize(e){var Z;this.updateDOMMetrics(e);const t=e.element,s=e.domMetrics,{top:i,left:n,width:o,height:l}=s.bounds,{top:c,left:u,bottom:h,right:p}=s.margin,d=o+Math.max(u,0)+Math.max(p,0),m=l+Math.max(c,0)+Math.max(h,0),f=e.computedPixelRatio,w=Math.max(Fe(d*f),32),x=Math.max(Fe(m*f),32),b={};let T;const S=getComputedStyle(t),M=S.transform;let C=null;if(M&&M!=="none"){const J=1/this.pixelsPerMeter;C=Bs(S,o,l,J,Zs)}if(e.isMediaElement)b.stateKey=t;else{const J=g.attributeHTML(g.LAYER_ATTRIBUTE,""),ut=S.display==="inline";g.updateInputAttributes(t);const ee=Qs(e,d,m,w,x),Me=await Ys(t);let te=await $s(t);te=te.replace(J,`${J} ${g.RENDERING_ATTRIBUTE}="" ${ut?`${g.RENDERING_INLINE_ATTRIBUTE}="" `:" "} `+g.getPsuedoAttributes(e.desiredPseudoState));const ht=[...Me.map(de=>de.hash),ee[0],te,ee[1]].join(`
`),dt=await crypto.subtle.digest("SHA-1",g.textEncoder.encode(ht)),mt=ye(dt)+"?w="+d+";h="+m+";tw="+w+";th="+x;b.stateKey=mt,T='<svg width="'+w+'" height="'+x+`" xmlns="http://www.w3.org/2000/svg"><defs><style type="text/css"><![CDATA[
`+Me.map(de=>de.serialized).join(`
`)+']]></style></defs><foreignObject x="0" y="0" width="'+w+'" height="'+x+'">'+ee[0]+te+ee[1]+"</foreignObject></svg>"}const L=await this.requestStoredData(b.stateKey);return L.cssTransform=C==null?void 0:C.clone(),L.bounds.left=n,L.bounds.top=i,L.bounds.width=o,L.bounds.height=l,L.margin.left=u,L.margin.top=c,L.margin.right=p,L.margin.bottom=h,L.fullWidth=d,L.fullHeight=m,L.pixelRatio=f,L.textureWidth=w,L.textureHeight=x,e.desiredDOMStateKey=b.stateKey,typeof b.stateKey=="string"&&e.allStateHashes.add(b.stateKey),b.needsRasterize=!e.isMediaElement&&d*m>0&&!((Z=L.texture)==null?void 0:Z.hash),b.svgUrl=b.needsRasterize&&T?"data:image/svg+xml;utf8,"+encodeURIComponent(T):void 0,e.lastSVGUrl=b.svgUrl,b}async rasterize(e,t){var T;const s=this.getLayerState(e),i=this._imagePool.pop()||new Image,{fullWidth:n,fullHeight:o,textureWidth:l,textureHeight:c,pixelRatio:u}=s;if(await new Promise((S,M)=>{i.onload=()=>{S()},i.onerror=C=>{M(C)},i.width=l,i.height=c,i.src=t}),!i.complete||i.currentSrc!==t)throw new Error("Rasterization Failed");await i.decode();const h=n*u,p=o*u,d=await this.rasterizeToCanvas(i,h,p,30,30),m=this.getImageData(d),f=await crypto.subtle.digest("SHA-1",m.data),w=ye(f)+"?w="+l+";h="+c;((T=s.texture)==null?void 0:T.hash)!==w&&(s.renderAttempts=0),s.renderAttempts++,s.texture=this.getTextureState(w);const b=s.texture.canvas||s.texture.ktx2Url;if(!(s.renderAttempts>this.MINIMUM_RENDER_ATTEMPTS&&b)&&(setTimeout(()=>this.addToRasterizeQueue(e,t),(500+Math.random()*1e3)*2^s.renderAttempts),!s.texture.canvas)){s.texture.canvas=await this.rasterizeToCanvas(i,h,p,l,c);try{await this.compressTexture(w)}finally{this._imagePool.push(i)}}}async rasterizeToCanvas(e,t,s,i,n,o){o=o||document.createElement("canvas"),o.width=i,o.height=n;const l=o.getContext("2d");return l.imageSmoothingEnabled=!0,l.imageSmoothingQuality="high",l.drawImage(e,0,0,i,n),o}getImageData(e){return e.getContext("2d").getImageData(0,0,e.width,e.height)}addToRasterizeQueue(e,t){const s=this.rasterizeQueue.find(o=>o.hash===e);if(s)return s.promise;let i;const n=new Promise(o=>{i=o});return this.rasterizeQueue.push({hash:e,svgUrl:t,resolve:i,promise:n}),n}optimizeImageData(e){}addToOptimizeQueue(e){}}const F=class extends ti{constructor(){super();r(this,"renderer");r(this,"textureEncoding",qt);r(this,"ktx2Loader",new Ht);r(this,"texturesByHash",new Map);r(this,"layersByElement",new WeakMap);r(this,"layersByMesh",new WeakMap);r(this,"_compressedTexturePromise",new Map);r(this,"_canvasTexturePromise",new Map);this.ktx2Loader.setTranscoderPath(F.DEFAULT_TRANSCODER_PATH)}static initialize(e){F.instance=new F,F.instance.renderer=e,F.instance.ktx2Loader.detectSupport(e),F.instance.ktx2Encoder.setWorkerLimit(1)}getTexture(e){const t=this.getTextureState(e);return this.texturesByHash.has(e)||this.texturesByHash.set(e,{}),this._loadCompressedTextureIfNecessary(t),this._loadCanvasTextureIfNecessary(t),this.texturesByHash.get(e)}_loadCompressedTextureIfNecessary(e){const t=e.ktx2Url;!t||this._compressedTexturePromise.has(e.hash)||new Promise(s=>{this._compressedTexturePromise.set(e.hash,s),this.ktx2Loader.loadAsync(t).then(i=>{i.wrapS=V,i.wrapT=V,i.minFilter=Be,i.encoding=this.textureEncoding,this.texturesByHash.get(e.hash).compressedTexture=i}).finally(()=>{s(void 0)})})}_loadCanvasTextureIfNecessary(e){var i;const t=this.texturesByHash.get(e.hash);if(t.compressedTexture){(i=t.canvasTexture)==null||i.dispose(),t.canvasTexture=void 0;return}const s=e.canvas;if(!!s&&!t.canvasTexture&&!t.compressedTexture){const n=new je(s);n.wrapS=V,n.wrapT=V,n.minFilter=Be,n.encoding=this.textureEncoding,n.flipY=!1,t.canvasTexture=n}}};let oe=F;r(oe,"DEFAULT_TRANSCODER_PATH","https://unpkg.com/@loaders.gl/textures@3.1.7/dist/libs/"),r(oe,"instance");const Ue=new le,ke=new le,si=new Y;class ai extends se{constructor(e,t={}){super();r(this,"containerElement");r(this,"options");r(this,"rootLayer");r(this,"raycaster",new $t);r(this,"_interactionRays",[]);r(this,"_hitIntersections",[]);r(this,"_previousHoverLayers",new Set);r(this,"_contentMeshes",[]);r(this,"_prepareHitTest",e=>{e.desiredPseudoStates.hover&&this._previousHoverLayers.add(e),e.cursor.visible=!1,e.desiredPseudoStates.hover=!1,e.contentMesh.visible&&this._contentMeshes.push(e.contentMesh)});t.manager||(t.manager=oe.instance),this.options=t;const s=typeof e=="string"?Es(e):e;this.containerElement=g.createLayerTree(s,t,(i,{target:n})=>{var o,l,c,u;if(i==="layercreated"){const h=n.layer||new ae(n,this);n===s?(h[ge]=()=>this._updateInteractions(),this.rootLayer=h,this.add(h)):(o=h.parentWebLayer)==null||o.add(h),(c=(l=this.options).onLayerCreate)==null||c.call(l,h)}else if(i==="layermoved"){const h=this.options.manager.layersByElement.get(n);(u=h.parentWebLayer)==null||u.add(h)}}),this.containerElement.container=this,this.refresh(),this.update()}get manager(){return this.options.manager}get interactionRays(){return this._interactionRays}set interactionRays(e){this._interactionRays=e}async updateUntilReady(){const e=setInterval(()=>{this.update()},20);this.rootLayer.setNeedsRefresh(!0),await this.rootLayer.refresh(!0),clearInterval(e)}update(){this.rootLayer.update(!0)}refresh(){this.rootLayer.refresh(!0)}querySelector(e){return this.rootLayer.querySelector(e)}get contentMesh(){return this.rootLayer.contentMesh}_intersectionSort(e,t){const s=e.object.parent,i=t.object.parent;return s.depth!==i.depth?i.depth-s.depth:i.index-s.index}_updateInteractions(){const e=this._previousHoverLayers;e.clear(),this._contentMeshes.length=0,this.rootLayer.traverseLayersPreOrder(this._prepareHitTest);for(const t of this._interactionRays){"isObject3D"in t&&t.isObject3D?this.raycaster.ray.set(t.getWorldPosition(Ue),t.getWorldDirection(ke).negate()):this.raycaster.ray.copy(t),this._hitIntersections.length=0;const s=this.raycaster.intersectObjects(this._contentMeshes,!1,this._hitIntersections);s.sort(this._intersectionSort);const i=s[0];if(i){const n=i.object.parent;n.cursor.position.copy(i.point),n.cursor.visible=!0,n.desiredPseudoStates.hover=!0,e.has(n)||n.setNeedsRefresh()}}for(const t of e)t.desiredPseudoStates.hover||t.setNeedsRefresh()}hitTest(e){const t=this.raycaster,s=this._hitIntersections,i=this.options.manager.layersByMesh;"isObject3D"in e&&e.isObject3D?this.raycaster.ray.set(e.getWorldPosition(Ue),e.getWorldDirection(ke).negate()):this.raycaster.ray.copy(e),s.length=0,t.intersectObject(this,!0,s),s.sort(this._intersectionSort);for(const n of s){const o=i.get(n.object);if(!o)continue;const l=o.bounds,c=o.margin,u=l.width+c.left+c.right,h=l.height+c.top+c.bottom;if(u*h===0)continue;let p=o.element;const d=n.uv.x*u-c.left,m=n.uv.y*h-c.top;return ce(o.element,f=>{if(!p.contains(f))return!1;const w=ve(f,si,o.element),{left:x,top:b,width:T,height:S}=w,M=x+T,C=b+S;return d>x&&d<M&&m>b&&m<C?(p=f,!0):!1}),{layer:o,intersection:n,target:p}}}destroy(){this.containerElement.remove(),this.removeFromParent(),this.rootLayer.dispose()}async downloadCache(e){await this.manager.saveStore();const t=new Set;this.rootLayer.traverseLayersPreOrder(i=>{if(!(e&&!e(i)))for(const n of i.allStateHashes)t.add(n)});const s=await this.manager.exportCache(Array.from(t));rt(s,"web."+this.rootLayer.element.id+".cache")}}export{be as Q,_s as S,A as V,ai as W,Xt as a,_e as b,xs as c,oe as d,ni as e,Xe as f};
