var ji=Object.defineProperty;var Wi=(n,e,t)=>e in n?ji(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var c=(n,e,t)=>(Wi(n,typeof e!="symbol"?e+"":e,t),t);import{w as se,x as A,y as q,z as F,F as Z,H as nt,J as mr,K as H,U as K,X as dn,Y as qi,Z as Hi,_ as $i,$ as Gi,a0 as Qi,a1 as Xi,a2 as Yi,a3 as Zi,a4 as Ji,a5 as es,a6 as ts,a7 as ns,a8 as rs,a9 as is,aa as ss,ab as as,ac as os,ad as us,ae as Bt,af as cs,m as Ot,ag as ls,O as Dt,q as yr,M as gr,r as vr,n as hs,ah as fs,ai as It,aj as br,ak as ds,al as ps,am as ms,an as ys,ao as gs,i as vs}from"./vendor.js";const bs=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerpolicy&&(s.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?s.credentials="include":i.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}};bs();const wr=Object.freeze(new se(0,0)),ws=Object.freeze(new se(1,1)),ae=Object.freeze(new A(0,0,0)),_s=Object.freeze(new A(1,0,0)),xs=Object.freeze(new A(0,1,0)),Ss=Object.freeze(new A(0,0,1)),pn=Object.freeze(new A(1,1,1)),mn=Object.freeze(new q),rt={RIGHT:Object.freeze(new A(1,0,0)),UP:Object.freeze(new A(0,1,0)),NEAR:Object.freeze(new A(0,0,1)),LEFT:Object.freeze(new A(-1,0,0)),DOWN:Object.freeze(new A(0,-1,0)),FAR:Object.freeze(new A(0,0,-1))};function yn(n,e){return typeof n=="number"?Ts(n,e):"isVector3"in n?Ms(n,e):"isVector2"in n?Es(n,e):"isBox3"in n?Rs(n,e):"isQuaternion"in n?Cs(n,e):"isColor"in n?As(n,e):1/0}function Ts(n,e){if(e===n)return 0;const t=Math.abs(e-n),r=(Math.abs(e)+Math.abs(n))/2;return t/r}function Ms(n,e){if(e.equals(n))return 0;const t=e.distanceTo(n),r=(e.length()+n.length())/2;return t/r}function Es(n,e){if(e.equals(n))return 0;const t=e.distanceTo(n),r=(e.length()+n.length())/2;return t/r}function Rs(n,e){if(n.equals(e))return 0;const t=_r,r=e.min.distanceTo(n.min),i=e.max.distanceTo(n.max),s=(r+i)/2,a=(e.getSize(t).length()+n.getSize(t).length())/2;return s/a}const _r=new A;function Cs(n,e){return n.equals(e)?0:n.angleTo(e)/Math.PI}function As(n,e){return n.equals(e)?0:_r.set(Math.abs(e.r-n.r),Math.abs(e.g-n.g),Math.abs(e.b-n.b)).length()/Bs}const Bs=Math.sqrt(3),it=(n=1)=>{var e=Math.random();return(e%1e-8>5e-9?1:-1)*Math.sqrt(-Math.log(Math.max(1e-9,e)))*n},gn=(n=1)=>{const e=Math.sqrt(Math.sqrt(1/(2*n)));return 1/it(e)**2},zt=(()=>{const n=Math.PI*2,e=new A(0,0,1),t=new q,r=new q,i=new A,s=new q;return function(u=1,o=1){var l=(Math.random()-.5)*n*u,p=Math.random()*n,m=Math.random()*Math.PI*o;return i.set(1,0,0).applyAxisAngle(e,p),t.setFromAxisAngle(e,l),r.setFromAxisAngle(i,m),s.multiplyQuaternions(r,t)}})();function xr(n,e){let t=0;for(let i=0;i<n.length;i++)t+=(e==null?void 0:e[i])||1;const r=Math.random()*t;t=0;for(let i=0;i<n.length;i++)if(t+=(e==null?void 0:e[i])||1,t>r)return n[i];return n[0]}const Os=(()=>{const n=new A;return function(t,r,i){const s=n.set(t.x,t.y,t.z),a=r.dot(s),u=n.copy(r).multiplyScalar(a),o=i.set(u.x,u.y,u.z,t.w).normalize();return a<0&&(o.x=-o.x,o.y=-o.y,o.z=-o.z,o.w=-o.w),o}})();class Lt{constructor(){c(this,"callbacks",[])}memoize(e,...t){t.push(this);const r=Ds(e);for(const i of t)i.callbacks.push(r);return r}invalidateAll(){const e=this.callbacks;for(let t=0;t<this.callbacks.length;t++)e[t].needsUpdate=!0}isFullyInvalid(){const e=this.callbacks;for(let t=0;t<this.callbacks.length;t++)if(!e[t].needsUpdate)return!1;return!0}}const Sr=void 0;function Ds(n){let e=Sr;const t=()=>{if(t.needsUpdate&&(t.needsUpdate=!1,e=n()),e===Sr)throw new Error("Possible recursive memoization detected");return e};return t.needsUpdate=!0,t}const Pt=Symbol("current"),kt=Symbol("target"),Tr=Symbol("previousTarget");class Mr{constructor(e,t){this.mode=e,this.metrics=t}}const Je=class extends Mr{constructor(e,t){super(e,t);c(this,"_cache",new Lt);c(this,"opacity",1);c(this,"_parent",null);c(this,"_localMatrix",new F);c(this,"_worldMatrix",new F);c(this,"_worldMatrixInverse",new F);c(this,"_worldPosition",new A);c(this,"_worldOrientation",new q);c(this,"_worldOrientationInverse",new q);c(this,"_worldScale",new A(1,1,1));c(this,"_worldRotation",new F);c(this,"_worldRotationInverse",new F);c(this,"_relativePosition",new A);c(this,"_relativeOrientation",new q);c(this,"_relativeScale",new A(1,1,1));c(this,"_cachedWorldCenter",this._cache.memoize(()=>this._worldCenter.copy(this.metrics.innerCenter).applyMatrix4(this.worldMatrix)));c(this,"_worldCenter",new A);c(this,"_cachedSpatialMatrix",this._cache.memoize(()=>{const e=this._worldFromSpatial.compose(this.outerOrigin,this.worldOrientation,pn);this._spatialFromWorld.copy(this._worldFromSpatial).invert(),this._localFromSpatial.multiplyMatrices(this.worldMatrixInverse,e),this._spatialFromLocal.copy(this._localFromSpatial).invert();const t=this.referenceState;return t?this._spatialFromReference.multiplyMatrices(this._spatialFromWorld,t.worldMatrix):this._spatialFromReference.copy(this._spatialFromWorld),e}));c(this,"_worldFromSpatial",new F);c(this,"_spatialFromWorld",new F);c(this,"_localFromSpatial",new F);c(this,"_spatialFromLocal",new F);c(this,"_spatialFromReference",new F);c(this,"_cachedSpatialBounds",this._cache.memoize(()=>{this._spatialBounds.copy(this.metrics.innerBounds);const e=this._spatialBounds.applyMatrix4(this.spatialFromLocal);return e.getCenter(this._spatialCenter),e.getSize(this._spatialSize),e}));c(this,"_spatialBounds",new Z);c(this,"_spatialSize",new A);c(this,"_spatialCenter",new A);c(this,"_cachedOuterBounds",this._cache.memoize(()=>{const e=this._outerBounds,t=this.metrics.system.nodeAdapters.get(this.metrics.node);if(t)e.copy(t.outerBounds[this.mode]);else{const r=this.referenceState;r?e.copy(r.metrics.innerBounds):e.setFromCenterAndSize(ae,ae),e.applyMatrix4(this.spatialFromReference)}return e.getCenter(this._outerCenter),e.getSize(this._outerSize),e}));c(this,"_outerBounds",new Z);c(this,"_outerCenter",new A);c(this,"_outerSize",new A);c(this,"_cachedOuterVisualBounds",this._cache.memoize(()=>{const e=this._outerVisualBounds,t=this.metrics.system.nodeAdapters.get(this.metrics.node);if(t)e.copy(t.outerVisualBounds[this.mode]);else{const r=this.referenceState;r?e.copy(r.visualBounds):e.setFromCenterAndSize(ae,ae)}return e.getCenter(this._outerVisualCenter),e.getSize(this._outerVisualSize),e}));c(this,"_outerVisualBounds",new Z);c(this,"_outerVisualCenter",new A);c(this,"_outerVisualSize",new A);c(this,"_viewFromWorld",new F);c(this,"_viewFromSpatial",new F);c(this,"_spatialFromView",new F);c(this,"_cachedNDCBounds",this._cache.memoize(()=>{if(this.metrics.system.viewNode===this.metrics.node)return this._ndcBounds.min.setScalar(-1),this._ndcBounds.max.setScalar(1),this._ndcBounds;const t=this.metrics.system.viewFrustum.perspectiveProjectionMatrix,r=this.viewFromWorld,i=this._viewProjectionFromWorld.multiplyMatrices(t,r),s=this._ndcBounds.copy(this.metrics.innerBounds).applyMatrix4(i);return s.getCenter(this._ndcCenter),s.getSize(this._ndcSize),(!isFinite(s.min.x)||!isFinite(s.min.y)||!isFinite(s.min.z)||!isFinite(s.max.x)||!isFinite(s.max.y)||!isFinite(s.max.z))&&(s.min.setScalar(-1),s.max.setScalar(1),s.getCenter(this._ndcCenter),s.getSize(this._ndcSize)),s},this._viewState._cache));c(this,"_viewProjectionFromWorld",new F);c(this,"_ndcBounds",new Z);c(this,"_ndcCenter",new A);c(this,"_ndcSize",new A);c(this,"_cachedVisualBounds",this._cache.memoize(()=>{const e=this.metrics.system,t=e.viewFrustum.perspectiveProjectionMatrix,r=this._inverseProjection.copy(t).invert(),i=this._visualBounds.copy(this.ndcBounds),s=this._v1,a=s.set(0,0,i.min.z).applyMatrix4(r).z,u=s.set(0,0,i.max.z).applyMatrix4(r).z;return i.min.z=u,i.max.z=a,i.min.x*=.5*e.viewResolution.x,i.max.x*=.5*e.viewResolution.x,i.min.y*=.5*e.viewResolution.y,i.max.y*=.5*e.viewResolution.y,i.getCenter(this._visualCenter),i.getSize(this._visualSize),i},this._viewState._cache));c(this,"_visualBounds",new Z);c(this,"_visualCenter",new A);c(this,"_visualSize",new A);c(this,"_v1",new A);c(this,"_inverseProjection",new F);c(this,"_viewPosition",new A);c(this,"_cachedViewAlignedOrientation",this._cache.memoize(()=>{const e=this._relativeViewMatrix.multiplyMatrices(this.worldMatrixInverse,this._viewState.worldMatrix),t=this._relativeViewRotation.extractRotation(e),r=this._relativeViewOrientation.setFromRotationMatrix(t),i=this._relativeViewForward.set(0,0,1).applyQuaternion(r),s=this._relativeViewUp.set(0,1,0).applyQuaternion(r);let a=1/0,u=1/0,o,l,p;for(p in rt){const h=rt[p];var m=s.distanceToSquared(h);m<u&&(u=m,l=h)}for(p in rt){const h=rt[p];if(h.x&&l.x||h.y&&l.y||h.z&&l.z)continue;const d=i.distanceToSquared(h);d<a&&(a=d,o=h)}const f=this._orthogonalRotation.identity();return f.lookAt(o,ae,l),this._orthogonalOrientation.setFromRotationMatrix(f)},this._viewState._cache));c(this,"_relativeViewMatrix",new F);c(this,"_relativeViewRotation",new F);c(this,"_relativeViewOrientation",new q);c(this,"_relativeViewUp",new A);c(this,"_relativeViewForward",new A);c(this,"_orthogonalRotation",new F);c(this,"_orthogonalOrientation",new q);c(this,"_computeOcclusion",this._cache.memoize(()=>{this._occludingPercent=0,this._occludedPercent=0;const e=this.metrics;if(e.innerBounds.isEmpty())return;const r=e.system.nodeAdapters.values(),i=this.visualBounds,s=i.min.z,a=Je._boxA,u=Je._boxB;a.min.set(i.min.x,i.min.y),a.min.set(i.max.x,i.max.y);const o=a.getSize(Je._sizeA).length();for(const l of r){const p=l.metrics;if(p===e||!p.isAdaptive||p.innerBounds.isEmpty()||p.containedByNode(l.node))continue;const f=(this.mode==="current"?p.current:p.target).visualBounds;a.min.set(i.min.x,i.min.y),a.min.set(i.max.x,i.max.y),u.min.set(f.min.x,f.min.y),u.min.set(f.max.x,f.max.y);const h=a.intersect(u).getSize(Je._sizeB).length()/o;h>0&&(s<f.min.z?this._occludingPercent+=h:this._occludedPercent+=h)}},this._viewState._cache));c(this,"_occludingPercent",0);c(this,"_occludedPercent",0)}invalidate(){this._cache.invalidateAll()}get parent(){return this._parent}set parent(e){this._parent!==e&&(this._parent=e,this.invalidate())}get parentState(){var e;return(e=this.metrics.parentMetrics)==null?void 0:e[this.mode]}get localMatrix(){var t;const e=(t=this.parentState)==null?void 0:t.worldMatrixInverse;return e?this._localMatrix.multiplyMatrices(e,this.worldMatrix):this._localMatrix.copy(this.worldMatrix)}get referenceState(){var e;return(e=this.metrics.referenceMetrics)==null?void 0:e[this.mode]}get worldMatrix(){return this._worldMatrix}set worldMatrix(e){if(isNaN(e.elements[0])||isNaN(e.elements[15])||e.elements[0]===0)throw new Error;this._worldMatrix.equals(e)||(this.invalidate(),this._worldMatrix.copy(e),this._worldMatrixInverse.copy(this._worldMatrix).invert(),this._worldMatrix.decompose(this._worldPosition,this._worldOrientation,this._worldScale),this._worldOrientationInverse.copy(this._worldOrientation).invert(),this._worldRotation.makeRotationFromQuaternion(this._worldOrientation),this._worldRotationInverse.makeRotationFromQuaternion(this._worldOrientationInverse))}get relativePosition(){var t;const e=(t=this.referenceState)==null?void 0:t.worldPosition;return e?this._relativePosition.subVectors(this.worldPosition,e):this._relativePosition.copy(this.worldPosition)}get relativeOrientation(){var t;const e=(t=this.referenceState)==null?void 0:t.worldOrientationInverse;return e?this._relativeOrientation.multiplyQuaternions(this.worldOrientation,e):this._relativeOrientation.copy(this.worldOrientation)}get relativeScale(){var t;const e=(t=this.referenceState)==null?void 0:t.worldScale;return e?this._relativeScale.copy(this.worldScale).divide(e):this._relativeScale.copy(this.worldScale)}get worldMatrixInverse(){return this._worldMatrixInverse}get worldPosition(){return this._worldPosition}get worldOrientation(){return this._worldOrientation}get worldScale(){return this._worldScale}get worldOrientationInverse(){return this._worldOrientationInverse}get worldRotation(){return this._worldRotation}get worldRotationInverse(){return this._worldRotationInverse}get worldCenter(){return this._cachedWorldCenter()}get spatialMatrix(){return this._cachedSpatialMatrix()}get spatialMatrixInverse(){return this.spatialMatrix,this._spatialFromWorld}get localFromSpatial(){return this.spatialMatrix,this._localFromSpatial}get spatialFromLocal(){return this.spatialMatrix,this._spatialFromLocal}get spatialFromReference(){return this.spatialMatrix,this._spatialFromReference}get spatialBounds(){return this._cachedSpatialBounds()}get spatialSize(){return this.spatialBounds,this._spatialSize}get spatialCenter(){return this.spatialBounds,this._spatialCenter}get outerBounds(){return this._cachedOuterBounds()}get outerCenter(){return this.outerBounds,this._outerCenter}get outerSize(){return this.outerBounds,this._outerSize}get outerOrigin(){return this.metrics.outerOrigin[this.mode]()}get outerOrientation(){var t,r;const e=this.metrics.system.nodeAdapters.get(this.metrics.node);return e?e.outerOrientation[this.mode]:(r=(t=this.referenceState)==null?void 0:t.worldOrientation)!=null?r:mn}get outerVisualBounds(){return this._cachedOuterVisualBounds()}get outerVisualCenter(){return this.outerVisualBounds,this._outerVisualCenter}get outerVisualSize(){return this.outerVisualBounds,this._outerVisualSize}get _viewState(){if(this.metrics.system.viewNode===this.metrics.node)return this;const e=this.metrics.system.viewMetrics;return this.mode==="current"?e[Pt]:e[kt]}get viewFromWorld(){return this._viewFromWorld.multiplyMatrices(this._viewState.worldMatrixInverse,this.worldMatrix)}get viewFromSpatial(){return this._viewFromSpatial.multiplyMatrices(this._viewState.worldMatrixInverse,this.spatialMatrix)}get spatialFromView(){return this._spatialFromView.copy(this.viewFromSpatial).invert()}get ndcBounds(){return this._cachedNDCBounds()}get ndcCenter(){return this._cachedNDCBounds(),this._ndcCenter}get ndcSize(){return this._cachedNDCBounds(),this._ndcSize}get visualBounds(){return this._cachedVisualBounds()}get visualCenter(){return this._cachedVisualBounds(),this._visualCenter}get visualSize(){return this._cachedVisualBounds(),this._visualSize}get relativeViewPosition(){return this._viewPosition.copy(this._viewState.worldPosition).applyMatrix4(this.worldMatrixInverse)}get viewAlignedOrientation(){return this._cachedViewAlignedOrientation()}get occludingPercent(){return this._computeOcclusion(),this._occludingPercent}get occludedPercent(){return this._computeOcclusion(),this._occludedPercent}visualAverageEdgeLength(){}};let ye=Je;c(ye,"_boxA",new nt),c(ye,"_boxB",new nt),c(ye,"_sizeA",new se),c(ye,"_sizeB",new se);class Is{constructor(e,t){this.system=e,this.node=t}}var nu,ru,iu;class Er extends Is{constructor(e,t){super(e,t);c(this,"_cache",new Lt);c(this,"needsUpdate",!0);c(this,"parentNode");c(this,"parentMetrics");c(this,"referenceMetrics");c(this,"_adapter");c(this,"_cachedInnerBounds",this._cache.memoize(()=>{const e=this._innerBounds;if(!this.raw.parent)return e.makeEmpty();if(this.node!==this.system.viewNode){e.copy(this.intrinsicBounds);const i=this._childBounds;for(const s of this.boundingChildMetrics)s.update(),i.copy(s.innerBounds),i.applyMatrix4(s.raw.relativeMatrix),e.union(i)}const t=e.getCenter(this._innerCenter),r=e.getSize(this._innerSize);if(r.length()>0){const i=this.system.epsillonMeters;Math.abs(r.x)<=i&&(r.x=(Math.sign(r.x)||1)*i*1e3),Math.abs(r.y)<=i&&(r.y=(Math.sign(r.y)||1)*i*1e3),Math.abs(r.z)<=i&&(r.z=(Math.sign(r.z)||1)*i*1e3,t.z-=i*1e3/2),e.setFromCenterAndSize(t,r)}return e}));c(this,"_childBounds",new Z);c(this,"_innerBounds",new Z);c(this,"_innerCenter",new A);c(this,"_innerSize",new A);c(this,"_intrinsicBoundsNeedsUpdate",!0);c(this,"_intrinsicBounds",new Z);c(this,"_intrinsicCenter",new A);c(this,"_intrinsicSize",new A);c(this,"_cachedNodeChildren",this._cache.memoize(()=>(this.system.bindings.getChildren(this,this._nodeChildren),this._nodeChildren)));c(this,"_nodeChildren",new Array);c(this,"_computeState",(()=>{const e=new F,t=new q,r=new F,i=new A,s=new q,a=new A,u=new A,o=new A,l=new A,p=new A;return function(f){var w;f.parent=this.raw.parent;const h=this._adapter,d=(w=this.referenceMetrics)==null?void 0:w[f.mode];t.copy((h==null?void 0:h.orientation.enabled)&&(h==null?void 0:h.orientation[f.mode])||this.raw.relativeOrientation);const y=(h==null?void 0:h.bounds.enabled)&&(h==null?void 0:h.bounds[f.mode]);if(y){y.getCenter(u),y.getSize(o);const _=this.innerCenter,g=this.innerSize,x=this.system.epsillonMeters;Math.abs(o.x)<=x&&(o.x=(Math.sign(o.x)||1)*x*10),Math.abs(o.y)<=x&&(o.y=(Math.sign(o.y)||1)*x*10),Math.abs(o.z)<=x&&(o.z=(Math.sign(o.z)||1)*x*10),a.copy(o),Math.abs(g.x)>=x&&(a.x/=g.x),Math.abs(g.y)>=x&&(a.y/=g.y),Math.abs(g.z)>=x&&(a.z/=g.z),s.multiplyQuaternions(f.outerOrientation,t).normalize(),l.copy(u).applyQuaternion(s),p.copy(_).multiply(a).applyQuaternion(s),i.copy(f.outerOrigin).add(l).sub(p),r.compose(i,s,a),f.worldMatrix=r}else e.compose(this.raw.relativePosition,t,this.raw.relativeScale),f.worldMatrix=(d==null?void 0:d.worldMatrix)?r.multiplyMatrices(d==null?void 0:d.worldMatrix,e):e;const v=(h==null?void 0:h.opacity.enabled)&&(h==null?void 0:h.opacity[f.mode]);return f.opacity=typeof v=="number"?v:1,f}})());c(this,"raw",{parent:null,worldMatrix:new F,relativeMatrix:new F,opacity:0,worldPosition:new A,worldOrientation:new q,worldScale:new A,relativePosition:new A,relativeOrientation:new q,relativeScale:new A,spatialBounds:new Z,worldFromSpatial:new F,localFromSpatial:new F,spatialFromLocal:new F});c(this,"outerOrigin",{current:()=>this._getOuterOrigin("current"),target:()=>this._getOuterOrigin("target")});c(this,"_cachedCurrentState",this._cache.memoize(()=>this._computeState(this[Pt])));c(this,nu,new ye("current",this));c(this,"_cachedTargetState",this._cache.memoize(()=>this._computeState(this[kt])));c(this,ru,new ye("target",this));c(this,iu,new ye("target",this));c(this,"_cachedBoundsChildren",this._cache.memoize(()=>{const e=this.nodeChildren,t=this._boundingChildren;t.length=0;for(const r of e){const i=this.system.getMetrics(r);i.isAdaptive||t.push(i)}return t}));c(this,"_boundingChildren",[])}update(){var e,t;if(this.needsUpdate){this.needsUpdate=!1;const r=this._adapter=this.system.nodeAdapters.get(this.node);this.parentNode=this.raw.parent,this.parentMetrics=this.parentNode&&this.system.getMetrics(this.parentNode);const i=((e=r==null?void 0:r.activeLayout)==null?void 0:e.referenceNode)||(r==null?void 0:r.referenceNode)||this.parentNode;this.referenceMetrics=i&&this.system.getMetrics(i),(t=this.referenceMetrics)==null||t.update(),r?r._update():(this.invalidateInnerBounds(),this.invalidateStates(),this.updateRawState())}}get innerBounds(){return this._cachedInnerBounds()}get innerCenter(){return this.innerBounds,this._innerCenter}get innerSize(){return this.innerBounds,this._innerSize}get intrinsicBounds(){return this._intrinsicBoundsNeedsUpdate&&(this._intrinsicBoundsNeedsUpdate=!1,this.system.bindings.getIntrinsicBounds(this,this._intrinsicBounds),this._intrinsicBounds.getCenter(this._intrinsicCenter),this._intrinsicBounds.getSize(this._intrinsicSize)),this._intrinsicBounds}get intrinsicCenter(){return this.intrinsicBounds,this._intrinsicCenter}get intrinsicSize(){return this.intrinsicBounds,this._intrinsicSize}invalidateIntrinsicBounds(){this._intrinsicBoundsNeedsUpdate=!0;for(const e of this.boundingChildMetrics)e.invalidateIntrinsicBounds()}invalidateInnerBounds(){if(!this._cachedInnerBounds.needsUpdate){this._cachedNodeChildren.needsUpdate=!0,this._cachedBoundsChildren.needsUpdate=!0,this._cachedInnerBounds.needsUpdate=!0;for(const e of this.boundingChildMetrics)e.invalidateInnerBounds()}}containsNode(e){this.update();let t=this.system.getMetrics(e);for(;t;){if(t.parentMetrics===this)return t.node;t=t.parentMetrics}return!1}containedByNode(e){this.update();let t=this.parentMetrics;for(;t;){if(t.node===e)return t.node;t=t.parentMetrics}return!1}get nodeChildren(){return this._cachedNodeChildren()}invalidateStates(){this._cachedCurrentState.needsUpdate=!0,this._cachedTargetState.needsUpdate=!0,this[Pt].invalidate(),this[kt].invalidate()}updateRawState(){this.system.bindings.getState(this);const e=this.raw;e.worldMatrix.decompose(e.worldPosition,e.worldOrientation,e.worldScale),e.relativeMatrix.decompose(e.relativePosition,e.relativeOrientation,e.relativeScale),e.worldFromSpatial.compose(this.outerOrigin.target(),e.worldOrientation,pn),e.localFromSpatial.copy(e.worldMatrix).invert().multiply(e.worldFromSpatial),e.spatialFromLocal.copy(e.localFromSpatial).invert(),e.spatialBounds.copy(this.innerBounds).applyMatrix4(e.spatialFromLocal)}_getOuterOrigin(e){var r,i,s;const t=this.system.nodeAdapters.get(this.node);return t?t.outerOrigin[e]:(s=(i=(r=this.referenceMetrics)==null?void 0:r[e])==null?void 0:i.worldCenter)!=null?s:ae}get current(){return this.update(),this._cachedCurrentState()}get target(){return this.update(),this._cachedTargetState()}get previousTarget(){return this.update(),this[Tr]}get boundingChildMetrics(){return this._cachedBoundsChildren()}get isAdaptive(){return this.system.nodeAdapters.has(this.node)}}nu=Pt,ru=kt,iu=Tr;class Nt{constructor(e){c(this,"relativeTolerance");c(this,"stepSizeMin");c(this,"stepSizeMax");c(this,"stepSizeStart");c(this,"minFeasibleTime");c(this,"maxInfeasibleTime");c(this,"maxIterationsPerFrame");c(this,"swarmSize");c(this,"pulseRate");c(this,"pulseFrequencyMin");c(this,"pulseFrequencyMax");e&&Object.assign(this,e)}}class Rr{constructor(e){c(this,"_config",new Nt);c(this,"_prevOrientation",new q);c(this,"_prevBounds",new Z);c(this,"_scratchSolution",new oe);c(this,"_scratchBestSolution",new oe);this.system=e}_setConfig(e){var r,i,s,a,u,o,l,p,m,f;const t=this.system.optimize;this._config.minFeasibleTime=(r=e.minFeasibleTime)!=null?r:t.minFeasibleTime,this._config.maxInfeasibleTime=(i=e.maxInfeasibleTime)!=null?i:t.maxInfeasibleTime,this._config.pulseRate=(s=e.pulseRate)!=null?s:t.pulseRate,this._config.maxIterationsPerFrame=(a=e.maxIterationsPerFrame)!=null?a:t.maxIterationsPerFrame,this._config.swarmSize=(u=e.swarmSize)!=null?u:t.swarmSize,this._config.pulseFrequencyMin=(o=e.pulseFrequencyMin)!=null?o:t.pulseFrequencyMin,this._config.pulseFrequencyMax=(l=e.pulseFrequencyMax)!=null?l:t.pulseFrequencyMax,this._config.stepSizeMax=(p=e.stepSizeMax)!=null?p:t.stepSizeMax,this._config.stepSizeMin=(m=e.stepSizeMin)!=null?m:t.stepSizeMin,this._config.stepSizeStart=(f=e.stepSizeStart)!=null?f:t.stepSizeStart}update(e){if(e.layouts.length===0||e.metrics.innerBounds.isEmpty())return e.activeLayout=null,!1;const t=this._prevOrientation.copy(e.orientation.target),r=this._prevBounds.copy(e.bounds.target);for(const a of e.layouts)this._setConfig(a),this._updateLayout(e,a);let i,s;for(const a of e.layouts){const u=a.solutions[0];if((!s||!s.isFeasible&&u.isFeasible)&&(s=u,i=a,s.isFeasible))break}return e.layoutFeasibleTime+=e.system.deltaTime,e.layoutInfeasibleTime+=e.system.deltaTime,(s==null?void 0:s.isFeasible)||(e.layoutFeasibleTime=0),s&&s.isFeasible&&e.layoutFeasibleTime>=this._config.minFeasibleTime||e.layoutInfeasibleTime>=this._config.maxInfeasibleTime?(e.layoutInfeasibleTime=0,s.apply(!1)):(e.orientation.target=t,e.bounds.target=r,e.metrics.invalidateStates()),e.activeLayout=i,!0}_updateLayout(e,t){var p;e.measureBoundsCache.clear(),t.processObjectives();const r=t.solutions,i=this._config,s=this._scratchSolution,a=this._scratchBestSolution,u=1.5,o=1.5**(-1/4);let l=i.maxIterationsPerFrame;((p=t.solutions[0])==null?void 0:p.isFeasible)&&(l=1),this._manageSolutionPopulation(e,t,i.swarmSize,i.stepSizeStart),r[0].apply();for(let m=0;m<l;m++){t.iteration++,a.copy(r[0]);let f=!1;for(let h=0;h<r.length;h++){const d=r[h];s.copy(d),s.mutationStrategies=d.mutationStrategies;let y;if(Math.random()<i.pulseRate){const w=a!==d?a:r[1];let _;if(r.length>2)do _=r[Math.floor(Math.random()*r.length)];while(_===d);s.moveTowards(w,i.pulseFrequencyMin,i.pulseFrequencyMax),_&&t.compareSolutions(_,d)<=0&&s.moveTowards(_,i.pulseFrequencyMin,i.pulseFrequencyMax)}else y=s.perturb();s.apply();const v=t.compareSolutions(s,d)<0;if(v&&(d.copy(s),d!==r[0]&&t.compareSolutions(d,r[0])<0&&r[0].copy(d),f=!0),y)if(y.stepSize*=v?u:o,!v&&y.stepSize<i.stepSizeMin||y.stepSize>i.stepSizeMax){for(const w of d.mutationStrategies)w.stepSize=i.stepSizeStart;d!==r[0]&&(t.restartRate=.001+(1-.001)*t.restartRate,d.randomize(1),d.apply(),f=!0)}else d!==r[0]&&(t.restartRate=(1-.001)*t.restartRate)}f&&t.sortSolutions(),t.compareSolutions(a,r[0])<=0?t.successRate=(1-.005)*t.successRate:t.successRate=.005+(1-.005)*t.successRate}}_manageSolutionPopulation(e,t,r,i){if(r<=1)throw new Error("Swarm size must be larger than 1");if(t.solutions.length<r)for(;t.solutions.length<r;){const s=new oe(t);for(const a of s.mutationStrategies)a.stepSize=i;s.randomize(1),t.solutions.push(s)}else if(t.solutions.length>r)for(;t.solutions.length>r;)t.solutions.pop()}}class Ie{constructor(e){c(this,"type","ratio");c(this,"sortBlame",0);c(this,"relativeTolerance");c(this,"absoluteTolerance");c(this,"computedAbsoluteTolerance",-1/0);c(this,"computedRelativeTolerance",-1/0);c(this,"priority",0);c(this,"index",-1);c(this,"layout");c(this,"reduceFromOneOrManySpec",(e,t,r)=>{if(t===void 0)return 0;if(t instanceof Array){let i=-1/0;for(const s of t)i=Math.max(r(e,s),i);return i}return r(e,t)});c(this,"_getNumberScoreSingle",(e,t)=>{let r=0;if(typeof t!="object"){const i=this.layout.adapter.system.measureNumber(t);r=-Math.abs(e-i)}else{const i="gt"in t?this.layout.adapter.system.measureNumber(t.gt):void 0,s="lt"in t?this.layout.adapter.system.measureNumber(t.lt):void 0;i!==void 0&&e<i?r=e-i:s!==void 0&&e>s&&(r=s-e)}return r});c(this,"_getVector3ScoreSingle",(e,t)=>{const r="x"in t&&typeof t.x!="undefined"?this.getNumberScore(e.x,t.x):0,i="y"in t&&typeof t.y!="undefined"?this.getNumberScore(e.y,t.y):0,s="z"in t&&typeof t.z!="undefined"?this.getNumberScore(e.z,t.z):0,a="magnitude"in t&&typeof t.magnitude!="undefined"?this.getNumberScore(e.length(),t.magnitude):0;return r+i+s+a});c(this,"_quat",new q);c(this,"_euler",new mr);c(this,"_getQuaternionScoreSingle",(e,t)=>{var r,i;if(t===void 0)return 0;if("x"in t)return-this._quat.copy(t).angleTo(e)*H;if("swingRange"in t){const s=this._euler.setFromQuaternion(e),a=s.x*H,u=s.y*H,o=s.z*H,l=this.layout.adapter.system,p=l.mathScope.degree;let m=((r=t.swingRange)==null?void 0:r.x)?l.measureNumber(t.swingRange.x,p):0,f=((i=t.swingRange)==null?void 0:i.y)?l.measureNumber(t.swingRange.y,p):0;m=Math.max(m,.01),f=Math.max(f,.01);const h=t.twistRange?l.measureNumber(t.twistRange,p):0,d=1-(a/m)**2-(u/f)**2,y=h-Math.abs(o);return(d>0?0:d)+(y>0?0:y)}return 0});c(this,"_getBoundsMeasureScoreSingle",(e,t,r,i)=>{if(t===void 0)return 0;if(typeof t=="object"){if("gt"in t){const s=this.layout.adapter.measureBounds(t.gt,r,i);if(e<s)return e-s}if("lt"in t){const s=this.layout.adapter.measureBounds(t.lt,r,i);if(e>s)return s-e}return 0}return-Math.abs(e-this.layout.adapter.measureBounds(t,r,i))});this.layout=e}static isDiscreteSpec(e){const t=typeof e;return t==="string"||t==="number"}static isContinuousSpec(e){return e!==void 0&&!(e instanceof Array)&&typeof e=="object"&&("gt"in e||"lt"in e)}get bestScore(){return this.layout.solutions[0].scores[this.index]}getNumberScore(e,t){return this.reduceFromOneOrManySpec(e,t,this._getNumberScoreSingle)}getVector3Score(e,t){return this.reduceFromOneOrManySpec(e,t,this._getVector3ScoreSingle)}getQuaternionScore(e,t){return this.reduceFromOneOrManySpec(e,t,this._getQuaternionScoreSingle)}getBoundsScore(e,t){if(e===void 0)return 0;let r=0;for(const i in e){if(i==="absolute")continue;let s=i;if(s==="size"||s==="center"){const a=e[s];for(const u of Ps){let o=u;t!=="spatial"&&(this.type==="meter"&&o!=="z"||this.type==="pixel"&&o==="z")||(r+=this.getBoundsMeasureScore(a==null?void 0:a[o],t,s+o))}}else{if(t!=="spatial"&&(this.type==="meter"&&s!=="back"&&s!=="front"||this.type==="pixel"&&(s==="back"||s==="front")))continue;r+=this.getBoundsMeasureScore(e[s],t,s)}}return r}getBoundsMeasureScore(e,t,r){if(e===void 0)return 0;const i=this.layout.adapter.metrics.target;let s,a,u;switch(t){case"spatial":s=i.spatialBounds,a=i.spatialCenter,u=i.spatialSize;break;case"visual":case"view":s=i.visualBounds,a=i.visualCenter,u=i.visualSize;break;default:throw new Error(`Unknown measure type "${t}.${r}" in spec:
 "${e}"`)}let o=0;switch(r){case"left":o=s.min.x;break;case"right":o=s.max.x;break;case"bottom":o=s.min.y;break;case"top":o=s.max.y;break;case"back":o=s.min.z;break;case"front":o=s.max.z;break;case"centerx":o=a.x;break;case"centery":o=a.y;break;case"centerz":o=a.z;break;case"centerdistance":o=t==="spatial"?a.length():Math.sqrt(a.x**2+u.y**2);break;case"sizex":o=u.x;break;case"sizey":o=u.y;break;case"sizez":o=u.z;break;case"sizediagonal":o=t==="spatial"?u.length():Math.sqrt(u.x**2+u.y**2);break;default:throw new Error(`Unknown measure subtype ${t}.${r} in spec "${e}"`)}if(e instanceof Array){let l=-1/0;for(const p of e)l=Math.max(this._getBoundsMeasureScoreSingle(o,p,t,r),l);return l}return this._getBoundsMeasureScoreSingle(o,e,t,r)}attenuateVisualScore(e){let t=0;const r=this.layout.getComputedAbsoluteTolerance("pixel"),i=this.layout.adapter,s=i.system.viewResolution,a=i.system.viewFrustum,u=s.x,o=s.y,l=s.length(),p=i.metrics.target.visualBounds,m=p.min.x- -u/2+r,f=p.max.x-u/2-r,h=p.min.y- -o/2+r,d=p.max.y-o/2-r,y=p.max.z+a.nearMeters;return m<0&&(t+=Math.abs(m/u)),f>0&&(t+=Math.abs(f/u)),h<0&&(t+=Math.abs(h/o)),d>0&&(t+=Math.abs(d/o)),y>0&&(t+=y*10),e-Math.abs(l)*t}}class Cr extends Ie{constructor(e){super(e);c(this,"spec");this.type="degree"}evaluate(){const e=this.layout.adapter.metrics.target;return this.getQuaternionScore(e.relativeOrientation,this.spec)}}class zs extends Ie{constructor(e){super(e);c(this,"spec");this.type="ratio"}evaluate(){const e=this.layout.adapter.metrics.target;return this.getVector3Score(e.worldScale,this.spec)}}class Ls extends Ie{constructor(e){super(e);c(this,"mode","xyz");c(this,"_scale",new A);this.type="ratio"}evaluate(){const e=this.layout.adapter.metrics.target,t=this.mode;if(!t)return 0;const r=this._scale.copy(e.worldScale),i=t==="xyz"?Math.max(Math.abs(r.x),Math.abs(r.y),Math.abs(r.z)):Math.max(Math.abs(r.x),Math.abs(r.y)),s=r.divideScalar(i);return-(1/s.x)+1+-(1/s.y)+1+(t==="xyz"?-(1/s.z)+1:s.z>1?1-s.z:0)}}const Ps=["x","y","z","diagonal","distance"];class ks extends Ie{constructor(e){super(e);c(this,"spec");this.type="meter"}evaluate(){return this.getBoundsScore(this.spec,"spatial")}}class Ar extends Ie{constructor(e){super(e);c(this,"spec");c(this,"pixelTolerance");c(this,"meterTolerance");this.type="pixel"}evaluate(){var e;return this.type==="meter"&&(this.absoluteTolerance=this.meterTolerance),this.type==="pixel"&&(this.absoluteTolerance=this.pixelTolerance),this.getBoundsScore(this.spec,"visual")+this.getBoundsScore((e=this.spec)==null?void 0:e.absolute,"view")}}class Ns extends Ie{constructor(e){super(e);c(this,"minAreaPercent",0);this.type="pixel"}evaluate(){var o;const e=this.layout.adapter.metrics.target,t=e.visualSize,r=this.layout.adapter.system.viewResolution,i=Math.min(t.x*t.y,r.x*r.y),s=((o=e.referenceState)==null?void 0:o.visualSize)||r,a=s.x*s.y;return this.attenuateVisualScore(i)-a*this.minAreaPercent}}class Br extends Ie{constructor(e){super(e);this.type="meter",this.absoluteTolerance=1e10}evaluate(){return-this.layout.adapter.metrics.target.visualCenter.length()}}const Or=new A;class Dr extends Nt{constructor(e){super();c(this,"absoluteTolerance",{meter:"10mm",pixel:"4px",degree:"0.002deg",ratio:.002});c(this,"successRate",0);c(this,"restartRate",0);c(this,"objectives",new Array);c(this,"referenceNode",null);c(this,"maximizeObjective");c(this,"orientationConstraint");c(this,"keepAspectConstraint");c(this,"scaleConstraint");c(this,"boundsConstraint");c(this,"visualBoundsMeterConstraint");c(this,"visualBoundsPixelConstraint");c(this,"magnetizeObjective");c(this,"minimizeOcclusionObjective");c(this,"solutions",new Array);c(this,"iteration",0);c(this,"bestSolution");c(this,"compareSolutions",(e,t)=>{const r=this.objectives;if(e.scores.length<r.length)return 1;if(t.scores.length<r.length)return-1;if(e.boundsCenterDistance>1e20)return 1;if(t.boundsCenterDistance>1e10)return-1;if(e.boundsManhattanLength>1e20)return 1;if(t.boundsManhattanLength>1e10)return-1;const i=e.isFeasible,s=t.isFeasible;if(i&&!s)return-1;if(s&&!i)return 1;let a=0;const u=this.solutions[0].scores;for(let o=0;o<r.length;o++){const l=e.scores[o],p=t.scores[o];if(isNaN(l))return 1;if(isNaN(p))return-1;const m=r[o],f=m.computedRelativeTolerance,h=m.computedAbsoluteTolerance,d=Math.max(u[o],l,p),y=Math.min(d-Math.abs(d)*f,-h);if(l<y||p<y)return m.sortBlame++,p-l;p-l!=0&&(a=p-l)}return a});this.adapter=e}getComputedAbsoluteTolerance(e){return this.adapter.system.measureNumber(this.absoluteTolerance[e],e)}poseRelativeTo(e){return this.referenceNode=e,this}maximize(e){var r;const t=this.maximizeObjective=(r=this.maximizeObjective)!=null?r:new Ns(this);return t.priority=-1e3,t.relativeTolerance=.1,this.addObjective(t,e)}orientation(e,t){var i;const r=this.orientationConstraint=(i=this.orientationConstraint)!=null?i:new Cr(this);return r.spec=e,r.priority=-999,this.addObjective(r,t)}keepAspect(e="xyz",t){var i;const r=this.keepAspectConstraint=(i=this.keepAspectConstraint)!=null?i:new Ls(this);return r.mode=e,r.priority=-998,this.addObjective(r,t)}scale(e,t){var i;const r=this.scaleConstraint=(i=this.scaleConstraint)!=null?i:new zs(this);return r.spec=e,r.priority=-2,this.addObjective(r,t)}bounds(e,t){var i;const r=this.boundsConstraint=(i=this.boundsConstraint)!=null?i:new ks(this);return r.spec=e,this.addObjective(r,t)}visualOrientation(e,t){var i;const r=this.orientationConstraint=(i=this.orientationConstraint)!=null?i:new Cr(this);return r.spec=e,r.priority=-999,this.addObjective(r,t)}visualBounds(e,t){var s,a;const r=this.visualBoundsMeterConstraint=(s=this.visualBoundsMeterConstraint)!=null?s:new Ar(this),i=this.visualBoundsPixelConstraint=(a=this.visualBoundsPixelConstraint)!=null?a:new Ar(this);return r.spec=e,r.type="meter",i.spec=e,i.type="pixel",this.addObjective(r,t).addObjective(i,t)}magnetize(e){var r;const t=this.magnetizeObjective=(r=this.magnetizeObjective)!=null?r:new Br(this);return t.priority=-900,t.relativeTolerance=.95,this.addObjective(t,e)}avoidOcclusion(e){var r;const t=this.minimizeOcclusionObjective=(r=this.minimizeOcclusionObjective)!=null?r:new Br(this);return t.priority=11,this.addObjective(t,e)}addObjective(e,t){return Object.assign(e,t),this.objectives.indexOf(e)===-1&&this.objectives.push(e),this.processObjectives(),this}get hasValidSolution(){var e;return((e=this.solutions[0])==null?void 0:e.isFeasible)===!0}processObjectives(){var i,s;const e=this.adapter.system,t=this.objectives;let r=0;for(const a of t)a.index=r++,a.computedAbsoluteTolerance=a.absoluteTolerance!==void 0?e.measureNumber(a.absoluteTolerance,e.mathScope[a.type]):this.getComputedAbsoluteTolerance(a.type),a.computedRelativeTolerance=(s=(i=a.relativeTolerance)!=null?i:this.relativeTolerance)!=null?s:this.adapter.system.optimize.relativeTolerance}sortSolutions(){this.solutions.sort(this.compareSolutions),this.bestSolution=this.solutions[0]}}const G=class{constructor(e){c(this,"layout");c(this,"orientation",new q);c(this,"bounds",new Z);c(this,"scores",[]);c(this,"isFeasible",!1);c(this,"mutationStrategies",[{type:"rotate",stepSize:.1},{type:"center",stepSize:.1},{type:"size",stepSize:.1},{type:"minmax",stepSize:.1}]);c(this,"_mutationWeights",[]);c(this,"boundsManhattanLength");c(this,"boundsCenterDistance");e&&(this.layout=e)}get aspectPenalty(){return this.scores[this.layout.objectives.indexOf(this.layout.keepAspectConstraint)]||0}get orientationPenalty(){return this.scores[this.layout.objectives.indexOf(this.layout.orientationConstraint)]||0}get spatialBoundsPenalty(){return this.scores[this.layout.objectives.indexOf(this.layout.boundsConstraint)]||0}_selectStrategy(){const e=this.mutationStrategies,t=this._mutationWeights,r=this.layout.orientationConstraint,i=this.layout.keepAspectConstraint;for(let s=0;s<e.length;s++)t[s]=e[s].stepSize,r&&e[s].type=="rotate"&&this.orientationPenalty>-r.computedAbsoluteTolerance&&(t[s]*=.01),i&&e[s].type=="size"&&this.aspectPenalty<-i.computedAbsoluteTolerance&&(t[s]*=100);return xr(e,t)}copy(e){this.layout=e.layout,this.orientation.copy(e.orientation),this.bounds.copy(e.bounds),this.scores.length=0;for(let t=0;t<e.scores.length;t++)this.scores[t]=e.scores[t];return this.isFeasible=e.isFeasible,this}randomize(e){const t=gn(e),r=G._scratchV1.set(0,0,-t),i=this.layout.adapter.system.viewMetrics.target;r.applyMatrix4(i.worldMatrix);const s=this.layout.adapter.metrics.target.parentState;s&&r.applyMatrix4(s.worldMatrixInverse),this.orientation.copy(i.worldOrientation),s&&this.orientation.multiply(s.worldOrientationInverse);const a=this.layout.adapter.metrics.innerBounds,u=a.isEmpty()?G._scratchV2.set(1,1,1):a.getSize(G._scratchV2);return u.normalize(),u.multiplyScalar(t*2*Math.tan(5*K)),this.bounds.setFromCenterAndSize(r,u),this}moveTowards(e,t,r){const i=this.bounds.getCenter(G._center),s=this.bounds.getSize(G._size),a=e.bounds,u=a.getCenter(G._otherCenter),o=a.getSize(G._otherSize);this.orientation.slerp(e.orientation,G.generatePulseFrequency(t,r)).normalize(),Math.random()<.5?(i.lerp(u,G.generatePulseFrequency(t,r)),s.lerp(o,G.generatePulseFrequency(t,r)),this.bounds.setFromCenterAndSize(i,s)):(this.bounds.min.lerp(a.min,G.generatePulseFrequency(t,r)),this.bounds.max.lerp(a.max,G.generatePulseFrequency(t,r)))}perturb(){var l;const e=this._selectStrategy(),t=e.type;let r=e.stepSize;if(t==="rotate"||Math.random()<.001){const p=(l=this.layout.orientationConstraint)==null?void 0:l.spec;if((p==null?void 0:p.isQuaternion)&&this.orientationPenalty<p.computedAbsoluteTolerance&&Math.random()<.01)this.orientation.copy(p);else{const m=Math.min(gn(Math.min(r,1)*1e-4),1);this.orientation.multiply(zt(m,m)).normalize()}}const i=this.bounds,s=i.getCenter(G._center),a=i.getSize(G._size);if(t==="center"){const p=G._direction.set(0,0,1).applyQuaternion(zt(1,1));p.setLength(it(r)).multiplyScalar(a.length()),s.add(p)}if(t==="size"){const p=2**it(r);a.multiplyScalar(p)}if(a.clampScalar(this.layout.adapter.system.epsillonMeters/10,1e20),i.setFromCenterAndSize(s,a),t==="minmax"){const p=G._direction.set(0,0,1).applyQuaternion(zt(1,1));p.setLength(it(r)).multiply(a),Math.random()<.5,i.min.add(p)}const u=i.min,o=i.max;return u.x>o.x&&this._swap(u,o,"x"),u.y>o.y&&this._swap(u,o,"y"),u.z>o.z&&this._swap(u,o,"z"),e}_swap(e,t,r){const i=e[r],s=t[r];e[r]=s,t[r]=i}static generatePulseFrequency(e,t){return e+Math.random()*(t-e)}apply(e=!0){const t=this.layout,r=t.adapter;if(r.orientation.target=this.orientation,r.bounds.target=this.bounds,r.metrics.invalidateStates(),e){this.isFeasible=!0;for(let i=0;i<t.objectives.length;i++){const s=t.objectives[i],a=this.scores[i]=s.evaluate();(a<-s.computedAbsoluteTolerance||!isFinite(a))&&(this.isFeasible=!1)}}this.boundsManhattanLength=this.bounds.getSize(Or).manhattanLength(),this.boundsCenterDistance=this.bounds.getCenter(Or).length()}};let oe=G;c(oe,"_scratchV1",new A),c(oe,"_scratchV2",new A),c(oe,"_direction",new A),c(oe,"_center",new A),c(oe,"_size",new A),c(oe,"_otherCenter",new A),c(oe,"_otherSize",new A);const Ir=qi;class zr{constructor(e){c(this,"target");c(this,"duration");c(this,"easing");c(this,"blend");c(this,"elapsed");e&&Object.assign(this,e)}}class st{constructor(e){c(this,"multiplier");c(this,"duration");c(this,"easing");c(this,"threshold");c(this,"delay");c(this,"debounce");c(this,"maxWait");c(this,"blend");e&&Object.assign(this,e)}}const Fs=new se,Us=new A,Ks=new q,Lr=new Z,Vs=new dn,js=new dn(0,0,0);class ge extends st{constructor(e,t,r,i=e.transition){super(r);c(this,"needsUpdate",!1);c(this,"_size",new A);c(this,"_start");c(this,"_current");c(this,"_reference");c(this,"_target");c(this,"queue",[]);c(this,"enabled",!1);c(this,"forceWait",!1);c(this,"_forceCommit",!1);c(this,"_resolvedConfig",new st);c(this,"delayTime",0);c(this,"debounceTime",0);c(this,"_previousStatus","unchanged");c(this,"_status","unchanged");c(this,"_previousTarget");c(this,"_syncGroup");this.system=e,this.parentConfig=i,this.reset(t),this._previousTarget=this._copy(this._previousTarget,this.target)}_copy(e,t){if(typeof t=="undefined")return;if(typeof t=="number")return t;const r=e?e.copy(t):t.clone();if(r&&"isBox3"in r){const i=r,s=i.getSize(this._size);(i.isEmpty()||!isFinite(s.x)||!isFinite(s.y)||!isFinite(s.z))&&i.setFromCenterAndSize(ae,ae)}return r}_isEqual(e,t){return e===void 0||t===void 0?!1:e===t?!0:typeof e=="number"?e===t:(e==null?void 0:e.equals(t))||!1}reset(e){this._start=this._copy(this._start,e),this._current=this._copy(this._current,e),this._target=this._copy(this._target,e),this.queue.length=0}set start(e){this._start=this._copy(this._start,e)}get start(){return this._start}set current(e){this._current=this._copy(this._current,e)}get current(){return this._current}set reference(e){this._reference=this._copy(this._reference,e)}get reference(){return this._reference}set target(e){this.enabled=!0,this._target=this._copy(this._target,e)}get target(){return this._target}get progress(){if(!this.enabled)return 1;if(this.queue.length>0){const e=this.queue[this.queue.length-1];return e.duration===0?0:e.elapsed/e.duration}return 1}get forceCommit(){return this._forceCommit}set forceCommit(e){this._forceCommit!==e&&(this._forceCommit=e)}get relativeDifference(){var t,r;const e=(r=(t=this.queue[this.queue.length-1])==null?void 0:t.target)!=null?r:this.start;return typeof this.target!="undefined"?yn(e,this.target):0}get referenceRelativeDifference(){return typeof this.reference!="undefined"&&typeof this.target!="undefined"?yn(this.reference,this.target):1/0}get resolvedConfig(){var i,s,a,u,o,l,p,m,f,h,d,y,v,w,_,g;const e=this._resolvedConfig,t=this.parentConfig,r=this.system.transition;return e.multiplier=(s=(i=this.multiplier)!=null?i:t==null?void 0:t.multiplier)!=null?s:r.multiplier,e.duration=(u=(a=this.duration)!=null?a:t==null?void 0:t.duration)!=null?u:r.duration,e.easing=(l=(o=this.easing)!=null?o:t==null?void 0:t.easing)!=null?l:r.easing,e.threshold=(m=(p=this.threshold)!=null?p:t==null?void 0:t.threshold)!=null?m:r.threshold,e.delay=(h=(f=this.delay)!=null?f:t==null?void 0:t.delay)!=null?h:r.delay,e.debounce=(y=(d=this.debounce)!=null?d:t==null?void 0:t.debounce)!=null?y:r.debounce,e.maxWait=(w=(v=this.maxWait)!=null?v:t==null?void 0:t.maxWait)!=null?w:r.maxWait,e.blend=(g=(_=this.blend)!=null?_:t==null?void 0:t.blend)!=null?g:r.blend,e}get previousStatus(){return this._previousStatus}get status(){return this.needsUpdate&&(this._previousStatus=this._status,this._status=this._computeStatus()),this._status}_computeStatus(){if(this.forceCommit)return"committing";const e=this.resolvedConfig,t=e.threshold,r=this.system.deltaTime*e.multiplier,i=this.delayTime+r,s=this.debounceTime+r;return this.relativeDifference>t?!this.forceWait&&(i>=e.delay&&s>=e.debounce||i>=e.maxWait)?"committing":this.referenceRelativeDifference<t?"settling":"changed":"unchanged"}_updateTransitionable(){var u,o,l,p,m;const e=this.system.deltaTime,t=this.resolvedConfig,r=this.queue,i=this.status,s=e*t.multiplier;for(;r.length&&r[0].elapsed>=r[0].duration;)this.start=r.shift().target;this.current=this.start;let a=this.start;for(let f=0;f<r.length;f++){const h=r[f];if(this._addTransitionToCurrent(a,h,s),a=h.target,!h.blend)break}switch(this.debounceTime+=s,i){case"settling":break;case"changed":this.delayTime+=s,this.reference=this.target;break;case"unchanged":this.reference=void 0,this.delayTime=0;break;case"committing":this.delayTime=0,this.debounceTime=0;const f=typeof this.forceCommit=="object"?this.forceCommit:new zr;f.target=(u=f.target)!=null?u:this._copy(void 0,this.target),f.duration=(o=f.duration)!=null?o:t.duration,f.easing=(l=f.easing)!=null?l:t.easing,f.blend=(p=f.blend)!=null?p:t.blend,f.elapsed=(m=f.elapsed)!=null?m:0,r.push(f),this.forceCommit=!1;break}this.forceWait=!1}_addTransitionToCurrent(e,t,r){const i=this._current,s=t.duration>0?t.easing(Math.min(t.elapsed/t.duration,1)):1,a=t.target;if(t.elapsed+=r,typeof a=="number"){this._current=i+Hi(a-e,0,1-s);return}if("isVector3"in a){const u=i,o=e,l=a,p=Us.copy(l).sub(o).lerp(ae,1-s);this._current=u.add(p);return}if("isVector2"in a){const u=i,o=e,l=a,p=Fs.copy(l).sub(o).lerp(wr,1-s);this._current=u.add(p);return}if("isQuaternion"in a){const u=i,o=e,l=a,p=Ks.copy(o).invert().multiply(l).slerp(mn,1-s);this._current=u.multiply(p).normalize();return}if("isColor"in a){const u=i,o=e,l=a,p=Vs.copy(l).sub(o).lerp(js,1-s);this._current=u.add(p);return}if("isBox3"in a){const u=i,o=e,l=a,p=Lr.min.copy(l.min).sub(o.min).lerp(ae,1-s),m=Lr.max.copy(l.max).sub(o.max).lerp(ae,1-s);u.min.add(p),u.max.add(m),this._current=u;return}}_swap(e,t,r){const i=e[r],s=t[r];e[r]=s,t[r]=i}update(e=!1){if(!this.needsUpdate&&!e||(this._isEqual(this._previousTarget,this.target)||(this._target=this._target,this.enabled=!0),this._previousTarget=this._copy(this._previousTarget,this.target),!this.enabled))return;const t=this.syncGroup;if(!this.forceCommit&&t){for(const r of t)if(r.enabled&&r.status==="committing"){for(const i of t)i.needsUpdate&&i.forceCommit===!1&&i.relativeDifference>i.resolvedConfig.threshold&&(i.forceCommit=!0);break}}this._updateTransitionable(),this.needsUpdate=!1}set syncGroup(e){this._syncGroup&&this._syncGroup.delete(this),this._syncGroup=e,e==null||e.add(this)}get syncGroup(){return this._syncGroup}}class Pr{constructor(e,t){c(this,"measureBoundsCache",new Map);c(this,"metrics");c(this,"transition",new st);c(this,"referenceNode");c(this,"_outerOrigin");c(this,"_outerOrientation");c(this,"_outerBounds");c(this,"_outerVisualBounds");c(this,"_parentAdapter",null);c(this,"_orientation");c(this,"_bounds");c(this,"_opacity");c(this,"layouts",new Array);c(this,"layoutFeasibleTime",0);c(this,"layoutInfeasibleTime",0);c(this,"_prevLayout",null);c(this,"_activeLayout",null);c(this,"_progress",1);c(this,"_hasValidContext",!1);c(this,"onUpdate");c(this,"onPostUpdate");c(this,"_prevNodeOrientation",new q);c(this,"_prevNodeBounds",new Z);this.system=e,this.node=t,this.metrics=this.system.getMetrics(this.node);const r=this.metrics.target;this._orientation=new ge(this.system,r.relativeOrientation,void 0,this.transition),this._bounds=new ge(this.system,r.spatialBounds,void 0,this.transition),this._opacity=new ge(this.system,r.opacity,void 0,this.transition),this._outerOrigin=new ge(this.system,r.outerCenter,void 0,this.transition),this._outerOrientation=new ge(this.system,r.outerOrientation,void 0,this.transition),this._outerBounds=new ge(this.system,r.outerBounds,void 0,this.transition),this._outerVisualBounds=new ge(this.system,r.outerVisualBounds,void 0,this.transition),this._outerOrigin.debounce=0,this._outerOrigin.delay=0,this._outerOrientation.debounce=0,this._outerOrientation.delay=0,this._outerBounds.debounce=0,this._outerBounds.delay=0,this._outerVisualBounds.debounce=0,this._outerVisualBounds.delay=0,this._orientation.syncGroup=this._bounds.syncGroup=this._opacity.syncGroup=new Set}measureBounds(e,t,r){var w,_,g;const i=this.system,s=i.mathScope,a=i.math,u=t==="spatial"||r==="front"||r==="back"||r==="centerz"||r==="sizez"?s.meter:s.pixel,o=u===s.meter?"m":"px";typeof e=="number"&&(e=""+e+o);const l=t+"-"+r+" = "+e;if((w=this.measureBoundsCache)==null?void 0:w.has(l))return this.measureBoundsCache.get(l);if(!i.mathCompiledExpressions.has(e)){const b=a.parse(e.replace("%","percent")).compile();i.mathCompiledExpressions.set(e,b)}const p=i.mathCompiledExpressions.get(e),m=i.viewMetrics.target,f=this.metrics.target;let h,d;switch(t){case"spatial":h=f.outerBounds,d=f.outerCenter;break;case"visual":h=f.outerVisualBounds,d=f.outerVisualCenter;break;case"view":h=m.visualBounds,d=m.visualCenter;break;default:throw new Error(`Unknown measure type "${t}.${r}"`)}if(e.includes("%")){const x=t==="spatial"?f.outerSize:(_=f.outerVisualSize)!=null?_:m.visualSize;let b=0;switch(r){case"left":case"centerx":case"right":case"sizex":b=a.unit(x.x/100,o);break;case"bottom":case"centery":case"top":case"sizey":b=a.unit(x.y/100,o);break;case"back":case"centerz":case"front":case"sizez":b=a.unit(x.z/100,"m");break;case"sizediagonal":b=t==="spatial"?a.unit(x.length()/100,"m"):a.unit(Math.sqrt(x.x**2+x.y**2)/100,"px");break;default:throw new Error(`Invalid measure subtype "${t}.${r}" for percentage units`)}s.percent=b}let y;switch(r){case"left":y=h.min.x;break;case"centerx":y=d.x;break;case"right":y=h.max.x;break;case"bottom":y=h.min.y;break;case"centery":y=d.y;break;case"top":y=h.max.y;break;case"front":y=h.max.z;break;case"centerz":y=d.z;break;case"back":y=h.min.z;break;case"centerdistance":default:y=0}let v=p.evaluate(s);return typeof v=="object"&&(v=a.number(v,u)),y+=v,s.percent=void 0,(g=this.measureBoundsCache)==null||g.set(l,y),y}get outerOrigin(){return this._outerOrigin}get outerOrientation(){return this._outerOrientation}get outerBounds(){return this._outerBounds}get outerVisualBounds(){return this._outerVisualBounds}get parentAdapter(){return this._parentAdapter}_computeParentAdapter(){let e=this.metrics;for(;e=e.parentMetrics;){const t=this.system.nodeAdapters.get(e.node);if(t)return t}return null}get orientation(){return this._orientation}get bounds(){return this._bounds}get opacity(){return this._opacity}get previousLayout(){return this._prevLayout}set activeLayout(e){this._prevLayout=this._activeLayout,this._activeLayout=e}get activeLayout(){return this._activeLayout}get progress(){return this._progress}_computeProgress(){return Math.min(this.orientation.progress,this.bounds.progress,this.opacity.progress)}createLayout(){const e=new Dr(this);return this.layouts.push(e),e}get hasValidContext(){return this._hasValidContext}_computeHasValidContext(){var t;const e=this.parentAdapter;return e?e.hasValidContext?!!(e.layouts.length===0||((t=e.activeLayout)==null?void 0:t.hasValidSolution)):!1:!0}_update(){var t;this._parentAdapter=this._computeParentAdapter(),this._hasValidContext=this._computeHasValidContext();const e=this.metrics;if(e.referenceMetrics&&(this.outerOrigin.target=e.referenceMetrics.target.worldCenter,this.outerOrientation.target=e.referenceMetrics.target.worldOrientation,this.outerBounds.target=e.referenceMetrics.innerBounds,this.outerBounds.target.applyMatrix4(e.target.spatialFromReference),this.outerVisualBounds.target=e.referenceMetrics.target.visualBounds),this.outerOrigin.update(),this.outerOrientation.update(),this.outerBounds.update(),this.outerVisualBounds.update(),this.onUpdate){this.onUpdate(),e.invalidateIntrinsicBounds(),e.invalidateInnerBounds(),e.invalidateStates(),e.updateRawState();const r=e.raw;if(!this.system.optimizer.update(this)){const i=this.orientation.current,s=this.orientation.target,a=r.relativeOrientation;s.angleTo(a)>this.system.epsillonRadians&&i.angleTo(a)>this.system.epsillonRadians&&(this.orientation.target=a);const u=this.bounds.current,o=this.bounds.target,l=r.spatialBounds;(o.min.distanceTo(l.min)>this.system.epsillonMeters||o.max.distanceTo(l.max)>this.system.epsillonMeters)&&(u.min.distanceTo(l.min)>this.system.epsillonMeters||u.max.distanceTo(l.max)>this.system.epsillonMeters)&&(this.bounds.target=l)}}else e.invalidateIntrinsicBounds(),e.invalidateInnerBounds(),e.invalidateStates(),this.system.optimizer.update(this);this.opacity.update(),this.orientation.update(),this.bounds.update(),this._progress=this._computeProgress(),e.invalidateStates(),this.system.bindings.apply(e,e.current),e.invalidateStates(),(t=this.onPostUpdate)==null||t.call(this)}}class kr{constructor(){c(this,"_cache",new Lt);c(this,"isLayoutFrustum",!0);c(this,"_leftDegrees",-20);c(this,"_rightDegrees",20);c(this,"_bottomDegrees",-20);c(this,"_topDegrees",20);c(this,"_nearMeters",.5);c(this,"_farMeters",1e3);c(this,"_size",new se);c(this,"_center",new se);c(this,"_v1",new A);c(this,"_inverseProjection",new F);c(this,"_forwardDirection",new A(0,0,-1));c(this,"_fullNDC",new Z(new A(-1,-1,-1),new A(1,1,1)));c(this,"_cachedPerspectiveProjectionMatrix",this._cache.memoize(()=>{const e=this.nearMeters,t=this.farMeters,r=e*Math.tan(this.leftDegrees*K),i=e*Math.tan(this.rightDegrees*K),s=e*Math.tan(this.topDegrees*K),a=e*Math.tan(this.bottomDegrees*K);return this._perspective.makePerspective(r,i,s,a,e,t)}));c(this,"_perspective",new F);c(this,"_boxA",new nt);c(this,"_boxB",new nt);c(this,"_overlapSize",new se)}get leftDegrees(){return this._leftDegrees}set leftDegrees(e){e!==this._leftDegrees&&(this._leftDegrees=e,this._cache.invalidateAll())}get rightDegrees(){return this._rightDegrees}set rightDegrees(e){e!==this._rightDegrees&&(this._rightDegrees=e,this._cache.invalidateAll())}get bottomDegrees(){return this._bottomDegrees}set bottomDegrees(e){e!==this._bottomDegrees&&(this._bottomDegrees=e,this._cache.invalidateAll())}get topDegrees(){return this._topDegrees}set topDegrees(e){e!==this._topDegrees&&(this._topDegrees=e,this._cache.invalidateAll())}get nearMeters(){return this._nearMeters}set nearMeters(e){e!==this._nearMeters&&(this._nearMeters=e,this._cache.invalidateAll())}get farMeters(){return this._farMeters}set farMeters(e){e!==this._farMeters&&(this._farMeters=e,this._cache.invalidateAll())}get sizeDegrees(){return this._size.set(this.rightDegrees-this.leftDegrees,this.topDegrees-this.bottomDegrees),this._size}get diagonalDegrees(){const e=this.sizeDegrees;return Math.acos(Math.cos(e.x*K)*Math.cos(e.y*K))*H}get centerDegrees(){const e=this.sizeDegrees;return this._center.set(this.leftDegrees+e.x/2,this.bottomDegrees+e.y/2)}get angleToCenter(){const e=this.centerDegrees;return Math.acos(Math.cos(e.x*K)*Math.cos(e.y*K))*H}get angleToTopLeft(){return Math.acos(Math.cos(this.leftDegrees*K)*Math.cos(this.topDegrees*K))*H}get angleToTopRight(){return Math.acos(Math.cos(this.rightDegrees*K)*Math.cos(this.topDegrees*K))*H}get angleToBottomLeft(){return Math.acos(Math.cos(this.leftDegrees*K)*Math.cos(this.bottomDegrees*K))*H}get angleToBottomRight(){return Math.acos(Math.cos(this.rightDegrees*K)*Math.cos(this.bottomDegrees*K))*H}get angleToClosestPoint(){const e=Math.min(Math.max(0,this.leftDegrees),this.rightDegrees),t=Math.min(Math.max(0,this.bottomDegrees),this.topDegrees);return Math.acos(Math.cos(e*K)*Math.cos(t*K))*H}get angleToFarthestPoint(){return Math.max(this.angleToTopLeft,this.angleToTopRight,this.angleToBottomLeft,this.angleToBottomRight)}get depth(){return this.farMeters-this.nearMeters}get distance(){return this.nearMeters+this.depth/2}get aspectRatio(){const e=this.nearMeters,t=e*Math.tan(this.leftDegrees*K),r=e*Math.tan(this.rightDegrees*K),i=e*Math.tan(this.topDegrees*K),s=e*Math.tan(this.bottomDegrees*K);return(i-s)/(r-t)}setFromPerspectiveProjectionMatrix(e,t=this._fullNDC){const r=this._inverseProjection.copy(e).invert(),i=this._v1,s=this._forwardDirection,a=Math.sign(t.min.x)*i.set(t.min.x,0,-1).applyMatrix4(r).angleTo(s)*H,u=Math.sign(t.max.x)*i.set(t.max.x,0,-1).applyMatrix4(r).angleTo(s)*H,o=Math.sign(t.max.y)*i.set(0,t.max.y,-1).applyMatrix4(r).angleTo(s)*H,l=Math.sign(t.min.y)*i.set(0,t.min.y,-1).applyMatrix4(r).angleTo(s)*H,p=-i.set(0,0,t.min.z).applyMatrix4(r).z,m=-i.set(0,0,t.max.z).applyMatrix4(r).z;return this.leftDegrees=a,this.rightDegrees=u,this.topDegrees=o,this.bottomDegrees=l,this.nearMeters=p,this.farMeters=m,this}get perspectiveProjectionMatrix(){return this._cachedPerspectiveProjectionMatrix()}overlapPercent(e){return this._boxA.min.x=this.leftDegrees,this._boxA.max.x=this.rightDegrees,this._boxA.min.y=this.bottomDegrees,this._boxA.max.y=this.topDegrees,this._boxB.min.x=e.leftDegrees,this._boxB.max.x=e.rightDegrees,this._boxB.min.y=e.bottomDegrees,this._boxB.max.y=e.topDegrees,this._boxA.intersect(this._boxB).getSize(this._overlapSize).length()/this.sizeDegrees.length()}}class Nr{constructor(e,t){c(this,"math",$i({evaluateDependencies:Gi,addDependencies:Qi,subtractDependencies:Xi,multiplyDependencies:Yi,divideDependencies:Zi,modDependencies:Ji,numberDependencies:es,createUnitDependencies:ts,unitDependencies:ns},{predictable:!0}));c(this,"mathCompiledExpressions",new Map);c(this,"mathScope",{ratio:void 0,degree:this.math.unit("degree"),meter:this.math.unit("meter"),pixel:this.math.createUnit("pixel",{aliases:["pixels","px"]}),percent:void 0,vdeg:void 0,vw:void 0,vh:void 0});c(this,"epsillonMeters",1e-10);c(this,"epsillonRadians",1e-10);c(this,"epsillonRatio",1e-10);c(this,"transition",new st({multiplier:1,duration:0,easing:Ir.easeInOut,threshold:0,delay:0,debounce:0,maxWait:10,blend:!0}));c(this,"optimize",new Nt({minFeasibleTime:.02,maxInfeasibleTime:5,relativeTolerance:.001,maxIterationsPerFrame:10,swarmSize:10,pulseFrequencyMin:0,pulseFrequencyMax:1,pulseRate:.4,stepSizeMin:1e-4,stepSizeMax:4,stepSizeStart:1.5}));c(this,"optimizer",new Rr(this));c(this,"viewFrustum",new kr);c(this,"viewResolution",new se(1e3,1e3));c(this,"deltaTime",1/60);c(this,"time",0);c(this,"maxDeltaTime",1/60);c(this,"nodeMetrics",new Map);c(this,"nodeAdapters",new Map);c(this,"transitionables",[]);c(this,"getMetrics",e=>{if(!e)throw new Error("node must be defined");let t=this.nodeMetrics.get(e);return t||(t=new Er(this,e),this.nodeMetrics.set(e,t)),t});c(this,"getState",e=>{if(!e)throw new Error("node must be defined");return this.getMetrics(e).target});c(this,"getAdapter",e=>{let t=this.nodeAdapters.get(e);return t||(t=new Pr(this,e),this.nodeAdapters.set(e,t)),t});c(this,"createTransitionable",(e,t)=>{const r=new ge(this,e,t,this.transition);return this.transitionables.push(r),r});c(this,"_prevResolution",new se);c(this,"_prevSize",new se);c(this,"measureNumberCache",{});this.viewNode=e,this.bindings=t}get viewMetrics(){if(!this.viewNode)throw new Error("EtherealSystem.viewNode must be defined");return this.getMetrics(this.viewNode)}update(e,t){this.deltaTime=Math.max(e,this.maxDeltaTime),this.time=t,(!this._prevResolution.equals(this.viewResolution)||!this._prevSize.equals(this.viewFrustum.sizeDegrees))&&(this.mathScope.vdeg=this.math.unit(this.viewResolution.y/this.viewFrustum.sizeDegrees.y,"px"),this.mathScope.vw=this.math.unit(this.viewResolution.x/100,"px"),this.mathScope.vh=this.math.unit(this.viewResolution.y/100,"px"),this.measureNumberCache={}),this._prevResolution.copy(this.viewResolution),this._prevSize.copy(this.viewFrustum.sizeDegrees);for(const r of this.nodeMetrics.values()){r.needsUpdate=!0;const i=this.nodeAdapters.get(r.node);i&&(i.opacity.needsUpdate=!0,i.orientation.needsUpdate=!0,i.bounds.needsUpdate=!0,i.outerOrigin.needsUpdate=!0,i.outerOrientation.needsUpdate=!0,i.outerBounds.needsUpdate=!0,i.outerVisualBounds.needsUpdate=!0)}for(const r of this.transitionables)r.needsUpdate=!0;for(const r of this.transitionables)r.update();this.viewMetrics.update();for(const r of this.nodeAdapters.values())r.metrics.update()}measureNumber(e,t){if(typeof e=="number")return e;if(e in this.measureNumberCache)return this.measureNumberCache[e];if(!this.mathCompiledExpressions.has(e)){const u=this.math.parse(e).compile();this.mathCompiledExpressions.set(e,u)}const r=this.mathCompiledExpressions.get(e),i=r.evaluate(this.mathScope),s=typeof i=="number"?i:this.math.number(r.evaluate(this.mathScope),t);return this.measureNumberCache[e]=s,s}}const Ws=new A;class qs{constructor(e=0,t=0,r=0){this.horizontalRadians=e,this.verticalRadians=t,this.distance=r}get horizontalDegrees(){return this.horizontalRadians*H}set horizontalDegrees(e){this.horizontalRadians=e*K}get verticalDegrees(){return this.verticalRadians*H}set verticalDegrees(e){this.verticalRadians=e*K}setWithRadians(e,t,r){return this.horizontalRadians=e,this.verticalRadians=t,this.distance=r,this}setWithDegrees(e,t,r){return this.horizontalDegrees=e,this.verticalDegrees=t,this.distance=r,this}fromCartesianDirection(e){const t=Ws.copy(e).normalize();return this.verticalRadians=Math.asin(t.y)*H,this.horizontalRadians=Math.atan2(t.x,-t.z)*H,this.distance=0,this}fromCartesianPosition(e){return this.fromCartesianDirection(e),this.distance=e.length(),this}toCartesianDirection(e){const t=this.verticalRadians,r=-Math.PI-this.horizontalRadians,i=Math.sin(t),s=Math.cos(t)*Math.sin(r),a=-Math.cos(t)*Math.cos(r);return e.set(s,i,a).normalize()}toCartesianPosition(e){return this.toCartesianDirection(e).multiplyScalar(this.distance)}}const Hs=new F,$s=new F,at={getChildren(n,e){const t=n.node;if(!!t.isObject3D){e.length=0;for(let r=0;r<t.children.length;r++)e[r]=t.children[r]}},getState(n){var i;if(n.system.viewNode===n.node){const s=n.node;s.updateMatrixWorld(),n.system.viewFrustum.setFromPerspectiveProjectionMatrix(s.projectionMatrix)}const e=n.node;if(!e.isObject3D)return;let t,r;if(n.isAdaptive){const s=(i=n.referenceMetrics)==null?void 0:i.target.worldMatrix;r=Hs.compose(e.position,e.quaternion,e.scale),t=s?$s.multiplyMatrices(s,r):r}else t=e.matrixWorld,r=e.matrix;n.raw.parent=e.parent,n.raw.worldMatrix.copy(t),n.raw.relativeMatrix.copy(r),n.raw.opacity=Fr(n)||1},getIntrinsicBounds(n,e){const t=n.node;if(!!t.isObject3D)return t.geometry?(t.geometry.boundingBox||t.geometry.computeBoundingBox(),e.copy(t.geometry.boundingBox)):e},apply(n,e){const t=n.node;if(!t.isObject3D)return;if(e.parent!==t.parent){const i=e.parent;i&&i.add(t)}let r=e.localMatrix;if(isNaN(r.elements[0])||isNaN(r.elements[13])||isNaN(r.elements[14])||isNaN(r.elements[15])||r.elements[0]===0)throw new Error;if(r=e.worldMatrix,isNaN(r.elements[0])||isNaN(r.elements[13])||isNaN(r.elements[14])||isNaN(r.elements[15])||r.elements[0]===0)throw new Error;t.matrixAutoUpdate=!1,t.matrix.copy(e.localMatrix),t.matrixWorld.copy(e.worldMatrix),Ur(n,e.opacity)}};function Fr(n){const e=n.node;if(e.material){const t=e.material;if(t.length){for(const r of t)if(r.opacity!==void 0)return r.opacity}else if("opacity"in e.material)return e.material.opacity}for(const t of n.boundingChildMetrics){const r=Fr(t);if(r!==void 0)return r}}function Ur(n,e){const t=n.node;if(t.material){const r=t.material;if(r.length)for(const i of r)"opacity"in i&&(i.opacity=e);else t.material.opacity=e}for(const r of n.boundingChildMetrics)Ur(r,e)}const Kr={getChildren(n,e){n.node.isObject3D&&at.getChildren(n,e)},getState(n){n.node.isObject3D&&at.getState(n)},getIntrinsicBounds(n,e){return n.node.isObject3D&&at.getIntrinsicBounds(n,e),e},apply(n,e){n.node.isObject3D&&at.apply(n,e)}};function Gs(n,e=Kr){return new Nr(n,e)}var Jo=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",ThreeBindings:at,DefaultBindings:Kr,createLayoutSystem:Gs,EtherealLayoutSystem:Nr,MathUtils:rs,Matrix3:is,Matrix4:F,V_00:wr,V_11:ws,V_000:ae,V_100:_s,V_010:xs,V_001:Ss,V_111:pn,Q_IDENTITY:mn,DIRECTION:rt,Vector2:se,Vector3:A,Vector4:ss,Quaternion:q,Euler:mr,Color:dn,Box2:nt,Box3:Z,Ray:as,Line3:os,Plane:us,computeRelativeDifference:yn,gaussian:it,levy:gn,randomQuaternion:zt,randomSelect:xr,extractRotationAboutAxis:Os,LayoutFrustum:kr,NodeStateBase:Mr,NodeState:ye,SpatialMetrics:Er,SpatialAdapter:Pr,SpatialLayout:Dr,LayoutSolution:oe,OptimizerConfig:Nt,SpatialOptimizer:Rr,easing:Ir,Transition:zr,TransitionConfig:st,Transitionable:ge,SphericalCoordinate:qs,MemoizationCache:Lt});function Ft(n,e,t,r=0){var i;r++,n=n.shadowRoot||n;for(let s=n.firstElementChild;s;s=s.nextElementSibling){if(s.assignedSlot)continue;const a=(i=s.assignedElements)==null?void 0:i.call(s,{flatten:!0});if(a)for(const u of a)e.call(t,u,r)&&Ft(s,e,t,r);e.call(t,s,r)&&Ft(s,e,t,r)}}class ze{constructor(){c(this,"left",0);c(this,"top",0);c(this,"width",0);c(this,"height",0)}copy(e){return this.top=e.top,this.left=e.left,this.width=e.width,this.height=e.height,this}}class Ve{constructor(){c(this,"left",0);c(this,"top",0);c(this,"right",0);c(this,"bottom",0)}copy(e){return this.top=e.top,this.left=e.left,this.right=e.right,this.bottom=e.bottom,this}}function ot(n,e=new ze,t){const r=n.ownerDocument,i=r.documentElement,s=r.body;if(n===i)return Ys(r,e);if(t===n){e.left=0,e.top=0,e.width=n.offsetWidth,e.height=n.offsetHeight;return}const a=n.ownerDocument.defaultView;let u=n,o,l=u.offsetParent,p=a.getComputedStyle(u,null),m=u.offsetTop,f=u.offsetLeft;for(l&&t&&(l.contains(t)||l.contains(t.getRootNode().host))&&l!==t&&(ot(t,e,l),f-=e.left,m-=e.top);(u=u.parentElement)&&u!==s&&u!==i&&u!==t&&p.position!=="fixed";)o=a.getComputedStyle(u,null),m-=u.scrollTop,f-=u.scrollLeft,u===l&&(m+=u.offsetTop,f+=u.offsetLeft,m+=parseFloat(o.borderTopWidth)||0,f+=parseFloat(o.borderLeftWidth)||0,l=u.offsetParent),p=o;return p.position==="fixed"&&(m+=Math.max(i.scrollTop,s.scrollTop),f+=Math.max(i.scrollLeft,s.scrollLeft)),e.left=f,e.top=m,e.width=n.offsetWidth,e.height=n.offsetHeight,e}function Vr(n,e){if(n.offsetParent===null){e.left=e.right=e.top=e.bottom=0;return}let t=getComputedStyle(n);e.left=parseFloat(t.marginLeft)||0,e.right=parseFloat(t.marginRight)||0,e.top=parseFloat(t.marginTop)||0,e.bottom=parseFloat(t.marginBottom)||0}function Qs(n,e){let t=getComputedStyle(n);e.left=parseFloat(t.borderLeftWidth)||0,e.right=parseFloat(t.borderRightWidth)||0,e.top=parseFloat(t.borderTopWidth)||0,e.bottom=parseFloat(t.borderBottomWidth)||0}function Xs(n,e){let t=getComputedStyle(n);e.left=parseFloat(t.paddingLeft)||0,e.right=parseFloat(t.paddingRight)||0,e.top=parseFloat(t.paddingTop)||0,e.bottom=parseFloat(t.paddingBottom)||0}const je=document.createElement("div");je.id="VIEWPORT";je.style.position="fixed";je.style.width="100vw";je.style.height="100vh";je.style.visibility="hidden";je.style.pointerEvents="none";function Ys(n,e){const t=n.documentElement,r=n.body,i=getComputedStyle(t),s=getComputedStyle(r);return e.top=r.offsetTop+parseFloat(i.marginTop)||0+parseFloat(s.marginTop)||0,e.left=r.offsetLeft+parseFloat(i.marginLeft)||0+parseFloat(s.marginLeft)||0,e.width=Math.max(Math.max(r.scrollWidth,t.scrollWidth),Math.max(r.offsetWidth,t.offsetWidth),Math.max(r.clientWidth,t.clientWidth)),e.height=Math.max(Math.max(r.scrollHeight,t.scrollHeight),Math.max(r.offsetHeight,t.offsetHeight),Math.max(r.clientHeight,t.clientHeight)),e}function Zs(n){const e=document.createElement("div");e.innerHTML=n;const t=e.firstElementChild;return e.removeChild(t),t}(function(n){function e(){}function t(o,l){if(o=o===void 0?"utf-8":o,l=l===void 0?{fatal:!1}:l,a.indexOf(o.toLowerCase())===-1)throw new RangeError("Failed to construct 'TextDecoder': The encoding label provided ('"+o+"') is invalid.");if(l.fatal)throw Error("Failed to construct 'TextDecoder': the 'fatal' option is unsupported.")}function r(o){return Buffer.from(o.buffer,o.byteOffset,o.byteLength).toString("utf-8")}function i(o){var l=URL.createObjectURL(new Blob([o],{type:"text/plain;charset=UTF-8"}));try{var p=new XMLHttpRequest;return p.open("GET",l,!1),p.send(),p.responseText}catch{return s(o)}finally{URL.revokeObjectURL(l)}}function s(o){for(var l=0,p=Math.min(65536,o.length+1),m=new Uint16Array(p),f=[],h=0;;){var d=l<o.length;if(!d||h>=p-1){if(f.push(String.fromCharCode.apply(null,m.subarray(0,h))),!d)return f.join("");o=o.subarray(l),h=l=0}if(d=o[l++],(d&128)==0)m[h++]=d;else if((d&224)==192){var y=o[l++]&63;m[h++]=(d&31)<<6|y}else if((d&240)==224){y=o[l++]&63;var v=o[l++]&63;m[h++]=(d&31)<<12|y<<6|v}else if((d&248)==240){y=o[l++]&63,v=o[l++]&63;var w=o[l++]&63;d=(d&7)<<18|y<<12|v<<6|w,65535<d&&(d-=65536,m[h++]=d>>>10&1023|55296,d=56320|d&1023),m[h++]=d}}}if(n.TextEncoder&&n.TextDecoder)return!1;var a=["utf-8","utf8","unicode-1-1-utf-8"];Object.defineProperty(e.prototype,"encoding",{value:"utf-8"}),e.prototype.encode=function(o,l){if(l=l===void 0?{stream:!1}:l,l.stream)throw Error("Failed to encode: the 'stream' option is unsupported.");l=0;for(var p=o.length,m=0,f=Math.max(32,p+(p>>>1)+7),h=new Uint8Array(f>>>3<<3);l<p;){var d=o.charCodeAt(l++);if(55296<=d&&56319>=d){if(l<p){var y=o.charCodeAt(l);(y&64512)==56320&&(++l,d=((d&1023)<<10)+(y&1023)+65536)}if(55296<=d&&56319>=d)continue}if(m+4>h.length&&(f+=8,f*=1+l/o.length*2,f=f>>>3<<3,y=new Uint8Array(f),y.set(h),h=y),(d&4294967168)==0)h[m++]=d;else{if((d&4294965248)==0)h[m++]=d>>>6&31|192;else if((d&4294901760)==0)h[m++]=d>>>12&15|224,h[m++]=d>>>6&63|128;else if((d&4292870144)==0)h[m++]=d>>>18&7|240,h[m++]=d>>>12&63|128,h[m++]=d>>>6&63|128;else continue;h[m++]=d&63|128}}return h.slice?h.slice(0,m):h.subarray(0,m)},Object.defineProperty(t.prototype,"encoding",{value:"utf-8"}),Object.defineProperty(t.prototype,"fatal",{value:!1}),Object.defineProperty(t.prototype,"ignoreBOM",{value:!1});var u=s;typeof Buffer=="function"&&Buffer.from?u=r:typeof Blob=="function"&&typeof URL=="function"&&typeof URL.createObjectURL=="function"&&(u=i),t.prototype.decode=function(o,l){if(l=l===void 0?{stream:!1}:l,l.stream)throw Error("Failed to decode: the 'stream' option is unsupported.");return o=o instanceof Uint8Array?o:o.buffer instanceof ArrayBuffer?new Uint8Array(o.buffer):new Uint8Array(o),u(o)},n.TextEncoder=e,n.TextDecoder=t})(typeof window!="undefined"?window:typeof Bt!="undefined"?Bt:Bt);var vn={exports:{}};(function(n){(function(e,t){var r={};t(r);var i=r.default;for(var s in r)i[s]=r[s];n.exports=i})(Bt,function(e){e.__esModule=!0,e.digestLength=32,e.blockSize=64;var t=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]);function r(f,h,d,y,v){for(var w,_,g,x,b,S,E,T,M,B,L,N,P;v>=64;){for(w=h[0],_=h[1],g=h[2],x=h[3],b=h[4],S=h[5],E=h[6],T=h[7],B=0;B<16;B++)L=y+B*4,f[B]=(d[L]&255)<<24|(d[L+1]&255)<<16|(d[L+2]&255)<<8|d[L+3]&255;for(B=16;B<64;B++)M=f[B-2],N=(M>>>17|M<<32-17)^(M>>>19|M<<32-19)^M>>>10,M=f[B-15],P=(M>>>7|M<<32-7)^(M>>>18|M<<32-18)^M>>>3,f[B]=(N+f[B-7]|0)+(P+f[B-16]|0);for(B=0;B<64;B++)N=(((b>>>6|b<<32-6)^(b>>>11|b<<32-11)^(b>>>25|b<<32-25))+(b&S^~b&E)|0)+(T+(t[B]+f[B]|0)|0)|0,P=((w>>>2|w<<32-2)^(w>>>13|w<<32-13)^(w>>>22|w<<32-22))+(w&_^w&g^_&g)|0,T=E,E=S,S=b,b=x+N|0,x=g,g=_,_=w,w=N+P|0;h[0]+=w,h[1]+=_,h[2]+=g,h[3]+=x,h[4]+=b,h[5]+=S,h[6]+=E,h[7]+=T,y+=64,v-=64}return y}var i=function(){function f(){this.digestLength=e.digestLength,this.blockSize=e.blockSize,this.state=new Int32Array(8),this.temp=new Int32Array(64),this.buffer=new Uint8Array(128),this.bufferLength=0,this.bytesHashed=0,this.finished=!1,this.reset()}return f.prototype.reset=function(){return this.state[0]=1779033703,this.state[1]=3144134277,this.state[2]=1013904242,this.state[3]=2773480762,this.state[4]=1359893119,this.state[5]=2600822924,this.state[6]=528734635,this.state[7]=1541459225,this.bufferLength=0,this.bytesHashed=0,this.finished=!1,this},f.prototype.clean=function(){for(var h=0;h<this.buffer.length;h++)this.buffer[h]=0;for(var h=0;h<this.temp.length;h++)this.temp[h]=0;this.reset()},f.prototype.update=function(h,d){if(d===void 0&&(d=h.length),this.finished)throw new Error("SHA256: can't update because hash was finished.");var y=0;if(this.bytesHashed+=d,this.bufferLength>0){for(;this.bufferLength<64&&d>0;)this.buffer[this.bufferLength++]=h[y++],d--;this.bufferLength===64&&(r(this.temp,this.state,this.buffer,0,64),this.bufferLength=0)}for(d>=64&&(y=r(this.temp,this.state,h,y,d),d%=64);d>0;)this.buffer[this.bufferLength++]=h[y++],d--;return this},f.prototype.finish=function(h){if(!this.finished){var d=this.bytesHashed,y=this.bufferLength,v=d/536870912|0,w=d<<3,_=d%64<56?64:128;this.buffer[y]=128;for(var g=y+1;g<_-8;g++)this.buffer[g]=0;this.buffer[_-8]=v>>>24&255,this.buffer[_-7]=v>>>16&255,this.buffer[_-6]=v>>>8&255,this.buffer[_-5]=v>>>0&255,this.buffer[_-4]=w>>>24&255,this.buffer[_-3]=w>>>16&255,this.buffer[_-2]=w>>>8&255,this.buffer[_-1]=w>>>0&255,r(this.temp,this.state,this.buffer,0,_),this.finished=!0}for(var g=0;g<8;g++)h[g*4+0]=this.state[g]>>>24&255,h[g*4+1]=this.state[g]>>>16&255,h[g*4+2]=this.state[g]>>>8&255,h[g*4+3]=this.state[g]>>>0&255;return this},f.prototype.digest=function(){var h=new Uint8Array(this.digestLength);return this.finish(h),h},f.prototype._saveState=function(h){for(var d=0;d<this.state.length;d++)h[d]=this.state[d]},f.prototype._restoreState=function(h,d){for(var y=0;y<this.state.length;y++)this.state[y]=h[y];this.bytesHashed=d,this.finished=!1,this.bufferLength=0},f}();e.Hash=i;var s=function(){function f(h){this.inner=new i,this.outer=new i,this.blockSize=this.inner.blockSize,this.digestLength=this.inner.digestLength;var d=new Uint8Array(this.blockSize);if(h.length>this.blockSize)new i().update(h).finish(d).clean();else for(var y=0;y<h.length;y++)d[y]=h[y];for(var y=0;y<d.length;y++)d[y]^=54;this.inner.update(d);for(var y=0;y<d.length;y++)d[y]^=54^92;this.outer.update(d),this.istate=new Uint32Array(8),this.ostate=new Uint32Array(8),this.inner._saveState(this.istate),this.outer._saveState(this.ostate);for(var y=0;y<d.length;y++)d[y]=0}return f.prototype.reset=function(){return this.inner._restoreState(this.istate,this.inner.blockSize),this.outer._restoreState(this.ostate,this.outer.blockSize),this},f.prototype.clean=function(){for(var h=0;h<this.istate.length;h++)this.ostate[h]=this.istate[h]=0;this.inner.clean(),this.outer.clean()},f.prototype.update=function(h){return this.inner.update(h),this},f.prototype.finish=function(h){return this.outer.finished?this.outer.finish(h):(this.inner.finish(h),this.outer.update(h,this.digestLength).finish(h)),this},f.prototype.digest=function(){var h=new Uint8Array(this.digestLength);return this.finish(h),h},f}();e.HMAC=s;function a(f){var h=new i().update(f),d=h.digest();return h.clean(),d}e.hash=a,e.default=a;function u(f,h){var d=new s(f).update(h),y=d.digest();return d.clean(),y}e.hmac=u;function o(f,h,d,y){var v=y[0];if(v===0)throw new Error("hkdf: cannot expand more");h.reset(),v>1&&h.update(f),d&&h.update(d),h.update(y),h.finish(f),y[0]++}var l=new Uint8Array(e.digestLength);function p(f,h,d,y){h===void 0&&(h=l),y===void 0&&(y=32);for(var v=new Uint8Array([1]),w=u(h,f),_=new s(w),g=new Uint8Array(_.digestLength),x=g.length,b=new Uint8Array(y),S=0;S<y;S++)x===g.length&&(o(g,_,d,v),x=0),b[S]=g[x++];return _.clean(),g.fill(0),v.fill(0),b}e.hkdf=p;function m(f,h,d,y){for(var v=new s(f),w=v.digestLength,_=new Uint8Array(4),g=new Uint8Array(w),x=new Uint8Array(w),b=new Uint8Array(y),S=0;S*w<y;S++){var E=S+1;_[0]=E>>>24&255,_[1]=E>>>16&255,_[2]=E>>>8&255,_[3]=E>>>0&255,v.reset(),v.update(h),v.update(_),v.finish(x);for(var T=0;T<w;T++)g[T]=x[T];for(var T=2;T<=d;T++){v.reset(),v.update(x).finish(x);for(var M=0;M<w;M++)g[M]^=x[M]}for(var T=0;T<w&&S*w+T<y;T++)b[S*w+T]=g[T]}for(var S=0;S<w;S++)g[S]=x[S]=0;for(var S=0;S<4;S++)_[S]=0;return v.clean(),b}e.pbkdf2=m})})(vn);function Js(n){return n.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g,"")}function jr(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function ea(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function ut(n,e){return" "+n+'="'+jr(e)+'"'}function ta(n,e){return!n.hasAttribute("xmlns")&&(e||n.namespaceURI!==n.parentElement.namespaceURI)?' xmlns="'+n.namespaceURI+'"':""}async function Wr(n,e){let t=[];for(const r of n.childNodes)t.push(qr(r,e));return Promise.all(t).then(r=>r.join(""))}async function na(n,e){const t=n.tagName.toLowerCase();let r="<"+t;r+=ta(n,e.depth===0);const i=Wr(n,e);for(const s of n.attributes)s.name==="src"?r+=ut(s.name,await R.getDataURL(s.value)):r+=ut(s.name,s.value);return n.childNodes.length>0?(e.depth++,r+=">",r+=await i,r+="</"+t+">",e.depth--):r+="/>",r}function ra(n){var e=n.nodeValue||"";return ea(e)}function ia(n){return"<![CDATA["+n.nodeValue+"]]>"}async function qr(n,e){var r;const t=(r=e.replacer)==null?void 0:r.call(e,n);if(typeof t=="string")return t;if(n.nodeName==="#document"||n.nodeName==="#document-fragment")return Wr(n,e);if(n.tagName)return na(n,e);if(n.nodeName==="#text")return ra(n);if(n.nodeName!=="#comment"){if(n.nodeName==="#cdata-section")return ia(n)}return""}async function sa(n,e){return Js(await qr(n,{depth:0,replacer:e}))}/*! *****************************************************************************
Copyright (c) Microsoft Corporation.
Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.
THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var k=function(){return k=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++){t=arguments[r];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s])}return e},k.apply(this,arguments)};function bn(n,e,t){if(t||arguments.length===2)for(var r=0,i=e.length,s;r<i;r++)(s||!(r in e))&&(s||(s=Array.prototype.slice.call(e,0,r)),s[r]=e[r]);return n.concat(s||Array.prototype.slice.call(e))}var V=typeof globalThis!="undefined"?globalThis:typeof self!="undefined"?self:typeof window!="undefined"?window:global,W=Object.keys,X=Array.isArray;typeof Promise!="undefined"&&!V.Promise&&(V.Promise=Promise);function J(n,e){return typeof e!="object"||W(e).forEach(function(t){n[t]=e[t]}),n}var ct=Object.getPrototypeOf,aa={}.hasOwnProperty;function ue(n,e){return aa.call(n,e)}function We(n,e){typeof e=="function"&&(e=e(ct(n))),(typeof Reflect=="undefined"?W:Reflect.ownKeys)(e).forEach(function(t){ve(n,t,e[t])})}var Hr=Object.defineProperty;function ve(n,e,t,r){Hr(n,e,J(t&&ue(t,"get")&&typeof t.get=="function"?{get:t.get,set:t.set,configurable:!0}:{value:t,configurable:!0,writable:!0},r))}function qe(n){return{from:function(e){return n.prototype=Object.create(e.prototype),ve(n.prototype,"constructor",n),{extend:We.bind(null,n.prototype)}}}}var oa=Object.getOwnPropertyDescriptor;function wn(n,e){var t=oa(n,e),r;return t||(r=ct(n))&&wn(r,e)}var ua=[].slice;function Ut(n,e,t){return ua.call(n,e,t)}function $r(n,e){return e(n)}function lt(n){if(!n)throw new Error("Assertion Failed")}function Gr(n){V.setImmediate?setImmediate(n):setTimeout(n,0)}function Qr(n,e){return n.reduce(function(t,r,i){var s=e(r,i);return s&&(t[s[0]]=s[1]),t},{})}function ca(n,e,t){try{n.apply(null,t)}catch(r){e&&e(r)}}function be(n,e){if(ue(n,e))return n[e];if(!e)return n;if(typeof e!="string"){for(var t=[],r=0,i=e.length;r<i;++r){var s=be(n,e[r]);t.push(s)}return t}var a=e.indexOf(".");if(a!==-1){var u=n[e.substr(0,a)];return u===void 0?void 0:be(u,e.substr(a+1))}}function he(n,e,t){if(!(!n||e===void 0)&&!("isFrozen"in Object&&Object.isFrozen(n)))if(typeof e!="string"&&"length"in e){lt(typeof t!="string"&&"length"in t);for(var r=0,i=e.length;r<i;++r)he(n,e[r],t[r])}else{var s=e.indexOf(".");if(s!==-1){var a=e.substr(0,s),u=e.substr(s+1);if(u==="")t===void 0?X(n)&&!isNaN(parseInt(a))?n.splice(a,1):delete n[a]:n[a]=t;else{var o=n[a];o||(o=n[a]={}),he(o,u,t)}}else t===void 0?X(n)&&!isNaN(parseInt(e))?n.splice(e,1):delete n[e]:n[e]=t}}function la(n,e){typeof e=="string"?he(n,e,void 0):"length"in e&&[].map.call(e,function(t){he(n,t,void 0)})}function Xr(n){var e={};for(var t in n)ue(n,t)&&(e[t]=n[t]);return e}var ha=[].concat;function Yr(n){return ha.apply([],n)}var Zr="Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(Yr([8,16,32,64].map(function(n){return["Int","Uint","Float"].map(function(e){return e+n+"Array"})}))).filter(function(n){return V[n]}),fa=Zr.map(function(n){return V[n]});Qr(Zr,function(n){return[n,!0]});var Re=null;function ht(n){Re=typeof WeakMap!="undefined"&&new WeakMap;var e=_n(n);return Re=null,e}function _n(n){if(!n||typeof n!="object")return n;var e=Re&&Re.get(n);if(e)return e;if(X(n)){e=[],Re&&Re.set(n,e);for(var t=0,r=n.length;t<r;++t)e.push(_n(n[t]))}else if(fa.indexOf(n.constructor)>=0)e=n;else{var i=ct(n);e=i===Object.prototype?{}:Object.create(i),Re&&Re.set(n,e);for(var s in n)ue(n,s)&&(e[s]=_n(n[s]))}return e}var da={}.toString;function xn(n){return da.call(n).slice(8,-1)}var Sn=typeof Symbol!="undefined"?Symbol.iterator:"@@iterator",pa=typeof Sn=="symbol"?function(n){var e;return n!=null&&(e=n[Sn])&&e.apply(n)}:function(){return null},He={};function we(n){var e,t,r,i;if(arguments.length===1){if(X(n))return n.slice();if(this===He&&typeof n=="string")return[n];if(i=pa(n)){for(t=[];r=i.next(),!r.done;)t.push(r.value);return t}if(n==null)return[n];if(e=n.length,typeof e=="number"){for(t=new Array(e);e--;)t[e]=n[e];return t}return[n]}for(e=arguments.length,t=new Array(e);e--;)t[e]=arguments[e];return t}var Tn=typeof Symbol!="undefined"?function(n){return n[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},pe=typeof location!="undefined"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function Jr(n,e){pe=n,ei=e}var ei=function(){return!0},ma=!new Error("").stack;function Le(){if(ma)try{throw Le.arguments,new Error}catch(n){return n}return new Error}function Mn(n,e){var t=n.stack;return t?(e=e||0,t.indexOf(n.name)===0&&(e+=(n.name+n.message).split(`
`).length),t.split(`
`).slice(e).filter(ei).map(function(r){return`
`+r}).join("")):""}var ya=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"],ti=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],En=ya.concat(ti),ga={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function $e(n,e){this._e=Le(),this.name=n,this.message=e}qe($e).from(Error).extend({stack:{get:function(){return this._stack||(this._stack=this.name+": "+this.message+Mn(this._e,2))}},toString:function(){return this.name+": "+this.message}});function ni(n,e){return n+". Errors: "+Object.keys(e).map(function(t){return e[t].toString()}).filter(function(t,r,i){return i.indexOf(t)===r}).join(`
`)}function Kt(n,e,t,r){this._e=Le(),this.failures=e,this.failedKeys=r,this.successCount=t,this.message=ni(n,e)}qe(Kt).from($e);function ft(n,e){this._e=Le(),this.name="BulkError",this.failures=Object.keys(e).map(function(t){return e[t]}),this.failuresByPos=e,this.message=ni(n,e)}qe(ft).from($e);var va=En.reduce(function(n,e){return n[e]=e+"Error",n},{}),ba=$e,I=En.reduce(function(n,e){var t=e+"Error";function r(i,s){this._e=Le(),this.name=t,i?typeof i=="string"?(this.message=""+i+(s?`
 `+s:""),this.inner=s||null):typeof i=="object"&&(this.message=i.name+" "+i.message,this.inner=i):(this.message=ga[e]||t,this.inner=null)}return qe(r).from(ba),n[e]=r,n},{});I.Syntax=SyntaxError;I.Type=TypeError;I.Range=RangeError;var ri=ti.reduce(function(n,e){return n[e+"Error"]=I[e],n},{});function wa(n,e){if(!n||n instanceof $e||n instanceof TypeError||n instanceof SyntaxError||!n.name||!ri[n.name])return n;var t=new ri[n.name](e||n.message,n);return"stack"in n&&ve(t,"stack",{get:function(){return this.inner.stack}}),t}var Vt=En.reduce(function(n,e){return["Syntax","Type","Range"].indexOf(e)===-1&&(n[e+"Error"]=I[e]),n},{});Vt.ModifyError=Kt;Vt.DexieError=$e;Vt.BulkError=ft;function U(){}function dt(n){return n}function _a(n,e){return n==null||n===dt?e:function(t){return e(n(t))}}function Pe(n,e){return function(){n.apply(this,arguments),e.apply(this,arguments)}}function xa(n,e){return n===U?e:function(){var t=n.apply(this,arguments);t!==void 0&&(arguments[0]=t);var r=this.onsuccess,i=this.onerror;this.onsuccess=null,this.onerror=null;var s=e.apply(this,arguments);return r&&(this.onsuccess=this.onsuccess?Pe(r,this.onsuccess):r),i&&(this.onerror=this.onerror?Pe(i,this.onerror):i),s!==void 0?s:t}}function Sa(n,e){return n===U?e:function(){n.apply(this,arguments);var t=this.onsuccess,r=this.onerror;this.onsuccess=this.onerror=null,e.apply(this,arguments),t&&(this.onsuccess=this.onsuccess?Pe(t,this.onsuccess):t),r&&(this.onerror=this.onerror?Pe(r,this.onerror):r)}}function Ta(n,e){return n===U?e:function(t){var r=n.apply(this,arguments);J(t,r);var i=this.onsuccess,s=this.onerror;this.onsuccess=null,this.onerror=null;var a=e.apply(this,arguments);return i&&(this.onsuccess=this.onsuccess?Pe(i,this.onsuccess):i),s&&(this.onerror=this.onerror?Pe(s,this.onerror):s),r===void 0?a===void 0?void 0:a:J(r,a)}}function Ma(n,e){return n===U?e:function(){return e.apply(this,arguments)===!1?!1:n.apply(this,arguments)}}function Rn(n,e){return n===U?e:function(){var t=n.apply(this,arguments);if(t&&typeof t.then=="function"){for(var r=this,i=arguments.length,s=new Array(i);i--;)s[i]=arguments[i];return t.then(function(){return e.apply(r,s)})}return e.apply(this,arguments)}}var pt={},Ea=100,Ra=20,ii=100,Cn=typeof Promise=="undefined"?[]:function(){var n=Promise.resolve();if(typeof crypto=="undefined"||!crypto.subtle)return[n,ct(n),n];var e=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[e,ct(e),n]}(),An=Cn[0],jt=Cn[1],Bn=Cn[2],si=jt&&jt.then,Wt=An&&An.constructor,On=!!Bn,Dn=!1,Ca=Bn?function(){Bn.then(Gt)}:V.setImmediate?setImmediate.bind(null,Gt):V.MutationObserver?function(){var n=document.createElement("div");new MutationObserver(function(){Gt(),n=null}).observe(n,{attributes:!0}),n.setAttribute("i","1")}:function(){setTimeout(Gt,0)},mt=function(n,e){yt.push([n,e]),qt&&(Ca(),qt=!1)},In=!0,qt=!0,ke=[],Ht=[],zn=null,Ln=dt,Ge={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:mi,pgp:!1,env:{},finalize:function(){this.unhandleds.forEach(function(n){try{mi(n[0],n[1])}catch{}})}},O=Ge,yt=[],Ne=0,$t=[];function C(n){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this.onuncatched=U,this._lib=!1;var e=this._PSD=O;if(pe&&(this._stackHolder=Le(),this._prev=null,this._numPrev=0),typeof n!="function"){if(n!==pt)throw new TypeError("Not a function");this._state=arguments[1],this._value=arguments[2],this._state===!1&&kn(this,this._value);return}this._state=null,this._value=null,++e.ref,oi(this,n)}var Pn={get:function(){var n=O,e=Yt;function t(r,i){var s=this,a=!n.global&&(n!==O||e!==Yt),u=a&&!_e(),o=new C(function(l,p){Nn(s,new ai(Jt(r,n,a,u),Jt(i,n,a,u),l,p,n))});return pe&&li(o,this),o}return t.prototype=pt,t},set:function(n){ve(this,"then",n&&n.prototype===pt?Pn:{get:function(){return n},set:Pn.set})}};We(C.prototype,{then:Pn,_then:function(n,e){Nn(this,new ai(null,null,n,e,O))},catch:function(n){if(arguments.length===1)return this.then(null,n);var e=arguments[0],t=arguments[1];return typeof e=="function"?this.then(null,function(r){return r instanceof e?t(r):Qt(r)}):this.then(null,function(r){return r&&r.name===e?t(r):Qt(r)})},finally:function(n){return this.then(function(e){return n(),e},function(e){return n(),Qt(e)})},stack:{get:function(){if(this._stack)return this._stack;try{Dn=!0;var n=ci(this,[],Ra),e=n.join(`
From previous: `);return this._state!==null&&(this._stack=e),e}finally{Dn=!1}}},timeout:function(n,e){var t=this;return n<1/0?new C(function(r,i){var s=setTimeout(function(){return i(new I.Timeout(e))},n);t.then(r,i).finally(clearTimeout.bind(null,s))}):this}});typeof Symbol!="undefined"&&Symbol.toStringTag&&ve(C.prototype,Symbol.toStringTag,"Dexie.Promise");Ge.env=hi();function ai(n,e,t,r,i){this.onFulfilled=typeof n=="function"?n:null,this.onRejected=typeof e=="function"?e:null,this.resolve=t,this.reject=r,this.psd=i}We(C,{all:function(){var n=we.apply(null,arguments).map(Zt);return new C(function(e,t){n.length===0&&e([]);var r=n.length;n.forEach(function(i,s){return C.resolve(i).then(function(a){n[s]=a,--r||e(n)},t)})})},resolve:function(n){if(n instanceof C)return n;if(n&&typeof n.then=="function")return new C(function(t,r){n.then(t,r)});var e=new C(pt,!0,n);return li(e,zn),e},reject:Qt,race:function(){var n=we.apply(null,arguments).map(Zt);return new C(function(e,t){n.map(function(r){return C.resolve(r).then(e,t)})})},PSD:{get:function(){return O},set:function(n){return O=n}},totalEchoes:{get:function(){return Yt}},newPSD:Ce,usePSD:Xe,scheduler:{get:function(){return mt},set:function(n){mt=n}},rejectionMapper:{get:function(){return Ln},set:function(n){Ln=n}},follow:function(n,e){return new C(function(t,r){return Ce(function(i,s){var a=O;a.unhandleds=[],a.onunhandled=s,a.finalize=Pe(function(){var u=this;Ba(function(){u.unhandleds.length===0?i():s(u.unhandleds[0])})},a.finalize),n()},e,t,r)})}});Wt&&(Wt.allSettled&&ve(C,"allSettled",function(){var n=we.apply(null,arguments).map(Zt);return new C(function(e){n.length===0&&e([]);var t=n.length,r=new Array(t);n.forEach(function(i,s){return C.resolve(i).then(function(a){return r[s]={status:"fulfilled",value:a}},function(a){return r[s]={status:"rejected",reason:a}}).then(function(){return--t||e(r)})})})}),Wt.any&&typeof AggregateError!="undefined"&&ve(C,"any",function(){var n=we.apply(null,arguments).map(Zt);return new C(function(e,t){n.length===0&&t(new AggregateError([]));var r=n.length,i=new Array(r);n.forEach(function(s,a){return C.resolve(s).then(function(u){return e(u)},function(u){i[a]=u,--r||t(new AggregateError(i))})})})}));function oi(n,e){try{e(function(t){if(n._state===null){if(t===n)throw new TypeError("A promise cannot be resolved with itself.");var r=n._lib&&gt();t&&typeof t.then=="function"?oi(n,function(i,s){t instanceof C?t._then(i,s):t.then(i,s)}):(n._state=!0,n._value=t,ui(n)),r&&vt()}},kn.bind(null,n))}catch(t){kn(n,t)}}function kn(n,e){if(Ht.push(e),n._state===null){var t=n._lib&&gt();e=Ln(e),n._state=!1,n._value=e,pe&&e!==null&&typeof e=="object"&&!e._promise&&ca(function(){var r=wn(e,"stack");e._promise=n,ve(e,"stack",{get:function(){return Dn?r&&(r.get?r.get.apply(e):r.value):n.stack}})}),Oa(n),ui(n),t&&vt()}}function ui(n){var e=n._listeners;n._listeners=[];for(var t=0,r=e.length;t<r;++t)Nn(n,e[t]);var i=n._PSD;--i.ref||i.finalize(),Ne===0&&(++Ne,mt(function(){--Ne==0&&Fn()},[]))}function Nn(n,e){if(n._state===null){n._listeners.push(e);return}var t=n._state?e.onFulfilled:e.onRejected;if(t===null)return(n._state?e.resolve:e.reject)(n._value);++e.psd.ref,++Ne,mt(Aa,[t,n,e])}function Aa(n,e,t){try{zn=e;var r,i=e._value;e._state?r=n(i):(Ht.length&&(Ht=[]),r=n(i),Ht.indexOf(i)===-1&&Da(e)),t.resolve(r)}catch(s){t.reject(s)}finally{zn=null,--Ne==0&&Fn(),--t.psd.ref||t.psd.finalize()}}function ci(n,e,t){if(e.length===t)return e;var r="";if(n._state===!1){var i=n._value,s,a;i!=null?(s=i.name||"Error",a=i.message||i,r=Mn(i,0)):(s=i,a=""),e.push(s+(a?": "+a:"")+r)}return pe&&(r=Mn(n._stackHolder,2),r&&e.indexOf(r)===-1&&e.push(r),n._prev&&ci(n._prev,e,t)),e}function li(n,e){var t=e?e._numPrev+1:0;t<Ea&&(n._prev=e,n._numPrev=t)}function Gt(){gt()&&vt()}function gt(){var n=In;return In=!1,qt=!1,n}function vt(){var n,e,t;do for(;yt.length>0;)for(n=yt,yt=[],t=n.length,e=0;e<t;++e){var r=n[e];r[0].apply(null,r[1])}while(yt.length>0);In=!0,qt=!0}function Fn(){var n=ke;ke=[],n.forEach(function(r){r._PSD.onunhandled.call(null,r._value,r)});for(var e=$t.slice(0),t=e.length;t;)e[--t]()}function Ba(n){function e(){n(),$t.splice($t.indexOf(e),1)}$t.push(e),++Ne,mt(function(){--Ne==0&&Fn()},[])}function Oa(n){ke.some(function(e){return e._value===n._value})||ke.push(n)}function Da(n){for(var e=ke.length;e;)if(ke[--e]._value===n._value){ke.splice(e,1);return}}function Qt(n){return new C(pt,!1,n)}function j(n,e){var t=O;return function(){var r=gt(),i=O;try{return Ae(t,!0),n.apply(this,arguments)}catch(s){e&&e(s)}finally{Ae(i,!1),r&&vt()}}}var Y={awaits:0,echoes:0,id:0},Ia=0,Xt=[],Un=0,Yt=0,za=0;function Ce(n,e,t,r){var i=O,s=Object.create(i);s.parent=i,s.ref=0,s.global=!1,s.id=++za;var a=Ge.env;s.env=On?{Promise:C,PromiseProp:{value:C,configurable:!0,writable:!0},all:C.all,race:C.race,allSettled:C.allSettled,any:C.any,resolve:C.resolve,reject:C.reject,nthen:di(a.nthen,s),gthen:di(a.gthen,s)}:{},e&&J(s,e),++i.ref,s.finalize=function(){--this.parent.ref||this.parent.finalize()};var u=Xe(s,n,t,r);return s.ref===0&&s.finalize(),u}function Qe(){return Y.id||(Y.id=++Ia),++Y.awaits,Y.echoes+=ii,Y.id}function _e(){return Y.awaits?(--Y.awaits==0&&(Y.id=0),Y.echoes=Y.awaits*ii,!0):!1}(""+si).indexOf("[native code]")===-1&&(Qe=_e=U);function Zt(n){return Y.echoes&&n&&n.constructor===Wt?(Qe(),n.then(function(e){return _e(),e},function(e){return _e(),$(e)})):n}function La(n){++Yt,(!Y.echoes||--Y.echoes==0)&&(Y.echoes=Y.id=0),Xt.push(O),Ae(n,!0)}function Pa(){var n=Xt[Xt.length-1];Xt.pop(),Ae(n,!1)}function Ae(n,e){var t=O;if((e?Y.echoes&&(!Un++||n!==O):Un&&(!--Un||n!==O))&&fi(e?La.bind(null,n):Pa),n!==O&&(O=n,t===Ge&&(Ge.env=hi()),On)){var r=Ge.env.Promise,i=n.env;jt.then=i.nthen,r.prototype.then=i.gthen,(t.global||n.global)&&(Object.defineProperty(V,"Promise",i.PromiseProp),r.all=i.all,r.race=i.race,r.resolve=i.resolve,r.reject=i.reject,i.allSettled&&(r.allSettled=i.allSettled),i.any&&(r.any=i.any))}}function hi(){var n=V.Promise;return On?{Promise:n,PromiseProp:Object.getOwnPropertyDescriptor(V,"Promise"),all:n.all,race:n.race,allSettled:n.allSettled,any:n.any,resolve:n.resolve,reject:n.reject,nthen:jt.then,gthen:n.prototype.then}:{}}function Xe(n,e,t,r,i){var s=O;try{return Ae(n,!0),e(t,r,i)}finally{Ae(s,!1)}}function fi(n){si.call(An,n)}function Jt(n,e,t,r){return typeof n!="function"?n:function(){var i=O;t&&Qe(),Ae(e,!0);try{return n.apply(this,arguments)}finally{Ae(i,!1),r&&fi(_e)}}}function di(n,e){return function(t,r){return n.call(this,Jt(t,e),Jt(r,e))}}var pi="unhandledrejection";function mi(n,e){var t;try{t=e.onuncatched(n)}catch{}if(t!==!1)try{var r,i={promise:e,reason:n};if(V.document&&document.createEvent?(r=document.createEvent("Event"),r.initEvent(pi,!0,!0),J(r,i)):V.CustomEvent&&(r=new CustomEvent(pi,{detail:i}),J(r,i)),r&&V.dispatchEvent&&(dispatchEvent(r),!V.PromiseRejectionEvent&&V.onunhandledrejection))try{V.onunhandledrejection(r)}catch{}pe&&r&&!r.defaultPrevented&&console.warn("Unhandled rejection: "+(n.stack||n))}catch{}}var $=C.reject;function yi(n,e,t,r){if(!n.idbdb||!n._state.openComplete&&!O.letThrough&&!n._vip){if(n._state.openComplete)return $(new I.DatabaseClosed(n._state.dbOpenError));if(!n._state.isBeingOpened){if(!n._options.autoOpen)return $(new I.DatabaseClosed);n.open().catch(U)}return n._state.dbReadyPromise.then(function(){return yi(n,e,t,r)})}else{var i=n._createTransaction(e,t,n._dbSchema);try{i.create()}catch(s){return $(s)}return i._promise(e,function(s,a){return Ce(function(){return O.trans=i,r(s,a,i)})}).then(function(s){return i._completion.then(function(){return s})})}}var gi="3.2.0",Fe=String.fromCharCode(65535),Kn=-1/0,xe="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",vi="String expected.",bt=[],en=typeof navigator!="undefined"&&/(MSIE|Trident|Edge)/.test(navigator.userAgent),ka=en,Na=en,bi=function(n){return!/(dexie\.js|dexie\.min\.js)/.test(n)},tn="__dbnames",Vn="readonly",jn="readwrite";function Ue(n,e){return n?e?function(){return n.apply(this,arguments)&&e.apply(this,arguments)}:n:e}var wi={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function nn(n){return typeof n=="string"&&!/\./.test(n)?function(e){return e[n]===void 0&&n in e&&(e=ht(e),delete e[n]),e}:function(e){return e}}var Fa=function(){function n(){}return n.prototype._trans=function(e,t,r){var i=this._tx||O.trans,s=this.name;function a(o,l,p){if(!p.schema[s])throw new I.NotFound("Table "+s+" not part of transaction");return t(p.idbtrans,p)}var u=gt();try{return i&&i.db===this.db?i===O.trans?i._promise(e,a,r):Ce(function(){return i._promise(e,a,r)},{trans:i,transless:O.transless||O}):yi(this.db,e,[this.name],a)}finally{u&&vt()}},n.prototype.get=function(e,t){var r=this;return e&&e.constructor===Object?this.where(e).first(t):this._trans("readonly",function(i){return r.core.get({trans:i,key:e}).then(function(s){return r.hook.reading.fire(s)})}).then(t)},n.prototype.where=function(e){if(typeof e=="string")return new this.db.WhereClause(this,e);if(X(e))return new this.db.WhereClause(this,"["+e.join("+")+"]");var t=W(e);if(t.length===1)return this.where(t[0]).equals(e[t[0]]);var r=this.schema.indexes.concat(this.schema.primKey).filter(function(p){return p.compound&&t.every(function(m){return p.keyPath.indexOf(m)>=0})&&p.keyPath.every(function(m){return t.indexOf(m)>=0})})[0];if(r&&this.db._maxKey!==Fe)return this.where(r.name).equals(r.keyPath.map(function(p){return e[p]}));!r&&pe&&console.warn("The query "+JSON.stringify(e)+" on "+this.name+" would benefit of a "+("compound index ["+t.join("+")+"]"));var i=this.schema.idxByName,s=this.db._deps.indexedDB;function a(p,m){try{return s.cmp(p,m)===0}catch{return!1}}var u=t.reduce(function(p,m){var f=p[0],h=p[1],d=i[m],y=e[m];return[f||d,f||!d?Ue(h,d&&d.multi?function(v){var w=be(v,m);return X(w)&&w.some(function(_){return a(y,_)})}:function(v){return a(y,be(v,m))}):h]},[null,null]),o=u[0],l=u[1];return o?this.where(o.name).equals(e[o.keyPath]).filter(l):r?this.filter(l):this.where(t).equals("")},n.prototype.filter=function(e){return this.toCollection().and(e)},n.prototype.count=function(e){return this.toCollection().count(e)},n.prototype.offset=function(e){return this.toCollection().offset(e)},n.prototype.limit=function(e){return this.toCollection().limit(e)},n.prototype.each=function(e){return this.toCollection().each(e)},n.prototype.toArray=function(e){return this.toCollection().toArray(e)},n.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},n.prototype.orderBy=function(e){return new this.db.Collection(new this.db.WhereClause(this,X(e)?"["+e.join("+")+"]":e))},n.prototype.reverse=function(){return this.toCollection().reverse()},n.prototype.mapToClass=function(e){this.schema.mappedClass=e;var t=function(r){if(!r)return r;var i=Object.create(e.prototype);for(var s in r)if(ue(r,s))try{i[s]=r[s]}catch{}return i};return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=t,this.hook("reading",t),e},n.prototype.defineClass=function(){function e(t){J(this,t)}return this.mapToClass(e)},n.prototype.add=function(e,t){var r=this,i=this.schema.primKey,s=i.auto,a=i.keyPath,u=e;return a&&s&&(u=nn(a)(e)),this._trans("readwrite",function(o){return r.core.mutate({trans:o,type:"add",keys:t!=null?[t]:null,values:[u]})}).then(function(o){return o.numFailures?C.reject(o.failures[0]):o.lastResult}).then(function(o){if(a)try{he(e,a,o)}catch{}return o})},n.prototype.update=function(e,t){if(typeof e=="object"&&!X(e)){var r=be(e,this.schema.primKey.keyPath);if(r===void 0)return $(new I.InvalidArgument("Given object does not contain its primary key"));try{typeof t!="function"?W(t).forEach(function(i){he(e,i,t[i])}):t(e,{value:e,primKey:r})}catch{}return this.where(":id").equals(r).modify(t)}else return this.where(":id").equals(e).modify(t)},n.prototype.put=function(e,t){var r=this,i=this.schema.primKey,s=i.auto,a=i.keyPath,u=e;return a&&s&&(u=nn(a)(e)),this._trans("readwrite",function(o){return r.core.mutate({trans:o,type:"put",values:[u],keys:t!=null?[t]:null})}).then(function(o){return o.numFailures?C.reject(o.failures[0]):o.lastResult}).then(function(o){if(a)try{he(e,a,o)}catch{}return o})},n.prototype.delete=function(e){var t=this;return this._trans("readwrite",function(r){return t.core.mutate({trans:r,type:"delete",keys:[e]})}).then(function(r){return r.numFailures?C.reject(r.failures[0]):void 0})},n.prototype.clear=function(){var e=this;return this._trans("readwrite",function(t){return e.core.mutate({trans:t,type:"deleteRange",range:wi})}).then(function(t){return t.numFailures?C.reject(t.failures[0]):void 0})},n.prototype.bulkGet=function(e){var t=this;return this._trans("readonly",function(r){return t.core.getMany({keys:e,trans:r}).then(function(i){return i.map(function(s){return t.hook.reading.fire(s)})})})},n.prototype.bulkAdd=function(e,t,r){var i=this,s=Array.isArray(t)?t:void 0;r=r||(s?void 0:t);var a=r?r.allKeys:void 0;return this._trans("readwrite",function(u){var o=i.schema.primKey,l=o.auto,p=o.keyPath;if(p&&s)throw new I.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(s&&s.length!==e.length)throw new I.InvalidArgument("Arguments objects and keys must have the same length");var m=e.length,f=p&&l?e.map(nn(p)):e;return i.core.mutate({trans:u,type:"add",keys:s,values:f,wantResults:a}).then(function(h){var d=h.numFailures,y=h.results,v=h.lastResult,w=h.failures,_=a?y:v;if(d===0)return _;throw new ft(i.name+".bulkAdd(): "+d+" of "+m+" operations failed",w)})})},n.prototype.bulkPut=function(e,t,r){var i=this,s=Array.isArray(t)?t:void 0;r=r||(s?void 0:t);var a=r?r.allKeys:void 0;return this._trans("readwrite",function(u){var o=i.schema.primKey,l=o.auto,p=o.keyPath;if(p&&s)throw new I.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(s&&s.length!==e.length)throw new I.InvalidArgument("Arguments objects and keys must have the same length");var m=e.length,f=p&&l?e.map(nn(p)):e;return i.core.mutate({trans:u,type:"put",keys:s,values:f,wantResults:a}).then(function(h){var d=h.numFailures,y=h.results,v=h.lastResult,w=h.failures,_=a?y:v;if(d===0)return _;throw new ft(i.name+".bulkPut(): "+d+" of "+m+" operations failed",w)})})},n.prototype.bulkDelete=function(e){var t=this,r=e.length;return this._trans("readwrite",function(i){return t.core.mutate({trans:i,type:"delete",keys:e})}).then(function(i){var s=i.numFailures,a=i.lastResult,u=i.failures;if(s===0)return a;throw new ft(t.name+".bulkDelete(): "+s+" of "+r+" operations failed",u)})},n}();function wt(n){var e={},t=function(u,o){if(o){for(var l=arguments.length,p=new Array(l-1);--l;)p[l-1]=arguments[l];return e[u].subscribe.apply(null,p),n}else if(typeof u=="string")return e[u]};t.addEventType=s;for(var r=1,i=arguments.length;r<i;++r)s(arguments[r]);return t;function s(u,o,l){if(typeof u=="object")return a(u);o||(o=Ma),l||(l=U);var p={subscribers:[],fire:l,subscribe:function(m){p.subscribers.indexOf(m)===-1&&(p.subscribers.push(m),p.fire=o(p.fire,m))},unsubscribe:function(m){p.subscribers=p.subscribers.filter(function(f){return f!==m}),p.fire=p.subscribers.reduce(o,l)}};return e[u]=t[u]=p,p}function a(u){W(u).forEach(function(o){var l=u[o];if(X(l))s(o,u[o][0],u[o][1]);else if(l==="asap")var p=s(o,dt,function(){for(var f=arguments.length,h=new Array(f);f--;)h[f]=arguments[f];p.subscribers.forEach(function(d){Gr(function(){d.apply(null,h)})})});else throw new I.InvalidArgument("Invalid event config")})}}function _t(n,e){return qe(e).from({prototype:n}),e}function Ua(n){return _t(Fa.prototype,function(t,r,i){this.db=n,this._tx=i,this.name=t,this.schema=r,this.hook=n._allTables[t]?n._allTables[t].hook:wt(null,{creating:[xa,U],reading:[_a,dt],updating:[Ta,U],deleting:[Sa,U]})})}function Ye(n,e){return!(n.filter||n.algorithm||n.or)&&(e?n.justLimit:!n.replayFilter)}function Wn(n,e){n.filter=Ue(n.filter,e)}function qn(n,e,t){var r=n.replayFilter;n.replayFilter=r?function(){return Ue(r(),e())}:e,n.justLimit=t&&!r}function Ka(n,e){n.isMatch=Ue(n.isMatch,e)}function rn(n,e){if(n.isPrimKey)return e.primaryKey;var t=e.getIndexByKeyPath(n.index);if(!t)throw new I.Schema("KeyPath "+n.index+" on object store "+e.name+" is not indexed");return t}function _i(n,e,t){var r=rn(n,e.schema);return e.openCursor({trans:t,values:!n.keysOnly,reverse:n.dir==="prev",unique:!!n.unique,query:{index:r,range:n.range}})}function sn(n,e,t,r){var i=n.replayFilter?Ue(n.filter,n.replayFilter()):n.filter;if(n.or){var s={},a=function(u,o,l){if(!i||i(o,l,function(f){return o.stop(f)},function(f){return o.fail(f)})){var p=o.primaryKey,m=""+p;m==="[object ArrayBuffer]"&&(m=""+new Uint8Array(p)),ue(s,m)||(s[m]=!0,e(u,o,l))}};return Promise.all([n.or._iterate(a,t),xi(_i(n,r,t),n.algorithm,a,!n.keysOnly&&n.valueMapper)])}else return xi(_i(n,r,t),Ue(n.algorithm,i),e,!n.keysOnly&&n.valueMapper)}function xi(n,e,t,r){var i=r?function(a,u,o){return t(r(a),u,o)}:t,s=j(i);return n.then(function(a){if(a)return a.start(function(){var u=function(){return a.continue()};(!e||e(a,function(o){return u=o},function(o){a.stop(o),u=U},function(o){a.fail(o),u=U}))&&s(a.value,a,function(o){return u=o}),u()})})}function ee(n,e){try{var t=Si(n),r=Si(e);if(t!==r)return t==="Array"?1:r==="Array"?-1:t==="binary"?1:r==="binary"?-1:t==="string"?1:r==="string"?-1:t==="Date"?1:r!=="Date"?NaN:-1;switch(t){case"number":case"Date":case"string":return n>e?1:n<e?-1:0;case"binary":return ja(Ti(n),Ti(e));case"Array":return Va(n,e)}}catch{}return NaN}function Va(n,e){for(var t=n.length,r=e.length,i=t<r?t:r,s=0;s<i;++s){var a=ee(n[s],e[s]);if(a!==0)return a}return t===r?0:t<r?-1:1}function ja(n,e){for(var t=n.length,r=e.length,i=t<r?t:r,s=0;s<i;++s)if(n[s]!==e[s])return n[s]<e[s]?-1:1;return t===r?0:t<r?-1:1}function Si(n){var e=typeof n;if(e!=="object")return e;if(ArrayBuffer.isView(n))return"binary";var t=xn(n);return t==="ArrayBuffer"?"binary":t}function Ti(n){return n instanceof Uint8Array?n:ArrayBuffer.isView(n)?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):new Uint8Array(n)}var Wa=function(){function n(){}return n.prototype._read=function(e,t){var r=this._ctx;return r.error?r.table._trans(null,$.bind(null,r.error)):r.table._trans("readonly",e).then(t)},n.prototype._write=function(e){var t=this._ctx;return t.error?t.table._trans(null,$.bind(null,t.error)):t.table._trans("readwrite",e,"locked")},n.prototype._addAlgorithm=function(e){var t=this._ctx;t.algorithm=Ue(t.algorithm,e)},n.prototype._iterate=function(e,t){return sn(this._ctx,e,t,this._ctx.table.core)},n.prototype.clone=function(e){var t=Object.create(this.constructor.prototype),r=Object.create(this._ctx);return e&&J(r,e),t._ctx=r,t},n.prototype.raw=function(){return this._ctx.valueMapper=null,this},n.prototype.each=function(e){var t=this._ctx;return this._read(function(r){return sn(t,e,r,t.table.core)})},n.prototype.count=function(e){var t=this;return this._read(function(r){var i=t._ctx,s=i.table.core;if(Ye(i,!0))return s.count({trans:r,query:{index:rn(i,s.schema),range:i.range}}).then(function(u){return Math.min(u,i.limit)});var a=0;return sn(i,function(){return++a,!1},r,s).then(function(){return a})}).then(e)},n.prototype.sortBy=function(e,t){var r=e.split(".").reverse(),i=r[0],s=r.length-1;function a(l,p){return p?a(l[r[p]],p-1):l[i]}var u=this._ctx.dir==="next"?1:-1;function o(l,p){var m=a(l,s),f=a(p,s);return m<f?-u:m>f?u:0}return this.toArray(function(l){return l.sort(o)}).then(t)},n.prototype.toArray=function(e){var t=this;return this._read(function(r){var i=t._ctx;if(i.dir==="next"&&Ye(i,!0)&&i.limit>0){var s=i.valueMapper,a=rn(i,i.table.core.schema);return i.table.core.query({trans:r,limit:i.limit,values:!0,query:{index:a,range:i.range}}).then(function(o){var l=o.result;return s?l.map(s):l})}else{var u=[];return sn(i,function(o){return u.push(o)},r,i.table.core).then(function(){return u})}},e)},n.prototype.offset=function(e){var t=this._ctx;return e<=0?this:(t.offset+=e,Ye(t)?qn(t,function(){var r=e;return function(i,s){return r===0?!0:r===1?(--r,!1):(s(function(){i.advance(r),r=0}),!1)}}):qn(t,function(){var r=e;return function(){return--r<0}}),this)},n.prototype.limit=function(e){return this._ctx.limit=Math.min(this._ctx.limit,e),qn(this._ctx,function(){var t=e;return function(r,i,s){return--t<=0&&i(s),t>=0}},!0),this},n.prototype.until=function(e,t){return Wn(this._ctx,function(r,i,s){return e(r.value)?(i(s),t):!0}),this},n.prototype.first=function(e){return this.limit(1).toArray(function(t){return t[0]}).then(e)},n.prototype.last=function(e){return this.reverse().first(e)},n.prototype.filter=function(e){return Wn(this._ctx,function(t){return e(t.value)}),Ka(this._ctx,e),this},n.prototype.and=function(e){return this.filter(e)},n.prototype.or=function(e){return new this.db.WhereClause(this._ctx.table,e,this)},n.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},n.prototype.desc=function(){return this.reverse()},n.prototype.eachKey=function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(r,i){e(i.key,i)})},n.prototype.eachUniqueKey=function(e){return this._ctx.unique="unique",this.eachKey(e)},n.prototype.eachPrimaryKey=function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(r,i){e(i.primaryKey,i)})},n.prototype.keys=function(e){var t=this._ctx;t.keysOnly=!t.isMatch;var r=[];return this.each(function(i,s){r.push(s.key)}).then(function(){return r}).then(e)},n.prototype.primaryKeys=function(e){var t=this._ctx;if(t.dir==="next"&&Ye(t,!0)&&t.limit>0)return this._read(function(i){var s=rn(t,t.table.core.schema);return t.table.core.query({trans:i,values:!1,limit:t.limit,query:{index:s,range:t.range}})}).then(function(i){var s=i.result;return s}).then(e);t.keysOnly=!t.isMatch;var r=[];return this.each(function(i,s){r.push(s.primaryKey)}).then(function(){return r}).then(e)},n.prototype.uniqueKeys=function(e){return this._ctx.unique="unique",this.keys(e)},n.prototype.firstKey=function(e){return this.limit(1).keys(function(t){return t[0]}).then(e)},n.prototype.lastKey=function(e){return this.reverse().firstKey(e)},n.prototype.distinct=function(){var e=this._ctx,t=e.index&&e.table.schema.idxByName[e.index];if(!t||!t.multi)return this;var r={};return Wn(this._ctx,function(i){var s=i.primaryKey.toString(),a=ue(r,s);return r[s]=!0,!a}),this},n.prototype.modify=function(e){var t=this,r=this._ctx;return this._write(function(i){var s;if(typeof e=="function")s=e;else{var a=W(e),u=a.length;s=function(w){for(var _=!1,g=0;g<u;++g){var x=a[g],b=e[x];be(w,x)!==b&&(he(w,x,b),_=!0)}return _}}var o=r.table.core,l=o.schema.primaryKey,p=l.outbound,m=l.extractKey,f=t.db._options.modifyChunkSize||200,h=[],d=0,y=[],v=function(w,_){var g=_.failures,x=_.numFailures;d+=w-x;for(var b=0,S=W(g);b<S.length;b++){var E=S[b];h.push(g[E])}};return t.clone().primaryKeys().then(function(w){var _=function(g){var x=Math.min(f,w.length-g);return o.getMany({trans:i,keys:w.slice(g,g+x),cache:"immutable"}).then(function(b){for(var S=[],E=[],T=p?[]:null,M=[],B=0;B<x;++B){var L=b[B],N={value:ht(L),primKey:w[g+B]};s.call(N,N.value,N)!==!1&&(N.value==null?M.push(w[g+B]):!p&&ee(m(L),m(N.value))!==0?(M.push(w[g+B]),S.push(N.value)):(E.push(N.value),p&&T.push(w[g+B])))}var P=Ye(r)&&r.limit===1/0&&(typeof e!="function"||e===Hn)&&{index:r.index,range:r.range};return Promise.resolve(S.length>0&&o.mutate({trans:i,type:"add",values:S}).then(function(Q){for(var z in Q.failures)M.splice(parseInt(z),1);v(S.length,Q)})).then(function(){return(E.length>0||P&&typeof e=="object")&&o.mutate({trans:i,type:"put",keys:T,values:E,criteria:P,changeSpec:typeof e!="function"&&e}).then(function(Q){return v(E.length,Q)})}).then(function(){return(M.length>0||P&&e===Hn)&&o.mutate({trans:i,type:"delete",keys:M,criteria:P}).then(function(Q){return v(M.length,Q)})}).then(function(){return w.length>g+x&&_(g+f)})})};return _(0).then(function(){if(h.length>0)throw new Kt("Error modifying one or more objects",h,d,y);return w.length})})})},n.prototype.delete=function(){var e=this._ctx,t=e.range;return Ye(e)&&(e.isPrimKey&&!Na||t.type===3)?this._write(function(r){var i=e.table.core.schema.primaryKey,s=t;return e.table.core.count({trans:r,query:{index:i,range:s}}).then(function(a){return e.table.core.mutate({trans:r,type:"deleteRange",range:s}).then(function(u){var o=u.failures;u.lastResult,u.results;var l=u.numFailures;if(l)throw new Kt("Could not delete some values",Object.keys(o).map(function(p){return o[p]}),a-l);return a-l})})}):this.modify(Hn)},n}(),Hn=function(n,e){return e.value=null};function qa(n){return _t(Wa.prototype,function(t,r){this.db=n;var i=wi,s=null;if(r)try{i=r()}catch(l){s=l}var a=t._ctx,u=a.table,o=u.hook.reading.fire;this._ctx={table:u,index:a.index,isPrimKey:!a.index||u.schema.primKey.keyPath&&a.index===u.schema.primKey.name,range:i,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:s,or:a.or,valueMapper:o!==dt?o:null}})}function Ha(n,e){return n<e?-1:n===e?0:1}function $a(n,e){return n>e?-1:n===e?0:1}function ne(n,e,t){var r=n instanceof Ei?new n.Collection(n):n;return r._ctx.error=t?new t(e):new TypeError(e),r}function Ze(n){return new n.Collection(n,function(){return Mi("")}).limit(0)}function Ga(n){return n==="next"?function(e){return e.toUpperCase()}:function(e){return e.toLowerCase()}}function Qa(n){return n==="next"?function(e){return e.toLowerCase()}:function(e){return e.toUpperCase()}}function Xa(n,e,t,r,i,s){for(var a=Math.min(n.length,r.length),u=-1,o=0;o<a;++o){var l=e[o];if(l!==r[o])return i(n[o],t[o])<0?n.substr(0,o)+t[o]+t.substr(o+1):i(n[o],r[o])<0?n.substr(0,o)+r[o]+t.substr(o+1):u>=0?n.substr(0,u)+e[u]+t.substr(u+1):null;i(n[o],l)<0&&(u=o)}return a<r.length&&s==="next"?n+t.substr(n.length):a<n.length&&s==="prev"?n.substr(0,t.length):u<0?null:n.substr(0,u)+r[u]+t.substr(u+1)}function an(n,e,t,r){var i,s,a,u,o,l,p,m=t.length;if(!t.every(function(y){return typeof y=="string"}))return ne(n,vi);function f(y){i=Ga(y),s=Qa(y),a=y==="next"?Ha:$a;var v=t.map(function(w){return{lower:s(w),upper:i(w)}}).sort(function(w,_){return a(w.lower,_.lower)});u=v.map(function(w){return w.upper}),o=v.map(function(w){return w.lower}),l=y,p=y==="next"?"":r}f("next");var h=new n.Collection(n,function(){return Be(u[0],o[m-1]+r)});h._ondirectionchange=function(y){f(y)};var d=0;return h._addAlgorithm(function(y,v,w){var _=y.key;if(typeof _!="string")return!1;var g=s(_);if(e(g,o,d))return!0;for(var x=null,b=d;b<m;++b){var S=Xa(_,g,u[b],o[b],a,l);S===null&&x===null?d=b+1:(x===null||a(x,S)>0)&&(x=S)}return v(x!==null?function(){y.continue(x+p)}:w),!1}),h}function Be(n,e,t,r){return{type:2,lower:n,upper:e,lowerOpen:t,upperOpen:r}}function Mi(n){return{type:1,lower:n,upper:n}}var Ei=function(){function n(){}return Object.defineProperty(n.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),n.prototype.between=function(e,t,r,i){r=r!==!1,i=i===!0;try{return this._cmp(e,t)>0||this._cmp(e,t)===0&&(r||i)&&!(r&&i)?Ze(this):new this.Collection(this,function(){return Be(e,t,!r,!i)})}catch{return ne(this,xe)}},n.prototype.equals=function(e){return e==null?ne(this,xe):new this.Collection(this,function(){return Mi(e)})},n.prototype.above=function(e){return e==null?ne(this,xe):new this.Collection(this,function(){return Be(e,void 0,!0)})},n.prototype.aboveOrEqual=function(e){return e==null?ne(this,xe):new this.Collection(this,function(){return Be(e,void 0,!1)})},n.prototype.below=function(e){return e==null?ne(this,xe):new this.Collection(this,function(){return Be(void 0,e,!1,!0)})},n.prototype.belowOrEqual=function(e){return e==null?ne(this,xe):new this.Collection(this,function(){return Be(void 0,e)})},n.prototype.startsWith=function(e){return typeof e!="string"?ne(this,vi):this.between(e,e+Fe,!0,!0)},n.prototype.startsWithIgnoreCase=function(e){return e===""?this.startsWith(e):an(this,function(t,r){return t.indexOf(r[0])===0},[e],Fe)},n.prototype.equalsIgnoreCase=function(e){return an(this,function(t,r){return t===r[0]},[e],"")},n.prototype.anyOfIgnoreCase=function(){var e=we.apply(He,arguments);return e.length===0?Ze(this):an(this,function(t,r){return r.indexOf(t)!==-1},e,"")},n.prototype.startsWithAnyOfIgnoreCase=function(){var e=we.apply(He,arguments);return e.length===0?Ze(this):an(this,function(t,r){return r.some(function(i){return t.indexOf(i)===0})},e,Fe)},n.prototype.anyOf=function(){var e=this,t=we.apply(He,arguments),r=this._cmp;try{t.sort(r)}catch{return ne(this,xe)}if(t.length===0)return Ze(this);var i=new this.Collection(this,function(){return Be(t[0],t[t.length-1])});i._ondirectionchange=function(a){r=a==="next"?e._ascending:e._descending,t.sort(r)};var s=0;return i._addAlgorithm(function(a,u,o){for(var l=a.key;r(l,t[s])>0;)if(++s,s===t.length)return u(o),!1;return r(l,t[s])===0?!0:(u(function(){a.continue(t[s])}),!1)}),i},n.prototype.notEqual=function(e){return this.inAnyRange([[Kn,e],[e,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},n.prototype.noneOf=function(){var e=we.apply(He,arguments);if(e.length===0)return new this.Collection(this);try{e.sort(this._ascending)}catch{return ne(this,xe)}var t=e.reduce(function(r,i){return r?r.concat([[r[r.length-1][1],i]]):[[Kn,i]]},null);return t.push([e[e.length-1],this.db._maxKey]),this.inAnyRange(t,{includeLowers:!1,includeUppers:!1})},n.prototype.inAnyRange=function(e,t){var r=this,i=this._cmp,s=this._ascending,a=this._descending,u=this._min,o=this._max;if(e.length===0)return Ze(this);if(!e.every(function(b){return b[0]!==void 0&&b[1]!==void 0&&s(b[0],b[1])<=0}))return ne(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",I.InvalidArgument);var l=!t||t.includeLowers!==!1,p=t&&t.includeUppers===!0;function m(b,S){for(var E=0,T=b.length;E<T;++E){var M=b[E];if(i(S[0],M[1])<0&&i(S[1],M[0])>0){M[0]=u(M[0],S[0]),M[1]=o(M[1],S[1]);break}}return E===T&&b.push(S),b}var f=s;function h(b,S){return f(b[0],S[0])}var d;try{d=e.reduce(m,[]),d.sort(h)}catch{return ne(this,xe)}var y=0,v=p?function(b){return s(b,d[y][1])>0}:function(b){return s(b,d[y][1])>=0},w=l?function(b){return a(b,d[y][0])>0}:function(b){return a(b,d[y][0])>=0};function _(b){return!v(b)&&!w(b)}var g=v,x=new this.Collection(this,function(){return Be(d[0][0],d[d.length-1][1],!l,!p)});return x._ondirectionchange=function(b){b==="next"?(g=v,f=s):(g=w,f=a),d.sort(h)},x._addAlgorithm(function(b,S,E){for(var T=b.key;g(T);)if(++y,y===d.length)return S(E),!1;return _(T)?!0:(r._cmp(T,d[y][1])===0||r._cmp(T,d[y][0])===0||S(function(){f===s?b.continue(d[y][0]):b.continue(d[y][1])}),!1)}),x},n.prototype.startsWithAnyOf=function(){var e=we.apply(He,arguments);return e.every(function(t){return typeof t=="string"})?e.length===0?Ze(this):this.inAnyRange(e.map(function(t){return[t,t+Fe]})):ne(this,"startsWithAnyOf() only works with strings")},n}();function Ya(n){return _t(Ei.prototype,function(t,r,i){this.db=n,this._ctx={table:t,index:r===":id"?null:r,or:i};var s=n._deps.indexedDB;if(!s)throw new I.MissingAPI;this._cmp=this._ascending=s.cmp.bind(s),this._descending=function(a,u){return s.cmp(u,a)},this._max=function(a,u){return s.cmp(a,u)>0?a:u},this._min=function(a,u){return s.cmp(a,u)<0?a:u},this._IDBKeyRange=n._deps.IDBKeyRange})}function me(n){return j(function(e){return xt(e),n(e.target.error),!1})}function xt(n){n.stopPropagation&&n.stopPropagation(),n.preventDefault&&n.preventDefault()}var St="storagemutated",Oe="x-storagemutated-1",De=wt(null,St),Za=function(){function n(){}return n.prototype._lock=function(){return lt(!O.global),++this._reculock,this._reculock===1&&!O.global&&(O.lockOwnerFor=this),this},n.prototype._unlock=function(){if(lt(!O.global),--this._reculock==0)for(O.global||(O.lockOwnerFor=null);this._blockedFuncs.length>0&&!this._locked();){var e=this._blockedFuncs.shift();try{Xe(e[1],e[0])}catch{}}return this},n.prototype._locked=function(){return this._reculock&&O.lockOwnerFor!==this},n.prototype.create=function(e){var t=this;if(!this.mode)return this;var r=this.db.idbdb,i=this.db._state.dbOpenError;if(lt(!this.idbtrans),!e&&!r)switch(i&&i.name){case"DatabaseClosedError":throw new I.DatabaseClosed(i);case"MissingAPIError":throw new I.MissingAPI(i.message,i);default:throw new I.OpenFailed(i)}if(!this.active)throw new I.TransactionInactive;return lt(this._completion._state===null),e=this.idbtrans=e||(this.db.core?this.db.core.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}):r.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})),e.onerror=j(function(s){xt(s),t._reject(e.error)}),e.onabort=j(function(s){xt(s),t.active&&t._reject(new I.Abort(e.error)),t.active=!1,t.on("abort").fire(s)}),e.oncomplete=j(function(){t.active=!1,t._resolve(),"mutatedParts"in e&&De.storagemutated.fire(e.mutatedParts)}),this},n.prototype._promise=function(e,t,r){var i=this;if(e==="readwrite"&&this.mode!=="readwrite")return $(new I.ReadOnly("Transaction is readonly"));if(!this.active)return $(new I.TransactionInactive);if(this._locked())return new C(function(a,u){i._blockedFuncs.push([function(){i._promise(e,t,r).then(a,u)},O])});if(r)return Ce(function(){var a=new C(function(u,o){i._lock();var l=t(u,o,i);l&&l.then&&l.then(u,o)});return a.finally(function(){return i._unlock()}),a._lib=!0,a});var s=new C(function(a,u){var o=t(a,u,i);o&&o.then&&o.then(a,u)});return s._lib=!0,s},n.prototype._root=function(){return this.parent?this.parent._root():this},n.prototype.waitFor=function(e){var t=this._root(),r=C.resolve(e);if(t._waitingFor)t._waitingFor=t._waitingFor.then(function(){return r});else{t._waitingFor=r,t._waitingQueue=[];var i=t.idbtrans.objectStore(t.storeNames[0]);(function a(){for(++t._spinCount;t._waitingQueue.length;)t._waitingQueue.shift()();t._waitingFor&&(i.get(-1/0).onsuccess=a)})()}var s=t._waitingFor;return new C(function(a,u){r.then(function(o){return t._waitingQueue.push(j(a.bind(null,o)))},function(o){return t._waitingQueue.push(j(u.bind(null,o)))}).finally(function(){t._waitingFor===s&&(t._waitingFor=null)})})},n.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new I.Abort))},n.prototype.table=function(e){var t=this._memoizedTables||(this._memoizedTables={});if(ue(t,e))return t[e];var r=this.schema[e];if(!r)throw new I.NotFound("Table "+e+" not part of transaction");var i=new this.db.Table(e,r,this);return i.core=this.db.core.table(e),t[e]=i,i},n}();function Ja(n){return _t(Za.prototype,function(t,r,i,s,a){var u=this;this.db=n,this.mode=t,this.storeNames=r,this.schema=i,this.chromeTransactionDurability=s,this.idbtrans=null,this.on=wt(this,"complete","error","abort"),this.parent=a||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new C(function(o,l){u._resolve=o,u._reject=l}),this._completion.then(function(){u.active=!1,u.on.complete.fire()},function(o){var l=u.active;return u.active=!1,u.on.error.fire(o),u.parent?u.parent._reject(o):l&&u.idbtrans&&u.idbtrans.abort(),$(o)})})}function $n(n,e,t,r,i,s,a){return{name:n,keyPath:e,unique:t,multi:r,auto:i,compound:s,src:(t&&!a?"&":"")+(r?"*":"")+(i?"++":"")+Ri(e)}}function Ri(n){return typeof n=="string"?n:n?"["+[].join.call(n,"+")+"]":""}function Ci(n,e,t){return{name:n,primKey:e,indexes:t,mappedClass:null,idxByName:Qr(t,function(r){return[r.name,r]})}}function eo(n){return n.length===1?n[0]:n}var Tt=function(n){try{return n.only([[]]),Tt=function(){return[[]]},[[]]}catch{return Tt=function(){return Fe},Fe}};function Gn(n){return n==null?function(){}:typeof n=="string"?to(n):function(e){return be(e,n)}}function to(n){var e=n.split(".");return e.length===1?function(t){return t[n]}:function(t){return be(t,n)}}function Ai(n){return[].slice.call(n)}var no=0;function Mt(n){return n==null?":id":typeof n=="string"?n:"["+n.join("+")+"]"}function ro(n,e,t){function r(m,f){var h=Ai(m.objectStoreNames);return{schema:{name:m.name,tables:h.map(function(d){return f.objectStore(d)}).map(function(d){var y=d.keyPath,v=d.autoIncrement,w=X(y),_=y==null,g={},x={name:d.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:_,compound:w,keyPath:y,autoIncrement:v,unique:!0,extractKey:Gn(y)},indexes:Ai(d.indexNames).map(function(b){return d.index(b)}).map(function(b){var S=b.name,E=b.unique,T=b.multiEntry,M=b.keyPath,B=X(M),L={name:S,compound:B,keyPath:M,unique:E,multiEntry:T,extractKey:Gn(M)};return g[Mt(M)]=L,L}),getIndexByKeyPath:function(b){return g[Mt(b)]}};return g[":id"]=x.primaryKey,y!=null&&(g[Mt(y)]=x.primaryKey),x})},hasGetAll:h.length>0&&"getAll"in f.objectStore(h[0])&&!(typeof navigator!="undefined"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}}function i(m){if(m.type===3)return null;if(m.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var f=m.lower,h=m.upper,d=m.lowerOpen,y=m.upperOpen,v=f===void 0?h===void 0?null:e.upperBound(h,!!y):h===void 0?e.lowerBound(f,!!d):e.bound(f,h,!!d,!!y);return v}function s(m){var f=m.name;function h(v){var w=v.trans,_=v.type,g=v.keys,x=v.values,b=v.range;return new Promise(function(S,E){S=j(S);var T=w.objectStore(f),M=T.keyPath==null,B=_==="put"||_==="add";if(!B&&_!=="delete"&&_!=="deleteRange")throw new Error("Invalid operation type: "+_);var L=(g||x||{length:1}).length;if(g&&x&&g.length!==x.length)throw new Error("Given keys array must have same length as given values array.");if(L===0)return S({numFailures:0,failures:{},results:[],lastResult:void 0});var N,P=[],Q=[],z=0,re=function(de){++z,xt(de)};if(_==="deleteRange"){if(b.type===4)return S({numFailures:z,failures:Q,results:[],lastResult:void 0});b.type===3?P.push(N=T.clear()):P.push(N=T.delete(i(b)))}else{var ce=B?M?[x,g]:[x,null]:[g,null],Me=ce[0],fe=ce[1];if(B)for(var ie=0;ie<L;++ie)P.push(N=fe&&fe[ie]!==void 0?T[_](Me[ie],fe[ie]):T[_](Me[ie])),N.onerror=re;else for(var ie=0;ie<L;++ie)P.push(N=T[_](Me[ie])),N.onerror=re}var Ee=function(de){var tt=de.target.result;P.forEach(function(le,At){return le.error!=null&&(Q[At]=le.error)}),S({numFailures:z,failures:Q,results:_==="delete"?g:P.map(function(le){return le.result}),lastResult:tt})};N.onerror=function(de){re(de),Ee(de)},N.onsuccess=Ee})}function d(v){var w=v.trans,_=v.values,g=v.query,x=v.reverse,b=v.unique;return new Promise(function(S,E){S=j(S);var T=g.index,M=g.range,B=w.objectStore(f),L=T.isPrimaryKey?B:B.index(T.name),N=x?b?"prevunique":"prev":b?"nextunique":"next",P=_||!("openKeyCursor"in L)?L.openCursor(i(M),N):L.openKeyCursor(i(M),N);P.onerror=me(E),P.onsuccess=j(function(Q){var z=P.result;if(!z){S(null);return}z.___id=++no,z.done=!1;var re=z.continue.bind(z),ce=z.continuePrimaryKey;ce&&(ce=ce.bind(z));var Me=z.advance.bind(z),fe=function(){throw new Error("Cursor not started")},ie=function(){throw new Error("Cursor not stopped")};z.trans=w,z.stop=z.continue=z.continuePrimaryKey=z.advance=fe,z.fail=j(E),z.next=function(){var Ee=this,de=1;return this.start(function(){return de--?Ee.continue():Ee.stop()}).then(function(){return Ee})},z.start=function(Ee){var de=new Promise(function(le,At){le=j(le),P.onerror=me(At),z.fail=At,z.stop=function(Vi){z.stop=z.continue=z.continuePrimaryKey=z.advance=ie,le(Vi)}}),tt=function(){if(P.result)try{Ee()}catch(le){z.fail(le)}else z.done=!0,z.start=function(){throw new Error("Cursor behind last entry")},z.stop()};return P.onsuccess=j(function(le){P.onsuccess=tt,tt()}),z.continue=re,z.continuePrimaryKey=ce,z.advance=Me,tt(),de},S(z)},E)})}function y(v){return function(w){return new Promise(function(_,g){_=j(_);var x=w.trans,b=w.values,S=w.limit,E=w.query,T=S===1/0?void 0:S,M=E.index,B=E.range,L=x.objectStore(f),N=M.isPrimaryKey?L:L.index(M.name),P=i(B);if(S===0)return _({result:[]});if(v){var Q=b?N.getAll(P,T):N.getAllKeys(P,T);Q.onsuccess=function(Me){return _({result:Me.target.result})},Q.onerror=me(g)}else{var z=0,re=b||!("openKeyCursor"in N)?N.openCursor(P):N.openKeyCursor(P),ce=[];re.onsuccess=function(Me){var fe=re.result;if(!fe)return _({result:ce});if(ce.push(b?fe.value:fe.primaryKey),++z===S)return _({result:ce});fe.continue()},re.onerror=me(g)}})}}return{name:f,schema:m,mutate:h,getMany:function(v){var w=v.trans,_=v.keys;return new Promise(function(g,x){g=j(g);for(var b=w.objectStore(f),S=_.length,E=new Array(S),T=0,M=0,B,L=function(z){var re=z.target;(E[re._pos]=re.result)!=null,++M===T&&g(E)},N=me(x),P=0;P<S;++P){var Q=_[P];Q!=null&&(B=b.get(_[P]),B._pos=P,B.onsuccess=L,B.onerror=N,++T)}T===0&&g(E)})},get:function(v){var w=v.trans,_=v.key;return new Promise(function(g,x){g=j(g);var b=w.objectStore(f),S=b.get(_);S.onsuccess=function(E){return g(E.target.result)},S.onerror=me(x)})},query:y(o),openCursor:d,count:function(v){var w=v.query,_=v.trans,g=w.index,x=w.range;return new Promise(function(b,S){var E=_.objectStore(f),T=g.isPrimaryKey?E:E.index(g.name),M=i(x),B=M?T.count(M):T.count();B.onsuccess=j(function(L){return b(L.target.result)}),B.onerror=me(S)})}}}var a=r(n,t),u=a.schema,o=a.hasGetAll,l=u.tables.map(function(m){return s(m)}),p={};return l.forEach(function(m){return p[m.name]=m}),{stack:"dbcore",transaction:n.transaction.bind(n),table:function(m){var f=p[m];if(!f)throw new Error("Table '"+m+"' not found");return p[m]},MIN_KEY:-1/0,MAX_KEY:Tt(e),schema:u}}function io(n,e){return e.reduce(function(t,r){var i=r.create;return k(k({},t),i(t))},n)}function so(n,e,t,r){var i=t.IDBKeyRange;t.indexedDB;var s=io(ro(e,i,r),n.dbcore);return{dbcore:s}}function Qn(n,e){var t=n._novip,r=e.db,i=so(t._middlewares,r,t._deps,e);t.core=i.dbcore,t.tables.forEach(function(s){var a=s.name;t.core.schema.tables.some(function(u){return u.name===a})&&(s.core=t.core.table(a),t[a]instanceof t.Table&&(t[a].core=s.core))})}function on(n,e,t,r){var i=n._novip;t.forEach(function(s){var a=r[s];e.forEach(function(u){var o=wn(u,s);(!o||"value"in o&&o.value===void 0)&&(u===i.Transaction.prototype||u instanceof i.Transaction?ve(u,s,{get:function(){return this.table(s)},set:function(l){Hr(this,s,{value:l,writable:!0,configurable:!0,enumerable:!0})}}):u[s]=new i.Table(s,a))})})}function Xn(n,e){var t=n._novip;e.forEach(function(r){for(var i in r)r[i]instanceof t.Table&&delete r[i]})}function ao(n,e){return n._cfg.version-e._cfg.version}function oo(n,e,t,r){var i=n._dbSchema,s=n._createTransaction("readwrite",n._storeNames,i);s.create(t),s._completion.catch(r);var a=s._reject.bind(s),u=O.transless||O;Ce(function(){O.trans=s,O.transless=u,e===0?(W(i).forEach(function(o){Yn(t,o,i[o].primKey,i[o].indexes)}),Qn(n,t),C.follow(function(){return n.on.populate.fire(s)}).catch(a)):uo(n,e,s,t).catch(a)})}function uo(n,e,t,r){var i=n._novip,s=[],a=i._versions,u=i._dbSchema=Jn(i,i.idbdb,r),o=!1,l=a.filter(function(m){return m._cfg.version>=e});l.forEach(function(m){s.push(function(){var f=u,h=m._cfg.dbschema;er(i,f,r),er(i,h,r),u=i._dbSchema=h;var d=Bi(f,h);d.add.forEach(function(x){Yn(r,x[0],x[1].primKey,x[1].indexes)}),d.change.forEach(function(x){if(x.recreate)throw new I.Upgrade("Not yet support for changing primary key");var b=r.objectStore(x.name);x.add.forEach(function(S){return Zn(b,S)}),x.change.forEach(function(S){b.deleteIndex(S.name),Zn(b,S)}),x.del.forEach(function(S){return b.deleteIndex(S)})});var y=m._cfg.contentUpgrade;if(y&&m._cfg.version>e){Qn(i,r),t._memoizedTables={},o=!0;var v=Xr(h);d.del.forEach(function(x){v[x]=f[x]}),Xn(i,[i.Transaction.prototype]),on(i,[i.Transaction.prototype],W(v),v),t.schema=v;var w=Tn(y);w&&Qe();var _,g=C.follow(function(){if(_=y(t),_&&w){var x=_e.bind(null,null);_.then(x,x)}});return _&&typeof _.then=="function"?C.resolve(_):g.then(function(){return _})}}),s.push(function(f){if(!o||!ka){var h=m._cfg.dbschema;lo(h,f)}Xn(i,[i.Transaction.prototype]),on(i,[i.Transaction.prototype],i._storeNames,i._dbSchema),t.schema=i._dbSchema})});function p(){return s.length?C.resolve(s.shift()(t.idbtrans)).then(p):C.resolve()}return p().then(function(){co(u,r)})}function Bi(n,e){var t={del:[],add:[],change:[]},r;for(r in n)e[r]||t.del.push(r);for(r in e){var i=n[r],s=e[r];if(!i)t.add.push([r,s]);else{var a={name:r,def:s,recreate:!1,del:[],add:[],change:[]};if(""+(i.primKey.keyPath||"")!=""+(s.primKey.keyPath||"")||i.primKey.auto!==s.primKey.auto&&!en)a.recreate=!0,t.change.push(a);else{var u=i.idxByName,o=s.idxByName,l=void 0;for(l in u)o[l]||a.del.push(l);for(l in o){var p=u[l],m=o[l];p?p.src!==m.src&&a.change.push(m):a.add.push(m)}(a.del.length>0||a.add.length>0||a.change.length>0)&&t.change.push(a)}}}return t}function Yn(n,e,t,r){var i=n.db.createObjectStore(e,t.keyPath?{keyPath:t.keyPath,autoIncrement:t.auto}:{autoIncrement:t.auto});return r.forEach(function(s){return Zn(i,s)}),i}function co(n,e){W(n).forEach(function(t){e.db.objectStoreNames.contains(t)||Yn(e,t,n[t].primKey,n[t].indexes)})}function lo(n,e){[].slice.call(e.db.objectStoreNames).forEach(function(t){return n[t]==null&&e.db.deleteObjectStore(t)})}function Zn(n,e){n.createIndex(e.name,e.keyPath,{unique:e.unique,multiEntry:e.multi})}function Jn(n,e,t){var r={},i=Ut(e.objectStoreNames,0);return i.forEach(function(s){for(var a=t.objectStore(s),u=a.keyPath,o=$n(Ri(u),u||"",!1,!1,!!a.autoIncrement,u&&typeof u!="string",!0),l=[],p=0;p<a.indexNames.length;++p){var m=a.index(a.indexNames[p]);u=m.keyPath;var f=$n(m.name,u,!!m.unique,!!m.multiEntry,!1,u&&typeof u!="string",!1);l.push(f)}r[s]=Ci(s,o,l)}),r}function ho(n,e,t){var r=n._novip;r.verno=e.version/10;var i=r._dbSchema=Jn(r,e,t);r._storeNames=Ut(e.objectStoreNames,0),on(r,[r._allTables],W(i),i)}function fo(n,e){var t=Jn(n,n.idbdb,e),r=Bi(t,n._dbSchema);return!(r.add.length||r.change.some(function(i){return i.add.length||i.change.length}))}function er(n,e,t){for(var r=n._novip,i=t.db.objectStoreNames,s=0;s<i.length;++s){var a=i[s],u=t.objectStore(a);r._hasGetAll="getAll"in u;for(var o=0;o<u.indexNames.length;++o){var l=u.indexNames[o],p=u.index(l).keyPath,m=typeof p=="string"?p:"["+Ut(p).join("+")+"]";if(e[a]){var f=e[a].idxByName[m];f&&(f.name=l,delete e[a].idxByName[m],e[a].idxByName[l]=f)}}}typeof navigator!="undefined"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&V.WorkerGlobalScope&&V instanceof V.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(r._hasGetAll=!1)}function po(n){return n.split(",").map(function(e,t){e=e.trim();var r=e.replace(/([&*]|\+\+)/g,""),i=/^\[/.test(r)?r.match(/^\[(.*)\]$/)[1].split("+"):r;return $n(r,i||null,/\&/.test(e),/\*/.test(e),/\+\+/.test(e),X(i),t===0)})}var mo=function(){function n(){}return n.prototype._parseStoresSpec=function(e,t){W(e).forEach(function(r){if(e[r]!==null){var i=po(e[r]),s=i.shift();if(s.multi)throw new I.Schema("Primary key cannot be multi-valued");i.forEach(function(a){if(a.auto)throw new I.Schema("Only primary key can be marked as autoIncrement (++)");if(!a.keyPath)throw new I.Schema("Index must have a name and cannot be an empty string")}),t[r]=Ci(r,s,i)}})},n.prototype.stores=function(e){var t=this.db;this._cfg.storesSource=this._cfg.storesSource?J(this._cfg.storesSource,e):e;var r=t._versions,i={},s={};return r.forEach(function(a){J(i,a._cfg.storesSource),s=a._cfg.dbschema={},a._parseStoresSpec(i,s)}),t._dbSchema=s,Xn(t,[t._allTables,t,t.Transaction.prototype]),on(t,[t._allTables,t,t.Transaction.prototype,this._cfg.tables],W(s),s),t._storeNames=W(s),this},n.prototype.upgrade=function(e){return this._cfg.contentUpgrade=Rn(this._cfg.contentUpgrade||U,e),this},n}();function yo(n){return _t(mo.prototype,function(t){this.db=n,this._cfg={version:t,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})}function tr(n,e){var t=n._dbNamesDB;return t||(t=n._dbNamesDB=new cr(tn,{addons:[],indexedDB:n,IDBKeyRange:e}),t.version(1).stores({dbnames:"name"})),t.table("dbnames")}function nr(n){return n&&typeof n.databases=="function"}function go(n){var e=n.indexedDB,t=n.IDBKeyRange;return nr(e)?Promise.resolve(e.databases()).then(function(r){return r.map(function(i){return i.name}).filter(function(i){return i!==tn})}):tr(e,t).toCollection().primaryKeys()}function vo(n,e){var t=n.indexedDB,r=n.IDBKeyRange;!nr(t)&&e!==tn&&tr(t,r).put({name:e}).catch(U)}function bo(n,e){var t=n.indexedDB,r=n.IDBKeyRange;!nr(t)&&e!==tn&&tr(t,r).delete(e).catch(U)}function rr(n){return Ce(function(){return O.letThrough=!0,n()})}function wo(){var n=!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent);if(!n||!indexedDB.databases)return Promise.resolve();var e;return new Promise(function(t){var r=function(){return indexedDB.databases().finally(t)};e=setInterval(r,100),r()}).finally(function(){return clearInterval(e)})}function _o(n){var e=n._state,t=n._deps.indexedDB;if(e.isBeingOpened||n.idbdb)return e.dbReadyPromise.then(function(){return e.dbOpenError?$(e.dbOpenError):n});pe&&(e.openCanceller._stackHolder=Le()),e.isBeingOpened=!0,e.dbOpenError=null,e.openComplete=!1;var r=e.openCanceller;function i(){if(e.openCanceller!==r)throw new I.DatabaseClosed("db.open() was cancelled")}var s=e.dbReadyResolve,a=null,u=!1;return C.race([r,(typeof navigator=="undefined"?C.resolve():wo()).then(function(){return new C(function(o,l){if(i(),!t)throw new I.MissingAPI;var p=n.name,m=e.autoSchema?t.open(p):t.open(p,Math.round(n.verno*10));if(!m)throw new I.MissingAPI;m.onerror=me(l),m.onblocked=j(n._fireOnBlocked),m.onupgradeneeded=j(function(f){if(a=m.transaction,e.autoSchema&&!n._options.allowEmptyDB){m.onerror=xt,a.abort(),m.result.close();var h=t.deleteDatabase(p);h.onsuccess=h.onerror=j(function(){l(new I.NoSuchDatabase("Database "+p+" doesnt exist"))})}else{a.onerror=me(l);var d=f.oldVersion>Math.pow(2,62)?0:f.oldVersion;u=d<1,n._novip.idbdb=m.result,oo(n,d/10,a,l)}},l),m.onsuccess=j(function(){a=null;var f=n._novip.idbdb=m.result,h=Ut(f.objectStoreNames);if(h.length>0)try{var d=f.transaction(eo(h),"readonly");e.autoSchema?ho(n,f,d):(er(n,n._dbSchema,d),fo(n,d)||console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Some queries may fail.")),Qn(n,d)}catch{}bt.push(n),f.onversionchange=j(function(y){e.vcFired=!0,n.on("versionchange").fire(y)}),f.onclose=j(function(y){n.on("close").fire(y)}),u&&vo(n._deps,p),o()},l)})})]).then(function(){return i(),e.onReadyBeingFired=[],C.resolve(rr(function(){return n.on.ready.fire(n.vip)})).then(function o(){if(e.onReadyBeingFired.length>0){var l=e.onReadyBeingFired.reduce(Rn,U);return e.onReadyBeingFired=[],C.resolve(rr(function(){return l(n.vip)})).then(o)}})}).finally(function(){e.onReadyBeingFired=null,e.isBeingOpened=!1}).then(function(){return n}).catch(function(o){e.dbOpenError=o;try{a&&a.abort()}catch{}return r===e.openCanceller&&n._close(),$(o)}).finally(function(){e.openComplete=!0,s()})}function ir(n){var e=function(a){return n.next(a)},t=function(a){return n.throw(a)},r=s(e),i=s(t);function s(a){return function(u){var o=a(u),l=o.value;return o.done?l:!l||typeof l.then!="function"?X(l)?Promise.all(l).then(r,i):r(l):l.then(r,i)}}return s(e)()}function xo(n,e,t){var r=arguments.length;if(r<2)throw new I.InvalidArgument("Too few arguments");for(var i=new Array(r-1);--r;)i[r-1]=arguments[r];t=i.pop();var s=Yr(i);return[n,s,t]}function So(n,e,t,r,i){return C.resolve().then(function(){var s=O.transless||O,a=n._createTransaction(e,t,n._dbSchema,r),u={trans:a,transless:s};r?a.idbtrans=r.idbtrans:a.create();var o=Tn(i);o&&Qe();var l,p=C.follow(function(){if(l=i.call(a,a),l)if(o){var m=_e.bind(null,null);l.then(m,m)}else typeof l.next=="function"&&typeof l.throw=="function"&&(l=ir(l))},u);return(l&&typeof l.then=="function"?C.resolve(l).then(function(m){return a.active?m:$(new I.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):p.then(function(){return l})).then(function(m){return r&&a._resolve(),a._completion.then(function(){return m})}).catch(function(m){return a._reject(m),$(m)})})}function un(n,e,t){for(var r=X(n)?n.slice():[n],i=0;i<t;++i)r.push(e);return r}function To(n){return k(k({},n),{table:function(e){var t=n.table(e),r=t.schema,i={},s=[];function a(y,v,w){var _=Mt(y),g=i[_]=i[_]||[],x=y==null?0:typeof y=="string"?1:y.length,b=v>0,S=k(k({},w),{isVirtual:b,keyTail:v,keyLength:x,extractKey:Gn(y),unique:!b&&w.unique});if(g.push(S),S.isPrimaryKey||s.push(S),x>1){var E=x===2?y[0]:y.slice(0,x-1);a(E,v+1,w)}return g.sort(function(T,M){return T.keyTail-M.keyTail}),S}var u=a(r.primaryKey.keyPath,0,r.primaryKey);i[":id"]=[u];for(var o=0,l=r.indexes;o<l.length;o++){var p=l[o];a(p.keyPath,0,p)}function m(y){var v=i[Mt(y)];return v&&v[0]}function f(y,v){return{type:y.type===1?2:y.type,lower:un(y.lower,y.lowerOpen?n.MAX_KEY:n.MIN_KEY,v),lowerOpen:!0,upper:un(y.upper,y.upperOpen?n.MIN_KEY:n.MAX_KEY,v),upperOpen:!0}}function h(y){var v=y.query.index;return v.isVirtual?k(k({},y),{query:{index:v,range:f(y.query.range,v.keyTail)}}):y}var d=k(k({},t),{schema:k(k({},r),{primaryKey:u,indexes:s,getIndexByKeyPath:m}),count:function(y){return t.count(h(y))},query:function(y){return t.query(h(y))},openCursor:function(y){var v=y.query.index,w=v.keyTail,_=v.isVirtual,g=v.keyLength;if(!_)return t.openCursor(y);function x(b){function S(T){T!=null?b.continue(un(T,y.reverse?n.MAX_KEY:n.MIN_KEY,w)):y.unique?b.continue(b.key.slice(0,g).concat(y.reverse?n.MIN_KEY:n.MAX_KEY,w)):b.continue()}var E=Object.create(b,{continue:{value:S},continuePrimaryKey:{value:function(T,M){b.continuePrimaryKey(un(T,n.MAX_KEY,w),M)}},primaryKey:{get:function(){return b.primaryKey}},key:{get:function(){var T=b.key;return g===1?T[0]:T.slice(0,g)}},value:{get:function(){return b.value}}});return E}return t.openCursor(h(y)).then(function(b){return b&&x(b)})}});return d}})}var Mo={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:To};function sr(n,e,t,r){return t=t||{},r=r||"",W(n).forEach(function(i){if(!ue(e,i))t[r+i]=void 0;else{var s=n[i],a=e[i];if(typeof s=="object"&&typeof a=="object"&&s&&a){var u=xn(s),o=xn(a);u!==o?t[r+i]=e[i]:u==="Object"?sr(s,a,t,r+i+"."):s!==a&&(t[r+i]=e[i])}else s!==a&&(t[r+i]=e[i])}}),W(e).forEach(function(i){ue(n,i)||(t[r+i]=e[i])}),t}function Eo(n,e){return e.type==="delete"?e.keys:e.keys||e.values.map(n.extractKey)}var Ro={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(n){return k(k({},n),{table:function(e){var t=n.table(e),r=t.schema.primaryKey,i=k(k({},t),{mutate:function(s){var a=O.trans,u=a.table(e).hook,o=u.deleting,l=u.creating,p=u.updating;switch(s.type){case"add":if(l.fire===U)break;return a._promise("readwrite",function(){return m(s)},!0);case"put":if(l.fire===U&&p.fire===U)break;return a._promise("readwrite",function(){return m(s)},!0);case"delete":if(o.fire===U)break;return a._promise("readwrite",function(){return m(s)},!0);case"deleteRange":if(o.fire===U)break;return a._promise("readwrite",function(){return f(s)},!0)}return t.mutate(s);function m(d){var y=O.trans,v=d.keys||Eo(r,d);if(!v)throw new Error("Keys missing");return d=d.type==="add"||d.type==="put"?k(k({},d),{keys:v}):k({},d),d.type!=="delete"&&(d.values=bn([],d.values,!0)),d.keys&&(d.keys=bn([],d.keys,!0)),Co(t,d,v).then(function(w){var _=v.map(function(g,x){var b=w[x],S={onerror:null,onsuccess:null};if(d.type==="delete")o.fire.call(S,g,b,y);else if(d.type==="add"||b===void 0){var E=l.fire.call(S,g,d.values[x],y);g==null&&E!=null&&(g=E,d.keys[x]=g,r.outbound||he(d.values[x],r.keyPath,g))}else{var T=sr(b,d.values[x]),M=p.fire.call(S,T,g,b,y);if(M){var B=d.values[x];Object.keys(M).forEach(function(L){ue(B,L)?B[L]=M[L]:he(B,L,M[L])})}}return S});return t.mutate(d).then(function(g){for(var x=g.failures,b=g.results,S=g.numFailures,E=g.lastResult,T=0;T<v.length;++T){var M=b?b[T]:v[T],B=_[T];M==null?B.onerror&&B.onerror(x[T]):B.onsuccess&&B.onsuccess(d.type==="put"&&w[T]?d.values[T]:M)}return{failures:x,results:b,numFailures:S,lastResult:E}}).catch(function(g){return _.forEach(function(x){return x.onerror&&x.onerror(g)}),Promise.reject(g)})})}function f(d){return h(d.trans,d.range,1e4)}function h(d,y,v){return t.query({trans:d,values:!1,query:{index:r,range:y},limit:v}).then(function(w){var _=w.result;return m({type:"delete",keys:_,trans:d}).then(function(g){return g.numFailures>0?Promise.reject(g.failures[0]):_.length<v?{failures:[],numFailures:0,lastResult:void 0}:h(d,k(k({},y),{lower:_[_.length-1],lowerOpen:!0}),v)})})}}});return i}})}};function Co(n,e,t){return e.type==="add"?Promise.resolve([]):n.getMany({trans:e.trans,keys:t,cache:"immutable"})}function Oi(n,e,t){try{if(!e||e.keys.length<n.length)return null;for(var r=[],i=0,s=0;i<e.keys.length&&s<n.length;++i)ee(e.keys[i],n[s])===0&&(r.push(t?ht(e.values[i]):e.values[i]),++s);return r.length===n.length?r:null}catch{return null}}var Ao={stack:"dbcore",level:-1,create:function(n){return{table:function(e){var t=n.table(e);return k(k({},t),{getMany:function(r){if(!r.cache)return t.getMany(r);var i=Oi(r.keys,r.trans._cache,r.cache==="clone");return i?C.resolve(i):t.getMany(r).then(function(s){return r.trans._cache={keys:r.keys,values:r.cache==="clone"?ht(s):s},s})},mutate:function(r){return r.type!=="add"&&(r.trans._cache=null),t.mutate(r)}})}}}},ar;function or(n){return!("from"in n)}var Se=function(n,e){if(this)J(this,arguments.length?{d:1,from:n,to:arguments.length>1?e:n}:{d:0});else{var t=new Se;return n&&"d"in n&&J(t,n),t}};We(Se.prototype,(ar={add:function(n){return cn(this,n),this},addKey:function(n){return Et(this,n,n),this},addKeys:function(n){var e=this;return n.forEach(function(t){return Et(e,t,t)}),this}},ar[Sn]=function(){return ur(this)},ar));function Et(n,e,t){var r=ee(e,t);if(!isNaN(r)){if(r>0)throw RangeError();if(or(n))return J(n,{from:e,to:t,d:1});var i=n.l,s=n.r;if(ee(t,n.from)<0)return i?Et(i,e,t):n.l={from:e,to:t,d:1,l:null,r:null},Di(n);if(ee(e,n.to)>0)return s?Et(s,e,t):n.r={from:e,to:t,d:1,l:null,r:null},Di(n);ee(e,n.from)<0&&(n.from=e,n.l=null,n.d=s?s.d+1:1),ee(t,n.to)>0&&(n.to=t,n.r=null,n.d=n.l?n.l.d+1:1);var a=!n.r;i&&!n.l&&cn(n,i),s&&a&&cn(n,s)}}function cn(n,e){function t(r,i){var s=i.from,a=i.to,u=i.l,o=i.r;Et(r,s,a),u&&t(r,u),o&&t(r,o)}or(e)||t(n,e)}function Bo(n,e){var t=ur(e),r=t.next();if(r.done)return!1;for(var i=r.value,s=ur(n),a=s.next(i.from),u=a.value;!r.done&&!a.done;){if(ee(u.from,i.to)<=0&&ee(u.to,i.from)>=0)return!0;ee(i.from,u.from)<0?i=(r=t.next(u.from)).value:u=(a=s.next(i.from)).value}return!1}function ur(n){var e=or(n)?null:{s:0,n};return{next:function(t){for(var r=arguments.length>0;e;)switch(e.s){case 0:if(e.s=1,r)for(;e.n.l&&ee(t,e.n.from)<0;)e={up:e,n:e.n.l,s:1};else for(;e.n.l;)e={up:e,n:e.n.l,s:1};case 1:if(e.s=2,!r||ee(t,e.n.to)<=0)return{value:e.n,done:!1};case 2:if(e.n.r){e.s=3,e={up:e,n:e.n.r,s:0};continue}case 3:e=e.up}return{done:!0}}}}function Di(n){var e,t,r=(((e=n.r)===null||e===void 0?void 0:e.d)||0)-(((t=n.l)===null||t===void 0?void 0:t.d)||0),i=r>1?"r":r<-1?"l":"";if(i){var s=i==="r"?"l":"r",a=k({},n),u=n[i];n.from=u.from,n.to=u.to,n[i]=u[i],a[i]=u[s],n[s]=a,a.d=Ii(a)}n.d=Ii(n)}function Ii(n){var e=n.r,t=n.l;return(e?t?Math.max(e.d,t.d):e.d:t?t.d:0)+1}var Oo={stack:"dbcore",level:0,create:function(n){var e=n.schema.name,t=new Se(n.MIN_KEY,n.MAX_KEY);return k(k({},n),{table:function(r){var i=n.table(r),s=i.schema,a=s.primaryKey,u=a.extractKey,o=a.outbound,l=k(k({},i),{mutate:function(f){var h=f.trans,d=h.mutatedParts||(h.mutatedParts={}),y=function(E){var T="idb://"+e+"/"+r+"/"+E;return d[T]||(d[T]=new Se)},v=y(""),w=y(":dels"),_=f.type,g=f.type==="deleteRange"?[f.range]:f.type==="delete"?[f.keys]:f.values.length<50?[[],f.values]:[],x=g[0],b=g[1],S=f.trans._cache;return i.mutate(f).then(function(E){if(X(x)){_!=="delete"&&(x=E.results),v.addKeys(x);var T=Oi(x,S);!T&&_!=="add"&&w.addKeys(x),(T||b)&&Do(y,s,T,b)}else if(x){var M={from:x.lower,to:x.upper};w.add(M),v.add(M)}else v.add(t),w.add(t),s.indexes.forEach(function(B){return y(B.name).add(t)});return E})}}),p=function(f){var h,d,y=f.query,v=y.index,w=y.range;return[v,new Se((h=w.lower)!==null&&h!==void 0?h:n.MIN_KEY,(d=w.upper)!==null&&d!==void 0?d:n.MAX_KEY)]},m={get:function(f){return[a,new Se(f.key)]},getMany:function(f){return[a,new Se().addKeys(f.keys)]},count:p,query:p,openCursor:p};return W(m).forEach(function(f){l[f]=function(h){var d=O.subscr;if(d){var y=function(S){var E="idb://"+e+"/"+r+"/"+S;return d[E]||(d[E]=new Se)},v=y(""),w=y(":dels"),_=m[f](h),g=_[0],x=_[1];if(y(g.name||"").add(x),!g.isPrimaryKey)if(f==="count")w.add(t);else{var b=f==="query"&&o&&h.values&&i.query(k(k({},h),{values:!1}));return i[f].apply(this,arguments).then(function(S){if(f==="query"){if(o&&h.values)return b.then(function(B){var L=B.result;return v.addKeys(L),S});var E=h.values?S.result.map(u):S.result;h.values?v.addKeys(E):w.addKeys(E)}else if(f==="openCursor"){var T=S,M=h.values;return T&&Object.create(T,{key:{get:function(){return w.addKey(T.primaryKey),T.key}},primaryKey:{get:function(){var B=T.primaryKey;return w.addKey(B),B}},value:{get:function(){return M&&v.addKey(T.primaryKey),T.value}}})}return S})}}return i[f].apply(this,arguments)}}),l}})}};function Do(n,e,t,r){function i(s){var a=n(s.name||"");function u(l){return l!=null?s.extractKey(l):null}var o=function(l){return s.multiEntry&&X(l)?l.forEach(function(p){return a.addKey(p)}):a.addKey(l)};(t||r).forEach(function(l,p){var m=t&&u(t[p]),f=r&&u(r[p]);ee(m,f)!==0&&(m!=null&&o(m),f!=null&&o(f))})}e.indexes.forEach(i)}var cr=function(){function n(e,t){var r=this;this._middlewares={},this.verno=0;var i=n.dependencies;this._options=t=k({addons:n.addons,autoOpen:!0,indexedDB:i.indexedDB,IDBKeyRange:i.IDBKeyRange},t),this._deps={indexedDB:t.indexedDB,IDBKeyRange:t.IDBKeyRange};var s=t.addons;this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var a={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:U,dbReadyPromise:null,cancelOpen:U,openCanceller:null,autoSchema:!0};a.dbReadyPromise=new C(function(u){a.dbReadyResolve=u}),a.openCanceller=new C(function(u,o){a.cancelOpen=o}),this._state=a,this.name=e,this.on=wt(this,"populate","blocked","versionchange","close",{ready:[Rn,U]}),this.on.ready.subscribe=$r(this.on.ready.subscribe,function(u){return function(o,l){n.vip(function(){var p=r._state;if(p.openComplete)p.dbOpenError||C.resolve().then(o),l&&u(o);else if(p.onReadyBeingFired)p.onReadyBeingFired.push(o),l&&u(o);else{u(o);var m=r;l||u(function f(){m.on.ready.unsubscribe(o),m.on.ready.unsubscribe(f)})}})}}),this.Collection=qa(this),this.Table=Ua(this),this.Transaction=Ja(this),this.Version=yo(this),this.WhereClause=Ya(this),this.on("versionchange",function(u){u.newVersion>0?console.warn("Another connection wants to upgrade database '"+r.name+"'. Closing db now to resume the upgrade."):console.warn("Another connection wants to delete database '"+r.name+"'. Closing db now to resume the delete request."),r.close()}),this.on("blocked",function(u){!u.newVersion||u.newVersion<u.oldVersion?console.warn("Dexie.delete('"+r.name+"') was blocked"):console.warn("Upgrade '"+r.name+"' blocked by other connection holding version "+u.oldVersion/10)}),this._maxKey=Tt(t.IDBKeyRange),this._createTransaction=function(u,o,l,p){return new r.Transaction(u,o,l,r._options.chromeTransactionDurability,p)},this._fireOnBlocked=function(u){r.on("blocked").fire(u),bt.filter(function(o){return o.name===r.name&&o!==r&&!o._state.vcFired}).map(function(o){return o.on("versionchange").fire(u)})},this.use(Mo),this.use(Ro),this.use(Oo),this.use(Ao),this.vip=Object.create(this,{_vip:{value:!0}}),s.forEach(function(u){return u(r)})}return n.prototype.version=function(e){if(isNaN(e)||e<.1)throw new I.Type("Given version is not a positive number");if(e=Math.round(e*10)/10,this.idbdb||this._state.isBeingOpened)throw new I.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,e);var t=this._versions,r=t.filter(function(i){return i._cfg.version===e})[0];return r||(r=new this.Version(e),t.push(r),t.sort(ao),r.stores({}),this._state.autoSchema=!1,r)},n.prototype._whenReady=function(e){var t=this;return this.idbdb&&(this._state.openComplete||O.letThrough||this._vip)?e():new C(function(r,i){if(t._state.openComplete)return i(new I.DatabaseClosed(t._state.dbOpenError));if(!t._state.isBeingOpened){if(!t._options.autoOpen){i(new I.DatabaseClosed);return}t.open().catch(U)}t._state.dbReadyPromise.then(r,i)}).then(e)},n.prototype.use=function(e){var t=e.stack,r=e.create,i=e.level,s=e.name;s&&this.unuse({stack:t,name:s});var a=this._middlewares[t]||(this._middlewares[t]=[]);return a.push({stack:t,create:r,level:i==null?10:i,name:s}),a.sort(function(u,o){return u.level-o.level}),this},n.prototype.unuse=function(e){var t=e.stack,r=e.name,i=e.create;return t&&this._middlewares[t]&&(this._middlewares[t]=this._middlewares[t].filter(function(s){return i?s.create!==i:r?s.name!==r:!1})),this},n.prototype.open=function(){return _o(this)},n.prototype._close=function(){var e=this._state,t=bt.indexOf(this);if(t>=0&&bt.splice(t,1),this.idbdb){try{this.idbdb.close()}catch{}this._novip.idbdb=null}e.dbReadyPromise=new C(function(r){e.dbReadyResolve=r}),e.openCanceller=new C(function(r,i){e.cancelOpen=i})},n.prototype.close=function(){this._close();var e=this._state;this._options.autoOpen=!1,e.dbOpenError=new I.DatabaseClosed,e.isBeingOpened&&e.cancelOpen(e.dbOpenError)},n.prototype.delete=function(){var e=this,t=arguments.length>0,r=this._state;return new C(function(i,s){var a=function(){e.close();var u=e._deps.indexedDB.deleteDatabase(e.name);u.onsuccess=j(function(){bo(e._deps,e.name),i()}),u.onerror=me(s),u.onblocked=e._fireOnBlocked};if(t)throw new I.InvalidArgument("Arguments not allowed in db.delete()");r.isBeingOpened?r.dbReadyPromise.then(a):a()})},n.prototype.backendDB=function(){return this.idbdb},n.prototype.isOpen=function(){return this.idbdb!==null},n.prototype.hasBeenClosed=function(){var e=this._state.dbOpenError;return e&&e.name==="DatabaseClosed"},n.prototype.hasFailed=function(){return this._state.dbOpenError!==null},n.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(n.prototype,"tables",{get:function(){var e=this;return W(this._allTables).map(function(t){return e._allTables[t]})},enumerable:!1,configurable:!0}),n.prototype.transaction=function(){var e=xo.apply(this,arguments);return this._transaction.apply(this,e)},n.prototype._transaction=function(e,t,r){var i=this,s=O.trans;(!s||s.db!==this||e.indexOf("!")!==-1)&&(s=null);var a=e.indexOf("?")!==-1;e=e.replace("!","").replace("?","");var u,o;try{if(o=t.map(function(p){var m=p instanceof i.Table?p.name:p;if(typeof m!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return m}),e=="r"||e===Vn)u=Vn;else if(e=="rw"||e==jn)u=jn;else throw new I.InvalidArgument("Invalid transaction mode: "+e);if(s){if(s.mode===Vn&&u===jn)if(a)s=null;else throw new I.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");s&&o.forEach(function(p){if(s&&s.storeNames.indexOf(p)===-1)if(a)s=null;else throw new I.SubTransaction("Table "+p+" not included in parent transaction.")}),a&&s&&!s.active&&(s=null)}}catch(p){return s?s._promise(null,function(m,f){f(p)}):$(p)}var l=So.bind(null,this,u,o,s,r);return s?s._promise(u,l,"lock"):O.trans?Xe(O.transless,function(){return i._whenReady(l)}):this._whenReady(l)},n.prototype.table=function(e){if(!ue(this._allTables,e))throw new I.InvalidTable("Table "+e+" does not exist");return this._allTables[e]},n}(),Io=typeof Symbol!="undefined"&&"observable"in Symbol?Symbol.observable:"@@observable",zo=function(){function n(e){this._subscribe=e}return n.prototype.subscribe=function(e,t,r){return this._subscribe(!e||typeof e=="function"?{next:e,error:t,complete:r}:e)},n.prototype[Io]=function(){return this},n}();function zi(n,e){return W(e).forEach(function(t){var r=n[t]||(n[t]=new Se);cn(r,e[t])}),n}function Li(n){return new zo(function(e){var t=Tn(n);function r(h){t&&Qe();var d=function(){return Ce(n,{subscr:h,trans:null})},y=O.trans?Xe(O.transless,d):d();return t&&y.then(_e,_e),y}var i=!1,s={},a={},u={get closed(){return i},unsubscribe:function(){i=!0,De.storagemutated.unsubscribe(m)}};e.start&&e.start(u);var o=!1,l=!1;function p(){return W(a).some(function(h){return s[h]&&Bo(s[h],a[h])})}var m=function(h){zi(s,h),p()&&f()},f=function(){if(!(o||i)){s={};var h={},d=r(h);l||(De(St,m),l=!0),o=!0,Promise.resolve(d).then(function(y){o=!1,!i&&(p()?f():(s={},a=h,e.next&&e.next(y)))},function(y){o=!1,e.error&&e.error(y),u.unsubscribe()})}};return f(),u})}var lr;try{lr={indexedDB:V.indexedDB||V.mozIndexedDB||V.webkitIndexedDB||V.msIndexedDB,IDBKeyRange:V.IDBKeyRange||V.webkitIDBKeyRange}}catch{lr={indexedDB:null,IDBKeyRange:null}}var Ke=cr;We(Ke,k(k({},Vt),{delete:function(n){var e=new Ke(n,{addons:[]});return e.delete()},exists:function(n){return new Ke(n,{addons:[]}).open().then(function(e){return e.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(n){try{return go(Ke.dependencies).then(n)}catch{return $(new I.MissingAPI)}},defineClass:function(){function n(e){J(this,e)}return n},ignoreTransaction:function(n){return O.trans?Xe(O.transless,n):n()},vip:rr,async:function(n){return function(){try{var e=ir(n.apply(this,arguments));return!e||typeof e.then!="function"?C.resolve(e):e}catch(t){return $(t)}}},spawn:function(n,e,t){try{var r=ir(n.apply(t,e||[]));return!r||typeof r.then!="function"?C.resolve(r):r}catch(i){return $(i)}},currentTransaction:{get:function(){return O.trans||null}},waitFor:function(n,e){var t=C.resolve(typeof n=="function"?Ke.ignoreTransaction(n):n).timeout(e||6e4);return O.trans?O.trans.waitFor(t):t},Promise:C,debug:{get:function(){return pe},set:function(n){Jr(n,n==="dexie"?function(){return!0}:bi)}},derive:qe,extend:J,props:We,override:$r,Events:wt,on:De,liveQuery:Li,extendObservabilitySet:zi,getByKeyPath:be,setByKeyPath:he,delByKeyPath:la,shallowClone:Xr,deepClone:ht,getObjectDiff:sr,cmp:ee,asap:Gr,minKey:Kn,addons:[],connections:bt,errnames:va,dependencies:lr,semVer:gi,version:gi.split(".").map(function(n){return parseInt(n)}).reduce(function(n,e,t){return n+e/Math.pow(10,t*2)})}));Ke.maxKey=Tt(Ke.dependencies.IDBKeyRange);typeof dispatchEvent!="undefined"&&typeof addEventListener!="undefined"&&(De(St,function(n){if(!Te){var e;en?(e=document.createEvent("CustomEvent"),e.initCustomEvent(Oe,!0,!0,n)):e=new CustomEvent(Oe,{detail:n}),Te=!0,dispatchEvent(e),Te=!1}}),addEventListener(Oe,function(n){var e=n.detail;Te||ln(e)}));function ln(n){var e=Te;try{Te=!0,De.storagemutated.fire(n)}finally{Te=e}}var Te=!1;if(typeof BroadcastChannel!="undefined"){var Pi=new BroadcastChannel(Oe);De(St,function(n){Te||Pi.postMessage(n)}),Pi.onmessage=function(n){n.data&&ln(n.data)}}else if(typeof self!="undefined"&&typeof navigator!="undefined"){De(St,function(n){try{Te||(typeof localStorage!="undefined"&&localStorage.setItem(Oe,JSON.stringify({trig:Math.random(),changedParts:n})),typeof self.clients=="object"&&bn([],self.clients.matchAll({includeUncontrolled:!0}),!0).forEach(function(e){return e.postMessage({type:Oe,changedParts:n})}))}catch{}}),addEventListener("storage",function(n){if(n.key===Oe){var e=JSON.parse(n.newValue);e&&ln(e.changedParts)}});var ki=self.document&&navigator.serviceWorker;ki&&ki.addEventListener("message",Lo)}function Lo(n){var e=n.data;e&&e.type===Oe&&ln(e.changedParts)}C.rejectionMapper=wa;Jr(pe,bi);var Po=`(() => {
  var __create = Object.create;
  var __defProp = Object.defineProperty;
  var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
  var __getOwnPropNames = Object.getOwnPropertyNames;
  var __getProtoOf = Object.getPrototypeOf;
  var __hasOwnProp = Object.prototype.hasOwnProperty;
  var __markAsModule = (target) => __defProp(target, "__esModule", { value: true });
  var __commonJS = (cb, mod) => function __require() {
    return mod || (0, cb[__getOwnPropNames(cb)[0]])((mod = { exports: {} }).exports, mod), mod.exports;
  };
  var __reExport = (target, module, copyDefault, desc) => {
    if (module && typeof module === "object" || typeof module === "function") {
      for (let key of __getOwnPropNames(module))
        if (!__hasOwnProp.call(target, key) && (copyDefault || key !== "default"))
          __defProp(target, key, { get: () => module[key], enumerable: !(desc = __getOwnPropDesc(module, key)) || desc.enumerable });
    }
    return target;
  };
  var __toESM = (module, isNodeMode) => {
    return __reExport(__markAsModule(__defProp(module != null ? __create(__getProtoOf(module)) : {}, "default", !isNodeMode && module && module.__esModule ? { get: () => module.default, enumerable: true } : { value: module, enumerable: true })), module);
  };

  // (disabled):../../node_modules/@loaders.gl/worker-utils/dist/esm/lib/node/require-utils.node
  var require_require_utils = __commonJS({
    "(disabled):../../node_modules/@loaders.gl/worker-utils/dist/esm/lib/node/require-utils.node"() {
    }
  });

  // ../../node_modules/@loaders.gl/textures/dist/esm/lib/utils/version.js
  var VERSION = true ? "3.1.4" : "latest";

  // ../../node_modules/@loaders.gl/worker-utils/dist/esm/lib/env-utils/assert.js
  function assert(condition, message) {
    if (!condition) {
      throw new Error(message || "loaders.gl assertion failed.");
    }
  }

  // ../../node_modules/@loaders.gl/worker-utils/dist/esm/lib/env-utils/globals.js
  var globals = {
    self: typeof self !== "undefined" && self,
    window: typeof window !== "undefined" && window,
    global: typeof global !== "undefined" && global,
    document: typeof document !== "undefined" && document
  };
  var self_ = globals.self || globals.window || globals.global || {};
  var window_ = globals.window || globals.self || globals.global || {};
  var global_ = globals.global || globals.self || globals.window || {};
  var document_ = globals.document || {};
  var isBrowser = typeof process !== "object" || String(process) !== "[object process]" || process.browser;
  var isWorker = typeof importScripts === "function";
  var isMobile = typeof window !== "undefined" && typeof window.orientation !== "undefined";
  var matches = typeof process !== "undefined" && process.version && /v([0-9]*)/.exec(process.version);
  var nodeVersion = matches && parseFloat(matches[1]) || 0;

  // ../../node_modules/@loaders.gl/worker-utils/dist/esm/lib/library-utils/library-utils.js
  var node = __toESM(require_require_utils());
  var VERSION2 = true ? "3.1.4" : LATEST;
  var loadLibraryPromises = {};
  async function loadLibrary(libraryUrl, moduleName = null, options = {}) {
    if (moduleName) {
      libraryUrl = getLibraryUrl(libraryUrl, moduleName, options);
    }
    loadLibraryPromises[libraryUrl] = loadLibraryPromises[libraryUrl] || loadLibraryFromFile(libraryUrl);
    return await loadLibraryPromises[libraryUrl];
  }
  function getLibraryUrl(library, moduleName, options) {
    if (library.startsWith("http")) {
      return library;
    }
    const modules = options.modules || {};
    if (modules[library]) {
      return modules[library];
    }
    if (!isBrowser) {
      return "modules/".concat(moduleName, "/dist/libs/").concat(library);
    }
    if (options.CDN) {
      assert(options.CDN.startsWith("http"));
      return "".concat(options.CDN, "/").concat(moduleName, "@").concat(VERSION2, "/dist/libs/").concat(library);
    }
    if (isWorker) {
      return "../src/libs/".concat(library);
    }
    return "modules/".concat(moduleName, "/src/libs/").concat(library);
  }
  async function loadLibraryFromFile(libraryUrl) {
    if (libraryUrl.endsWith("wasm")) {
      const response2 = await fetch(libraryUrl);
      return await response2.arrayBuffer();
    }
    if (!isBrowser) {
      try {
        return node && node.requireFromFile && await node.requireFromFile(libraryUrl);
      } catch {
        return null;
      }
    }
    if (isWorker) {
      return importScripts(libraryUrl);
    }
    const response = await fetch(libraryUrl);
    const scriptSource = await response.text();
    return loadLibraryFromString(scriptSource, libraryUrl);
  }
  function loadLibraryFromString(scriptSource, id) {
    if (!isBrowser) {
      return node.requireFromString && node.requireFromString(scriptSource, id);
    }
    if (isWorker) {
      eval.call(global_, scriptSource);
      return null;
    }
    const script = document.createElement("script");
    script.id = id;
    try {
      script.appendChild(document.createTextNode(scriptSource));
    } catch (e) {
      script.text = scriptSource;
    }
    document.body.appendChild(script);
    return null;
  }

  // ../../node_modules/@loaders.gl/textures/dist/esm/lib/parsers/basis-module-loader.js
  var VERSION3 = true ? "3.1.4" : "latest";
  var BASIS_CDN_ENCODER_WASM = "https://unpkg.com/@loaders.gl/textures@".concat(VERSION3, "/dist/libs/basis_encoder.wasm");
  var BASIS_CDN_ENCODER_JS = "https://unpkg.com/@loaders.gl/textures@".concat(VERSION3, "/dist/libs/basis_encoder.js");
  var loadBasisEncoderPromise;
  async function loadBasisEncoderModule(options) {
    const modules = options.modules || {};
    if (modules.basisEncoder) {
      return modules.basisEncoder;
    }
    loadBasisEncoderPromise = loadBasisEncoderPromise || loadBasisEncoder(options);
    return await loadBasisEncoderPromise;
  }
  async function loadBasisEncoder(options) {
    let BASIS_ENCODER = null;
    let wasmBinary = null;
    [BASIS_ENCODER, wasmBinary] = await Promise.all([await loadLibrary(BASIS_CDN_ENCODER_JS, "textures", options), await loadLibrary(BASIS_CDN_ENCODER_WASM, "textures", options)]);
    BASIS_ENCODER = BASIS_ENCODER || globalThis.BASIS;
    return await initializeBasisEncoderModule(BASIS_ENCODER, wasmBinary);
  }
  function initializeBasisEncoderModule(BasisEncoderModule, wasmBinary) {
    const options = {};
    if (wasmBinary) {
      options.wasmBinary = wasmBinary;
    }
    return new Promise((resolve) => {
      BasisEncoderModule(options).then((module) => {
        const {
          BasisFile,
          KTX2File,
          initializeBasis,
          BasisEncoder
        } = module;
        initializeBasis();
        resolve({
          BasisFile,
          KTX2File,
          BasisEncoder
        });
      });
    });
  }

  // ../../node_modules/@loaders.gl/textures/dist/esm/lib/encoders/encode-ktx2-basis-texture.js
  async function encodeKTX2BasisTexture(image, options = {}) {
    const {
      useSRGB = false,
      qualityLevel = 10,
      encodeUASTC = false,
      mipmaps = false
    } = options;
    const {
      BasisEncoder
    } = await loadBasisEncoderModule(options);
    const basisEncoder = new BasisEncoder();
    try {
      const basisFileData = new Uint8Array(image.width * image.height * 4);
      basisEncoder.setCreateKTX2File(true);
      basisEncoder.setKTX2UASTCSupercompression(true);
      basisEncoder.setKTX2SRGBTransferFunc(true);
      basisEncoder.setSliceSourceImage(0, image.data, image.width, image.height, false);
      basisEncoder.setPerceptual(useSRGB);
      basisEncoder.setMipSRGB(useSRGB);
      basisEncoder.setQualityLevel(qualityLevel);
      basisEncoder.setUASTC(encodeUASTC);
      basisEncoder.setMipGen(mipmaps);
      const numOutputBytes = basisEncoder.encode(basisFileData);
      const actualKTX2FileData = basisFileData.subarray(0, numOutputBytes).buffer;
      return actualKTX2FileData;
    } catch (error) {
      console.error("Basis Universal Supercompressed GPU Texture encoder Error: ", error);
      throw error;
    } finally {
      basisEncoder.delete();
    }
  }

  // ../../node_modules/@loaders.gl/textures/dist/esm/ktx2-basis-universal-texture-writer.js
  var KTX2BasisUniversalTextureWriter = {
    name: "Basis Universal Supercompressed GPU Texture",
    id: "ktx2-basis-supercompressed-texture",
    module: "textures",
    version: VERSION,
    extensions: ["ktx2"],
    options: {
      useSRGB: false,
      qualityLevel: 10,
      encodeUASTC: false,
      mipmaps: false
    },
    encode: encodeKTX2BasisTexture
  };

  // core/textures/KTX2Worker.ts
  var worker = self;
  worker.onmessage = async (msg) => {
    try {
      const texture = await KTX2BasisUniversalTextureWriter.encode(msg.data);
      const response = { texture };
      worker.postMessage(response, [texture]);
    } catch (err) {
      worker.postMessage({ error: err.message });
    }
  };
})();
`,ko=class{constructor(n=4){c(this,"pool");c(this,"queue",[]);c(this,"workers",[]);c(this,"workersResolve",[]);c(this,"workerStatus",0);c(this,"workerCreator");this.pool=n}_initWorker(n){if(!this.workers[n]){const e=this.workerCreator();e.addEventListener("message",this._onMessage.bind(this,n)),this.workers[n]=e}}_getIdleWorker(){for(let n=0;n<this.pool;n++)if(!(this.workerStatus&1<<n))return n;return-1}_onMessage(n,e){const t=this.workersResolve[n];if(t&&t(e),this.queue.length){const{resolve:r,msg:i,transfer:s}=this.queue.shift();this.workersResolve[n]=r,this.workers[n].postMessage(i,s)}else this.workerStatus^=1<<n}setWorkerCreator(n){this.workerCreator=n}setWorkerLimit(n){this.pool=n}postMessage(n,e){return new Promise(t=>{const r=this._getIdleWorker();r!==-1?(this._initWorker(r),this.workerStatus|=1<<r,this.workersResolve[r]=t,this.workers[r].postMessage(n,e)):this.queue.push({resolve:t,msg:n,transfer:e})})}dispose(){this.workers.forEach(n=>n.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}},No=new Blob([Po],{type:"text/javascript"}),Fo=URL.createObjectURL(No),Uo=class{constructor(){c(this,"pool",new ko);this.pool.setWorkerCreator(()=>new Worker(Fo))}async encode(n){const e=await this.pool.postMessage(n,[n.data.buffer]);if(e.data.error)throw new Error(e.data.error);if(!e.data.texture)throw new Error("Encoding failed");return e.data.texture}};class Ko extends cr{constructor(e){super(e);c(this,"textures");this.version(1).stores({textures:"&hash, lastUsedTime"})}}const pr=class{constructor(e="web-layer-cache"){c(this,"_textureStore");c(this,"_textureUrls",new Map);c(this,"_textureData",new Map);c(this,"_textureSubscriptions",new Map);c(this,"_layerStateData",new Map);c(this,"_encoder",new Uo);this._textureStore=new Ko(e)}getLayerStateData(e){let t=this._layerStateData.get(e);return t||(t={bounds:new ze,margin:new Ve,renderAttempts:0},this._layerStateData.set(e,t)),t.textureHash&&(t.textureUrl=this.getTextureURL(t.textureHash)),t}async updateTexture(e,t){return new Promise(async r=>{try{const i=await this._encoder.encode(t),s=await this._textureStore.textures.get(e)||{hash:e,renderAttempts:0,lastUsedTime:Date.now(),texture:void 0};s.texture=i,s.renderAttempts++,this._textureStore.textures.put(s)}finally{r(null)}})}async requestTextureData(e){if(!this._textureSubscriptions.has(e)){const t=Li(()=>this._textureStore.textures.get(e)).subscribe(r=>{if(r){this._textureData.set(e,r);const i=this._textureUrls.get(e);i&&URL.revokeObjectURL(i),r.texture?this._textureUrls.set(e,URL.createObjectURL(new Blob([r.texture],{type:"image/ktx2"}))):this._textureUrls.delete(e)}});this._textureSubscriptions.set(e,t)}return this._textureStore.textures.get(e)}getTextureData(e){return this._textureSubscriptions.has(e)||this.requestTextureData(e),this._textureData.get(e)}getTextureURL(e){return this._textureSubscriptions.has(e)||this.requestTextureData(e),this._textureUrls.get(e)}};let hr=pr;c(hr,"instance",new pr);const Vo=new TextEncoder;function jo(n){return 1<<31-Math.clz32(n)}function Ni(n){return jo((n-1)*2)}const te=class{constructor(e,t){c(this,"element");c(this,"eventCallback");c(this,"id");c(this,"needsRefresh",!0);c(this,"needsRemoval",!1);c(this,"pseudoStates",{hover:!1,active:!1,focus:!1,target:!1});c(this,"svgImage",new Image);c(this,"parentLayer");c(this,"childLayers",[]);c(this,"pixelRatio");c(this,"_desiredStateHash","");c(this,"_rasterizingStateHash","");c(this,"_currentStateHash","");c(this,"_svgSrc","");c(this,"_svgDocument","");c(this,"_hashingCanvas",document.createElement("canvas"));c(this,"_domMetrics",{bounds:new ze,padding:new Ve,margin:new Ve,border:new Ve});c(this,"textureUrl");c(this,"bounds",new ze);c(this,"margin",new Ve);c(this,"serializationReplacer",e=>{var s;if(this.element===e)return;const t=e,r=(s=t.tagName)==null?void 0:s.toLowerCase();if(r==="style"||r==="link")return"";const i=R.layers.get(t);if(i){const a=i._domMetrics.bounds;let u="";const o=`box-sizing:border-box;max-width:${a.width+1}px;max-height:${a.height+1}px;min-width:${a.width}px;min-height:${a.height}px;visibility:hidden`;let l=!1;for(const m of i.element.attributes)m.name!=="src"&&(m.name=="style"?(u+=ut(m.name,m.value+";"+o),l=!0):u+=ut(m.name,m.value));l||(u+=ut("style",o));const p=t.tagName.toLowerCase();return`<${p} ${u}></${p}>`}});this.element=e,this.eventCallback=t,R.layers.set(e,this),this.id=e.getAttribute(R.ELEMENT_UID_ATTRIBUTE)||R.generateElementUID(),e.setAttribute(R.ELEMENT_UID_ATTRIBUTE,this.id),e.setAttribute(R.LAYER_ATTRIBUTE,""),this.parentLayer=R.getClosestLayer(this.element,!1),this.eventCallback("layercreated",{target:e}),this._hashingCanvas.width=30,this._hashingCanvas.height=30}get depth(){let e=0,t=this;for(;t.parentLayer;)t=t.parentLayer,e++;return e}get rootLayer(){let e=this;for(;e.parentLayer;)e=e.parentLayer;return e}traverseParentLayers(e){const t=this.parentLayer;t&&(t.traverseParentLayers(e),e(t))}traverseLayers(e){e(this),this.traverseChildLayers(e)}traverseChildLayers(e){for(const t of this.childLayers)t.traverseLayers(e)}update(){if(this._currentStateHash){const e=te.CACHE.getLayerStateData(this._currentStateHash);this.bounds.copy(e.bounds),this.margin.copy(e.margin),this.textureUrl!==e.textureUrl&&(this.textureUrl=e.textureUrl,this.eventCallback("layerpainted",{target:this.element}))}else{const e=this._domMetrics;this.bounds.copy(e.bounds),this.margin.copy(e.margin)}}refresh(){if(!this._currentStateHash){const e=this._domMetrics;ot(this.element,e.bounds,this.parentLayer&&this.parentLayer.element),Vr(this.element,e.margin)}this.needsRefresh=!1,this._updateParentAndChildLayers(),R.addToSerializeQueue(this)}_updateParentAndChildLayers(){const e=this.element,t=this.childLayers,r=t.slice(),i=this.parentLayer;this.parentLayer=R.getClosestLayer(this.element,!1),i!==this.parentLayer&&(this.parentLayer&&this.parentLayer.childLayers.push(this),this.eventCallback("layermoved",{target:e})),t.length=0,Ft(e,this._tryConvertElementToWebLayer,this);for(const s of r)R.getClosestLayer(s.element,!1)||(s.needsRemoval=!0,t.push(s))}_tryConvertElementToWebLayer(e){if(this.needsRemoval)return!1;const t=e,r=getComputedStyle(t);if(t.getAttribute(R.ELEMENT_UID_ATTRIBUTE)||t.setAttribute(R.ELEMENT_UID_ATTRIBUTE,R.generateElementUID()),t.hasAttribute(R.LAYER_ATTRIBUTE)||t.nodeName==="VIDEO"||r.transform!=="none"){let a=R.layers.get(t);return a||(a=new te(t,this.eventCallback)),this.childLayers.push(a),!1}return!0}async serialize(){var s;const e=this.element;if(e.nodeName==="VIDEO")return;const t=this._domMetrics;ot(e,t.bounds,(s=this.parentLayer)==null?void 0:s.element),Vr(e,t.margin);let{width:r,height:i}=t.bounds;if(r+=Math.max(t.margin.left,0)+Math.max(t.margin.right,0),i+=Math.max(t.margin.top,0)+Math.max(t.margin.bottom,0),r*i>0){Xs(e,t.padding),Qs(e,t.border);const a=R.attributeHTML(R.ELEMENT_UID_ATTRIBUTE,""+this.id),o=getComputedStyle(e).display==="inline";R.updateInputAttributes(e);const l=this._getParentsHTML(e);l[0]=l[0].replace("html","html "+R.RENDERING_DOCUMENT_ATTRIBUTE+'="" ');const p=await R.getAllEmbeddedStyles(e);let m=await sa(e,this.serializationReplacer);m=m.replace(a,`${a} ${R.RENDERING_ATTRIBUTE}="" ${o?`${R.RENDERING_INLINE_ATTRIBUTE}="" `:" "} `+R.getPsuedoAttributes(this.pseudoStates));const f='<svg width="'+r+'" height="'+i+`" xmlns="http://www.w3.org/2000/svg"><defs><style type="text/css"><![CDATA[
`+p.join(`
`)+']]></style></defs><foreignObject x="0" y="0" width="'+(r+1)+'" height="'+(i+1)+'">'+l[0]+m+l[1]+"</foreignObject></svg>",h=this._svgDocument=f,d=this._desiredStateHash=R.arrayBufferToBase64(vn.exports.hash(Vo.encode(h)))+"?w="+r+";h="+i;this._currentStateHash=d;const y=te.CACHE.getLayerStateData(d);if(y.bounds.copy(t.bounds),y.margin.copy(t.margin),y.renderAttempts>=te.MINIMUM_RENDER_ATTEMPTS&&y.textureHash)return;R.addToRasterizeQueue(this)}else this.bounds.copy(t.bounds),this.margin.copy(t.margin)}async rasterize(){return new Promise((e,t)=>{const r=()=>{R.addToRenderQueue(this),this.svgImage.onload=null,e()};this.svgImage.onload=()=>{setTimeout(r,10)},this.svgImage.onerror=i=>{t(i)},this._rasterizingStateHash=this._desiredStateHash,this.svgImage.src=this._svgSrc="data:image/svg+xml;utf8,"+encodeURIComponent(this._svgDocument)})}async render(){var L;const e=this._svgSrc;if(!this.svgImage.complete||this.svgImage.currentSrc!==e){setTimeout(()=>R.addToRenderQueue(this),100);return}const t=this._rasterizingStateHash,r=te.CACHE.getLayerStateData(t);let{width:i,height:s}=r.bounds,{left:a,top:u,right:o,bottom:l}=r.margin;const p=Math.max(i+a+o,1),m=Math.max(s+u+l,1),f=this._hashingCanvas;let h=f.width,d=f.height;const y=f.getContext("2d");y.clearRect(0,0,h,d),y.imageSmoothingEnabled=!1,y.drawImage(this.svgImage,0,0,p,m,0,0,h,d);const v=y.getImageData(0,0,h,d).data,w=this.pixelRatio||parseFloat(this.element.getAttribute(R.PIXEL_RATIO_ATTRIBUTE))||window.devicePixelRatio,_=Math.max(Ni(p*w),32),g=Math.max(Ni(m*w),32),x=R.arrayBufferToBase64(vn.exports.hash(new Uint8Array(v)))+"?w="+_+";h="+g,b=r.textureHash;r.textureHash=x,b!==x&&(r.renderAttempts=0),r.renderAttempts++;const S=((L=te.CACHE.getTextureData(x))==null?void 0:L.renderAttempts)||0;if(r.renderAttempts>te.MINIMUM_RENDER_ATTEMPTS&&S>te.MINIMUM_RENDER_ATTEMPTS)return;setTimeout(()=>R.addToRenderQueue(this),(500+Math.random()*1e3)*2^r.renderAttempts);const E=await te.CACHE.requestTextureData(x);if(b===x&&(E==null?void 0:E.texture)||this.svgImage.currentSrc!==e)return;const T=te.canvasPool.pop()||document.createElement("canvas");T.width=_,T.height=g;const M=T.getContext("2d");M.imageSmoothingEnabled=!1,M.clearRect(0,0,_,g),M.drawImage(this.svgImage,0,0,p,m,0,0,_,g);const B=M.getImageData(0,0,_,g);te.CACHE.updateTexture(x,B).then(()=>{te.canvasPool.push(T)})}_getParentsHTML(e){const t=[],r=[],i=this._domMetrics;let s=e.parentElement;s||(s=document.documentElement);do{let a=s.tagName.toLowerCase(),u=" ",o="";for(const m of s.attributes){const f=jr(m.value);if(m.name==="style"){o=f;continue}u+=`${m.name}="${f}" `}const l="<"+a+(a==="html"?` xmlns="http://www.w3.org/1999/xhtml" style="--x-width:${i.bounds.width}px;--x-height:${i.bounds.height}px;--x-inline-top:${i.border.top+i.margin.top+i.padding.top}px; ${o}" `:` style="${o}" ${R.RENDERING_PARENT_ATTRIBUTE}="" `)+u+" >";t.unshift(l);const p="</"+a+">";if(r.push(p),a=="html")break}while(s=s!==document.documentElement?s.parentElement||document.documentElement:null);return[t.join(""),r.join("")]}};let Rt=te;c(Rt,"CACHE",new hr),c(Rt,"MINIMUM_RENDER_ATTEMPTS",3),c(Rt,"canvasPool",[]);const Wo=self.ResizeObserver||cs;function qo(n,e){if(document.contains(n))return n;const t=document.createElement("div");return t.setAttribute(R.RENDERING_CONTAINER_ATTRIBUTE,""),t.style.visibility="hidden",t.style.pointerEvents="none",t.style.touchAction="none",t.attachShadow({mode:"open"}).appendChild(n),document.documentElement.appendChild(t),n}const Ho=new F,$o=new F;new TextDecoder;Promise.resolve();const D=class{static get ELEMENT_UID_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-uid"}static get HOVER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-hover"}static get ACTIVE_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-active"}static get FOCUS_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-focus"}static get TARGET_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-target"}static get LAYER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-layer"}static get PIXEL_RATIO_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-pixel-ratio"}static get RENDERING_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering"}static get RENDERING_PARENT_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-parent"}static get RENDERING_CONTAINER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-container"}static get RENDERING_INLINE_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-inline"}static get RENDERING_DOCUMENT_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-document"}static generateElementUID(){return""+this._nextUID++}static getPsuedoAttributes(e){return`${e.hover?`${this.HOVER_ATTRIBUTE}="" `:" "}${e.focus?`${this.FOCUS_ATTRIBUTE}="" `:" "}${e.active?`${this.ACTIVE_ATTRIBUTE}="" `:" "}${e.target?`${this.TARGET_ATTRIBUTE}="" `:" "}`}static initRootNodeObservation(e){const t=e.ownerDocument,r=e.getRootNode(),i="head"in r?r.head:r;if(this.rootNodeObservers.get(r))return;const s=this.containerStyleElement=t.createElement("style");t.head.appendChild(s),s.innerHTML=`
      [${D.RENDERING_CONTAINER_ATTRIBUTE}] {
        all: initial;
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0px;
      }
    `;const a=`
    [${D.RENDERING_DOCUMENT_ATTRIBUTE}] * {
      transform: none !important;
    }

    [${D.RENDERING_ATTRIBUTE}], [${D.RENDERING_ATTRIBUTE}] * {
      visibility: visible !important;
      /* the following is a hack for Safari; 
      without some kind of css filter active, 
      any box-shadow effect will fail to rasterize properly */
      filter: opacity(1);
    }
    
    [${D.RENDERING_ATTRIBUTE}] [${D.LAYER_ATTRIBUTE}], [${D.RENDERING_ATTRIBUTE}] [${D.LAYER_ATTRIBUTE}] * {
      visibility: hidden !important;
    }

    [${D.RENDERING_ATTRIBUTE}] {
      position: relative !important;
      top: 0 !important;
      left: 0 !important;
      float: left !important; /* prevent margin-collapse in SVG foreign-element for Webkit */
      box-sizing:border-box;
      min-width:var(--x-width);
      min-height:var(--x-height);
    }
    
    [${D.RENDERING_INLINE_ATTRIBUTE}] {
      top: var(--x-inline-top) !important;
      width:auto !important;
    }

    [${D.RENDERING_PARENT_ATTRIBUTE}] {
      transform: none !important;
      left: 0 !important;
      top: 0 !important;
      margin: 0 !important;
      border:0 !important;
      border-radius:0 !important;
      width: 100% !important;
      height:100% !important;
      padding:0 !important;
      visibility:hidden !important;
      filter:none !important;
    }
    
    [${D.RENDERING_PARENT_ATTRIBUTE}]::before, [${D.RENDERING_PARENT_ATTRIBUTE}]::after {
      content:none !important;
      box-shadow:none !important;
    }
    `,u=t.createElement("style");if(u.textContent=a,i.append(u),r===t){let f="";const h=()=>{if(f!=window.location.hash&&window.location.hash)try{this.targetElement=r.querySelector(window.location.hash)}catch{}f=window.location.hash};window.addEventListener("hashchange",h,!1),h(),window.addEventListener("focusin",d=>{this.focusElement=d.target},!1),window.addEventListener("focusout",d=>{this.focusElement=null},!1),window.addEventListener("load",d=>{o()})}const o=()=>{for(const[f,h]of this.layers)h.needsRefresh=!0},l=f=>{var h=f.nodeName.toUpperCase();p.indexOf(h)!==-1&&f.addEventListener("load",o)},p=["STYLE","LINK"],m=new MutationObserver(f=>{for(const h of f){p.indexOf(h.target.nodeName.toUpperCase())!==-1&&o();for(const d of h.addedNodes)l(d)}});m.observe(t,{childList:!0,attributes:!0,characterData:!0,subtree:!0,attributeOldValue:!0,characterDataOldValue:!0}),this.rootNodeObservers.set(r,m)}static addToSerializeQueue(e){this.serializeQueue.indexOf(e)===-1&&this.serializeQueue.push(e)}static addToRasterizeQueue(e){this.rasterizeQueue.indexOf(e)===-1&&this.rasterizeQueue.push(e)}static addToRenderQueue(e){this.renderQueue.indexOf(e)===-1&&this.renderQueue.push(e)}static _runTasks(){D.tasksPending=!1;const e=D.serializeQueue,t=D.rasterizeQueue,r=D.renderQueue,i=D.TASK_SYNC_MAX_TIME/2;let s=performance.now();for(;r.length&&performance.now()-s<i;)r.shift().render();for(s=performance.now();e.length&&performance.now()-s<i;)e.shift().serialize();t.length&&D.rasterizeTaskCount<D.TASK_ASYNC_MAX_COUNT&&(D.rasterizeTaskCount++,t.shift().rasterize().finally(()=>{D.rasterizeTaskCount--}))}static scheduleTasksIfNeeded(){this.tasksPending||D.serializeQueue.length===0&&D.renderQueue.length===0&&(D.rasterizeQueue.length===0||D.rasterizeTaskCount===D.TASK_ASYNC_MAX_COUNT)||(this.tasksPending=!0,D.scheduleIdle(D._runTasks))}static scheduleIdle(e){setTimeout(e,1)}static setLayerNeedsRefresh(e){e.needsRefresh=!0}static createLayerTree(e,t,r){if(D.getClosestLayer(e))throw new Error("A root WebLayer for the given element already exists");qo(e),D.initRootNodeObservation(e);const i=new MutationObserver(D._handleMutations);this.mutationObservers.set(e,i),this.startMutationObserver(e);const s=new Wo(u=>{for(const o of u){const l=this.getClosestLayer(o.target);l.traverseLayers(D.setLayerNeedsRefresh),l.traverseParentLayers(D.setLayerNeedsRefresh)}});s.observe(e),this.resizeObservers.set(e,s),e.addEventListener("input",this._triggerRefresh,{capture:!0}),e.addEventListener("keydown",this._triggerRefresh,{capture:!0}),e.addEventListener("submit",this._triggerRefresh,{capture:!0}),e.addEventListener("change",this._triggerRefresh,{capture:!0}),e.addEventListener("focus",this._triggerRefresh,{capture:!0}),e.addEventListener("blur",this._triggerRefresh,{capture:!0}),e.addEventListener("transitionend",this._triggerRefresh,{capture:!0});const a=new Rt(e,r);return this.rootLayers.set(e,a),a}static disposeLayer(e){this.rootLayers.has(e.element)&&(this.rootLayers.delete(e.element),this.mutationObservers.get(e.element).disconnect(),this.mutationObservers.delete(e.element),this.resizeObservers.get(e.element).disconnect(),this.resizeObservers.delete(e.element),e.element.removeEventListener("input",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("keydown",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("submit",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("change",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("focus",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("blur",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("transitionend",this._triggerRefresh,{capture:!0}))}static getClosestLayer(e,t=!0){let r=t?e:e.parentElement;const i=r==null?void 0:r.closest(`[${D.LAYER_ATTRIBUTE}]`);if(!i){const s=e==null?void 0:e.getRootNode().host;if(s)return this.getClosestLayer(s,t)}return this.layers.get(i)}static parseCSSTransform(e,t,r,i,s=new F){const a=e.transform,u=e.transformOrigin;if(a.indexOf("matrix(")==0){s.identity();var o=a.substring(7,a.length-1).split(", ").map(parseFloat);s.elements[0]=o[0],s.elements[1]=o[1],s.elements[4]=o[2],s.elements[5]=o[3],s.elements[12]=o[4],s.elements[13]=o[5]}else if(a.indexOf("matrix3d(")==0){var o=a.substring(9,a.length-1).split(", ").map(parseFloat);s.fromArray(o)}else return null;s.elements[0]===0&&(s.elements[0]=1e-15),s.elements[5]===0&&(s.elements[5]=1e-15),s.elements[10]===0&&(s.elements[10]=1e-15),s.elements[12]*=i,s.elements[13]*=i*-1;var l=u.split(" ").map(parseFloat),p=(l[0]-t/2)*i,m=(l[1]-r/2)*i*-1,f=l[2]||0,h=Ho.identity().makeTranslation(-p,-m,-f),d=$o.identity().makeTranslation(p,m,f);for(const y of s.elements)if(isNaN(y))return null;return s.premultiply(d).multiply(h)}static pauseMutationObservers(){const e=D.mutationObservers.values();for(const t of e)D._handleMutations(t.takeRecords()),t.disconnect()}static resumeMutationObservers(){for(const[e]of D.mutationObservers)this.startMutationObserver(e)}static startMutationObserver(e){D.mutationObservers.get(e).observe(e,{attributes:!0,childList:!0,subtree:!0,characterData:!0,characterDataOldValue:!0,attributeOldValue:!0})}static _addDynamicPseudoClassRules(e){const t=e.styleSheets;for(let s=0;s<t.length;s++)try{const a=t[s],u=a.cssRules;if(!u)continue;const o=[];for(var r=0;r<u.length;r++){u[r].cssText.indexOf(":hover")>-1&&o.push(u[r].cssText.replace(new RegExp(":hover","g"),`[${D.HOVER_ATTRIBUTE}]`)),u[r].cssText.indexOf(":active")>-1&&o.push(u[r].cssText.replace(new RegExp(":active","g"),`[${D.ACTIVE_ATTRIBUTE}]`)),u[r].cssText.indexOf(":focus")>-1&&o.push(u[r].cssText.replace(new RegExp(":focus","g"),`[${D.FOCUS_ATTRIBUTE}]`)),u[r].cssText.indexOf(":target")>-1&&o.push(u[r].cssText.replace(new RegExp(":target","g"),`[${D.TARGET_ATTRIBUTE}]`));var i=o.indexOf(u[r].cssText);i>-1&&o.splice(i,1)}for(var r=0;r<o.length;r++)a.insertRule(o[r])}catch{}}static arrayBufferToBase64(e){for(var t="",r=e.byteLength,i=0;i<r;i++)t+=String.fromCharCode(e[i]);return window.btoa(t)}static attributeCSS(e,t){return t?`[${e}]=${t}`:`[${e}]`}static attributeHTML(e,t){return t?`${e}="${t}"`:`${e}=""`}static async generateEmbeddedCSS(e,t){let r;const i=[];t=t.replace(new RegExp(":hover","g"),this.attributeCSS(this.HOVER_ATTRIBUTE)),t=t.replace(new RegExp(":active","g"),this.attributeCSS(this.ACTIVE_ATTRIBUTE)),t=t.replace(new RegExp(":focus","g"),this.attributeCSS(this.FOCUS_ATTRIBUTE)),t=t.replace(new RegExp(":target","g"),this.attributeCSS(this.TARGET_ATTRIBUTE));const s=RegExp(/(@import.*?["']([^"']+)["'].*?|url\((?!['"]?(?:data):)['"]?([^'"\)]*)['"]?\))/gi);for(;r=s.exec(t);){const u=!!r[2]?"type/css":void 0,o=r[2]||r[3];i.push(this.getDataURL(new URL(o,e).href,u).then(l=>{t=t.replace(o,l)}))}return await Promise.all(i),t}static async getAllEmbeddedStyles(e){const t=e.getRootNode(),r=this.embeddedStyles.get(t)||new Map;this.embeddedStyles.set(t,r);const i=Array.from(t.querySelectorAll("style, link[type='text/css'], link[rel='stylesheet']")),s=e.getRootNode()instanceof ShadowRoot;for(const a of i)r.has(a)||r.set(a,new Promise(u=>{if(a.tagName.toLowerCase()==="style")u(a.textContent||"");else{const o=a;u(this.getEmbeddedCSS(o.href))}}).then(u=>{const o=RegExp(/@font-face[^{]*{([^{}]|{[^{}]*})*}/gi),l=u.match(o);if(s&&l)for(const p of l){if(this.fontStyles.has(p))continue;const m=document.createElement("style");m.innerHTML=l.reduce((f,h)=>h+`

`+f,""),document.head.appendChild(m),this.fontStyles.set(p,m),r.set(m,Promise.resolve(""))}return this.generateEmbeddedCSS(window.location.href,u)}));return Promise.all(r.values())}static deleteEmbeddedStyle(e){const t=e.getRootNode(),r=this.embeddedStyles.get(t);r==null||r.delete(e)}static async getDataURL(e,t){if(e.startsWith("data"))return e;if(this.dataURLMap.has(e))return this.dataURLMap.get(e);const r=new Promise(async i=>{const s=await fetch(e,t?{headers:{accept:t}}:void 0),a=s.headers.get("content-type");if(a=="text/css"){const u=await this.generateEmbeddedCSS(e,await s.text());this.embeddedCSSMap.set(e,u),i("data:"+a+";base64,"+window.btoa(u))}else{const u=new Uint8Array(await s.arrayBuffer());i("data:"+a+";base64,"+this.arrayBufferToBase64(u))}});return this.dataURLMap.set(e,r),r}static async getEmbeddedCSS(e){if(this.embeddedCSSMap.has(e))return this.embeddedCSSMap.get(e);const t=await fetch(e,{headers:{accept:"text/css"}}),r=await this.generateEmbeddedCSS(e,await t.text());return this.embeddedCSSMap.set(e,r),this.embeddedCSSMap.get(e)}static updateInputAttributes(e){e.matches("input")&&this._updateInputAttribute(e);for(const t of e.getElementsByTagName("input"))this._updateInputAttribute(t)}static _updateInputAttribute(e){e.hasAttribute("checked")?e.checked||e.removeAttribute("checked"):e.checked&&e.setAttribute("checked",""),e.getAttribute("value")!==e.value&&e.setAttribute("value",e.value)}static isBlankImage(e){return!new Uint32Array(e.buffer).some(r=>r!==0)}};let R=D;c(R,"ATTRIBUTE_PREFIX","xr"),c(R,"_nextUID",0),c(R,"serializer",new XMLSerializer),c(R,"rootLayers",new Map),c(R,"layers",new Map),c(R,"mutationObservers",new Map),c(R,"resizeObservers",new Map),c(R,"serializeQueue",[]),c(R,"rasterizeQueue",[]),c(R,"renderQueue",[]),c(R,"focusElement",null),c(R,"activeElement",null),c(R,"targetElement",null),c(R,"rootNodeObservers",new Map),c(R,"containerStyleElement"),c(R,"TASK_ASYNC_MAX_COUNT",2),c(R,"TASK_SYNC_MAX_TIME",200),c(R,"rasterizeTaskCount",0),c(R,"tasksPending",!1),c(R,"_handleMutations",e=>{var t,r;for(const i of e){if(i.type==="attributes"&&i.target.getAttribute(i.attributeName)===i.oldValue)continue;if(i.type==="characterData"){const u=i.target;if(u.data===i.oldValue)continue;if(((t=u.parentElement)==null?void 0:t.tagName.toLowerCase())==="style"){const o=u.parentElement,l=o.getRootNode();(r=D.embeddedStyles.get(l))==null||r.delete(o)}}const s=i.target.nodeType===Node.ELEMENT_NODE?i.target:i.target.parentElement;if(!s)continue;const a=D.getClosestLayer(s);if(!!a){if(i.type==="attributes"&&i.attributeName==="class"){const u=i.oldValue?i.oldValue:"",o=i.target.className;if(u===o)continue}a.parentLayer?a.parentLayer.traverseChildLayers(D.setLayerNeedsRefresh):a.traverseLayers(D.setLayerNeedsRefresh)}}}),c(R,"_triggerRefresh",async e=>{const t=D.getClosestLayer(e.target);t&&(t.parentLayer?t.parentLayer.traverseChildLayers(D.setLayerNeedsRefresh):t.traverseLayers(D.setLayerNeedsRefresh))}),c(R,"embeddedStyles",new Map),c(R,"fontStyles",new Map),c(R,"dataURLMap",new Map),c(R,"embeddedCSSMap",new Map);const fr=Symbol("ON_BEFORE_UPDATE"),dr=new Ot,Go=new ls;function Fi(n){const e=n.attributes.uv;for(let t=0;t<e.count;t++)e.setY(t,1-e.getY(t));return n}const Ct=class extends Dt{constructor(e,t){super();c(this,"element");c(this,"options");c(this,"_camera");c(this,"_webLayer");c(this,"_localZ",0);c(this,"_viewZ",0);c(this,"_renderZ",0);c(this,"_videoTexture");c(this,"textures",new Set);c(this,"contentMesh");c(this,"_boundsMesh");c(this,"cursor",new Dt);c(this,"depthMaterial",new ds({depthPacking:ps,alphaTest:.001}));c(this,"domLayout",new Dt);c(this,"domSize",new Ot(1,1,1));c(this,"bounds",new ze);c(this,"margin",new Ve);c(this,"childWebLayers",[]);c(this,"shouldApplyDOMLayout","auto");this.element=e,this.options=t,this.name=e.id,this._webLayer=R.getClosestLayer(e),e.layer=this;const r=this.element.nodeName==="VIDEO"?Ct.GEOMETRY:Ct.FLIPPED_GEOMETRY;this.contentMesh=new gr(r,new vr({side:hs,depthWrite:!1,transparent:!0,alphaTest:.001,opacity:1})),this._boundsMesh=new gr(r,new vr({visible:!1})),this.add(this.contentMesh),this.add(this._boundsMesh),this.cursor.visible=!1,this.matrixAutoUpdate=!0,this.contentMesh.matrixAutoUpdate=!0,this.contentMesh.visible=!1,this.contentMesh.customDepthMaterial=this.depthMaterial,this.contentMesh.onBeforeRender=(i,s,a)=>{this._camera=a},this._boundsMesh.matrixAutoUpdate=!0,this.options.manager.layersByElement.set(this.element,this),this.options.manager.layersByMesh.set(this.contentMesh,this)}static shouldApplyDOMLayout(e){const t=e.shouldApplyDOMLayout;return t==="always"||t===!0?!0:t==="never"||t===!1?!1:!!(t==="auto"&&e.parentWebLayer&&e.parent===e.parentWebLayer)}get currentTexture(){const e=this.options.manager;if(this._webLayer.element.tagName==="VIDEO"){const i=this._webLayer.element;let s=this._videoTexture;return s||(s=new fs(i),s.wrapS=It,s.wrapT=It,s.minFilter=br,e.textureEncoding&&(s.encoding=e.textureEncoding),this._videoTexture=s),s}const t=this._webLayer.textureUrl;let r=t?e.getTexture(t,this):void 0;return r&&this.textures.add(r),r}get pseudoStates(){return this._webLayer.pseudoStates}get depth(){return this._webLayer.depth}get index(){return this.parentWebLayer?this.parentWebLayer.childWebLayers.indexOf(this):0}get needsRefresh(){return this._webLayer.needsRefresh}setNeedsRefresh(){this._webLayer.traverseLayers(R.setLayerNeedsRefresh)}get needsRemoval(){return this._webLayer.needsRemoval}get parentWebLayer(){return this._webLayer.parentLayer&&this.options.manager.layersByElement.get(this._webLayer.parentLayer.element)}refresh(e=!1){var t;this._webLayer.refresh(),this.childWebLayers.length=0;for(const r of this._webLayer.childLayers){const i=this.options.manager.layersByElement.get((t=R.getClosestLayer(r.element))==null?void 0:t.element);!i||(this.childWebLayers.push(i),e&&i.refresh(e))}this._refreshVideoBounds()}updateLayout(){if(this._updateDOMLayout(),this._camera){this._localZ=Math.abs(dr.setFromMatrixPosition(this.matrix).z+dr.setFromMatrixPosition(this.contentMesh.matrix).z),this._viewZ=Math.abs(this.contentMesh.getWorldPosition(dr).applyMatrix4(this._camera.matrixWorldInverse).z);let e=this.parentWebLayer?this.parentWebLayer._renderZ:this._viewZ;this._localZ<.001?this._renderZ=e:this._renderZ=this._viewZ,this.contentMesh.renderOrder=(this.options.renderOrderOffset||0)+(1-Math.log(this._renderZ+1)/Math.log(this._camera.far+1))+(this.depth+this.index*.001)*1e-7}}updateContent(){const e=this.contentMesh,t=this.currentTexture,r=e.material;if(t&&r.map!==t){const a=this.contentMesh.scale,u=Math.abs(a.x*this.scale.x/a.y*this.scale.y),o=this.domSize.x/this.domSize.y;Math.abs(o-u)<1e3&&(r.map=t,this.depthMaterial.map=t,r.needsUpdate=!0,this.depthMaterial.needsUpdate=!0)}r.transparent=!0;const i=e.material,s=i.opacity<.005;s?e.visible=!1:i.map&&(e.visible=!0),this.needsRemoval&&s&&(this.parent&&this.parent.remove(this),this.dispose())}get container(){return this.options.manager.layersByElement.get(this._webLayer.rootLayer.element)}[fr](){}_doUpdate(){this[fr](),this._webLayer.update(),this.updateContent(),this.updateLayout(),Ct.shouldApplyDOMLayout(this)&&(this.position.copy(this.domLayout.position),this.quaternion.copy(this.domLayout.quaternion),this.scale.copy(this.domLayout.scale)),this.contentMesh.position.set(0,0,0),this.contentMesh.scale.copy(this.domSize),this.contentMesh.quaternion.set(0,0,0,1),this._boundsMesh.position.set(0,0,0),this._boundsMesh.scale.copy(this.domSize),this._boundsMesh.quaternion.set(0,0,0,1),this.needsRefresh&&this.options.autoRefresh!==!1&&this.refresh(),R.scheduleTasksIfNeeded()}update(e=!1){e?this.traverseLayersPreOrder(this._doUpdate):this._doUpdate()}querySelector(e){var r;const t=this.element.querySelector(e)||((r=this.element.shadowRoot)==null?void 0:r.querySelector(e));if(t)return this.options.manager.layersByElement.get(t)}traverseLayerAncestors(e){const t=this.parentWebLayer;t&&(t.traverseLayerAncestors(e),e.call(this,t))}traverseLayersPreOrder(e){if(e.call(this,this)===!1)return!1;for(const t of this.childWebLayers)if(t.traverseLayersPreOrder(e)===!1)return!1;return!0}traverseLayersPostOrder(e){for(const t of this.childWebLayers)if(t.traverseLayersPostOrder(e)===!1)return!1;return e.call(this,this)||!0}dispose(){R.disposeLayer(this._webLayer),this.options.manager.disposeLayer(this);for(const e of this.childWebLayers)e.dispose()}_refreshVideoBounds(){if(this.element.nodeName==="VIDEO"){const e=this.element,t=this.currentTexture,r=getComputedStyle(this.element),{objectFit:i}=r,{width:s,height:a}=this.bounds.copy(this._webLayer.bounds),{videoWidth:u,videoHeight:o}=e,l=u/o,p=s/a;switch(t.center.set(.5,.5),i){case"none":t.repeat.set(s/u,a/o).clampScalar(0,1);break;case"contain":case"scale-down":if(t.repeat.set(1,1),p>l){const m=this.bounds.height*l||0;this.bounds.left+=(this.bounds.width-m)/2,this.bounds.width=m}else{const m=this.bounds.width/l||0;this.bounds.top+=(this.bounds.height-m)/2,this.bounds.height=m}break;case"cover":if(t.repeat.set(s/u,a/o),p<l){const m=this.bounds.height*l||0;this.bounds.left+=(this.bounds.width-m)/2,this.bounds.width=m}else{const m=this.bounds.width/l||0;this.bounds.top+=(this.bounds.height-m)/2,this.bounds.height=m}break;default:case"fill":t.repeat.set(1,1);break}}}_updateDOMLayout(){if(this.needsRemoval)return;const{bounds:e,margin:t}=this._webLayer;if(!e||!t)return;this.domLayout.position.set(0,0,0),this.domLayout.scale.set(1,1,1),this.domLayout.quaternion.set(0,0,0,1);const r=this.element.nodeName==="VIDEO",i=r?this.bounds:this.bounds.copy(e),s=r?this.margin:this.margin.copy(t),a=i.width+s.left+s.right,u=i.height+s.top+s.bottom,o=i.width,l=i.height,p=1/this.options.manager.pixelsPerUnit;this.domSize.set(Math.max(p*(o+s.left+s.right),1e-5),Math.max(p*(l+s.top+s.bottom),1e-5),1);const m=this.parentWebLayer;if(!m)return;const f=m.bounds,h=m.margin,d=f.width+h.left+h.right,y=f.height+h.bottom+h.top,v=-d/2+h.left,w=y/2-h.top;this.domLayout.position.set(p*(v+a/2+i.left-s.left),p*(w-u/2-i.top+s.top),0);const _=getComputedStyle(this.element),g=_.transform;if(g&&g!=="none"){const x=R.parseCSSTransform(_,i.width,i.height,p,Go);x&&(this.domLayout.updateMatrix(),this.domLayout.matrix.multiply(x),this.domLayout.matrix.decompose(this.domLayout.position,this.domLayout.quaternion,this.domLayout.scale))}}};let hn=Ct;c(hn,"GEOMETRY",Fi(new yr(1,1,2,2))),c(hn,"FLIPPED_GEOMETRY",Fi(new yr(1,1,2,2)));const et=class{constructor(){c(this,"textureEncoding",ys);c(this,"texturesByUrl",new Map);c(this,"layersUsingTexture",new WeakMap);c(this,"textureLoader",new gs);c(this,"layersByElement",new WeakMap);c(this,"layersByMesh",new WeakMap);c(this,"pixelsPerUnit",1e3);this.textureLoader.setTranscoderPath(et.DEFAULT_TRANSCODER_PATH)}static initialize(e){et.instance=new et,et.instance.textureLoader.detectSupport(e)}getTexture(e,t){var s;let r=this.texturesByUrl.get(e);if(typeof r!="string")return r?(t&&((s=this.layersUsingTexture.get(r))==null||s.add(t)),r):(this.textureLoader.loadAsync(e).then(a=>{a.wrapS=It,a.wrapT=It,a.minFilter=br,a.encoding=this.textureEncoding,this.layersUsingTexture.set(a,new Set),this.texturesByUrl.set(e,a)}).catch(()=>{this.texturesByUrl.set(e,"error")}),this.texturesByUrl.set(e,"pending"),r)}disposeLayer(e){for(const t of e.textures){const r=this.layersUsingTexture.get(t);r.delete(e),r.size===0&&t.dispose()}}};let fn=et;c(fn,"DEFAULT_TRANSCODER_PATH",`https://unpkg.com/@loaders.gl/textures@${ms}/dist/libs/`),c(fn,"instance");const Ui=new Ot,Ki=new Ot,Qo=new ze,Xo=new ze;class eu extends Dt{constructor(e,t={}){super();c(this,"options");c(this,"rootLayer");c(this,"_interactionRays",[]);c(this,"_raycaster",new vs);c(this,"_hitIntersections",[]);c(this,"_previousHoverLayers",new Set);c(this,"_contentMeshes",[]);c(this,"_prepareHitTest",e=>{e.pseudoStates.hover&&this._previousHoverLayers.add(e),e.cursor.visible=!1,e.pseudoStates.hover=!1,this._contentMeshes.push(e.contentMesh)});t.manager||(t.manager=fn.instance),this.options=t;const r=typeof e=="string"?Zs(e):e;R.createLayerTree(r,t,(i,{target:s})=>{var a,u,o,l,p,m;if(i==="layercreated"){const f=new hn(s,this.options);s===r?(f[fr]=()=>this._updateInteractions(),this.rootLayer=f,this.add(f)):(a=f.parentWebLayer)==null||a.add(f),(o=(u=this.options).onLayerCreate)==null||o.call(u,f)}else if(i==="layerpainted"){const f=R.layers.get(s),h=this.options.manager.layersByElement.get(f.element);(p=(l=this.options).onLayerPaint)==null||p.call(l,h)}else if(i==="layermoved"){const f=this.options.manager.layersByElement.get(s);(m=f.parentWebLayer)==null||m.add(f)}}),this.refresh(),this.update()}get interactionRays(){return this._interactionRays}set interactionRays(e){this._interactionRays=e}update(){this.rootLayer.update(!0)}refresh(){this.rootLayer.refresh(!0)}querySelector(e){return this.rootLayer.querySelector(e)}get contentMesh(){return this.rootLayer.contentMesh}_intersectionSort(e,t){const r=e.object.parent,i=t.object.parent;return r.depth!==i.depth?i.depth-r.depth:i.index-r.index}_updateInteractions(){const e=this._previousHoverLayers;e.clear(),this._contentMeshes.length=0,this.rootLayer.traverseLayersPreOrder(this._prepareHitTest);for(const t of this._interactionRays){"isObject3D"in t&&t.isObject3D?this._raycaster.ray.set(t.getWorldPosition(Ui),t.getWorldDirection(Ki).negate()):this._raycaster.ray.copy(t),this._hitIntersections.length=0;const r=this._raycaster.intersectObjects(this._contentMeshes,!1,this._hitIntersections);r.sort(this._intersectionSort);const i=r[0];if(i){const s=i.object.parent;s.cursor.position.copy(i.point),s.cursor.visible=!0,s.pseudoStates.hover=!0,e.has(s)||s.setNeedsRefresh()}}for(const t of e)t.pseudoStates.hover||t.setNeedsRefresh()}hitTest(e){const t=this._raycaster,r=this._hitIntersections,i=this.options.manager.layersByMesh;"isObject3D"in e&&e.isObject3D?this._raycaster.ray.set(e.getWorldPosition(Ui),e.getWorldDirection(Ki).negate()):this._raycaster.ray.copy(e),r.length=0,t.intersectObject(this,!0,r),r.sort(this._intersectionSort);for(const s of r){const a=i.get(s.object);if(!a)continue;const u=ot(a.element,Qo);if(!u.width||!u.height)continue;let o=a.element;const l=s.uv.x*u.width,p=(1-s.uv.y)*u.height;return Ft(a.element,m=>{if(!o.contains(m))return!1;const f=ot(m,Xo),h=f.left-u.left,d=f.top-u.top,{width:y,height:v}=f,w=h+y,_=d+v;return l>h&&l<w&&p>d&&p<_?(o=m,!0):!1}),{layer:a,intersection:s,target:o}}}}export{mn as Q,qs as S,ae as V,eu as W,xs as a,pn as b,Gs as c,fn as d,Jo as e,Ir as f};
